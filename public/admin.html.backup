<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Admin ‚Äî Venus Lealtad</title>
  <link rel="icon" href="/assets/logo.png">
  <style>
    /* [TODOS LOS ESTILOS EXISTENTES SE MANTIENEN IGUAL] */
    body.checking-auth {
      opacity: 0;
      pointer-events: none;
    }

    body.auth-verified {
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    :root {
      --venus: #8c9668;
      --venus-soft: #dfe6c1;
      --bg: #3f4037;
      --ink: #f9fafb;
      --muted: #e5e7eb;
      --line: rgba(255, 255, 255, 0.25);
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .wrap {
      max-width: 1100px;
      margin: 16px auto;
      padding: 0 12px 32px;
      width: 100%;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand img {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, .1);
    }

    h1 {
      font-size: 22px;
      margin: 0;
      color: var(--ink);
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .1);
      padding: 7px 13px;
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
      color: var(--ink);
      white-space: nowrap;
      backdrop-filter: blur(3px);
      transition: all 0.2s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--venus-green) 0%, #9aa066 100%);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(140, 150, 104, 0.3);
      transition: all 0.2s ease;
    }

    .btn.primary:hover {
      background: linear-gradient(135deg, #9aa066 0%, var(--venus-green) 100%);
      box-shadow: 0 6px 16px rgba(140, 150, 104, 0.4);
      transform: translateY(-1px);
    }

    .btn.ghost {
      background: transparent;
      border-color: var(--line);
    }

    .btn.small {
      padding: 5px 10px;
      font-size: 12px;
    }

    .nav {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 8px 0 14px;
    }

    .nav a {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid transparent;
      text-decoration: none;
      font-size: 13px;
      color: var(--muted);
      background: transparent;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .nav a.is-active {
      background: rgba(255, 255, 255, .15);
      border-color: var(--venus);
      color: var(--venus-soft);
      box-shadow: 0 4px 14px rgba(0, 0, 0, .1);
    }

    .card {
      background: rgba(255, 255, 255, .08);
      border-radius: var(--radius);
      border: 1px solid var(--line);
      padding: 16px 16px 14px;
      box-shadow: 0 10px 28px rgba(0, 0, 0, .2);
      margin-bottom: 14px;
      backdrop-filter: blur(3px);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.05), transparent 60%),
        radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.03), transparent 60%);
      opacity: .9;
      pointer-events: none;
    }

    .card>* {
      position: relative;
      z-index: 1;
    }

    .card h2 {
      margin: 0 0 6px;
      font-size: 18px;
      color: var(--ink);
    }

    .card h3 {
      margin: 0 0 6px;
      font-size: 15px;
      color: var(--ink);
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select.filter-select {
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      border: 1px solid var(--line);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      outline: none;
      cursor: pointer;
    }

    .grid-3-kpi {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    @media (max-width:700px) {
      .grid-3-kpi {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width:480px) {
      .grid-3-kpi {
        grid-template-columns: 1fr;
      }
    }

    .kpi {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, .1);
      border: 1px solid rgba(255, 255, 255, .15);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      backdrop-filter: blur(3px);
    }

    .kpi span.value {
      font-size: 20px;
      font-weight: 600;
      color: var(--ink);
    }

    .kpi span {
      color: var(--muted);
    }

    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    label {
      display: block;
      margin: 8px 0 4px;
      font-size: 13px;
      font-weight: 500;
      color: var(--ink);
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .1);
      font-size: 13px;
      color: var(--ink);
      backdrop-filter: blur(3px);
    }

    input::placeholder {
      color: var(--muted);
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    .hidden {
      display: none !important;
    }

    .table-wrap {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 13px;
    }

    thead {
      background: rgba(255, 255, 255, .1);
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, .1);
      text-align: left;
      white-space: nowrap;
      color: var(--ink);
    }

    tr:last-child td {
      border-bottom: none;
    }

    code {
      font-size: 12px;
      background: rgba(255, 255, 255, .15);
      padding: 2px 4px;
      border-radius: 4px;
      color: var(--ink);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      background: #bbf7d0;
      color: #166534;
      font-size: 11px;
    }

    /* Estilos adaptados de index.html para la Gift Card */
    .gift-card-visual {
      background-color: #8c9668;
      /* Tu color original */
      border-radius: 20px;
      color: #fff;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      width: 100%;
      max-width: 320px;
      /* Tama√±o proporcional para compartir */
      position: relative;
      overflow: hidden;
      text-align: center;
      margin: 0 auto;
      /* Centrado */
      font-family: 'Poppins', sans-serif;
    }

    .gift-card-visual::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.05), transparent 70%),
        radial-gradient(circle at 80% 60%, rgba(255, 255, 255, 0.04), transparent 60%);
      opacity: 0.7;
      z-index: 0;
    }

    .gift-card-content {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .gift-brand-logo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #fff;
      margin-bottom: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      object-fit: contain;
      padding: 2px;
    }

    .gift-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 5px 0;
    }

    .gift-service {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 10px 0 5px;
      color: #dfe6c1;
      /* Venus soft color */
    }

    .gift-meta {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 15px;
    }

    .gift-qr-container {
      background: #fff;
      padding: 10px;
      border-radius: 12px;
      margin-top: 10px;
      display: inline-block;
    }


    .gift-qr {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      background: #fff;
      padding: 8px;
      margin-bottom: 8px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0, 0, 0, .18);
      font-size: 11px;
      margin-top: 6px;
    }

    .gift-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .footer {
      margin-top: auto;
      text-align: center;
      padding: 8px 0 14px;
      font-size: 12px;
      color: var(--muted);
    }

    .success-message {
      background: rgba(187, 247, 208, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 10px;
      font-size: 13px;
      color: #bbf7d0;
    }

    dialog {
      border-radius: 16px;
      border: 1px solid var(--line);
      background: #111827;
      color: var(--ink);
      padding: 16px 18px 14px;
      max-width: 420px;
      width: 90%;
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, .6);
    }

    /* ===== OFF-CANVAS MENU (Module Selection) ===== */
    .offcanvas {
      position: fixed;
      top: 0;
      right: -400px;
      width: 380px;
      height: 100vh;
      background: linear-gradient(135deg, rgba(27, 28, 26, 0.98), rgba(140, 150, 104, 0.1));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-left: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      overflow-y: auto;
      padding: 24px;
    }

    .offcanvas.open {
      right: 0;
    }

    .offcanvas-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .offcanvas-backdrop.show {
      opacity: 1;
      visibility: visible;
    }

    .offcanvas-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .offcanvas-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--venus-soft);
    }

    .module-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      transition: all 0.2s ease;
    }

    .module-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .module-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .module-icon {
      font-size: 20px;
    }

    .module-label {
      font-size: 14px;
      font-weight: 500;
      color: #f3f3f3;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.2);
      transition: .3s;
      border-radius: 34px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked+.toggle-slider {
      background-color: var(--venus-green);
      box-shadow: 0 0 8px rgba(140, 150, 104, 0.5);
    }

    .toggle-switch input:checked+.toggle-slider:before {
      transform: translateX(22px);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-card {
      background: linear-gradient(135deg, rgba(27, 28, 26, 0.95), rgba(140, 150, 104, 0.15));
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, .15);
      padding: 24px;
      max-width: 480px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, .4),
        0 0 0 1px rgba(255, 255, 255, .05) inset;
      color: #f9fafb;
      animation: modalSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--venus-soft);
    }

    .modal-body p {
      margin: 12px 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-body strong {
      font-weight: 600;
      min-width: 80px;
      color: var(--venus-soft);
    }

    .modal-footer {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* Mejorar botones del modal */
    .modal-footer .btn.small {
      border-radius: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .modal-footer .btn.small:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .modal-footer .btn.primary {
      background: linear-gradient(135deg, var(--venus-green), #a0b070);
      border: none;
    }

    .modal-footer .btn.success {
      box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
    }

    .modal-footer .btn.success:hover {
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
      background: #22c55e;
    }

    .modal-footer .btn.ghost {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-footer .btn.ghost:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .qr-box {
      margin-top: 10px;
      display: flex;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 10px;
    }

    .qr-box canvas {
      background: #fff;
      border-radius: 8px;
      padding: 8px;
      max-width: 100%;
      height: auto;
    }

    /* Estilos para debugging */
    .debug-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--line);
    }

    .debug-output {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 10px;
    }

    /* Estilos para el formulario de notificaci√≥n individual */
    .notify-form-container {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Spinner animation for loading states */
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .notify-form-header {
      font-size: 14px;
      font-weight: 600;
      color: var(--venus-soft);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .input-group {
      position: relative;
      margin-bottom: 10px;
    }

    .input-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      pointer-events: none;
      color: var(--muted);
    }

    .input-group textarea+.input-icon {
      top: 12px;
      transform: none;
    }

    .notify-input {
      width: 100%;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 10px 12px 10px 38px;
      /* Padding left for icon */
      color: #fff;
      font-size: 13px;
      transition: all 0.2s;
    }

    .notify-input:focus {
      border-color: var(--venus);
      outline: none;
      background: rgba(0, 0, 0, 0.3);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.1);
    }

    .notify-textarea {
      width: 100%;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 10px 12px 10px 38px;
      /* Padding left for icon */
      color: #fff;
      font-size: 13px;
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
      transition: all 0.2s;
    }

    .notify-textarea:focus {
      border-color: var(--venus);
      outline: none;
      background: rgba(0, 0, 0, 0.3);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.1);
    }

    .notify-btn-group {}

    .automation-textarea:focus {
      outline: none;
      border-color: var(--venus-green);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.1);
    }

    .automation-test-btn {
      margin-top: 12px;
    }

    .automation-history {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .automation-log-item {
      padding: 8px;
      margin-bottom: 6px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.5;
    }

    .modal-textarea:focus {
      outline: none;
      border-color: var(--venus-green);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.1);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>

<body class="checking-auth">

  <main class="wrap">
    <header class="topbar">
      <div class="brand">
        <img src="/assets/logo.png" alt="Venus">
        <div>
          <h1>Admin ‚Äî Venus Lealtad</h1>
          <div class="muted" id="me-line">Sesi√≥n iniciada</div>
        </div>
      </div>
      <div class="actions">
        <a class="btn" href="/" target="_blank" rel="noopener">P√°gina clientes</a>
        <button id="logout" class="btn">Cerrar sesi√≥n</button>
      </div>
    </header>

    <nav class="nav">
      <a href="#overview" data-tab="overview" class="is-active">Resumen</a>
      <a href="#cards" data-tab="cards">Tarjetas</a>
      <a href="#events" data-tab="events">Gift Cards</a>
      <a href="#notifications" data-tab="notifications">Notificaciones</a>
      <a href="#appointments" data-tab="appointments">Citas</a>
      <a href="#settings" data-tab="settings">Configuraci√≥n</a>
    </nav>

    <!-- TAB: Overview - MODIFICADO CON FILTROS Y REPORTES -->
    <section id="tab-overview" class="card">
      <div
        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
        <div class="row" style="gap:8px;margin-bottom:14px;justify-content:space-between;">
          <h2 style="font-size:20px;font-weight:700;color:var(--ink);margin:0;">Resumen</h2>
          <div class="row" style="gap:8px;">
            <button id="btn-personalize-dashboard" class="btn small ghost">
              ‚öôÔ∏è Personalizar
            </button>
            <select id="stats-filter" class="btn small">
              <option value="day">Hoy</option>
              <option value="week" selected>Esta semana</option>
              <option value="month">Este mes</option>
            </select>
            <button id="btn-download-report" class="btn small primary">
              ‚¨á Descargar Reporte
            </button>
          </div>
        </div>
      </div>

      <!-- KPIs principales (fila 1) -->
      <div class="grid-3-kpi" data-module-section="kpis">
        <div class="kpi">
          <span>Tarjetas totales</span>
          <span class="value" id="kpi-total">‚Äî</span>
        </div>
        <div class="kpi">
          <span>Tarjetas completas</span>
          <span class="value" id="kpi-full">‚Äî</span>
        </div>
        <div class="kpi">
          <span id="stamps-period-label">Sellos hoy</span>
          <span class="value" id="kpi-stamps">‚Äî</span>
        </div>
      </div>

      <!-- KPIs adicionales (fila 2) -->
      <div class="grid-3-kpi" style="margin-top:14px;" data-module-section="kpis">
        <div class="kpi">
          <span id="redeems-period-label">Canjes hoy</span>
          <span class="value" id="kpi-redeems">‚Äî</span>
        </div>
        <div class="kpi">
          <span>Promedio sellos</span>
          <span class="value" id="kpi-avg">‚Äî</span>
        </div>
        <div class="kpi">
          <span>Tasa completitud</span>
          <span class="value" id="kpi-rate">‚Äî</span>
        </div>
      </div>

      <!-- CUMPLEA√ëOS DEL MES (Overview) -->
      <div id="overview-birthday-section" class="hidden" data-module-section="birthdays"
        style="margin-top: 20px; padding: 15px; background: rgba(255, 209, 102, 0.1); border: 1px solid rgba(255, 209, 102, 0.3); border-radius: 12px;">
        <div class="row" style="justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üéÇ</span>
            <div>
              <h3 style="margin: 0; color: #ffd166;" id="overview-birthday-title">Cumplea√±os (√∫ltimos 30 d√≠as)</h3>
              <p class="muted" style="margin: 2px 0 0; font-size: 13px;">Pasados y pr√≥ximos cumplea√±os.</p>
            </div>
          </div>
        </div>

        <!-- Cumplea√±os pr√≥ximos -->
        <div id="upcoming-birthdays-container" class="hidden" style="margin-top: 15px;">
          <h4 style="margin: 0 0 8px; font-size: 13px; color: #a7f3d0; font-weight: 600;">üéâ Pr√≥ximos Cumplea√±os</h4>
          <div id="upcoming-birthday-list" style="display: flex; gap: 8px; flex-wrap: wrap;">
            <!-- Lista de cumplea√±os pr√≥ximos -->
          </div>
        </div>

        <!-- Cumplea√±os pasados -->
        <div id="past-birthdays-container" class="hidden" style="margin-top: 15px;">
          <h4 style="margin: 0 0 8px; font-size: 13px; color: #cbd5e1; font-weight: 600;">üìÖ Cumplea√±os Pasados</h4>
          <div id="past-birthday-list" style="display: flex; gap: 8px; flex-wrap: wrap;">
            <!-- Lista de cumplea√±os pasados -->
          </div>
        </div>
      </div>

      <!-- Gr√°fica Actividad reciente -->
      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--line);" data-module-section="activity">
        <h3 style="margin:0 0 12px;font-size:15px;color:var(--ink);" id="activity-title">üìà Actividad reciente (7 d√≠as)
        </h3>
        <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:12px;">
          <canvas id="activity-chart" style="max-height:200px;"></canvas>
        </div>
      </div>

      <!-- Top clientes -->
      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--line);" data-module-section="topClients">
        <h3 style="margin:0 0 12px;font-size:15px;color:var(--ink);">‚≠ê Top Clientes</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Sellos</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody id="top-clients">
              <tr>
                <td colspan="3" style="text-align:center;padding:12px;" class="muted">Cargando...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Estado de Wallets - MEJORADO CON ESTAD√çSTICAS REALES -->
      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--line);" data-module-section="walletStats">
        <h3 style="margin:0 0 12px;font-size:15px;color:var(--ink);">üì± Estado de Wallets</h3>
        <div class="grid-3-kpi">
          <div class="kpi">
            <span>üü¢ Google Wallet</span>
            <span class="value" id="kpi-google">‚Äî</span>
          </div>
          <div class="kpi">
            <span>üçé Apple Wallet</span>
            <span class="value" id="kpi-apple">‚Äî</span>
          </div>
          <div class="kpi">
            <span>üì≤ Dispositivos totales</span>
            <span class="value" id="kpi-devices">‚Äî</span>
          </div>
        </div>
        <div style="margin-top:10px; text-align:center;">
          <button id="btn-refresh-wallet-stats" class="btn small ghost">üîÑ Actualizar estad√≠sticas</button>
        </div>
      </div>

      <!-- KPIs AVANZADOS (NUEVOS) -->
      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--line);" data-module-section="newKPIs">
        <h3 style="margin:0 0 12px;font-size:15px;color:var(--ink);">üìä KPIs Avanzados</h3>

        <!-- Primera fila: Clientes -->
        <div class="grid-3-kpi">
          <div class="kpi">
            <span>Clientes nuevos</span>
            <span class="value" id="kpi-new-clients">‚Äî</span>
          </div>
          <div class="kpi">
            <span>üü¢ Activos (30d)</span>
            <span class="value" id="kpi-active-clients">‚Äî</span>
          </div>
          <div class="kpi">
            <span>üî¥ Inactivos (30d)</span>
            <span class="value" id="kpi-inactive-clients">‚Äî</span>
          </div>
        </div>

        <!-- Segunda fila: An√°lisis -->
        <div class="grid-3-kpi" style="margin-top:14px;">
          <div class="kpi">
            <span>Promedio d√≠as inactivo</span>
            <span class="value" id="kpi-avg-last-visit">‚Äî</span>
          </div>
          <div class="kpi">
            <span>Ciclos completados</span>
            <span class="value" id="kpi-cycles-completed">‚Äî</span>
          </div>
          <div class="kpi">
            <span>Tasa de retorno</span>
            <span class="value" id="kpi-return-rate">‚Äî</span>
          </div>
        </div>

        <!-- Gr√°ficas de distribuci√≥n -->
        <div style="margin-top:16px;background:rgba(255,255,255,0.05);border-radius:12px;padding:12px;">
          <h4 style="margin:0 0 10px;font-size:13px;color:var(--venus-soft);">Distribuci√≥n por d√≠a de la semana</h4>
          <canvas id="day-distribution-chart"></canvas>
        </div>

        <div style="margin-top:16px;background:rgba(255,255,255,0.05);border-radius:12px;padding:12px;">
          <h4 style="margin:0 0 10px;font-size:13px;color:var(--venus-soft);">Distribuci√≥n por hora del d√≠a</h4>
          <canvas id="hour-distribution-chart"></canvas>
        </div>
      </div>
    </section>

    <!-- TAB: Cards -->
    <section id="tab-cards" class="card hidden">
      <h2>Tarjetas de lealtad</h2>
      <p class="muted">Gestiona todas las tarjetas de tus clientes.</p>

      <!-- KPI CUMPLEA√ëOS -->
      <div id="birthday-section" class="hidden"
        style="margin: 15px 0; padding: 15px; background: rgba(255, 209, 102, 0.1); border: 1px solid rgba(255, 209, 102, 0.3); border-radius: 12px;">
        <div class="row" style="justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">üéÇ</span>
            <div>
              <h3 style="margin: 0; color: #ffd166;">Cumplea√±os Cercanos</h3>
              <p class="muted" style="margin: 2px 0 0; font-size: 13px;">Clientes que cumplen a√±os en los pr√≥ximos 7
                d√≠as.</p>
            </div>
          </div>
          <div id="birthday-actions">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>
        <div id="birthday-list" style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
          <!-- Lista de cumplea√±eros -->
        </div>
      </div>

      <div class="row" style="margin-top:12px; align-items: center;">
        <input id="search-cards" placeholder="Buscar por nombre o tel√©fono..." style="flex:1;min-width:200px;">

        <!-- SORTING CONTROLS -->
        <select id="sort-cards" class="filter-select">
          <option value="created_at:desc">üìÖ Recientes</option>
          <option value="created_at:asc">üìÖ Antiguos</option>
          <option value="name:asc">abc Nombre (A-Z)</option>
          <option value="name:desc">zyx Nombre (Z-A)</option>
          <option value="stamps:desc">‚≠ê M√°s sellos</option>
          <option value="stamps:asc">‚≠ê Menos sellos</option>
          <option value="last_visit:desc">üïí √öltima visita</option>
        </select>

        <button id="btn-search-cards" class="btn primary">üîç Buscar</button>
        <button id="btn-reload-cards" class="btn">üîÑ Recargar</button>
        <button id="btn-scan-card" class="btn ghost">üì∑ Escanear QR</button>
      </div>

      <div class="table-wrap" style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <!-- ID REMOVED -->
              <th>Cliente</th>
              <th>Tel√©fono</th>
              <th>Cumplea√±os</th>
              <th>√öltima Visita</th>
              <th>Creada</th>
              <th>Sellos</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="cards-tbody">
            <tr>
              <td colspan="7" style="text-align:center;padding:12px;" class="muted">Cargando tarjetas...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:12px;">
        <button id="btn-prev-page" class="btn small ghost">‚Üê Anterior</button>
        <span id="page-info" class="muted">P√°gina 1</span>
        <button id="btn-next-page" class="btn small ghost">Siguiente ‚Üí</button>
      </div>
    </section>

    <!-- TAB: Gift Cards -->
    <section id="tab-events" class="card hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2 style="margin:0;">Gift Cards</h2>
        <button id="btn-scan-gift-card" class="btn primary">
          üì∑ Escanear QR
        </button>
      </div>

      <!-- Formulario Crear Gift Card -->
      <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:16px;margin-bottom:20px;">
        <h3 style="margin:0 0 8px;font-size:16px;">Crear Gift Card</h3>
        <p class="muted" style="margin:0 0 16px;font-size:13px;">Genera una tarjeta de regalo digital con vigencia de 30
          d√≠as.</p>

        <form id="gift-form" style="max-width:500px;">
          <label>Nombre del cliente (opcional)</label>
          <input id="gift-name" placeholder="Ej. Ana L√≥pez">

          <label>Servicio a regalar</label>
          <input id="gift-service" required placeholder="Ej. Facial hidratante, Masaje relajante‚Ä¶">

          <button type="submit" class="btn primary" style="margin-top:10px;">Generar Gift Card</button>
        </form>

        <div id="gift-preview-container" class="hidden" style="margin-top: 20px;">
          <div id="gift-card-visual" class="gift-card-visual">
            <div class="gift-card-content">
              <img src="/assets/logo.png" alt="Venus" class="gift-brand-logo">

              <div class="gift-title">Venus Lealtad</div>
              <div style="font-size: 0.9rem; opacity: 0.9;">¬°Tienes un regalo! üéÅ</div>

              <hr style="width: 50%; border: 0; border-top: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">

              <div id="gift-visual-service" class="gift-service">Servicio</div>
              <div id="gift-visual-client" class="gift-meta">Para: Cliente</div>
              <div id="gift-visual-date" class="gift-meta" style="font-size: 0.8rem; margin-top:0;">Vence: --/--/--
              </div>

              <div class="gift-qr-container">
                <canvas id="gift-qr"></canvas>
              </div>
              <div style="font-size: 10px; color: #333; margin-top: 4px; color: #fff; opacity: 0.8;">Muestra este c√≥digo
              </div>
            </div>
          </div>
        </div>

        <div id="gift-actions" class="gift-actions hidden">
          <button type="button" id="gift-copy" class="btn small">Copiar texto</button>
          <button type="button" id="gift-whatsapp" class="btn small primary">Enviar por WhatsApp</button>
          <button type="button" id="gift-whatsapp-image" class="btn small primary">üì∑ WhatsApp con imagen</button>
        </div>

        <div id="gift-success" class="success-message hidden">
          ‚úÖ Gift Card generada exitosamente. Puedes enviarla por WhatsApp o compartir el texto.
        </div>
    </section>

    <!-- TAB: Settings - MEJORADO CON DEBUGGING -->
    <section id="tab-settings" class="card hidden">
      <h2>Configuraci√≥n</h2>
      <p class="muted">Env√≠a notificaciones push a todos los pases en Google Wallet.</p>

      <div
        style="background:rgba(140,150,104,0.1);border:1px solid rgba(140,150,104,0.3);border-radius:12px;padding:14px;margin:12px 0;">
        <h3 style="margin:0 0 8px;">üì≤ Notificaciones Push</h3>

        <form id="push-notification-form">
          <label>T√≠tulo de la notificaci√≥n</label>
          <input id="push-title" placeholder="Ej. ¬°Nueva promoci√≥n!" required maxlength="50">
          <small class="muted">M√°ximo 50 caracteres</small>

          <label style="margin-top:10px;">Mensaje</label>
          <textarea id="push-message" placeholder="Ej. Hoy tenemos 20% de descuento..." required maxlength="200"
            rows="3"></textarea>
          <small class="muted">M√°ximo 200 caracteres</small>

          <label style="margin-top:10px;">Tipo</label>
          <select id="push-type">
            <option value="promo">üéÅ Promoci√≥n</option>
            <option value="reminder">‚è∞ Recordatorio</option>
            <option value="update">‚ÑπÔ∏è Actualizaci√≥n</option>
            <option value="alert">‚ö†Ô∏è Alerta</option>
          </select>

          <div style="margin-top:12px;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;">
            <div class="row" style="justify-content:space-between;margin-bottom:8px;">
              <span class="muted" style="font-size:12px;">Vista previa:</span>
              <span id="preview-type" style="font-size:12px;">üéÅ Promoci√≥n</span>
            </div>
            <div style="background:rgba(255,255,255,0.1);border-radius:8px;padding:10px;">
              <div id="preview-title" style="font-weight:600;margin-bottom:4px;">¬°Nueva promoci√≥n!</div>
              <div id="preview-message" class="muted" style="font-size:12px;">Tu mensaje aparecer√° aqu√≠...</div>
            </div>
          </div>

          <div class="row" style="margin-top:14px;gap:10px;">
            <button type="button" id="btn-mass-push" class="btn primary">Enviar a todos</button>
            <button type="button" id="test-push" class="btn ghost">Enviar prueba</button>
          </div>
        </form>

        <div id="push-success" class="success-message hidden" style="margin-top:12px;">
          ‚úÖ Notificaci√≥n enviada a <span id="push-count">0</span> pases
        </div>

        <div id="push-error" class="hidden"
          style="background:rgba(254,202,202,0.1);border:1px solid rgba(153,27,27,0.3);border-radius:10px;padding:10px 12px;margin-top:12px;font-size:13px;color:#fecaca;">
          ‚ùå Error al enviar notificaci√≥n
        </div>
      </div>

      <div style="margin-top:16px;">
        <div class="row" style="justify-content:space-between;margin-bottom:8px;">
          <h3 style="margin:0;">üìã Historial</h3>
          <button id="refresh-history" class="btn small ghost">üîÑ</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>T√≠tulo</th>
                <th>Tipo</th>
                <th>Enviadas</th>
                <th>Errores</th>
              </tr>
            </thead>
            <tbody id="notifications-history">
              <tr>
                <td colspan="5" style="text-align:center;padding:12px;" class="muted">Cargando...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- NUEVA SECCI√ìN: DEBUGGING AVANZADO -->
      <div class="debug-section">
        <h3 style="margin:0 0 12px;font-size:15px;color:var(--ink);">üêõ Debugging Avanzado</h3>

        <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:12px;">
          <button id="btn-test-apple-push" class="btn small">üß™ Test Apple Push</button>
          <button id="btn-test-google-push" class="btn small">üß™ Test Google Push</button>
          <button id="btn-fix-google-wallet" class="btn small">üîß Reparar Google Wallet</button>
          <button id="btn-check-devices" class="btn small">üì± Ver Dispositivos</button>
          <button id="btn-check-apns" class="btn small">üçé Ver Config APNs</button>
        </div>
        <div id="debug-output" class="debug-output hidden">
          <!-- Aqu√≠ se mostrar√°n los resultados del debugging -->
        </div>
      </div>
    </section>

    <!-- TAB: Notificaciones -->
    <section id="tab-notifications" class="card hidden">
      <h2>üîî Notificaciones</h2>
      <p class="muted" style="margin:0 0 20px;font-size:13px;">
        Configura notificaciones autom√°ticas para diferentes eventos del programa de lealtad.
      </p>

      <!-- Bot√≥n ejecutar todas -->
      <div style="margin-bottom:24px;">
        <button id="btn-run-all-automations" class="btn primary">
          ‚ñ∂Ô∏è Ejecutar Automatizaciones Activas
        </button>
        <span class="muted" style="font-size:12px;margin-left:10px;">Procesa todas las reglas activas ahora</span>
      </div>

      <!-- Regla 1: Cumplea√±os -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon">üéÇ</span>
            <span class="automation-title">Recordatorio de Cumplea√±os</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-birthday-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <label class="automation-label">D√≠as de anticipaci√≥n:</label>
          <input type="number" id="auto-birthday-days" class="automation-input" value="3" min="0" max="30">

          <label class="automation-label" style="margin-top:10px;">Mensaje:</label>
          <textarea id="auto-birthday-message" class="automation-textarea"
            rows="2">¬°Feliz cumplea√±os! üéâ Te esperamos con un regalo especial en Venus.</textarea>

          <button class="btn small ghost automation-test-btn" data-type="birthday">üß™ Probar</button>
        </div>
      </div>

      <!-- Regla 2: Inactividad -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon">üò¥</span>
            <span class="automation-title">Alerta de Inactividad</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-inactivity-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <label class="automation-label">D√≠as sin visita:</label>
          <input type="number" id="auto-inactivity-days" class="automation-input" value="30" min="7" max="180">

          <label class="automation-label" style="margin-top:10px;">Mensaje:</label>
          <textarea id="auto-inactivity-message" class="automation-textarea"
            rows="2">¬°Te extra√±amos! üòä Hace tiempo que no te vemos. Ven y disfruta nuestros servicios.</textarea>

          <button class="btn small ghost automation-test-btn" data-type="inactivity">üß™ Probar</button>
        </div>
      </div>

      <!-- Regla 3: Tarjeta Completada -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon">üéÅ</span>
            <span class="automation-title">Tarjeta Completada</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-completed-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <p class="muted" style="font-size:12px;margin:0 0 10px;">Notificaci√≥n cuando el cliente complete su tarjeta.
          </p>

          <label class="automation-label">Mensaje:</label>
          <textarea id="auto-completed-message" class="automation-textarea"
            rows="2">¬°Felicidades! üéÅ Has completado tu tarjeta. Ven a canjear tu premio.</textarea>

          <button class="btn small ghost automation-test-btn" data-type="completed">üß™ Probar</button>
        </div>
      </div>

      <!-- Regla 4: Casi Completa -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon">‚ö°</span>
            <span class="automation-title">Casi Completa (Motivacional)</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-almost-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <label class="automation-label">Faltan X sellos:</label>
          <input type="number" id="auto-almost-stamps" class="automation-input" value="2" min="1" max="5">

          <label class="automation-label" style="margin-top:10px;">Mensaje:</label>
          <textarea id="auto-almost-message" class="automation-textarea"
            rows="2">¬°Ya casi! ‚ö° Solo te faltan [X] sellos para tu premio. ¬°No esperes m√°s!</textarea>

          <button class="btn small ghost automation-test-btn" data-type="almost">üß™ Probar</button>
        </div>
      </div>

      <!-- Historial de automatizaciones -->
      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--line);">
        <h4 style="margin:0 0 10px;font-size:14px;color:var(--venus-soft);">üìã Historial Reciente</h4>
        <div id="automation-history" class="automation-history">
          <p class="muted" style="font-size:12px;">No hay env√≠os recientes</p>
        </div>
      </div>
    </section>

    <!-- TAB: Citas -->
    <section id="tab-appointments" class="tab-content hidden">
      <div class="header-actions">
        <h2>üìÖ Agenda de Citas</h2>
        <button class="btn primary" id="btn-new-appointment">Nueva Cita</button>
      </div>

      <!-- Calendario Semanal -->
      <div class="card" style="margin-bottom:20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3 style="margin:0;">Semana Actual</h3>
          <div style="display:flex;gap:8px;">
            <button class="btn small ghost" id="btn-prev-week">‚Üê Anterior</button>
            <button class="btn small ghost" id="btn-today">Hoy</button>
            <button class="btn small ghost" id="btn-next-week">Siguiente ‚Üí</button>
          </div>
        </div>
        <div id="weekly-calendar" style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;"></div>
      </div>

      <!-- Citas del D√≠a Seleccionado -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3 style="margin:0;">Citas del <span id="selected-date-label">Hoy</span></h3>
          <button class="btn small" id="btn-refresh-appts">üîÑ Actualizar</button>
        </div>

        <table class="data-table">
          <thead>
            <tr>
              <th>Hora</th>
              <th>Cliente</th>
              <th>Servicio</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="appts-tbody">
            <tr>
              <td colspan="5" style="text-align:center;padding:20px;">Cargando...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Historial del Mes -->
      <div class="card" style="margin-top:20px;">
        <h3 style="margin-top:0;">Historial del Mes</h3>
        <div id="month-stats"
          style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:16px;">
          <div class="stat-card">
            <div class="stat-label">Total Citas</div>
            <div class="stat-value" id="stat-total">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Completadas</div>
            <div class="stat-value" id="stat-completed">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Canceladas</div>
            <div class="stat-value" id="stat-cancelled">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Pendientes</div>
            <div class="stat-value" id="stat-pending">-</div>
          </div>
        </div>
      </div>
    </section>

    <!-- DIALOG: Nueva Cita -->
    <dialog id="newApptDialog">
      <div class="dialog-content">
        <h3 style="margin-top:0;margin-bottom:20px;">üìÖ Agendar Cita</h3>
        <form id="form-new-appt">
          <div style="display:grid;gap:16px;">
            <!-- Cliente Dropdown -->
            <div>
              <label class="form-label">Cliente</label>
              <select id="new-appt-client-select" class="form-input">
                <option value="">Selecciona un cliente...</option>
              </select>
              <button type="button" id="btn-toggle-new-client" class="btn small ghost" style="margin-top:8px;">
                + Registrar nuevo cliente
              </button>
            </div>

            <!-- Formulario Nuevo Cliente (oculto por defecto) -->
            <div id="new-client-form"
              style="display:none;background:rgba(140,150,104,0.1);border:1px solid rgba(140,150,104,0.3);border-radius:12px;padding:16px;">
              <h4 style="margin:0 0 12px 0;color:var(--venus-soft);">Nuevo Cliente</h4>
              <div style="display:grid;gap:12px;">
                <div>
                  <label class="form-label">Nombre completo</label>
                  <input type="text" id="new-client-name" class="form-input" placeholder="Ej: Mar√≠a Gonz√°lez">
                </div>
                <div>
                  <label class="form-label">Tel√©fono</label>
                  <input type="tel" id="new-client-phone" class="form-input" placeholder="52...">
                </div>
                <button type="button" id="btn-save-new-client" class="btn small primary">Guardar Cliente</button>
              </div>
            </div>

            <!-- Tel√©fono (solo lectura cuando se selecciona cliente) -->
            <div>
              <label class="form-label">Tel√©fono</label>
              <input type="tel" id="new-appt-phone" class="form-input" placeholder="52..." required readonly>
            </div>

            <!-- Servicio y Precio -->
            <div style="display:grid;grid-template-columns:2fr 1fr;gap:10px;">
              <div>
                <label class="form-label">Servicio</label>
                <select id="new-appt-service" class="form-input" required>
                  <option value="">Selecciona un servicio...</option>
                </select>
              </div>
              <div>
                <label class="form-label">Precio</label>
                <input type="number" id="new-appt-price" class="form-input" placeholder="0" min="0" step="10">
              </div>
            </div>

            <!-- Fecha y Hora -->
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
              <div>
                <label class="form-label">Fecha</label>
                <input type="date" id="new-appt-date" class="form-input" required>
              </div>
              <div>
                <label class="form-label">Hora inicio</label>
                <select id="new-appt-time" class="form-input" required>
                  <option value="">Selecciona...</option>
                </select>
              </div>
              <div>
                <label class="form-label">Hora fin</label>
                <input type="text" id="new-appt-end-time" class="form-input" readonly
                  style="background:rgba(0,0,0,0.15);color:var(--muted);">
              </div>
            </div>

            <!-- Recordatorios -->
            <div class="reminders-section">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                <svg width="18" height="18" fill="none" stroke="var(--venus-soft)" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                  </path>
                </svg>
                <span style="font-size:13px;font-weight:600;color:var(--venus-soft);">Recordatorios por WhatsApp</span>
              </div>
              <div style="display:grid;gap:10px;">
                <label class="reminder-option">
                  <input type="checkbox" id="check-whatsapp-confirm" checked>
                  <span class="reminder-text">
                    <strong>Confirmaci√≥n inmediata</strong>
                    <small>Se env√≠a al crear la cita</small>
                  </span>
                </label>
                <label class="reminder-option">
                  <input type="checkbox" id="check-whatsapp-24h" checked>
                  <span class="reminder-text">
                    <strong>24 horas antes</strong>
                    <small>Recordatorio autom√°tico</small>
                  </span>
                </label>
                <label class="reminder-option">
                  <input type="checkbox" id="check-whatsapp-2h" checked>
                  <span class="reminder-text">
                    <strong>2 horas antes</strong>
                    <small>Recordatorio final</small>
                  </span>
                </label>
              </div>
            </div>

            <!-- Botones -->
            <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
              <button type="button" class="btn ghost" id="btn-cancel-appt">Cancelar</button>
              <button type="submit" class="btn primary">Agendar</button>
            </div>
          </div>
        </form>
      </div>
    </dialog>

    <style>
      /* Dialog Styles - Backdrop Opaco */
      #newApptDialog::backdrop {
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
      }

      #newApptDialog {
        border: none;
        border-radius: 16px;
        padding: 0;
        max-width: 650px;
        width: 90%;
        background: transparent;
      }

      .dialog-content {
        background: var(--bg-card);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 24px;
        color: #fff;
      }

      /* Form Elements */
      .form-label {
        display: block;
        font-size: 12px;
        margin-bottom: 6px;
        color: var(--venus-soft);
        font-weight: 500;
      }

      .form-input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--line);
        background: rgba(0, 0, 0, 0.3);
        color: #fff;
        font-size: 14px;
        transition: all 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--venus-green);
        background: rgba(0, 0, 0, 0.4);
      }

      .form-input:disabled,
      .form-input:read-only {
        background: rgba(0, 0, 0, 0.15);
        color: var(--muted);
        cursor: not-allowed;
      }

      /* Reminders Section */
      .reminders-section {
        background: rgba(140, 150, 104, 0.1);
        border: 1px solid rgba(140, 150, 104, 0.3);
        border-radius: 12px;
        padding: 16px;
      }

      .reminder-option {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
      }

      .reminder-option:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .reminder-option input[type="checkbox"] {
        margin-top: 2px;
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--venus-green);
      }

      .reminder-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .reminder-text strong {
        font-size: 13px;
        color: #fff;
      }

      .reminder-text small {
        font-size: 11px;
        color: var(--muted);
      }

      /* Weekly Calendar */
      .day-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .day-card:hover {
        background: rgba(140, 150, 104, 0.1);
        border-color: var(--venus-green);
      }

      .day-card.selected {
        background: rgba(140, 150, 104, 0.2);
        border-color: var(--venus-green);
      }

      .day-card.today {
        border: 2px solid var(--venus-green);
      }

      .day-name {
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        margin-bottom: 4px;
      }

      .day-number {
        font-size: 20px;
        font-weight: 700;
        color: #fff;
        margin-bottom: 4px;
      }

      .day-count {
        font-size: 11px;
        color: var(--venus-soft);
      }

      /* Stats Cards */
      .stat-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
      }

      .stat-label {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--venus-soft);
      }
    </style>

    <!-- DIALOG: Esc√°ner QR -->
    <dialog id="scanDialog">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <h3 style="margin:0;font-size:16px;">Escanear tarjeta</h3>
        <button type="button" id="scan-close" class="btn small ghost">Cerrar</button>
      </div>
      <div id="qr-reader" style="width:100%;"></div>
      <div class="muted" id="scan-status" style="margin-top:8px;font-size:12px;">Iniciando c√°mara‚Ä¶</div>
    </dialog>

    <!-- DIALOG: Esc√°ner Gift Card -->
    <dialog id="giftScanDialog"
      style="background:rgba(27,28,26,0.95);border:1px solid rgba(255,255,255,0.15);border-radius:16px;padding:20px;max-width:500px;width:90%;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h3 style="margin:0;font-size:16px;color:#f9fafb;">üì∑ Escan gift card</h3>
        <button type="button" id="gift-scan-close" class="btn small ghost">Cerrar</button>
      </div>
      <div id="gift-qr-reader" style="width:100%;"></div>
      <div class="muted" id="gift-scan-status" style="margin-top:12px;font-size:13px;text-align:center;">Esperando
        escaneo...</div>
    </dialog>


    <footer class="footer">¬© Venus Cosmetolog√≠a</footer>

    <!-- Modal Tarjeta -->
    <div id="card-modal-backdrop" class="modal-backdrop hidden">
      <div class="modal-card">
        <div class="modal-header">
          <h3>Tarjeta</h3>
          <button id="cm-close" class="btn small ghost">Cerrar</button>
        </div>
        <div class="modal-body">
          <p><strong>ID:</strong> <code id="cm-id"></code></p>
          <p><strong>Cliente:</strong> <span id="cm-name"></span></p>
          <p><strong>Tel√©fono:</strong> <span id="cm-phone"></span></p>
          <p><strong>Sellos:</strong> <span id="cm-stamps"></span></p>
          <p><strong>Estado:</strong> <span id="cm-status"></span></p>

          <!-- NUEVOS CAMPOS (FASE 5) -->
          <div style="margin-top:20px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.1);">
            <h4 style="margin:0 0 12px;font-size:14px;color:var(--venus-soft);">üìä Informaci√≥n Adicional</h4>

            <!-- Stats calculados (solo lectura) -->
            <div class="client-stats">
              <div class="stat-row">
                <span class="stat-label">Visitas totales:</span>
                <span id="cm-visited-count" class="stat-value">‚Äî</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Ciclos completados:</span>
                <span id="cm-cycles-completed" class="stat-value">‚Äî</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">√öltima visita:</span>
                <span id="cm-last-visit" class="stat-value">‚Äî</span>
              </div>
            </div>

            <!-- Campos editables -->
            <div style="margin-top:16px;">
              <label class="modal-field-label">üíá Servicios favoritos:</label>
              <input id="cm-favorite-services" class="modal-input" placeholder="Ej: Corte, Tinte, Manicure">
            </div>

            <div style="margin-top:12px;">
              <label class="modal-field-label">üìù Notas del cliente:</label>
              <textarea id="cm-notes" class="modal-textarea" rows="3"
                placeholder="Notas administrativas sobre el cliente..."></textarea>
            </div>

            <button id="cm-save-notes" class="btn small primary" style="margin-top:12px;">
              üíæ Guardar Cambios
            </button>
          </div>

          <div class="qr-box">
            <canvas id="card-qr"></canvas>
          </div>

          <!-- Formulario de Notificaci√≥n Individual (Oculto por defecto) -->
          <div id="notify-form-container" class="notify-form-container hidden">
            <span class="notify-form-header">
              üîî Push Individual
            </span>

            <div class="input-group">
              <input id="notify-title" class="notify-input" placeholder="T√≠tulo" value="Recordatorio Venus">
              <span class="input-icon">üìå</span>
            </div>

            <div class="input-group">
              <textarea id="notify-message" class="notify-textarea" placeholder="Escribe tu mensaje aqu√≠..."></textarea>
              <span class="input-icon">üí¨</span>
            </div>

            <div class="notify-btn-group">
              <button id="btn-cancel-notify" class="btn small ghost">Cancelar</button>
              <button id="btn-send-notify" class="btn small primary">üöÄ Enviar Push</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <!-- Primary actions -->
          <button id="cm-stamp" class="btn small primary">+1 sello</button>
          <button id="cm-redeem" class="btn small">Canjear</button>

          <!-- WhatsApp button -->
          <button id="cm-whatsapp" class="btn small success" style="background: #25D366; color: white;">
            üì± WhatsApp
          </button>

          <!-- Secondary actions -->
          <button id="cm-copy" class="btn small ghost">Copiar ID</button>
          <button id="cm-open-url" class="btn small ghost">Abrir cliente</button>
          <button id="cm-notify" class="btn small ghost">üîî Notificar</button>
          <button id="cm-delete" class="btn small ghost" style="color:#fecaca;">Eliminar</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Off-Canvas Menu for Module Selection -->
  <div class="offcanvas-backdrop" id="offcanvas-backdrop"></div>
  <div class="offcanvas" id="modules-offcanvas">
    <div class="offcanvas-header">
      <h3 class="offcanvas-title">üéõÔ∏è Personalizar Dashboard</h3>
      <button class="btn small ghost" id="close-offcanvas">‚úï</button>
    </div>

    <p class="muted" style="font-size: 13px; margin-bottom: 20px;">
      Selecciona los m√≥dulos que deseas ver en el Resumen
    </p>

    <!-- Module Toggles -->
    <div id="module-list">
      <div class="module-item" data-module="kpis">
        <div class="module-info">
          <span class="module-icon">üìä</span>
          <span class="module-label">KPIs Principales</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="kpis" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="birthdays">
        <div class="module-info">
          <span class="module-icon">üéÇ</span>
          <span class="module-label">Cumplea√±os</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="birthdays" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="activity">
        <div class="module-info">
          <span class="module-icon">üìà</span>
          <span class="module-label">Gr√°fica de Actividad</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="activity" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="topClients">
        <div class="module-info">
          <span class="module-icon">‚≠ê</span>
          <span class="module-label">Top Clientes</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="topClients" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="walletStats">
        <div class="module-info">
          <span class="module-icon">üì±</span>
          <span class="module-label">Estado de Wallets</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="walletStats" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="newKPIs">
        <div class="module-info">
          <span class="module-icon">üìä</span>
          <span class="module-label">KPIs Avanzados</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="newKPIs" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

    <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
      <button id="reset-modules" class="btn small ghost" style="width: 100%;">
        üîÑ Restaurar por defecto
      </button>
    </div>
  </div>

  <!-- QRCode lib -->

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- Chart.js lib -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    const $ = s => document.querySelector(s);

    /* ===== MODULE SELECTION SYSTEM ===== */
    const DEFAULT_MODULES = {
      kpis: true,
      birthdays: true,
      activity: true,
      topClients: true,
      walletStats: true,
      newKPIs: true
    };

    // Load saved modules from localStorage
    function getSelectedModules() {
      const saved = localStorage.getItem('venus_modules');
      return saved ? JSON.parse(saved) : { ...DEFAULT_MODULES };
    }

    // Save modules to localStorage
    function saveSelectedModules(modules) {
      localStorage.setItem('venus_modules', JSON.stringify(modules));
    }

    // Apply module visibility
    function applyModuleVisibility() {
      const modules = getSelectedModules();

      // Find and toggle module visibility based on data-module-section attributes
      document.querySelectorAll('[data-module-section]').forEach(section => {
        const moduleName = section.getAttribute('data-module-section');
        if (modules[moduleName] === false) {
          section.style.display = 'none';
        } else {
          section.style.display = '';
        }
      });
    }

    // Open/close offcanvas
    function openOffcanvas() {
      document.getElementById('modules-offcanvas').classList.add('open');
      document.getElementById('offcanvas-backdrop').classList.add('show');
    }

    function closeOffcanvas() {
      document.getElementById('modules-offcanvas').classList.remove('open');
      document.getElementById('offcanvas-backdrop').classList.remove('show');
    }

    // Initialize module toggles from localStorage
    function initializeModuleToggles() {
      const modules = getSelectedModules();

      document.querySelectorAll('.toggle-switch input[type="checkbox"]').forEach(toggle => {
        const moduleName = toggle.getAttribute('data-module');
        toggle.checked = modules[moduleName] !== false;

        // Add event listener
        toggle.addEventListener('change', (e) => {
          const modules = getSelectedModules();
          modules[moduleName] = e.target.checked;
          saveSelectedModules(modules);
          applyModuleVisibility();

          console.log('üìä M√≥dulo', moduleName, e.target.checked ? 'activado' : 'desactivado');
        });
      });
    }

    // Event listeners for offcanvas
    document.getElementById('btn-personalize-dashboard').addEventListener('click', openOffcanvas);
    document.getElementById('close-offcanvas').addEventListener('click', closeOffcanvas);
    document.getElementById('offcanvas-backdrop').addEventListener('click', closeOffcanvas);

    // Reset to defaults
    document.getElementById('reset-modules').addEventListener('click', () => {
      if (confirm('¬øRestaurar configuraci√≥n por defecto?')) {
        saveSelectedModules(DEFAULT_MODULES);
        initializeModuleToggles();
        applyModuleVisibility();
        alert('‚úÖ Configuraci√≥n restaurada');
      }
    });

    // Initialize on page load
    initializeModuleToggles();
    applyModuleVisibility();

    /* ===== AUTOMATIZACIONES (UI PLACEHOLDER) ===== */
    // Event listeners para los toggles de automatizaciones
    document.querySelectorAll('[id^="auto-"][id$="-enabled"]').forEach(toggle => {
      toggle.addEventListener('change', (e) => {
        const ruleType = e.target.id.replace('auto-', '').replace('-enabled', '');
        console.log(`ü§ñ Automatizaci√≥n "${ruleType}" ${e.target.checked ? 'activada' : 'desactivada'}`);
        // TODO: Guardar en Firestore cuando se implemente backend
      });
    });

    // Event listeners para botones de prueba
    document.querySelectorAll('.automation-test-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const type = e.target.getAttribute('data-type');
        alert(`üß™ Funci√≥n de prueba para "${type}" ser√° implementada pr√≥ximamente.\n\nEsto enviar√° una notificaci√≥n de prueba a un cliente aleatorio.`);
      });
    });

    // Bot√≥n ejecutar todas las automatizaciones
    document.getElementById('btn-run-all-automations')?.addEventListener('click', () => {
      alert('‚ñ∂Ô∏è Ejecuci√≥n de automatizaciones ser√° implementada pr√≥ximamente.\n\nEsto procesar√° todas las reglas activas y enviar√° notificaciones a los clientes que cumplan las condiciones.');
    });

    /* ===== GIFT CARD QR SCANNER ===== */
    let giftHtml5QrcodeScanner = null;
    const giftScanDialog = document.getElementById('giftScanDialog');
    const giftScanStatus = document.getElementById('gift-scan-status');

    // Bot√≥n para abrir scanner
    document.getElementById('btn-scan-gift-card')?.addEventListener('click', () => {
      openGiftScanner();
    });

    // Bot√≥n para cerrar scanner
    document.getElementById('gift-scan-close')?.addEventListener('click', () => {
      closeGiftScanner();
    });

    function openGiftScanner() {
      if (typeof Html5Qrcode === 'undefined') {
        alert('‚ùå Librer√≠a de scanner no disponible');
        return;
      }

      giftScanDialog.showModal();
      giftScanStatus.textContent = 'Iniciando c√°mara...';

      // Inicializar scanner
      giftHtml5QrcodeScanner = new Html5Qrcode('gift-qr-reader');

      const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      };

      giftHtml5QrcodeScanner.start(
        { facingMode: 'environment' }, // C√°mara trasera
        config,
        onGiftScanSuccess,
        onGiftScanError
      ).then(() => {
        giftScanStatus.textContent = 'üì∑ Escanea el QR de la gift card';
      }).catch(err => {
        console.error('Error iniciando c√°mara:', err);
        giftScanStatus.textContent = '‚ùå Error al iniciar c√°mara';
      });
    }

    function closeGiftScanner() {
      if (giftHtml5QrcodeScanner) {
        giftHtml5QrcodeScanner.stop().then(() => {
          giftHtml5QrcodeScanner.clear();
          giftHtml5QrcodeScanner = null;
        }).catch(err => {
          console.error('Error cerrando scanner:', err);
        });
      }
      giftScanDialog.close();
    }

    async function onGiftScanSuccess(decodedText) {
      console.log('‚úÖ QR escaneado:', decodedText);
      giftScanStatus.textContent = '‚úÖ QR detectado, procesando...';

      // Detener scanner
      if (giftHtml5QrcodeScanner) {
        await giftHtml5QrcodeScanner.stop();
      }

      // Procesar gift card
      await processGiftCardScan(decodedText);
    }

    function onGiftScanError(error) {
      // Silenciar errores de escaneo continuo
    }

    async function processGiftCardScan(giftId) {
      try {
        // Buscar gift card
        const response = await fetch(`/api/admin/gift-card/${giftId}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Gift card no encontrada');
        }

        const giftCard = await response.json();

        // Verificar si ya fue canjeada
        if (giftCard.redeemed) {
          giftScanStatus.textContent = '‚ö†Ô∏è Esta gift card ya fue canjeada';
          alert(`‚ö†Ô∏è Gift card ya canjeada\n\nCanjeada por: ${giftCard.redeemedBy || 'No disponible'}\nFecha: ${new Date(giftCard.redeemedAt).toLocaleString('es-MX')}`);
          setTimeout(() => {
            closeGiftScanner();
          }, 2000);
          return;
        }

        // Confirmar canje
        const confirmed = confirm(`¬øCanjear gift card?\n\nServicio: ${giftCard.service}\nCliente: ${giftCard.clientName || 'An√≥nimo'}\n\n¬øMarcar como canjeada?`);

        if (!confirmed) {
          giftScanStatus.textContent = 'Canje cancelado';
          setTimeout(() => {
            closeGiftScanner();
          }, 1500);
          return;
        }

        // Marcar como canjeada
        const redeemResponse = await fetch(`/api/admin/gift-card/${giftId}/redeem`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });

        if (!redeemResponse.ok) {
          throw new Error('Error al canjear');
        }

        giftScanStatus.textContent = '‚úÖ Gift card canjeada correctamente';
        alert('‚úÖ Gift card canjeada exitosamente');

        // Recargar lista de gift cards si estamos en ese tab
        if (!document.getElementById('tab-events').classList.contains('hidden')) {
          loadGiftHistory();
        }

        setTimeout(() => {
          closeGiftScanner();
        }, 1500);

      } catch (error) {
        console.error('Error procesando gift card:', error);
        giftScanStatus.textContent = `‚ùå ${error.message}`;
        alert(`‚ùå Error: ${error.message}`);
        setTimeout(() => {
          closeGiftScanner();
        }, 2000);
      }
    }

    /* ===== SESI√ìN Y PROTECCI√ìN ===== */
    async function loadMe() {
      try {
        const r = await fetch("/api/admin/me", { credentials: "include" });

        // ‚≠ê CR√çTICO: Si no hay sesi√≥n v√°lida, redirigir al login
        if (!r.ok) {
          console.log("Sin sesi√≥n v√°lida, redirigiendo a login...");
          window.location.href = "/admin-login.html";
          return;
        }

        const j = await r.json();
        $("#me-line").textContent = "Sesi√≥n: " + (j.email || j.uid || "admin");

        // ‚≠ê CR√çTICO: Quitar la pantalla negra solo cuando la sesi√≥n sea v√°lida
        document.body.classList.remove('checking-auth');
        document.body.classList.add('auth-verified');

        // Cargar datos iniciales
        loadMetrics('week');
      } catch (e) {
        console.error("Error verificando sesi√≥n:", e);
        // Si hay error de red o servidor, tambi√©n redirigir
        window.location.href = "/admin-login.html";
      }
    }

    // ‚≠ê CR√çTICO: Verificar sesi√≥n ANTES de mostrar cualquier cosa
    loadMe();

    /* ===== TABS ===== */
    document.querySelectorAll('[data-tab]').forEach(tab => {
      tab.addEventListener('click', function (e) {
        e.preventDefault();

        document.querySelectorAll('.nav a').forEach(a => a.classList.remove('is-active'));
        this.classList.add('is-active');

        document.querySelectorAll('[id^="tab-"]').forEach(s => s.classList.add('hidden'));

        const targetId = 'tab-' + this.getAttribute('data-tab');
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
          targetSection.classList.remove('hidden');
        }

        const tabName = this.getAttribute('data-tab');
        if (tabName === 'overview') {
          loadMetrics(document.getElementById('stats-filter').value);
        } else if (tabName === 'cards') {
          loadCards(1);
        } else if (tabName === 'settings') {
          loadNotificationsHistory();
        }
      });
    });

    /* ===== FILTRADO Y REPORTES ===== */
    let globalStatsData = {};

    // Evento cambio de filtro
    document.getElementById('stats-filter').addEventListener('change', (e) => {
      loadMetrics(e.target.value);
    });

    // Evento descargar reporte
    document.getElementById('btn-download-report').addEventListener('click', downloadCSV);

    function downloadCSV() {
      if (!globalStatsData.clientsToExport || globalStatsData.clientsToExport.length === 0) {
        alert('‚ö†Ô∏è No hay datos para exportar. Espera a que carguen las m√©tricas.');
        return;
      }

      // Get selected modules from localStorage
      const selectedModules = getSelectedModules();

      const period = document.getElementById('stats-filter').value;
      const periodLabel = period === 'day' ? 'Hoy' : period === 'week' ? 'Esta Semana' : 'Este Mes';

      let csvContent = 'data:text/csv;charset=utf-8,';

      // Header
      csvContent += `REPORTE DE LEALTAD VENUS\r\n`;
      csvContent += `Periodo: ${periodLabel}\r\n`;
      csvContent += `Generado: ${new Date().toLocaleString('es-MX')}\r\n`;
      csvContent += `\r\n`;

      // ===== KPIs Section (if enabled) =====
      if (selectedModules.kpis !== false) {
        csvContent += `M√âTRICAS GENERALES\r\n`;
        csvContent += `M√©trica,Valor\r\n`;
        csvContent += `Total Tarjetas Activas,${globalStatsData.total || 0}\r\n`;
        csvContent += `Tarjetas Completadas,${globalStatsData.full || 0}\r\n`;
        csvContent += `Sellos en este periodo,${globalStatsData.stamps || 0}\r\n`;
        csvContent += `Canjes en este periodo,${globalStatsData.redeems || 0}\r\n`;
        csvContent += `Promedio de Sellos,${globalStatsData.avg || 0}\r\n`;
        csvContent += `Tasa de Completitud,${globalStatsData.rate || '0%'}\r\n`;
        csvContent += `\r\n`;
      }

      // ===== Top Clients Section (if enabled) =====
      if (selectedModules.topClients !== false && globalStatsData.clients && globalStatsData.clients.length > 0) {
        csvContent += `TOP CLIENTES\r\n`;
        csvContent += `Nombre,Sellos,Meta,Estado,Progreso\r\n`;
        globalStatsData.clients.forEach(c => {
          const estado = c.stamps >= c.max ? "Completada" : "En curso";
          const progreso = Math.round((c.stamps / c.max) * 100) + '%';
          const name = (c.name || "Sin nombre").replace(/,/g, "");
          csvContent += `${name},${c.stamps},${c.max},${estado},${progreso}\r\n`;
        });
        csvContent += `\r\n`;
      }

      // ===== Wallet Stats Section (if enabled) =====
      if (selectedModules.walletStats !== false && globalStatsData.walletStats) {
        csvContent += `ESTADO DE WALLETS\r\n`;
        csvContent += `Plataforma,Cantidad\r\n`;
        csvContent += `Google Wallet,${globalStatsData.walletStats.google || 0}\r\n`;
        csvContent += `Apple Wallet,${globalStatsData.walletStats.apple || 0}\r\n`;
        csvContent += `Dispositivos Totales,${globalStatsData.walletStats.total || 0}\r\n`;
        csvContent += `\r\n`;
      }

      // ===== All Cards Data =====
      csvContent += `TODAS LAS TARJETAS\r\n`;
      csvContent += `Nombre,Tel√©fono,Sellos Actuales,Meta,Estado,Fecha Nacimiento,√öltima Visita,Creada,Visitas Totales,Ciclos Completados,Servicios Favoritos,Notas\r\n`;

      globalStatsData.clientsToExport.forEach(c => {
        const estado = c.stamps >= c.max ? "Completada" : "En curso";
        const phone = c.phone || "";
        const bday = c.birthdate || "";
        const last = c.last_visit ? new Date(c.last_visit).toLocaleDateString() : (c.updated_at ? new Date(c.updated_at).toLocaleDateString() : "");
        const created = c.createdAt ? new Date(c.createdAt).toLocaleDateString() : "";
        const name = (c.name || "Sin nombre").replace(/,/g, "");

        // ‚≠ê FASE 5: Nuevas columnas
        const visitedCount = c.visitedCount || 0;
        const cyclesCompleted = c.cyclesCompleted || 0;
        const favoriteServices = (c.favoriteServices || "").replace(/,/g, ";"); // Reemplazar comas
        const notes = (c.notes || "").replace(/,/g, ";").replace(/\r?\n/g, " "); // Reemplazar comas y saltos de l√≠nea

        csvContent += `${name},${phone},${c.stamps},${c.max},${estado},${bday},${last},${created},${visitedCount},${cyclesCompleted},${favoriteServices},${notes}\r\n`;
      });

      // Create download
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', `venus_reporte_${period}_${Date.now()}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      console.log('‚úÖ CSV generado con m√≥dulos:', Object.keys(selectedModules).filter(k => selectedModules[k] !== false));
    }

    /* ===== METRICS (Firestore) - MEJORADO CON FILTROS ===== */
    let activityChart = null;

    async function loadMetrics(range = 'week') {
      try {
        // Actualizar etiquetas seg√∫n el rango
        updatePeriodLabels(range);

        // M√©tricas b√°sicas con filtro de rango
        const response = await fetch(`/api/admin/metrics-firebase?range=${range}`, {
          credentials: 'include'
        });
        const data = await response.json();

        // KPIs principales
        document.getElementById('kpi-total').textContent = data.total || 0;
        document.getElementById('kpi-full').textContent = data.full || 0;

        // Actualizar seg√∫n el rango
        if (range === 'day') {
          document.getElementById('kpi-stamps').textContent = data.stampsToday || 0;
          document.getElementById('kpi-redeems').textContent = data.redeemsToday || 0;
        } else if (range === 'week') {
          document.getElementById('kpi-stamps').textContent = data.stampsWeek || 0;
          document.getElementById('kpi-redeems').textContent = data.redeemsWeek || 0;
        } else if (range === 'month') {
          document.getElementById('kpi-stamps').textContent = data.stampsMonth || 0;
          document.getElementById('kpi-redeems').textContent = data.redeemsMonth || 0;
        }

        // Promedio sellos
        const avg = data.total > 0 ? (((data.totalStamps || 0) / data.total)).toFixed(1) : '0.0';
        document.getElementById('kpi-avg').textContent = avg;

        // Tasa de completitud
        const rate = data.total > 0 ? ((data.full / data.total) * 100).toFixed(0) : '0';
        document.getElementById('kpi-rate').textContent = rate + '%';

        // Cargar componentes adicionales
        await loadTopClients();
        await loadActivityChart(range);
        await loadWalletStats();

        // Fetch ALL cards for Birthdays & Report
        // Note: For large datasets, this should be paginated or a separate endpoint
        try {
          const cardsResp = await fetch('/api/admin/cards-firebase?limit=1000', { credentials: 'include' });
          if (cardsResp.ok) {
            const cardsData = await cardsResp.json();
            checkOverviewBirthdays(cardsData.items || []);

            // Populate globalStatsData.clients with ALL clients for the report
            // (loadTopClients only gets top 5)
            if (cardsData.items) {
              globalStatsData.allClients = cardsData.items;
            }
          }
        } catch (e) {
          console.error("Error fetching cards for overview:", e);
        }

        // Guardar datos para reporte
        globalStatsData = {
          ...globalStatsData, // Keep allClients if set
          total: data.total || 0,
          full: data.full || 0,
          stampsPeriod: range === 'day' ? data.stampsToday : (range === 'week' ? data.stampsWeek : data.stampsMonth),
          redeemsPeriod: range === 'day' ? data.redeemsToday : (range === 'week' ? data.redeemsWeek : data.redeemsMonth),
          avg: avg,
          rate: rate,
          range: range
        };

      } catch (error) {
        console.error('Error:', error);
        // En caso de error, cargar datos de ejemplo
        loadSampleData(range);
      }
    }

    function updatePeriodLabels(range) {
      const stampsLabel = document.getElementById('stamps-period-label');
      const redeemsLabel = document.getElementById('redeems-period-label');
      const activityTitle = document.getElementById('activity-title');

      if (range === 'day') {
        stampsLabel.textContent = 'Sellos hoy';
        redeemsLabel.textContent = 'Canjes hoy';
        activityTitle.textContent = 'üìà Actividad hoy';
      } else if (range === 'week') {
        stampsLabel.textContent = 'Sellos esta semana';
        redeemsLabel.textContent = 'Canjes esta semana';
        activityTitle.textContent = 'üìà Actividad reciente (7 d√≠as)';
      } else if (range === 'month') {
        stampsLabel.textContent = 'Sellos este mes';
        redeemsLabel.textContent = 'Canjes este mes';
        activityTitle.textContent = 'üìà Actividad mensual';
      }
    }


    /* ===== ADVANCED KPIS (NUEVO - FASE 3) ===== */
    let dayChart = null;
    let hourChart = null;

    async function loadAdvancedKPIs(range = 'week') {
      try {
        // Obtener todas las tarjetas para an√°lisis
        const response = await fetch('/api/admin/cards-all?limit=1000', {
          credentials: 'include'
        });
        const data = await response.json();
        const cards = data.items || [];

        const now = new Date();
        const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

        // Determinar rango para "clientes nuevos"
        let periodStart;
        if (range === 'day') {
          periodStart = new Date(now.setHours(0, 0, 0, 0));
        } else if (range === 'week') {
          periodStart = new Date(now - 7 * 24 * 60 * 60 * 1000);
        } else {
          periodStart = new Date(now.getFullYear(), now.getMonth(), 1);
        }

        // 1. Clientes nuevos
        const newClients = cards.filter(c => {
          if (!c.createdAt) return false;
          return new Date(c.createdAt) >= periodStart;
        });

        // 2 & 3. Clientes activos e inactivos (√∫ltimos 30 d√≠as)
        const activeClients = cards.filter(c => {
          const lastVisit = c.last_visit || c.updated_at;
          if (!lastVisit) return false;
          return new Date(lastVisit) >= thirtyDaysAgo;
        });
        const inactiveClients = cards.length - activeClients.length;

        // 4. Promedio d√≠as desde √∫ltima visita
        let totalDays = 0;
        let count = 0;
        cards.forEach(c => {
          const lastVisit = c.last_visit || c.updated_at;
          if (lastVisit) {
            const days = Math.floor((Date.now() - new Date(lastVisit).getTime()) / (24 * 60 * 60 * 1000));
            totalDays += days;
            count++;
          }
        });
        const avgLastVisit = count > 0 ? Math.round(totalDays / count) : 0;

        // 5. Ciclos completados
        const cyclesCompleted = cards.filter(c => c.stamps >= c.max).length;

        // 6. Tasa de retorno (activos / total)
        const returnRate = cards.length > 0 ? Math.round((activeClients.length / cards.length) * 100) : 0;

        // Actualizar UI
        document.getElementById('kpi-new-clients').textContent = newClients.length;
        document.getElementById('kpi-active-clients').textContent = `${activeClients.length} (${returnRate}%)`;
        document.getElementById('kpi-inactive-clients').textContent = inactiveClients;
        document.getElementById('kpi-avg-last-visit').textContent = `${avgLastVisit} d√≠as`;
        document.getElementById('kpi-cycles-completed').textContent = cyclesCompleted;
        document.getElementById('kpi-return-rate').textContent = `${returnRate}%`;

        // 7. Renderizar gr√°ficas de distribuci√≥n
        renderDayDistribution(cards);
        renderHourDistribution(cards);

        console.log('üìä KPIs avanzados cargados');
      } catch (error) {
        console.error('Error cargando KPIs avanzados:', error);
        // Valores por defecto en caso de error
        document.getElementById('kpi-new-clients').textContent = '‚Äî';
        document.getElementById('kpi-active-clients').textContent = '‚Äî';
        document.getElementById('kpi-inactive-clients').textContent = '‚Äî';
        document.getElementById('kpi-avg-last-visit').textContent = '‚Äî';
        document.getElementById('kpi-cycles-completed').textContent = '‚Äî';
        document.getElementById('kpi-return-rate').textContent = '‚Äî';
      }
    }

    function renderDayDistribution(cards) {
      const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
      const dayCounts = [0, 0, 0, 0, 0, 0, 0];

      cards.forEach(c => {
        const lastVisit = c.last_visit || c.updated_at;
        if (lastVisit) {
          const day = new Date(lastVisit).getDay();
          dayCounts[day]++;
        }
      });

      const ctx = document.getElementById('day-distribution-chart');
      if (dayChart) dayChart.destroy();

      dayChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dayNames,
          datasets: [{
            label: 'Visitas',
            data: dayCounts,
            backgroundColor: 'rgba(140, 150, 104, 0.6)',
            borderColor: 'rgb(140, 150, 104)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#e5e7eb', font: { size: 11 } },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            },
            x: {
              ticks: { color: '#e5e7eb', font: { size: 11 } },
              grid: { display: false }
            }
          }
        }
      });
    }

    function renderHourDistribution(cards) {
      const hourCounts = new Array(24).fill(0);

      cards.forEach(c => {
        const lastVisit = c.last_visit || c.updated_at;
        if (lastVisit) {
          const hour = new Date(lastVisit).getHours();
          hourCounts[hour]++;
        }
      });

      const ctx = document.getElementById('hour-distribution-chart');
      if (hourChart) hourChart.destroy();

      hourChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
          datasets: [{
            label: 'Visitas',
            data: hourCounts,
            borderColor: 'rgb(140, 150, 104)',
            backgroundColor: 'rgba(140, 150, 104, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#e5e7eb', font: { size: 11 } },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            },
            x: {
              ticks: { color: '#e5e7eb', font: { size: 10 }, maxRotation: 0 },
              grid: { display: false }
            }
          }
        }
      });
    }

    function loadSampleData(range) {
      // Datos de ejemplo para cuando la API falle
      let labels, dataStamps, kpiStamps, kpiRedeems;

      if (range === 'day') {
        labels = ['10:00', '12:00', '14:00', '16:00', '18:00', '20:00'];
        dataStamps = [2, 5, 1, 8, 4, 6];
        kpiStamps = 26;
        kpiRedeems = 3;
      } else if (range === 'week') {
        labels = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
        dataStamps = [12, 19, 3, 5, 22, 30, 15];
        kpiStamps = 106;
        kpiRedeems = 8;
      } else { // month
        labels = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];
        dataStamps = [80, 120, 95, 110];
        kpiStamps = 405;
        kpiRedeems = 25;
      }

      // Actualizar UI con datos de ejemplo
      document.getElementById('kpi-total').textContent = "142";
      document.getElementById('kpi-full').textContent = "18";
      document.getElementById('kpi-stamps').textContent = kpiStamps;
      document.getElementById('kpi-redeems').textContent = kpiRedeems;
      document.getElementById('kpi-avg').textContent = "5.2";
      document.getElementById('kpi-rate').textContent = "13%";

      // Actualizar gr√°fica
      renderChart(labels, dataStamps);

      // Simular Top Clientes
      renderSampleTopClients();

      // Guardar datos para reporte
      globalStatsData = {
        total: 142,
        full: 18,
        stampsPeriod: kpiStamps,
        redeemsPeriod: kpiRedeems,
        avg: "5.2",
        rate: "13",
        range: range
      };
    }

    function renderChart(labels, data) {
      const ctx = document.getElementById('activity-chart');

      // Destruir gr√°fica anterior si existe
      if (activityChart) {
        activityChart.destroy();
      }

      activityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Sellos',
            data: data,
            borderColor: '#8c9668',
            backgroundColor: 'rgba(140, 150, 104, 0.15)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: '#8c9668',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 10,
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#8c9668',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#e5e7eb',
                font: { size: 11 }
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#e5e7eb',
                font: { size: 11 }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    function renderSampleTopClients() {
      const clients = [
        { name: 'Ana L√≥pez', stamps: 7, max: 8 },
        { name: 'Carlos Ruiz', stamps: 8, max: 8 },
        { name: 'Sof√≠a Mendoza', stamps: 4, max: 8 },
        { name: 'Roberto Garc√≠a', stamps: 6, max: 8 },
        { name: 'Laura Torres', stamps: 8, max: 8 }
      ];

      const tbody = document.getElementById('top-clients');
      tbody.innerHTML = clients.map(c => `
        <tr>
          <td>${c.name}</td>
          <td>${c.stamps}/${c.max}</td>
          <td>
            ${c.stamps >= c.max
          ? '<span class="tag">üéÅ Completa</span>'
          : `<span class="muted">${c.max - c.stamps} m√°s</span>`
        }
          </td>
        </tr>
      `).join('');

      // Guardar para el reporte
      globalStatsData.clients = clients;
    }

    async function loadTopClients() {
      try {
        const response = await fetch('/api/admin/top-clients', {
          credentials: 'include'
        });
        const data = await response.json();

        const tbody = document.getElementById('top-clients');
        if (!data.clients || data.clients.length === 0) {
          tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:12px;" class="muted">No hay datos</td></tr>`;
          return;
        }

        tbody.innerHTML = data.clients.slice(0, 5).map(c => `
          <tr>
            <td>${c.name || 'Sin nombre'}</td>
            <td>${c.stamps}/${c.max}</td>
            <td>
              ${c.stamps >= c.max
            ? '<span class="tag">üéÅ Completa</span>'
            : `<span class="muted">${c.max - c.stamps} m√°s</span>`
          }
            </td>
          </tr>
        `).join('');

        // Guardar para el reporte
        globalStatsData.clients = data.clients.slice(0, 5);
      } catch (error) {
        console.error('Error cargando top clients:', error);
        renderSampleTopClients();
      }
    }

    async function loadActivityChart(range = 'week') {
      try {
        const response = await fetch(`/api/admin/activity-${range}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('API no disponible');
        }

        const data = await response.json();
        const ctx = document.getElementById('activity-chart');

        // Destruir gr√°fica anterior si existe
        if (activityChart) {
          activityChart.destroy();
        }

        activityChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.labels || ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
            datasets: [{
              label: 'Sellos',
              data: data.stamps || [0, 0, 0, 0, 0, 0, 0],
              borderColor: '#8c9668',
              backgroundColor: 'rgba(140, 150, 104, 0.15)',
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#8c9668',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 10,
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: '#8c9668',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: '#e5e7eb',
                  font: { size: 11 }
                },
                grid: {
                  color: 'rgba(255, 255, 255, 0.1)'
                }
              },
              x: {
                ticks: {
                  color: '#e5e7eb',
                  font: { size: 11 }
                },
                grid: {
                  display: false
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error cargando gr√°fica:', error);
        // Si falla, no hacemos nada ya que loadSampleData ya renderiz√≥ una gr√°fica
      }
    }

    /* ===== WALLET STATS MEJORADO ===== */
    async function loadWalletStats() {
      try {
        // Primero intentar con el nuevo endpoint de device-stats
        try {
          const deviceStatsResponse = await fetch('/api/admin/device-stats', {
            credentials: 'include'
          });

          if (deviceStatsResponse.ok) {
            const deviceStats = await deviceStatsResponse.json();

            // Mostrar en UI
            document.getElementById('kpi-google').textContent = deviceStats.googleWallet || 0;
            document.getElementById('kpi-apple').textContent = deviceStats.appleWallet || 0;
            document.getElementById('kpi-devices').textContent = deviceStats.totalDevices || 0;

            // ‚≠ê Guardar en globalStatsData para CSV
            globalStatsData.walletStats = {
              google: deviceStats.googleWallet || 0,
              apple: deviceStats.appleWallet || 0,
              total: deviceStats.totalDevices || 0
            };

            console.log('üì± Wallet stats cargadas exitosamente');
            return;
          }
        } catch (e) {
          console.log('Nuevo endpoint device-stats no disponible, usando endpoint legacy');
        }

        // Fallback al endpoint legacy
        const response = await fetch('/api/admin/wallet-stats', {
          credentials: 'include'
        });
        const data = await response.json();

        document.getElementById('kpi-google').textContent = data.googleWallets || 0;
        document.getElementById('kpi-apple').textContent = data.appleWallets || 0;
        document.getElementById('kpi-devices').textContent = data.appleDevices || 0;
      } catch (error) {
        console.error('Error cargando wallet stats:', error);
        document.getElementById('kpi-google').textContent = '‚Äî';
        document.getElementById('kpi-apple').textContent = '‚Äî';
        document.getElementById('kpi-devices').textContent = '‚Äî';
      }
    }

    // Bot√≥n para actualizar estad√≠sticas de wallets
    document.getElementById('btn-refresh-wallet-stats')?.addEventListener('click', loadWalletStats);

    /* ===== CARDS (Firestore + men√∫ de acciones) ===== */
    let currentPage = 1;
    let cardsCache = {};
    let currentCardId = null;

    async function loadCards(page = 1) {
      try {
        const searchQuery = document.getElementById('search-cards').value;
        const sortValue = document.getElementById('sort-cards').value;
        const [sortField, sortOrder] = sortValue.split(':');

        const url = `/api/admin/cards-firebase?page=${page}&q=${encodeURIComponent(searchQuery)}&sort=${sortField}&order=${sortOrder}`;

        const response = await fetch(url, {
          credentials: 'include'
        });

        if (!response.ok) throw new Error('Error ' + response.status);

        const data = await response.json();
        const tbody = document.getElementById('cards-tbody');

        if (!data.items || data.items.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:12px;" class="muted">No hay tarjetas</td></tr>`;
          return;
        }

        cardsCache = {};
        data.items.forEach(c => { cardsCache[c.id] = c; });

        // Check birthdays
        checkBirthdays(data.items);

        tbody.innerHTML = data.items.map(card => {
          // Formatear cumplea√±os
          let birthdayStr = '‚Äî';
          if (card.birthdate) {
            const [y, m, d] = card.birthdate.split('-').map(Number);
            const monthNames = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
            birthdayStr = `${d} ${monthNames[m - 1]}`;
          }

          // Formatear √∫ltima visita
          let lastVisitStr = '‚Äî';
          if (card.last_visit) {
            lastVisitStr = new Date(card.last_visit).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' });
          } else if (card.updated_at) {
            lastVisitStr = new Date(card.updated_at).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' });
          }

          // Formatear fecha creaci√≥n
          let createdStr = '‚Äî';
          if (card.createdAt) {
            createdStr = new Date(card.createdAt).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' });
          }

          return `
          <tr data-card-id="${card.id}">
            <!-- ID REMOVED from view -->
            <td>
              <div style="font-weight:500;">${card.name || '‚Äî'}</div>
              <div class="muted" style="font-size:11px;">ID: ${card.id.substring(0, 8)}...</div>
            </td>
            <td>${card.phone || '‚Äî'}</td>
            <td>${birthdayStr}</td>
            <td>${lastVisitStr}</td>
            <td>${createdStr}</td>
            <td>
              <div style="display:flex;align-items:center;gap:6px;">
                <span style="font-weight:600;">${card.stamps}</span>
                <span class="muted">/ ${card.max}</span>
              </div>
            </td>
            <td><span class="tag">${card.status || 'active'}</span></td>
            <td>
              <div class="row" style="gap:4px;flex-wrap:wrap;">
                <button class="btn small" data-action="view">Ver</button>
                <button class="btn small" data-action="copy">Copiar ID</button>
                <button class="btn small" data-action="open">Abrir cliente</button>
                <button class="btn small" data-action="stamp">+1 sello</button>

                <button class="btn small" data-action="redeem">Canjear</button>
                <button class="btn small ghost" data-action="delete">Eliminar</button>
              </div>
            </td>
          </tr>
        `}).join('');

        document.getElementById('page-info').textContent =
          `P√°gina ${data.page} de ${data.totalPages} (${data.total} total)`;
        document.getElementById('btn-prev-page').disabled = data.page === 1;
        document.getElementById('btn-next-page').disabled = data.page === data.totalPages;
        currentPage = data.page;
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('cards-tbody').innerHTML =
          `<tr><td colspan="8" style="text-align:center;padding:12px;color:#fecaca;">Error: ${error.message}</td></tr>`;
      }
    }

    // Event listener for sorting
    document.getElementById('sort-cards').addEventListener('change', () => loadCards(1));

    document.getElementById('btn-prev-page').addEventListener('click', () => {
      if (currentPage > 1) loadCards(currentPage - 1);
    });

    document.getElementById('btn-next-page').addEventListener('click', () => {
      loadCards(currentPage + 1);
    });

    // ===== B√öSQUEDA INSTANT√ÅNEA CON DEBOUNCE =====
    let searchTimeout;
    const searchInput = document.getElementById('search-cards');
    const searchBtn = document.getElementById('btn-search-cards');

    // Instant search con debounce de 300ms
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        console.log('üîç B√∫squeda instant√°nea:', e.target.value);
        loadCards(1);
      }, 300);
    });

    // Mantener funcionalidad del bot√≥n de b√∫squeda
    searchBtn.addEventListener('click', () => loadCards(1));

    // Enter key tambi√©n busca
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        clearTimeout(searchTimeout); // Cancelar debounce
        loadCards(1);
      }
    });
    document.getElementById('btn-reload-cards').addEventListener('click', () => loadCards(currentPage));

    document.getElementById('cards-tbody').addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;

      const tr = btn.closest('tr[data-card-id]');
      if (!tr) return;

      const cardId = tr.dataset.cardId;
      const card = cardsCache[cardId] || { id: cardId };
      const action = btn.dataset.action;

      switch (action) {
        case 'view':
          openCardModal(card);
          break;
        case 'copy':
          await copyCardId(cardId);
          break;
        case 'open':
          openClientPage(cardId);
          break;
        case 'stamp':
          await stampCard(cardId);
          break;
        case 'redeem':
          await redeemCard(cardId);
          break;
        case 'delete':
          await deleteCard(cardId);
          break;
      }
    });

    /* ===== ESC√ÅNER QR (html5-qrcode) ===== */
    const scanDialog = $("#scanDialog");
    const scanStatus = $("#scan-status");
    let html5QrCode = null;

    $("#btn-scan-card").addEventListener("click", async () => {
      scanDialog.showModal();
      await startScan();
    });

    $("#scan-close").addEventListener("click", () => {
      stopScan();
      scanDialog.close();
    });

    async function startScan() {
      try {
        scanStatus.textContent = "Iniciando c√°mara...";

        // Crear instancia de html5-qrcode
        html5QrCode = new Html5Qrcode("qr-reader");

        // Iniciar escaneo
        await html5QrCode.start(
          { facingMode: "environment" }, // C√°mara trasera
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          async (decodedText, decodedResult) => {
            // ‚úÖ QR detectado exitosamente
            console.log("QR detectado:", decodedText);
            scanStatus.textContent = "‚úÖ QR detectado";

            // Detener esc√°ner
            await stopScan();

            // Procesar el QR
            await handleScan(decodedText);

            // Cerrar di√°logo
            scanDialog.close();
          },
          (errorMessage) => {
            // Ignorar errores de no detectar QR (son normales)
          }
        );

        scanStatus.textContent = "üì∑ Apunta al QR de la tarjeta...";

      } catch (err) {
        console.error("Error iniciando c√°mara:", err);
        scanStatus.textContent = "‚ùå No se pudo acceder a la c√°mara";

        // Si falla, pedir permisos expl√≠citamente
        if (err.name === 'NotAllowedError') {
          scanStatus.textContent = "‚ö†Ô∏è Por favor permite el acceso a la c√°mara";
        }
      }
    }

    async function stopScan() {
      if (html5QrCode && html5QrCode.isScanning) {
        try {
          await html5QrCode.stop();
          console.log("Esc√°ner detenido");
        } catch (err) {
          console.error("Error deteniendo esc√°ner:", err);
        }
      }
      html5QrCode = null;
    }

    function extractCardId(text) {
      try {
        const u = new URL(text);
        let c = u.searchParams.get("cardId");
        if (c) return c;
        c = u.searchParams.get("card");
        if (c) return c;
      } catch { }
      if (/^card_\d+/.test(text)) return text;
      return null;
    }

    async function handleScan(raw) {
      const cid = extractCardId(raw);
      if (!cid) {
        scanStatus.textContent = "QR inv√°lido.";
        return;
      }

      stopScan();
      scanDialog.close();

      let card = cardsCache[cid];

      if (!card) {
        try {
          const r = await fetch('/api/card/' + encodeURIComponent(cid), {
            credentials: 'include'
          });
          if (r.ok) {
            card = await r.json();
          }
        } catch (e) {
          console.error('Error buscando tarjeta por ID', e);
        }
      }

      if (!card) {
        alert('Tarjeta no encontrada');
        return;
      }

      openCardModal(card);
    }

    /* ===== GIFT CARDS MEJORADO ===== */
    window.currentGiftCard = null;

    document.getElementById('gift-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      // 1. Obtener datos
      const clientName = (document.getElementById('gift-name').value || '').trim() || 'Cliente';
      const service = (document.getElementById('gift-service').value || '').trim();

      if (!service) { alert('Ingresa un servicio'); return; }

      // 2. Calcular fechas e IDs
      const giftId = 'gift_' + Date.now();
      const expirationDate = new Date();
      expirationDate.setDate(expirationDate.getDate() + 30);
      const formattedDate = expirationDate.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });

      // 3. Actualizar la VISTA VISUAL (Nuevo dise√±o)
      document.getElementById('gift-visual-service').textContent = service;
      document.getElementById('gift-visual-client').textContent = `Para: ${clientName}`;
      document.getElementById('gift-visual-date').textContent = `V√°lida hasta: ${formattedDate}`;

      // 4. Generar QR
      const payloadText = `GIFT|codigo=${giftId}|servicio=${service}|cliente=${clientName}|vence=${expirationDate.toISOString().slice(0, 10)}`;
      const giftCanvas = document.getElementById('gift-qr');

      try {
        // Aseguramos que el canvas est√© limpio
        const ctx = giftCanvas.getContext('2d');
        ctx.clearRect(0, 0, giftCanvas.width, giftCanvas.height);

        // Usamos la librer√≠a qrcode (aseg√∫rate de haberla importado en el head)
        await QRCode.toCanvas(giftCanvas, payloadText, {
          width: 150,
          margin: 0,
          color: { dark: '#000000', light: '#ffffff' }
        });

      } catch (err) {
        console.error(err);
        alert('Error generando QR. Verifica que la librer√≠a qrcode.min.js est√© en el <head>');
        return;
      }

      // 5. Mostrar resultados
      document.getElementById('gift-preview-container').classList.remove('hidden');
      document.getElementById('gift-actions').classList.remove('hidden');
      document.getElementById('gift-success').classList.remove('hidden');

      // Guardar referencia global
      window.currentGiftCard = { id: giftId, client: clientName, service, expires: formattedDate };
    });

    // --- L√≥gica para compartir IMAGEN COMPLETA en WhatsApp ---
    document.getElementById('gift-whatsapp-image').addEventListener('click', async function () {
      if (!window.currentGiftCard) return;

      const btn = this;
      const originalText = btn.textContent;
      btn.textContent = 'Generando imagen...';

      try {
        // Seleccionamos el div con el dise√±o completo
        const elementToCapture = document.getElementById('gift-card-visual');

        // Usamos html2canvas para crear una imagen de todo el div
        const canvasFull = await html2canvas(elementToCapture, {
          scale: 2, // Mejor calidad
          backgroundColor: null // Transparencia si aplica
        });

        const imageDataURL = canvasFull.toDataURL('image/png');
        const gift = window.currentGiftCard;

        const message = `üéÅ ¬°Hola ${gift.client}!\n\n` +
          `Te env√≠o una Gift Card de Venus Cosmetolog√≠a para:\n` +
          `‚ú® *${gift.service}*\n\n` +
          `Presenta la imagen adjunta en tu pr√≥xima visita. üåø`;

        // L√≥gica de env√≠o (Web Share API o Descarga)
        if (navigator.share && navigator.canShare) {
          const blob = await (await fetch(imageDataURL)).blob();
          const file = new File([blob], 'gift-card-venus.png', { type: 'image/png' });
          try {
            await navigator.share({
              title: 'Gift Card Venus',
              text: message,
              files: [file]
            });
          } catch (err) {
            if (err.name !== 'AbortError') fallbackWhatsAppShare(message, imageDataURL);
          }
        } else {
          fallbackWhatsAppShare(message, imageDataURL);
        }
      } catch (e) {
        console.error(e);
        alert('Error al generar la imagen');
      } finally {
        btn.textContent = originalText;
      }
    });

    function fallbackWhatsAppShare(message, imageDataURL) {
      // Crea un enlace de descarga autom√°tico
      const link = document.createElement('a');
      link.download = 'gift-card-venus.png';
      link.href = imageDataURL;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      setTimeout(() => {
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message + '\n\n(Adjunta la imagen descargada)')}`;
        window.open(whatsappUrl, '_blank');
      }, 1000);
    }

    document.getElementById('gift-copy').addEventListener('click', function () {
      if (!window.currentGiftCard) return;
      const gift = window.currentGiftCard;
      const text =
        `üéÅ Gift Card Venus Cosmetolog√≠a\n\n` +
        `‚ú® Servicio: ${gift.service}\n` +
        `üë§ A nombre de: ${gift.client}\n` +
        `üìÖ Vigente hasta: ${gift.expires}\n` +
        `üîë C√≥digo: ${gift.id}\n\n` +
        `Presenta este mensaje en tu visita üíö`;

      navigator.clipboard.writeText(text).then(() => {
        const originalText = this.textContent;
        this.textContent = '‚úÖ Copiado';
        setTimeout(() => {
          this.textContent = originalText;
        }, 2000);
      }).catch(() => {
        alert('No se pudo copiar el texto');
      });
    });

    document.getElementById('gift-whatsapp').addEventListener('click', function () {
      if (!window.currentGiftCard) return;

      const gift = window.currentGiftCard;
      const message =
        `üéÅ ¬°Hola ${gift.client}!\n\n` +
        `Tienes una Gift Card de Venus Cosmetolog√≠a:\n\n` +
        `‚ú® Servicio: ${gift.service}\n` +
        `üìÖ V√°lida hasta: ${gift.expires}\n` +
        `üîë C√≥digo: ${gift.id}\n\n` +
        `Presenta este c√≥digo en tu cita üíö`;

      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    });

    /* ===== PUSH NOTIFICATIONS - CORREGIDO ===== */
    const typeEmojis = {
      'promo': 'üéÅ Promoci√≥n',
      'reminder': '‚è∞ Recordatorio',
      'update': '‚ÑπÔ∏è Actualizaci√≥n',
      'alert': '‚ö†Ô∏è Alerta'
    };

    document.getElementById('push-title').addEventListener('input', function () {
      document.getElementById('preview-title').textContent = this.value || '¬°Nueva promoci√≥n!';
    });

    document.getElementById('push-message').addEventListener('input', function () {
      document.getElementById('preview-message').textContent = this.value || 'Tu mensaje aparecer√° aqu√≠...';
    });

    document.getElementById('push-type').addEventListener('change', function () {
      document.getElementById('preview-type').textContent = typeEmojis[this.value];
    });

    document.getElementById('push-notification-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const title = document.getElementById('push-title').value;
      const message = document.getElementById('push-message').value;
      const type = document.getElementById('push-type').value;

      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Enviando...';
      submitBtn.disabled = true;

      try {
        const response = await fetch('/api/admin/push-notification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            title,
            message,
            type,
            // ‚úÖ CORREGIDO: Especificar que es alerta visible
            alertType: 'visible',
            badge: 1,
            sound: 'default'
          })
        });

        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        document.getElementById('push-count').textContent = data.passCount;
        document.getElementById('push-success').classList.remove('hidden');
        document.getElementById('push-error').classList.add('hidden');

        this.reset();
        document.getElementById('preview-title').textContent = '¬°Nueva promoci√≥n!';
        document.getElementById('preview-message').textContent = 'Tu mensaje aparecer√° aqu√≠...';

        loadNotificationsHistory();

        setTimeout(() => {
          document.getElementById('push-success').classList.add('hidden');
        }, 5000);

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('push-error').classList.remove('hidden');
        document.getElementById('push-success').classList.add('hidden');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    document.getElementById('test-push').addEventListener('click', async function () {
      const title = document.getElementById('push-title').value;
      const message = document.getElementById('push-message').value;

      if (!title || !message) {
        alert('Completa t√≠tulo y mensaje primero');
        return;
      }

      const originalText = this.textContent;
      this.textContent = 'Enviando...';
      this.disabled = true;

      try {
        const response = await fetch('/api/admin/push-test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            title,
            message,
            type: document.getElementById('push-type').value,
            // ‚úÖ CORREGIDO: Especificar que es alerta visible
            alertType: 'visible'
          })
        });

        const data = await response.json();

        if (data.success) {
          alert(`‚úÖ Prueba enviada a: ${data.cardId}`);
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      } finally {
        this.textContent = originalText;
        this.disabled = false;
      }
    });

    async function loadNotificationsHistory() {
      try {
        const response = await fetch('/api/admin/notifications', {
          credentials: 'include'
        });

        if (!response.ok) throw new Error('Error cargando historial');

        const data = await response.json();
        const tbody = document.getElementById('notifications-history');

        if (!data.notifications || data.notifications.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:12px;" class="muted">No hay notificaciones</td></tr>`;
          return;
        }

        tbody.innerHTML = data.notifications.map(n => {
          const date = new Date(n.createdAt);
          const dateStr = date.toLocaleDateString('es-ES', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
          }) + ', ' + date.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
          });

          return `
            <tr>
              <td>${dateStr}</td>
              <td>${n.title}</td>
              <td>${typeEmojis[n.type] || n.type}</td>
              <td>${n.googleSent}/${n.cardsSent}</td>
              <td>${n.errors > 0 ? `<span style="color:#fecaca">${n.errors}</span>` : '0'}</td>
            </tr>
          `;
        }).join('');

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('notifications-history').innerHTML =
          `<tr><td colspan="5" style="text-align:center;padding:12px;color:#fecaca;">Error cargando historial</td></tr>`;
      }
    }

    document.getElementById('refresh-history').addEventListener('click', loadNotificationsHistory);

    // ===== Modal Tarjeta =====
    const modalBackdrop = document.getElementById('card-modal-backdrop');
    const modalCloseBtn = document.getElementById('cm-close');
    const modalId = document.getElementById('cm-id');
    const modalName = document.getElementById('cm-name');
    const modalPhone = document.getElementById('cm-phone');
    const modalStamps = document.getElementById('cm-stamps');
    const modalStatus = document.getElementById('cm-status');
    const modalQrCanvas = document.getElementById('card-qr');

    async function openCardModal(card) {
      currentCardId = card.id;
      modalId.textContent = card.id;
      modalName.textContent = card.name || '‚Äî';
      modalPhone.textContent = card.phone || '‚Äî';
      modalStamps.textContent = `${card.stamps} / ${card.max}`;
      modalStatus.textContent = card.status || 'active';

      // ‚≠ê FASE 5: Cargar informaci√≥n adicional del cliente
      loadClientInfo(card);

      modalBackdrop.classList.remove('hidden');

      // Resetear formulario de notificaci√≥n
      document.getElementById('notify-form-container').classList.add('hidden');
      document.getElementById('notify-title').value = 'Recordatorio Venus';
      document.getElementById('notify-message').value = '';

      const url = `${window.location.origin}/?cardId=${encodeURIComponent(card.id)}`;

      // CORRECCI√ìN CR√çTICA: Generar QR correctamente esperando a que est√© lista la librer√≠a
      if (typeof QRCode !== 'undefined' && modalQrCanvas) {
        try {
          // Limpiar canvas anterior
          const ctx = modalQrCanvas.getContext('2d');
          ctx.clearRect(0, 0, modalQrCanvas.width, modalQrCanvas.height);

          // Generar nuevo QR
          await QRCode.toCanvas(modalQrCanvas, url, {
            width: 170,
            height: 170,
            margin: 2,
            color: {
              dark: '#000000',
              light: '#ffffff'
            }
          });
          console.log('QR de tarjeta generado exitosamente');
        } catch (err) {
          console.error('Error generando QR de tarjeta:', err);
          // Mostrar mensaje de error en el canvas
          const ctx = modalQrCanvas.getContext('2d');
          ctx.fillStyle = '#fff';
          ctx.fillRect(0, 0, 170, 170);
          ctx.fillStyle = '#000';
          ctx.font = '12px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('Error generando QR', 85, 85);
        }
      } else {
        console.error('QRCode library no disponible');
      }
    }

    function closeCardModal() {
      modalBackdrop.classList.add('hidden');
      currentCardId = null;
    }

    modalCloseBtn.addEventListener('click', closeCardModal);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeCardModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modalBackdrop.classList.contains('hidden')) {
        closeCardModal();
      }
    });

    // ===== Helpers acciones tarjeta - CORREGIDOS =====
    async function copyCardId(cardId) {
      try {
        await navigator.clipboard.writeText(cardId);
        alert('‚úÖ ID copiado al portapapeles');
      } catch (e) {
        alert('No se pudo copiar el ID');
      }
    }

    function openClientPage(cardId) {
      const url = `${window.location.origin}/?cardId=${encodeURIComponent(cardId)}`;
      window.open(url, '_blank');
    }

    /* ===== PHASE 5: LOAD & SAVE CLIENT INFO ===== */
    function loadClientInfo(card) {
      // Cargar campos editables
      document.getElementById('cm-notes').value = card.notes || '';
      document.getElementById('cm-favorite-services').value = card.favoriteServices || '';

      // Cargar stats calculados
      document.getElementById('cm-visited-count').textContent = card.visitedCount || 0;
      document.getElementById('cm-cycles-completed').textContent = card.cyclesCompleted || 0;

      // Formatear y mostrar lastVisit
      if (card.last_visit || card.updated_at) {
        const lastVisitDate = new Date(card.last_visit || card.updated_at);
        document.getElementById('cm-last-visit').textContent = lastVisitDate.toLocaleDateString('es-MX');
      } else {
        document.getElementById('cm-last-visit').textContent = '‚Äî';
      }
    }

    async function saveClientInfo() {
      if (!currentCardId) return;

      const notes = document.getElementById('cm-notes').value;
      const favoriteServices = document.getElementById('cm-favorite-services').value;

      try {
        const response = await fetch('/api/admin/update-client-info', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: currentCardId,
            notes,
            favoriteServices
          })
        });

        const data = await response.json();

        if (response.ok) {
          alert('‚úÖ Informaci√≥n guardada correctamente');
          // Actualizar cache
          if (cardsCache[currentCardId]) {
            cardsCache[currentCardId].notes = notes;
            cardsCache[currentCardId].favoriteServices = favoriteServices;
          }
        } else {
          alert(`‚ùå Error: ${data.error || 'No se pudo guardar'}`);
        }
      } catch (error) {
        console.error('Error guardando informaci√≥n:', error);
        alert('‚ùå Error al guardar informaci√≥n');
      }
    }

    // Event listener para bot√≥n guardar
    document.getElementById('cm-save-notes')?.addEventListener('click', saveClientInfo);

    /* ===== STAMP CARD - CORREGIDO PARA ACTUALIZAR GOOGLE WALLET ===== */
    async function stampCard(cardId) {
      if (!confirm('¬øAgregar 1 sello a esta tarjeta?')) return;
      try {
        const r = await fetch('/api/admin/stamp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cardId })
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          throw new Error(data.error || 'No se pudo agregar sello');
        }

        // ‚úÖ CORRECCI√ìN CR√çTICA: Actualizar Google Wallet inmediatamente
        try {
          const card = cardsCache[cardId];
          if (card) {
            // Calcular nuevos stamps
            const newStamps = (card.stamps || 0) + 1;

            // Actualizar Google Wallet
            const { updateLoyaltyObject } = await import("./lib/google.js");
            await updateLoyaltyObject(cardId, card.name, newStamps, card.max);
            console.log(`[GOOGLE WALLET] ‚úÖ Stamp actualizado para: ${cardId} (${newStamps}/${card.max})`);
          }
        } catch (googleError) {
          console.error(`[GOOGLE WALLET] ‚ùå Error actualizando stamp:`, googleError.message);
        }

        await loadCards(currentPage);
        if (currentCardId === cardId) {
          const updated = cardsCache[cardId];
          if (updated) openCardModal(updated);
        }
        alert('‚úÖ Sello agregado y Google Wallet actualizado');
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    }

    async function redeemCard(cardId) {
      if (!confirm('¬øCanjear esta tarjeta? Se reiniciar√°n los sellos.')) return;
      try {
        const r = await fetch('/api/admin/redeem', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cardId })
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          throw new Error(data.error || 'No se pudo canjear');
        }

        // ‚úÖ CORRECCI√ìN: Actualizar Google Wallet despu√©s del canje
        try {
          const card = cardsCache[cardId];
          if (card) {
            const { updateLoyaltyObject } = await import("./lib/google.js");
            await updateLoyaltyObject(cardId, card.name, 0, card.max);
            console.log(`[GOOGLE WALLET] ‚úÖ Canje realizado para: ${cardId} (0/${card.max})`);
          }
        } catch (googleError) {
          console.error(`[GOOGLE WALLET] ‚ùå Error actualizando canje:`, googleError.message);
        }

        await loadCards(currentPage);
        if (currentCardId === cardId) {
          const updated = cardsCache[cardId];
          if (updated) openCardModal(updated);
        }
        alert('‚úÖ Canje realizado y Google Wallet actualizado');
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    }

    async function deleteCard(cardId) {
      if (!confirm('‚ö†Ô∏è Esto eliminar√° la tarjeta de la base de datos, eventos y Firestore. ¬øContinuar?')) return;
      try {
        const r = await fetch(`/api/admin/card/${encodeURIComponent(cardId)}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          throw new Error(data.error || 'No se pudo eliminar');
        }
        closeCardModal();
        await loadCards(currentPage);
        alert('‚úÖ Tarjeta eliminada');
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    }

    /* ===== REGISTRAR DISPOSITIVO GOOGLE (NUEVO) ===== */
    async function registerGoogleDevice(cardId) {
      try {
        let deviceId = localStorage.getItem('google_device_id');
        if (!deviceId) {
          deviceId = 'gdev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('google_device_id', deviceId);
        }

        const response = await fetch('/api/google/register-device', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            cardId: cardId,
            deviceId: deviceId
          })
        });

        const data = await response.json();

        if (data.success) {
          console.log('‚úÖ Dispositivo Google registrado:', deviceId);
          return true;
        } else {
          console.error('‚ùå Error registrando dispositivo Google:', data.error);
          return false;
        }
      } catch (error) {
        console.error('‚ùå Error registrando dispositivo Google:', error);
        return false;
      }
    }

    // Toggle del formulario de notificaci√≥n
    document.getElementById('cm-notify').addEventListener('click', () => {
      const form = document.getElementById('notify-form-container');
      form.classList.toggle('hidden');
      if (!form.classList.contains('hidden')) {
        document.getElementById('notify-message').focus();
      }
    });

    // Cancelar notificaci√≥n
    document.getElementById('btn-cancel-notify').addEventListener('click', () => {
      document.getElementById('notify-form-container').classList.add('hidden');
    });

    // Enviar notificaci√≥n individual
    document.getElementById('btn-send-notify').addEventListener('click', async function () {
      if (!currentCardId) return;

      const title = document.getElementById('notify-title').value;
      const message = document.getElementById('notify-message').value;

      if (!title || !message) {
        alert('Por favor completa el t√≠tulo y el mensaje');
        return;
      }

      const btn = this;
      const originalText = btn.textContent;
      btn.textContent = 'Enviando...';
      btn.disabled = true;

      try {
        const r = await fetch('/api/admin/push-one', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: currentCardId,
            title,
            message,
            type: 'personal',
            alertType: 'visible'
          })
        });
        const data = await r.json();

        if (!r.ok || !data.success) {
          throw new Error(data.error || 'No se pudo enviar la notificaci√≥n');
        }

        alert('‚úÖ Notificaci√≥n enviada exitosamente');
        document.getElementById('notify-form-container').classList.add('hidden');
        document.getElementById('notify-message').value = ''; // Limpiar mensaje

      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    });

    // ‚úÖ NUEVO: Bot√≥n para registrar dispositivo Google desde el modal
    document.getElementById('cm-register-google')?.addEventListener('click', async () => {
      if (currentCardId) {
        const success = await registerGoogleDevice(currentCardId);
        if (success) {
          alert('‚úÖ Dispositivo Google registrado exitosamente');
        } else {
          alert('‚ùå Error registrando dispositivo Google');
        }
      }
    });

    // Acciones desde el modal
    document.getElementById('cm-stamp').addEventListener('click', async () => {
      if (currentCardId) await stampCard(currentCardId);
    });

    document.getElementById('cm-redeem').addEventListener('click', async () => {
      if (currentCardId) await redeemCard(currentCardId);
    });

    document.getElementById('cm-copy').addEventListener('click', async () => {
      if (currentCardId) await copyCardId(currentCardId);
    });

    document.getElementById('cm-open-url').addEventListener('click', () => {
      if (currentCardId) openClientPage(currentCardId);
    });

    // ===== NUEVO: Bot√≥n WhatsApp =====
    document.getElementById('cm-whatsapp').addEventListener('click', () => {
      if (!currentCardId) return;

      const phone = cardsCache[currentCardId]?.phone;
      const name = cardsCache[currentCardId]?.name || 'Cliente';

      if (!phone) {
        alert('‚ö†Ô∏è Este cliente no tiene tel√©fono registrado');
        return;
      }

      // Limpiar el n√∫mero (remover espacios, guiones, etc.)
      const cleanPhone = phone.replace(/\D/g, '');

      // Mensaje predeterminado
      const message = encodeURIComponent(`Hola ${name}, te contacto de Venus Cosmetolog√≠a`);

      // Abrir WhatsApp
      window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
    });

    /* ===== DEBUGGING AVANZADO (NUEVO) ===== */

    // Test Apple Push
    document.getElementById('btn-test-apple-push')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta para prueba:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = 'üß™ Enviando prueba Apple Push...';

      try {
        const response = await fetch('/api/debug/test-apple-push', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: cardId,
            title: "üî• PRUEBA APPLE PUSH",
            message: "Si ves esto, las notificaciones Apple funcionan correctamente!"
          })
        });

        const data = await response.json();
        output.innerHTML = `‚úÖ Resultado Apple Push:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `‚ùå Error Apple Push:<br>${error.message}`;
      }
    });

    // Test Google Push
    document.getElementById('btn-test-google-push')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta para prueba:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = 'üß™ Enviando prueba Google Push...';

      try {
        const response = await fetch('/api/debug/test-google-push', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: cardId,
            title: "üî• PRUEBA GOOGLE PUSH",
            message: "Esto debe aparecer en Google Wallet"
          })
        });

        const data = await response.json();
        output.innerHTML = `‚úÖ Resultado Google Push:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `‚ùå Error Google Push:<br>${error.message}`;
      }
    });

    // Reparar Google Wallet
    document.getElementById('btn-fix-google-wallet')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta a reparar:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = 'üîß Reparando objeto Google Wallet...';

      try {
        const response = await fetch(`/api/debug/fix-google-wallet/${cardId}`, {
          method: 'POST',
          credentials: 'include'
        });

        const data = await response.json();
        output.innerHTML = `‚úÖ Google Wallet reparado:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `‚ùå Error reparando Google Wallet:<br>${error.message}`;
      }
    });

    /* ===== BIRTHDAY LOGIC (Cards Tab) ===== */
    function checkBirthdays(cards) {
      const today = new Date();
      const currentMonth = today.getMonth(); // 0-11
      const currentDay = today.getDate();

      const upcomingBirthdays = cards.filter(card => {
        if (!card.birthdate) return false;
        // Parse YYYY-MM-DD manually to avoid timezone issues
        const [y, m, d] = card.birthdate.split('-').map(Number);
        const bMonth = m - 1; // 0-11
        const bDay = d;

        // Check if birthday is in the next 7 days
        if (bMonth === currentMonth) {
          return bDay >= currentDay && bDay <= currentDay + 7;
        }
        // Handle month wrapping
        const nextMonthDate = new Date(today);
        nextMonthDate.setDate(today.getDate() + 7);
        if (nextMonthDate.getMonth() !== currentMonth && bMonth === nextMonthDate.getMonth()) {
          return bDay <= nextMonthDate.getDate();
        }
        return false;
      });

      const section = document.getElementById('birthday-section');
      const list = document.getElementById('birthday-list');
      const actions = document.getElementById('birthday-actions');

      if (upcomingBirthdays.length === 0) {
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');
      list.innerHTML = upcomingBirthdays.map(c => {
        const [y, m, d] = c.birthdate.split('-').map(Number);

        // Calculate days until (handling year wrap if needed, though simpler here)
        const now = new Date(); now.setHours(0, 0, 0, 0);
        const nextBday = new Date(today.getFullYear(), m - 1, d);
        if (nextBday < now) nextBday.setFullYear(now.getFullYear() + 1);

        const diffTime = nextBday - now;
        const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        let actionBtn = '';
        if (daysUntil <= 2 && daysUntil >= 0) {
          actionBtn = `<button onclick="sendBirthdayPush('${c.id}', '${c.name}')" class="btn small primary" style="font-size:10px; padding: 2px 6px;">üéÅ Felicitar</button>`;
        }

        const monthNames = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];

        return `
          <div style="background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 16px;">üéâ</span>
            <div>
              <div style="font-weight: 600; font-size: 13px;">${c.name || 'Cliente'}</div>
              <div class="muted" style="font-size: 11px;">${d} de ${monthNames[m - 1]}</div>
            </div>
            ${actionBtn}
          </div>
        `;
      }).join('');

      actions.innerHTML = `<span class="tag" style="background:#ffd166; color:#000;">${upcomingBirthdays.length} pendientes</span>`;
    }

    /* ===== BIRTHDAY LOGIC (Overview Tab) ===== */
    function checkOverviewBirthdays(cards) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Calculate 30 days ago and 30 days ahead
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);

      const thirtyDaysAhead = new Date(today);
      thirtyDaysAhead.setDate(today.getDate() + 30);

      // Filter birthdays
      const allBirthdays = cards.filter(card => {
        if (!card.birthdate) return false;
        const [y, m, d] = card.birthdate.split('-').map(Number);
        const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

        // Include birthdays from 30 days ago to 30 days ahead
        return birthdayThisYear >= thirtyDaysAgo && birthdayThisYear <= thirtyDaysAhead;
      });

      const section = document.getElementById('overview-birthday-section');
      const upcomingContainer = document.getElementById('upcoming-birthdays-container');
      const pastContainer = document.getElementById('past-birthdays-container');
      const upcomingList = document.getElementById('upcoming-birthday-list');
      const pastList = document.getElementById('past-birthday-list');

      if (allBirthdays.length === 0) {
        section.classList.add('hidden');
        return;
      }

      // Separate into past and upcoming
      const pastBirthdays = [];
      const upcomingBirthdays = [];

      allBirthdays.forEach(card => {
        const [y, m, d] = card.birthdate.split('-').map(Number);
        const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

        if (birthdayThisYear < today) {
          pastBirthdays.push(card);
        } else {
          upcomingBirthdays.push(card);
        }
      });

      section.classList.remove('hidden');

      const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

      // Render upcoming birthdays (sorted by date, closest first)
      if (upcomingBirthdays.length > 0) {
        upcomingContainer.classList.remove('hidden');
        upcomingBirthdays.sort((a, b) => {
          const [ya, ma, da] = a.birthdate.split('-').map(Number);
          const [yb, mb, db] = b.birthdate.split('-').map(Number);
          const dateA = new Date(today.getFullYear(), ma - 1, da);
          const dateB = new Date(today.getFullYear(), mb - 1, db);
          return dateA - dateB; // Soonest first
        });

        upcomingList.innerHTML = upcomingBirthdays.map(c => {
          const [y, m, d] = c.birthdate.split('-').map(Number);
          const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

          const diffTime = birthdayThisYear - today;
          const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          let actionBtn = '';
          let daysLabel = '';

          if (daysUntil === 0) {
            daysLabel = '<span style="color: #ffd166; font-weight: 600;">üéâ Hoy</span>';
            actionBtn = `<button onclick="sendBirthdayPush('${c.id}', '${c.name}')" class="btn small primary" style="font-size:10px; padding: 2px 6px;">üéÅ Felicitar</button>`;
          } else {
            daysLabel = `<span style="color: #a7f3d0;">en ${daysUntil} d√≠a${daysUntil > 1 ? 's' : ''}</span>`;
          }

          return `
            <div style="background: rgba(167, 243, 208, 0.1); border: 1px solid rgba(167, 243, 208, 0.2); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 16px;">üéà</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 13px;">${c.name || 'Cliente'}</div>
                <div class="muted" style="font-size: 11px;">${d} de ${monthNames[m - 1].toLowerCase()} ‚Ä¢ ${daysLabel}</div>
              </div>
              ${actionBtn}
            </div>
          `;
        }).join('');
      } else {
        upcomingContainer.classList.add('hidden');
      }

      // Render past birthdays (sorted by date, most recent first)
      if (pastBirthdays.length > 0) {
        pastContainer.classList.remove('hidden');
        pastBirthdays.sort((a, b) => {
          const [ya, ma, da] = a.birthdate.split('-').map(Number);
          const [yb, mb, db] = b.birthdate.split('-').map(Number);
          const dateA = new Date(today.getFullYear(), ma - 1, da);
          const dateB = new Date(today.getFullYear(), mb - 1, db);
          return dateB - dateA; // Most recent first
        });

        pastList.innerHTML = pastBirthdays.map(c => {
          const [y, m, d] = c.birthdate.split('-').map(Number);
          const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

          const diffTime = today - birthdayThisYear;
          const daysAgo = Math.floor(diffTime / (1000 * 60 * 60 * 24));

          const daysLabel = `<span style="color: #cbd5e1;">hace ${daysAgo} d√≠a${daysAgo > 1 ? 's' : ''}</span>`;

          return `
            <div style="background: rgba(203, 213, 225, 0.1); border: 1px solid rgba(203, 213, 225, 0.2); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 16px;">üéÇ</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 13px;">${c.name || 'Cliente'}</div>
                <div class="muted" style="font-size: 11px;">${d} de ${monthNames[m - 1].toLowerCase()} ‚Ä¢ ${daysLabel}</div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        pastContainer.classList.add('hidden');
      }
    }

    window.sendBirthdayPush = async function (cardId, name) {
      if (!confirm(`¬øEnviar felicitaci√≥n de cumplea√±os a ${name}?`)) return;

      try {
        const r = await fetch('/api/admin/push-one', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: cardId,
            title: "üéÇ ¬°Feliz Cumplea√±os!",
            message: `¬°Hola ${name}! En Venus queremos celebrarte. Ven por un regalo especial en tu pr√≥xima visita. üéâ`,
            type: 'promo',
            alertType: 'visible'
          })
        });
        const data = await r.json();
        if (!r.ok || !data.success) {
          throw new Error(data.error || 'No se pudo enviar');
        }
        alert('‚úÖ Felicitaci√≥n enviada exitosamente');
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    };

    // Ver dispositivos
    document.getElementById('btn-check-devices')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta para ver dispositivos:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = 'üì± Cargando informaci√≥n de dispositivos...';

      try {
        // Dispositivos Apple
        const appleResponse = await fetch(`/api/debug/apple-devices?cardId=${cardId}`, {
          credentials: 'include'
        });
        const appleData = await appleResponse.json();

        // Dispositivos Google
        const googleResponse = await fetch(`/api/debug/google-devices/${cardId}`, {
          credentials: 'include'
        });
        const googleData = await googleResponse.json();

        output.innerHTML = `
          <strong>üì± Dispositivos para ${cardId}:</strong><br><br>
          <strong>üçé Apple:</strong> ${appleData.devices?.length || 0} dispositivos<br>
          <strong>üü¢ Google:</strong> ${googleData.deviceCount || 0} dispositivos<br><br>
          <strong>Detalles Apple:</strong><br>${JSON.stringify(appleData.devices || [], null, 2)}<br><br>
          <strong>Detalles Google:</strong><br>${JSON.stringify(googleData.devices || [], null, 2)}
        `;
      } catch (error) {
        output.innerHTML = `‚ùå Error cargando dispositivos:<br>${error.message}`;
      }
    });

    // Ver configuraci√≥n APNs
    document.getElementById('btn-check-apns')?.addEventListener('click', async function () {
      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = 'üçé Verificando configuraci√≥n APNs...';

      try {
        const response = await fetch('/api/debug/apple-apns', {
          credentials: 'include'
        });

        const data = await response.json();
        output.innerHTML = `‚úÖ Configuraci√≥n APNs:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `‚ùå Error verificando APNs:<br>${error.message}`;
      }
    });

    // Logout
    document.getElementById('logout').addEventListener('click', async () => {
      try {
        await fetch('/api/logout', { method: 'POST', credentials: 'include' });
        window.location.href = '/admin-login.html';
      } catch (error) {
        console.error('Error al cerrar sesi√≥n:', error);
        window.location.href = '/admin-login.html';
      }
    });

    /* =========================================================
       L√ìGICA DEL BOT√ìN "ENVIAR A TODOS"
       ========================================================= */

    // Prevent form submission from interfering with buttons
    const pushForm = document.getElementById('push-notification-form');
    if (pushForm) {
      pushForm.addEventListener('submit', (e) => {
        e.preventDefault();
        console.log('Form submission prevented');
      });
    }

    const btnGlobal = document.getElementById('btn-mass-push');
    console.log('üîç Buscando bot√≥n btn-mass-push:', btnGlobal);

    if (btnGlobal) {
      console.log('‚úÖ Bot√≥n encontrado, agregando event listener');

      btnGlobal.addEventListener('click', async (e) => {
        e.preventDefault(); // Prevent any form submission
        e.stopPropagation(); // Stop event bubbling

        console.log('üöÄ Bot√≥n "Enviar a todos" clickeado');

        const title = document.getElementById('push-title').value.trim();
        const message = document.getElementById('push-message').value.trim();

        console.log('üìù T√≠tulo:', title);
        console.log('üìù Mensaje:', message);

        if (!title || !message) {
          console.warn('‚ö†Ô∏è Faltan datos');
          return alert("‚ö†Ô∏è Faltan datos: Escribe t√≠tulo y mensaje.");
        }

        if (!confirm(`üö® ¬øENVIAR A TODOS?\n\n"${title}"`)) {
          console.log('‚ùå Usuario cancel√≥');
          return;
        }

        const originalText = btnGlobal.textContent;
        btnGlobal.innerHTML = `<span style="display: inline-flex; align-items: center; gap: 6px;"><span class="spinner"></span> Enviando...</span>`;
        btnGlobal.disabled = true;

        console.log('üì° Enviando petici√≥n a /api/admin/push-all...');

        try {
          const r = await fetch('/api/admin/push-all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ title, message })
          });

          console.log('üì• Respuesta recibida:', r.status);
          const data = await r.json();
          console.log('üì¶ Data:', data);

          if (data.success) {
            const apple = data.results?.apple || 0;
            const google = data.results?.google || 0;
            console.log('‚úÖ √âxito! Apple:', apple, 'Google:', google);
            alert(`‚úÖ ¬°ENVIADO!\n\nüçè Apple: ${apple}\nü§ñ Google: ${google}`);
            // Limpiar campos
            document.getElementById('push-title').value = "";
            document.getElementById('push-message').value = "";
          } else {
            console.error('‚ùå Error en respuesta:', data.error);
            alert('‚ö†Ô∏è Error: ' + (data.error || "Desconocido"));
          }
        } catch (e) {
          console.error('üí• Error de conexi√≥n:', e);
          alert('‚ùå Error de conexi√≥n: ' + e.message);
        } finally {
          btnGlobal.textContent = originalText;
          btnGlobal.disabled = false;
          console.log('üèÅ Proceso terminado');
        }
      });
    } else {
      console.error('‚ùå Bot√≥n btn-mass-push NO encontrado en el DOM');
    }
    /* =========================================================
       L√ìGICA DE CITAS
       ========================================================= */

    // Elementos
    const apptDateInput = document.getElementById('appt-filter-date');
    const btnRefreshAppts = document.getElementById('btn-refresh-appts');
    const btnNewAppt = document.getElementById('btn-new-appointment');
    const newApptDialog = document.getElementById('newApptDialog');
    const formNewAppt = document.getElementById('form-new-appt');
    const btnCancelAppt = document.getElementById('btn-cancel-appt');
    const apptsTbody = document.getElementById('appts-tbody');
    const serviceSelect = document.getElementById('new-appt-service');

    // Inicializar fecha hoy
    if (apptDateInput) {
      apptDateInput.valueAsDate = new Date();
    }

    // Cargar Servicios
    let allServices = [];
    async function loadServices() {
      try {
        const res = await fetch('/api/services');
        const json = await res.json();
        if (json.success && serviceSelect) {
          allServices = json.data;
          serviceSelect.innerHTML = '<option value="">Selecciona un servicio...</option>';
          json.data.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = `${s.name} (${s.durationMinutes} min)`;
            opt.dataset.name = s.name;
            opt.dataset.duration = s.durationMinutes;
            opt.dataset.price = s.price;
            serviceSelect.appendChild(opt);
          });
        }
      } catch (e) { console.error('Error loading services', e); }
    }

    // Autocomplete de clientes
    let allClients = [];
    const clientInput = document.getElementById('new-appt-client');
    const clientSuggestions = document.getElementById('client-suggestions');
    const phoneInput = document.getElementById('new-appt-phone');

    async function loadClients() {
      try {
        const res = await fetch('/api/admin/cards?limit=1000');
        const json = await res.json();
        if (json.items) {
          allClients = json.items;
        }
      } catch (e) { console.error('Error loading clients', e); }
    }

    if (clientInput) {
      clientInput.addEventListener('input', function () {
        const query = this.value.toLowerCase().trim();
        if (query.length < 2) {
          clientSuggestions.style.display = 'none';
          return;
        }

        const matches = allClients.filter(c =>
          c.name.toLowerCase().includes(query) ||
          (c.phone && c.phone.includes(query))
        ).slice(0, 5);

        if (matches.length > 0) {
          clientSuggestions.innerHTML = matches.map(c => `
            <div class="client-suggestion-item" data-id="${c.id}" data-name="${c.name}" data-phone="${c.phone || ''}">
              <div class="client-name">${c.name}</div>
              <div class="client-phone">${c.phone || 'Sin tel√©fono'}</div>
            </div>
          `).join('');
          clientSuggestions.style.display = 'block';

          // Event listeners para las sugerencias
          clientSuggestions.querySelectorAll('.client-suggestion-item').forEach(item => {
            item.addEventListener('click', function () {
              clientInput.value = this.dataset.name;
              phoneInput.value = this.dataset.phone || '';
              clientSuggestions.style.display = 'none';
            });
          });
        } else {
          clientSuggestions.style.display = 'none';
        }
      });

      // Cerrar sugerencias al hacer clic fuera
      document.addEventListener('click', function (e) {
        if (!clientInput.contains(e.target) && !clientSuggestions.contains(e.target)) {
          clientSuggestions.style.display = 'none';
        }
      });
    }

    // Bot√≥n "Nuevo cliente"
    const btnNewClient = document.getElementById('btn-new-client');
    if (btnNewClient) {
      btnNewClient.addEventListener('click', () => {
        clientInput.value = '';
        phoneInput.value = '';
        clientInput.focus();
      });
    }

    // Auto-llenar precio y calcular hora fin cuando se selecciona servicio
    const priceInput = document.getElementById('new-appt-price');
    const timeInput = document.getElementById('new-appt-time');
    const endTimeInput = document.getElementById('new-appt-end-time');

    if (serviceSelect) {
      serviceSelect.addEventListener('change', function () {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
          // Llenar precio
          const price = selectedOption.dataset.price;
          if (price && priceInput) {
            priceInput.value = price;
          }
          // Calcular hora fin
          calculateEndTime();
        }
      });
    }

    // Calcular hora fin cuando cambia la hora de inicio
    if (timeInput) {
      timeInput.addEventListener('change', calculateEndTime);
    }

    function calculateEndTime() {
      if (!timeInput || !endTimeInput || !serviceSelect) return;

      const startTime = timeInput.value;
      const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];

      if (!startTime || !selectedOption.value) return;

      const duration = parseInt(selectedOption.dataset.duration) || 60;

      // Parsear hora de inicio
      const [hours, minutes] = startTime.split(':').map(Number);
      const startDate = new Date();
      startDate.setHours(hours, minutes, 0);

      // Agregar duraci√≥n
      const endDate = new Date(startDate.getTime() + duration * 60000);

      // Formatear hora fin
      const endHours = String(endDate.getHours()).padStart(2, '0');
      const endMinutes = String(endDate.getMinutes()).padStart(2, '0');
      endTimeInput.value = `${endHours}:${endMinutes}`;
    }

    // Cargar Citas
    async function loadAppointments() {
      if (!apptsTbody) return;
      apptsTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;">Cargando...</td></tr>';

      const date = apptDateInput.value;
      try {
        const res = await fetch(`/api/appointments?date=${date}`);
        const json = await res.json();

        if (json.success) {
          if (json.data.length === 0) {
            apptsTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;" class="muted">No hay citas para este d√≠a</td></tr>';
            return;
          }

          apptsTbody.innerHTML = json.data.map(appt => {
            const time = new Date(appt.startDateTime).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', hour12: false });
            const statusColors = {
              'scheduled': 'var(--venus-green)',
              'cancelled': 'var(--err-text)',
              'completed': 'var(--ok-text)'
            };
            const statusLabels = {
              'scheduled': 'Agendada',
              'cancelled': 'Cancelada',
              'completed': 'Completada'
            };

            return `
              <tr>
                <td style="font-weight:bold;color:#fff;">${time}</td>
                <td>
                  <div>${appt.clientName}</div>
                  <div class="muted" style="font-size:11px;">${appt.clientPhone}</div>
                </td>
                <td>${appt.serviceName}</td>
                <td><span class="tag" style="background:rgba(255,255,255,0.1);color:${statusColors[appt.status] || '#fff'}">${statusLabels[appt.status] || appt.status}</span></td>
                <td>
                  ${appt.status === 'scheduled' ? `<button class="btn small ghost" onclick="cancelAppointment('${appt.id}')">Cancelar</button>` : ''}
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error(e);
        apptsTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--err-text);">Error cargando citas</td></tr>';
      }
    }

    // Cancelar Cita
    window.cancelAppointment = async (id) => {
      if (!confirm('¬øCancelar esta cita?')) return;
      try {
        await fetch(`/api/appointments/${id}/cancel`, { method: 'PATCH' });
        loadAppointments();
      } catch (e) { alert('Error: ' + e.message); }
    };

    // Event Listeners
    if (btnRefreshAppts) btnRefreshAppts.addEventListener('click', loadAppointments);
    if (apptDateInput) apptDateInput.addEventListener('change', loadAppointments);

    if (btnNewAppt) {
      btnNewAppt.addEventListener('click', () => {
        loadServices();
        loadClients();
        newApptDialog.showModal();
        // Set default date/time
        if (apptDateInput.value) document.getElementById('new-appt-date').value = apptDateInput.value;
      });
    }

    if (btnCancelAppt) {
      btnCancelAppt.addEventListener('click', () => newApptDialog.close());
    }

    if (formNewAppt) {
      formNewAppt.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = formNewAppt.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Agendando...';

        try {
          const serviceOpt = serviceSelect.options[serviceSelect.selectedIndex];

          const body = {
            name: document.getElementById('new-appt-client').value,
            phone: document.getElementById('new-appt-phone').value,
            serviceId: serviceSelect.value,
            serviceName: serviceOpt.dataset.name,
            date: document.getElementById('new-appt-date').value,
            time: document.getElementById('new-appt-time').value,
            durationMinutes: parseInt(serviceOpt.dataset.duration),
            sendWhatsAppConfirmation: document.getElementById('check-whatsapp-confirm').checked,
            sendWhatsApp24h: document.getElementById('check-whatsapp-24h').checked,
            sendWhatsApp2h: document.getElementById('check-whatsapp-2h').checked
          };

          const res = await fetch('/api/appointments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });

          const json = await res.json();
          if (json.success) {
            alert('‚úÖ Cita agendada');
            newApptDialog.close();
            formNewAppt.reset();
            loadAppointments();
          } else {
            alert('‚ùå Error: ' + json.error);
          }
        } catch (e) {
          alert('Error de conexi√≥n');
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });
    }

    // Auto-load when tab is shown
    // Detect hash change or click
    window.addEventListener('hashchange', () => {
      if (location.hash === '#appointments') loadAppointments();
    });
    // Initial load if hash is present
    if (location.hash === '#appointments') loadAppointments();

  </script>
</body>

</html>