<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Venus Lealtad</title>
  <link rel="icon" href="/assets/logo.png">
  <style>
    :root {
      --venus: #8c9668;
      --venus-green: #8c9668;
      --venus-soft: #dfe6c1;
      --bg: #3f4037;
      --ink: #1b1b1b;
      --muted: #e5e7eb;
      --line: rgba(255, 255, 255, 0.25);
      --err: #fecaca;
      --err-text: #991b1b;
      --ok: #bbf7d0;
      --ok-text: #166534;
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    html,
    body {
      height: 100%;
      font-family: system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, sans-serif;
      background: #2d2f28;
      color: #fff;
      overflow-x: hidden;
    }

    /* Animated gradient background */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 20% 30%, rgba(140, 150, 104, 0.15), transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(140, 150, 104, 0.12), transparent 50%),
        linear-gradient(135deg, #2d2f28 0%, #3a3d33 100%);
      animation: bgShift 20s ease-in-out infinite;
      z-index: 0;
    }

    @keyframes bgShift {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.85;
      }
    }

    /* Contenedor principal */
    .page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      position: relative;
      z-index: 1;
    }

    .container {
      width: 100%;
      max-width: 480px;
    }

    /* Glassmorphism card */
    .card {
      position: relative;
      background: linear-gradient(135deg, rgba(27, 28, 26, 0.8), rgba(140, 150, 104, 0.1));
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      padding: 28px 24px 24px;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.05) inset;
      overflow: hidden;
      animation: cardSlideIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes cardSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.08), transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(140, 150, 104, 0.1), transparent 50%);
      opacity: 0.6;
      pointer-events: none;
    }

    .card>* {
      position: relative;
      z-index: 1;
    }

    /* Logo with glow */
    .logo {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: #fff;
      margin: 0 auto 10px;
      display: block;
      box-shadow:
        0 0 20px rgba(140, 150, 104, 0.4),
        0 4px 12px rgba(0, 0, 0, 0.2);
      animation: logoGlow 3s ease-in-out infinite;
    }

    @keyframes logoGlow {

      0%,
      100% {
        box-shadow: 0 0 20px rgba(140, 150, 104, 0.4), 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      50% {
        box-shadow: 0 0 30px rgba(140, 150, 104, 0.6), 0 4px 12px rgba(0, 0, 0, 0.2);
      }
    }

    .title {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      color: #f9fafb;
      letter-spacing: -0.02em;
    }

    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      margin-top: 4px;
      color: rgba(255, 255, 255, 0.7);
    }

    .top-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 8px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin: 20px 0 16px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .tabs button {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.2);
      color: rgba(255, 255, 255, 0.8);
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      backdrop-filter: blur(5px);
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .tabs button:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .tabs button.active {
      background: rgba(140, 150, 104, 0.9);
      color: #f9fafb;
      border-color: rgba(140, 150, 104, 1);
      box-shadow: 0 2px 8px rgba(140, 150, 104, 0.3);
      font-weight: 600;
    }

    .section-title {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: 6px;
      color: #f9fafb;
    }

    .muted {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.65);
      margin-bottom: 12px;
    }

    /* Premium inputs */
    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      margin: 10px 0 5px;
      color: rgba(255, 255, 255, 0.9);
      letter-spacing: 0.01em;
    }

    input {
      width: 100%;
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.95);
      font-size: 0.9rem;
      outline: none;
      transition: all 0.2s ease;
      color: #1f2937;
    }

    input::placeholder {
      color: #9ca3af;
    }

    input:focus {
      border-color: var(--venus-green);
      box-shadow:
        0 0 0 3px rgba(140, 150, 104, 0.15),
        0 2px 8px rgba(140, 150, 104, 0.1);
      background: #fff;
      transform: translateY(-1px);
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    /* Premium buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      font-family: inherit;
      white-space: nowrap;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--venus-green) 0%, #9aa066 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(140, 150, 104, 0.3);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #9aa066 0%, var(--venus-green) 100%);
      box-shadow: 0 6px 16px rgba(140, 150, 104, 0.4);
      transform: translateY(-2px);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(140, 150, 104, 0.3);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.25);
      color: #f9fafb;
      backdrop-filter: blur(5px);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.35);
      transform: translateY(-1px);
    }

    /* Alerts */
    .alert {
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 0.8rem;
      margin-top: 8px;
      animation: alertSlideIn 0.3s ease;
    }

    @keyframes alertSlideIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .alert.ok {
      background: rgba(187, 247, 208, 0.95);
      color: var(--ok-text);
      border: 1px solid #4ade80;
    }

    .alert.err {
      background: rgba(254, 202, 202, 0.95);
      color: var(--err-text);
      border: 1px solid #fca5a5;
    }

    .link {
      color: rgba(255, 255, 255, 0.85);
      text-decoration: underline;
      text-underline-offset: 2px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .link:hover {
      color: #fff;
    }

    .footer {
      margin-top: 14px;
      text-align: center;
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.75rem;
    }

    .hidden {
      display: none
    }

    /* Responsive */
    @media (max-width:360px) {
      .card {
        padding: 20px 16px 16px;
      }

      .logo {
        width: 60px;
        height: 60px;
      }

      .title {
        font-size: 1.3rem;
      }

      .tabs button {
        font-size: 0.75rem;
        padding: 5px 10px;
      }

      input {
        font-size: 0.85rem;
      }
    }

    @media (min-width:768px) {
      .container {
        max-width: 520px;
      }

      .card {
        padding: 32px 32px 28px;
      }

      .logo {
        width: 84px;
        height: 84px;
      }

      .title {
        font-size: 1.7rem;
      }

      .subtitle {
        font-size: 1rem;
      }

      .section-title {
        font-size: 1.15rem;
      }

      input {
        font-size: 0.95rem;
        padding: 12px 16px;
      }

      .btn {
        font-size: 0.9rem;
        padding: 11px 20px;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <main class="container">
      <section class="card">
        <img class="logo" src="/assets/logo.png" alt="Venus">

        <h1 class="title">Admin — Venus Lealtad</h1>
        <p class="subtitle">Inicia sesión para entrar al panel</p>

        <div class="top-actions">
          <a class="btn btn-ghost" href="/" target="_blank" rel="noopener">Página clientes</a>
        </div>

        <nav class="tabs" role="tablist" aria-label="Cambiar sección">
          <button class="active" data-tab="login" aria-selected="true">Iniciar sesión</button>
          <button data-tab="register" aria-selected="false">Crear cuenta</button>
          <button data-tab="forgot" aria-selected="false">Olvidé mi contraseña</button>
          <button data-tab="reset" aria-selected="false" id="tab-reset-btn" class="hidden">Restablecer
            contraseña</button>
        </nav>

        <!-- LOGIN -->
        <section id="tab-login">
          <h2 class="section-title">Iniciar sesión</h2>
          <p class="muted">Escribe tu correo y contraseña.</p>
          <div id="login-alert" class="alert hidden"></div>
          <form id="form-login">
            <label>Correo electrónico</label>
            <input id="login-email" type="email" required placeholder="tucorreo@dominio.com">

            <label>Contraseña</label>
            <input id="login-pass" type="password" required placeholder="••••••••">

            <div class="row">
              <span class="link" data-goto="forgot">¿Olvidaste tu contraseña?</span>
              <button class="btn btn-primary" type="submit">Entrar</button>
            </div>
          </form>
        </section>

        <!-- REGISTER -->
        <section id="tab-register" class="hidden">
          <h2 class="section-title">Crear cuenta</h2>
          <p class="muted">Solo personal autorizado. Si el registro está cerrado, solicita acceso al administrador.</p>
          <div id="reg-alert" class="alert hidden"></div>
          <form id="form-register">
            <label>Correo electrónico</label>
            <input id="reg-email" type="email" required placeholder="tucorreo@dominio.com">

            <label>Contraseña</label>
            <input id="reg-pass" type="password" minlength="6" required placeholder="Mínimo 6 caracteres">

            <div style="margin-top:12px;text-align:right;">
              <button class="btn btn-primary" type="submit">Crear cuenta</button>
            </div>
          </form>
        </section>

        <!-- FORGOT -->
        <section id="tab-forgot" class="hidden">
          <h2 class="section-title">Restablecer contraseña</h2>
          <p class="muted">Te enviaremos un correo con un enlace para crear una nueva.</p>
          <div id="forgot-alert" class="alert hidden"></div>
          <form id="form-forgot">
            <label>Correo electrónico</label>
            <input id="forgot-email" type="email" required placeholder="tucorreo@dominio.com">

            <div style="margin-top:12px;text-align:right;">
              <button class="btn btn-primary" type="submit">Enviar enlace</button>
            </div>
          </form>
        </section>

        <!-- RESET -->
        <section id="tab-reset" class="hidden">
          <h2 class="section-title">Nueva contraseña</h2>
          <p class="muted">Ingresa tu nueva contraseña (debe tener al menos 6 caracteres).</p>
          <div id="reset-alert" class="alert hidden"></div>
          <form id="form-reset">
            <input id="reset-token" type="hidden">

            <label>Nueva contraseña</label>
            <input id="reset-pass" type="password" minlength="6" required placeholder="Mínimo 6 caracteres">

            <div style="margin-top:12px;text-align:right;">
              <button class="btn btn-primary" type="submit">Actualizar contraseña</button>
            </div>
          </form>
        </section>
      </section>

      <div class="footer">© Venus Cosmetología</div>
    </main>
  </div>

  <script>
    // Tabs
    const tabs = document.querySelectorAll('[data-tab]');
    const sections = {
      login: document.getElementById('tab-login'),
      register: document.getElementById('tab-register'),
      forgot: document.getElementById('tab-forgot'),
      reset: document.getElementById('tab-reset')
    };

    function activate(tab) {
      tabs.forEach(b => {
        const active = b.dataset.tab === tab;
        b.classList.toggle('active', active);
        b.setAttribute('aria-selected', active);
      });
      Object.entries(sections).forEach(([k, el]) => {
        if (k === tab) { el.classList.remove('hidden'); }
        else { el.classList.add('hidden'); }
      });

      // Special handling for reset tab button
      const resetBtn = document.getElementById('tab-reset-btn');
      if (tab === 'reset') {
        resetBtn.classList.remove('hidden');
      } else {
        const params = new URLSearchParams(location.search);
        if (!params.get('token')) {
          resetBtn.classList.add('hidden');
        }
      }

      const params = new URLSearchParams(location.search);
      params.set('view', tab);
      history.replaceState(null, '', '?' + params.toString());
    }

    tabs.forEach(b => b.addEventListener('click', () => activate(b.dataset.tab)));
    document.querySelectorAll('[data-goto]').forEach(a =>
      a.addEventListener('click', e => {
        e.preventDefault();
        activate(a.dataset.goto);
      })
    );
    // Check for reset token in URL on load
    const urlParams = new URLSearchParams(location.search);
    const urlView = urlParams.get('view');
    const resetToken = urlParams.get('token');

    if (resetToken && urlView === 'reset') {
      // Show reset tab button and activate reset view
      document.getElementById('tab-reset-btn').classList.remove('hidden');
      document.getElementById('reset-token').value = resetToken;
      activate('reset');
    } else if (urlView && sections[urlView]) {
      activate(urlView);
    }

    // helpers alerts
    function showAlert(id, type, msg) {
      const el = document.getElementById(id);
      el.className = 'alert ' + type;
      el.textContent = msg;
      el.classList.remove('hidden');
    }
    function openClientPage(cardId) {
      const url = `${window.location.origin}/?cardId=${encodeURIComponent(cardId)}`;
      window.open(url, '_blank');
    }

    // ✅ NUEVO: Abrir dialog de nueva cita con datos del cliente pre-llenados
    function openScheduleDialogForClient(card) {
      // 1. Cerrar el modal del cliente
      closeCardModal();

      // 2. Cambiar a la pestaña de Agenda
      switchView('agenda');

      // 3. Pre-llenar datos del cliente en el form
      const clientSelect = document.getElementById('new-appt-client-select');
      const phoneInput = document.getElementById('new-appt-phone');

      if (clientSelect) {
        clientSelect.value = card.name || '';
      }

      if (phoneInput) {
        phoneInput.value = card.phone || '';
      }

      // 4. Limpiar otros campos para nueva cita
      document.getElementById('new-appt-service').value = '';
      document.getElementById('new-appt-price').value = '';
      document.getElementById('new-appt-date').value = '';
      document.getElementById('new-appt-hour').value = '';
      document.getElementById('new-appt-minute').value = '';

      // 5. Ocultar el formulario de nuevo cliente si está visible
      const newClientForm = document.getElementById('new-client-form');
      if (newClientForm) {
        newClientForm.style.display = 'none';
      }

      // 6. Abrir el dialog
      const newApptDialog = document.getElementById('newApptDialog');
      if (newApptDialog) {
        newApptDialog.showModal();
      }
    }
    function clearAlert(id) {
      const el = document.getElementById(id);
      el.className = 'alert hidden';
      el.textContent = '';
    }

    // Submit: login
    document.getElementById('form-login').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearAlert('login-alert');
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-pass').value;
      const r = await fetch('/api/admin/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });
      const j = await r.json().catch(() => ({}));
      if (!r.ok) {
        showAlert(
          'login-alert',
          'err',
          j.error === 'invalid_credentials'
            ? 'Credenciales inválidas'
            : 'Error de inicio de sesión'
        );
        return;
      }
      location.href = '/admin';
    });

    // Submit: register
    document.getElementById('form-register').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearAlert('reg-alert');
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-pass').value;
      const r = await fetch('/api/admin/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });
      const j = await r.json().catch(() => ({}));
      if (!r.ok) {
        const map = {
          signup_disabled: 'Registro deshabilitado',
          email_in_use: 'Este correo ya está registrado',
          missing_fields: 'Faltan datos'
        };
        showAlert('reg-alert', 'err', map[j.error] || 'No se pudo crear la cuenta');
        return;
      }
      showAlert('reg-alert', 'ok', 'Cuenta creada. Ya puedes iniciar sesión.');
      setTimeout(() => activate('login'), 1200);
    });

    // Submit: forgot
    document.getElementById('form-forgot').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearAlert('forgot-alert');
      const email = document.getElementById('forgot-email').value.trim();
      const r = await fetch('/api/admin/forgot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      await r.json().catch(() => ({}));
      if (!r.ok) {
        showAlert('forgot-alert', 'err', 'No se pudo enviar el correo');
        return;
      }
      showAlert(
        'forgot-alert',
        'ok',
        'Te enviamos un enlace de restablecimiento si el correo existe en el sistema.'
      );
    });

    // Submit: reset
    document.getElementById('form-reset').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearAlert('reset-alert');
      const token = document.getElementById('reset-token').value;
      const password = document.getElementById('reset-pass').value;

      if (!token) {
        showAlert('reset-alert', 'err', 'Token inválido o ausente');
        return;
      }

      const r = await fetch('/api/admin/reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token, password })
      });
      const j = await r.json().catch(() => ({}));
      if (!r.ok) {
        const map = {
          invalid_token: 'El enlace no es válido',
          expired: 'El enlace expiró. Solicita uno nuevo.',
          missing_fields: 'Faltan datos'
        };
        showAlert('reset-alert', 'err', map[j.error] || 'No se pudo actualizar la contraseña');
        return;
      }
      showAlert('reset-alert', 'ok', 'Contraseña actualizada. Redirigiendo...');
      setTimeout(() => {
        location.href = '/admin-login.html?view=login';
      }, 1500);
    });
  </script>
</body>

</html>