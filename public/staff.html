<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Venus Lealtad</title>
  <link rel="icon" href="/assets/logo.png">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      background-color: #3f4037;
      font-family: 'Poppins', sans-serif;
    }

    .venus-card {
      background-color: #8c9668;
      border-radius: 20px;
      padding: 2rem;
      color: white;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .venus-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 30%, rgba(255,255,255,0.07), transparent 70%),
                  radial-gradient(circle at 80% 60%, rgba(255,255,255,0.05), transparent 70%);
      opacity: 0.7;
    }

    .venus-card * { position: relative; z-index: 2; }

    .brand__logo {
      width: 75px;
      height: 75px;
      border-radius: 50%;
      background: white;
      object-fit: cover;
      box-shadow: 0 0 10px rgba(255,255,255,0.4);
    }

    .grid div {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-weight: 600;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .hidden { display: none !important; }
  </style>
</head>

<body class="py-4">

  <main class="container d-flex flex-column align-items-center">

    <!-- =================== VISTA CREAR =================== -->
    <section id="view-create" class="venus-card w-100" style="max-width:480px;">
      
      <div class="text-center">
        <img src="/assets/logo.png" class="brand__logo mb-2" />
        <h1 class="fw-bold mt-2">Venus Lealtad</h1>
        <p class="opacity-75">Gana sellos y canjea tu facial ðŸŒ¿</p>

        <h2 class="fw-semibold mt-3">Crea tu tarjeta</h2>
        <p class="opacity-75 mb-4">Ingresa tus datos para generar tu tarjeta digital.</p>
      </div>

      <form id="create-form">
        
        <label class="fw-semibold">Nombre</label>
        <input id="name" class="form-control mb-3" placeholder="Tu nombre" required />

        <label class="fw-semibold">TelÃ©fono</label>
        <input id="phone" class="form-control mb-3" placeholder="10 dÃ­gitos" pattern="[0-9]{10}" required />

        <label class="fw-semibold">Fecha de nacimiento</label>
        <input id="birthdate" type="date" class="form-control mb-3" required />

        <input type="hidden" id="max" value="8" />

        <div id="error-message" class="alert alert-danger py-2 px-3 d-none"></div>

        <button id="submit-btn" class="btn btn-light w-100 fw-semibold shadow-sm">
          Crear tarjeta
        </button>
      </form>
    </section>

    <!-- =================== VISTA TARJETA =================== -->
    <section id="view-card" class="venus-card w-100 hidden mt-4" style="max-width:480px;">
      
      <h2 id="c_name" class="text-center fw-semibold">Cliente</h2>
      <p id="c_info" class="text-center">Progreso: 0/8</p>

      <div id="grid" class="grid container text-center mt-3"
           style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;"></div>

      <button id="gwallet" class="btn btn-light w-100 mt-4 fw-semibold">
        Guardar en Google Wallet
      </button>

      <button id="applewallet" class="btn btn-dark w-100 mt-2 fw-semibold d-flex justify-content-center gap-2">
        <span class="fs-4">ï£¿</span>
        Agregar a Apple Wallet
      </button>

      <button id="share" class="btn btn-light w-100 mt-2 fw-semibold">
        Compartir
      </button>

      <details class="mt-4 bg-dark bg-opacity-25 p-3 rounded">
        <summary class="fw-semibold">Mostrar QR</summary>

        <div class="text-center mt-3">
          <img id="qr" class="bg-white p-1 rounded" width="150" />
          <p class="small opacity-75 mt-2">Este QR contiene tu cardId.</p>

          <div class="d-flex justify-content-center align-items-center gap-2">
            <code id="cid" class="px-2 py-1 bg-dark bg-opacity-50 rounded text-white small"></code>

            <button id="copy" class="btn btn-light btn-sm fw-semibold">
              Copiar
            </button>
          </div>
        </div>
      </details>

    </section>

    <footer class="text-white opacity-75 text-center mt-3 small">
      Â© Venus CosmetologÃ­a â€” Programa de Lealtad
    </footer>
  </main>

  
  <!-- =================== JAVASCRIPT ORIGINAL =================== -->
  <script>
    const createView = document.getElementById("view-create");
    const cardView = document.getElementById("view-card");
    const grid = document.getElementById("grid");
    const errorMessage = document.getElementById("error-message");
    const submitBtn = document.getElementById("submit-btn");
    const params = new URLSearchParams(window.location.search);
    const urlCardId = params.get("cardId");

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.remove("d-none");
    }

    function hideError() {
      errorMessage.classList.add("d-none");
    }

    function setLoading(loading) {
      if (loading) {
        submitBtn.textContent = "Creando...";
        submitBtn.disabled = true;
      } else {
        submitBtn.textContent = "Crear tarjeta";
        submitBtn.disabled = false;
      }
    }

    function showCardView(data) {
      createView.classList.add("hidden");
      cardView.classList.remove("hidden");

      const cardId = data.cardId || data.id;
      const max = data.max || 8;
      const stamps = data.stamps || 0;

      document.getElementById("c_name").textContent = data.name;
      document.getElementById("c_info").textContent = `Progreso: ${stamps}/${max}`;
      
      grid.innerHTML = "";
      for (let i = 1; i <= max; i++) {
        const div = document.createElement("div");
        div.textContent = i;
        div.classList.add("shadow-sm");

        div.style.background = i <= stamps ? "white" : "rgba(255,255,255,0.3)";
        div.style.color = i <= stamps ? "#333" : "white";

        grid.appendChild(div);
      }

      document.getElementById("qr").src =
        "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=" +
        encodeURIComponent(cardId);

      document.getElementById("cid").textContent = cardId;

      document.getElementById("gwallet").onclick = async () => {
        let saveUrl = data.gwallet;

        if (!saveUrl) {
          const resp = await fetch(`/api/save-card?cardId=${cardId}&name=${data.name}&stamps=${stamps}&max=${max}`);
          const j = await resp.json();
          saveUrl = j.saveUrl || j.addToGoogleUrl;
        }
        window.location.href = saveUrl;
      };

      document.getElementById("applewallet").onclick = () => {
        const passUrl = data.applewallet || `/api/apple/pass?cardId=${cardId}`;
        const a = document.createElement("a");
        a.href = passUrl;
        a.download = `venus-${cardId}.pkpass`;
        a.click();
      };

      document.getElementById("share").onclick = () => {
        const url = `${location.origin}?cardId=${cardId}`;
        navigator.clipboard.writeText(url);
        alert("Enlace copiado.");
      };

      document.getElementById("copy").onclick = () => {
        navigator.clipboard.writeText(cardId);
        alert("ID copiado.");
      };
    }

    if (urlCardId) {
      fetch(`/api/card/${urlCardId}`)
        .then(r => r.json())
        .then(showCardView)
        .catch(() => showError("No se pudo cargar la tarjeta."));
    }

    document.getElementById("create-form").addEventListener("submit", async e => {
      e.preventDefault();
      hideError();
      setLoading(true);

      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const birthdate = document.getElementById("birthdate").value;

      try {
        const res = await fetch(`/api/create-card?name=${encodeURIComponent(name)}&phone=${phone}&birthdate=${birthdate}&max=8`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        data.url ? (location.href = data.url) : showCardView(data);

      } catch (err) {
        showError(err.message);
      } finally {
        setLoading(false);
      }
    });
  </script>

</body>
</html>