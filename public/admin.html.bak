<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Admin ‚Äî Venus Lealtad</title>
  <link rel="icon" href="/assets/logo.png">
  <style>
    /* [TODOS LOS ESTILOS EXISTENTES SE MANTIENEN IGUAL] */
    body.checking-auth {
      opacity: 0;
      pointer-events: none;
    }

    body.auth-verified {
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    :root {
      --venus: #8c9668;
      --venus-soft: #dfe6c1;
      --bg: #3f4037;
      --ink: #f9fafb;
      --muted: #e5e7eb;
      --line: rgba(255, 255, 255, 0.25);
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .wrap {
      max-width: 1100px;
      margin: 16px auto;
      padding: 0 12px 32px;
      width: 100%;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand img {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, .1);
    }

    h1 {
      font-size: 22px;
      margin: 0;
      color: var(--ink);
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .1);
      padding: 7px 13px;
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
      color: var(--ink);
      white-space: nowrap;
      backdrop-filter: blur(3px);
      transition: all 0.2s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--venus-green) 0%, #9aa066 100%);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(140, 150, 104, 0.3);
      transition: all 0.2s ease;
    }

    .btn.primary:hover {
      background: linear-gradient(135deg, #9aa066 0%, var(--venus-green) 100%);
      box-shadow: 0 6px 16px rgba(140, 150, 104, 0.4);
      transform: translateY(-1px);
    }

    .btn.ghost {
      background: transparent;
      border-color: var(--line);
    }

    .btn.small {
      padding: 5px 10px;
      font-size: 12px;
    }

    .nav {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 8px 0 14px;
    }

    .nav a {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid transparent;
      text-decoration: none;
      font-size: 13px;
      color: var(--muted);
      background: transparent;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .nav a.is-active {
      background: rgba(255, 255, 255, .15);
      border-color: var(--venus);
      color: var(--venus-soft);
      box-shadow: 0 4px 14px rgba(0, 0, 0, .1);
    }

    .card {
      background: rgba(255, 255, 255, .08);
      border-radius: var(--radius);
      border: 1px solid var(--line);
      padding: 16px 16px 14px;
      box-shadow: 0 10px 28px rgba(0, 0, 0, .2);
      margin-bottom: 14px;
      backdrop-filter: blur(3px);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.05), transparent 60%),
        radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.03), transparent 60%);
      opacity: .9;
      pointer-events: none;
    }

    .card>* {
      position: relative;
      z-index: 1;
    }

    .card h2 {
      margin: 0 0 6px;
      font-size: 18px;
      color: var(--ink);
    }

    .card h3 {
      margin: 0 0 6px;
      font-size: 15px;
      color: var(--ink);
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select.filter-select {
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      border: 1px solid var(--line);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      outline: none;
      cursor: pointer;
    }

    .grid-3-kpi {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    @media (max-width:700px) {
      .grid-3-kpi {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width:480px) {
      .grid-3-kpi {
        grid-template-columns: 1fr;
      }
    }

    .kpi {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, .1);
      border: 1px solid rgba(255, 255, 255, .15);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      backdrop-filter: blur(3px);
    }

    .kpi span.value {
      font-size: 20px;
      font-weight: 600;
      color: var(--ink);
    }

    .kpi span {
      color: var(--muted);
    }

    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    label {
      display: block;
      margin: 8px 0 4px;
      font-size: 13px;
      font-weight: 500;
      color: var(--ink);
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .1);
      font-size: 13px;
      color: var(--ink);
      backdrop-filter: blur(3px);
    }

    input::placeholder {
      color: var(--muted);
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    .hidden {
      display: none !important;
    }

    .table-wrap {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 13px;
    }

    thead {
      background: rgba(255, 255, 255, .1);
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, .1);
      text-align: left;
      white-space: nowrap;
      color: var(--ink);
    }

    tr:last-child td {
      border-bottom: none;
    }

    code {
      font-size: 12px;
      background: rgba(255, 255, 255, .15);
      padding: 2px 4px;
      border-radius: 4px;
      color: var(--ink);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      background: #bbf7d0;
      color: #166534;
      font-size: 11px;
    }

    /* Estilos adaptados de index.html para la Gift Card */
    .gift-card-visual {
      background-color: #8c9668;
      /* Tu color original */
      border-radius: 20px;
      color: #fff;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      width: 100%;
      max-width: 320px;
      /* Tama√±o proporcional para compartir */
      position: relative;
      overflow: hidden;
      text-align: center;
      margin: 0 auto;
      /* Centrado */
      font-family: 'Poppins', sans-serif;
    }

    .gift-card-visual::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.05), transparent 70%),
        radial-gradient(circle at 80% 60%, rgba(255, 255, 255, 0.04), transparent 60%);
      opacity: 0.7;
      z-index: 0;
    }

    .gift-card-content {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .gift-brand-logo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #fff;
      margin-bottom: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      object-fit: contain;
      padding: 2px;
    }

    .gift-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 5px 0;
    }

    .gift-service {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 10px 0 5px;
      color: #dfe6c1;
      /* Venus soft color */
    }

    .gift-meta {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 15px;
    }

    .gift-qr-container {
      background: #fff;
      padding: 10px;
      border-radius: 12px;
      margin-top: 10px;
      display: inline-block;
    }


    .gift-qr {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      background: #fff;
      padding: 8px;
      margin-bottom: 8px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0, 0, 0, .18);
      font-size: 11px;
      margin-top: 6px;
    }

    .gift-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .footer {
      margin-top: auto;
      text-align: center;
      padding: 8px 0 14px;
      font-size: 12px;
      color: var(--muted);
    }

    .success-message {
      background: rgba(187, 247, 208, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 10px;
      font-size: 13px;
      color: #bbf7d0;
    }

    dialog {
      border-radius: 16px;
      border: 1px solid var(--line);
      background: #111827;
      color: var(--ink);
      padding: 16px 18px 14px;
      max-width: 420px;
      width: 90%;
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, .6);
    }

    /* ===== OFF-CANVAS MENU (Module Selection) ===== */
    .offcanvas {
      position: fixed;
      top: 0;
      right: -400px;
      width: 380px;
      height: 100vh;
      background: linear-gradient(135deg, rgba(27, 28, 26, 0.98), rgba(140, 150, 104, 0.1));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-left: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      overflow-y: auto;
      padding: 24px;
    }

    .offcanvas.open {
      right: 0;
    }

    .offcanvas-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .offcanvas-backdrop.show {
      opacity: 1;
      visibility: visible;
    }

    .offcanvas-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .offcanvas-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--venus-soft);
    }

    .module-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      transition: all 0.2s ease;
    }

    .module-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .module-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .module-icon {
      font-size: 20px;
    }

    .module-label {
      font-size: 14px;
      font-weight: 500;
      color: #f3f3f3;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.2);
      transition: .3s;
      border-radius: 34px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked+.toggle-slider {
      background-color: var(--venus-green);
      box-shadow: 0 0 8px rgba(140, 150, 104, 0.5);
    }

    .toggle-switch input:checked+.toggle-slider:before {
      transform: translateX(22px);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-card {
      background: linear-gradient(135deg, rgba(27, 28, 26, 0.95), rgba(140, 150, 104, 0.15));
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, .15);
      padding: 24px;
      max-width: 480px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, .4),
        0 0 0 1px rgba(255, 255, 255, .05) inset;
      color: #f9fafb;
      animation: modalSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--venus-soft);
    }

    .modal-body p {
      margin: 12px 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-body strong {
      font-weight: 600;
      min-width: 80px;
      color: var(--venus-soft);
    }

    .modal-footer {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* Mejorar botones del modal */
    .modal-footer .btn.small {
      border-radius: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .modal-footer .btn.small:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .modal-footer .btn.primary {
      background: linear-gradient(135deg, var(--venus-green), #a0b070);
      border: none;
    }

    .modal-footer .btn.success {
      box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
    }

    .modal-footer .btn.success:hover {
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
      background: #22c55e;
    }

    .modal-footer .btn.ghost {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-footer .btn.ghost:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .qr-box {
      margin-top: 10px;
      display: flex;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 10px;
    }

    .qr-box canvas {
      background: #fff;
      border-radius: 8px;
      padding: 8px;
      max-width: 100%;
      height: auto;
    }

    /* Estilos para debugging */
    .debug-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--line);
    }

    .debug-output {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 10px;
    }

    /* Estilos para el formulario de notificaci√≥n individual */
    .notify-form-container {
      margin-top: 15px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(140, 150, 104, 0.08) 0%, rgba(140, 150, 104, 0.03) 100%);
      border: 1px solid rgba(140, 150, 104, 0.2);
      border-radius: 16px;
      animation: slideDown 0.3s ease-out;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Spinner animation for loading states */
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .notify-form-header {
      font-size: 15px;
      font-weight: 600;
      color: var(--venus-soft);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(140, 150, 104, 0.15);
    }

    .input-group {
      position: relative;
      margin-bottom: 12px;
    }

    .input-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      pointer-events: none;
      color: var(--venus-soft);
      opacity: 0.7;
    }

    .input-group textarea+.input-icon {
      top: 14px;
      transform: none;
    }

    .notify-input {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(140, 150, 104, 0.2);
      border-radius: 12px;
      padding: 12px 14px 12px 42px;
      color: #fff;
      font-size: 14px;
      transition: all 0.2s;
    }

    .notify-input:focus {
      border-color: var(--venus-soft);
      outline: none;
      background: rgba(0, 0, 0, 0.4);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.15);
    }

    .notify-textarea {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(140, 150, 104, 0.2);
      border-radius: 12px;
      padding: 12px 14px 12px 42px;
      color: #fff;
      font-size: 14px;
      min-height: 90px;
      resize: vertical;
      font-family: inherit;
      transition: all 0.2s;
    }

    .notify-textarea:focus {
      border-color: var(--venus-soft);
      outline: none;
      background: rgba(0, 0, 0, 0.4);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.15);
    }

    .notify-btn-group {}

    .automation-textarea:focus {
      outline: none;
      border-color: var(--venus-green);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.1);
    }

    .stat-money {
      font-variant-numeric: tabular-nums;
    }

    /* Payment functionality styles */
    .payment-indicator {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .payment-efectivo {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .payment-tarjeta {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .payment-transferencia {
      background: rgba(168, 85, 247, 0.2);
      color: #a855f7;
    }

    .payment-no_pagado {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .form-input.readonly {
      background: rgba(0, 0, 0, 0.2);
      cursor: not-allowed;
      opacity: 0.7;
    }

    .automation-history {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .automation-log-item {
      padding: 8px;
      margin-bottom: 6px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.5;
    }

    .modal-textarea:focus {
      outline: none;
      border-color: var(--venus-green);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.1);
    }

    /* ===== HISTORIAL DE CITAS SELECCIONABLE ===== */
    .client-history-panel {
      margin-top: 12px;
      background: rgba(140, 150, 104, 0.08);
      border: 1px solid rgba(140, 150, 104, 0.25);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .client-history-panel.hidden {
      display: none;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      cursor: pointer;
      transition: background 0.2s;
      user-select: none;
    }

    .history-header:hover {
      background: rgba(140, 150, 104, 0.12);
    }

    .history-toggle-icon {
      transition: transform 0.3s ease;
      font-size: 12px;
      color: var(--venus-soft);
    }

    .history-header.expanded .history-toggle-icon {
      transform: rotate(180deg);
    }

    .history-count {
      font-size: 12px;
      color: var(--venus-soft);
      font-weight: 600;
    }

    .history-hint {
      font-size: 11px;
      color: var(--muted);
      font-style: italic;
    }

    .history-content {
      border-top: 1px solid rgba(140, 150, 104, 0.15);
      max-height: 180px;
      overflow-y: auto;
    }

    .history-list {
      padding: 8px;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .history-item:last-child {
      margin-bottom: 0;
    }

    .history-item:hover {
      background: rgba(140, 150, 104, 0.2);
      border-color: var(--venus-soft);
    }

    .history-item:active {
      transform: scale(0.98);
    }

    .history-item-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .history-item-date {
      font-size: 11px;
      color: var(--muted);
    }

    .history-item-service {
      font-size: 13px;
      color: #fff;
      font-weight: 500;
    }

    .history-item-select {
      font-size: 11px;
      color: var(--venus-soft);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .history-item:hover .history-item-select {
      opacity: 1;
    }

    .history-empty {
      text-align: center;
      padding: 16px;
      color: var(--muted);
      font-size: 13px;
    }

    .history-item.selected {
      background: rgba(140, 150, 104, 0.3);
      border-color: var(--venus-soft);
    }

    .history-item.selected .history-item-select {
      opacity: 1;
      color: #22c55e;
    }

    /* ===== TABS SERVICIOS/PRODUCTOS ===== */
    .tabs-header {
      display: flex;
      border-bottom: 1px solid var(--line);
      background: rgba(0,0,0,0.2);
      border-radius: 12px 12px 0 0;
      overflow: hidden;
    }

    .tab-btn {
      flex: 1;
      padding: 14px 20px;
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
    }

    .tab-btn:hover {
      color: var(--ink);
      background: rgba(255,255,255,0.05);
    }

    .tab-btn.active {
      color: var(--venus-soft);
      background: rgba(140, 150, 104, 0.1);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--venus);
      border-radius: 3px 3px 0 0;
    }

    .tab-count {
      background: rgba(255,255,255,0.1);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }

    .tab-btn.active .tab-count {
      background: var(--venus);
      color: white;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* Productos */
    .product-cell {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .product-img {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .stock {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
    }

    .stock-ok {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .stock-low {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
    }

    .stock-out {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .stats-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-item {
      background: rgba(0,0,0,0.2);
      padding: 12px 20px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-item .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--venus-soft);
    }

    .stat-item .stat-label {
      font-size: 11px;
      color: var(--muted);
    }

    .filter-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      padding: 6px 14px;
      border-radius: 20px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chip:hover {
      background: rgba(255,255,255,0.1);
      color: var(--ink);
    }

    .chip.active {
      background: var(--venus);
      border-color: var(--venus);
      color: white;
    }

    .item-category {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    /* ===== FONT AWESOME ICONS ===== */
    .btn i {
      margin-right: 6px;
    }

    .btn.icon-only i {
      margin: 0;
    }

    h2 i, h3 i, h4 i {
      margin-right: 8px;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>

<body class="checking-auth">

  <main class="wrap">
    <header class="topbar">
      <div class="brand">
        <img src="/assets/logo.png" alt="Venus">
        <div>
          <h1>Admin ‚Äî Venus Lealtad</h1>
          <div class="muted" id="me-line">Sesi√≥n iniciada</div>
        </div>
      </div>
      <div class="actions">
        <a class="btn" href="/" target="_blank" rel="noopener">P√°gina clientes</a>
        <button id="logout" class="btn">Cerrar sesi√≥n</button>
      </div>
    </header>

    <nav class="nav">
      <a href="#overview" data-tab="overview" class="is-active"><i class="fas fa-th-large"></i> Resumen</a>
      <a href="#cards" data-tab="cards"><i class="fas fa-credit-card"></i> Tarjetas</a>
      <a href="#events" data-tab="events"><i class="fas fa-gift"></i> Gift Cards</a>
      <a href="#notifications" data-tab="notifications"><i class="fas fa-bell"></i> Notificaciones</a>
      <a href="#appointments" data-tab="appointments"><i class="fas fa-calendar"></i> Citas</a>
      <a href="#services" data-tab="services"><i class="fas fa-sparkles"></i> Servicios</a>
      <a href="#settings" data-tab="settings"><i class="fas fa-cog"></i> Configuraci√≥n</a>
    </nav>

    <!-- TAB: Overview - MODIFICADO CON FILTROS Y REPORTES -->
    <section id="tab-overview" class="card">
      <div class="section-header">
        <h2>Resumen</h2>
        <div class="header-actions">
          <button id="btn-personalize-dashboard" class="btn small ghost">
            ‚öôÔ∏è Personalizar
          </button>
          <div class="select-wrapper">
            <select id="stats-filter" class="filter-select">
              <option value="day">Hoy</option>
              <option value="week" selected>Esta semana</option>
              <option value="month">Este mes</option>
            </select>
          </div>
          <button id="btn-download-report" class="btn small primary">
            ‚¨á Reporte
          </button>
        </div>
      </div>

      <!-- KPIs principales (fila 1) -->
      <div class="grid-3-kpi" data-module-section="kpis">
        <div class="kpi">
          <span>Tarjetas totales</span>
          <span class="value" id="kpi-total">‚Äî</span>
        </div>
        <div class="kpi">
          <span>Tarjetas completas</span>
          <span class="value" id="kpi-full">‚Äî</span>
        </div>
        <div class="kpi">
          <span id="stamps-period-label">Sellos hoy</span>
          <span class="value" id="kpi-stamps">‚Äî</span>
        </div>
      </div>

      <!-- KPIs adicionales (fila 2) -->
      <div class="grid-3-kpi" style="margin-top:14px;" data-module-section="kpis">
        <div class="kpi">
          <span id="redeems-period-label">Canjes hoy</span>
          <span class="value" id="kpi-redeems">‚Äî</span>
        </div>
        <div class="kpi">
          <span>Promedio sellos</span>
          <span class="value" id="kpi-avg">‚Äî</span>
        </div>
        <div class="kpi">
          <span>Tasa completitud</span>
          <span class="value" id="kpi-rate">‚Äî</span>
        </div>
      </div>

      <!-- CUMPLEA√ëOS DEL MES (Overview) -->
      <div id="overview-birthday-section" class="hidden" data-module-section="birthdays"
        style="margin-top: 20px; padding: 15px; background: rgba(255, 209, 102, 0.1); border: 1px solid rgba(255, 209, 102, 0.3); border-radius: 12px;">
        <div class="row" style="justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;"><i class="fas fa-birthday-cake"></i></span>
            <div>
              <h3 style="margin: 0; color: #ffd166;" id="overview-birthday-title">Cumplea√±os (√∫ltimos 30 d√≠as)</h3>
              <p class="muted" style="margin: 2px 0 0; font-size: 13px;">Pasados y pr√≥ximos cumplea√±os.</p>
            </div>
          </div>
        </div>

        <!-- Cumplea√±os pr√≥ximos -->
        <div id="upcoming-birthdays-container" class="hidden" style="margin-top: 15px;">
          <h4 style="margin: 0 0 8px; font-size: 13px; color: #a7f3d0; font-weight: 600;"><i class="fas fa-party-horn"></i> Pr√≥ximos Cumplea√±os</h4>
          <div id="upcoming-birthday-list" style="display: flex; gap: 8px; flex-wrap: wrap;">
            <!-- Lista de cumplea√±os pr√≥ximos -->
          </div>
        </div>

        <!-- Cumplea√±os pasados -->
        <div id="past-birthdays-container" class="hidden" style="margin-top: 15px;">
          <h4 style="margin: 0 0 8px; font-size: 13px; color: #cbd5e1; font-weight: 600;"><i class="fas fa-calendar"></i> Cumplea√±os Pasados</h4>
          <div id="past-birthday-list" style="display: flex; gap: 8px; flex-wrap: wrap;">
            <!-- Lista de cumplea√±os pasados -->
          </div>
        </div>
      </div>

      <!-- Gr√°fica Actividad reciente -->
      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--line);" data-module-section="activity">
        <h3 style="margin:0 0 12px;font-size:15px;color:var(--ink);" id="activity-title"><i class="fas fa-chart-line"></i> Actividad reciente (7 d√≠as)
        </h3>
        <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:12px;">
          <canvas id="activity-chart" style="max-height:200px;"></canvas>
        </div>
      </div>

      <!-- Top clientes -->
      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--line);" data-module-section="topClients">
        <h3 style="margin:0 0 12px;font-size:15px;color:var(--ink);"><i class="fas fa-star"></i> Top Clientes</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Sellos</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody id="top-clients">
              <tr>
                <td colspan="3" style="text-align:center;padding:12px;" class="muted">Cargando...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Estado de Wallets - MEJORADO CON ESTAD√çSTICAS REALES -->
      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--line);" data-module-section="walletStats">
        <h3 style="margin:0 0 12px;font-size:15px;color:var(--ink);"><i class="fas fa-mobile-alt"></i> Estado de Wallets</h3>
        <div class="grid-3-kpi">
          <div class="kpi">
            <span>üü¢ Google Wallet</span>
            <span class="value" id="kpi-google">‚Äî</span>
          </div>
          <div class="kpi">
            <span><i class="fab fa-apple"></i> Apple Wallet</span>
            <span class="value" id="kpi-apple">‚Äî</span>
          </div>
          <div class="kpi">
            <span><i class="fas fa-mobile-alt"></i> Dispositivos totales</span>
            <span class="value" id="kpi-devices">‚Äî</span>
          </div>
        </div>
        <div style="margin-top:10px; text-align:center;">
          <button id="btn-refresh-wallet-stats" class="btn small ghost"><i class="fas fa-sync-alt"></i> Actualizar estad√≠sticas</button>
        </div>
      </div>

      <!-- KPIs AVANZADOS (NUEVOS) -->
      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--line);" data-module-section="newKPIs">
        <h3 style="margin:0 0 12px;font-size:15px;color:var(--ink);"><i class="fas fa-chart-bar"></i> KPIs Avanzados</h3>

        <!-- Primera fila: Clientes -->
        <div class="grid-3-kpi">
          <div class="kpi">
            <span>Clientes nuevos</span>
            <span class="value" id="kpi-new-clients">‚Äî</span>
          </div>
          <div class="kpi">
            <span>üü¢ Activos (30d)</span>
            <span class="value" id="kpi-active-clients">‚Äî</span>
          </div>
          <div class="kpi">
            <span><i class="fas fa-circle"></i> Inactivos (30d)</span>
            <span class="value" id="kpi-inactive-clients">‚Äî</span>
          </div>
        </div>

        <!-- Segunda fila: An√°lisis -->
        <div class="grid-3-kpi" style="margin-top:14px;">
          <div class="kpi">
            <span>Promedio d√≠as inactivo</span>
            <span class="value" id="kpi-avg-last-visit">‚Äî</span>
          </div>
          <div class="kpi">
            <span>Ciclos completados</span>
            <span class="value" id="kpi-cycles-completed">‚Äî</span>
          </div>
          <div class="kpi">
            <span>Tasa de retorno</span>
            <span class="value" id="kpi-return-rate">‚Äî</span>
          </div>
        </div>

        <!-- Gr√°ficas de distribuci√≥n -->
        <div style="margin-top:16px;background:rgba(255,255,255,0.05);border-radius:12px;padding:12px;">
          <h4 style="margin:0 0 10px;font-size:13px;color:var(--venus-soft);">Distribuci√≥n por d√≠a de la semana</h4>
          <canvas id="day-distribution-chart"></canvas>
        </div>

        <div style="margin-top:16px;background:rgba(255,255,255,0.05);border-radius:12px;padding:12px;">
          <h4 style="margin:0 0 10px;font-size:13px;color:var(--venus-soft);">Distribuci√≥n por hora del d√≠a</h4>
          <canvas id="hour-distribution-chart"></canvas>
        </div>
      </div>
    </section>

    <!-- TAB: Cards -->
    <section id="tab-cards" class="card hidden">
      <h2>Tarjetas de lealtad</h2>
      <p class="muted">Gestiona todas las tarjetas de tus clientes.</p>

      <!-- KPI CUMPLEA√ëOS -->
      <div id="birthday-section" class="hidden"
        style="margin: 15px 0; padding: 15px; background: rgba(255, 209, 102, 0.1); border: 1px solid rgba(255, 209, 102, 0.3); border-radius: 12px;">
        <div class="row" style="justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;"><i class="fas fa-birthday-cake"></i></span>
            <div>
              <h3 style="margin: 0; color: #ffd166;">Cumplea√±os Cercanos</h3>
              <p class="muted" style="margin: 2px 0 0; font-size: 13px;">Clientes que cumplen a√±os en los pr√≥ximos 7
                d√≠as.</p>
            </div>
          </div>
          <div id="birthday-actions">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>
        <div id="birthday-list" style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
          <!-- Lista de cumplea√±eros -->
        </div>
      </div>

      <div class="row" style="margin-top:12px; align-items: center;">
        <input id="search-cards" placeholder="Buscar por nombre o tel√©fono..." style="flex:1;min-width:200px;">

        <!-- SORTING CONTROLS -->
        <select id="sort-cards" class="filter-select">
          <option value="created_at:desc">Recientes</option>
          <option value="created_at:asc">Antiguos</option>
          <option value="name:asc">Nombre (A-Z)</option>
          <option value="name:desc">Nombre (Z-A)</option>
          <option value="stamps:desc">M√°s sellos</option>
          <option value="stamps:asc">Menos sellos</option>
          <option value="last_visit:desc">√öltima visita</option>
        </select>

        <button id="btn-search-cards" class="btn primary"><i class="fas fa-search"></i> Buscar</button>
        <button id="btn-reload-cards" class="btn"><i class="fas fa-sync-alt"></i> Recargar</button>
        <button id="btn-scan-card" class="btn ghost"><i class="fas fa-qrcode"></i> Escanear QR</button>
      </div>

      <div class="table-wrap" style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Tel√©fono</th>
              <th>√öltima Visita</th>
              <th>Sellos</th>
              <th style="width:120px;">Acciones</th>
            </tr>
          </thead>
          <tbody id="cards-tbody">
            <tr>
              <td colspan="5" style="text-align:center;padding:12px;" class="muted">Cargando tarjetas...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:12px;">
        <button id="btn-prev-page" class="btn small ghost">‚Üê Anterior</button>
        <span id="page-info" class="muted">P√°gina 1</span>
        <button id="btn-next-page" class="btn small ghost">Siguiente ‚Üí</button>
      </div>
    </section>

    <!-- TAB: Gift Cards -->
    <section id="tab-events" class="card hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2 style="margin:0;">Gift Cards</h2>
        <button id="btn-scan-gift-card" class="btn primary">
          <i class="fas fa-qrcode"></i> Escanear QR
        </button>
      </div>

      <!-- Formulario Crear Gift Card -->
      <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:16px;margin-bottom:20px;">
        <h3 style="margin:0 0 8px;font-size:16px;">Crear Gift Card</h3>
        <p class="muted" style="margin:0 0 16px;font-size:13px;">Genera una tarjeta de regalo digital con vigencia de 30
          d√≠as.</p>

        <form id="gift-form" style="max-width:500px;">
          <label>Nombre del cliente (opcional)</label>
          <input id="gift-name" placeholder="Ej. Ana L√≥pez">

          <label>Servicio a regalar</label>
          <input id="gift-service" required placeholder="Ej. Facial hidratante, Masaje relajante‚Ä¶">

          <button type="submit" class="btn primary" style="margin-top:10px;">Generar Gift Card</button>
        </form>

        <div id="gift-preview-container" class="hidden" style="margin-top: 20px;">
          <div id="gift-card-visual" class="gift-card-visual">
            <div class="gift-card-content">
              <img src="/assets/logo.png" alt="Venus" class="gift-brand-logo">

              <div class="gift-title">Venus Lealtad</div>
              <div style="font-size: 0.9rem; opacity: 0.9;">¬°Tienes un regalo! üéÅ</div>

              <hr style="width: 50%; border: 0; border-top: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">

              <div id="gift-visual-service" class="gift-service">Servicio</div>
              <div id="gift-visual-client" class="gift-meta">Para: Cliente</div>
              <div id="gift-visual-date" class="gift-meta" style="font-size: 0.8rem; margin-top:0;">Vence: --/--/--
              </div>

              <div class="gift-qr-container">
                <canvas id="gift-qr"></canvas>
              </div>
              <div style="font-size: 10px; color: #333; margin-top: 4px; color: #fff; opacity: 0.8;">Muestra este c√≥digo
              </div>
            </div>
          </div>
        </div>

        <div id="gift-actions" class="gift-actions hidden">
          <button type="button" id="gift-copy" class="btn small">Copiar texto</button>
          <button type="button" id="gift-whatsapp" class="btn small primary">Enviar por WhatsApp</button>
          <button type="button" id="gift-whatsapp-image" class="btn small primary"><i class="fas fa-camera"></i> WhatsApp con imagen</button>
        </div>

        <div id="gift-success" class="success-message hidden">
          ‚úÖ Gift Card generada exitosamente. Puedes enviarla por WhatsApp o compartir el texto.
        </div>
    </section>

    <!-- TAB: Settings - MEJORADO CON DEBUGGING -->
    <section id="tab-settings" class="card hidden">
      <h2>Configuraci√≥n</h2>
      <p class="muted">Env√≠a notificaciones push a todos los pases en Google Wallet.</p>

      <div
        style="background:rgba(140,150,104,0.1);border:1px solid rgba(140,150,104,0.3);border-radius:12px;padding:14px;margin:12px 0;">
        <h3 style="margin:0 0 8px;"><i class="fas fa-mobile-alt"></i> Notificaciones Push</h3>

        <form id="push-notification-form">
          <label>T√≠tulo de la notificaci√≥n</label>
          <input id="push-title" placeholder="Ej. ¬°Nueva promoci√≥n!" required maxlength="50">
          <small class="muted">M√°ximo 50 caracteres</small>

          <label style="margin-top:10px;">Mensaje</label>
          <textarea id="push-message" placeholder="Ej. Hoy tenemos 20% de descuento..." required maxlength="200"
            rows="3"></textarea>
          <small class="muted">M√°ximo 200 caracteres</small>

          <label style="margin-top:10px;">Tipo</label>
          <select id="push-type">
            <option value="promo">Promoci√≥n</option>
            <option value="reminder">Recordatorio</option>
            <option value="update">Actualizaci√≥n</option>
            <option value="alert">‚ö†Ô∏è Alerta</option>
          </select>

          <div style="margin-top:12px;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;">
            <div class="row" style="justify-content:space-between;margin-bottom:8px;">
              <span class="muted" style="font-size:12px;">Vista previa:</span>
              <span id="preview-type" style="font-size:12px;">üéÅ Promoci√≥n</span>
            </div>
            <div style="background:rgba(255,255,255,0.1);border-radius:8px;padding:10px;">
              <div id="preview-title" style="font-weight:600;margin-bottom:4px;">¬°Nueva promoci√≥n!</div>
              <div id="preview-message" class="muted" style="font-size:12px;">Tu mensaje aparecer√° aqu√≠...</div>
            </div>
          </div>

          <div class="row" style="margin-top:14px;gap:10px;">
            <button type="button" id="btn-mass-push" class="btn primary">Enviar a todos</button>
            <button type="button" id="test-push" class="btn ghost">Enviar prueba</button>
          </div>
        </form>

        <div id="push-success" class="success-message hidden" style="margin-top:12px;">
          ‚úÖ Notificaci√≥n enviada a <span id="push-count">0</span> pases
        </div>

        <div id="push-error" class="hidden"
          style="background:rgba(254,202,202,0.1);border:1px solid rgba(153,27,27,0.3);border-radius:10px;padding:10px 12px;margin-top:12px;font-size:13px;color:#fecaca;">
          ‚ùå Error al enviar notificaci√≥n
        </div>
      </div>

      <div style="margin-top:16px;">
        <div class="row" style="justify-content:space-between;margin-bottom:8px;">
          <h3 style="margin:0;"><i class="fas fa-list"></i> Historial</h3>
          <button id="refresh-history" class="btn small ghost"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>T√≠tulo</th>
                <th>Tipo</th>
                <th>Enviadas</th>
                <th>Errores</th>
              </tr>
            </thead>
            <tbody id="notifications-history">
              <tr>
                <td colspan="5" style="text-align:center;padding:12px;" class="muted">Cargando...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- NUEVA SECCI√ìN: DEBUGGING AVANZADO -->
      <div class="debug-section">
        <h3 style="margin:0 0 12px;font-size:15px;color:var(--ink);"><i class="fas fa-bug"></i> Debugging Avanzado</h3>

        <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:12px;">
          <button id="btn-test-apple-push" class="btn small"><i class="fas fa-flask"></i> Test Apple Push</button>
          <button id="btn-test-google-push" class="btn small"><i class="fas fa-flask"></i> Test Google Push</button>
          <button id="btn-fix-google-wallet" class="btn small"><i class="fas fa-wrench"></i> Reparar Google Wallet</button>
          <button id="btn-check-devices" class="btn small"><i class="fas fa-mobile-alt"></i> Ver Dispositivos</button>
          <button id="btn-check-apns" class="btn small"><i class="fab fa-apple"></i> Ver Config APNs</button>
        </div>
        <div id="debug-output" class="debug-output hidden">
          <!-- Aqu√≠ se mostrar√°n los resultados del debugging -->
        </div>
      </div>
    </section>

    <!-- TAB: Notificaciones -->
    <section id="tab-notifications" class="card hidden">
      <h2><i class="fas fa-bell"></i> Notificaciones</h2>
      <p class="muted" style="margin:0 0 20px;font-size:13px;">
        Configura notificaciones autom√°ticas para diferentes eventos del programa de lealtad.
      </p>

      <!-- Bot√≥n ejecutar todas -->
      <div style="margin-bottom:24px;">
        <button id="btn-run-all-automations" class="btn primary">
          <i class="fas fa-play"></i> Ejecutar Automatizaciones Activas
        </button>
        <span class="muted" style="font-size:12px;margin-left:10px;">Procesa todas las reglas activas ahora</span>
      </div>

      <!-- Regla 1: Cumplea√±os -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon"><i class="fas fa-birthday-cake"></i></span>
            <span class="automation-title">Recordatorio de Cumplea√±os</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-birthday-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <label class="automation-label">D√≠as de anticipaci√≥n:</label>
          <input type="number" id="auto-birthday-days" class="automation-input" value="3" min="0" max="30">

          <label class="automation-label" style="margin-top:10px;">Mensaje:</label>
          <textarea id="auto-birthday-message" class="automation-textarea"
            rows="2">¬°Feliz cumplea√±os! üéâ Te esperamos con un regalo especial en Venus.</textarea>

          <button class="btn small ghost automation-test-btn" data-type="birthday"><i class="fas fa-flask"></i> Probar</button>
        </div>
      </div>

      <!-- Regla 2: Inactividad -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon"><i class="fas fa-moon"></i></span>
            <span class="automation-title">Alerta de Inactividad</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-inactivity-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <label class="automation-label">D√≠as sin visita:</label>
          <input type="number" id="auto-inactivity-days" class="automation-input" value="30" min="7" max="180">

          <label class="automation-label" style="margin-top:10px;">Mensaje:</label>
          <textarea id="auto-inactivity-message" class="automation-textarea"
            rows="2">¬°Te extra√±amos! üòä Hace tiempo que no te vemos. Ven y disfruta nuestros servicios.</textarea>

          <button class="btn small ghost automation-test-btn" data-type="inactivity"><i class="fas fa-flask"></i> Probar</button>
        </div>
      </div>

      <!-- Regla 3: Tarjeta Completada -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon"><i class="fas fa-gift"></i></span>
            <span class="automation-title">Tarjeta Completada</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-completed-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <p class="muted" style="font-size:12px;margin:0 0 10px;">Notificaci√≥n cuando el cliente complete su tarjeta.
          </p>

          <label class="automation-label">Mensaje:</label>
          <textarea id="auto-completed-message" class="automation-textarea"
            rows="2">¬°Felicidades! üéÅ Has completado tu tarjeta. Ven a canjear tu premio.</textarea>

          <button class="btn small ghost automation-test-btn" data-type="completed"><i class="fas fa-flask"></i> Probar</button>
        </div>
      </div>

      <!-- Regla 4: Casi Completa -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon">‚ö°</span>
            <span class="automation-title">Casi Completa (Motivacional)</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-almost-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <label class="automation-label">Faltan X sellos:</label>
          <input type="number" id="auto-almost-stamps" class="automation-input" value="2" min="1" max="5">

          <label class="automation-label" style="margin-top:10px;">Mensaje:</label>
          <textarea id="auto-almost-message" class="automation-textarea"
            rows="2">¬°Ya casi! ‚ö° Solo te faltan [X] sellos para tu premio. ¬°No esperes m√°s!</textarea>

          <button class="btn small ghost automation-test-btn" data-type="almost">üß™ Probar</button>
        </div>
      </div>

      <!-- Historial de automatizaciones -->
      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--line);">
        <h4 style="margin:0 0 10px;font-size:14px;color:var(--venus-soft);"><i class="fas fa-list"></i> Historial Reciente</h4>
        <div id="automation-history" class="automation-history">
          <p class="muted" style="font-size:12px;">No hay env√≠os recientes</p>
        </div>
      </div>
    </section>

    <!-- TAB: Citas -->
    <section id="tab-appointments" class="tab-content hidden">
      <div class="header-actions">
        <h2><i class="fas fa-calendar"></i> Agenda de Citas</h2>
        <button class="btn primary" id="btn-new-appointment">Nueva Cita</button>
      </div>

      <!-- Calendario Semanal -->
      <div class="card" style="margin-bottom:20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3 style="margin:0;">Semana Actual</h3>
          <div style="display:flex;gap:8px;">
            <button class="btn small ghost" id="btn-prev-week">‚Üê Anterior</button>
            <button class="btn small ghost" id="btn-today">Hoy</button>
            <button class="btn small ghost" id="btn-next-week">Siguiente ‚Üí</button>
          </div>
        </div>
        <div id="weekly-calendar" style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;"></div>
      </div>

      <!-- Citas del D√≠a Seleccionado -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3 style="margin:0;">Citas del <span id="selected-date-label">Hoy</span></h3>
          <button class="btn small" id="btn-refresh-appts"><i class="fas fa-sync-alt"></i> Actualizar</button>
        </div>

        <table class="data-table">
          <thead>
            <tr>
              <th>Hora</th>
              <th>Cliente</th>
              <th>Servicio</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="appts-tbody">
            <tr>
              <td colspan="5" style="text-align:center;padding:20px;">Cargando...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Historial del Mes -->
      <div class="card" style="margin-top:20px;">
        <h3 style="margin-top:0;">Historial del Mes</h3>
        <div id="month-stats"
          style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:16px;">
          <div class="stat-card">
            <div class="stat-label">Total Citas</div>
            <div class="stat-value" id="stat-total">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Completadas</div>
            <div class="stat-value" id="stat-completed">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Canceladas</div>
            <div class="stat-value" id="stat-cancelled">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Pendientes</div>
            <div class="stat-value" id="stat-pending">-</div>
          </div>
        </div>
      </div>

      <!-- Resumen de Ventas del Mes -->
      <div class="card" style="margin-top:20px;">
        <h3 style="margin-top:0;"><i class="fas fa-dollar-sign"></i> Ventas del Mes</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;">
          <div class="stat-card">
            <div class="stat-label"><i class="fas fa-money-bill"></i> Efectivo</div>
            <div class="stat-value stat-money" id="revenue-cash">$0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label"><i class="fas fa-credit-card"></i> Tarjeta</div>
            <div class="stat-value stat-money" id="revenue-card">$0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label"><i class="fas fa-building"></i> Transferencia</div>
            <div class="stat-value stat-money" id="revenue-transfer">$0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label"><i class="fas fa-dollar-sign"></i> Total</div>
            <div class="stat-value stat-money" id="revenue-total" style="color:#FFD166;font-weight:700;">$0.00</div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: Servicios -->
    <section id="tab-services" class="tab-content hidden">
      <div class="header-actions">
        <h2><i class="fas fa-sparkles"></i> Gesti√≥n de Servicios</h2>
        <button class="btn primary" id="btn-new-service">Nuevo Servicio</button>
      </div>

      <!-- Barra de b√∫squeda -->
      <div class="card" style="margin-bottom:16px;">
        <input type="text" id="search-services" class="form-input" placeholder="Buscar servicio por nombre..."
          style="width:100%;max-width:400px;">
      </div>

      <div class="card">
        <div class="table-wrap" style="overflow-x:auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Duraci√≥n (min)</th>
                <th>Precio</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="services-tbody">
              <tr>
                <td colspan="4" class="muted" style="text-align:center;padding:20px;">Cargando servicios...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- DIALOG: Nueva Cita -->
    <dialog id="newApptDialog">
      <div class="dialog-content">
        <h3 style="margin-top:0;margin-bottom:20px;"><i class="fas fa-calendar"></i> Agendar Cita</h3>
        <form id="form-new-appt">
          <div style="display:grid;gap:16px;">
            <!-- Cliente con b√∫squeda editable -->
            <div>
              <label class="form-label">Cliente</label>
              <div class="custom-select-wrapper">
                <input type="text" id="new-appt-client-select" class="form-input"
                  placeholder="Buscar o escribir nombre..." autocomplete="off">
                <span class="dropdown-toggle-icon">‚ñº</span>
                <div id="clients-dropdown-list" class="custom-dropdown-list" style="display:none;"></div>
              </div>
              <button type="button" id="btn-toggle-new-client" class="btn small ghost" style="margin-top:8px;">
                + Registrar nuevo cliente
              </button>

              <!-- Panel Historial de Citas - Clic para seleccionar servicio -->
              <div id="client-history-panel" class="client-history-panel hidden">
                <div class="history-header" id="toggle-history">
                  <div style="display:flex;align-items:center;gap:8px;">
                    <span class="history-toggle-icon">‚ñº</span>
                    <span><i class="fas fa-calendar"></i> Citas anteriores</span>
                    <span class="history-count" id="history-count">(0)</span>
                  </div>
                  <span class="history-hint" id="history-hint">Clic para repetir servicio</span>
                </div>
                <div class="history-content" id="history-content" style="display:none;">
                  <div id="history-list" class="history-list">
                  </div>
                </div>
              </div>
            </div>

            <!-- Formulario Nuevo Cliente (oculto por defecto) -->
            <div id="new-client-form"
              style="display:none;background:rgba(140,150,104,0.1);border:1px solid rgba(140,150,104,0.3);border-radius:12px;padding:16px;">
              <h4 style="margin:0 0 12px 0;color:var(--venus-soft);">Nuevo Cliente</h4>
              <div style="display:grid;gap:12px;">
                <div>
                  <label class="form-label">Nombre completo</label>
                  <input type="text" id="new-client-name" class="form-input" placeholder="Ej: Mar√≠a Gonz√°lez">
                </div>
                <div>
                  <label class="form-label">Tel√©fono</label>
                  <input type="tel" id="new-client-phone" class="form-input" placeholder="52...">
                </div>
                <button type="button" id="btn-save-new-client" class="btn small primary">Guardar Cliente</button>
              </div>
            </div>

            <!-- Tel√©fono -->
            <div>
              <label class="form-label">Tel√©fono</label>
              <input type="tel" id="new-appt-phone" class="form-input" placeholder="4421234567" required>
            </div>

            <!-- Servicio y Precio -->
            <div class="grid-service-price">
              <div>
                <label class="form-label">Servicio</label>
                <div class="custom-select-wrapper">
                  <input type="text" id="new-appt-service" class="form-input"
                    placeholder="Buscar o escribir servicio..." autocomplete="off" required>
                  <span class="dropdown-toggle-icon">‚ñº</span>
                  <div id="services-dropdown-list" class="custom-dropdown-list" style="display:none;"></div>
                </div>
              </div>
              <div>
                <label class="form-label">Precio</label>
                <div style="position:relative;">
                  <span
                    style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--venus-soft);font-size:14px;">$</span>
                  <input type="number" id="new-appt-price" class="form-input" placeholder="0" min="0" step="10"
                    style="padding-left:28px;">
                </div>
              </div>
            </div>

            <!-- Fecha y Hora -->
            <div class="grid-date-time">
              <div style="position:relative;">
                <label class="form-label"><i class="fas fa-calendar"></i> Fecha</label>
                <input type="text" id="new-appt-date" class="form-input date-picker-input" readonly required
                  placeholder="Seleccionar fecha" style="cursor:pointer;">
                <div id="new-appt-calendar" class="calendar-dropdown" style="display:none;"></div>
              </div>
              <div>
                <label class="form-label">Hora</label>
                <select id="new-appt-hour" class="form-input" required>
                  <option value="">--</option>
                </select>
              </div>
              <div>
                <label class="form-label">Min</label>
                <select id="new-appt-minute" class="form-input" required>
                  <option value="">--</option>
                </select>
              </div>
              <div>
                <label class="form-label">Hora fin</label>
                <input type="text" id="new-appt-end-time" class="form-input" readonly
                  style="background:rgba(0,0,0,0.15);color:var(--muted);">
              </div>
            </div>

            <!-- Recordatorios -->
            <div class="reminders-section">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                <svg width="18" height="18" fill="none" stroke="var(--venus-soft)" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                  </path>
                </svg>
                <span style="font-size:13px;font-weight:600;color:var(--venus-soft);">Recordatorios por
                  WhatsApp</span>
              </div>
              <div style="display:grid;gap:10px;">
                <label class="reminder-option">
                  <input type="checkbox" id="check-whatsapp-confirm" checked>
                  <span class="reminder-text">
                    <strong>Confirmaci√≥n inmediata</strong>
                    <small>Se env√≠a al crear la cita</small>
                  </span>
                </label>
                <label class="reminder-option">
                  <input type="checkbox" id="check-whatsapp-24h" checked>
                  <span class="reminder-text">
                    <strong>24 horas antes</strong>
                    <small>Recordatorio autom√°tico</small>
                  </span>
                </label>
                <label class="reminder-option">
                  <input type="checkbox" id="check-whatsapp-2h" checked>
                  <span class="reminder-text">
                    <strong>2 horas antes</strong>
                    <small>Recordatorio final</small>
                  </span>
                </label>
              </div>
            </div>

            <!-- Botones -->
            <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
              <button type="button" class="btn ghost" id="btn-cancel-appt">Cancelar</button>
              <button type="submit" class="btn primary">Agendar</button>
            </div>
          </div>
        </form>
      </div>
    </dialog>

    <!-- Modal: Modificar Cita -->
    <dialog id="editApptDialog">
      <div class="dialog-content">
        <h2><i class="fas fa-edit"></i> Modificar Cita</h2>
        <form id="form-edit-appt">
          <input type="hidden" id="edit-appt-id">

          <div class="form-grid">
            <!-- Cliente (congelado) -->
            <div style="grid-column: 1/3;">
              <label class="form-label">Cliente (no editable)</label>
              <input type="text" id="edit-appt-client-name" class="form-input" readonly
                style="background:rgba(255,255,255,0.05);cursor:not-allowed;">
            </div>

            <!-- Servicio -->
            <div style="grid-column: 1/3;">
              <label class="form-label">Servicio</label>
              <div class="custom-select-wrapper">
                <input type="text" id="edit-appt-service" class="form-input" required>
                <span class="dropdown-toggle-icon">‚ñº</span>
                <div id="edit-services-dropdown-list" class="custom-dropdown-list" style="display:none;"></div>
              </div>
            </div>

            <div>
              <label class="form-label">Precio</label>
              <div style="position:relative;">
                <span
                  style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--venus-soft);font-size:14px;">$</span>
                <input type="number" id="edit-appt-price" class="form-input" readonly style="padding-left:28px;">
              </div>
            </div>

            <div>
              <label class="form-label">Duraci√≥n (min)</label>
              <input type="number" id="edit-appt-duration" class="form-input" readonly>
            </div>

            <!-- Fecha y Hora -->
            <div class="grid-date-time full-width">
              <div style="position:relative;">
                <label class="form-label"><i class="fas fa-calendar"></i> Fecha</label>
                <input type="text" id="edit-appt-date" class="form-input date-picker-input" readonly required
                  placeholder="Seleccionar fecha" style="cursor:pointer;">
                <div id="edit-appt-calendar" class="calendar-dropdown" style="display:none;"></div>
              </div>
              <div>
                <label class="form-label">Hora</label>
                <select id="edit-appt-hour" class="form-input" required style="width:100px;">
                  <option value="">--</option>
                </select>
              </div>
              <div>
                <label class="form-label">Min</label>
                <select id="edit-appt-minute" class="form-input" required style="width:90px;">
                  <option value="">--</option>
                </select>
              </div>
              <div>
                <label class="form-label">Termina</label>
                <input type="text" id="edit-appt-end-time" class="form-input" readonly>
              </div>
            </div>

            <!-- Botones -->
            <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;grid-column:1/3;">
              <button type="button" class="btn ghost" id="btn-cancel-edit-appt">Cancelar</button>
              <button type="submit" class="btn primary">Guardar Cambios</button>
            </div>
          </div>
        </form>
      </div>
    </dialog>

    <!-- PAYMENT DIALOG -->
    <dialog id="paymentDialog">
      <div class="dialog-header">
        <h3><i class="fas fa-money-bill"></i> Registrar Pago</h3>
        <button type="button" id="btn-close-payment" class="btn-close"><i class="fas fa-times"></i></button>
      </div>
      <form id="form-payment">
        <div class="form-row">
          <label>Cliente:</label>
          <input id="payment-client-name" readonly class="form-input readonly" style="cursor: not-allowed;">
        </div>
        <div class="form-row">
          <label>Servicio:</label>
          <input id="payment-service-name" readonly class="form-input readonly" style="cursor: not-allowed;">
        </div>
        <div class="form-row">
          <label>M√©todo de Pago <span style="color:#ef4444;">*</span></label>
          <select id="payment-method" class="form-input" required>
            <option value="efectivo">Efectivo</option>
            <option value="tarjeta">Tarjeta</option>
            <option value="transferencia">Transferencia</option>
            <option value="no_pagado">No Pagado</option>
          </select>
        </div>
        <div class="form-row">
          <label>Monto <span style="color:#ef4444;">*</span></label>
          <input id="payment-amount" type="number" step="0.01" min="0" class="form-input" placeholder="0.00" required>
        </div>
        <div class="dialog-footer">
          <button type="submit" class="btn primary"><i class="fas fa-save"></i> Guardar Pago</button>
          <button type="button" id="btn-cancel-payment" class="btn ghost">Cancelar</button>
        </div>
      </form>
    </dialog>

    <style>
      /* Dialog Styles - Backdrop Opaco */
      #newApptDialog::backdrop {
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
      }

      #newApptDialog {
        border: none;
        border-radius: 16px;
        padding: 0;
        max-width: 650px;
        width: 90%;
        background: transparent;
      }

      .dialog-content {
        background: var(--bg-card);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 24px;
        color: #fff;
      }

      /* Form Elements */
      .form-label {
        display: block;
        font-size: 12px;
        margin-bottom: 6px;
        color: var(--venus-soft);
        font-weight: 500;
      }

      .form-input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--line);
        background: rgba(0, 0, 0, 0.3);
        color: #fff;
        font-size: 14px;
        transition: all 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--venus-green);
        background: rgba(0, 0, 0, 0.4);
      }

      .form-input:disabled,
      .form-input:read-only {
        background: rgba(0, 0, 0, 0.15);
        color: var(--muted);
        cursor: not-allowed;
      }

      /* Reminders Section */
      .reminders-section {
        background: rgba(140, 150, 104, 0.1);
        border: 1px solid rgba(140, 150, 104, 0.3);
        border-radius: 12px;
        padding: 16px;
      }

      .reminder-option {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
      }

      .reminder-option:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .reminder-option {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        transition: all 0.2s;
      }

      .reminder-option:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .reminder-option input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        margin-top: 3px;
        width: 20px;
        height: 20px;
        cursor: pointer;
        border: 2px solid var(--venus-soft);
        border-radius: 6px;
        background: rgba(0, 0, 0, 0.3);
        position: relative;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .reminder-option input[type="checkbox"]:hover {
        border-color: var(--venus-green);
        background: rgba(140, 150, 104, 0.1);
      }

      .reminder-option input[type="checkbox"]:checked {
        background: var(--venus-green);
        border-color: var(--venus-green);
      }

      /* Checkmark dibujado con CSS - BLANCO Y GRUESO */
      .reminder-option input[type="checkbox"]:checked::after {
        content: "";
        position: absolute;
        left: 6px;
        top: 2px;
        width: 6px;
        height: 12px;
        border: solid #fff;
        border-width: 0 3px 3px 0;
        transform: rotate(45deg);
        filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.5));
      }

      .reminder-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .reminder-text strong {
        font-size: 14px;
        color: #fff;
        font-weight: 500;
      }

      .reminder-text small {
        font-size: 12px;
        color: var(--muted);
        line-height: 1.4;
      }

      /* Weekly Calendar */
      .day-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .day-card:hover {
        background: rgba(140, 150, 104, 0.1);
        border-color: var(--venus-green);
      }

      .day-card.selected {
        background: rgba(140, 150, 104, 0.2);
        border-color: var(--venus-green);
      }

      .day-card.today {
        border: 2px solid var(--venus-green);
      }

      .day-name {
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        margin-bottom: 4px;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .data-table th,
      .data-table td {
        padding: 12px 8px;
        text-align: left;
        border-bottom: 1px solid var(--line);
      }

      .data-table th {
        font-weight: 600;
        color: var(--venus-soft);
        background: rgba(255, 255, 255, .02);
      }

      .data-table tbody tr:hover {
        background: rgba(255, 255, 255, .03);
      }

      /* Responsive table */
      @media (max-width: 768px) {
        .data-table thead {
          display: none;
        }

        .data-table,
        .data-table tbody,
        .data-table tr,
        .data-table td {
          display: block;
          width: 100%;
        }

        .data-table tr {
          margin-bottom: 16px;
          border: 1px solid var(--line);
          border-radius: 12px;
          padding: 12px;
          background: rgba(255, 255, 255, .02);
        }

        .data-table td {
          padding: 8px 0;
          border: none;
          position: relative;
          padding-left: 45%;
          text-align: right;
        }

        .data-table td::before {
          content: attr(data-label);
          position: absolute;
          left: 0;
          width: 40%;
          padding-left: 8px;
          font-weight: 600;
          color: var(--venus-soft);
          text-align: left;
        }

        .data-table td .actions {
          justify-content: flex-end;
        }
      }

      .day-number {
        font-size: 20px;
        font-weight: 700;
        color: #fff;
        margin-bottom: 4px;
      }

      .day-count {
        font-size: 11px;
        color: var(--venus-soft);
      }

      /* Stats Cards */
      .stat-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
      }

      .stat-label {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--venus-soft);
      }

      /* Section Headers */
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 12px;
      }

      .section-header h2 {
        font-size: 20px;
        font-weight: 700;
        color: var(--ink);
        margin: 0;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      /* Responsive Grids */
      .grid-service-price {
        display: grid;
        grid-template-columns: 1fr 120px;
        gap: 10px;
      }

      .grid-date-time {
        display: grid;
        grid-template-columns: 1fr 100px 90px 1fr;
        gap: 10px;
      }

      .full-width {
        grid-column: 1 / -1;
      }

      /* Mobile Responsiveness */
      @media (max-width: 768px) {
        .grid-service-price {
          grid-template-columns: 1fr;
        }

        .grid-date-time {
          grid-template-columns: 1fr 1fr;
          gap: 8px;
        }

        /* Make date span full width on mobile */
        .grid-date-time>div:first-child {
          grid-column: 1 / -1;
        }

        #newApptDialog,
        #editApptDialog {
          width: 95%;
          max-height: 95vh;
          margin: 10px auto;
        }

        .dialog-content {
          padding: 16px;
          max-height: 85vh;
          overflow-y: auto;
        }

        .form-label {
          font-size: 13px;
        }

        .form-input {
          font-size: 16px;
          /* Prevent zoom on iOS */
        }

        /* Adjust calendar dropdown for mobile to be centered */
        .calendar-dropdown {
          position: fixed;
          top: 50% !important;
          left: 50% !important;
          transform: translate(-50%, -50%);
          width: 90%;
          max-width: 320px;
          margin-top: 0;
          z-index: 2000;
        }
      }

      /* Custom Calendar Dropdown */
      .calendar-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        margin-top: 8px;
        background: #1a1a1a;
        /* Solid background */
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 16px;
        width: 300px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        min-width: 280px;
      }

      /* Custom Searchable Dropdown */
      .custom-select-wrapper {
        position: relative;
      }

      .dropdown-toggle-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--venus-soft);
        cursor: pointer;
        font-size: 12px;
        pointer-events: auto;
        /* Ensure click works */
        padding: 4px;
      }

      .custom-dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1001;
        margin-top: 4px;
        background: #1a1a1a;
        border: 1px solid var(--line);
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }

      .dropdown-item {
        padding: 10px 12px;
        cursor: pointer;
        font-size: 13px;
        color: var(--ink);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s;
      }

      .dropdown-item:last-child {
        border-bottom: none;
      }

      .dropdown-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .dropdown-item .item-meta {
        display: block;
        font-size: 11px;
        color: var(--muted);
        margin-top: 2px;
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        gap: 8px;
      }

      .calendar-nav-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--line);
        color: #fff;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
      }

      .calendar-nav-btn:hover {
        background: var(--venus-green);
        border-color: var(--venus-green);
      }

      .calendar-month-year {
        font-weight: 600;
        color: #fff;
        font-size: 14px;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }

      .calendar-day-header {
        text-align: center;
        font-size: 11px;
        color: var(--venus-soft);
        padding: 8px 0;
        font-weight: 600;
      }

      .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        color: #fff;
        transition: all 0.15s;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid transparent;
      }

      .calendar-day:hover:not(.empty):not(.selected) {
        background: rgba(140, 150, 104, 0.2);
        border-color: var(--venus-green);
      }

      .calendar-day.empty {
        cursor: default;
        background: transparent;
        opacity: 0.3;
      }

      .calendar-day.today {
        border-color: var(--venus-green);
        background: rgba(140, 150, 104, 0.15);
        font-weight: 600;
      }

      .calendar-day.selected {
        background: var(--venus-green);
        color: #000;
        font-weight: 600;
      }

      .calendar-day.other-month {
        color: rgba(255, 255, 255, 0.3);
      }
    </style>

    <!-- DIALOG: Esc√°ner QR -->
    <dialog id="scanDialog">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <h3 style="margin:0;font-size:16px;">Escanear tarjeta</h3>
        <button type="button" id="scan-close" class="btn small ghost">Cerrar</button>
      </div>
      <div id="qr-reader" style="width:100%;"></div>
      <div class="muted" id="scan-status" style="margin-top:8px;font-size:12px;">Iniciando c√°mara‚Ä¶</div>
    </dialog>

    <!-- DIALOG: Esc√°ner Gift Card -->
    <dialog id="giftScanDialog"
      style="background:rgba(27,28,26,0.95);border:1px solid rgba(255,255,255,0.15);border-radius:16px;padding:20px;max-width:500px;width:90%;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h3 style="margin:0;font-size:16px;color:#f9fafb;"><i class="fas fa-qrcode"></i> Escan gift card</h3>
        <button type="button" id="gift-scan-close" class="btn small ghost">Cerrar</button>
      </div>
      <div id="gift-qr-reader" style="width:100%;"></div>
      <div class="muted" id="gift-scan-status" style="margin-top:12px;font-size:13px;text-align:center;">Esperando
        escaneo...</div>
    </dialog>


    <footer class="footer">¬© Venus Cosmetolog√≠a</footer>

    <!-- Modal Tarjeta - SIMPLIFICADO -->
    <div id="card-modal-backdrop" class="modal-backdrop hidden">
      <div class="modal-card" style="max-width:420px;">

        <!-- Header con acciones r√°pidas -->
        <div class="modal-header" style="flex-wrap:wrap;gap:10px;">
          <h3 style="margin:0;flex:1;"><i class="fas fa-user"></i> Cliente</h3>
          <div style="display:flex;gap:6px;">
            <button id="cm-stamp" class="btn small" style="background:#FFD166;color:#1b1b1b;font-weight:600;">‚≠ê +1
              sello</button>
            <button id="cm-close" class="btn small ghost">‚úï</button>
          </div>
        </div>

        <!-- Info del cliente -->
        <div class="modal-body" style="padding:16px 0;">

          <!-- Datos principales -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
            <div>
              <div class="muted" style="font-size:11px;margin-bottom:2px;">Nombre</div>
              <div id="cm-name" style="font-weight:600;font-size:15px;">‚Äî</div>
            </div>
            <div>
              <div class="muted" style="font-size:11px;margin-bottom:2px;">Tel√©fono</div>
              <div id="cm-phone" style="font-size:15px;">‚Äî</div>
            </div>
          </div>

          <!-- Sellos con barra de progreso -->
          <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:14px;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <span style="font-size:13px;">Progreso</span>
              <span id="cm-stamps" style="font-weight:700;font-size:18px;color:var(--venus-soft);">0 / 8</span>
            </div>
            <div style="background:rgba(255,255,255,0.1);border-radius:8px;height:8px;overflow:hidden;">
              <div id="cm-progress-bar"
                style="background:linear-gradient(90deg,#FFD166,#8c9668);height:100%;width:0%;transition:width 0.3s;border-radius:8px;">
              </div>
            </div>
            <div id="cm-status-text" class="muted" style="font-size:11px;margin-top:6px;text-align:center;">‚Äî</div>
          </div>

          <!-- Pr√≥xima cita (si existe) -->
          <div id="cm-next-appt-section" class="hidden"
            style="background:rgba(140,150,104,0.15);border:1px solid rgba(140,150,104,0.3);border-radius:12px;padding:12px;margin-bottom:16px;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
              <span>üìÖ</span>
              <span style="font-size:12px;color:var(--venus-soft);font-weight:600;">Pr√≥xima cita</span>
            </div>
            <div id="cm-next-appt-date" style="font-size:18px;font-weight:700;color:#22c55e;">‚Äî</div>
            <div id="cm-next-appt-service" style="font-size:13px;margin-top:2px;">‚Äî</div>
          </div>

          <!-- Stats r√°pidos -->
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;">
            <div style="text-align:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;">
              <div id="cm-visited-count" style="font-size:18px;font-weight:700;color:var(--venus-soft);">0</div>
              <div class="muted" style="font-size:10px;">Visitas</div>
            </div>
            <div style="text-align:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;">
              <div id="cm-cycles-completed" style="font-size:18px;font-weight:700;color:var(--venus-soft);">0</div>
              <div class="muted" style="font-size:10px;">Ciclos</div>
            </div>
            <div style="text-align:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;">
              <div id="cm-last-visit" style="font-size:12px;font-weight:600;color:var(--venus-soft);">‚Äî</div>
              <div class="muted" style="font-size:10px;">√öltima visita</div>
            </div>
          </div>

          <!-- Notas (colapsable) -->
          <details style="margin-bottom:16px;">
            <summary style="cursor:pointer;font-size:13px;color:var(--venus-soft);margin-bottom:8px;">üìù Notas del
              cliente</summary>
            <textarea id="cm-notes" class="modal-textarea" rows="2" placeholder="Agregar notas..."
              style="width:100%;background:rgba(0,0,0,0.2);border:1px solid var(--line);border-radius:8px;padding:10px;color:#fff;font-size:13px;resize:none;"></textarea>
            <button id="cm-save-notes" class="btn small ghost" style="margin-top:6px;font-size:11px;"><i class="fas fa-save"></i> Guardar
              nota</button>
          </details>

          <!-- QR (colapsable) -->
          <details>
            <summary style="cursor:pointer;font-size:13px;color:var(--venus-soft);margin-bottom:8px;">üî≤ C√≥digo QR
            </summary>
            <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:12px;text-align:center;">
              <canvas id="card-qr" style="max-width:150px;"></canvas>
              <div class="muted" style="font-size:10px;margin-top:6px;">ID: <code id="cm-id"
                  style="font-size:10px;">‚Äî</code></div>
            </div>
          </details>

        </div>

        <!-- Footer con acciones -->
        <div class="modal-footer"
          style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.1);">
          <button id="cm-whatsapp" class="btn small" style="background:#25D366;color:white;">
            üí¨ WhatsApp
          </button>
          <button id="cm-schedule" class="btn small" style="background:#8c9668;color:white;">
            üìÖ Agendar
          </button>
          <button id="cm-redeem" class="btn small">
            üéÅ Canjear
          </button>
        </div>

        <!-- Acciones secundarias -->
        <div
          style="display:flex;justify-content:center;gap:12px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.05);">
          <button id="cm-copy" class="btn-link"
            style="background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;">Copiar ID</button>
          <button id="cm-open-url" class="btn-link"
            style="background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;">Abrir p√°gina</button>
          <button id="cm-notify" class="btn-link"
            style="background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;">Notificar</button>
          <button id="cm-delete" class="btn-link"
            style="background:none;border:none;color:#ef4444;font-size:11px;cursor:pointer;">Eliminar</button>
        </div>

        <!-- Formulario de Notificaci√≥n Individual (Oculto por defecto) -->
        <div id="notify-form-container" class="notify-form-container hidden" style="margin-top:16px;">
          <span class="notify-form-header">üîî Push Individual</span>
          <div class="input-group">
            <input id="notify-title" class="notify-input" placeholder="T√≠tulo" value="Recordatorio Venus">
            <span class="input-icon">üìå</span>
          </div>
          <div class="input-group">
            <textarea id="notify-message" class="notify-textarea" placeholder="Escribe tu mensaje aqu√≠..."></textarea>
            <span class="input-icon">üí¨</span>
          </div>
          <div class="notify-btn-group" style="display:flex;gap:8px;margin-top:10px;">
            <button id="btn-cancel-notify" class="btn small ghost">Cancelar</button>
            <button id="btn-send-notify" class="btn small primary">üöÄ Enviar</button>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- Off-Canvas Menu for Module Selection -->
  <div class="offcanvas-backdrop" id="offcanvas-backdrop"></div>
  <div class="offcanvas" id="modules-offcanvas">
    <div class="offcanvas-header">
      <h3 class="offcanvas-title">üéõÔ∏è Personalizar Dashboard</h3>
      <button class="btn small ghost" id="close-offcanvas">‚úï</button>
    </div>

    <p class="muted" style="font-size: 13px; margin-bottom: 20px;">
      Selecciona los m√≥dulos que deseas ver en el Resumen
    </p>

    <!-- Module Toggles -->
    <div id="module-list">
      <div class="module-item" data-module="kpis">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-chart-bar"></i></span>
          <span class="module-label">KPIs Principales</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="kpis" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="birthdays">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-birthday-cake"></i></span>
          <span class="module-label">Cumplea√±os</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="birthdays" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="activity">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-chart-line"></i></span>
          <span class="module-label">Gr√°fica de Actividad</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="activity" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="topClients">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-star"></i></span>
          <span class="module-label">Top Clientes</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="topClients" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="walletStats">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-mobile-alt"></i></span>
          <span class="module-label">Estado de Wallets</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="walletStats" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="newKPIs">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-chart-bar"></i></span>
          <span class="module-label">KPIs Avanzados</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="newKPIs" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

    <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
      <button id="reset-modules" class="btn small ghost" style="width: 100%;">
        üîÑ Restaurar por defecto
      </button>
    </div>
  </div>

  <!-- Modal Nuevo/Editar Servicio -->
  <!-- Modal Nuevo/Editar Servicio -->
  <div id="modal-service" class="modal-backdrop hidden">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="modal-service-title">Nuevo Servicio</h3>
        <span class="close-modal" id="close-modal-service">&times;</span>
      </div>

      <form id="form-service">
        <input type="hidden" id="service-id">

        <div class="form-group">
          <label class="form-label">Nombre del Servicio</label>
          <input type="text" id="service-name" class="form-input" required placeholder="Ej. Facial Hidratante">
        </div>

        <div class="row" style="gap:15px;">
          <div class="form-group" style="flex:1;">
            <label class="form-label">Duraci√≥n (min)</label>
            <input type="number" id="service-duration" class="form-input" required min="10" step="5" value="60">
          </div>
          <div class="form-group" style="flex:1;">
            <label class="form-label">Precio</label>
            <div style="position:relative;">
              <span
                style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:14px;">$</span>
              <input type="number" id="service-price" class="form-input" required min="0" step="50"
                style="padding-left:25px;">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn ghost" id="cancel-service">Cancelar</button>
          <button type="submit" class="btn primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- QRCode lib -->

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- Chart.js lib -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    // Global instances
    let newApptClientDropdown, newApptServiceDropdown, editApptServiceDropdown;

    // Payment dialog variables
    let currentPaymentApptId = null;
    const paymentDialog = document.getElementById('paymentDialog');
    const formPayment = document.getElementById('form-payment');

    const $ = s => document.querySelector(s);

    /* ===== MODULE SELECTION SYSTEM ===== */
    const DEFAULT_MODULES = {
      kpis: true,
      birthdays: true,
      activity: true,
      topClients: true,
      walletStats: true,
      newKPIs: true
    };

    // Load saved modules from localStorage
    function getSelectedModules() {
      const saved = localStorage.getItem('venus_modules');
      return saved ? JSON.parse(saved) : { ...DEFAULT_MODULES };
    }

    // Save modules to localStorage
    function saveSelectedModules(modules) {
      localStorage.setItem('venus_modules', JSON.stringify(modules));
    }

    // Apply module visibility
    function applyModuleVisibility() {
      const modules = getSelectedModules();

      // Find and toggle module visibility based on data-module-section attributes
      document.querySelectorAll('[data-module-section]').forEach(section => {
        const moduleName = section.getAttribute('data-module-section');
        if (modules[moduleName] === false) {
          section.style.display = 'none';
        } else {
          section.style.display = '';
        }
      });
    }

    // Open/close offcanvas
    function openOffcanvas() {
      document.getElementById('modules-offcanvas').classList.add('open');
      document.getElementById('offcanvas-backdrop').classList.add('show');
    }

    function closeOffcanvas() {
      document.getElementById('modules-offcanvas').classList.remove('open');
      document.getElementById('offcanvas-backdrop').classList.remove('show');
    }

    // Initialize module toggles from localStorage
    function initializeModuleToggles() {
      const modules = getSelectedModules();

      document.querySelectorAll('.toggle-switch input[type="checkbox"]').forEach(toggle => {
        const moduleName = toggle.getAttribute('data-module');
        toggle.checked = modules[moduleName] !== false;

        // Add event listener
        toggle.addEventListener('change', (e) => {
          const modules = getSelectedModules();
          modules[moduleName] = e.target.checked;
          saveSelectedModules(modules);
          applyModuleVisibility();

          console.log('üìä M√≥dulo', moduleName, e.target.checked ? 'activado' : 'desactivado');
        });
      });
    }

    // Event listeners for offcanvas
    document.getElementById('btn-personalize-dashboard').addEventListener('click', openOffcanvas);
    document.getElementById('close-offcanvas').addEventListener('click', closeOffcanvas);
    document.getElementById('offcanvas-backdrop').addEventListener('click', closeOffcanvas);

    // Reset to defaults
    document.getElementById('reset-modules').addEventListener('click', () => {
      if (confirm('¬øRestaurar configuraci√≥n por defecto?')) {
        saveSelectedModules(DEFAULT_MODULES);
        initializeModuleToggles();
        applyModuleVisibility();
        alert('‚úÖ Configuraci√≥n restaurada');
      }
    });

    // Initialize on page load
    initializeModuleToggles();
    applyModuleVisibility();

    /* ===== AUTOMATIZACIONES (UI PLACEHOLDER) ===== */
    // Event listeners para los toggles de automatizaciones
    document.querySelectorAll('[id^="auto-"][id$="-enabled"]').forEach(toggle => {
      toggle.addEventListener('change', (e) => {
        const ruleType = e.target.id.replace('auto-', '').replace('-enabled', '');
        console.log(`ü§ñ Automatizaci√≥n "${ruleType}" ${e.target.checked ? 'activada' : 'desactivada'}`);
        // TODO: Guardar en Firestore cuando se implemente backend
      });
    });

    // Event listeners para botones de prueba
    document.querySelectorAll('.automation-test-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const type = e.target.getAttribute('data-type');
        alert(`üß™ Funci√≥n de prueba para "${type}" ser√° implementada pr√≥ximamente.\n\nEsto enviar√° una notificaci√≥n de prueba a un cliente aleatorio.`);
      });
    });

    // Bot√≥n ejecutar todas las automatizaciones
    document.getElementById('btn-run-all-automations')?.addEventListener('click', () => {
      alert('‚ñ∂Ô∏è Ejecuci√≥n de automatizaciones ser√° implementada pr√≥ximamente.\n\nEsto procesar√° todas las reglas activas y enviar√° notificaciones a los clientes que cumplan las condiciones.');
    });

    /* ===== GIFT CARD QR SCANNER ===== */
    let giftHtml5QrcodeScanner = null;
    const giftScanDialog = document.getElementById('giftScanDialog');
    const giftScanStatus = document.getElementById('gift-scan-status');

    // Bot√≥n para abrir scanner
    document.getElementById('btn-scan-gift-card')?.addEventListener('click', () => {
      openGiftScanner();
    });

    // Bot√≥n para cerrar scanner
    document.getElementById('gift-scan-close')?.addEventListener('click', () => {
      closeGiftScanner();
    });

    function openGiftScanner() {
      if (typeof Html5Qrcode === 'undefined') {
        alert('‚ùå Librer√≠a de scanner no disponible');
        return;
      }

      giftScanDialog.showModal();
      giftScanStatus.textContent = 'Iniciando c√°mara...';

      // Inicializar scanner
      giftHtml5QrcodeScanner = new Html5Qrcode('gift-qr-reader');

      const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      };

      giftHtml5QrcodeScanner.start(
        { facingMode: 'environment' }, // C√°mara trasera
        config,
        onGiftScanSuccess,
        onGiftScanError
      ).then(() => {
        giftScanStatus.textContent = 'üì∑ Escanea el QR de la gift card';
      }).catch(err => {
        console.error('Error iniciando c√°mara:', err);
        giftScanStatus.textContent = '‚ùå Error al iniciar c√°mara';
      });
    }

    function closeGiftScanner() {
      if (giftHtml5QrcodeScanner) {
        giftHtml5QrcodeScanner.stop().then(() => {
          giftHtml5QrcodeScanner.clear();
          giftHtml5QrcodeScanner = null;
        }).catch(err => {
          console.error('Error cerrando scanner:', err);
        });
      }
      giftScanDialog.close();
    }

    async function onGiftScanSuccess(decodedText) {
      console.log('‚úÖ QR escaneado:', decodedText);
      giftScanStatus.textContent = '‚úÖ QR detectado, procesando...';

      // Detener scanner
      if (giftHtml5QrcodeScanner) {
        await giftHtml5QrcodeScanner.stop();
      }

      // Procesar gift card
      await processGiftCardScan(decodedText);
    }

    function onGiftScanError(error) {
      // Silenciar errores de escaneo continuo
    }

    async function processGiftCardScan(giftId) {
      try {
        // Buscar gift card
        const response = await fetch(`/api/admin/gift-card/${giftId}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Gift card no encontrada');
        }

        const giftCard = await response.json();

        // Verificar si ya fue canjeada
        if (giftCard.redeemed) {
          giftScanStatus.textContent = '‚ö†Ô∏è Esta gift card ya fue canjeada';
          alert(`‚ö†Ô∏è Gift card ya canjeada\n\nCanjeada por: ${giftCard.redeemedBy || 'No disponible'}\nFecha: ${new Date(giftCard.redeemedAt).toLocaleString('es-MX')}`);
          setTimeout(() => {
            closeGiftScanner();
          }, 2000);
          return;
        }

        // Confirmar canje
        const confirmed = confirm(`¬øCanjear gift card?\n\nServicio: ${giftCard.service}\nCliente: ${giftCard.clientName || 'An√≥nimo'}\n\n¬øMarcar como canjeada?`);

        if (!confirmed) {
          giftScanStatus.textContent = 'Canje cancelado';
          setTimeout(() => {
            closeGiftScanner();
          }, 1500);
          return;
        }

        // Marcar como canjeada
        const redeemResponse = await fetch(`/api/admin/gift-card/${giftId}/redeem`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });

        if (!redeemResponse.ok) {
          throw new Error('Error al canjear');
        }

        giftScanStatus.textContent = '‚úÖ Gift card canjeada correctamente';
        alert('‚úÖ Gift card canjeada exitosamente');

        // Recargar lista de gift cards si estamos en ese tab
        if (!document.getElementById('tab-events').classList.contains('hidden')) {
          loadGiftHistory();
        }

        setTimeout(() => {
          closeGiftScanner();
        }, 1500);

      } catch (error) {
        console.error('Error procesando gift card:', error);
        giftScanStatus.textContent = `‚ùå ${error.message}`;
        alert(`‚ùå Error: ${error.message}`);
        setTimeout(() => {
          closeGiftScanner();
        }, 2000);
      }
    }

    /* ===== SESI√ìN Y PROTECCI√ìN ===== */
    async function loadMe() {
      try {
        const r = await fetch("/api/admin/me", { credentials: "include" });

        // ‚≠ê CR√çTICO: Si no hay sesi√≥n v√°lida, redirigir al login
        if (!r.ok) {
          console.log("Sin sesi√≥n v√°lida, redirigiendo a login...");
          window.location.href = "/admin-login.html";
          return;
        }

        const j = await r.json();
        $("#me-line").textContent = "Sesi√≥n: " + (j.email || j.uid || "admin");

        // ‚≠ê CR√çTICO: Quitar la pantalla negra solo cuando la sesi√≥n sea v√°lida
        document.body.classList.remove('checking-auth');
        document.body.classList.add('auth-verified');

        // Cargar datos iniciales
        loadMetrics('week');
      } catch (e) {
        console.error("Error verificando sesi√≥n:", e);
        // Si hay error de red o servidor, tambi√©n redirigir
        window.location.href = "/admin-login.html";
      }
    }

    // ‚≠ê CR√çTICO: Verificar sesi√≥n ANTES de mostrar cualquier cosa
    loadMe();

    /* ===== TABS ===== */
    document.querySelectorAll('[data-tab]').forEach(tab => {
      tab.addEventListener('click', function (e) {
        e.preventDefault();

        document.querySelectorAll('.nav a').forEach(a => a.classList.remove('is-active'));
        this.classList.add('is-active');

        document.querySelectorAll('[id^="tab-"]').forEach(s => s.classList.add('hidden'));

        const targetId = 'tab-' + this.getAttribute('data-tab');
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
          targetSection.classList.remove('hidden');
        }

        const tabName = this.getAttribute('data-tab');
        if (tabName === 'overview') {
          loadMetrics(document.getElementById('stats-filter').value);
        } else if (tabName === 'cards') {
          loadCards(1);
        } else if (tabName === 'settings') {
          loadNotificationsHistory();
        }
      });
    });

    /* ===== FILTRADO Y REPORTES ===== */
    let globalStatsData = {};

    // Evento cambio de filtro
    document.getElementById('stats-filter').addEventListener('change', (e) => {
      loadMetrics(e.target.value);
    });

    // Evento descargar reporte
    document.getElementById('btn-download-report').addEventListener('click', downloadCSV);

    function downloadCSV() {
      if (!globalStatsData.clientsToExport || globalStatsData.clientsToExport.length === 0) {
        alert('‚ö†Ô∏è No hay datos para exportar. Espera a que carguen las m√©tricas.');
        return;
      }

      // Get selected modules from localStorage
      const selectedModules = getSelectedModules();

      const period = document.getElementById('stats-filter').value;
      const periodLabel = period === 'day' ? 'Hoy' : period === 'week' ? 'Esta Semana' : 'Este Mes';

      let csvContent = 'data:text/csv;charset=utf-8,';

      // Header
      csvContent += `REPORTE DE LEALTAD VENUS\r\n`;
      csvContent += `Periodo: ${periodLabel}\r\n`;
      csvContent += `Generado: ${new Date().toLocaleString('es-MX')}\r\n`;
      csvContent += `\r\n`;

      // ===== KPIs Section (if enabled) =====
      if (selectedModules.kpis !== false) {
        csvContent += `M√âTRICAS GENERALES\r\n`;
        csvContent += `M√©trica,Valor\r\n`;
        csvContent += `Total Tarjetas Activas,${globalStatsData.total || 0}\r\n`;
        csvContent += `Tarjetas Completadas,${globalStatsData.full || 0}\r\n`;
        csvContent += `Sellos en este periodo,${globalStatsData.stamps || 0}\r\n`;
        csvContent += `Canjes en este periodo,${globalStatsData.redeems || 0}\r\n`;
        csvContent += `Promedio de Sellos,${globalStatsData.avg || 0}\r\n`;
        csvContent += `Tasa de Completitud,${globalStatsData.rate || '0%'}\r\n`;
        csvContent += `\r\n`;
      }

      // ===== Top Clients Section (if enabled) =====
      if (selectedModules.topClients !== false && globalStatsData.clients && globalStatsData.clients.length > 0) {
        csvContent += `TOP CLIENTES\r\n`;
        csvContent += `Nombre,Sellos,Meta,Estado,Progreso\r\n`;
        globalStatsData.clients.forEach(c => {
          const estado = c.stamps >= c.max ? "Completada" : "En curso";
          const progreso = Math.round((c.stamps / c.max) * 100) + '%';
          const name = (c.name || "Sin nombre").replace(/,/g, "");
          csvContent += `${name},${c.stamps},${c.max},${estado},${progreso}\r\n`;
        });
        csvContent += `\r\n`;
      }

      // ===== Wallet Stats Section (if enabled) =====
      if (selectedModules.walletStats !== false && globalStatsData.walletStats) {
        csvContent += `ESTADO DE WALLETS\r\n`;
        csvContent += `Plataforma,Cantidad\r\n`;
        csvContent += `Google Wallet,${globalStatsData.walletStats.google || 0}\r\n`;
        csvContent += `Apple Wallet,${globalStatsData.walletStats.apple || 0}\r\n`;
        csvContent += `Dispositivos Totales,${globalStatsData.walletStats.total || 0}\r\n`;
        csvContent += `\r\n`;
      }

      // ===== All Cards Data =====
      csvContent += `TODAS LAS TARJETAS\r\n`;
      csvContent += `Nombre,Tel√©fono,Sellos Actuales,Meta,Estado,Fecha Nacimiento,√öltima Visita,Creada,Visitas Totales,Ciclos Completados,Servicios Favoritos,Notas\r\n`;

      globalStatsData.clientsToExport.forEach(c => {
        const estado = c.stamps >= c.max ? "Completada" : "En curso";
        const phone = c.phone || "";
        const bday = c.birthdate || "";
        const last = c.last_visit ? new Date(c.last_visit).toLocaleDateString() : (c.updated_at ? new Date(c.updated_at).toLocaleDateString() : "");
        const created = c.createdAt ? new Date(c.createdAt).toLocaleDateString() : "";
        const name = (c.name || "Sin nombre").replace(/,/g, "");

        // ‚≠ê FASE 5: Nuevas columnas
        const visitedCount = c.visitedCount || 0;
        const cyclesCompleted = c.cyclesCompleted || 0;
        const favoriteServices = (c.favoriteServices || "").replace(/,/g, ";"); // Reemplazar comas
        const notes = (c.notes || "").replace(/,/g, ";").replace(/\r?\n/g, " "); // Reemplazar comas y saltos de l√≠nea

        csvContent += `${name},${phone},${c.stamps},${c.max},${estado},${bday},${last},${created},${visitedCount},${cyclesCompleted},${favoriteServices},${notes}\r\n`;
      });

      // Create download
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', `venus_reporte_${period}_${Date.now()}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      console.log('‚úÖ CSV generado con m√≥dulos:', Object.keys(selectedModules).filter(k => selectedModules[k] !== false));
    }

    /* ===== METRICS (Firestore) - MEJORADO CON FILTROS ===== */
    let activityChart = null;

    async function loadMetrics(range = 'week') {
      try {
        // Actualizar etiquetas seg√∫n el rango
        updatePeriodLabels(range);

        // M√©tricas b√°sicas con filtro de rango
        const response = await fetch(`/api/admin/metrics-firebase?range=${range}`, {
          credentials: 'include'
        });
        const data = await response.json();

        // KPIs principales
        document.getElementById('kpi-total').textContent = data.total || 0;
        document.getElementById('kpi-full').textContent = data.full || 0;

        // Actualizar seg√∫n el rango
        if (range === 'day') {
          document.getElementById('kpi-stamps').textContent = data.stampsToday || 0;
          document.getElementById('kpi-redeems').textContent = data.redeemsToday || 0;
        } else if (range === 'week') {
          document.getElementById('kpi-stamps').textContent = data.stampsWeek || 0;
          document.getElementById('kpi-redeems').textContent = data.redeemsWeek || 0;
        } else if (range === 'month') {
          document.getElementById('kpi-stamps').textContent = data.stampsMonth || 0;
          document.getElementById('kpi-redeems').textContent = data.redeemsMonth || 0;
        }

        // Promedio sellos
        const avg = data.total > 0 ? (((data.totalStamps || 0) / data.total)).toFixed(1) : '0.0';
        document.getElementById('kpi-avg').textContent = avg;

        // Tasa de completitud
        const rate = data.total > 0 ? ((data.full / data.total) * 100).toFixed(0) : '0';
        document.getElementById('kpi-rate').textContent = rate + '%';

        // Cargar componentes adicionales
        await loadTopClients();
        await loadActivityChart(range);
        await loadWalletStats();

        // Fetch ALL cards for Birthdays & Report
        // Note: For large datasets, this should be paginated or a separate endpoint
        try {
          const cardsResp = await fetch('/api/admin/cards-firebase?limit=1000', { credentials: 'include' });
          if (cardsResp.ok) {
            const cardsData = await cardsResp.json();
            checkOverviewBirthdays(cardsData.items || []);

            // Populate globalStatsData.clients with ALL clients for the report
            // (loadTopClients only gets top 5)
            if (cardsData.items) {
              globalStatsData.allClients = cardsData.items;
            }
          }
        } catch (e) {
          console.error("Error fetching cards for overview:", e);
        }

        // Guardar datos para reporte
        globalStatsData = {
          ...globalStatsData, // Keep allClients if set
          total: data.total || 0,
          full: data.full || 0,
          stampsPeriod: range === 'day' ? data.stampsToday : (range === 'week' ? data.stampsWeek : data.stampsMonth),
          redeemsPeriod: range === 'day' ? data.redeemsToday : (range === 'week' ? data.redeemsWeek : data.redeemsMonth),
          avg: avg,
          rate: rate,
          range: range
        };

      } catch (error) {
        console.error('Error:', error);
        // En caso de error, cargar datos de ejemplo
        loadSampleData(range);
      }
    }

    function updatePeriodLabels(range) {
      const stampsLabel = document.getElementById('stamps-period-label');
      const redeemsLabel = document.getElementById('redeems-period-label');
      const activityTitle = document.getElementById('activity-title');

      if (range === 'day') {
        stampsLabel.textContent = 'Sellos hoy';
        redeemsLabel.textContent = 'Canjes hoy';
        activityTitle.textContent = 'üìà Actividad hoy';
      } else if (range === 'week') {
        stampsLabel.textContent = 'Sellos esta semana';
        redeemsLabel.textContent = 'Canjes esta semana';
        activityTitle.textContent = 'üìà Actividad reciente (7 d√≠as)';
      } else if (range === 'month') {
        stampsLabel.textContent = 'Sellos este mes';
        redeemsLabel.textContent = 'Canjes este mes';
        activityTitle.textContent = 'üìà Actividad mensual';
      }
    }


    /* ===== ADVANCED KPIS (NUEVO - FASE 3) ===== */
    let dayChart = null;
    let hourChart = null;

    async function loadAdvancedKPIs(range = 'week') {
      try {
        // Obtener todas las tarjetas para an√°lisis
        const response = await fetch('/api/admin/cards-all?limit=1000', {
          credentials: 'include'
        });
        const data = await response.json();
        const cards = data.items || [];

        const now = new Date();
        const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

        // Determinar rango para "clientes nuevos"
        let periodStart;
        if (range === 'day') {
          periodStart = new Date(now.setHours(0, 0, 0, 0));
        } else if (range === 'week') {
          periodStart = new Date(now - 7 * 24 * 60 * 60 * 1000);
        } else {
          periodStart = new Date(now.getFullYear(), now.getMonth(), 1);
        }

        // 1. Clientes nuevos
        const newClients = cards.filter(c => {
          if (!c.createdAt) return false;
          return new Date(c.createdAt) >= periodStart;
        });

        // 2 & 3. Clientes activos e inactivos (√∫ltimos 30 d√≠as)
        const activeClients = cards.filter(c => {
          const lastVisit = c.last_visit || c.updated_at;
          if (!lastVisit) return false;
          return new Date(lastVisit) >= thirtyDaysAgo;
        });
        const inactiveClients = cards.length - activeClients.length;

        // 4. Promedio d√≠as desde √∫ltima visita
        let totalDays = 0;
        let count = 0;
        cards.forEach(c => {
          const lastVisit = c.last_visit || c.updated_at;
          if (lastVisit) {
            const days = Math.floor((Date.now() - new Date(lastVisit).getTime()) / (24 * 60 * 60 * 1000));
            totalDays += days;
            count++;
          }
        });
        const avgLastVisit = count > 0 ? Math.round(totalDays / count) : 0;

        // 5. Ciclos completados
        const cyclesCompleted = cards.filter(c => c.stamps >= c.max).length;

        // 6. Tasa de retorno (activos / total)
        const returnRate = cards.length > 0 ? Math.round((activeClients.length / cards.length) * 100) : 0;

        // Actualizar UI
        document.getElementById('kpi-new-clients').textContent = newClients.length;
        document.getElementById('kpi-active-clients').textContent = `${activeClients.length} (${returnRate}%)`;
        document.getElementById('kpi-inactive-clients').textContent = inactiveClients;
        document.getElementById('kpi-avg-last-visit').textContent = `${avgLastVisit} d√≠as`;
        document.getElementById('kpi-cycles-completed').textContent = cyclesCompleted;
        document.getElementById('kpi-return-rate').textContent = `${returnRate}%`;

        // 7. Renderizar gr√°ficas de distribuci√≥n
        renderDayDistribution(cards);
        renderHourDistribution(cards);

        console.log('üìä KPIs avanzados cargados');
      } catch (error) {
        console.error('Error cargando KPIs avanzados:', error);
        // Valores por defecto en caso de error
        document.getElementById('kpi-new-clients').textContent = '‚Äî';
        document.getElementById('kpi-active-clients').textContent = '‚Äî';
        document.getElementById('kpi-inactive-clients').textContent = '‚Äî';
        document.getElementById('kpi-avg-last-visit').textContent = '‚Äî';
        document.getElementById('kpi-cycles-completed').textContent = '‚Äî';
        document.getElementById('kpi-return-rate').textContent = '‚Äî';
      }
    }

    function renderDayDistribution(cards) {
      const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
      const dayCounts = [0, 0, 0, 0, 0, 0, 0];

      cards.forEach(c => {
        const lastVisit = c.last_visit || c.updated_at;
        if (lastVisit) {
          const day = new Date(lastVisit).getDay();
          dayCounts[day]++;
        }
      });

      const ctx = document.getElementById('day-distribution-chart');
      if (dayChart) dayChart.destroy();

      dayChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dayNames,
          datasets: [{
            label: 'Visitas',
            data: dayCounts,
            backgroundColor: 'rgba(140, 150, 104, 0.6)',
            borderColor: 'rgb(140, 150, 104)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#e5e7eb', font: { size: 11 } },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            },
            x: {
              ticks: { color: '#e5e7eb', font: { size: 11 } },
              grid: { display: false }
            }
          }
        }
      });
    }

    function renderHourDistribution(cards) {
      const hourCounts = new Array(24).fill(0);

      cards.forEach(c => {
        const lastVisit = c.last_visit || c.updated_at;
        if (lastVisit) {
          const hour = new Date(lastVisit).getHours();
          hourCounts[hour]++;
        }
      });

      const ctx = document.getElementById('hour-distribution-chart');
      if (hourChart) hourChart.destroy();

      hourChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
          datasets: [{
            label: 'Visitas',
            data: hourCounts,
            borderColor: 'rgb(140, 150, 104)',
            backgroundColor: 'rgba(140, 150, 104, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#e5e7eb', font: { size: 11 } },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            },
            x: {
              ticks: { color: '#e5e7eb', font: { size: 10 }, maxRotation: 0 },
              grid: { display: false }
            }
          }
        }
      });
    }

    function loadSampleData(range) {
      // Datos de ejemplo para cuando la API falle
      let labels, dataStamps, kpiStamps, kpiRedeems;

      if (range === 'day') {
        labels = ['10:00', '12:00', '14:00', '16:00', '18:00', '20:00'];
        dataStamps = [2, 5, 1, 8, 4, 6];
        kpiStamps = 26;
        kpiRedeems = 3;
      } else if (range === 'week') {
        labels = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
        dataStamps = [12, 19, 3, 5, 22, 30, 15];
        kpiStamps = 106;
        kpiRedeems = 8;
      } else { // month
        labels = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];
        dataStamps = [80, 120, 95, 110];
        kpiStamps = 405;
        kpiRedeems = 25;
      }

      // Actualizar UI con datos de ejemplo
      document.getElementById('kpi-total').textContent = "142";
      document.getElementById('kpi-full').textContent = "18";
      document.getElementById('kpi-stamps').textContent = kpiStamps;
      document.getElementById('kpi-redeems').textContent = kpiRedeems;
      document.getElementById('kpi-avg').textContent = "5.2";
      document.getElementById('kpi-rate').textContent = "13%";

      // Actualizar gr√°fica
      renderChart(labels, dataStamps);

      // Simular Top Clientes
      renderSampleTopClients();

      // Guardar datos para reporte
      globalStatsData = {
        total: 142,
        full: 18,
        stampsPeriod: kpiStamps,
        redeemsPeriod: kpiRedeems,
        avg: "5.2",
        rate: "13",
        range: range
      };
    }

    function renderChart(labels, data) {
      const ctx = document.getElementById('activity-chart');

      // Destruir gr√°fica anterior si existe
      if (activityChart) {
        activityChart.destroy();
      }

      activityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Sellos',
            data: data,
            borderColor: '#8c9668',
            backgroundColor: 'rgba(140, 150, 104, 0.15)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: '#8c9668',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 10,
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#8c9668',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#e5e7eb',
                font: { size: 11 }
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#e5e7eb',
                font: { size: 11 }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    function renderSampleTopClients() {
      const clients = [
        { name: 'Ana L√≥pez', stamps: 7, max: 8 },
        { name: 'Carlos Ruiz', stamps: 8, max: 8 },
        { name: 'Sof√≠a Mendoza', stamps: 4, max: 8 },
        { name: 'Roberto Garc√≠a', stamps: 6, max: 8 },
        { name: 'Laura Torres', stamps: 8, max: 8 }
      ];

      const tbody = document.getElementById('top-clients');
      tbody.innerHTML = clients.map(c => `
        <tr>
          <td>${c.name}</td>
          <td>${c.stamps}/${c.max}</td>
          <td>
            ${c.stamps >= c.max
          ? '<span class="tag">üéÅ Completa</span>'
          : `<span class="muted">${c.max - c.stamps} m√°s</span>`
        }
          </td>
        </tr>
      `).join('');

      // Guardar para el reporte
      globalStatsData.clients = clients;
    }

    async function loadTopClients() {
      try {
        const response = await fetch('/api/admin/top-clients', {
          credentials: 'include'
        });
        const data = await response.json();

        const tbody = document.getElementById('top-clients');
        if (!data.clients || data.clients.length === 0) {
          tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:12px;" class="muted">No hay datos</td></tr>`;
          return;
        }

        tbody.innerHTML = data.clients.slice(0, 5).map(c => `
          <tr>
            <td>${c.name || 'Sin nombre'}</td>
            <td>${c.stamps}/${c.max}</td>
            <td>
              ${c.stamps >= c.max
            ? '<span class="tag">üéÅ Completa</span>'
            : `<span class="muted">${c.max - c.stamps} m√°s</span>`
          }
            </td>
          </tr>
        `).join('');

        // Guardar para el reporte
        globalStatsData.clients = data.clients.slice(0, 5);
      } catch (error) {
        console.error('Error cargando top clients:', error);
        renderSampleTopClients();
      }
    }

    async function loadActivityChart(range = 'week') {
      try {
        const response = await fetch(`/api/admin/activity-${range}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('API no disponible');
        }

        const data = await response.json();
        const ctx = document.getElementById('activity-chart');

        // Destruir gr√°fica anterior si existe
        if (activityChart) {
          activityChart.destroy();
        }

        activityChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.labels || ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
            datasets: [{
              label: 'Sellos',
              data: data.stamps || [0, 0, 0, 0, 0, 0, 0],
              borderColor: '#8c9668',
              backgroundColor: 'rgba(140, 150, 104, 0.15)',
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#8c9668',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 10,
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: '#8c9668',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: '#e5e7eb',
                  font: { size: 11 }
                },
                grid: {
                  color: 'rgba(255, 255, 255, 0.1)'
                }
              },
              x: {
                ticks: {
                  color: '#e5e7eb',
                  font: { size: 11 }
                },
                grid: {
                  display: false
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error cargando gr√°fica:', error);
        // Si falla, no hacemos nada ya que loadSampleData ya renderiz√≥ una gr√°fica
      }
    }

    /* ===== WALLET STATS MEJORADO ===== */
    async function loadWalletStats() {
      try {
        // Primero intentar con el nuevo endpoint de device-stats
        try {
          const deviceStatsResponse = await fetch('/api/admin/device-stats', {
            credentials: 'include'
          });

          if (deviceStatsResponse.ok) {
            const deviceStats = await deviceStatsResponse.json();

            // Mostrar en UI
            document.getElementById('kpi-google').textContent = deviceStats.googleWallet || 0;
            document.getElementById('kpi-apple').textContent = deviceStats.appleWallet || 0;
            document.getElementById('kpi-devices').textContent = deviceStats.totalDevices || 0;

            // ‚≠ê Guardar en globalStatsData para CSV
            globalStatsData.walletStats = {
              google: deviceStats.googleWallet || 0,
              apple: deviceStats.appleWallet || 0,
              total: deviceStats.totalDevices || 0
            };

            console.log('üì± Wallet stats cargadas exitosamente');
            return;
          }
        } catch (e) {
          console.log('Nuevo endpoint device-stats no disponible, usando endpoint legacy');
        }

        // Fallback al endpoint legacy
        const response = await fetch('/api/admin/wallet-stats', {
          credentials: 'include'
        });
        const data = await response.json();

        document.getElementById('kpi-google').textContent = data.googleWallets || 0;
        document.getElementById('kpi-apple').textContent = data.appleWallets || 0;
        document.getElementById('kpi-devices').textContent = data.appleDevices || 0;
      } catch (error) {
        console.error('Error cargando wallet stats:', error);
        document.getElementById('kpi-google').textContent = '‚Äî';
        document.getElementById('kpi-apple').textContent = '‚Äî';
        document.getElementById('kpi-devices').textContent = '‚Äî';
      }
    }

    // Bot√≥n para actualizar estad√≠sticas de wallets
    document.getElementById('btn-refresh-wallet-stats')?.addEventListener('click', loadWalletStats);

    /* ===== CARDS (Firestore + men√∫ de acciones) ===== */
    let currentPage = 1;
    let cardsCache = {};
    let currentCardId = null;

    // Helper para formatear cumplea√±os
    function formatBirthday(birthdate) {
      if (!birthdate) return '';
      const [y, m, d] = birthdate.split('-').map(Number);
      const months = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
      return `${d} ${months[m - 1]}`;
    }

    async function loadCards(page = 1) {
      try {
        const searchQuery = document.getElementById('search-cards').value;
        const sortValue = document.getElementById('sort-cards').value;
        const [sortField, sortOrder] = sortValue.split(':');

        const url = `/api/admin/cards-firebase?page=${page}&q=${encodeURIComponent(searchQuery)}&sort=${sortField}&order=${sortOrder}`;

        const response = await fetch(url, {
          credentials: 'include'
        });

        if (!response.ok) throw new Error('Error ' + response.status);

        const data = await response.json();
        const tbody = document.getElementById('cards-tbody');

        if (!data.items || data.items.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:12px;" class="muted">No hay tarjetas</td></tr>`;
          return;
        }

        cardsCache = {};
        data.items.forEach(c => { cardsCache[c.id] = c; });

        // Check birthdays
        checkBirthdays(data.items);

        tbody.innerHTML = data.items.map(card => {
          // Formatear √∫ltima visita
          let lastVisitStr = '‚Äî';
          if (card.last_visit) {
            const lastDate = new Date(card.last_visit);
            const now = new Date();
            const diffDays = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) lastVisitStr = 'Hoy';
            else if (diffDays === 1) lastVisitStr = 'Ayer';
            else if (diffDays < 7) lastVisitStr = `Hace ${diffDays} d√≠as`;
            else lastVisitStr = lastDate.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
          } else if (card.updated_at) {
            lastVisitStr = new Date(card.updated_at).toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
          }

          return `
          <tr data-card-id="${card.id}" class="card-row" style="cursor:pointer;">
            <td>
              <div style="font-weight:500;">${card.name || '‚Äî'}</div>
              ${card.birthdate ? `<div class="muted" style="font-size:11px;">üéÇ ${formatBirthday(card.birthdate)}</div>` : ''}
            </td>
            <td style="font-size:13px;">${card.phone || '‚Äî'}</td>
            <td style="font-size:12px;">${lastVisitStr}</td>
            <td>
              <div style="display:flex;align-items:center;gap:6px;">
                <div style="background:rgba(255,255,255,0.1);border-radius:4px;height:6px;width:60px;overflow:hidden;">
                  <div style="background:linear-gradient(90deg,#FFD166,#8c9668);height:100%;width:${(card.stamps / card.max) * 100}%;"></div>
                </div>
                <span style="font-size:12px;font-weight:500;">${card.stamps}/${card.max}</span>
              </div>
            </td>
            <td>
              <div style="display:flex;gap:6px;">
                <button class="btn small" data-action="stamp" style="background:#FFD166;color:#000;font-weight:600;padding:4px 10px;"><i class="fas fa-star"></i>+1</button>
                <button class="btn small ghost" data-action="view" style="padding:4px 10px;">Ver</button>
              </div>
            </td>
          </tr>
        `}).join('');

        document.getElementById('page-info').textContent =
          `P√°gina ${data.page} de ${data.totalPages} (${data.total} total)`;
        document.getElementById('btn-prev-page').disabled = data.page === 1;
        document.getElementById('btn-next-page').disabled = data.page === data.totalPages;
        currentPage = data.page;
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('cards-tbody').innerHTML =
          `<tr><td colspan="8" style="text-align:center;padding:12px;color:#fecaca;">Error: ${error.message}</td></tr>`;
      }
    }

    // Event listener for sorting
    document.getElementById('sort-cards').addEventListener('change', () => loadCards(1));

    document.getElementById('btn-prev-page').addEventListener('click', () => {
      if (currentPage > 1) loadCards(currentPage - 1);
    });

    document.getElementById('btn-next-page').addEventListener('click', () => {
      loadCards(currentPage + 1);
    });

    // ===== B√öSQUEDA INSTANT√ÅNEA CON DEBOUNCE =====
    let searchTimeout;
    const searchInput = document.getElementById('search-cards');
    const searchBtn = document.getElementById('btn-search-cards');

    // Instant search con debounce de 300ms
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        console.log('üîç B√∫squeda instant√°nea:', e.target.value);
        loadCards(1);
      }, 300);
    });

    // Mantener funcionalidad del bot√≥n de b√∫squeda
    searchBtn.addEventListener('click', () => loadCards(1));

    // Enter key tambi√©n busca
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        clearTimeout(searchTimeout); // Cancelar debounce
        loadCards(1);
      }
    });
    document.getElementById('btn-reload-cards').addEventListener('click', () => loadCards(currentPage));

    document.getElementById('cards-tbody').addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;

      const tr = btn.closest('tr[data-card-id]');
      if (!tr) return;

      const cardId = tr.dataset.cardId;
      const card = cardsCache[cardId] || { id: cardId };
      const action = btn.dataset.action;

      switch (action) {
        case 'view':
          openCardModal(card);
          break;
        case 'copy':
          await copyCardId(cardId);
          break;
        case 'open':
          openClientPage(cardId);
          break;
        case 'stamp':
          await stampCard(cardId);
          break;
        case 'redeem':
          await redeemCard(cardId);
          break;
        case 'delete':
          await deleteCard(cardId);
          break;
      }
    });

    // Event listener for clicking on card rows (not on buttons)
    document.getElementById('cards-tbody').addEventListener('click', (e) => {
      // Si se hizo clic en un bot√≥n, ignorar
      if (e.target.closest('button')) return;

      // Buscar el tr m√°s cercano
      const tr = e.target.closest('tr.card-row');
      if (!tr) return;

      const cardId = tr.dataset.cardId;
      const card = cardsCache[cardId];
      if (card) {
        openCardModal(card);
      }
    });

    /* ===== ESC√ÅNER QR (html5-qrcode) ===== */
    const scanDialog = $("#scanDialog");
    const scanStatus = $("#scan-status");
    let html5QrCode = null;

    $("#btn-scan-card").addEventListener("click", async () => {
      scanDialog.showModal();
      await startScan();
    });

    $("#scan-close").addEventListener("click", () => {
      stopScan();
      scanDialog.close();
    });

    async function startScan() {
      try {
        scanStatus.textContent = "Iniciando c√°mara...";

        // Crear instancia de html5-qrcode
        html5QrCode = new Html5Qrcode("qr-reader");

        // Iniciar escaneo
        await html5QrCode.start(
          { facingMode: "environment" }, // C√°mara trasera
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          async (decodedText, decodedResult) => {
            // ‚úÖ QR detectado exitosamente
            console.log("QR detectado:", decodedText);
            scanStatus.textContent = "‚úÖ QR detectado";

            // Detener esc√°ner
            await stopScan();

            // Procesar el QR
            await handleScan(decodedText);

            // Cerrar di√°logo
            scanDialog.close();
          },
          (errorMessage) => {
            // Ignorar errores de no detectar QR (son normales)
          }
        );

        scanStatus.textContent = "üì∑ Apunta al QR de la tarjeta...";

      } catch (err) {
        console.error("Error iniciando c√°mara:", err);
        scanStatus.textContent = "‚ùå No se pudo acceder a la c√°mara";

        // Si falla, pedir permisos expl√≠citamente
        if (err.name === 'NotAllowedError') {
          scanStatus.textContent = "‚ö†Ô∏è Por favor permite el acceso a la c√°mara";
        }
      }
    }

    async function stopScan() {
      if (html5QrCode && html5QrCode.isScanning) {
        try {
          await html5QrCode.stop();
          console.log("Esc√°ner detenido");
        } catch (err) {
          console.error("Error deteniendo esc√°ner:", err);
        }
      }
      html5QrCode = null;
    }

    function extractCardId(text) {
      try {
        const u = new URL(text);
        let c = u.searchParams.get("cardId");
        if (c) return c;
        c = u.searchParams.get("card");
        if (c) return c;
      } catch { }
      if (/^card_\d+/.test(text)) return text;
      return null;
    }

    async function handleScan(raw) {
      const cid = extractCardId(raw);
      if (!cid) {
        scanStatus.textContent = "QR inv√°lido.";
        return;
      }

      stopScan();
      scanDialog.close();

      let card = cardsCache[cid];

      if (!card) {
        try {
          const r = await fetch('/api/card/' + encodeURIComponent(cid), {
            credentials: 'include'
          });
          if (r.ok) {
            card = await r.json();
          }
        } catch (e) {
          console.error('Error buscando tarjeta por ID', e);
        }
      }

      if (!card) {
        alert('Tarjeta no encontrada');
        return;
      }

      openCardModal(card);
    }

    /* ===== GIFT CARDS MEJORADO ===== */
    window.currentGiftCard = null;

    document.getElementById('gift-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      // 1. Obtener datos
      const clientName = (document.getElementById('gift-name').value || '').trim() || 'Cliente';
      const service = (document.getElementById('gift-service').value || '').trim();

      if (!service) { alert('Ingresa un servicio'); return; }

      // 2. Calcular fechas e IDs
      const giftId = 'gift_' + Date.now();
      const expirationDate = new Date();
      expirationDate.setDate(expirationDate.getDate() + 30);
      const formattedDate = expirationDate.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });

      // 3. Actualizar la VISTA VISUAL (Nuevo dise√±o)
      document.getElementById('gift-visual-service').textContent = service;
      document.getElementById('gift-visual-client').textContent = `Para: ${clientName}`;
      document.getElementById('gift-visual-date').textContent = `V√°lida hasta: ${formattedDate}`;

      // 4. Generar QR
      const payloadText = `GIFT|codigo=${giftId}|servicio=${service}|cliente=${clientName}|vence=${expirationDate.toISOString().slice(0, 10)}`;
      const giftCanvas = document.getElementById('gift-qr');

      try {
        // Aseguramos que el canvas est√© limpio
        const ctx = giftCanvas.getContext('2d');
        ctx.clearRect(0, 0, giftCanvas.width, giftCanvas.height);

        // Usamos la librer√≠a qrcode (aseg√∫rate de haberla importado en el head)
        await QRCode.toCanvas(giftCanvas, payloadText, {
          width: 150,
          margin: 0,
          color: { dark: '#000000', light: '#ffffff' }
        });

      } catch (err) {
        console.error(err);
        alert('Error generando QR. Verifica que la librer√≠a qrcode.min.js est√© en el <head>');
        return;
      }

      // 5. Mostrar resultados
      document.getElementById('gift-preview-container').classList.remove('hidden');
      document.getElementById('gift-actions').classList.remove('hidden');
      document.getElementById('gift-success').classList.remove('hidden');

      // Guardar referencia global
      window.currentGiftCard = { id: giftId, client: clientName, service, expires: formattedDate };
    });

    // --- L√≥gica para compartir IMAGEN COMPLETA en WhatsApp ---
    document.getElementById('gift-whatsapp-image').addEventListener('click', async function () {
      if (!window.currentGiftCard) return;

      const btn = this;
      const originalText = btn.textContent;
      btn.textContent = 'Generando imagen...';

      try {
        // Seleccionamos el div con el dise√±o completo
        const elementToCapture = document.getElementById('gift-card-visual');

        // Usamos html2canvas para crear una imagen de todo el div
        const canvasFull = await html2canvas(elementToCapture, {
          scale: 2, // Mejor calidad
          backgroundColor: null // Transparencia si aplica
        });

        const imageDataURL = canvasFull.toDataURL('image/png');
        const gift = window.currentGiftCard;

        const message = `üéÅ ¬°Hola ${gift.client}!\n\n` +
          `Te env√≠o una Gift Card de Venus Cosmetolog√≠a para:\n` +
          `‚ú® *${gift.service}*\n\n` +
          `Presenta la imagen adjunta en tu pr√≥xima visita. üåø`;

        // L√≥gica de env√≠o (Web Share API o Descarga)
        if (navigator.share && navigator.canShare) {
          const blob = await (await fetch(imageDataURL)).blob();
          const file = new File([blob], 'gift-card-venus.png', { type: 'image/png' });
          try {
            await navigator.share({
              title: 'Gift Card Venus',
              text: message,
              files: [file]
            });
          } catch (err) {
            if (err.name !== 'AbortError') fallbackWhatsAppShare(message, imageDataURL);
          }
        } else {
          fallbackWhatsAppShare(message, imageDataURL);
        }
      } catch (e) {
        console.error(e);
        alert('Error al generar la imagen');
      } finally {
        btn.textContent = originalText;
      }
    });

    function fallbackWhatsAppShare(message, imageDataURL) {
      // Crea un enlace de descarga autom√°tico
      const link = document.createElement('a');
      link.download = 'gift-card-venus.png';
      link.href = imageDataURL;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      setTimeout(() => {
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message + '\n\n(Adjunta la imagen descargada)')}`;
        window.open(whatsappUrl, '_blank');
      }, 1000);
    }

    document.getElementById('gift-copy').addEventListener('click', function () {
      if (!window.currentGiftCard) return;
      const gift = window.currentGiftCard;
      const text =
        `üéÅ Gift Card Venus Cosmetolog√≠a\n\n` +
        `‚ú® Servicio: ${gift.service}\n` +
        `üë§ A nombre de: ${gift.client}\n` +
        `üìÖ Vigente hasta: ${gift.expires}\n` +
        `üîë C√≥digo: ${gift.id}\n\n` +
        `Presenta este mensaje en tu visita üíö`;

      navigator.clipboard.writeText(text).then(() => {
        const originalText = this.textContent;
        this.textContent = '‚úÖ Copiado';
        setTimeout(() => {
          this.textContent = originalText;
        }, 2000);
      }).catch(() => {
        alert('No se pudo copiar el texto');
      });
    });

    document.getElementById('gift-whatsapp').addEventListener('click', function () {
      if (!window.currentGiftCard) return;

      const gift = window.currentGiftCard;
      const message =
        `üéÅ ¬°Hola ${gift.client}!\n\n` +
        `Tienes una Gift Card de Venus Cosmetolog√≠a:\n\n` +
        `‚ú® Servicio: ${gift.service}\n` +
        `üìÖ V√°lida hasta: ${gift.expires}\n` +
        `üîë C√≥digo: ${gift.id}\n\n` +
        `Presenta este c√≥digo en tu cita üíö`;

      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    });

    /* ===== PUSH NOTIFICATIONS - CORREGIDO ===== */
    const typeEmojis = {
      'promo': 'üéÅ Promoci√≥n',
      'reminder': '‚è∞ Recordatorio',
      'update': '‚ÑπÔ∏è Actualizaci√≥n',
      'alert': '‚ö†Ô∏è Alerta'
    };

    document.getElementById('push-title').addEventListener('input', function () {
      document.getElementById('preview-title').textContent = this.value || '¬°Nueva promoci√≥n!';
    });

    document.getElementById('push-message').addEventListener('input', function () {
      document.getElementById('preview-message').textContent = this.value || 'Tu mensaje aparecer√° aqu√≠...';
    });

    document.getElementById('push-type').addEventListener('change', function () {
      document.getElementById('preview-type').textContent = typeEmojis[this.value];
    });

    document.getElementById('push-notification-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const title = document.getElementById('push-title').value;
      const message = document.getElementById('push-message').value;
      const type = document.getElementById('push-type').value;

      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Enviando...';
      submitBtn.disabled = true;

      try {
        const response = await fetch('/api/admin/push-notification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            title,
            message,
            type,
            // ‚úÖ CORREGIDO: Especificar que es alerta visible
            alertType: 'visible',
            badge: 1,
            sound: 'default'
          })
        });

        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        document.getElementById('push-count').textContent = data.passCount;
        document.getElementById('push-success').classList.remove('hidden');
        document.getElementById('push-error').classList.add('hidden');

        this.reset();
        document.getElementById('preview-title').textContent = '¬°Nueva promoci√≥n!';
        document.getElementById('preview-message').textContent = 'Tu mensaje aparecer√° aqu√≠...';

        loadNotificationsHistory();

        setTimeout(() => {
          document.getElementById('push-success').classList.add('hidden');
        }, 5000);

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('push-error').classList.remove('hidden');
        document.getElementById('push-success').classList.add('hidden');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    document.getElementById('test-push').addEventListener('click', async function () {
      const title = document.getElementById('push-title').value;
      const message = document.getElementById('push-message').value;

      if (!title || !message) {
        alert('Completa t√≠tulo y mensaje primero');
        return;
      }

      const originalText = this.textContent;
      this.textContent = 'Enviando...';
      this.disabled = true;

      try {
        const response = await fetch('/api/admin/push-test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            title,
            message,
            type: document.getElementById('push-type').value,
            // ‚úÖ CORREGIDO: Especificar que es alerta visible
            alertType: 'visible'
          })
        });

        const data = await response.json();

        if (data.success) {
          alert(`‚úÖ Prueba enviada a: ${data.cardId}`);
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      } finally {
        this.textContent = originalText;
        this.disabled = false;
      }
    });

    async function loadNotificationsHistory() {
      try {
        const response = await fetch('/api/admin/notifications', {
          credentials: 'include'
        });

        if (!response.ok) throw new Error('Error cargando historial');

        const data = await response.json();
        const tbody = document.getElementById('notifications-history');

        if (!data.notifications || data.notifications.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:12px;" class="muted">No hay notificaciones</td></tr>`;
          return;
        }

        tbody.innerHTML = data.notifications.map(n => {
          const date = new Date(n.createdAt);
          const dateStr = date.toLocaleDateString('es-ES', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
          }) + ', ' + date.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
          });

          return `
            <tr>
              <td>${dateStr}</td>
              <td>${n.title}</td>
              <td>${typeEmojis[n.type] || n.type}</td>
              <td>${n.googleSent}/${n.cardsSent}</td>
              <td>${n.errors > 0 ? `<span style="color:#fecaca">${n.errors}</span>` : '0'}</td>
            </tr>
          `;
        }).join('');

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('notifications-history').innerHTML =
          `<tr><td colspan="5" style="text-align:center;padding:12px;color:#fecaca;">Error cargando historial</td></tr>`;
      }
    }

    document.getElementById('refresh-history').addEventListener('click', loadNotificationsHistory);

    // ===== Modal Tarjeta =====
    const modalBackdrop = document.getElementById('card-modal-backdrop');
    const modalCloseBtn = document.getElementById('cm-close');
    const modalQrCanvas = document.getElementById('card-qr');

    async function openCardModal(card) {
      currentCardId = card.id;

      // Datos b√°sicos
      document.getElementById('cm-id').textContent = card.id;
      document.getElementById('cm-name').textContent = card.name || '‚Äî';
      document.getElementById('cm-phone').textContent = card.phone || '‚Äî';
      document.getElementById('cm-stamps').textContent = `${card.stamps} / ${card.max}`;

      // Barra de progreso
      const progressPercent = Math.min((card.stamps / card.max) * 100, 100);
      document.getElementById('cm-progress-bar').style.width = `${progressPercent}%`;

      // Texto de estado
      const remaining = card.max - card.stamps;
      let statusText = '';
      if (card.stamps >= card.max) {
        statusText = 'üéâ ¬°Tarjeta completa! Lista para canjear';
      } else if (remaining === 1) {
        statusText = '‚ö° ¬°Solo falta 1 sello!';
      } else if (remaining <= 3) {
        statusText = `üî• Faltan ${remaining} sellos`;
      } else {
        statusText = `Faltan ${remaining} sellos para completar`;
      }
      document.getElementById('cm-status-text').textContent = statusText;

      // Notas
      document.getElementById('cm-notes').value = card.notes || '';

      // Cargar informaci√≥n adicional del cliente
      loadClientInfo(card);

      // Cargar pr√≥xima cita
      loadNextAppointment(card.phone, card.name);

      // Mostrar modal
      modalBackdrop.classList.remove('hidden');

      // Resetear formulario de notificaci√≥n
      document.getElementById('notify-form-container').classList.add('hidden');
      document.getElementById('notify-title').value = 'Recordatorio Venus';
      document.getElementById('notify-message').value = '';

      // Generar QR
      const url = `${window.location.origin}/?cardId=${encodeURIComponent(card.id)}`;
      if (typeof QRCode !== 'undefined' && modalQrCanvas) {
        try {
          const ctx = modalQrCanvas.getContext('2d');
          ctx.clearRect(0, 0, modalQrCanvas.width, modalQrCanvas.height);
          await QRCode.toCanvas(modalQrCanvas, url, {
            width: 150,
            height: 150,
            margin: 2,
            color: { dark: '#000000', light: '#ffffff' }
          });
        } catch (err) {
          console.error('Error generando QR:', err);
        }
      }
    }

    // Funci√≥n auxiliar para cargar pr√≥xima cita
    async function loadNextAppointment(phone, name) {
      const nextApptSection = document.getElementById('cm-next-appt-section');

      try {
        const searchParam = phone || name;
        if (!searchParam) {
          nextApptSection.classList.add('hidden');
          return;
        }

        const res = await fetch(`/api/appointments/client?search=${encodeURIComponent(searchParam)}`);
        const json = await res.json();

        if (json.success && json.data) {
          // Buscar la pr√≥xima cita (status = scheduled y fecha futura)
          const now = new Date();
          const nextAppt = json.data.find(a =>
            a.status === 'scheduled' && new Date(a.startDateTime) > now
          );

          if (nextAppt) {
            const date = new Date(nextAppt.startDateTime);
            const dateStr = date.toLocaleDateString('es-MX', {
              day: 'numeric',
              month: 'short'
            });
            const timeStr = date.toLocaleTimeString('es-MX', {
              hour: '2-digit',
              minute: '2-digit'
            });

            document.getElementById('cm-next-appt-date').textContent = `${dateStr} ${timeStr}`;
            document.getElementById('cm-next-appt-service').textContent = nextAppt.serviceName;
            nextApptSection.classList.remove('hidden');
          } else {
            nextApptSection.classList.add('hidden');
          }
        } else {
          nextApptSection.classList.add('hidden');
        }
      } catch (error) {
        console.error('Error cargando pr√≥xima cita:', error);
        nextApptSection.classList.add('hidden');
      }
    }

    function closeCardModal() {
      modalBackdrop.classList.add('hidden');
      currentCardId = null;
    }

    modalCloseBtn.addEventListener('click', closeCardModal);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeCardModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modalBackdrop.classList.contains('hidden')) {
        closeCardModal();
      }
    });

    // ===== Helpers acciones tarjeta - CORREGIDOS =====
    async function copyCardId(cardId) {
      try {
        await navigator.clipboard.writeText(cardId);
        alert('‚úÖ ID copiado al portapapeles');
      } catch (e) {
        alert('No se pudo copiar el ID');
      }
    }

    function openClientPage(cardId) {
      const url = `${window.location.origin}/?cardId=${encodeURIComponent(cardId)}`;
      window.open(url, '_blank');
    }

    /* ===== PHASE 5: LOAD & SAVE CLIENT INFO ===== */
    async function loadClientInfo(card) {
      // Cargar campos editables
      document.getElementById('cm-notes').value = card.notes || '';

      // Resetear valores mientras carga
      document.getElementById('cm-visited-count').textContent = '...';
      document.getElementById('cm-cycles-completed').textContent = '...';
      document.getElementById('cm-last-visit').textContent = '...';

      try {
        // Cargar eventos de la tarjeta para calcular stats reales
        const eventsRes = await fetch(`/api/events/${card.id}`);
        const events = await eventsRes.json();

        if (Array.isArray(events)) {
          // Contar stamps (visitas)
          const stamps = events.filter(e => e.type === 'STAMP');
          const redeems = events.filter(e => e.type === 'REDEEM');

          document.getElementById('cm-visited-count').textContent = stamps.length;
          document.getElementById('cm-cycles-completed').textContent = redeems.length;

          // √öltima visita (√∫ltimo stamp)
          if (stamps.length > 0) {
            const lastStamp = stamps.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
            const lastVisitDate = new Date(lastStamp.createdAt);
            document.getElementById('cm-last-visit').textContent = lastVisitDate.toLocaleDateString('es-MX', {
              day: 'numeric', month: 'short', year: 'numeric'
            });
          } else {
            document.getElementById('cm-last-visit').textContent = '‚Äî';
          }
        }

        // Cargar pr√≥xima cita del cliente
        const phone = card.phone;
        if (phone) {
          const apptRes = await fetch(`/api/appointments/client?search=${encodeURIComponent(phone)}`);
          const apptData = await apptRes.json();

          if (apptData.success && apptData.data && apptData.data.length > 0) {
            // Buscar citas futuras (scheduled o confirmed)
            const now = new Date();
            const futureAppts = apptData.data
              .filter(a => (a.status === 'scheduled' || a.status === 'confirmed') && new Date(a.startDateTime) > now)
              .sort((a, b) => new Date(a.startDateTime) - new Date(b.startDateTime));

            // Ya se maneja en loadNextAppointment()
          }
        }

      } catch (error) {
        console.error('Error cargando info del cliente:', error);
        document.getElementById('cm-visited-count').textContent = '‚Äî';
        document.getElementById('cm-cycles-completed').textContent = '‚Äî';
        document.getElementById('cm-last-visit').textContent = '‚Äî';
      }
    }

    async function saveClientInfo() {
      if (!currentCardId) return;

      const notes = document.getElementById('cm-notes').value;

      try {
        const response = await fetch('/api/admin/update-client-info', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: currentCardId,
            notes
          })
        });

        const data = await response.json();

        if (response.ok) {
          alert('‚úÖ Informaci√≥n guardada correctamente');
          // Actualizar cache
          if (cardsCache[currentCardId]) {
            cardsCache[currentCardId].notes = notes;
          }
        } else {
          alert(`‚ùå Error: ${data.error || 'No se pudo guardar'}`);
        }
      } catch (error) {
        console.error('Error guardando informaci√≥n:', error);
        alert('‚ùå Error al guardar informaci√≥n');
      }
    }

    // Event listener para bot√≥n guardar
    document.getElementById('cm-save-notes')?.addEventListener('click', saveClientInfo);

    /* ===== STAMP CARD - CORREGIDO PARA ACTUALIZAR GOOGLE WALLET ===== */
    async function stampCard(cardId) {
      if (!confirm('¬øAgregar 1 sello a esta tarjeta?')) return;
      try {
        const r = await fetch('/api/admin/stamp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cardId })
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          throw new Error(data.error || 'No se pudo agregar sello');
        }

        // ‚úÖ CORRECCI√ìN CR√çTICA: Actualizar Google Wallet inmediatamente
        try {
          const card = cardsCache[cardId];
          if (card) {
            // Calcular nuevos stamps
            const newStamps = (card.stamps || 0) + 1;

            // Actualizar Google Wallet
            const { updateLoyaltyObject } = await import("./lib/google.js");
            await updateLoyaltyObject(cardId, card.name, newStamps, card.max);
            console.log(`[GOOGLE WALLET] ‚úÖ Stamp actualizado para: ${cardId} (${newStamps}/${card.max})`);
          }
        } catch (googleError) {
          console.error(`[GOOGLE WALLET] ‚ùå Error actualizando stamp:`, googleError.message);
        }

        await loadCards(currentPage);
        if (currentCardId === cardId) {
          const updated = cardsCache[cardId];
          if (updated) openCardModal(updated);
        }
        alert('‚úÖ Sello agregado y Google Wallet actualizado');
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    }

    async function redeemCard(cardId) {
      if (!confirm('¬øCanjear esta tarjeta? Se reiniciar√°n los sellos.')) return;
      try {
        const r = await fetch('/api/admin/redeem', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cardId })
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          throw new Error(data.error || 'No se pudo canjear');
        }

        // ‚úÖ CORRECCI√ìN: Actualizar Google Wallet despu√©s del canje
        try {
          const card = cardsCache[cardId];
          if (card) {
            const { updateLoyaltyObject } = await import("./lib/google.js");
            await updateLoyaltyObject(cardId, card.name, 0, card.max);
            console.log(`[GOOGLE WALLET] ‚úÖ Canje realizado para: ${cardId} (0/${card.max})`);
          }
        } catch (googleError) {
          console.error(`[GOOGLE WALLET] ‚ùå Error actualizando canje:`, googleError.message);
        }

        await loadCards(currentPage);
        if (currentCardId === cardId) {
          const updated = cardsCache[cardId];
          if (updated) openCardModal(updated);
        }
        alert('‚úÖ Canje realizado y Google Wallet actualizado');
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    }

    async function deleteCard(cardId) {
      if (!confirm('‚ö†Ô∏è Esto eliminar√° la tarjeta de la base de datos, eventos y Firestore. ¬øContinuar?')) return;
      try {
        const r = await fetch(`/api/admin/card/${encodeURIComponent(cardId)}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          throw new Error(data.error || 'No se pudo eliminar');
        }
        closeCardModal();
        await loadCards(currentPage);
        alert('‚úÖ Tarjeta eliminada');
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    }

    /* ===== REGISTRAR DISPOSITIVO GOOGLE (NUEVO) ===== */
    async function registerGoogleDevice(cardId) {
      try {
        let deviceId = localStorage.getItem('google_device_id');
        if (!deviceId) {
          deviceId = 'gdev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('google_device_id', deviceId);
        }

        const response = await fetch('/api/google/register-device', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            cardId: cardId,
            deviceId: deviceId
          })
        });

        const data = await response.json();

        if (data.success) {
          console.log('‚úÖ Dispositivo Google registrado:', deviceId);
          return true;
        } else {
          console.error('‚ùå Error registrando dispositivo Google:', data.error);
          return false;
        }
      } catch (error) {
        console.error('‚ùå Error registrando dispositivo Google:', error);
        return false;
      }
    }

    // Toggle del formulario de notificaci√≥n
    document.getElementById('cm-notify').addEventListener('click', () => {
      const form = document.getElementById('notify-form-container');
      form.classList.toggle('hidden');
      if (!form.classList.contains('hidden')) {
        document.getElementById('notify-message').focus();
      }
    });

    // Cancelar notificaci√≥n
    document.getElementById('btn-cancel-notify').addEventListener('click', () => {
      document.getElementById('notify-form-container').classList.add('hidden');
    });

    // Enviar notificaci√≥n individual
    document.getElementById('btn-send-notify').addEventListener('click', async function () {
      if (!currentCardId) return;

      const title = document.getElementById('notify-title').value;
      const message = document.getElementById('notify-message').value;

      if (!title || !message) {
        alert('Por favor completa el t√≠tulo y el mensaje');
        return;
      }

      const btn = this;
      const originalText = btn.textContent;
      btn.textContent = 'Enviando...';
      btn.disabled = true;

      try {
        const r = await fetch('/api/admin/push-one', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: currentCardId,
            title,
            message,
            type: 'personal',
            alertType: 'visible'
          })
        });
        const data = await r.json();

        if (!r.ok || !data.success) {
          throw new Error(data.error || 'No se pudo enviar la notificaci√≥n');
        }

        alert('‚úÖ Notificaci√≥n enviada exitosamente');
        document.getElementById('notify-form-container').classList.add('hidden');
        document.getElementById('notify-message').value = ''; // Limpiar mensaje

      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    });

    // ‚úÖ NUEVO: Bot√≥n para registrar dispositivo Google desde el modal
    document.getElementById('cm-register-google')?.addEventListener('click', async () => {
      if (currentCardId) {
        const success = await registerGoogleDevice(currentCardId);
        if (success) {
          alert('‚úÖ Dispositivo Google registrado exitosamente');
        } else {
          alert('‚ùå Error registrando dispositivo Google');
        }
      }
    });

    // Acciones desde el modal - con verificaci√≥n de existencia
    const btnStamp = document.getElementById('cm-stamp');
    const btnRedeem = document.getElementById('cm-redeem');
    const btnCopy = document.getElementById('cm-copy');
    const btnOpenUrl = document.getElementById('cm-open-url');
    const btnDelete = document.getElementById('cm-delete');
    const btnWhatsApp = document.getElementById('cm-whatsapp');
    const btnSchedule = document.getElementById('cm-schedule');

    if (btnStamp) {
      btnStamp.addEventListener('click', async () => {
        if (currentCardId) await stampCard(currentCardId);
      });
    }

    if (btnRedeem) {
      btnRedeem.addEventListener('click', async () => {
        if (currentCardId) await redeemCard(currentCardId);
      });
    }

    if (btnCopy) {
      btnCopy.addEventListener('click', async () => {
        if (currentCardId) await copyCardId(currentCardId);
      });
    }

    if (btnOpenUrl) {
      btnOpenUrl.addEventListener('click', () => {
        if (currentCardId) openClientPage(currentCardId);
      });
    }

    if (btnDelete) {
      btnDelete.addEventListener('click', async () => {
        if (currentCardId) await deleteCard(currentCardId);
      });
    }

    // ===== Bot√≥n Agendar =====
    if (btnSchedule) {
      btnSchedule.addEventListener('click', () => {
        if (!currentCardId) return;

        const client = cardsCache[currentCardId];
        if (!client) return;

        // Primero cambiar a la pesta√±a de Agenda
        const agendaTab = document.querySelector('[data-tab="appointments"]');
        if (agendaTab) {
          agendaTab.click();
        }

        // Esperar un momento para que la pesta√±a se active
        setTimeout(() => {
          // Abrir el modal de nueva cita
          const newApptDialog = document.getElementById('newApptDialog');
          const clientSelectInput = document.getElementById('new-appt-client-select');
          const phoneInput = document.getElementById('new-appt-phone');
          const dateInput = document.getElementById('new-appt-date');

          if (newApptDialog && clientSelectInput && phoneInput) {
            // Cargar datos necesarios
            loadServices();
            loadClients();
            generateHourMinuteOptions();

            // Prellenar nombre y tel√©fono
            clientSelectInput.value = client.name || '';
            phoneInput.value = client.phone || '';

            // Prellenar fecha con hoy si est√° vac√≠a
            if (dateInput && !dateInput.value) {
              const today = new Date();
              const year = today.getFullYear();
              const month = String(today.getMonth() + 1).padStart(2, '0');
              const day = String(today.getDate()).padStart(2, '0');
              dateInput.value = `${year}-${month}-${day}`;
            }

            // Deshabilitar campos de nombre y tel√©fono (est√°n bloqueados)
            clientSelectInput.disabled = true;
            phoneInput.disabled = true;

            // Mostrar el modal
            newApptDialog.showModal();

            // Cerrar el modal del cliente
            closeCardModal();
          }
        }, 100);
      });
    }

    // ===== Bot√≥n WhatsApp =====
    if (btnWhatsApp) {
      btnWhatsApp.addEventListener('click', () => {
        if (!currentCardId) return;

        const phone = cardsCache[currentCardId]?.phone;
        const name = cardsCache[currentCardId]?.name || 'Cliente';

        if (!phone) {
          alert('‚ö†Ô∏è Este cliente no tiene tel√©fono registrado');
          return;
        }

        // Limpiar el n√∫mero (remover espacios, guiones, etc.)
        const cleanPhone = phone.replace(/\D/g, '');

        // Mensaje predeterminado
        const message = encodeURIComponent(`Hola ${name}, te contacto de Venus Cosmetolog√≠a`);

        // Abrir WhatsApp
        window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
      });
    }

    /* ===== DEBUGGING AVANZADO (NUEVO) ===== */

    // Test Apple Push
    document.getElementById('btn-test-apple-push')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta para prueba:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = 'üß™ Enviando prueba Apple Push...';

      try {
        const response = await fetch('/api/debug/test-apple-push', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: cardId,
            title: "üî• PRUEBA APPLE PUSH",
            message: "Si ves esto, las notificaciones Apple funcionan correctamente!"
          })
        });

        const data = await response.json();
        output.innerHTML = `‚úÖ Resultado Apple Push:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `‚ùå Error Apple Push:<br>${error.message}`;
      }
    });

    // Test Google Push
    document.getElementById('btn-test-google-push')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta para prueba:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = 'üß™ Enviando prueba Google Push...';

      try {
        const response = await fetch('/api/debug/test-google-push', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: cardId,
            title: "üî• PRUEBA GOOGLE PUSH",
            message: "Esto debe aparecer en Google Wallet"
          })
        });

        const data = await response.json();
        output.innerHTML = `‚úÖ Resultado Google Push:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `‚ùå Error Google Push:<br>${error.message}`;
      }
    });

    // Reparar Google Wallet
    document.getElementById('btn-fix-google-wallet')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta a reparar:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = 'üîß Reparando objeto Google Wallet...';

      try {
        const response = await fetch(`/api/debug/fix-google-wallet/${cardId}`, {
          method: 'POST',
          credentials: 'include'
        });

        const data = await response.json();
        output.innerHTML = `‚úÖ Google Wallet reparado:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `‚ùå Error reparando Google Wallet:<br>${error.message}`;
      }
    });

    /* ===== BIRTHDAY LOGIC (Cards Tab) ===== */
    function checkBirthdays(cards) {
      const today = new Date();
      const currentMonth = today.getMonth(); // 0-11
      const currentDay = today.getDate();

      const upcomingBirthdays = cards.filter(card => {
        if (!card.birthdate) return false;
        // Parse YYYY-MM-DD manually to avoid timezone issues
        const [y, m, d] = card.birthdate.split('-').map(Number);
        const bMonth = m - 1; // 0-11
        const bDay = d;

        // Check if birthday is in the next 7 days
        if (bMonth === currentMonth) {
          return bDay >= currentDay && bDay <= currentDay + 7;
        }
        // Handle month wrapping
        const nextMonthDate = new Date(today);
        nextMonthDate.setDate(today.getDate() + 7);
        if (nextMonthDate.getMonth() !== currentMonth && bMonth === nextMonthDate.getMonth()) {
          return bDay <= nextMonthDate.getDate();
        }
        return false;
      });

      const section = document.getElementById('birthday-section');
      const list = document.getElementById('birthday-list');
      const actions = document.getElementById('birthday-actions');

      if (upcomingBirthdays.length === 0) {
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');
      list.innerHTML = upcomingBirthdays.map(c => {
        const [y, m, d] = c.birthdate.split('-').map(Number);

        // Calculate days until (handling year wrap if needed, though simpler here)
        const now = new Date(); now.setHours(0, 0, 0, 0);
        const nextBday = new Date(today.getFullYear(), m - 1, d);
        if (nextBday < now) nextBday.setFullYear(now.getFullYear() + 1);

        const diffTime = nextBday - now;
        const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        let actionBtn = '';
        if (daysUntil <= 2 && daysUntil >= 0) {
          actionBtn = `<button onclick="sendBirthdayPush('${c.id}', '${c.name}')" class="btn small primary" style="font-size:10px; padding: 2px 6px;"><i class="fas fa-gift" style="width:12px;height:12px;"></i> Felicitar</button>`;
        }

        const monthNames = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];

        return `
          <div style="background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 16px;">üéâ</span>
            <div>
              <div style="font-weight: 600; font-size: 13px;">${c.name || 'Cliente'}</div>
              <div class="muted" style="font-size: 11px;">${d} de ${monthNames[m - 1]}</div>
            </div>
            ${actionBtn}
          </div>
        `;
      }).join('');

      actions.innerHTML = `<span class="tag" style="background:#ffd166; color:#000;">${upcomingBirthdays.length} pendientes</span>`;
    }

    /* ===== BIRTHDAY LOGIC (Overview Tab) ===== */
    function checkOverviewBirthdays(cards) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Calculate 30 days ago and 30 days ahead
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);

      const thirtyDaysAhead = new Date(today);
      thirtyDaysAhead.setDate(today.getDate() + 30);

      // Filter birthdays
      const allBirthdays = cards.filter(card => {
        if (!card.birthdate) return false;
        const [y, m, d] = card.birthdate.split('-').map(Number);
        const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

        // Include birthdays from 30 days ago to 30 days ahead
        return birthdayThisYear >= thirtyDaysAgo && birthdayThisYear <= thirtyDaysAhead;
      });

      const section = document.getElementById('overview-birthday-section');
      const upcomingContainer = document.getElementById('upcoming-birthdays-container');
      const pastContainer = document.getElementById('past-birthdays-container');
      const upcomingList = document.getElementById('upcoming-birthday-list');
      const pastList = document.getElementById('past-birthday-list');

      if (allBirthdays.length === 0) {
        section.classList.add('hidden');
        return;
      }

      // Separate into past and upcoming
      const pastBirthdays = [];
      const upcomingBirthdays = [];

      allBirthdays.forEach(card => {
        const [y, m, d] = card.birthdate.split('-').map(Number);
        const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

        if (birthdayThisYear < today) {
          pastBirthdays.push(card);
        } else {
          upcomingBirthdays.push(card);
        }
      });

      section.classList.remove('hidden');

      const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

      // Render upcoming birthdays (sorted by date, closest first)
      if (upcomingBirthdays.length > 0) {
        upcomingContainer.classList.remove('hidden');
        upcomingBirthdays.sort((a, b) => {
          const [ya, ma, da] = a.birthdate.split('-').map(Number);
          const [yb, mb, db] = b.birthdate.split('-').map(Number);
          const dateA = new Date(today.getFullYear(), ma - 1, da);
          const dateB = new Date(today.getFullYear(), mb - 1, db);
          return dateA - dateB; // Soonest first
        });

        upcomingList.innerHTML = upcomingBirthdays.map(c => {
          const [y, m, d] = c.birthdate.split('-').map(Number);
          const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

          const diffTime = birthdayThisYear - today;
          const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          let actionBtn = '';
          let daysLabel = '';

          if (daysUntil === 0) {
            daysLabel = '<span style="color: #ffd166; font-weight: 600;"><i class="fas fa-party-horn"></i> Hoy</span>';
            actionBtn = `<button onclick="sendBirthdayPush('${c.id}', '${c.name}')" class="btn small primary" style="font-size:10px; padding: 2px 6px;"><i class="fas fa-gift" style="width:12px;height:12px;"></i> Felicitar</button>`;
          } else {
            daysLabel = `<span style="color: #a7f3d0;">en ${daysUntil} d√≠a${daysUntil > 1 ? 's' : ''}</span>`;
          }

          return `
            <div style="background: rgba(167, 243, 208, 0.1); border: 1px solid rgba(167, 243, 208, 0.2); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 16px;">üéà</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 13px;">${c.name || 'Cliente'}</div>
                <div class="muted" style="font-size: 11px;">${d} de ${monthNames[m - 1].toLowerCase()} ‚Ä¢ ${daysLabel}</div>
              </div>
              ${actionBtn}
            </div>
          `;
        }).join('');
      } else {
        upcomingContainer.classList.add('hidden');
      }

      // Render past birthdays (sorted by date, most recent first)
      if (pastBirthdays.length > 0) {
        pastContainer.classList.remove('hidden');
        pastBirthdays.sort((a, b) => {
          const [ya, ma, da] = a.birthdate.split('-').map(Number);
          const [yb, mb, db] = b.birthdate.split('-').map(Number);
          const dateA = new Date(today.getFullYear(), ma - 1, da);
          const dateB = new Date(today.getFullYear(), mb - 1, db);
          return dateB - dateA; // Most recent first
        });

        pastList.innerHTML = pastBirthdays.map(c => {
          const [y, m, d] = c.birthdate.split('-').map(Number);
          const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

          const diffTime = today - birthdayThisYear;
          const daysAgo = Math.floor(diffTime / (1000 * 60 * 60 * 24));

          const daysLabel = `<span style="color: #cbd5e1;">hace ${daysAgo} d√≠a${daysAgo > 1 ? 's' : ''}</span>`;

          return `
            <div style="background: rgba(203, 213, 225, 0.1); border: 1px solid rgba(203, 213, 225, 0.2); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 16px;">üéÇ</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 13px;">${c.name || 'Cliente'}</div>
                <div class="muted" style="font-size: 11px;">${d} de ${monthNames[m - 1].toLowerCase()} ‚Ä¢ ${daysLabel}</div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        pastContainer.classList.add('hidden');
      }
    }

    window.sendBirthdayPush = async function (cardId, name) {
      if (!confirm(`¬øEnviar felicitaci√≥n de cumplea√±os a ${name}?`)) return;

      try {
        const r = await fetch('/api/admin/push-one', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: cardId,
            title: "üéÇ ¬°Feliz Cumplea√±os!",
            message: `¬°Hola ${name}! En Venus queremos celebrarte. Ven por un regalo especial en tu pr√≥xima visita. üéâ`,
            type: 'promo',
            alertType: 'visible'
          })
        });
        const data = await r.json();
        if (!r.ok || !data.success) {
          throw new Error(data.error || 'No se pudo enviar');
        }
        alert('‚úÖ Felicitaci√≥n enviada exitosamente');
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    };

    // Ver dispositivos
    document.getElementById('btn-check-devices')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta para ver dispositivos:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = 'üì± Cargando informaci√≥n de dispositivos...';

      try {
        // Dispositivos Apple
        const appleResponse = await fetch(`/api/debug/apple-devices?cardId=${cardId}`, {
          credentials: 'include'
        });
        const appleData = await appleResponse.json();

        // Dispositivos Google
        const googleResponse = await fetch(`/api/debug/google-devices/${cardId}`, {
          credentials: 'include'
        });
        const googleData = await googleResponse.json();

        output.innerHTML = `
          <strong>üì± Dispositivos para ${cardId}:</strong><br><br>
          <strong>üçé Apple:</strong> ${appleData.devices?.length || 0} dispositivos<br>
          <strong>üü¢ Google:</strong> ${googleData.deviceCount || 0} dispositivos<br><br>
          <strong>Detalles Apple:</strong><br>${JSON.stringify(appleData.devices || [], null, 2)}<br><br>
          <strong>Detalles Google:</strong><br>${JSON.stringify(googleData.devices || [], null, 2)}
        `;
      } catch (error) {
        output.innerHTML = `‚ùå Error cargando dispositivos:<br>${error.message}`;
      }
    });

    // Ver configuraci√≥n APNs
    document.getElementById('btn-check-apns')?.addEventListener('click', async function () {
      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = 'üçé Verificando configuraci√≥n APNs...';

      try {
        const response = await fetch('/api/debug/apple-apns', {
          credentials: 'include'
        });

        const data = await response.json();
        output.innerHTML = `‚úÖ Configuraci√≥n APNs:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `‚ùå Error verificando APNs:<br>${error.message}`;
      }
    });

    // Logout
    document.getElementById('logout').addEventListener('click', async () => {
      try {
        await fetch('/api/logout', { method: 'POST', credentials: 'include' });
        window.location.href = '/admin-login.html';
      } catch (error) {
        console.error('Error al cerrar sesi√≥n:', error);
        window.location.href = '/admin-login.html';
      }
    });

    /* =========================================================
       L√ìGICA DEL BOT√ìN "ENVIAR A TODOS"
       ========================================================= */



    // Prevent form submission from interfering with buttons
    const pushForm = document.getElementById('push-notification-form');
    if (pushForm) {
      pushForm.addEventListener('submit', (e) => {
        e.preventDefault();
        console.log('Form submission prevented');
      });
    }

    const btnGlobal = document.getElementById('btn-mass-push');
    console.log('üîç Buscando bot√≥n btn-mass-push:', btnGlobal);

    if (btnGlobal) {
      console.log('‚úÖ Bot√≥n encontrado, agregando event listener');

      btnGlobal.addEventListener('click', async (e) => {
        e.preventDefault(); // Prevent any form submission
        e.stopPropagation(); // Stop event bubbling

        console.log('üöÄ Bot√≥n "Enviar a todos" clickeado');

        const title = document.getElementById('push-title').value.trim();
        const message = document.getElementById('push-message').value.trim();

        console.log('üìù T√≠tulo:', title);
        console.log('üìù Mensaje:', message);

        if (!title || !message) {
          console.warn('‚ö†Ô∏è Faltan datos');
          return alert("‚ö†Ô∏è Faltan datos: Escribe t√≠tulo y mensaje.");
        }

        if (!confirm(`üö® ¬øENVIAR A TODOS?\n\n"${title}"`)) {
          console.log('‚ùå Usuario cancel√≥');
          return;
        }

        const originalText = btnGlobal.textContent;
        btnGlobal.innerHTML = `<span style="display: inline-flex; align-items: center; gap: 6px;"><span class="spinner"></span> Enviando...</span>`;
        btnGlobal.disabled = true;

        console.log('üì° Enviando petici√≥n a /api/admin/push-all...');

        try {
          const r = await fetch('/api/admin/push-all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ title, message })
          });

          console.log('üì• Respuesta recibida:', r.status);
          const data = await r.json();
          console.log('üì¶ Data:', data);

          if (data.success) {
            const apple = data.results?.apple || 0;
            const google = data.results?.google || 0;
            console.log('‚úÖ √âxito! Apple:', apple, 'Google:', google);
            alert(`‚úÖ ¬°ENVIADO!\n\nüçè Apple: ${apple}\nü§ñ Google: ${google}`);
            // Limpiar campos
            document.getElementById('push-title').value = "";
            document.getElementById('push-message').value = "";
          } else {
            console.error('‚ùå Error en respuesta:', data.error);
            alert('‚ö†Ô∏è Error: ' + (data.error || "Desconocido"));
          }
        } catch (e) {
          console.error('üí• Error de conexi√≥n:', e);
          alert('‚ùå Error de conexi√≥n: ' + e.message);
        } finally {
          btnGlobal.textContent = originalText;
          btnGlobal.disabled = false;
          console.log('üèÅ Proceso terminado');
        }
      });
    } else {
      console.error('‚ùå Bot√≥n btn-mass-push NO encontrado en el DOM');
    }
    // Este archivo contiene el JavaScript completo para el m√≥dulo de citas
    // Se insertar√° en admin.html reemplazando la secci√≥n actual

    /* =========================================================
       L√ìGICA DE CITAS - VERSI√ìN COMPLETA
       ========================================================= */

    // Variables globales
    let allServices = [];
    let allClients = [];
    let currentWeekStart = new Date();
    let selectedDate = new Date();

    // Elementos del DOM
    const btnNewAppt = document.getElementById('btn-new-appointment');
    const newApptDialog = document.getElementById('newApptDialog');
    const formNewAppt = document.getElementById('form-new-appt');
    const btnCancelAppt = document.getElementById('btn-cancel-appt');
    const apptsTbody = document.getElementById('appts-tbody');
    const serviceSelect = document.getElementById('new-appt-service');
    const clientSelect = document.getElementById('new-appt-client-select');
    const phoneInput = document.getElementById('new-appt-phone');
    const hourSelect = document.getElementById('new-appt-hour');
    const minuteSelect = document.getElementById('new-appt-minute');
    const priceInput = document.getElementById('new-appt-price');
    const endTimeInput = document.getElementById('new-appt-end-time');
    const btnRefreshAppts = document.getElementById('btn-refresh-appts');

    // Navegaci√≥n semanal
    const btnPrevWeek = document.getElementById('btn-prev-week');
    const btnNextWeek = document.getElementById('btn-next-week');
    const btnToday = document.getElementById('btn-today');
    const weeklyCalendar = document.getElementById('weekly-calendar');
    const selectedDateLabel = document.getElementById('selected-date-label');

    // Nuevo cliente
    const btnToggleNewClient = document.getElementById('btn-toggle-new-client');
    const newClientForm = document.getElementById('new-client-form');
    const btnSaveNewClient = document.getElementById('btn-save-new-client');


    // ========== GENERAR OPCIONES DE HORA Y MINUTOS ==========
    function generateHourMinuteOptions() {
      const hourSelect = document.getElementById('new-appt-hour');
      const minuteSelect = document.getElementById('new-appt-minute');

      if (!hourSelect || !minuteSelect) return;

      // Generar horas (8 AM - 8 PM)
      hourSelect.innerHTML = '<option value="">--</option>';
      for (let hour = 8; hour <= 20; hour++) {
        const option = document.createElement('option');
        option.value = String(hour).padStart(2, '0');
        const displayHour = hour > 12 ? hour - 12 : hour;
        const period = hour >= 12 ? 'PM' : 'AM';
        option.textContent = `${displayHour} ${period}`;
        hourSelect.appendChild(option);
      }

      // Generar minutos (00, 15, 30, 45)
      minuteSelect.innerHTML = '<option value="">--</option>';
      [0, 15, 30, 45].forEach(min => {
        const option = document.createElement('option');
        option.value = String(min).padStart(2, '0');
        option.textContent = String(min).padStart(2, '0');
        minuteSelect.appendChild(option);
      });
    }

    // ========== CARGAR SERVICIOS ==========
    async function loadServices() {
      try {
        const res = await fetch('/api/services');
        const json = await res.json();
        if (json.success) {
          allServices = json.data;

          // Map services to dropdown options format
          const options = allServices.map(s => ({
            value: s.name,
            label: s.name,
            meta: `${s.durationMinutes} min - $${s.price}`,
            data: { id: s.id, price: s.price, duration: s.durationMinutes }
          }));

          // Initialize dropdowns if not already done
          if (!newApptServiceDropdown) {
            newApptServiceDropdown = new CustomSearchableDropdown(
              'new-appt-service',
              'services-dropdown-list',
              (item) => {
                // Auto-fill price when service selected
                document.getElementById('new-appt-price').value = item.data.price;
              }
            );
          }
          newApptServiceDropdown.setOptions(options);

          if (!editApptServiceDropdown) {
            editApptServiceDropdown = new CustomSearchableDropdown(
              'edit-appt-service',
              'edit-services-dropdown-list',
              (item) => {
                // Auto-fill price and duration when service selected
                document.getElementById('edit-appt-price').value = item.data.price;
                document.getElementById('edit-appt-duration').value = item.data.duration;
                calculateEditEndTime();
              }
            );
          }
          editApptServiceDropdown.setOptions(options);
        }
      } catch (e) { console.error('Error loading services', e); }
    }

    /* =========================================================
       HISTORIAL DE CITAS - SELECCIONAR PARA REPETIR SERVICIO
       ========================================================= */

    const historyPanel = document.getElementById('client-history-panel');
    const historyHeader = document.getElementById('toggle-history');
    const historyContent = document.getElementById('history-content');
    const historyList = document.getElementById('history-list');
    const historyCount = document.getElementById('history-count');
    const historyHint = document.getElementById('history-hint');

    // Toggle expandir/contraer historial
    if (historyHeader) {
      historyHeader.addEventListener('click', () => {
        const isExpanded = historyContent.style.display !== 'none';
        historyContent.style.display = isExpanded ? 'none' : 'block';
        historyHeader.classList.toggle('expanded', !isExpanded);
      });
    }

    // Cargar historial de citas del cliente
    async function loadClientHistory(clientPhone, clientName) {
      if (!clientPhone && !clientName) {
        historyPanel.classList.add('hidden');
        return;
      }

      try {
        const searchParam = clientPhone || clientName;
        const res = await fetch(`/api/appointments/client?search=${encodeURIComponent(searchParam)}`);
        const json = await res.json();

        if (json.success && json.data && json.data.length > 0) {
          const appointments = json.data;
          historyPanel.classList.remove('hidden');
          historyCount.textContent = `(${appointments.length})`;
          historyHint.textContent = 'Clic para repetir servicio';
          renderHistoryList(appointments);

          if (appointments.length <= 5) {
            historyContent.style.display = 'block';
            historyHeader.classList.add('expanded');
          }
        } else {
          historyPanel.classList.remove('hidden');
          historyCount.textContent = '(0)';
          historyHint.textContent = '¬°Primera visita!';
          historyList.innerHTML = '<div class="history-empty">üéâ Nueva clienta</div>';
          historyContent.style.display = 'block';
          historyHeader.classList.add('expanded');
        }
      } catch (error) {
        console.error('Error cargando historial:', error);
        historyPanel.classList.add('hidden');
      }
    }

    function renderHistoryList(appointments) {
      if (appointments.length === 0) {
        historyList.innerHTML = '<div class="history-empty">Sin citas previas</div>';
        return;
      }

      // Ordenar por fecha m√°s reciente y tomar las √∫ltimas 8
      appointments.sort((a, b) => new Date(b.startDateTime) - new Date(a.startDateTime));
      const recentAppts = appointments.slice(0, 8);

      const statusLabels = {
        'completed': '‚úÖ',
        'scheduled': 'üìÖ',
        'confirmed': '‚úîÔ∏è',
        'cancelled': '‚ùå'
      };

      historyList.innerHTML = recentAppts.map(appt => {
        const date = new Date(appt.startDateTime);
        const dateStr = date.toLocaleDateString('es-MX', {
          day: 'numeric',
          month: 'short',
          year: date.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
        });
        const statusIcon = statusLabels[appt.status] || 'üìã';

        return `
          <div class="history-item" 
               data-service-name="${appt.serviceName}"
               data-service-id="${appt.serviceId || ''}" 
               onclick="selectHistoryService(this)">
            <div class="history-item-info">
              <span class="history-item-date">${statusIcon} ${dateStr}</span>
              <span class="history-item-service">${appt.serviceName}</span>
            </div>
            <span class="history-item-select">Seleccionar ‚Üí</span>
          </div>
        `;
      }).join('');
    }

    function selectHistoryService(element) {
      const serviceName = element.dataset.serviceName;
      const serviceId = element.dataset.serviceId;
      const service = allServices.find(s => s.name === serviceName || s.id === serviceId);

      const serviceInput = document.getElementById('new-appt-service');
      if (serviceInput) {
        serviceInput.value = serviceName;
        serviceInput.dispatchEvent(new Event('input', { bubbles: true }));
        serviceInput.dispatchEvent(new Event('change', { bubbles: true }));
      }

      const priceInput = document.getElementById('new-appt-price');
      if (priceInput && service) {
        priceInput.value = service.price;
      }

      document.querySelectorAll('.history-item').forEach(item => item.classList.remove('selected'));
      element.classList.add('selected');

      calculateEndTime();
    }

    window.selectHistoryService = selectHistoryService;

    // ========== CARGAR CLIENTES ==========
    async function loadClients() {
      try {
        console.log('[CLIENTS] üîç Cargando clientes...');
        const res = await fetch('/api/admin/cards?limit=1000');
        const data = await res.json();

        console.log('[CLIENTS] üì¶ Respuesta:', data);

        // La respuesta viene directa como objeto de paginaci√≥n, no tiene success: true
        if (data.items && Array.isArray(data.items)) {
          // Map clients to dropdown options format
          const options = data.items.map(c => ({
            value: c.name,
            label: c.name,
            meta: c.phone || 'Sin tel√©fono',
            data: { id: c.id, phone: c.phone }
          }));

          console.log('[CLIENTS] üìã Opciones mapeadas:', options.length);

          // Verificar que los elementos existen
          const inputEl = document.getElementById('new-appt-client-select');
          const dropdownEl = document.getElementById('clients-dropdown-list');

          console.log('[CLIENTS] üîç Input existe:', !!inputEl);
          console.log('[CLIENTS] üîç Dropdown existe:', !!dropdownEl);

          if (!inputEl || !dropdownEl) {
            console.error('[CLIENTS] ‚ùå Elementos no encontrados en el DOM');
            return;
          }

          if (!newApptClientDropdown) {
            console.log('[CLIENTS] üÜï Creando nuevo dropdown...');
            newApptClientDropdown = new CustomSearchableDropdown(
              'new-appt-client-select',
              'clients-dropdown-list',
              (item) => {
                console.log('[CLIENTS] ‚úÖ Cliente seleccionado:', item);
                // Auto-fill phone when client selected
                document.getElementById('new-appt-phone').value = item.data.phone || '';

                // Cargar historial de citas del cliente
                loadClientHistory(item.data.phone, item.label);
              }
            );
          }

          if (newApptClientDropdown) {
            newApptClientDropdown.setOptions(options);
            console.log('[CLIENTS] ‚úÖ Opciones configuradas');
          } else {
            console.error('[CLIENTS] ‚ùå Dropdown no se pudo crear');
          }
        }
      } catch (e) {
        console.error('[CLIENTS] ‚ùå Error loading clients:', e);
      }
    }

    // ========== CALENDARIO SEMANAL ==========
    function renderWeeklyCalendar() {
      if (!weeklyCalendar) return;

      weeklyCalendar.innerHTML = '';
      const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Ajustar al inicio de la semana (domingo)
      const weekStart = new Date(currentWeekStart);
      weekStart.setDate(weekStart.getDate() - weekStart.getDay());

      for (let i = 0; i < 7; i++) {
        const day = new Date(weekStart);
        day.setDate(day.getDate() + i);

        const isToday = day.getTime() === today.getTime();
        const isSelected = day.getTime() === selectedDate.getTime();

        const dayCard = document.createElement('div');
        dayCard.className = 'day-card';
        if (isToday) dayCard.classList.add('today');
        if (isSelected) dayCard.classList.add('selected');

        dayCard.innerHTML = `
      <div class="day-name">${days[i]}</div>
      <div class="day-number">${day.getDate()}</div>
      <div class="day-count" id="day-count-${day.toISOString().split('T')[0]}">-</div>
    `;

        dayCard.addEventListener('click', () => {
          selectedDate = new Date(day);
          renderWeeklyCalendar();
          loadAppointments();
          updateSelectedDateLabel();
        });

        weeklyCalendar.appendChild(dayCard);
      }

      // Cargar conteo de citas para cada d√≠a
      loadWeekAppointmentCounts(weekStart);
    }

    async function loadWeekAppointmentCounts(weekStart) {
      for (let i = 0; i < 7; i++) {
        const day = new Date(weekStart);
        day.setDate(day.getDate() + i);
        const dateStr = day.toISOString().split('T')[0];

        try {
          const res = await fetch(`/api/appointments?date=${dateStr}`);
          const json = await res.json();
          const countEl = document.getElementById(`day-count-${dateStr}`);
          if (countEl && json.success) {
            const count = json.data.length;
            countEl.textContent = count > 0 ? `${count} cita${count > 1 ? 's' : ''}` : 'Sin citas';
          }
        } catch (e) {
          console.error('Error loading day count', e);
        }
      }
    }

    function updateSelectedDateLabel() {
      if (!selectedDateLabel) return;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const selected = new Date(selectedDate);
      selected.setHours(0, 0, 0, 0);

      if (selected.getTime() === today.getTime()) {
        selectedDateLabel.textContent = 'Hoy';
      } else {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        selectedDateLabel.textContent = selected.toLocaleDateString('es-MX', options);
      }
    }

    // ========== CARGAR CITAS ==========
    async function loadAppointments() {
      if (!apptsTbody) return;
      apptsTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;">Cargando...</td></tr>';

      const dateStr = selectedDate.toISOString().split('T')[0];
      try {
        const res = await fetch(`/api/appointments?date=${dateStr}`);
        const json = await res.json();

        if (json.success) {
          if (json.data.length === 0) {
            apptsTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;" class="muted">No hay citas para este d√≠a</td></tr>';
            return;
          }

          apptsTbody.innerHTML = json.data.map(appt => {
            const time = new Date(appt.startDateTime).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', hour12: false });
            const statusColors = {
              'scheduled': 'var(--venus-green)',
              'cancelled': 'var(--err-text)',
              'completed': 'var(--ok-text)'
            };
            const statusLabels = {
              'scheduled': 'Agendada',
              'cancelled': 'Cancelada',
              'completed': 'Completada'
            };

            return `
          <tr>
            <td style="font-weight:bold;color:#fff;">${time}</td>
            <td>
              <div>${appt.clientName}</div>
              <div class="muted" style="font-size:11px;">${appt.clientPhone}</div>
            </td>
            <td>${appt.serviceName}</td>
            <td><span class="tag" style="background:rgba(255,255,255,0.1);color:${statusColors[appt.status] || '#fff'}">${statusLabels[appt.status] || appt.status}</span></td>
            <td>
          ${appt.status === 'scheduled' ? `
            <button class="btn small" onclick="openPaymentDialog('${appt.id}')"
              style="background:#22c55e;color:white;margin-right:5px;">
              üíµ Pagar
            </button>
            <button class="btn small" onclick="editAppointment('${appt.id}')" style="margin-right:5px;">Modificar</button>
            <button class="btn small ghost" onclick="cancelAppointment('${appt.id}')">Cancelar</button>
          ` : ''}
        </td>
          </tr>
        `;
          }).join('');
        }
      } catch (e) {
        console.error(e);
        apptsTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--err-text);">Error cargando citas</td></tr>';
      }
    }

    // ========== ESTAD√çSTICAS DEL MES ==========
    async function loadMonthStats() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      try {
        // Obtener todas las citas del mes
        const res = await fetch('/api/appointments/month?' + new URLSearchParams({
          year: year.toString(),
          month: (month + 1).toString()
        }));

        if (!res.ok) {
          throw new Error('Error cargando estad√≠sticas');
        }

        const json = await res.json();

        if (json.success && json.data) {
          const appointments = json.data;
          const total = appointments.length;
          const completed = appointments.filter(a => a.status === 'completed').length;
          const cancelled = appointments.filter(a => a.status === 'cancelled').length;
          const pending = appointments.filter(a => a.status === 'scheduled').length;

          document.getElementById('stat-total').textContent = total;
          document.getElementById('stat-completed').textContent = completed;
          document.getElementById('stat-cancelled').textContent = cancelled;
          document.getElementById('stat-pending').textContent = pending;
        } else {
          document.getElementById('stat-total').textContent = '0';
          document.getElementById('stat-completed').textContent = '0';
          document.getElementById('stat-cancelled').textContent = '0';
          document.getElementById('stat-pending').textContent = '0';
        }

        // Calculate revenue by payment method
        let cashTotal = 0;
        let cardTotal = 0;
        let transferTotal = 0;

        if (json.success && json.data) {
          json.data.forEach(appt => {
            if (appt.payment && appt.status === 'completed') {
              const amount = appt.payment.amount || 0;
              switch (appt.payment.method) {
                case 'efectivo':
                  cashTotal += amount;
                  break;
                case 'tarjeta':
                  cardTotal += amount;
                  break;
                case 'transferencia':
                  transferTotal += amount;
                  break;
              }
            }
          });
        }

        const total = cashTotal + cardTotal + transferTotal;

        // Update revenue display
        document.getElementById('revenue-cash').textContent = `$${cashTotal.toFixed(2)}`;
        document.getElementById('revenue-card').textContent = `$${cardTotal.toFixed(2)}`;
        document.getElementById('revenue-transfer').textContent = `$${transferTotal.toFixed(2)}`;
        document.getElementById('revenue-total').textContent = `$${total.toFixed(2)}`;
      } catch (e) {
        console.error('Error loading month stats', e);
        document.getElementById('stat-total').textContent = '-';
        document.getElementById('stat-completed').textContent = '-';
        document.getElementById('stat-cancelled').textContent = '-';
        document.getElementById('stat-pending').textContent = '-';
      }
    }

    // ========== CANCELAR CITA ==========
    window.cancelAppointment = async (id) => {
      if (!confirm('¬øCancelar esta cita?')) return;
      try {
        await fetch(`/api/appointments/${id}/cancel`, { method: 'PATCH' });
        loadAppointments();
        renderWeeklyCalendar();
        loadMonthStats();
      } catch (e) { alert('Error: ' + e.message); }
    };

    // ========== REGISTRAR PAGO ==========
    window.openPaymentDialog = async (apptId) => {
      try {
        const res = await fetch(`/api/appointments/${apptId}`);
        const json = await res.json();

        if (!json.success) {
          alert('Error cargando datos de la cita');
          return;
        }

        const appt = json.data;
        currentPaymentApptId = apptId;

        // Prellenar datos
        document.getElementById('payment-client-name').value = appt.clientName;
        document.getElementById('payment-service-name').value = appt.serviceName;
        document.getElementById('payment-amount').value = appt.price || 0;
        document.getElementById('payment-method').value = 'efectivo';

        paymentDialog.showModal();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    // Payment form submission
    if (formPayment) {
      formPayment.addEventListener('submit', async (e) => {
        e.preventDefault();

        const method = document.getElementById('payment-method').value;
        const amount = parseFloat(document.getElementById('payment-amount').value);

        if (amount <= 0) {
          alert('El monto debe ser mayor a 0');
          return;
        }

        try {
          const res = await fetch(`/api/appointments/${currentPaymentApptId}/payment`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              method,
              amount,
              paidAt: new Date().toISOString()
            })
          });

          const json = await res.json();

          if (!json.success) {
            throw new Error(json.error || 'Error registrando pago');
          }

          alert('‚úÖ Pago registrado correctamente');
          paymentDialog.close();
          loadAppointments();
          loadMonthStats();
        } catch (e) {
          alert('‚ùå Error: ' + e.message);
        }
      });

      // Cancel payment button
      document.getElementById('btn-cancel-payment')?.addEventListener('click', () => {
        paymentDialog.close();
      });

      // Close payment button
      document.getElementById('btn-close-payment')?.addEventListener('click', () => {
        paymentDialog.close();
      });
    }

    // ========== MODIFICAR CITA ==========
    const editApptDialog = document.getElementById('editApptDialog');
    const formEditAppt = document.getElementById('form-edit-appt');
    const btnCancelEditAppt = document.getElementById('btn-cancel-edit-appt');
    const editApptId = document.getElementById('edit-appt-id');
    const editClientName = document.getElementById('edit-appt-client-name');
    const editServiceInput = document.getElementById('edit-appt-service');
    const editPriceInput = document.getElementById('edit-appt-price');
    const editDurationInput = document.getElementById('edit-appt-duration');
    const editDateInput = document.getElementById('edit-appt-date');
    const editHourSelect = document.getElementById('edit-appt-hour');
    const editMinuteSelect = document.getElementById('edit-appt-minute');
    const editEndTimeInput = document.getElementById('edit-appt-end-time');

    window.editAppointment = async (id) => {
      try {
        // Fetch appointment data
        const res = await fetch(`/api/appointments/${id}`);
        const json = await res.json();

        if (!json.success) {
          alert('Error cargando cita');
          return;
        }

        const appt = json.data;

        // Load services and generate hour/minute options
        await loadServices();
        generateHourMinuteOptionsForEdit();

        // Populate edit form with frozen client name
        editApptId.value = id;
        editClientName.value = appt.clientName;
        editServiceInput.value = appt.serviceName;

        // Find service to get price and duration
        const service = allServices.find(s => s.name === appt.serviceName);
        if (service) {
          editPriceInput.value = service.price;
          editDurationInput.value = service.durationMinutes;
        }

        // Extract date and time from startDateTime
        const startDate = new Date(appt.startDateTime);
        const isoDate = appt.startDateTime.split('T')[0];
        editDateInput.value = isoDate;

        // Initialize calendar with existing date
        editApptCalendar.selectedDate = isoDate;
        const date = new Date(isoDate + 'T12:00:00');
        const day = date.getDate();
        const month = date.getMonth() + 1;
        const year = date.getFullYear();
        editDateInput.value = `${day}/${month}/${year}`;
        editDateInput.dataset.isoDate = isoDate;

        editHourSelect.value = String(startDate.getHours()).padStart(2, '0');
        editMinuteSelect.value = String(startDate.getMinutes()).padStart(2, '0');

        // Calculate end time
        calculateEditEndTime();

        // Show modal
        editApptDialog.showModal();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    function generateHourMinuteOptionsForEdit() {
      // Hours
      editHourSelect.innerHTML = '<option value="">--</option>';
      for (let h = 8; h <= 20; h++) {
        const val = String(h).padStart(2, '0');
        editHourSelect.innerHTML += `<option value="${val}">${h}:00</option>`;
      }

      // Minutes
      editMinuteSelect.innerHTML = '<option value="">--</option>';
      ['00', '15', '30', '45'].forEach(m => {
        editMinuteSelect.innerHTML += `<option value="${m}">${m}</option>`;
      });
    }

    function calculateEditEndTime() {
      if (!editHourSelect || !editMinuteSelect || !editEndTimeInput) return;

      const hour = editHourSelect.value;
      const minute = editMinuteSelect.value;
      const serviceName = editServiceInput.value.trim();
      const service = allServices.find(s => s.name === serviceName);

      if (!hour || !minute || !service) return;

      const duration = parseInt(service.durationMinutes) || 60;
      const startDate = new Date();
      startDate.setHours(parseInt(hour), parseInt(minute), 0);
      const endDate = new Date(startDate.getTime() + duration * 60000);

      const endHours = endDate.getHours();
      const endMinutes = endDate.getMinutes();
      const displayHour = endHours > 12 ? endHours - 12 : (endHours === 0 ? 12 : endHours);
      const period = endHours >= 12 ? 'PM' : 'AM';

      editEndTimeInput.value = `${displayHour}:${String(endMinutes).padStart(2, '0')} ${period}`;
    }

    // Event listeners for edit modal
    if (btnCancelEditAppt) {
      btnCancelEditAppt.addEventListener('click', () => editApptDialog.close());
    }

    if (editServiceInput) {
      editServiceInput.addEventListener('input', function () {
        const serviceName = this.value.trim();
        const service = allServices.find(s => s.name === serviceName);
        if (service) {
          editPriceInput.value = service.price;
          editDurationInput.value = service.durationMinutes;
          calculateEditEndTime();
        }
      });
    }

    if (editHourSelect) {
      editHourSelect.addEventListener('change', calculateEditEndTime);
    }

    if (editMinuteSelect) {
      editMinuteSelect.addEventListener('change', calculateEditEndTime);
    }

    if (formEditAppt) {
      formEditAppt.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = formEditAppt.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Guardando...';

        try {
          const hour = editHourSelect.value;
          const minute = editMinuteSelect.value;

          if (!hour || !minute) {
            alert('Por favor selecciona hora y minutos');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          const time = `${hour}:${minute}`;
          const serviceName = editServiceInput.value.trim();
          const service = allServices.find(s => s.name === serviceName);

          if (!service) {
            alert('Por favor selecciona un servicio v√°lido');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          const body = {
            serviceId: service.id,
            serviceName: service.name,
            date: editApptCalendar.getISODate() || editDateInput.value,
            time: time,
            durationMinutes: parseInt(service.durationMinutes)
          };

          const res = await fetch(`/api/appointments/${editApptId.value}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });

          const json = await res.json();
          if (json.success) {
            alert('‚úÖ Cita actualizada');
            editApptDialog.close();
            formEditAppt.reset();
            loadAppointments();
            renderWeeklyCalendar();
            loadMonthStats();
          } else {
            alert('‚ùå Error: ' + json.error);
          }
        } catch (e) {
          alert('Error de conexi√≥n');
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });
    }


    // ========== CUSTOM CALENDAR PICKER ==========
    /* =========================================================
       CUSTOM SEARCHABLE DROPDOWN CLASS
       ========================================================= */
    class CustomSearchableDropdown {
      constructor(inputId, dropdownId, onSelectCallback) {
        this.input = document.getElementById(inputId);
        this.dropdown = document.getElementById(dropdownId);

        if (!this.input || !this.dropdown) {
          console.error(`CustomSearchableDropdown: Elements not found - input: ${inputId}, dropdown: ${dropdownId}`);
          return;
        }

        this.wrapper = this.input.closest('.custom-select-wrapper');
        this.icon = this.wrapper ? this.wrapper.querySelector('.dropdown-toggle-icon') : null;

        if (!this.icon) {
          console.error(`CustomSearchableDropdown: Icon not found for ${inputId}`);
          return;
        }

        this.options = [];
        this.onSelectCallback = onSelectCallback;

        this.init();
      }

      init() {
        // Toggle on icon click
        this.icon.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggle();
        });

        // Open on input click
        this.input.addEventListener('click', (e) => {
          e.stopPropagation();
          console.log('[DROPDOWN] Input clicked, showing dropdown');
          this.show();
        });

        // Filter on input type
        this.input.addEventListener('input', () => {
          const query = this.input.value;
          console.log('[DROPDOWN] Input changed:', query);
          if (query.length === 0) {
            // Si est√° vac√≠o, mostrar todas las opciones
            this.render(this.options);
            this.show();
          } else {
            // Si hay texto, filtrar
            this.filter(query);
            this.show();
          }
        });

        // Close on outside click
        document.addEventListener('click', (e) => {
          if (!this.wrapper.contains(e.target)) {
            this.hide();
          }
        });
      }

      setOptions(options) {
        this.options = options;
        this.render(options);
      }

      render(items) {
        console.log('[DROPDOWN] Renderizando', items.length, 'items');
        this.dropdown.innerHTML = '';
        if (items.length === 0) {
          this.dropdown.innerHTML = '<div class="dropdown-item" style="cursor:default;color:var(--muted);">No hay resultados</div>';
          return;
        }

        items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'dropdown-item';
          div.innerHTML = `
            <div>${item.label}</div>
            ${item.meta ? `<span class="item-meta">${item.meta}</span>` : ''}
          `;

          // Store data attributes
          Object.keys(item.data || {}).forEach(key => {
            div.dataset[key] = item.data[key];
          });

          div.addEventListener('click', (e) => {
            e.stopPropagation();
            this.select(item);
          });

          this.dropdown.appendChild(div);
        });
      }

      filter(query) {
        const lowerQuery = query.toLowerCase();
        const filtered = this.options.filter(item =>
          item.label.toLowerCase().includes(lowerQuery) ||
          (item.meta && item.meta.toLowerCase().includes(lowerQuery))
        );
        this.render(filtered);
      }

      show() {
        console.log('[DROPDOWN] Mostrando dropdown con', this.options.length, 'opciones');
        // If empty input, show all
        if (!this.input.value) {
          this.render(this.options);
        }
        this.dropdown.style.display = 'block';
        this.icon.textContent = '‚ñ≤';
      }

      hide() {
        this.dropdown.style.display = 'none';
        this.icon.textContent = '‚ñº';
      }

      toggle() {
        if (this.dropdown.style.display === 'block') {
          this.hide();
        } else {
          this.show();
        }
      }

      select(item) {
        this.input.value = item.value; // Use value for input

        // Trigger callback if provided
        if (this.onSelectCallback) {
          this.onSelectCallback(item);
        }

        // Trigger native change event for other listeners
        this.input.dispatchEvent(new Event('change', { bubbles: true }));
        this.input.dispatchEvent(new Event('input', { bubbles: true }));

        // Close dropdown AFTER all callbacks
        this.hide();
      }
    }

    // Global instances (Moved to top)
    // Payment dialog variables (Moved to top)

    /* =========================================================
       CUSTOM CALENDAR CLASS
       ========================================================= */
    class CustomCalendar {
      constructor(inputId, calendarId) {
        this.input = document.getElementById(inputId);
        this.calendar = document.getElementById(calendarId);
        this.currentDate = new Date();
        this.selectedDate = null;

        if (!this.input || !this.calendar) return;

        this.input.addEventListener('click', (e) => {
          e.stopPropagation();
          this.show();
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
          if (!this.calendar.contains(e.target) && e.target !== this.input) {
            this.hide();
          }
        });
      }

      show() {
        this.render();
        this.calendar.style.display = 'block';
      }

      hide() {
        this.calendar.style.display = 'none';
      }

      render() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const dayNames = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];

        // First day of month and total days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        let html = `
          <div class="calendar-header">
            <button class="calendar-nav-btn" data-action="prev"><i class="fas fa-chevron-left"></i></button>
            <div class="calendar-month-year">${monthNames[month]} ${year}</div>
            <button class="calendar-nav-btn" data-action="next"><i data-lucide="chevron-right"></i></button>
          </div>
          <div class="calendar-grid">
        `;

        // Day headers
        dayNames.forEach(day => {
          html += `<div class="calendar-day-header">${day}</div>`;
        });

        // Empty cells before first day
        for (let i = 0; i < firstDay; i++) {
          html += `<div class="calendar-day empty"></div>`;
        }

        // Days of month
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          // Usar formato local YYYY-MM-DD para evitar problemas de timezone
          const y = date.getFullYear();
          const m = String(date.getMonth() + 1).padStart(2, '0');
          const d = String(date.getDate()).padStart(2, '0');
          const dateStr = `${y}-${m}-${d}`;
          const isToday = date.toDateString() === today.toDateString();
          const isSelected = this.selectedDate && dateStr === this.selectedDate;

          let classes = ['calendar-day'];
          if (isToday) classes.push('today');
          if (isSelected) classes.push('selected');

          html += `<div class="${classes.join(' ')}" data-date="${dateStr}">${day}</div>`;
        }

        html += `</div>`;
        this.calendar.innerHTML = html;

        // Event listeners
        this.calendar.querySelectorAll('[data-action="prev"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.currentDate.setMonth(this.currentDate.getMonth() - 1);
            this.render();
          });
        });

        this.calendar.querySelectorAll('[data-action="next"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.currentDate.setMonth(this.currentDate.getMonth() + 1);
            this.render();
          });
        });

        this.calendar.querySelectorAll('.calendar-day:not(.empty)').forEach(dayEl => {
          dayEl.addEventListener('click', (e) => {
            e.stopPropagation();
            const dateStr = dayEl.dataset.date;
            this.selectDate(dateStr);
          });
        });
      }

      selectDate(dateStr) {
        this.selectedDate = dateStr;
        const date = new Date(dateStr + 'T12:00:00');
        const day = date.getDate();
        const month = date.getMonth() + 1;
        const year = date.getFullYear();
        this.input.value = `${day}/${month}/${year}`;
        this.input.dataset.isoDate = dateStr;
        this.hide();
      }

      getISODate() {
        return this.input.dataset.isoDate || '';
      }
    }

    // Initialize calendars
    const newApptCalendar = new CustomCalendar('new-appt-date', 'new-appt-calendar');
    const editApptCalendar = new CustomCalendar('edit-appt-date', 'edit-appt-calendar');

    // ========== EVENT LISTENERS ==========

    // Navegaci√≥n semanal
    if (btnPrevWeek) {
      btnPrevWeek.addEventListener('click', () => {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        renderWeeklyCalendar();
      });
    }

    if (btnNextWeek) {
      btnNextWeek.addEventListener('click', () => {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        renderWeeklyCalendar();
      });
    }

    if (btnToday) {
      btnToday.addEventListener('click', () => {
        currentWeekStart = new Date();
        selectedDate = new Date();
        renderWeeklyCalendar();
        loadAppointments();
        updateSelectedDateLabel();
      });
    }

    if (btnRefreshAppts) {
      btnRefreshAppts.addEventListener('click', () => {
        loadAppointments();
        renderWeeklyCalendar();
      });
    }

    // Modal
    if (btnNewAppt) {
      btnNewAppt.addEventListener('click', () => {
        loadServices();
        loadClients();
        generateHourMinuteOptions();
        newApptDialog.showModal();
        document.getElementById('new-appt-date').value = selectedDate.toISOString().split('T')[0];

        // Limpiar historial
        if (historyPanel) historyPanel.classList.add('hidden');
        if (historyContent) historyContent.style.display = 'none';
        if (historyHeader) historyHeader.classList.remove('expanded');
      });
    }

    if (btnCancelAppt) {
      btnCancelAppt.addEventListener('click', () => newApptDialog.close());
    }

    // Cliente input - auto-llenar tel√©fono cuando se selecciona
    if (clientSelect) {
      clientSelect.addEventListener('input', function () {
        const clientName = this.value.trim();
        const client = allClients.find(c => c.name === clientName);
        if (client && phoneInput) {
          phoneInput.value = client.phone || '';
          phoneInput.readOnly = true;
        } else {
          if (!phoneInput.value || phoneInput.readOnly) {
            phoneInput.value = '';
          }
          phoneInput.readOnly = false;
        }
      });
    }

    // Servicio input - auto-llenar precio y calcular hora fin
    if (serviceSelect) {
      serviceSelect.addEventListener('input', function () {
        const serviceName = this.value.trim();
        const service = allServices.find(s => s.name === serviceName);
        if (service && priceInput) {
          priceInput.value = service.price;
          calculateEndTime();
        }
      });
    }

    // Hora select - calcular hora fin
    if (hourSelect) {
      hourSelect.addEventListener('change', calculateEndTime);
    }

    // Minuto select - calcular hora fin
    if (minuteSelect) {
      minuteSelect.addEventListener('change', calculateEndTime);
    }

    function calculateEndTime() {
      if (!hourSelect || !minuteSelect || !endTimeInput) return;

      const hour = hourSelect.value;
      const minute = minuteSelect.value;
      const serviceName = serviceSelect ? serviceSelect.value.trim() : '';
      const service = allServices.find(s => s.name === serviceName);

      if (!hour || !minute || !service) return;

      const duration = parseInt(service.durationMinutes) || 60;

      const startDate = new Date();
      startDate.setHours(parseInt(hour), parseInt(minute), 0);

      const endDate = new Date(startDate.getTime() + duration * 60000);

      const endHours = endDate.getHours();
      const endMinutes = endDate.getMinutes();
      const displayHour = endHours > 12 ? endHours - 12 : (endHours === 0 ? 12 : endHours);
      const period = endHours >= 12 ? 'PM' : 'AM';

      endTimeInput.value = `${displayHour}:${String(endMinutes).padStart(2, '0')} ${period}`;
    }


    // Toggle nuevo cliente form
    if (btnToggleNewClient) {
      btnToggleNewClient.addEventListener('click', () => {
        const isHidden = newClientForm.style.display === 'none';
        newClientForm.style.display = isHidden ? 'block' : 'none';
        btnToggleNewClient.textContent = isHidden ? '- Cancelar' : '+ Registrar nuevo cliente';
      });
    }

    // Guardar nuevo cliente
    if (btnSaveNewClient) {
      btnSaveNewClient.addEventListener('click', async () => {
        const name = document.getElementById('new-client-name').value.trim();
        const phone = document.getElementById('new-client-phone').value.trim();

        if (!name || !phone) {
          alert('Por favor completa nombre y tel√©fono');
          return;
        }

        try {
          const res = await fetch('/api/clients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, phone })
          });

          const json = await res.json();
          if (json.success) {
            alert('‚úÖ Cliente guardado');
            await loadClients();

            // Seleccionar el nuevo cliente
            const newClientId = json.client.id;
            clientSelect.value = newClientId;
            phoneInput.value = phone;
            phoneInput.readOnly = true;

            // Ocultar form
            newClientForm.style.display = 'none';
            btnToggleNewClient.textContent = '+ Registrar nuevo cliente';

            // Limpiar campos
            document.getElementById('new-client-name').value = '';
            document.getElementById('new-client-phone').value = '';
          } else {
            alert('‚ùå Error: ' + json.error);
          }
        } catch (e) {
          alert('Error de conexi√≥n');
        }
      });
    }

    // Submit form
    if (formNewAppt) {
      formNewAppt.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = formNewAppt.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Agendando...';

        try {
          // Construir hora desde los selectores separados
          const hour = hourSelect.value;
          const minute = minuteSelect.value;

          if (!hour || !minute) {
            alert('Por favor selecciona hora y minutos');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          const time = `${hour}:${minute}`;

          // Buscar servicio en allServices
          const serviceName = serviceSelect.value.trim();
          const service = allServices.find(s => s.name === serviceName);

          if (!service) {
            alert('Por favor selecciona un servicio v√°lido');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          const isoDate = newApptCalendar.getISODate();
          if (!isoDate) {
            alert('Por favor selecciona una fecha del calendario');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          const payload = {
            name: clientSelect.value.trim(),
            phone: phoneInput.value.trim(),
            serviceId: service.id,
            serviceName: serviceSelect.value.trim(),
            date: isoDate,
            time: time,
            durationMinutes: parseInt(service.durationMinutes),
            sendWhatsAppConfirmation: document.getElementById('check-whatsapp-confirm').checked,
            sendWhatsApp24h: document.getElementById('check-whatsapp-24h').checked,
            sendWhatsApp2h: document.getElementById('check-whatsapp-2h').checked
          };

          const res = await fetch('/api/appointments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const json = await res.json();
          if (json.success) {
            alert('‚úÖ Cita agendada');
            newApptDialog.close();
            formNewAppt.reset();
            loadAppointments();
            renderWeeklyCalendar();
          } else {
            alert('‚ùå Error: ' + json.error);
          }
        } catch (e) {
          alert('Error de conexi√≥n');
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });
    }

    // Inicializar
    renderWeeklyCalendar();
    updateSelectedDateLabel();
    loadMonthStats();

    // Auto-load when tab is shown
    window.addEventListener('hashchange', () => {
      if (location.hash === '#appointments') {
        renderWeeklyCalendar();
        loadAppointments();
        updateSelectedDateLabel();
        loadMonthStats();
      }
    });

    if (location.hash === '#appointments') {
      renderWeeklyCalendar();
      loadAppointments();
      updateSelectedDateLabel();
      loadMonthStats();
    }

    // ========== GESTI√ìN DE SERVICIOS ==========
    const servicesTbody = document.getElementById('services-tbody');
    const modalService = document.getElementById('modal-service');
    const formService = document.getElementById('form-service');
    const btnNewService = document.getElementById('btn-new-service');
    const closeModalService = document.getElementById('close-modal-service');
    const btnCancelService = document.getElementById('cancel-service');

    async function loadServicesTable() {
      try {
        servicesTbody.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center;padding:20px;">Cargando...</td></tr>';
        const res = await fetch('/api/services');
        const json = await res.json();

        if (json.success) {
          const services = json.data;
          if (services.length === 0) {
            servicesTbody.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center;padding:20px;">No hay servicios registrados</td></tr>';
            return;
          }

          // Store services globally for search
          window.allServicesData = services;
          renderServicesTable(services);
        }
      } catch (error) {
        console.error('Error loading services:', error);
        servicesTbody.innerHTML = '<tr><td colspan="4" style="color:red;text-align:center;">Error al cargar servicios</td></tr>';
      }
    }

    // Funci√≥n para renderizar la tabla de servicios
    function renderServicesTable(services) {
      if (services.length === 0) {
        servicesTbody.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center;padding:20px;">No se encontraron servicios</td></tr>';
        return;
      }

      servicesTbody.innerHTML = services.map(s => `
        <tr>
          <td data-label="Nombre">${s.name}</td>
          <td data-label="Duraci√≥n">${s.durationMinutes} min</td>
          <td data-label="Precio">$${s.price}</td>
          <td data-label="Acciones">
            <div class="actions">
              <button class="btn small ghost" onclick="editService('${s.id}')">Editar</button>
              <button class="btn small ghost" style="color:#ef4444;border-color:#ef4444;" onclick="deleteService('${s.id}')">Eliminar</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Abrir modal (Nuevo o Editar)
    window.editService = async (id) => {
      try {
        // Buscar servicio en la lista actual (o hacer fetch)
        const res = await fetch('/api/services');
        const json = await res.json();
        const service = json.data.find(s => s.id === id);

        if (service) {
          document.getElementById('service-id').value = service.id;
          document.getElementById('service-name').value = service.name;
          document.getElementById('service-duration').value = service.durationMinutes;
          document.getElementById('service-price').value = service.price;
          document.getElementById('modal-service-title').textContent = 'Editar Servicio';
          modalService.classList.remove('hidden');
        }
      } catch (e) { console.error(e); }
    };

    if (btnNewService) {
      btnNewService.addEventListener('click', () => {
        document.getElementById('form-service').reset();
        document.getElementById('service-id').value = '';
        document.getElementById('modal-service-title').textContent = 'Nuevo Servicio';
        modalService.classList.remove('hidden');
      });
    }

    // Cerrar modal
    const closeServiceModalFn = () => modalService.classList.add('hidden');
    if (closeModalService) closeModalService.addEventListener('click', closeServiceModalFn);
    if (btnCancelService) btnCancelService.addEventListener('click', closeServiceModalFn);

    // Guardar servicio
    if (formService) {
      formService.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('service-id').value;
        const data = {
          name: document.getElementById('service-name').value,
          durationMinutes: parseInt(document.getElementById('service-duration').value),
          price: parseFloat(document.getElementById('service-price').value)
        };

        try {
          const url = id ? `/api/services/${id}` : '/api/services';
          const method = id ? 'PUT' : 'POST';

          const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const json = await res.json();
          if (json.success) {
            closeServiceModalFn();
            loadServicesTable();
            // Recargar dropdowns de citas tambi√©n
            loadServices();
          } else {
            alert('Error al guardar: ' + json.error);
          }
        } catch (error) {
          console.error(error);
          alert('Error de conexi√≥n');
        }
      });
    }

    // Eliminar servicio
    window.deleteService = async (id) => {
      if (!confirm('¬øEst√°s seguro de eliminar este servicio?')) return;

      try {
        const res = await fetch(`/api/services/${id}`, { method: 'DELETE' });
        const json = await res.json();
        if (json.success) {
          loadServicesTable();
          loadServices(); // Recargar dropdowns
        } else {
          alert('Error al eliminar: ' + json.error);
        }
      } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
      }
    };

    // Cargar servicios al cambiar a la pesta√±a
    document.querySelectorAll('.nav a[data-tab="services"]').forEach(link => {
      link.addEventListener('click', () => {
        loadServicesTable();
      });
    });

    // B√∫squeda de servicios
    const searchServicesInput = document.getElementById('search-services');
    if (searchServicesInput) {
      searchServicesInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();

        if (!window.allServicesData) return;

        if (searchTerm === '') {
          renderServicesTable(window.allServicesData);
        } else {
          const filtered = window.allServicesData.filter(s =>
            s.name.toLowerCase().includes(searchTerm)
          );
          renderServicesTable(filtered);
        }
      });
    }

  </script>
</body>

</html>