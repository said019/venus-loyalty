<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Panel Admin â€” Venus Lealtad</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    :root{ --venus:#8c9668; --venus-2:#cdd8a6; --muted:#6b7280; --line:#e5e7eb; --bg:#fff6e3; --ink:#1b1b1b; }
    body{ background:var(--bg); color:var(--ink); }
    .wrap{ max-width:1100px; margin:24px auto; padding:16px }
    .muted{ color:var(--muted) }
    .btn{ background:var(--venus); color:#fff; border:none; border-radius:10px; padding:10px 14px; cursor:pointer }
    .btn.ghost{ background:#fff; color:var(--venus); border:1px solid var(--venus) }
    .btn.icon{ display:inline-flex; gap:8px; align-items:center }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .right{ display:flex; justify-content:flex-end }
    .panel{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:16px; margin:12px 0 }
    .h1{ display:flex; gap:10px; align-items:center; margin:0 0 8px }
    .nav{ display:flex; gap:8px; margin:6px 0 12px }
    .nav a{ padding:8px 12px; border-radius:10px; border:1px solid var(--line); background:#fff; color:#111; text-decoration:none }
    .nav a.is-active{ border-color:var(--venus); color:var(--venus) }
    .grid-kpi{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px }
    .kpi{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px }
    .kpi .big{ font-size:28px; font-weight:700 }
    .hidden{ display:none!important }
    input,select{ padding:10px; border:1px solid var(--line); border-radius:10px; background:#fafafa }
    table{ width:100%; border-collapse:collapse }
    th,td{ padding:10px; border-bottom:1px solid #eee; font-size:14px; text-align:left; vertical-align:top }
    th{ background:#fafafa }
    .tag{ display:inline-block; background:#eef2f7; border:1px solid #e5e7eb; padding:4px 8px; border-radius:999px; font-size:12px }
    .tools{ display:flex; gap:8px; flex-wrap:wrap }
    .pill{ background:#eef2f7; border:1px solid #e5e7eb; padding:6px 10px; border-radius:999px }
    dialog{ border:none; border-radius:12px; max-width:620px; width:92% }
    dialog .hd{ display:flex; justify-content:space-between; align-items:center }
    .qr-wrap{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
    .small{ font-size:12px }

    /* EscÃ¡ner QR */
    #scanDialog video{ width:100%; border-radius:12px; background:#000; aspect-ratio:16/9; object-fit:cover }
    #scanDialog .row{ margin-top:10px }
  </style>
</head>
<body>
  <main class="wrap">
    <header class="row" style="justify-content:space-between;margin-bottom:6px">
      <div class="row">
        <img src="/assets/logo.png" alt="Venus" style="width:40px;height:40px;border-radius:10px">
        <div>
          <h1 class="h1">Panel Admin â€” Venus Lealtad</h1>
          <div id="me-line" class="muted">Cargandoâ€¦</div>
        </div>
      </div>
      <div class="row">
        <a class="btn ghost" href="/" target="_blank" rel="noopener">Clientes</a>
        <!-- Staff eliminado; todo se hace aquÃ­ -->
        <button id="logout" class="btn ghost">Cerrar sesiÃ³n</button>
      </div>
    </header>

    <nav class="nav">
      <a href="#overview" class="is-active" data-tab>Resumen</a>
      <a href="#cards" data-tab>Tarjetas</a>
      <a href="#events" data-tab>Eventos</a>
      <a href="#settings" data-tab>ConfiguraciÃ³n</a>
    </nav>

    <!-- ========== OVERVIEW ========== -->
    <section id="tab-overview" class="panel">
      <h2 style="margin:0 0 8px">Resumen</h2>
      <p class="muted small">Indicadores rÃ¡pidos de tu programa de lealtad.</p>
      <div id="kpis" class="grid-kpi">
        <div class="kpi"><div class="muted">Tarjetas totales</div><div id="k_total" class="big">â€”</div></div>
        <div class="kpi"><div class="muted">Tarjetas completas</div><div id="k_full" class="big">â€”</div></div>
        <div class="kpi"><div class="muted">Sellos hoy</div><div id="k_stamps" class="big">â€”</div></div>
        <div class="kpi"><div class="muted">Canjes hoy</div><div id="k_redeems" class="big">â€”</div></div>
      </div>
      <div id="kpi_note" class="muted small" style="margin-top:8px"></div>
    </section>

    <!-- ========== CARDS ========== -->
    <section id="tab-cards" class="panel hidden">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">Tarjetas</h2>
        <div class="tools">
          <button id="scan" class="btn icon">ðŸ“· Escanear QR</button>
          <button id="reload" class="btn ghost">Recargar</button>
          <button id="export" class="btn ghost">Exportar CSV</button>
        </div>
      </div>

      <div class="row" style="gap:8px;margin:8px 0">
        <input id="q" placeholder="Buscar por ID o nombreâ€¦" style="min-width:260px">
        <select id="f_status">
          <option value="">Estado (todos)</option>
          <option value="ACTIVE">Activas</option>
          <option value="BLOCKED">Bloqueadas</option>
        </select>
        <select id="f_completed">
          <option value="">Completas (todas)</option>
          <option value="yes">SÃ­</option>
          <option value="no">No</option>
        </select>
        <button id="clearFilters" class="btn ghost">Limpiar filtros</button>
      </div>

      <div class="panel" style="margin:10px 0">
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Cliente</th><th>Sellos</th><th>Max</th><th>Estado</th><th>Creada</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="cards-tbody"></tbody>
        </table>
        <div class="row" style="justify-content:space-between;margin-top:8px">
          <button id="prev" class="btn ghost">Anterior</button>
          <div id="pageinfo" class="muted"></div>
          <button id="next" class="btn ghost">Siguiente</button>
        </div>
      </div>
    </section>

    <!-- ========== EVENTS ========== -->
    <section id="tab-events" class="panel hidden">
      <h2 style="margin:0 0 8px">Eventos</h2>
      <div class="row" style="gap:8px;margin-bottom:8px">
        <input id="eid" placeholder="card_...">
        <button id="eload" class="btn">Ver eventos</button>
      </div>
      <div class="panel">
        <table>
          <thead><tr><th>#</th><th>Tipo</th><th>Meta</th><th>Fecha</th></tr></thead>
          <tbody id="events-tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ========== SETTINGS ========== -->
    <section id="tab-settings" class="panel hidden">
      <h2 style="margin:0 0 6px">ConfiguraciÃ³n</h2>
      <p class="muted small">Algunas opciones avanzadas se activan desde variables de entorno.</p>
      <ul class="muted small" style="line-height:1.6">
        <li><span class="pill">ADMIN_ALLOW_SIGNUP</span> habilita/deshabilita nuevos registros.</li>
        <li><span class="pill">STAFF_USER / STAFF_PASS</span> (legacy) â€” ya no es necesario: el escÃ¡ner estÃ¡ en este panel.</li>
        <li>Rutas admin: <code>/api/admin/stamp</code> y <code>/api/admin/redeem</code>.</li>
      </ul>
    </section>

    <!-- DIALOGO DETALLE TARJETA -->
    <dialog id="cardDialog">
      <div class="hd">
        <h3 id="d_title" style="margin:0">Tarjeta</h3>
        <button id="d_close" class="btn ghost">Cerrar</button>
      </div>
      <div id="d_body" class="muted small">Cargandoâ€¦</div>
      <div style="margin-top:10px" class="qr-wrap">
        <img id="d_qr" alt="QR" width="140" height="140">
        <div>
          <div class="muted small">Comparte/usa este ID:</div>
          <div class="pill" id="d_id" style="user-select:all"></div>
          <div class="row" style="margin-top:8px">
            <button id="d_copy" class="btn ghost">Copiar ID</button>
            <a id="d_open" class="btn ghost" target="_blank" rel="noopener">Abrir como cliente</a>
          </div>
        </div>
      </div>
      <div style="margin-top:12px" class="row">
        <button id="d_stamp" class="btn">+1 sello</button>
        <button id="d_redeem" class="btn ghost">Canjear</button>
      </div>
      <div id="d_out" class="muted small" style="margin-top:6px"></div>
    </dialog>

    <!-- DIALOGO ESCÃNER QR -->
    <dialog id="scanDialog">
      <div class="hd">
        <h3 style="margin:0">Escanear QR</h3>
        <button id="scan_close" class="btn ghost">Cerrar</button>
      </div>
      <video id="scan_video" playsinline muted></video>
      <div class="row">
        <select id="scan_cameras"></select>
        <button id="scan_start" class="btn">Iniciar</button>
        <button id="scan_stop" class="btn ghost" disabled>Detener</button>
      </div>
      <div id="scan_out" class="muted small" style="margin-top:8px">Apunta al QR del cliente.</div>
    </dialog>
  </main>

  <script src="/admin.js"></script>
</body>
</html>