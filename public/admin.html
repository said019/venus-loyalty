<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Admin — Venus Lealtad</title>
  <link rel="icon" href="/assets/logo.png">
  <style>
    /* [TODOS LOS ESTILOS EXISTENTES SE MANTIENEN IGUAL] */
    body.checking-auth {
      opacity: 0;
      pointer-events: none;
    }

    body.auth-verified {
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    :root {
      --venus: #8c9668;
      --venus-soft: #dfe6c1;
      --bg: #3f4037;
      --ink: #f9fafb;
      --muted: #e5e7eb;
      --line: rgba(255, 255, 255, 0.25);
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, sans-serif;
      overflow-x: hidden;
      max-width: 100vw;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .wrap {
      max-width: 1100px;
      margin: 16px auto;
      padding: 0 12px 32px;
      width: 100%;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand img {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, .1);
    }

    h1 {
      font-size: 22px;
      margin: 0;
      color: var(--ink);
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .1);
      padding: 7px 13px;
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
      color: var(--ink);
      white-space: nowrap;
      backdrop-filter: blur(3px);
      transition: all 0.2s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--venus-green) 0%, #9aa066 100%);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(140, 150, 104, 0.3);
      transition: all 0.2s ease;
    }

    .btn.primary:hover {
      background: linear-gradient(135deg, #9aa066 0%, var(--venus-green) 100%);
      box-shadow: 0 6px 16px rgba(140, 150, 104, 0.4);
      transform: translateY(-1px);
    }

    .btn.ghost {
      background: transparent;
      border-color: var(--line);
    }

    .btn.small {
      padding: 5px 10px;
      font-size: 12px;
    }

    /* Estilo para días de trabajo */
    .day-checkbox {
      display: none;
    }

    .day-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #e8eaf6;
      color: #5c6bc0;
      border: 2px solid transparent;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .day-label:hover {
      background: #c5cae9;
    }

    .day-checkbox:checked+.day-label {
      background: #5c6bc0;
      color: white;
      border-color: #5c6bc0;
      box-shadow: 0 2px 8px rgba(92, 107, 192, 0.3);
    }

    .day-label .checkmark {
      display: none;
      font-size: 14px;
    }

    .day-checkbox:checked+.day-label .checkmark {
      display: inline-block;
    }

    .nav {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 8px 0 14px;
      position: relative;
      z-index: 100;
    }

    .nav a {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid transparent;
      text-decoration: none;
      font-size: 13px;
      color: var(--muted);
      background: transparent;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .nav a.is-active {
      background: rgba(255, 255, 255, .15);
      border-color: var(--venus);
      color: var(--venus-soft);
      box-shadow: 0 4px 14px rgba(0, 0, 0, .1);
    }

    .card {
      background: #2c2d26;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      padding: 16px 16px 14px;
      box-shadow: 0 10px 28px rgba(0, 0, 0, .2);
      margin-bottom: 14px;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.05), transparent 60%),
        radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.03), transparent 60%);
      opacity: .9;
      pointer-events: none;
    }

    .card>* {
      position: relative;
      z-index: 1;
    }

    .card h2 {
      margin: 0 0 6px;
      font-size: 18px;
      color: var(--ink);
    }

    .card h3 {
      margin: 0 0 6px;
      font-size: 15px;
      color: var(--ink);
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select.filter-select {
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      border: 1px solid var(--line);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      outline: none;
      cursor: pointer;
    }

    .grid-3-kpi {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    @media (max-width:700px) {
      .grid-3-kpi {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width:480px) {
      .grid-3-kpi {
        grid-template-columns: 1fr;
      }
    }

    .kpi {
      padding: 10px 12px;
      border-radius: 12px;
      background: #2c2d26;
      border: 1px solid rgba(255, 255, 255, .15);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      backdrop-filter: blur(3px);
    }

    .kpi span.value {
      font-size: 20px;
      font-weight: 600;
      color: var(--ink);
    }

    .kpi span {
      color: var(--muted);
    }

    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    label {
      display: block;
      margin: 8px 0 4px;
      font-size: 13px;
      font-weight: 500;
      color: var(--ink);
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #252620;
      font-size: 13px;
      color: var(--ink);
    }

    input::placeholder {
      color: var(--muted);
    }

    /* Estilos para el componente web de Google Places */
    gmp-place-autocomplete {
      width: 100%;
      display: block;
    }

    gmp-place-autocomplete input {
      width: 100% !important;
      padding: 9px 10px !important;
      border-radius: 10px !important;
      border: 1px solid var(--line) !important;
      background: rgba(255, 255, 255, .1) !important;
      font-size: 13px !important;
      color: var(--ink) !important;
      backdrop-filter: blur(3px) !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
      box-sizing: border-box !important;
    }

    gmp-place-autocomplete input::placeholder {
      color: var(--muted) !important;
    }

    gmp-place-autocomplete input:focus {
      outline: 2px solid var(--venus) !important;
      outline-offset: -1px !important;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    .hidden {
      display: none !important;
    }

    .table-wrap {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      max-width: 100%;
      min-height: 200px;
      /* Asegurar altura mínima */
      position: relative;
    }

    /* Asegurar que el contenedor principal no se desborde */
    .wrap {
      max-width: 100%;
      overflow-x: hidden;
    }

    .card {
      max-width: 100%;
      overflow: visible;
      /* Cambiar de hidden a visible */
      min-height: fit-content;
    }

    /* Fix específico para panel de servicios */
    #panel-services,
    #panel-products {
      min-height: 400px;
      overflow: visible;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 13px;
      table-layout: auto;
      visibility: visible !important;
      opacity: 1 !important;
    }

    thead {
      background: rgba(255, 255, 255, .1);
      visibility: visible !important;
    }

    tbody {
      visibility: visible !important;
      min-height: 100px;
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, .1);
      text-align: left;
      white-space: nowrap;
      color: var(--ink);
      visibility: visible !important;
    }

    tr:last-child td {
      border-bottom: none;
    }

    code {
      font-size: 12px;
      background: rgba(255, 255, 255, .15);
      padding: 2px 4px;
      border-radius: 4px;
      color: var(--ink);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      background: #bbf7d0;
      color: #166534;
      font-size: 11px;
    }

    /* Estilos adaptados de index.html para la Gift Card */
    .gift-card-visual {
      background-color: #8c9668;
      /* Tu color original */
      border-radius: 20px;
      color: #fff;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      width: 100%;
      max-width: 320px;
      /* Tamaño proporcional para compartir */
      position: relative;
      overflow: hidden;
      text-align: center;
      margin: 0 auto;
      /* Centrado */
      font-family: 'Poppins', sans-serif;
    }

    .gift-card-visual::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.05), transparent 70%),
        radial-gradient(circle at 80% 60%, rgba(255, 255, 255, 0.04), transparent 60%);
      opacity: 0.7;
      z-index: 0;
    }

    .gift-card-content {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .gift-brand-logo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #fff;
      margin-bottom: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      object-fit: contain;
      padding: 2px;
    }

    .gift-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 5px 0;
    }

    .gift-service {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 10px 0 5px;
      color: #dfe6c1;
      /* Venus soft color */
    }

    .gift-meta {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 15px;
    }

    .gift-qr-container {
      background: #fff;
      padding: 10px;
      border-radius: 12px;
      margin-top: 10px;
      display: inline-block;
    }


    .gift-qr {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      background: #fff;
      padding: 8px;
      margin-bottom: 8px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0, 0, 0, .18);
      font-size: 11px;
      margin-top: 6px;
    }

    .gift-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .footer {
      margin-top: auto;
      text-align: center;
      padding: 8px 0 14px;
      font-size: 12px;
      color: var(--muted);
    }

    .success-message {
      background: rgba(187, 247, 208, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 10px;
      font-size: 13px;
      color: #bbf7d0;
    }

    dialog {
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: #1a1b18;
      color: var(--ink);
      padding: 24px;
      max-width: 480px;
      width: 92%;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.05);
      animation: dialogSlideIn 0.3s ease-out;
    }

    @keyframes dialogSlideIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
      }

      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }

    /* Bloquear scroll cuando el diálogo está abierto */
    body:has(dialog[open]) {
      overflow: hidden;
    }

    dialog[open] {
      display: flex;
      flex-direction: column;
    }

    /* ===== OFF-CANVAS MENU (Module Selection) ===== */
    .offcanvas {
      position: fixed;
      top: 0;
      right: -400px;
      width: 380px;
      height: 100vh;
      background: linear-gradient(135deg, rgba(27, 28, 26, 0.98), rgba(140, 150, 104, 0.1));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-left: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      overflow-y: auto;
      padding: 24px;
    }

    .offcanvas.open {
      right: 0;
    }

    .offcanvas-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .offcanvas-backdrop.show {
      opacity: 1;
      visibility: visible;
    }

    .offcanvas-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .offcanvas-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--venus-soft);
    }

    .module-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      transition: all 0.2s ease;
    }

    .module-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .module-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .module-icon {
      font-size: 20px;
    }

    .module-label {
      font-size: 14px;
      font-weight: 500;
      color: #f3f3f3;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.2);
      transition: .3s;
      border-radius: 34px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked+.toggle-slider {
      background-color: var(--venus-green);
      box-shadow: 0 0 8px rgba(140, 150, 104, 0.5);
    }

    .toggle-switch input:checked+.toggle-slider:before {
      transform: translateX(22px);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal-card {
      background: #1b1c1a;
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, .15);
      padding: 24px;
      max-width: 480px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, .4),
        0 0 0 1px rgba(255, 255, 255, .05) inset;
      color: #f9fafb;
      animation: modalSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--venus-soft);
    }

    .modal-body p {
      margin: 12px 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-body strong {
      font-weight: 600;
      min-width: 80px;
      color: var(--venus-soft);
    }

    .modal-footer {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* Mejorar botones del modal */
    .modal-footer .btn.small {
      border-radius: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .modal-footer .btn.small:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .modal-footer .btn.primary {
      background: linear-gradient(135deg, var(--venus-green), #a0b070);
      border: none;
    }

    .modal-footer .btn.success {
      box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
    }

    .modal-footer .btn.success:hover {
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
      background: #22c55e;
    }

    .modal-footer .btn.ghost {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-footer .btn.ghost:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .qr-box {
      margin-top: 10px;
      display: flex;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 10px;
    }

    .qr-box canvas {
      background: #fff;
      border-radius: 8px;
      padding: 8px;
      max-width: 100%;
      height: auto;
    }

    /* Estilos para debugging */
    .debug-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--line);
    }

    .debug-output {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 10px;
    }

    /* Estilos para el formulario de notificación individual */
    .notify-form-container {
      margin-top: 15px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(140, 150, 104, 0.08) 0%, rgba(140, 150, 104, 0.03) 100%);
      border: 1px solid rgba(140, 150, 104, 0.2);
      border-radius: 16px;
      animation: slideDown 0.3s ease-out;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Spinner animation for loading states */
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .notify-form-header {
      font-size: 15px;
      font-weight: 600;
      color: var(--venus-soft);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(140, 150, 104, 0.15);
    }

    .input-group {
      position: relative;
      margin-bottom: 12px;
    }

    .input-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      pointer-events: none;
      color: var(--venus-soft);
      opacity: 0.7;
    }

    .input-group textarea+.input-icon {
      top: 14px;
      transform: none;
    }

    .notify-input {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(140, 150, 104, 0.2);
      border-radius: 12px;
      padding: 12px 14px 12px 42px;
      color: #fff;
      font-size: 14px;
      transition: all 0.2s;
    }

    .notify-input:focus {
      border-color: var(--venus-soft);
      outline: none;
      background: rgba(0, 0, 0, 0.4);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.15);
    }

    .notify-textarea {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(140, 150, 104, 0.2);
      border-radius: 12px;
      padding: 12px 14px 12px 42px;
      color: #fff;
      font-size: 14px;
      min-height: 90px;
      resize: vertical;
      font-family: inherit;
      transition: all 0.2s;
    }

    .notify-textarea:focus {
      border-color: var(--venus-soft);
      outline: none;
      background: rgba(0, 0, 0, 0.4);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.15);
    }



    .automation-textarea:focus {
      outline: none;
      border-color: var(--venus-green);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.1);
    }

    .stat-money {
      font-variant-numeric: tabular-nums;
    }

    /* Payment functionality styles */
    .payment-indicator {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .payment-efectivo {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .payment-tarjeta {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .payment-transferencia {
      background: rgba(168, 85, 247, 0.2);
      color: #a855f7;
    }

    .payment-no_pagado {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .form-input.readonly {
      background: rgba(0, 0, 0, 0.2);
      cursor: not-allowed;
      opacity: 0.7;
    }

    .automation-history {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .automation-log-item {
      padding: 8px;
      margin-bottom: 6px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.5;
    }

    .modal-textarea:focus {
      outline: none;
      border-color: var(--venus-green);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.1);
    }

    /* ===== HISTORIAL DE CITAS SELECCIONABLE ===== */
    .client-history-panel {
      margin-top: 12px;
      background: rgba(140, 150, 104, 0.08);
      border: 1px solid rgba(140, 150, 104, 0.25);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .client-history-panel.hidden {
      display: none;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      cursor: pointer;
      transition: background 0.2s;
      user-select: none;
    }

    .history-header:hover {
      background: rgba(140, 150, 104, 0.12);
    }

    .history-toggle-icon {
      transition: transform 0.3s ease;
      font-size: 12px;
      color: var(--venus-soft);
    }

    .history-header.expanded .history-toggle-icon {
      transform: rotate(180deg);
    }

    .history-count {
      font-size: 12px;
      color: var(--venus-soft);
      font-weight: 600;
    }

    .history-hint {
      font-size: 11px;
      color: var(--muted);
      font-style: italic;
    }

    .history-content {
      border-top: 1px solid rgba(140, 150, 104, 0.15);
      max-height: 180px;
      overflow-y: auto;
    }

    .history-list {
      padding: 8px;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .history-item:last-child {
      margin-bottom: 0;
    }

    .history-item:hover {
      background: rgba(140, 150, 104, 0.2);
      border-color: var(--venus-soft);
    }

    .history-item:active {
      transform: scale(0.98);
    }

    .history-item-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .history-item-date {
      font-size: 11px;
      color: var(--muted);
    }

    .history-item-service {
      font-size: 13px;
      color: #fff;
      font-weight: 500;
    }

    .history-item-select {
      font-size: 11px;
      color: var(--venus-soft);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .history-item:hover .history-item-select {
      opacity: 1;
    }

    .history-empty {
      text-align: center;
      padding: 16px;
      color: var(--muted);
      font-size: 13px;
    }

    .history-item.selected {
      background: rgba(140, 150, 104, 0.3);
      border-color: var(--venus-soft);
    }

    .history-item.selected .history-item-select {
      opacity: 1;
      color: #22c55e;
    }

    /* ===== TABS SERVICIOS/PRODUCTOS ===== */
    #tab-services {
      max-width: 100%;
      overflow-x: hidden;
    }

    .tabs-header {
      display: flex;
      border-bottom: 1px solid var(--line);
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px 12px 0 0;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }

    .tab-btn {
      flex: 1;
      padding: 14px 20px;
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
    }

    .tab-btn:hover {
      color: var(--ink);
      background: rgba(255, 255, 255, 0.05);
    }

    .tab-btn.active {
      color: var(--venus-soft);
      background: rgba(140, 150, 104, 0.1);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--venus);
      border-radius: 3px 3px 0 0;
    }

    .tab-count {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }

    .tab-btn.active .tab-count {
      background: var(--venus);
      color: white;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* Productos */
    .product-cell {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .product-img {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .stock {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
    }

    .stock-ok {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .stock-low {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
    }

    .stock-out {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .stats-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-item {
      background: rgba(0, 0, 0, 0.2);
      padding: 12px 20px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-item .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--venus-soft);
    }

    .stat-item .stat-label {
      font-size: 11px;
      color: var(--muted);
    }

    .filter-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      padding: 6px 14px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chip:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--ink);
    }

    .chip.active {
      background: var(--venus);
      border-color: var(--venus);
      color: white;
    }

    .item-category {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    /* ===== FONT AWESOME ICONS ===== */
    .btn i {
      margin-right: 6px;
    }

    .btn.icon-only i {
      margin: 0;
    }

    h2 i,
    h3 i,
    h4 i {
      margin-right: 8px;
    }

    /* ===== GIFT CARDS ===== */
    .gc-layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 24px;
    }

    @media (max-width: 900px) {
      .gc-layout {
        grid-template-columns: 1fr;
      }
    }

    .gc-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .gc-stat {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 14px 18px;
      border: 1px solid var(--line);
    }

    .gc-stat-value {
      font-size: 26px;
      font-weight: 700;
      color: var(--venus-soft);
    }

    .gc-stat-label {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .gc-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 600px;
      overflow-y: auto;
    }

    .gc-item {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 14px 16px;
      border: 1px solid var(--line);
      display: grid;
      grid-template-columns: 44px 1fr auto;
      gap: 14px;
      align-items: start;
      transition: all 0.2s;
    }

    .gc-item:hover {
      background: rgba(0, 0, 0, 0.3);
      border-color: var(--venus);
    }

    .gc-item.expired {
      opacity: 0.5;
    }

    .gc-icon {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .gc-icon.pending {
      background: linear-gradient(135deg, var(--venus), var(--venus-soft));
      color: white;
    }

    .gc-icon.redeemed {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .gc-icon.expired {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .gc-info h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .gc-service {
      font-size: 13px;
      color: var(--venus-soft);
      margin-bottom: 6px;
    }

    .gc-meta {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .gc-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .gc-status {
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .gc-status.pending {
      background: rgba(140, 150, 104, 0.2);
      color: var(--venus-soft);
    }

    .gc-status.redeemed {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .gc-status.expired {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .gc-vigencia {
      margin-top: 8px;
    }

    .gc-vigencia-bar {
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 4px;
    }

    .gc-vigencia-progress {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s;
    }

    .gc-vigencia-progress.ok {
      background: #22c55e;
    }

    .gc-vigencia-progress.warning {
      background: #fbbf24;
    }

    .gc-vigencia-progress.danger {
      background: #ef4444;
    }

    .gc-vigencia-text {
      font-size: 10px;
      color: var(--muted);
    }

    .gc-redeemed-info {
      background: rgba(34, 197, 94, 0.1);
      border-radius: 6px;
      padding: 6px 10px;
      margin-top: 8px;
      font-size: 11px;
      color: #22c55e;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .gc-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .gc-actions .btn {
      padding: 6px 8px;
    }

    .gc-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .gc-tab {
      padding: 7px 14px;
      border-radius: 8px;
      background: transparent;
      border: 1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .gc-tab:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--ink);
    }

    .gc-tab.active {
      background: var(--venus);
      border-color: var(--venus);
      color: white;
    }

    .gc-tab-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 7px;
      border-radius: 10px;
      font-size: 10px;
    }

    .gc-preview {
      background: linear-gradient(135deg, rgba(90, 90, 66, 0.5) 0%, rgba(74, 74, 53, 0.5) 100%);
      border-radius: 14px;
      padding: 24px;
      text-align: center;
      margin-top: 16px;
      border: 1px solid var(--line);
    }

    .gc-preview-logo {
      font-size: 36px;
      margin-bottom: 10px;
    }

    .gc-preview h3 {
      font-size: 16px;
      color: var(--venus-soft);
      margin-bottom: 6px;
    }

    .gc-preview .gc-preview-service {
      font-size: 14px;
      color: var(--ink);
      margin-bottom: 14px;
    }

    .gc-preview-qr {
      width: 90px;
      height: 90px;
      background: white;
      border-radius: 10px;
      margin: 0 auto 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gc-preview-validity {
      font-size: 11px;
      color: var(--muted);
    }

    .gc-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    .gc-empty i {
      font-size: 40px;
      margin-bottom: 10px;
      opacity: 0.4;
    }

    /* Mobile Menu Styles */
    .mobile-actions {
      display: none;
      align-items: center;
      gap: 8px;
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: var(--ink);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }

    .mobile-menu-btn:active {
      opacity: 0.7;
      transform: scale(0.95);
    }

    .mobile-bell {
      display: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }

    .mobile-bell:active {
      opacity: 0.7;
      transform: scale(0.95);
    }

    .mobile-menu {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 3000;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }

    .mobile-menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: bold;
    }

    .close-menu-btn {
      background: none;
      border: none;
      color: var(--ink);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }

    .close-menu-btn:active {
      opacity: 0.7;
      transform: scale(0.95);
    }

    .mobile-nav-link {
      display: block;
      padding: 12px;
      color: var(--ink);
      text-decoration: none;
      font-size: 16px;
      border-radius: 8px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      margin-bottom: 8px;
    }

    .mobile-nav-link:hover,
    .mobile-nav-link.is-active {
      background: rgba(255, 255, 255, 0.1);
    }

    @media (max-width: 768px) {
      .desktop-only {
        display: none !important;
      }

      .mobile-actions {
        display: flex;
      }

      .mobile-menu-btn {
        display: block;
      }

      .mobile-bell {
        display: block;
      }

      /* Mobile notification dropdown */
      .notification-dropdown {
        position: fixed;
        top: 60px;
        left: 10px;
        right: 10px;
        width: auto;
        max-width: none;
      }
    }

    /* ===== NOTIFICACIONES - CAMPANA ===== */
    .notification-wrapper {
      position: relative;
    }

    .notification-bell {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 10px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      position: relative;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }

    .notification-bell:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--ink);
    }

    .notification-bell:active {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(0.95);
    }

    .notification-bell i {
      font-size: 20px;
    }

    .notification-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      min-width: 18px;
      height: 18px;
      background: #ef4444;
      color: white;
      font-size: 10px;
      font-weight: 700;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 5px;
      animation: pulse-badge 2s infinite;
    }

    .notification-badge.hidden {
      display: none;
    }

    @keyframes pulse-badge {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }
    }

    .notification-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      width: 380px;
      max-width: calc(100vw - 40px);
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      display: none;
      overflow: hidden;
    }

    .notification-dropdown.active {
      display: block;
      animation: dropdownIn 0.2s ease;
    }

    @keyframes dropdownIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .notification-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notification-header h3 {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
    }

    .notification-header h3 i {
      font-size: 16px;
    }

    .btn-mark-read {
      background: none;
      border: none;
      color: var(--venus-soft);
      font-size: 12px;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .btn-mark-read:hover {
      background: rgba(140, 150, 104, 0.1);
    }

    .btn-mark-read i {
      font-size: 14px;
    }

    .notification-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 14px 20px;
      border-bottom: 1px solid var(--line);
      display: flex;
      gap: 12px;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-item:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .notification-item.unread {
      background: rgba(140, 150, 104, 0.08);
    }

    .notification-item.unread::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 6px;
      background: var(--venus);
      border-radius: 50%;
    }

    .notification-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 18px;
    }

    .notification-icon.cita {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
    }

    .notification-icon.venta {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .notification-icon.tarjeta {
      background: rgba(140, 150, 104, 0.15);
      color: var(--venus-soft);
    }

    .notification-icon.sello {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
    }

    .notification-icon.giftcard {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
    }

    .notification-icon.cumple {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .notification-icon.cumpleaños {
      background: rgba(236, 72, 153, 0.15);
      color: #ec4899;
    }

    .notification-icon.premio {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .notification-icon.stock {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
    }

    .notification-icon.alerta {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .notification-title .new-tag {
      background: var(--venus);
      color: white;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }

    .notification-message {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .notification-time {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .notification-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--muted);
    }

    /* ===== GOOGLE CALENDAR STYLES ===== */
    .google-calendar-container {
      background: var(--card);
      border-radius: var(--radius);
      padding: 0;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--line);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(135deg, var(--bg) 0%, #2a2a2a 100%);
      border-radius: var(--radius) var(--radius) 0 0;
    }

    .calendar-title-section {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .calendar-title-section h2 {
      margin: 0;
      font-size: 24px;
      font-weight: 400;
      color: var(--ink);
    }

    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .btn-nav {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--ink);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 36px;
    }

    .btn-nav:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .calendar-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .view-selector {
      display: flex;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 2px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .view-btn {
      background: none;
      border: none;
      color: var(--muted);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .view-btn.active {
      background: var(--venus);
      color: white;
    }

    .view-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.1);
      color: var(--ink);
    }

    .calendar-grid-container {
      display: block;
      padding: 0;
      width: 100%;
      overflow: hidden;
    }

    .weekdays-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: #1b1c1a;
      border-bottom: 1px solid var(--line);
      width: 100%;
      box-sizing: border-box;
      border-radius: 12px 12px 0 0;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .weekday {
      padding: 14px 8px;
      text-align: center;
      font-size: 12px;
      font-weight: 700;
      color: var(--venus-soft);
      text-transform: uppercase;
      letter-spacing: 1px;
      border-right: 1px solid var(--line);
      background: rgba(140, 150, 104, 0.05);
    }

    .weekday:last-child {
      border-right: none;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: var(--bg);
      width: 100%;
      box-sizing: border-box;
    }

    .calendar-day {
      min-height: 100px;
      border-right: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      padding: 8px;
      position: relative;
      cursor: pointer;
      transition: background-color 0.15s;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.03);
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(140, 150, 104, 0.3);
      user-select: none;
    }

    .calendar-day:hover {
      background-color: rgba(255, 255, 255, 0.08);
    }

    .calendar-day:active {
      background-color: rgba(140, 150, 104, 0.3);
    }

    .calendar-day.selected {
      background-color: rgba(140, 150, 104, 0.2);
      border-color: var(--venus);
    }

    .calendar-day.other-month {
      background-color: rgba(0, 0, 0, 0.2);
      opacity: 0.5;
    }

    .calendar-day.today {
      background-color: rgba(140, 150, 104, 0.15);
    }

    .calendar-day.today .day-number {
      background: var(--venus);
      color: white;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .day-number {
      font-size: 14px;
      font-weight: 500;
      color: var(--ink);
      margin-bottom: 4px;
      align-self: flex-start;
    }

    .day-events {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
      overflow: hidden;
    }

    .calendar-event {
      background: var(--venus);
      color: white;
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.15s, box-shadow 0.15s;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(140, 150, 104, 0.3);
      user-select: none;
    }

    .calendar-event:hover {
      filter: brightness(1.1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .calendar-event:active {
      transform: scale(0.97);
      filter: brightness(0.95);
    }

    .calendar-event.confirmed {
      background: #22c55e;
    }

    .calendar-event.cancelled {
      background: #ef4444;
      opacity: 0.6;
    }

    .calendar-event.pending,
    .calendar-event.scheduled {
      background: #f59e0b;
    }

    .event-more {
      color: var(--muted);
      font-size: 10px;
      margin-top: 2px;
      cursor: pointer;
    }

    .event-more:hover {
      color: var(--venus);
    }

    /* ===== RESPONSIVE CALENDAR (Inspirado en Apple Calendar iOS 18) ===== */

    /* Tablet Landscape (900-1200px) */
    @media (max-width: 1200px) {
      .calendar-day {
        min-height: 90px;
        padding: 6px;
      }

      .calendar-event {
        font-size: 10px;
        padding: 2px 4px;
      }

      .day-number {
        font-size: 13px;
      }
    }

    /* Tablet Portrait / iPad (600-900px) - Vista Compacta */
    @media (max-width: 900px) {
      .google-calendar-container {
        padding: 12px;
      }

      .calendar-header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }

      .calendar-title-section {
        justify-content: space-between;
      }

      .calendar-title-section h2 {
        font-size: 22px;
      }

      .calendar-actions {
        justify-content: space-between;
      }

      .calendar-day {
        min-height: 70px;
        padding: 4px;
      }

      .day-number {
        font-size: 12px;
        width: 24px;
        height: 24px;
        line-height: 24px;
      }

      .weekday {
        padding: 10px 4px;
        font-size: 10px;
      }

      /* Ocultar texto de eventos, mostrar solo indicadores */
      .calendar-event {
        font-size: 0;
        padding: 0;
        height: 4px;
        min-height: 4px;
        border-radius: 2px;
        margin: 1px 0;
      }

      .calendar-event::before {
        content: none;
      }

      .event-more {
        font-size: 9px;
      }
    }

    /* Móvil (<600px) - Vista Ultra Compacta */
    @media (max-width: 600px) {
      .google-calendar-container {
        padding: 8px;
        border-radius: 12px;
      }

      .calendar-header {
        gap: 8px;
        padding-bottom: 8px;
      }

      .calendar-title-section h2 {
        font-size: 18px;
      }

      .calendar-nav button {
        width: 32px;
        height: 32px;
        font-size: 12px;
      }

      .calendar-actions {
        flex-wrap: wrap;
        gap: 6px;
      }

      .calendar-actions .btn {
        padding: 6px 10px;
        font-size: 11px;
      }

      .weekday {
        padding: 8px 2px;
        font-size: 9px;
        letter-spacing: 0;
      }

      .calendar-day {
        min-height: 52px;
        padding: 3px;
      }

      .day-number {
        font-size: 11px;
        width: 22px;
        height: 22px;
        line-height: 22px;
      }

      /* Solo mostrar dots de colores para eventos */
      .calendar-event {
        height: 5px;
        width: 5px;
        min-height: 5px;
        border-radius: 50%;
        margin: 1px;
        display: inline-block;
      }

      .calendar-events-container {
        display: flex;
        flex-wrap: wrap;
        gap: 2px;
        justify-content: center;
      }

      .event-more {
        display: none;
      }

      /* Indicador de día seleccionado más visible */
      .calendar-day.selected {
        background: rgba(140, 150, 104, 0.25);
        box-shadow: inset 0 0 0 2px var(--venus);
      }

      .calendar-day.today .day-number {
        background: var(--venus);
        color: white;
        font-weight: 700;
      }
    }

    /* Extra pequeño (<400px) */
    @media (max-width: 400px) {
      .calendar-title-section h2 {
        font-size: 16px;
      }

      .calendar-nav button {
        width: 28px;
        height: 28px;
        font-size: 10px;
      }

      .calendar-day {
        min-height: 44px;
        padding: 2px;
      }

      .day-number {
        font-size: 10px;
        width: 20px;
        height: 20px;
        line-height: 20px;
      }

      .weekday {
        padding: 6px 1px;
        font-size: 8px;
      }
    }

    .notification-empty i {
      font-size: 40px;
      margin-bottom: 12px;
      opacity: 0.4;
    }

    .notification-empty p {
      font-size: 13px;
      margin: 0;
    }

    .notification-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--line);
      text-align: center;
    }

    .notification-footer button {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
    }

    .notification-footer button:hover {
      color: var(--venus-soft);
      text-decoration: underline;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <!-- Firebase removido - ahora usamos PostgreSQL -->
  <!-- Chart.js for Reports -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="checking-auth">

  <main class="wrap">
    <header class="topbar">
      <div class="brand">
        <img src="/assets/logo.png" alt="Venus">
        <div>
          <h1>Admin — Venus Lealtad</h1>
          <div class="muted" id="me-line">Sesión iniciada</div>
        </div>
      </div>
      <!-- Campana y menú móvil -->
      <div class="mobile-actions">
        <button class="notification-bell mobile-bell" id="notif-btn-mobile" title="Notificaciones"
          onclick="toggleNotifications(event)"></button>
        <i class="fas fa-bell"></i>
        <span class="notification-badge hidden" id="notif-badge-mobile">0</span>
        </button>
        <button class="mobile-menu-btn" id="mobile-menu-toggle" onclick="openMobileMenu()"><i
            class="fas fa-bars"></i></button>
      </div>

      <!-- Acciones desktop -->
      <div class="actions desktop-only">
        <!-- Campana de Notificaciones -->
        <div class="notification-wrapper">
          <button class="notification-bell" id="notif-btn-desktop" title="Notificaciones">
            <i class="fas fa-bell"></i>
            <span class="notification-badge hidden" id="notif-badge">0</span>
          </button>

          <div class="notification-dropdown" id="notif-dropdown">
            <div class="notification-header">
              <h3><i class="fas fa-bell"></i> Notificaciones</h3>
              <button class="btn-mark-read" id="btn-mark-all-read">
                <i class="fas fa-check-double"></i> Marcar leídas
              </button>
            </div>

            <div class="notification-list" id="notif-list">
              <div class="notification-empty">
                <i class="fas fa-bell-slash"></i>
                <p>No hay notificaciones</p>
              </div>
            </div>

            <div class="notification-footer">
              <button id="btn-clear-all-notif">Limpiar todas</button>
            </div>
          </div>
        </div>

        <a class="btn" href="/" target="_blank" rel="noopener">Página clientes</a>
        <button id="logout" class="btn">Cerrar sesión</button>
      </div>
    </header>

    <div class="mobile-menu hidden" id="mobile-menu">
      <div class="mobile-menu-header">
        <span>Menú</span>
        <button class="close-menu-btn" id="mobile-menu-close" onclick="closeMobileMenu()"><i
            class="fas fa-times"></i></button>
      </div>
      <div class="mobile-menu-content">
        <a href="#overview" class="mobile-nav-link" data-tab="overview"><i class="fas fa-th-large"></i> Resumen</a>
        <a href="#cards" class="mobile-nav-link" data-tab="cards"><i class="fas fa-credit-card"></i> Tarjetas</a>
        <a href="#events" class="mobile-nav-link" data-tab="events"><i class="fas fa-gift"></i> Gift Cards</a>
        <a href="#notifications" class="mobile-nav-link" data-tab="notifications"><i class="fas fa-bell"></i>
          Notificaciones</a>
        <a href="#requests" class="mobile-nav-link" data-tab="requests"><i class="fas fa-inbox"></i> Solicitudes</a>
        <a href="#appointments" class="mobile-nav-link" data-tab="appointments"><i class="fas fa-calendar"></i>
          Citas</a>
        <a href="#reports" class="mobile-nav-link" data-tab="reports"><i class="fas fa-chart-line"></i> Reportes</a>
        <a href="#services" class="mobile-nav-link" data-tab="services"><i class="fas fa-sparkles"></i> Servicios</a>
        <a href="#settings" class="mobile-nav-link" data-tab="settings"><i class="fas fa-cog"></i> Configuración</a>
        <hr style="border-color:rgba(255,255,255,0.1);margin:10px 0;">
        <a href="/" target="_blank" class="mobile-nav-link"><i class="fas fa-external-link-alt"></i> Página clientes</a>
        <button id="logout-mobile" class="mobile-nav-link"
          style="width:100%;text-align:left;background:none;border:none;color:var(--ink);font-size:16px;padding:12px;"><i
            class="fas fa-sign-out-alt"></i> Cerrar sesión</button>
      </div>
    </div>

    <nav class="nav desktop-only">
      <a href="#overview" data-tab="overview" class="is-active"><i class="fas fa-th-large"></i> Resumen</a>
      <a href="#cards" data-tab="cards"><i class="fas fa-credit-card"></i> Tarjetas</a>
      <a href="#events" data-tab="events"><i class="fas fa-gift"></i> Gift Cards</a>
      <a href="#notifications" data-tab="notifications"><i class="fas fa-bell"></i> Notificaciones</a>
      <a href="#requests" data-tab="requests"><i class="fas fa-inbox"></i> Solicitudes</a>
      <a href="#appointments" data-tab="appointments"><i class="fas fa-calendar"></i> Citas</a>
      <a href="#reports" data-tab="reports"><i class="fas fa-chart-line"></i> Reportes</a>
      <a href="#services" data-tab="services"><i class="fas fa-sparkles"></i> Servicios</a>
      <a href="#settings" data-tab="settings"><i class="fas fa-cog"></i> Configuración</a>
    </nav>

    <!-- TAB: Overview - MODIFICADO CON FILTROS Y REPORTES -->
    <section id="tab-overview" class="tab-content">
      <div class="header-actions" style="margin-bottom:20px;">
        <h2 id="dash-greeting">Buenos días</h2>
        <div style="display:flex;gap:10px;">
          <button class="btn small ghost" onclick="loadTodayStats(); loadGiftCardStats();" title="Actualizar">
            <i class="fas fa-sync"></i>
          </button>
          <button class="btn primary" onclick="newApptDialog.showModal()">
            <i class="fas fa-plus"></i> Nueva Cita
          </button>
        </div>
      </div>

      <!-- Hero Stats -->
      <div class="hero-stats">
        <div class="hero-stat">
          <div class="hero-stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="hero-stat-value" id="stat-total-clients">0</div>
          <div class="hero-stat-label">Clientes activos</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-icon">
            <i class="fas fa-star"></i>
          </div>
          <div class="hero-stat-value" id="stat-stamps-month">0</div>
          <div class="hero-stat-label">Sellos este mes</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-icon">
            <i class="fas fa-gift"></i>
          </div>
          <div class="hero-stat-value" id="stat-redeems-month">0</div>
          <div class="hero-stat-label">Canjes este mes</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-icon">
            <i class="fas fa-trophy"></i>
          </div>
          <div class="hero-stat-value" id="stat-return-rate">0%</div>
          <div class="hero-stat-label">Tasa de retorno</div>
        </div>
      </div>

      <!-- Sección HOY -->
      <div class="today-grid">
        <div class="today-card" onclick="switchTab('tab-appointments')" style="cursor:pointer;">
          <div class="today-card-icon citas">
            <i class="fas fa-calendar-check"></i>
          </div>
          <div class="today-card-info">
            <h4 id="today-appointments">0</h4>
            <p>Citas hoy</p>
          </div>
        </div>
        <div class="today-card" onclick="switchTab('tab-appointments')" style="cursor:pointer;">
          <div class="today-card-icon pendientes">
            <i class="fas fa-clock"></i>
          </div>
          <div class="today-card-info">
            <h4 id="today-pending">0</h4>
            <p>Por confirmar</p>
          </div>
        </div>
        <div class="today-card" onclick="switchTab('tab-appointments')" style="cursor:pointer;">
          <div class="today-card-icon ingresos">
            <i class="fas fa-dollar-sign"></i>
          </div>
          <div class="today-card-info">
            <h4 id="today-income">$0</h4>
            <p>Ingresos hoy</p>
          </div>
        </div>
      </div>

      <!-- Grid principal con sidebar -->
      <div class="dash-grid">
        <!-- Columna principal (vacía por ahora, se llenará en Fase 3) -->
        <div class="dash-main">
          <div class="card">
            <div class="card-header">
              <span class="card-title">
                <i class="fas fa-chart-line"></i> Actividad reciente
              </span>
            </div>
            <div class="card-body">
              <div style="position: relative; height: 250px; width: 100%;">
                <canvas id="activity-chart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar derecho -->
        <div class="dash-sidebar">
          <!-- Gift Cards -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">
                <i class="fas fa-gift"></i> Gift Cards
              </span>
              <a href="#" class="card-header-link" onclick="switchTab('tab-events');return false;">
                Ver todas <i class="fas fa-chevron-right"></i>
              </a>
            </div>
            <div class="card-body" style="padding:16px;">
              <div class="gc-summary">
                <div class="gc-summary-row">
                  <span class="gc-dot pending"></span>
                  <span class="gc-label">Pendientes</span>
                  <span class="gc-value" id="gc-pending">0</span>
                </div>
                <div class="gc-summary-row">
                  <span class="gc-dot expiring"></span>
                  <span class="gc-label">Por vencer (7 días)</span>
                  <span class="gc-value warning" id="gc-expiring">0</span>
                </div>
                <div class="gc-summary-row">
                  <span class="gc-dot redeemed"></span>
                  <span class="gc-label">Canjeadas este mes</span>
                  <span class="gc-value" id="gc-redeemed">0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Cumpleaños -->
          <div class="card" id="card-birthdays">
            <div class="card-header">
              <span class="card-title">
                <i class="fas fa-birthday-cake"></i> Cumpleaños
              </span>
            </div>
            <div class="card-body" style="padding:16px;">
              <div class="birthday-list" id="birthday-list">
                <div class="dash-empty">
                  <p>Sin cumpleaños próximos</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Top Clientes -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">
                <i class="fas fa-trophy"></i> Top Clientes
              </span>
            </div>
            <div class="card-body" style="padding:12px 16px;">
              <div id="top-clients-sidebar">
                <div class="dash-empty">
                  <p>Sin datos aún</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Wallets -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">
                <i class="fas fa-wallet"></i> Wallets
              </span>
            </div>
            <div class="card-body" style="padding:16px;">
              <div class="wallets-grid">
                <div class="wallet-card">
                  <div class="wallet-card-icon"><i class="fab fa-apple"></i></div>
                  <div class="wallet-card-value" id="wallet-apple">0</div>
                  <div class="wallet-card-label">Apple Wallet</div>
                </div>
                <div class="wallet-card">
                  <div class="wallet-card-icon"><i class="fab fa-google"></i></div>
                  <div class="wallet-card-value" id="wallet-google">0</div>
                  <div class="wallet-card-label">Google Wallet</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </section>

    <!-- TAB: Cards -->
    <section id="tab-cards" class="card hidden">
      <h2>Tarjetas de lealtad</h2>
      <p class="muted">Gestiona todas las tarjetas de tus clientes.</p>

      <!-- KPI CUMPLEAÑOS -->
      <div id="birthday-section" class="hidden"
        style="margin: 15px 0; padding: 15px; background: rgba(255, 209, 102, 0.1); border: 1px solid rgba(255, 209, 102, 0.3); border-radius: 12px;">
        <div class="row" style="justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;"><i class="fas fa-birthday-cake"></i></span>
            <div>
              <h3 style="margin: 0; color: #ffd166;">Cumpleaños Cercanos</h3>
              <p class="muted" style="margin: 2px 0 0; font-size: 13px;">Clientes que cumplen años en los próximos 7
                días.</p>
            </div>
          </div>
          <div id="birthday-actions">
            <!-- Se llenará dinámicamente -->
          </div>
        </div>
        <div id="birthday-list" style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
          <!-- Lista de cumpleañeros -->
        </div>
      </div>

      <div class="row" style="margin-top:12px; align-items: center;">
        <input id="search-cards" placeholder="Buscar por nombre o teléfono..." style="flex:1;min-width:200px;">

        <!-- SORTING CONTROLS -->
        <select id="sort-cards" class="filter-select">
          <option value="created_at:desc">Recientes</option>
          <option value="created_at:asc">Antiguos</option>
          <option value="name:asc">Nombre (A-Z)</option>
          <option value="name:desc">Nombre (Z-A)</option>
          <option value="stamps:desc">Más sellos</option>
          <option value="stamps:asc">Menos sellos</option>
          <option value="last_visit:desc">Última visita</option>
        </select>

        <button id="btn-search-cards" class="btn primary"><i class="fas fa-search"></i> Buscar</button>
        <button id="btn-reload-cards" class="btn"><i class="fas fa-sync-alt"></i> Recargar</button>
        <button id="btn-scan-card" class="btn ghost"><i class="fas fa-qrcode"></i> Escanear QR</button>
      </div>

      <div class="table-wrap" style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Teléfono</th>
              <th>Última Visita</th>
              <th>Sellos</th>
              <th style="width:120px;">Acciones</th>
            </tr>
          </thead>
          <tbody id="cards-tbody">
            <tr>
              <td colspan="5" style="text-align:center;padding:12px;" class="muted">Cargando tarjetas...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:12px;">
        <button id="btn-prev-page" class="btn small ghost">← Anterior</button>
        <span id="page-info" class="muted">Página 1</span>
        <button id="btn-next-page" class="btn small ghost">Siguiente →</button>
      </div>
    </section>

    <!-- TAB: Gift Cards -->
    <section id="tab-events" class="tab-content hidden">
      <div class="header-actions">
        <h2><i class="fas fa-gift"></i> Gift Cards</h2>
        <button class="btn ghost" id="btn-scan-gift-card">
          <i class="fas fa-qrcode"></i> Escanear QR
        </button>
      </div>

      <!-- Stats -->
      <div class="gc-stats">
        <div class="gc-stat">
          <div class="gc-stat-value" id="gc-stat-total">0</div>
          <div class="gc-stat-label"><i class="fas fa-gift"></i> Total</div>
        </div>
        <div class="gc-stat">
          <div class="gc-stat-value" id="gc-stat-pending" style="color:var(--venus-soft);">0</div>
          <div class="gc-stat-label"><i class="fas fa-clock"></i> Pendientes</div>
        </div>
        <div class="gc-stat">
          <div class="gc-stat-value" id="gc-stat-redeemed" style="color:#22c55e;">0</div>
          <div class="gc-stat-label"><i class="fas fa-check-circle"></i> Canjeadas</div>
        </div>
        <div class="gc-stat">
          <div class="gc-stat-value" id="gc-stat-expired" style="color:#ef4444;">0</div>
          <div class="gc-stat-label"><i class="fas fa-times-circle"></i> Expiradas</div>
        </div>
      </div>

      <!-- Layout 2 columnas -->
      <div class="gc-layout">

        <!-- Columna izquierda: Crear -->
        <div class="card">
          <h3 style="font-size:15px;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
            <i class="fas fa-plus-circle"></i> Crear Gift Card
          </h3>

          <form id="form-giftcard">
            <div class="form-group">
              <label class="form-label">Para quién es (opcional)</label>
              <input type="text" id="gc-recipient" class="form-input" placeholder="Nombre del destinatario">
            </div>

            <div class="form-group">
              <label class="form-label">Servicio a regalar</label>
              <select id="gc-service" class="form-input" required>
                <option value="">Seleccionar servicio...</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Mensaje personalizado (opcional)</label>
              <input type="text" id="gc-message" class="form-input" placeholder="Ej: ¡Feliz cumpleaños!"
                maxlength="100">
            </div>

            <div class="form-group">
              <label class="form-label">Vigencia</label>
              <select id="gc-validity" class="form-input">
                <option value="30">30 días</option>
                <option value="60">60 días</option>
                <option value="90">90 días</option>
              </select>
            </div>

            <button type="submit" class="btn primary" style="width:100%;">
              <i class="fas fa-sparkles"></i> Generar Gift Card
            </button>
          </form>

          <!-- Preview -->
          <div class="gc-preview" id="gc-preview">
            <div class="gc-preview-logo">🎁</div>
            <h3>Gift Card Venus</h3>
            <div class="gc-preview-service" id="gc-preview-service">Selecciona un servicio</div>
            <div class="gc-preview-qr">
              <i class="fas fa-qrcode" style="font-size:50px;color:#333;"></i>
            </div>
            <div class="gc-preview-validity" id="gc-preview-validity">Válida por 30 días</div>
          </div>
        </div>

        <!-- Columna derecha: Lista -->
        <div class="card">
          <div
            style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px;">
            <h3 style="font-size:15px;display:flex;align-items:center;gap:8px;">
              <i class="fas fa-list"></i> Gift Cards
            </h3>
            <input type="text" id="gc-search" class="form-input" placeholder="Buscar..."
              style="width:180px;padding:8px 12px;">
          </div>

          <!-- Tabs -->
          <div class="gc-tabs">
            <button class="gc-tab active" data-filter="all">
              Todas <span class="gc-tab-count" id="gc-count-all">0</span>
            </button>
            <button class="gc-tab" data-filter="pending">
              <i class="fas fa-clock"></i> Pendientes <span class="gc-tab-count" id="gc-count-pending">0</span>
            </button>
            <button class="gc-tab" data-filter="redeemed">
              <i class="fas fa-check"></i> Canjeadas <span class="gc-tab-count" id="gc-count-redeemed">0</span>
            </button>
            <button class="gc-tab" data-filter="expired">
              <i class="fas fa-times"></i> Expiradas <span class="gc-tab-count" id="gc-count-expired">0</span>
            </button>
          </div>

          <!-- Lista -->
          <div class="gc-list" id="gc-list">
            <div class="gc-empty">
              <i class="fas fa-gift"></i>
              <p>No hay gift cards</p>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Modal Ver Gift Card -->
    <div id="modal-giftcard-view" class="modal-backdrop hidden">
      <div class="modal-card" style="max-width:420px;">
        <div class="modal-header">
          <h3><i class="fas fa-gift"></i> Gift Card</h3>
          <button class="btn small ghost" onclick="closeGiftCardModal()"><i class="fas fa-times"></i></button>
        </div>
        <div id="modal-giftcard-content" style="padding:0;">
          <!-- Contenido dinámico con diseño personalizado -->
        </div>
        <div class="modal-footer" style="justify-content:center;gap:8px;flex-wrap:wrap;">
          <button class="btn ghost" onclick="downloadGiftCardImage()">
            <i class="fas fa-download"></i> Descargar
          </button>
          <button class="btn ghost" onclick="copyGiftCardLink()">
            <i class="fas fa-link"></i> Copiar link
          </button>
          <button class="btn primary" onclick="sendGiftCardWhatsAppImage()">
            <i class="fab fa-whatsapp"></i> WhatsApp
          </button>
        </div>
      </div>
    </div>

    <!-- TAB: Settings - MEJORADO CON DEBUGGING -->
    <section id="tab-settings" class="card hidden">
      <h2>Configuración</h2>

      <!-- Configuración del Negocio -->
      <div
        style="background:rgba(140,150,104,0.1);border:1px solid rgba(140,150,104,0.3);border-radius:12px;padding:14px;margin:12px 0;">
        <h3 style="margin:0 0 12px;"><i class="fas fa-store"></i> Datos del Negocio</h3>
        <p class="muted" style="margin:0 0 16px;font-size:12px;">Esta información se muestra en la página de agendar
          citas.</p>

        <form id="business-config-form">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <label>Nombre del negocio</label>
              <input id="biz-name" placeholder="Venus Estética" required>
            </div>
            <div>
              <label>WhatsApp del negocio</label>
              <input id="biz-whatsapp" placeholder="524271234567" required>
              <small class="muted">Formato: código país + número (sin +)</small>
            </div>
          </div>

          <label style="margin-top:12px;">Dirección</label>
          <div style="position:relative;">
            <!-- Nuevo componente web de Places API -->
            <gmp-place-autocomplete id="biz-address-autocomplete"
              placeholder="Ej: Cactus 50, San Juan del Río, Querétaro">
            </gmp-place-autocomplete>
            <input type="hidden" id="biz-address">
          </div>
          <small class="muted">Escribe tu dirección y selecciona una sugerencia del menú</small>

          <label style="margin-top:12px;">URL de Google Maps</label>
          <input id="biz-maps-url" type="url" placeholder="https://www.google.com/maps/search/..." readonly>
          <small class="muted">Este enlace se genera automáticamente basado en tu dirección</small>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
            <div>
              <label>Horario apertura</label>
              <select id="biz-open" class="form-input">
                <option value="00:00">00:00</option>
                <option value="00:30">00:30</option>
                <option value="01:00">01:00</option>
                <option value="01:30">01:30</option>
                <option value="02:00">02:00</option>
                <option value="02:30">02:30</option>
                <option value="03:00">03:00</option>
                <option value="03:30">03:30</option>
                <option value="04:00">04:00</option>
                <option value="04:30">04:30</option>
                <option value="05:00">05:00</option>
                <option value="05:30">05:30</option>
                <option value="06:00">06:00</option>
                <option value="06:30">06:30</option>
                <option value="07:00">07:00</option>
                <option value="07:30">07:30</option>
                <option value="08:00">08:00</option>
                <option value="08:30">08:30</option>
                <option value="09:00" selected>09:00</option>
                <option value="09:30">09:30</option>
                <option value="10:00">10:00</option>
                <option value="10:30">10:30</option>
                <option value="11:00">11:00</option>
                <option value="11:30">11:30</option>
                <option value="12:00">12:00</option>
                <option value="12:30">12:30</option>
                <option value="13:00">13:00</option>
                <option value="13:30">13:30</option>
                <option value="14:00">14:00</option>
                <option value="14:30">14:30</option>
                <option value="15:00">15:00</option>
                <option value="15:30">15:30</option>
                <option value="16:00">16:00</option>
                <option value="16:30">16:30</option>
                <option value="17:00">17:00</option>
                <option value="17:30">17:30</option>
                <option value="18:00">18:00</option>
                <option value="18:30">18:30</option>
                <option value="19:00">19:00</option>
                <option value="19:30">19:30</option>
                <option value="20:00">20:00</option>
                <option value="20:30">20:30</option>
                <option value="21:00">21:00</option>
                <option value="21:30">21:30</option>
                <option value="22:00">22:00</option>
                <option value="22:30">22:30</option>
                <option value="23:00">23:00</option>
                <option value="23:30">23:30</option>
              </select>
            </div>
            <div>
              <label>Horario cierre</label>
              <select id="biz-close" class="form-input">
                <option value="00:00">00:00</option>
                <option value="00:30">00:30</option>
                <option value="01:00">01:00</option>
                <option value="01:30">01:30</option>
                <option value="02:00">02:00</option>
                <option value="02:30">02:30</option>
                <option value="03:00">03:00</option>
                <option value="03:30">03:30</option>
                <option value="04:00">04:00</option>
                <option value="04:30">04:30</option>
                <option value="05:00">05:00</option>
                <option value="05:30">05:30</option>
                <option value="06:00">06:00</option>
                <option value="06:30">06:30</option>
                <option value="07:00">07:00</option>
                <option value="07:30">07:30</option>
                <option value="08:00">08:00</option>
                <option value="08:30">08:30</option>
                <option value="09:00">09:00</option>
                <option value="09:30">09:30</option>
                <option value="10:00">10:00</option>
                <option value="10:30">10:30</option>
                <option value="11:00">11:00</option>
                <option value="11:30">11:30</option>
                <option value="12:00">12:00</option>
                <option value="12:30">12:30</option>
                <option value="13:00">13:00</option>
                <option value="13:30">13:30</option>
                <option value="14:00">14:00</option>
                <option value="14:30">14:30</option>
                <option value="15:00">15:00</option>
                <option value="15:30">15:30</option>
                <option value="16:00">16:00</option>
                <option value="16:30">16:30</option>
                <option value="17:00">17:00</option>
                <option value="17:30">17:30</option>
                <option value="18:00">18:00</option>
                <option value="18:30">18:30</option>
                <option value="19:00" selected>19:00</option>
                <option value="19:30">19:30</option>
                <option value="20:00">20:00</option>
                <option value="20:30">20:30</option>
                <option value="21:00">21:00</option>
                <option value="21:30">21:30</option>
                <option value="22:00">22:00</option>
                <option value="22:30">22:30</option>
                <option value="23:00">23:00</option>
                <option value="23:30">23:30</option>
              </select>
            </div>
          </div>

          <label style="margin-top:12px;">Días de trabajo</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
            <input type="checkbox" id="biz-day-1" class="day-checkbox" checked>
            <label for="biz-day-1" class="day-label">
              <span class="checkmark">✓</span> Lun
            </label>

            <input type="checkbox" id="biz-day-2" class="day-checkbox" checked>
            <label for="biz-day-2" class="day-label">
              <span class="checkmark">✓</span> Mar
            </label>

            <input type="checkbox" id="biz-day-3" class="day-checkbox" checked>
            <label for="biz-day-3" class="day-label">
              <span class="checkmark">✓</span> Mié
            </label>

            <input type="checkbox" id="biz-day-4" class="day-checkbox" checked>
            <label for="biz-day-4" class="day-label">
              <span class="checkmark">✓</span> Jue
            </label>

            <input type="checkbox" id="biz-day-5" class="day-checkbox" checked>
            <label for="biz-day-5" class="day-label">
              <span class="checkmark">✓</span> Vie
            </label>

            <input type="checkbox" id="biz-day-6" class="day-checkbox" checked>
            <label for="biz-day-6" class="day-label">
              <span class="checkmark">✓</span> Sáb
            </label>

            <input type="checkbox" id="biz-day-0" class="day-checkbox">
            <label for="biz-day-0" class="day-label">
              <span class="checkmark">✓</span> Dom
            </label>
          </div>

          <div style="margin-top:14px;">
            <button type="submit" class="btn primary"><i class="fas fa-save"></i> Guardar configuración</button>
          </div>
        </form>

        <div id="biz-success" class="success-message hidden" style="margin-top:12px;">
          ✅ Configuración guardada correctamente
        </div>
      </div>

      <p class="muted" style="margin-top:20px;">Envía notificaciones push a todos los pases en Google Wallet.</p>

      <div
        style="background:rgba(140,150,104,0.1);border:1px solid rgba(140,150,104,0.3);border-radius:12px;padding:14px;margin:12px 0;">
        <h3 style="margin:0 0 8px;"><i class="fas fa-mobile-alt"></i> Notificaciones Push</h3>

        <form id="push-notification-form">
          <label>Título de la notificación</label>
          <input id="push-title" placeholder="Ej. ¡Nueva promoción!" required maxlength="50">
          <small class="muted">Máximo 50 caracteres</small>

          <label style="margin-top:10px;">Mensaje</label>
          <textarea id="push-message" placeholder="Ej. Hoy tenemos 20% de descuento..." required maxlength="200"
            rows="3"></textarea>
          <small class="muted">Máximo 200 caracteres</small>

          <label style="margin-top:10px;">Tipo</label>
          <select id="push-type">
            <option value="promo">Promoción</option>
            <option value="reminder">Recordatorio</option>
            <option value="update">Actualización</option>
            <option value="alert">⚠️ Alerta</option>
          </select>

          <div style="margin-top:12px;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;">
            <div class="row" style="justify-content:space-between;margin-bottom:8px;">
              <span class="muted" style="font-size:12px;">Vista previa:</span>
              <span id="preview-type" style="font-size:12px;">🎁 Promoción</span>
            </div>
            <div style="background:rgba(255,255,255,0.1);border-radius:8px;padding:10px;">
              <div id="preview-title" style="font-weight:600;margin-bottom:4px;">¡Nueva promoción!</div>
              <div id="preview-message" class="muted" style="font-size:12px;">Tu mensaje aparecerá aquí...</div>
            </div>
          </div>

          <div class="row" style="margin-top:14px;gap:10px;">
            <button type="button" id="btn-mass-push" class="btn primary">Enviar a todos</button>
            <button type="button" id="test-push" class="btn ghost">Enviar prueba</button>
          </div>
        </form>

        <div id="push-success" class="success-message hidden" style="margin-top:12px;">
          ✅ Notificación enviada a <span id="push-count">0</span> pases
        </div>

        <div id="push-error" class="hidden"
          style="background:rgba(254,202,202,0.1);border:1px solid rgba(153,27,27,0.3);border-radius:10px;padding:10px 12px;margin-top:12px;font-size:13px;color:#fecaca;">
          ❌ Error al enviar notificación
        </div>
      </div>

      <div style="margin-top:16px;">
        <div class="row" style="justify-content:space-between;margin-bottom:8px;">
          <h3 style="margin:0;"><i class="fas fa-list"></i> Historial</h3>
          <div style="display:flex;gap:8px;">
            <button id="refresh-history" class="btn small ghost" title="Refrescar"><i
                class="fas fa-sync-alt"></i></button>
            <button id="clear-notif-history" class="btn small ghost" style="color:#ef4444;" title="Borrar historial"><i
                class="fas fa-trash"></i></button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Título</th>
                <th>Tipo</th>
                <th>Enviadas</th>
                <th>Errores</th>
              </tr>
            </thead>
            <tbody id="notifications-history">
              <tr>
                <td colspan="5" style="text-align:center;padding:12px;" class="muted">Cargando...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- NUEVA SECCIÓN: DEBUGGING AVANZADO -->
      <div class="debug-section">
        <h3 style="margin:0 0 12px;font-size:15px;color:var(--ink);"><i class="fas fa-bug"></i> Debugging Avanzado</h3>

        <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:12px;">
          <button id="btn-test-apple-push" class="btn small"><i class="fas fa-flask"></i> Test Apple Push</button>
          <button id="btn-test-google-push" class="btn small"><i class="fas fa-flask"></i> Test Google Push</button>
          <button id="btn-fix-google-wallet" class="btn small"><i class="fas fa-wrench"></i> Reparar Google
            Wallet</button>
          <button id="btn-check-devices" class="btn small"><i class="fas fa-mobile-alt"></i> Ver Dispositivos</button>
          <button id="btn-check-apns" class="btn small"><i class="fab fa-apple"></i> Ver Config APNs</button>
        </div>

        <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--line);">
          <h4 style="margin:0 0 10px;font-size:13px;color:var(--venus-soft);">Simular Webhook WhatsApp (Local)</h4>
          <div class="row" style="gap:8px;flex-wrap:wrap;">
            <button class="btn small ghost" onclick="simulateWebhook('confirmar')"><i class="fas fa-check"></i> Simular
              Confirmar</button>
            <button class="btn small ghost" onclick="simulateWebhook('reprogramar')"><i class="fas fa-clock"></i>
              Simular Reprogramar</button>
            <button class="btn small ghost" onclick="simulateWebhook('cancelar')"><i class="fas fa-times"></i> Simular
              Cancelar</button>
          </div>
        </div>
        <div id="debug-output" class="debug-output hidden">
          <!-- Aquí se mostrarán los resultados del debugging -->
        </div>
      </div>
    </section>

    <!-- TAB: Notificaciones -->
    <section id="tab-notifications" class="card hidden">
      <h2><i class="fas fa-bell"></i> Notificaciones</h2>
      <p class="muted" style="margin:0 0 20px;font-size:13px;">
        Configura notificaciones automáticas para diferentes eventos del programa de lealtad.
      </p>

      <!-- Botón ejecutar todas -->
      <div style="margin-bottom:24px;">
        <button id="btn-run-all-automations" class="btn primary">
          <i class="fas fa-play"></i> Ejecutar Automatizaciones Activas
        </button>
        <span class="muted" style="font-size:12px;margin-left:10px;">Procesa todas las reglas activas ahora</span>
      </div>

      <!-- Regla 1: Cumpleaños -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon"><i class="fas fa-birthday-cake"></i></span>
            <span class="automation-title">Recordatorio de Cumpleaños</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-birthday-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <label class="automation-label">Días de anticipación:</label>
          <input type="number" id="auto-birthday-days" class="automation-input" value="3" min="0" max="30">

          <label class="automation-label" style="margin-top:10px;">Mensaje:</label>
          <textarea id="auto-birthday-message" class="automation-textarea"
            rows="2">¡Feliz cumpleaños! 🎉 Te esperamos con un regalo especial en Venus.</textarea>

          <button class="btn small ghost automation-test-btn" data-type="birthday"><i class="fas fa-flask"></i>
            Probar</button>
        </div>
      </div>

      <!-- Regla 2: Inactividad -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon"><i class="fas fa-moon"></i></span>
            <span class="automation-title">Alerta de Inactividad</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-inactivity-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <label class="automation-label">Días sin visita:</label>
          <input type="number" id="auto-inactivity-days" class="automation-input" value="30" min="7" max="180">

          <label class="automation-label" style="margin-top:10px;">Mensaje:</label>
          <textarea id="auto-inactivity-message" class="automation-textarea"
            rows="2">¡Te extrañamos! 😊 Hace tiempo que no te vemos. Ven y disfruta nuestros servicios.</textarea>

          <button class="btn small ghost automation-test-btn" data-type="inactivity"><i class="fas fa-flask"></i>
            Probar</button>
        </div>
      </div>

      <!-- Regla 3: Tarjeta Completada -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon"><i class="fas fa-gift"></i></span>
            <span class="automation-title">Tarjeta Completada</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-completed-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <p class="muted" style="font-size:12px;margin:0 0 10px;">Notificación cuando el cliente complete su tarjeta.
          </p>

          <label class="automation-label">Mensaje:</label>
          <textarea id="auto-completed-message" class="automation-textarea"
            rows="2">¡Felicidades! 🎁 Has completado tu tarjeta. Ven a canjear tu premio.</textarea>

          <button class="btn small ghost automation-test-btn" data-type="completed"><i class="fas fa-flask"></i>
            Probar</button>
        </div>
      </div>

      <!-- Regla 4: Casi Completa -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon">⚡</span>
            <span class="automation-title">Casi Completa (Motivacional)</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-almost-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <label class="automation-label">Faltan X sellos:</label>
          <input type="number" id="auto-almost-stamps" class="automation-input" value="2" min="1" max="5">

          <label class="automation-label" style="margin-top:10px;">Mensaje:</label>
          <textarea id="auto-almost-message" class="automation-textarea"
            rows="2">¡Ya casi! ⚡ Solo te faltan [X] sellos para tu premio. ¡No esperes más!</textarea>

          <button class="btn small ghost automation-test-btn" data-type="almost">🧪 Probar</button>
        </div>
      </div>

      <!-- Historial de automatizaciones -->
      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--line);">
        <h4 style="margin:0 0 10px;font-size:14px;color:var(--venus-soft);"><i class="fas fa-list"></i> Historial
          Reciente</h4>
        <div id="automation-history" class="automation-history">
          <p class="muted" style="font-size:12px;">No hay envíos recientes</p>
        </div>
      </div>
    </section>

    <!-- TAB: Solicitudes de Citas Online -->
    <section id="tab-requests" class="tab-content hidden">
      <div class="header-actions">
        <h2><i class="fas fa-inbox"></i> Solicitudes</h2>
        <div style="display:flex;gap:8px;">
          <button class="btn small ghost" onclick="deleteAllRequests()" title="Borrar todas las solicitudes"
            style="color:#ef4444;border-color:#ef4444;">
            <i class="fas fa-trash"></i> Borrar Todo
          </button>
          <button class="btn small ghost" onclick="loadBookingRequests()"><i class="fas fa-sync"></i></button>
        </div>
      </div>

      <!-- Stats compactas -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:16px;">
        <div class="kpi">
          <span class="value" id="req-pending">0</span>
          <span><i class="fas fa-clock"></i> Pendientes</span>
        </div>
        <div class="kpi">
          <span class="value" id="req-contacted">0</span>
          <span><i class="fas fa-phone"></i> Contactadas</span>
        </div>
        <div class="kpi">
          <span class="value" id="req-booked">0</span>
          <span><i class="fas fa-check"></i> Agendadas</span>
        </div>
      </div>

      <!-- Lista de solicitudes tipo tarjetas -->
      <div id="requests-list" style="display:flex;flex-direction:column;gap:10px;">
        <div style="text-align:center;padding:40px;" class="muted">
          <i class="fas fa-inbox" style="font-size:32px;margin-bottom:12px;display:block;opacity:0.5;"></i>
          Cargando solicitudes...
        </div>
      </div>

      <!-- Link compacto -->
      <div
        style="margin-top:16px;padding:12px;background:rgba(140,150,104,0.08);border-radius:10px;border:1px solid rgba(140,150,104,0.15);">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <div style="flex:1;min-width:200px;">
            <div style="font-size:12px;font-weight:600;margin-bottom:4px;"><i class="fas fa-link"></i> Página de Agendar
            </div>
            <code id="agendar-url" style="font-size:11px;word-break:break-all;"></code>
          </div>
          <div style="display:flex;gap:6px;">
            <button class="btn small" onclick="copyAgendarUrl()" title="Copiar URL"><i class="fas fa-copy"></i></button>
            <a href="/agendar.html" target="_blank" class="btn small ghost" title="Abrir"><i
                class="fas fa-external-link-alt"></i></a>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: Citas -->
    <section id="tab-appointments" class="tab-content hidden">
      <div class="header-actions">
        <h2><i class="fas fa-calendar"></i> Agenda de Citas</h2>
        <div style="display:flex;gap:8px;">
          <button class="btn small ghost" onclick="loadAppointments(); renderMonthlyCalendar(); loadMonthStats();"
            title="Actualizar">
            <i class="fas fa-sync"></i>
          </button>
          <button class="btn primary" id="btn-new-appointment">Nueva Cita</button>
        </div>
      </div>

      <!-- Google Calendar Style -->
      <div class="google-calendar-container">
        <!-- Header del calendario -->
        <div class="calendar-header">
          <div class="calendar-title-section">
            <h2 id="calendar-month-title">Diciembre 2024</h2>
            <div class="calendar-nav">
              <button class="btn-nav" id="btn-prev-month" title="Mes anterior">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button class="btn-nav" id="btn-today" title="Ir a hoy">Hoy</button>
              <button class="btn-nav" id="btn-next-month" title="Mes siguiente">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>

          <div class="calendar-actions">
            <button class="btn small ghost" onclick="loadAppointments(); renderMonthlyCalendar(); loadMonthStats();"
              title="Actualizar">
              <i class="fas fa-sync"></i>
            </button>
            <div class="view-selector">
              <button class="view-btn active" data-view="month">Mes</button>
              <button class="view-btn" data-view="week">Semana</button>
              <button class="view-btn" data-view="day">Día</button>
            </div>
          </div>
        </div>

        <!-- Calendario principal -->
        <div class="calendar-grid-container">
          <!-- Días de la semana -->
          <div class="weekdays-header">
            <div class="weekday">Dom</div>
            <div class="weekday">Lun</div>
            <div class="weekday">Mar</div>
            <div class="weekday">Mié</div>
            <div class="weekday">Jue</div>
            <div class="weekday">Vie</div>
            <div class="weekday">Sáb</div>
          </div>

          <!-- Grid de días -->
          <div class="calendar-grid" id="monthly-calendar">
            <!-- Los días se generan dinámicamente -->
          </div>
        </div>
      </div>

      <!-- Citas del Día Seleccionado -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3 style="margin:0;">Citas del <span id="selected-date-label">Hoy</span></h3>
          <button class="btn small" id="btn-refresh-appts"><i class="fas fa-sync-alt"></i> Actualizar</button>
        </div>

        <table class="data-table">
          <thead>
            <tr>
              <th>Hora</th>
              <th>Cliente</th>
              <th>Servicio</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="appts-tbody">
            <tr>
              <td colspan="5" style="text-align:center;padding:20px;">Cargando...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Historial del Mes -->
      <div class="card" style="margin-top:20px;">
        <h3 style="margin-top:0;">Historial del Mes</h3>
        <div id="month-stats"
          style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:16px;">
          <div class="stat-card">
            <div class="stat-label">Total Citas</div>
            <div class="stat-value" id="stat-total">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Completadas</div>
            <div class="stat-value" id="stat-completed">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Canceladas</div>
            <div class="stat-value" id="stat-cancelled">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Pendientes</div>
            <div class="stat-value" id="stat-pending">-</div>
          </div>
        </div>
      </div>

      <!-- Resumen de Ventas del Mes -->
      <div class="card" style="margin-top:20px;">
        <h3 style="margin-top:0;"><i class="fas fa-dollar-sign"></i> Ventas del Mes</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;">
          <div class="stat-card">
            <div class="stat-label"><i class="fas fa-money-bill"></i> Efectivo</div>
            <div class="stat-value stat-money" id="revenue-cash">$0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label"><i class="fas fa-credit-card"></i> Tarjeta</div>
            <div class="stat-value stat-money" id="revenue-card">$0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label"><i class="fas fa-building"></i> Transferencia</div>
            <div class="stat-value stat-money" id="revenue-transfer">$0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label"><i class="fas fa-dollar-sign"></i> Total</div>
            <div class="stat-value stat-money" id="revenue-total" style="color:#FFD166;font-weight:700;">$0.00</div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: Reportes de Ventas -->
    <section id="tab-reports" class="tab-content hidden">
      <div class="header-actions">
        <h2><i class="fas fa-chart-line"></i> Reportes de Ventas</h2>
        <div style="display:flex;gap:8px;">
          <button class="btn ghost" onclick="cargarReportesMes()">
            <i class="fas fa-sync"></i> Actualizar
          </button>
          <button class="btn primary" onclick="exportarVentasExcel()">
            <i class="fas fa-file-excel"></i> Exportar Excel
          </button>
        </div>
      </div>

      <!-- Selector de Mes (estilo Excel tabs) -->
      <div class="card" style="padding:12px;margin-bottom:16px;">
        <div style="display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;" id="report-month-tabs">
          <!-- Se generan dinámicamente -->
        </div>
      </div>

      <!-- Filtro de Fechas Personalizado -->
      <div class="card"
        style="padding:16px;margin-bottom:16px;background:linear-gradient(135deg, rgba(140,150,104,0.1) 0%, rgba(140,150,104,0.05) 100%);border:1px solid rgba(140,150,104,0.2);">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
          <div style="display:flex;align-items:center;gap:8px;">
            <i class="fas fa-filter" style="color:var(--venus);"></i>
            <span style="font-weight:600;font-size:14px;">Filtrar por fechas:</span>
          </div>

          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <div style="display:flex;align-items:center;gap:6px;">
              <label style="font-size:12px;color:var(--muted);">Desde:</label>
              <input type="date" id="report-date-from" class="form-control"
                style="padding:8px 12px;border-radius:8px;border:1px solid var(--line);background:var(--card);color:var(--ink);font-size:13px;">
            </div>

            <div style="display:flex;align-items:center;gap:6px;">
              <label style="font-size:12px;color:var(--muted);">Hasta:</label>
              <input type="date" id="report-date-to" class="form-control"
                style="padding:8px 12px;border-radius:8px;border:1px solid var(--line);background:var(--card);color:var(--ink);font-size:13px;">
            </div>

            <button class="btn primary" onclick="filtrarReportePorFechas()" style="padding:8px 16px;font-size:13px;">
              <i class="fas fa-search"></i> Filtrar
            </button>

            <button class="btn ghost" onclick="limpiarFiltroFechas()" style="padding:8px 12px;font-size:13px;">
              <i class="fas fa-times"></i> Limpiar
            </button>
          </div>

          <!-- Atajos rápidos -->
          <div style="display:flex;gap:6px;margin-left:auto;">
            <button class="btn ghost small" onclick="filtroRapido('hoy')"
              style="padding:6px 10px;font-size:11px;">Hoy</button>
            <button class="btn ghost small" onclick="filtroRapido('semana')"
              style="padding:6px 10px;font-size:11px;">Esta semana</button>
            <button class="btn ghost small" onclick="filtroRapido('mes')" style="padding:6px 10px;font-size:11px;">Este
              mes</button>
          </div>
        </div>

        <div id="filter-active-label"
          style="display:none;margin-top:10px;padding:8px 12px;background:rgba(140,150,104,0.15);border-radius:8px;font-size:12px;color:var(--venus);">
          <i class="fas fa-info-circle"></i> <span id="filter-range-text"></span>
        </div>
      </div>

      <!-- Layout Principal tipo Excel -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">

        <!-- Lado Izquierdo: Resumen Financiero -->
        <div class="card"
          style="background:linear-gradient(135deg, #2F3E2B 0%, #4A5D3F 100%);border:1px solid rgba(255,255,255,0.1);">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
            <img src="/assets/logo.png" alt="Venus" style="width:40px;height:40px;border-radius:8px;">
            <div>
              <div style="font-size:18px;font-weight:700;color:#fff;">Venus</div>
              <div style="font-size:11px;color:rgba(255,255,255,0.7);">COSMETOLOGÍA</div>
            </div>
          </div>

          <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
            <span style="font-size:13px;color:rgba(255,255,255,0.8);">Mes:</span>
            <span id="report-current-month" style="font-size:15px;font-weight:600;color:#fff;">Diciembre</span>
          </div>

          <!-- Resumen Financiero -->
          <div style="background:rgba(255,255,255,0.1);border-radius:10px;padding:12px;margin-bottom:12px;">
            <div style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.7);margin-bottom:8px;">Resumen
              Financiero</div>
            <div
              style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.15);">
              <span style="font-size:13px;color:rgba(255,255,255,0.9);">TOTAL Ingresos</span>
              <span id="report-total-ingresos" style="font-size:15px;font-weight:700;color:#C1D7AE;">$0.00</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:6px 0;">
              <span style="font-size:13px;color:rgba(255,255,255,0.9);">TOTAL Egresos</span>
              <span id="report-total-egresos" style="font-size:15px;font-weight:700;color:#8F9E8B;">$0.00</span>
            </div>
          </div>

          <!-- Ingresos por Servicios -->
          <div style="background:rgba(255,255,255,0.1);border-radius:10px;padding:12px;">
            <div style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.7);margin-bottom:8px;">Ingresos por
              servicios</div>
            <div id="report-servicios-list" style="max-height:200px;overflow-y:auto;">
              <!-- Se genera dinámicamente -->
            </div>
          </div>
        </div>

        <!-- Lado Derecho: Gráfica de Pastel -->
        <div class="card">
          <h3 style="margin:0 0 16px;font-size:14px;color:var(--venus-soft);">
            <i class="fas fa-chart-pie"></i> Distribución de Ingresos
          </h3>
          <div style="position:relative;height:280px;display:flex;align-items:center;justify-content:center;">
            <canvas id="report-pie-chart"></canvas>
          </div>
          <div style="display:flex;justify-content:center;gap:20px;margin-top:12px;">
            <div style="display:flex;align-items:center;gap:6px;">
              <div style="width:12px;height:12px;border-radius:3px;background:#6B8E23;"></div>
              <span style="font-size:12px;">Ingresos</span>
            </div>
            <div style="display:flex;align-items:center;gap:6px;">
              <div style="width:12px;height:12px;border-radius:3px;background:#3F4F3A;"></div>
              <span style="font-size:12px;">Egresos</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Ingresos por Tipo de Servicio (gráfica de pastel detallada) -->
      <div class="card" style="margin-bottom:20px;">
        <h3 style="margin:0 0 16px;font-size:14px;color:var(--venus-soft);">
          <i class="fas fa-spa"></i> Ingresos por Tipo de Servicio
        </h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:center;">
          <div style="position:relative;height:250px;">
            <canvas id="report-services-pie-chart"></canvas>
          </div>
          <div id="report-services-legend" style="display:flex;flex-direction:column;gap:8px;">
            <!-- Se genera dinámicamente -->
          </div>
        </div>
      </div>

      <!-- Tabla de Ingresos Detallada -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3 style="margin:0;font-size:14px;color:var(--venus-soft);">
            <i class="fas fa-list"></i> INGRESOS
          </h3>
          <div style="display:flex;gap:8px;align-items:center;">
            <select id="filter-payment-method" class="form-input" style="padding:6px 10px;font-size:12px;"
              onchange="filtrarTablaReporte()">
              <option value="">Todos los pagos</option>
              <option value="efectivo">Efectivo</option>
              <option value="tarjeta">Tarjeta</option>
              <option value="transferencia">Transferencia</option>
            </select>
          </div>
        </div>
        <div class="table-wrap" style="max-height:500px;overflow-y:auto;">
          <table class="data-table" style="font-size:12px;">
            <thead style="position:sticky;top:0;background:#2c2d26;z-index:1;">
        </div>

        <!-- Estadísticas -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px;">
          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
              <span style="font-size:12px;color:var(--muted);text-transform:uppercase;font-weight:600;">Total
                Ventas</span>
              <i class="fas fa-dollar-sign" style="color:var(--venus);font-size:20px;"></i>
            </div>
            <div id="report-total-sales" style="font-size:28px;font-weight:700;color:var(--venus);">$0.00</div>
            <div id="report-sales-count" style="font-size:12px;color:var(--muted);margin-top:4px;">0 ventas</div>
          </div>

          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
              <span style="font-size:12px;color:var(--muted);text-transform:uppercase;font-weight:600;">Efectivo</span>
              <i class="fas fa-money-bill-wave" style="color:#22c55e;font-size:20px;"></i>
            </div>
            <div id="report-cash-total" style="font-size:28px;font-weight:700;color:#22c55e;">$0.00</div>
            <div id="report-cash-count" style="font-size:12px;color:var(--muted);margin-top:4px;">0 ventas</div>
          </div>

          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
              <span style="font-size:12px;color:var(--muted);text-transform:uppercase;font-weight:600;">Tarjeta</span>
              <i class="fas fa-credit-card" style="color:#3b82f6;font-size:20px;"></i>
            </div>
            <div id="report-card-total" style="font-size:28px;font-weight:700;color:#3b82f6;">$0.00</div>
            <div id="report-card-count" style="font-size:12px;color:var(--muted);margin-top:4px;">0 ventas</div>
          </div>

          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
              <span
                style="font-size:12px;color:var(--muted);text-transform:uppercase;font-weight:600;">Transferencia</span>
              <i class="fas fa-exchange-alt" style="color:#8b5cf6;font-size:20px;"></i>
            </div>
            <div id="report-transfer-total" style="font-size:28px;font-weight:700;color:#8b5cf6;">$0.00</div>
            <div id="report-transfer-count" style="font-size:12px;color:var(--muted);margin-top:4px;">0 ventas</div>
          </div>
        </div>

        <!-- Panel de Gastos del Mes -->
        <div class="card"
          style="margin-bottom:20px;background:linear-gradient(135deg, rgba(239,68,68,0.05) 0%, rgba(220,38,38,0.05) 100%);border:1px solid rgba(239,68,68,0.2);">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h3 style="margin:0;font-size:18px;display:flex;align-items:center;gap:10px;">
              <i class="fas fa-receipt" style="color:#ef4444;"></i>
              <span>Gastos del Mes</span>
            </h3>
            <button class="btn primary" onclick="openExpenseModal()"
              style="background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
              <i class="fas fa-plus"></i> Nuevo Gasto
            </button>
          </div>

          <!-- Resumen de Gastos -->
          <div
            style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:20px;">
            <div
              style="background:rgba(255,255,255,0.05);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <i class="fas fa-wallet" style="color:#ef4444;"></i>
                <span style="font-size:11px;color:var(--muted);text-transform:uppercase;font-weight:600;">Total
                  Gastos</span>
              </div>
              <div id="expenses-total" style="font-size:24px;font-weight:700;color:#ef4444;">$0.00</div>
              <div id="expenses-count" style="font-size:11px;color:var(--muted);margin-top:4px;">0 gastos</div>
            </div>

            <div
              style="background:rgba(255,255,255,0.05);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <i class="fas fa-chart-line" style="color:#10b981;"></i>
                <span style="font-size:11px;color:var(--muted);text-transform:uppercase;font-weight:600;">Utilidad
                  Neta</span>
              </div>
              <div id="net-profit" style="font-size:24px;font-weight:700;color:#10b981;">$0.00</div>
              <div id="profit-margin" style="font-size:11px;color:var(--muted);margin-top:4px;">0% margen</div>
            </div>

            <div
              style="background:rgba(255,255,255,0.05);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <i class="fas fa-shopping-cart" style="color:#f59e0b;"></i>
                <span
                  style="font-size:11px;color:var(--muted);text-transform:uppercase;font-weight:600;">Productos</span>
              </div>
              <div id="expenses-products" style="font-size:24px;font-weight:700;color:#f59e0b;">$0.00</div>
            </div>

            <div
              style="background:rgba(255,255,255,0.05);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <i class="fas fa-ellipsis-h" style="color:#8b5cf6;"></i>
                <span style="font-size:11px;color:var(--muted);text-transform:uppercase;font-weight:600;">Otros</span>
              </div>
              <div id="expenses-others" style="font-size:24px;font-weight:700;color:#8b5cf6;">$0.00</div>
            </div>
          </div>

          <!-- Tabla de Gastos -->
          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Categoría</th>
                  <th>Descripción</th>
                  <th>Monto</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="expenses-tbody">
                <tr>
                  <td colspan="5" class="muted" style="text-align:center;padding:20px;">
                    No hay gastos registrados este mes
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Tabla de ventas -->
        <div class="card">
          <h3 style="margin-bottom:16px;font-size:15px;"><i class="fas fa-list"></i> Detalle de Ventas</h3>
          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th style="white-space:nowrap;">Fecha de pago</th>
                  <th>Cliente</th>
                  <th>Servicio</th>
                  <th>Tipo</th>
                  <th style="white-space:nowrap;">Forma de pago</th>
                  <th style="white-space:nowrap;">Cuenta Bancaria</th>
                  <th>Subtotal</th>
                  <th>IVA</th>
                  <th>Descuento</th>
                  <th>Total</th>
                  <th>Comentarios</th>
                </tr>
              </thead>
              <tbody id="report-sales-tbody">
                <tr>
                  <td colspan="11" class="muted" style="text-align:center;padding:40px;">
                    Selecciona un mes para ver los ingresos
                  </td>
                </tr>
              </tbody>
              <tfoot id="report-sales-tfoot" style="background:rgba(140,150,104,0.15);font-weight:600;">
                <!-- Totales -->
              </tfoot>
            </table>
          </div>
        </div>
    </section>

    <!-- TAB: Servicios y Productos -->
    <section id="tab-services" class="tab-content hidden">
      <div class="header-actions">
        <h2><i class="fas fa-sparkles"></i> Catálogo</h2>
      </div>

      <!-- Tabs Header -->
      <div class="tabs-header" style="margin-bottom:0;border-radius:12px 12px 0 0;">
        <button class="tab-btn active" onclick="switchCatalogTab('services')" id="btn-tab-services">
          <i class="fas fa-sparkles"></i> Servicios
          <span class="tab-count" id="services-count">0</span>
        </button>
        <button class="tab-btn" onclick="switchCatalogTab('products')" id="btn-tab-products">
          <i class="fas fa-shopping-bag"></i> Productos
          <span class="tab-count" id="products-count">0</span>
        </button>
      </div>

      <div class="card" style="border-radius:0 0 12px 12px;margin-top:0;">

        <!-- Panel: Servicios -->
        <div id="panel-services" class="tab-panel active">
          <div class="row" style="gap:12px;margin-bottom:16px;flex-wrap:wrap;">
            <input type="text" id="search-services" class="form-input" placeholder="Buscar servicio..."
              style="flex:1;min-width:200px;">
            <button class="btn ghost" onclick="autoCategorizarServicios()" style="white-space:nowrap;">
              <i class="fas fa-magic"></i> Auto-organizar
            </button>
            <button class="btn primary" id="btn-new-service"><i class="fas fa-plus"></i> Nuevo Servicio</button>
          </div>

          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Categoría</th>
                  <th>Duración</th>
                  <th>Precio</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="services-tbody">
                <tr>
                  <td colspan="5" class="muted" style="text-align:center;padding:20px;">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Panel: Productos -->
        <div id="panel-products" class="tab-panel">
          <!-- Stats -->
          <div class="stats-bar">
            <div class="stat-item">
              <span class="stat-value" id="stat-products-total">0</span>
              <span class="stat-label">Productos</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="stat-products-value">$0</span>
              <span class="stat-label">Valor inventario</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="stat-products-low" style="color:#fbbf24;">0</span>
              <span class="stat-label">Stock bajo</span>
            </div>
          </div>

          <div class="row" style="gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center;">
            <input type="text" id="search-products" class="form-input" placeholder="Buscar producto..."
              style="flex:1;min-width:200px;">
            <div class="filter-chips">
              <span class="chip active" data-category="all" onclick="filterProducts('all')">Todos</span>
              <span class="chip" data-category="skincare" onclick="filterProducts('skincare')">Skincare</span>
              <span class="chip" data-category="maquillaje" onclick="filterProducts('maquillaje')">Maquillaje</span>
              <span class="chip" data-category="corporal" onclick="filterProducts('corporal')">Corporal</span>
            </div>
            <button class="btn primary" id="btn-new-product"><i class="fas fa-plus"></i> Nuevo Producto</button>
          </div>

          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Categoría</th>
                  <th>Precio</th>
                  <th>Stock</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="products-tbody">
                <tr>
                  <td colspan="5" class="muted" style="text-align:center;padding:20px;">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <!-- Modal Nuevo/Editar Producto -->
    <div id="modal-product" class="modal-backdrop hidden">
      <div class="modal-card">
        <div class="modal-header">
          <h3 id="modal-product-title"><i class="fas fa-shopping-bag"></i> Nuevo Producto</h3>
          <button class="btn small ghost" id="close-modal-product"><i class="fas fa-times"></i></button>
        </div>

        <form id="form-product">
          <input type="hidden" id="product-id">

          <div class="form-group">
            <label class="form-label">Nombre del producto</label>
            <input type="text" id="product-name" class="form-input" required placeholder="Ej: Sérum Vitamina C">
          </div>

          <div class="row" style="gap:12px;">
            <div class="form-group" style="flex:1;">
              <label class="form-label">Categoría</label>
              <select id="product-category" class="form-input" required>
                <option value="skincare">Skincare</option>
                <option value="maquillaje">Maquillaje</option>
                <option value="corporal">Corporal</option>
                <option value="cabello">Cabello</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="form-group" style="flex:1;">
              <label class="form-label">Presentación</label>
              <input type="text" id="product-presentation" class="form-input" placeholder="Ej: 30ml, 50g">
            </div>
          </div>

          <div class="row" style="gap:12px;">
            <div class="form-group" style="flex:1;">
              <label class="form-label">Precio de venta</label>
              <div style="position:relative;">
                <span
                  style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);">$</span>
                <input type="number" id="product-price" class="form-input" required min="0" step="any"
                  style="padding-left:25px;">
              </div>
            </div>
            <div class="form-group" style="flex:1;">
              <label class="form-label">Costo (opcional)</label>
              <div style="position:relative;">
                <span
                  style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);">$</span>
                <input type="number" id="product-cost" class="form-input" min="0" step="any" style="padding-left:25px;">
              </div>
            </div>
          </div>

          <div class="row" style="gap:12px;">
            <div class="form-group" style="flex:1;">
              <label class="form-label">Stock actual</label>
              <input type="number" id="product-stock" class="form-input" required min="0" value="0">
            </div>
            <div class="form-group" style="flex:1;">
              <label class="form-label">Stock mínimo (alerta)</label>
              <input type="number" id="product-min-stock" class="form-input" min="0" value="5">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Descripción (opcional)</label>
            <input type="text" id="product-description" class="form-input" placeholder="Breve descripción">
          </div>

          <div class="modal-footer">
            <button type="button" class="btn ghost" id="cancel-product">Cancelar</button>
            <button type="submit" class="btn primary"><i class="fas fa-save"></i> Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- DIALOG: Nueva Cita -->
    <dialog id="newApptDialog">
      <div class="dialog-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h3 style="margin:0;"><i class="fas fa-calendar"></i> Agendar Cita</h3>
          <button type="button" class="btn ghost" onclick="newApptDialog.close()"
            style="min-width:auto;padding:8px 12px;" title="Cerrar">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="form-new-appt">
          <div style="display:grid;gap:16px;">
            <!-- Cliente con búsqueda editable -->
            <div>
              <label class="form-label">Cliente</label>
              <div class="custom-select-wrapper">
                <input type="text" id="new-appt-client-select" class="form-input"
                  placeholder="Buscar o escribir nombre..." autocomplete="off">
                <span class="dropdown-toggle-icon">▼</span>
                <div id="clients-dropdown-list" class="custom-dropdown-list" style="display:none;"></div>
              </div>
              <button type="button" id="btn-toggle-new-client" class="btn small ghost" style="margin-top:8px;">
                + Registrar nuevo cliente
              </button>

              <!-- Panel Historial de Citas - Clic para seleccionar servicio -->
              <div id="client-history-panel" class="client-history-panel hidden">
                <div class="history-header" id="toggle-history">
                  <div style="display:flex;align-items:center;gap:8px;">
                    <span class="history-toggle-icon">▼</span>
                    <span><i class="fas fa-calendar"></i> Citas anteriores</span>
                    <span class="history-count" id="history-count">(0)</span>
                  </div>
                  <span class="history-hint" id="history-hint">Clic para repetir servicio</span>
                </div>
                <div class="history-content" id="history-content" style="display:none;">
                  <div id="history-list" class="history-list">
                  </div>
                </div>
              </div>
            </div>

            <!-- Formulario Nuevo Cliente (oculto por defecto) -->
            <div id="new-client-form"
              style="display:none;background:rgba(140,150,104,0.1);border:1px solid rgba(140,150,104,0.3);border-radius:12px;padding:16px;">
              <h4 style="margin:0 0 12px 0;color:var(--venus-soft);">Nuevo Cliente</h4>
              <div style="display:grid;gap:12px;">
                <div>
                  <label class="form-label">Nombre completo</label>
                  <input type="text" id="new-client-name" class="form-input" placeholder="Ej: María González">
                </div>
                <div>
                  <label class="form-label">Teléfono</label>
                  <input type="tel" id="new-client-phone" class="form-input" placeholder="52...">
                </div>
                <button type="button" id="btn-save-new-client" class="btn small primary">Guardar Cliente</button>
              </div>
            </div>

            <!-- Teléfono -->
            <div>
              <label class="form-label">Teléfono</label>
              <input type="tel" id="new-appt-phone" class="form-input" placeholder="4421234567" required>
            </div>

            <!-- Servicio y Precio -->
            <div class="grid-service-price">
              <div>
                <label class="form-label">Servicio</label>
                <div class="custom-select-wrapper">
                  <input type="text" id="new-appt-service" class="form-input"
                    placeholder="Buscar o escribir servicio..." autocomplete="off">
                  <span class="dropdown-toggle-icon">▼</span>
                  <div id="services-dropdown-list" class="custom-dropdown-list" style="display:none;"></div>
                </div>
              </div>
              <div>
                <label class="form-label">Precio</label>
                <div style="position:relative;">
                  <span
                    style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--venus-soft);font-size:14px;">$</span>
                  <input type="number" id="new-appt-price" class="form-input" placeholder="0" min="0" step="any"
                    style="padding-left:28px;">
                </div>
              </div>
            </div>

            <!-- Botón para agregar servicio -->
            <button type="button" id="btn-add-service" class="btn small ghost" style="width:100%;">
              <i class="fas fa-plus"></i> Agregar otro servicio
            </button>

            <!-- Lista de servicios seleccionados -->
            <div id="selected-services-list"
              style="display:none;background:rgba(140,150,104,0.1);border:1px solid rgba(140,150,104,0.3);border-radius:12px;padding:16px;">
              <h4 style="margin:0 0 12px 0;color:var(--venus-soft);"><i class="fas fa-list"></i> Servicios seleccionados
              </h4>
              <div id="services-list-container"></div>
            </div>

            <!-- Fecha y Hora -->
            <div class="grid-date-time">
              <div style="position:relative;">
                <label class="form-label"><i class="fas fa-calendar"></i> Fecha</label>
                <input type="text" id="new-appt-date" class="form-input date-picker-input" readonly required
                  placeholder="Seleccionar fecha" style="cursor:pointer;">
                <div id="new-appt-calendar" class="calendar-dropdown" style="display:none;"></div>
              </div>
              <div>
                <label class="form-label">Hora</label>
                <select id="new-appt-hour" class="form-input" required>
                  <option value="">--</option>
                </select>
              </div>
              <div>
                <label class="form-label">Min</label>
                <select id="new-appt-minute" class="form-input" required>
                  <option value="">--</option>
                </select>
              </div>
              <div>
                <label class="form-label">Hora fin</label>
                <input type="text" id="new-appt-end-time" class="form-input" readonly
                  style="background:rgba(0,0,0,0.15);color:var(--muted);">
              </div>
            </div>

            <!-- Recordatorios -->
            <div class="reminders-section">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                <svg width="18" height="18" fill="none" stroke="var(--venus-soft)" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                  </path>
                </svg>
                <span style="font-size:13px;font-weight:600;color:var(--venus-soft);">Recordatorios por
                  WhatsApp</span>
              </div>
              <div style="display:grid;gap:10px;">
                <label class="reminder-option">
                  <input type="checkbox" id="check-whatsapp-confirm" checked>
                  <span class="reminder-text">
                    <strong>Confirmación inmediata</strong>
                    <small>Se envía al crear la cita</small>
                  </span>
                </label>
                <label class="reminder-option">
                  <input type="checkbox" id="check-whatsapp-24h" checked>
                  <span class="reminder-text">
                    <strong>24 horas antes</strong>
                    <small>Recordatorio automático</small>
                  </span>
                </label>
                <label class="reminder-option">
                  <input type="checkbox" id="check-whatsapp-2h" checked>
                  <span class="reminder-text">
                    <strong>2 horas antes</strong>
                    <small>Recordatorio final</small>
                  </span>
                </label>
              </div>
            </div>

            <!-- Gift Card -->
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(140,150,104,0.15);">
              <label class="form-label" style="display:flex;align-items:center;gap:6px;color:var(--venus-soft);">
                <i class="fas fa-gift"></i> Canjear Gift Card
              </label>
              <input type="text" id="new-appt-giftcard" class="form-input"
                placeholder="Ingresa el código de la tarjeta (Opcional)"
                style="background:rgba(140,150,104,0.05);border-color:rgba(140,150,104,0.3);">
            </div>

            <!-- Botones -->
            <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:16px;">
              <button type="button" class="btn ghost" id="btn-cancel-appt">Cancelar</button>
              <button type="submit" class="btn primary">Agendar</button>
            </div>
          </div>
        </form>
      </div>
    </dialog>

    <!-- Modal: Modificar Cita -->
    <dialog id="editApptDialog">
      <div class="dialog-content">
        <h2><i class="fas fa-edit"></i> Modificar Cita</h2>
        <form id="form-edit-appt">
          <input type="hidden" id="edit-appt-id">

          <div class="form-grid">
            <!-- Cliente (congelado) -->
            <div style="grid-column: 1/3;">
              <label class="form-label">Cliente (no editable)</label>
              <input type="text" id="edit-appt-client-name" class="form-input" readonly
                style="background:rgba(255,255,255,0.05);cursor:not-allowed;">
            </div>

            <!-- Servicio -->
            <div style="grid-column: 1/3;">
              <label class="form-label">Servicio</label>
              <div class="custom-select-wrapper">
                <input type="text" id="edit-appt-service" class="form-input" required>
                <span class="dropdown-toggle-icon">▼</span>
                <div id="edit-services-dropdown-list" class="custom-dropdown-list" style="display:none;"></div>
              </div>
            </div>

            <div>
              <label class="form-label">Precio</label>
              <div style="position:relative;">
                <span
                  style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--venus-soft);font-size:14px;">$</span>
                <input type="number" id="edit-appt-price" class="form-input" readonly style="padding-left:28px;">
              </div>
            </div>

            <div>
              <label class="form-label">Duración (min)</label>
              <input type="number" id="edit-appt-duration" class="form-input" readonly>
            </div>

            <!-- Fecha y Hora -->
            <div class="grid-date-time full-width">
              <div style="position:relative;">
                <label class="form-label"><i class="fas fa-calendar"></i> Fecha</label>
                <input type="text" id="edit-appt-date" class="form-input date-picker-input" readonly required
                  placeholder="Seleccionar fecha" style="cursor:pointer;">
                <div id="edit-appt-calendar" class="calendar-dropdown" style="display:none;"></div>
              </div>
              <div>
                <label class="form-label">Hora</label>
                <select id="edit-appt-hour" class="form-input" required style="width:100px;">
                  <option value="">--</option>
                </select>
              </div>
              <div>
                <label class="form-label">Min</label>
                <select id="edit-appt-minute" class="form-input" required style="width:90px;">
                  <option value="">--</option>
                </select>
              </div>
              <div>
                <label class="form-label">Termina</label>
                <input type="text" id="edit-appt-end-time" class="form-input" readonly>
              </div>
            </div>

            <!-- Botones -->
            <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;grid-column:1/3;">
              <button type="button" class="btn ghost" id="btn-cancel-edit-appt">Cancelar</button>
              <button type="submit" class="btn primary">Guardar Cambios</button>
            </div>
          </div>
        </form>
      </div>
    </dialog>

    <!-- PAYMENT DIALOG -->
    <dialog id="paymentDialog">
      <button class="btn-close-payment" onclick="closePaymentModal()" title="Cerrar">
        <i class="fas fa-times"></i>
      </button>

      <div class="dialog-header">
        <h3><i class="fas fa-receipt"></i> Cobrar Servicio</h3>
      </div>

      <div style="padding:0 20px 20px;">
        <!-- Info cliente y servicio -->
        <div class="payment-info-row">
          <div class="payment-info-box">
            <div class="payment-info-label">Cliente</div>
            <div class="payment-info-value" id="payment-client-name">-</div>
          </div>
          <div class="payment-info-box">
            <div class="payment-info-label">Servicio</div>
            <div class="payment-info-value" id="payment-service-name">-</div>
            <div class="payment-price-row">
              <span class="payment-price-display" id="payment-price-display">$0</span>
              <input type="number" class="payment-price-input" id="payment-price-input" min="0" step="any">
              <button class="btn-edit-price" onclick="togglePriceEdit()" title="Editar precio">
                <i class="fas fa-pencil" style="font-size:12px;"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Productos -->
        <div class="payment-section">
          <div class="payment-section-header">
            <span class="payment-section-title">
              <i class="fas fa-shopping-bag"></i> Productos
            </span>
          </div>

          <div class="product-add-row">
            <select id="payment-product-select">
              <option value="">Agregar producto...</option>
            </select>
            <input type="number" id="payment-product-qty" value="1" min="1" max="99">
            <button type="button" onclick="addProductToPayment()">
              <i class="fas fa-plus"></i>
            </button>
          </div>

          <div class="payment-product-list" id="payment-products-list">
            <div class="payment-products-empty">Sin productos adicionales</div>
          </div>
        </div>

        <!-- Descuento -->
        <div class="payment-section">
          <div class="payment-section-header">
            <span class="payment-section-title">
              <i class="fas fa-percent"></i> Descuento
            </span>
          </div>

          <div class="discount-row">
            <div class="discount-toggle">
              <button class="active" onclick="setDiscountType('percent')" id="btn-discount-percent">%</button>
              <button onclick="setDiscountType('fixed')" id="btn-discount-fixed">$</button>
            </div>
            <div class="discount-input-wrap">
              <input type="number" id="payment-discount-value" placeholder="0" min="0" value="0"
                oninput="calculateTotals()">
              <span class="discount-symbol" id="discount-symbol">%</span>
            </div>
          </div>

          <div class="discount-applied" id="discount-applied">
            <i class="fas fa-tag"></i>
            <span id="discount-applied-text">Descuento aplicado: -$0</span>
          </div>
        </div>

        <!-- Totales -->
        <div class="payment-totals">
          <div class="payment-total-row sub">
            <span>Servicio</span>
            <span id="total-service">$0</span>
          </div>
          <div class="payment-total-row sub" id="total-products-row" style="display:none;">
            <span>Productos (<span id="total-products-count">0</span>)</span>
            <span id="total-products">$0</span>
          </div>
          <div class="payment-total-row subtotal-line">
            <span>Subtotal</span>
            <span id="total-subtotal">$0</span>
          </div>
          <div class="payment-total-row discount" id="total-discount-row">
            <span id="total-discount-label">Descuento</span>
            <span id="total-discount">-$0</span>
          </div>
          <div class="payment-total-row grand">
            <span>Total</span>
            <span id="total-grand">$0</span>
          </div>
        </div>

        <!-- Método de pago -->
        <div class="form-row" style="margin-top:16px;margin-bottom:0;">
          <label>Método de Pago <span style="color:#ef4444;">*</span></label>
          <select id="payment-method" class="form-input">
            <option value="efectivo">Efectivo</option>
            <option value="tarjeta_credito">Tarjeta de crédito</option>
            <option value="tarjeta_debito">Tarjeta de débito</option>
            <option value="transferencia">Transferencia</option>
          </select>
        </div>

        <!-- Campos ocultos -->
        <input type="hidden" id="payment-appointment-id">
        <input type="hidden" id="payment-original-price">
      </div>

      <div class="dialog-footer">
        <button class="btn primary btn-cobrar" onclick="savePayment()" id="btn-save-payment">
          <i class="fas fa-check-circle"></i>
          Cobrar <span id="btn-payment-total">$0</span>
        </button>
        <button type="button" onclick="closePaymentModal()" class="btn ghost">Cancelar</button>
      </div>
    </dialog>

    <!-- PAYMENT DETAIL DIALOG -->
    <dialog id="paymentDetailDialog">
      <button class="btn-close-payment" onclick="closePaymentDetail()" title="Cerrar">
        <i class="fas fa-times"></i>
      </button>
      <div class="dialog-header" style="padding:20px 20px 0;">
        <h3><i class="fas fa-receipt"></i> Detalle de Pago</h3>
      </div>
      <div style="padding:0 20px 20px;" id="payment-detail-content">
        <!-- Contenido dinámico -->
      </div>
      <div class="dialog-footer">
        <button class="btn ghost" onclick="closePaymentDetail()">Cerrar</button>
      </div>
    </dialog>

    <!-- DIRECT SALE DIALOG -->
    <dialog id="directSaleDialog">
      <button class="btn-close-payment" onclick="closeDirectSaleModal()" title="Cerrar">
        <i class="fas fa-times"></i>
      </button>
      <div class="dialog-header" style="padding:20px 20px 0;">
        <h3><i class="fas fa-shopping-cart"></i> Nueva Venta</h3>
      </div>
      <div style="padding:0 20px 20px;">
        <!-- Cliente (opcional) -->
        <div class="form-row">
          <label>Cliente (opcional)</label>
          <input type="text" id="direct-sale-client" placeholder="Nombre del cliente" class="form-input">
        </div>

        <!-- Productos -->
        <div class="payment-section">
          <div class="payment-section-header">
            <span class="payment-section-title"><i class="fas fa-shopping-bag"></i> Productos</span>
          </div>
          <div class="product-add-row">
            <select id="direct-sale-product-select">
              <option value="">Agregar producto...</option>
            </select>
            <input type="number" id="direct-sale-product-qty" value="1" min="1" max="99">
            <button type="button" onclick="addProductToDirectSale()"><i class="fas fa-plus"></i></button>
          </div>
          <div class="payment-product-list" id="direct-sale-products-list">
            <div class="payment-products-empty">Selecciona productos para vender</div>
          </div>
        </div>

        <!-- Descuento -->
        <div class="payment-section">
          <div class="payment-section-header">
            <span class="payment-section-title"><i class="fas fa-percent"></i> Descuento</span>
          </div>
          <div class="discount-row">
            <div class="discount-toggle">
              <button class="active" onclick="setDirectSaleDiscountType('percent')"
                id="btn-ds-discount-percent">%</button>
              <button onclick="setDirectSaleDiscountType('fixed')" id="btn-ds-discount-fixed">$</button>
            </div>
            <div class="discount-input-wrap">
              <input type="number" id="direct-sale-discount-value" placeholder="0" min="0" value="0"
                oninput="calculateDirectSaleTotals()">
              <span class="discount-symbol" id="ds-discount-symbol">%</span>
            </div>
          </div>
        </div>

        <!-- Totales -->
        <div class="payment-totals">
          <div class="payment-total-row sub"><span>Productos</span><span id="ds-total-products">$0</span></div>
          <div class="payment-total-row discount" id="ds-total-discount-row" style="display:none;">
            <span>Descuento</span><span id="ds-total-discount">-$0</span>
          </div>
          <div class="payment-total-row grand"><span>Total</span><span id="ds-total-grand">$0</span></div>
        </div>

        <!-- Método de pago -->
        <div class="form-row" style="margin-top:16px;">
          <label>Método de Pago <span style="color:#ef4444;">*</span></label>
          <select id="direct-sale-payment-method" class="form-input">
            <option value="efectivo">Efectivo</option>
            <option value="tarjeta_credito">Tarjeta de crédito</option>
            <option value="tarjeta_debito">Tarjeta de débito</option>
            <option value="transferencia">Transferencia</option>
          </select>
        </div>
      </div>
      <div class="dialog-footer">
        <button class="btn primary btn-cobrar" onclick="saveDirectSale()" id="btn-save-direct-sale">
          <i class="fas fa-check-circle"></i> Cobrar <span id="btn-ds-total">$0</span>
        </button>
        <button type="button" onclick="closeDirectSaleModal()" class="btn ghost">Cancelar</button>
      </div>
    </dialog>

    <!-- EXPENSE DIALOG -->
    <dialog id="expenseDialog">
      <div class="dialog-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h3 style="margin:0;display:flex;align-items:center;gap:10px;">
            <i class="fas fa-receipt" style="color:#ef4444;"></i>
            <span id="expense-modal-title">Nuevo Gasto</span>
          </h3>
          <button type="button" class="btn ghost" onclick="closeExpenseModal()" style="min-width:auto;padding:8px 12px;"
            title="Cerrar">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="form-expense">
          <input type="hidden" id="expense-id">
          <div style="display:grid;gap:16px;">
            <!-- Fecha -->
            <div>
              <label class="form-label">Fecha</label>
              <input type="date" id="expense-date" class="form-input" required>
            </div>

            <!-- Categoría -->
            <div>
              <label class="form-label">Categoría</label>
              <select id="expense-category" class="form-input" required>
                <option value="">Seleccionar...</option>
                <option value="productos">📦 Productos/Inventario</option>
                <option value="renta">🏠 Renta</option>
                <option value="servicios">💡 Servicios (luz, agua, internet)</option>
                <option value="salarios">👥 Salarios</option>
                <option value="marketing">📢 Marketing/Publicidad</option>
                <option value="equipo">🔧 Equipo/Herramientas</option>
                <option value="mantenimiento">🛠️ Mantenimiento</option>
                <option value="transporte">🚗 Transporte</option>
                <option value="otros">📝 Otros</option>
              </select>
            </div>

            <!-- Descripción -->
            <div>
              <label class="form-label">Descripción</label>
              <textarea id="expense-description" class="form-input" rows="3"
                placeholder="Ej: Compra de productos para tratamientos faciales" required></textarea>
            </div>

            <!-- Monto -->
            <div>
              <label class="form-label">Monto</label>
              <div style="position:relative;">
                <span
                  style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--venus-soft);font-size:14px;">$</span>
                <input type="number" id="expense-amount" class="form-input" placeholder="0.00" min="0" step="0.01"
                  style="padding-left:28px;" required>
              </div>
            </div>

            <!-- Botones -->
            <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:16px;">
              <button type="button" class="btn ghost" onclick="closeExpenseModal()">Cancelar</button>
              <button type="submit" class="btn primary"
                style="background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                <i class="fas fa-save"></i> Guardar Gasto
              </button>
            </div>
          </div>
        </form>
      </div>
    </dialog>

    <style>
      /* Dialog Styles - Backdrop Opaco y Sólido */
      #newApptDialog::backdrop,
      #editApptDialog::backdrop,
      #paymentDialog::backdrop,
      #paymentDetailDialog::backdrop,
      #directSaleDialog::backdrop {
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }

      #newApptDialog,
      #editApptDialog {
        border: none;
        border-radius: 20px;
        padding: 0;
        max-width: 650px;
        width: 92%;
        background: #1a1b18;
        box-shadow: 0 25px 60px -15px rgba(0, 0, 0, 0.6),
          0 0 0 1px rgba(255, 255, 255, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
      }

      .dialog-content {
        background: #1a1b18;
        border: none;
        border-radius: 20px;
        padding: 28px;
        color: #fff;
      }

      .dialog-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .dialog-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .dialog-header h3 i {
        color: var(--venus);
      }

      .dialog-close {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: var(--muted);
        width: 36px;
        height: 36px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .dialog-close:hover {
        background: rgba(255, 255, 255, 0.15);
        color: white;
      }

      .dialog-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .dialog-footer .btn {
        padding: 12px 24px;
        border-radius: 12px;
        font-weight: 600;
      }

      /* Form Elements */
      .form-label {
        display: block;
        font-size: 12px;
        margin-bottom: 6px;
        color: var(--venus-soft);
        font-weight: 500;
      }

      .form-input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--line);
        background: rgba(0, 0, 0, 0.3);
        color: #fff;
        font-size: 14px;
        transition: all 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--venus-green);
        background: rgba(0, 0, 0, 0.4);
      }

      .form-input:disabled,
      .form-input:read-only {
        background: rgba(0, 0, 0, 0.15);
        color: var(--muted);
        cursor: not-allowed;
      }

      /* Reminders Section */
      .reminders-section {
        background: rgba(140, 150, 104, 0.1);
        border: 1px solid rgba(140, 150, 104, 0.3);
        border-radius: 12px;
        padding: 16px;
      }

      .reminder-option {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
      }

      .reminder-option:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .reminder-option {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        transition: all 0.2s;
      }

      .reminder-option:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .reminder-option input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        margin-top: 3px;
        width: 20px;
        height: 20px;
        cursor: pointer;
        border: 2px solid var(--venus-soft);
        border-radius: 6px;
        background: rgba(0, 0, 0, 0.3);
        position: relative;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .reminder-option input[type="checkbox"]:hover {
        border-color: var(--venus-green);
        background: rgba(140, 150, 104, 0.1);
      }

      .reminder-option input[type="checkbox"]:checked {
        background: var(--venus-green);
        border-color: var(--venus-green);
      }

      /* Checkmark dibujado con CSS - BLANCO Y GRUESO */
      .reminder-option input[type="checkbox"]:checked::after {
        content: "";
        position: absolute;
        left: 6px;
        top: 2px;
        width: 6px;
        height: 12px;
        border: solid #fff;
        border-width: 0 3px 3px 0;
        transform: rotate(45deg);
        filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.5));
      }

      .reminder-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .reminder-text strong {
        font-size: 14px;
        color: #fff;
        font-weight: 500;
      }

      .reminder-text small {
        font-size: 12px;
        color: var(--muted);
        line-height: 1.4;
      }

      /* Weekly Calendar */
      .day-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .day-card:hover {
        background: rgba(140, 150, 104, 0.1);
        border-color: var(--venus-green);
      }

      .day-card.selected {
        background: rgba(140, 150, 104, 0.2);
        border-color: var(--venus-green);
      }

      .day-card.today {
        border: 2px solid var(--venus-green);
      }

      .day-name {
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        margin-bottom: 4px;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .data-table th,
      .data-table td {
        padding: 12px 8px;
        text-align: left;
        border-bottom: 1px solid var(--line);
      }

      .data-table th {
        font-weight: 600;
        color: var(--venus-soft);
        background: rgba(255, 255, 255, .02);
      }

      .data-table tbody tr:hover {
        background: rgba(255, 255, 255, .03);
      }

      /* Responsive table */
      @media (max-width: 768px) {
        .data-table thead {
          display: none;
        }

        .data-table,
        .data-table tbody,
        .data-table tr,
        .data-table td {
          display: block;
          width: 100%;
        }

        .data-table tr {
          margin-bottom: 20px;
          border: 1px solid rgba(140, 150, 104, 0.3);
          border-radius: 16px;
          padding: 16px;
          background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .data-table td {
          padding: 0;
          border: none;
          position: relative;
          padding-left: 0;
          text-align: left;
          margin-bottom: 12px;
        }

        .data-table td:last-child {
          margin-bottom: 0;
        }

        .data-table td::before {
          content: attr(data-label);
          display: block;
          font-weight: 600;
          color: var(--venus-soft);
          font-size: 11px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          margin-bottom: 4px;
        }

        /* First cell (time) - make it prominent */
        .data-table td:first-child {
          font-size: 28px;
          font-weight: 700;
          color: var(--venus-soft);
          margin-bottom: 16px;
          padding-bottom: 12px;
          border-bottom: 1px solid rgba(140, 150, 104, 0.2);
        }

        .data-table td:first-child::before {
          font-size: 10px;
          color: var(--muted);
        }

        /* Actions cell - full width buttons */
        .data-table td .actions,
        .data-table td:last-child {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-top: 16px;
          padding-top: 12px;
          border-top: 1px solid rgba(140, 150, 104, 0.1);
        }

        .data-table td .actions button,
        .data-table td:last-child button {
          width: 100%;
          justify-content: center;
          padding: 12px 16px;
          font-size: 15px;
          border-radius: 12px;
        }

        /* Hide label for actions */
        .data-table td:last-child::before {
          display: none;
        }
      }

      .day-number {
        font-size: 20px;
        font-weight: 700;
        color: #fff;
        margin-bottom: 4px;
      }

      .day-count {
        font-size: 11px;
        color: var(--venus-soft);
      }

      /* Stats Cards */
      .stat-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
      }

      .stat-label {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--venus-soft);
      }

      /* Section Headers */
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 12px;
      }

      .section-header h2 {
        font-size: 20px;
        font-weight: 700;
        color: var(--ink);
        margin: 0;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      /* Responsive Grids */
      .grid-service-price {
        display: grid;
        grid-template-columns: 1fr 120px;
        gap: 10px;
      }

      .grid-date-time {
        display: grid;
        grid-template-columns: 1fr 100px 90px 1fr;
        gap: 10px;
      }

      .full-width {
        grid-column: 1 / -1;
      }

      /* Mobile Responsiveness */
      @media (max-width: 768px) {
        .grid-service-price {
          grid-template-columns: 1fr;
        }

        .grid-date-time {
          grid-template-columns: 1fr 1fr;
          gap: 8px;
        }

        /* Make date span full width on mobile */
        .grid-date-time>div:first-child {
          grid-column: 1 / -1;
        }

        #newApptDialog,
        #editApptDialog {
          width: 95%;
          max-height: 95vh;
          margin: 10px auto;
        }

        .dialog-content {
          padding: 16px;
          max-height: 85vh;
          overflow-y: auto;
        }

        .form-label {
          font-size: 13px;
        }

        .form-input {
          font-size: 16px;
          /* Prevent zoom on iOS */
        }

        /* Adjust calendar dropdown for mobile to be centered */
        .calendar-dropdown {
          position: fixed;
          top: 50% !important;
          left: 50% !important;
          transform: translate(-50%, -50%);
          width: 90%;
          max-width: 320px;
          margin-top: 0;
          z-index: 2000;
        }
      }

      /* Custom Calendar Dropdown */
      .calendar-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        margin-top: 8px;
        background: #1a1a1a;
        /* Solid background */
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 16px;
        width: 300px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        min-width: 280px;
      }

      /* Custom Searchable Dropdown */
      .custom-select-wrapper {
        position: relative;
      }

      .dropdown-toggle-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--venus-soft);
        cursor: pointer;
        font-size: 12px;
        pointer-events: auto;
        /* Ensure click works */
        padding: 4px;
      }

      .custom-dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1001;
        margin-top: 4px;
        background: #1a1a1a;
        border: 1px solid var(--line);
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }

      .dropdown-item {
        padding: 10px 12px;
        cursor: pointer;
        font-size: 13px;
        color: var(--ink);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s;
      }

      .dropdown-item:last-child {
        border-bottom: none;
      }

      .dropdown-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .dropdown-item .item-meta {
        display: block;
        font-size: 11px;
        color: var(--muted);
        margin-top: 2px;
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        gap: 8px;
      }

      .calendar-nav-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--line);
        color: #fff;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
      }

      .calendar-nav-btn:hover {
        background: var(--venus-green);
        border-color: var(--venus-green);
      }

      .calendar-month-year {
        font-weight: 600;
        color: #fff;
        font-size: 14px;
      }

      /* Estilos del calendario movidos a la sección principal */

      /* Time Grid for Week/Day View */
      .time-grid-container {
        display: flex;
        flex-direction: column;
        height: 600px;
        overflow: hidden;
        background: #23241f;
        border: 1px solid var(--line);
        border-radius: 12px;
      }

      .time-grid-header {
        display: flex;
        border-bottom: 1px solid var(--line);
        background: #2c2d26;
      }

      .time-header-spacer {
        width: 60px;
        flex-shrink: 0;
        border-right: 1px solid var(--line);
      }

      .day-headers {
        display: flex;
        flex: 1;
      }

      .day-header-cell {
        flex: 1;
        text-align: center;
        padding: 10px;
        font-size: 13px;
        font-weight: 600;
        color: var(--ink);
        border-right: 1px solid rgba(255, 255, 255, 0.05);
      }

      .day-header-cell.today {
        color: var(--venus);
        background: rgba(140, 150, 104, 0.1);
      }

      .time-grid-body {
        display: flex;
        flex: 1;
        overflow-y: auto;
      }

      .time-labels {
        width: 60px;
        flex-shrink: 0;
        border-right: 1px solid var(--line);
      }

      .time-label {
        height: 60px;
        /* 1 hour */
        text-align: right;
        padding-right: 8px;
        font-size: 11px;
        color: var(--muted);
        transform: translateY(-8px);
      }

      .days-grid {
        display: flex;
        flex: 1;
        position: relative;
      }

      .day-column {
        flex: 1;
        border-right: 1px solid rgba(255, 255, 255, 0.05);
        position: relative;
      }

      .time-slot {
        height: 60px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        cursor: pointer;
        transition: background 0.1s;
      }

      .time-slot:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .time-slot::after {
        content: '+ Agendar';
        display: none;
        color: var(--venus-soft);
        font-size: 10px;
        padding: 4px;
      }

      .time-slot:hover::after {
        display: block;
      }

      .appt-block {
        position: absolute;
        left: 2px;
        right: 2px;
        padding: 4px;
        border-radius: 4px;
        font-size: 11px;
        overflow: hidden;
        cursor: pointer;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        border-left: 3px solid rgba(0, 0, 0, 0.2);
      }

      .appt-block:hover {
        z-index: 20;
        transform: scale(1.02);
      }



      .calendar-day-dot {
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background: var(--venus-soft);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        animation: dotPulse 2s ease-in-out infinite;
      }

      @keyframes dotPulse {

        0%,
        100% {
          opacity: 1;
        }

        50% {
          opacity: 0.6;
        }
      }

      .calendar-day.has-appointments {
        background: rgba(140, 150, 104, 0.12);
        border-color: rgba(140, 150, 104, 0.2);
      }

      .calendar-day.selected .calendar-day-dot {
        background: #000;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .calendar-day {
          min-height: 45px;
          border-radius: 8px;
        }

        .calendar-day-number {
          font-size: 13px;
        }

        .calendar-day-dot {
          width: 4px;
          height: 4px;
        }
      }

      /* ===== MODAL COBRAR SERVICIO ===== */
      .payment-info-row {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
      }

      .payment-info-box {
        flex: 1;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        padding: 12px;
        border: 1px solid var(--line);
      }

      .payment-info-label {
        font-size: 10px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .payment-info-value {
        font-size: 14px;
        font-weight: 500;
      }

      .payment-products {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 16px;
        border: 1px solid var(--line);
      }

      .payment-products-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .payment-products-header h4 {
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--venus-soft);
      }

      .product-add-row {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }

      .product-add-row select {
        flex: 1;
        padding: 10px 12px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--line);
        border-radius: 8px;
        color: var(--ink);
        font-size: 13px;
      }

      .product-add-row input {
        width: 65px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--line);
        border-radius: 8px;
        color: var(--ink);
        font-size: 13px;
        text-align: center;
      }

      .product-add-row button {
        padding: 10px 14px;
        background: var(--venus);
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
      }

      .product-add-row button:hover {
        background: var(--venus-soft);
      }

      .payment-product-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 180px;
        overflow-y: auto;
      }

      .payment-product-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        border: 1px solid var(--line);
      }

      .payment-product-icon {
        width: 32px;
        height: 32px;
        background: rgba(140, 150, 104, 0.2);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--venus-soft);
        font-size: 14px;
      }

      .payment-product-info {
        flex: 1;
        min-width: 0;
      }

      .payment-product-name {
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .payment-product-meta {
        font-size: 11px;
        color: var(--muted);
      }

      .payment-product-price {
        font-size: 13px;
        font-weight: 600;
        color: var(--venus-soft);
        white-space: nowrap;
      }

      .payment-product-remove {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        padding: 4px;
        opacity: 0.6;
        display: flex;
        align-items: center;
      }

      .payment-product-remove:hover {
        opacity: 1;
      }

      .payment-products-empty {
        text-align: center;
        padding: 16px;
        color: var(--muted);
        font-size: 12px;
      }

      .stock-warn {
        font-size: 10px;
        color: #fbbf24;
        display: flex;
        align-items: center;
        gap: 4px;
        margin-top: 2px;
      }

      .payment-totals {
        background: rgba(140, 150, 104, 0.1);
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 16px;
        border: 1px solid rgba(140, 150, 104, 0.2);
      }

      .payment-total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
      }

      .payment-total-row.subtotal {
        font-size: 13px;
        color: var(--muted);
      }

      .payment-total-row.grand {
        font-size: 18px;
        font-weight: 700;
        color: var(--venus-soft);
        border-top: 1px solid var(--line);
        padding-top: 12px;
        margin-top: 8px;
      }

      /* Estilos adicionales para modal mejorado */
      #paymentDialog {
        max-width: 440px !important;
      }

      .btn-close-payment {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--line);
        color: var(--muted);
        width: 36px;
        height: 36px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        z-index: 10;
      }

      .btn-close-payment:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.3);
        color: #ef4444;
      }

      .payment-price-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
      }

      .payment-price-display {
        font-size: 15px;
        font-weight: 600;
        color: var(--venus-soft);
      }

      .payment-price-input {
        width: 100px;
        padding: 6px 10px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--venus);
        border-radius: 8px;
        color: var(--ink);
        font-size: 15px;
        font-weight: 600;
        display: none;
      }

      .payment-price-input.visible {
        display: block;
      }

      .payment-price-display.hidden {
        display: none;
      }

      .btn-edit-price {
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
        display: flex;
        align-items: center;
      }

      .btn-edit-price:hover {
        color: var(--venus-soft);
        background: rgba(140, 150, 104, 0.1);
      }

      .payment-section {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 14px;
        padding: 16px;
        margin-bottom: 16px;
        border: 1px solid var(--line);
      }

      .payment-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 14px;
      }

      .payment-section-title {
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--venus-soft);
      }

      .discount-row {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .discount-toggle {
        display: flex;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid var(--line);
      }

      .discount-toggle button {
        padding: 10px 18px;
        background: transparent;
        border: none;
        color: var(--muted);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .discount-toggle button.active {
        background: var(--venus);
        color: white;
      }

      .discount-toggle button:hover:not(.active) {
        background: rgba(255, 255, 255, 0.05);
      }

      .discount-input-wrap {
        flex: 1;
        position: relative;
      }

      .discount-input-wrap input {
        width: 100%;
        padding: 10px 14px;
        padding-right: 36px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--line);
        border-radius: 10px;
        color: var(--ink);
        font-size: 14px;
      }

      .discount-input-wrap input:focus {
        outline: none;
        border-color: var(--venus);
      }

      .discount-symbol {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
        font-size: 14px;
        font-weight: 500;
      }

      .discount-applied {
        margin-top: 12px;
        padding: 10px 14px;
        background: rgba(34, 197, 94, 0.1);
        border-radius: 10px;
        font-size: 13px;
        color: #22c55e;
        display: none;
        align-items: center;
        gap: 8px;
      }

      .discount-applied.visible {
        display: flex;
      }

      .payment-total-row.sub {
        font-size: 13px;
        color: var(--muted);
      }

      .payment-total-row.subtotal-line {
        font-size: 14px;
        color: var(--ink);
      }

      .payment-total-row.discount {
        font-size: 13px;
        color: #22c55e;
        display: none;
      }

      .payment-total-row.discount.visible {
        display: flex;
      }

      .btn-cobrar {
        flex: 1;
        padding: 14px 24px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 12px;
      }

      /* ===== DASHBOARD MEJORADO ===== */
      .hero-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 24px;
      }

      @media (max-width: 900px) {
        .hero-stats {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .hero-stat {
        background: var(--card);
        border-radius: 16px;
        padding: 20px;
        border: 1px solid var(--line);
        position: relative;
        overflow: hidden;
      }

      .hero-stat::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: radial-gradient(circle, rgba(140, 150, 104, 0.15) 0%, transparent 70%);
        opacity: 0.5;
      }

      .hero-stat-icon {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 14px;
        background: rgba(140, 150, 104, 0.15);
        color: var(--venus-soft);
      }

      .hero-stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--ink);
        line-height: 1;
        margin-bottom: 6px;
        transition: all 0.3s ease;
      }

      .hero-stat-label {
        font-size: 13px;
        color: var(--muted);
      }

      .hero-stat-trend {
        position: absolute;
        top: 16px;
        right: 16px;
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .hero-stat-trend.up {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
      }

      .today-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 24px;
      }

      @media (max-width: 700px) {
        .today-grid {
          grid-template-columns: 1fr;
        }
      }

      .today-card {
        background: var(--card);
        border-radius: 14px;
        padding: 18px;
        border: 1px solid var(--line);
        display: flex;
        align-items: center;
        gap: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .today-card:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--venus);
        transform: translateY(-2px);
      }

      .today-card-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .today-card-icon.citas {
        background: rgba(59, 130, 246, 0.15);
        color: #60a5fa;
      }

      .today-card-icon.pendientes {
        background: rgba(251, 191, 36, 0.15);
        color: #fbbf24;
      }

      .today-card-icon.ingresos {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
      }

      .today-card-info h4 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 2px;
        transition: all 0.3s ease;
      }

      .today-card-info p {
        font-size: 12px;
        color: var(--muted);
      }

      .dash-empty {
        text-align: center;
        padding: 30px 20px;
        color: var(--muted);
      }

      .dash-empty p {
        font-size: 13px;
      }

      /* Sidebar y layout */
      .dash-grid {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 24px;
      }

      @media (max-width: 1000px) {
        .dash-grid {
          grid-template-columns: 1fr;
        }
      }

      .dash-sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* Gift Cards summary */
      .gc-summary {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .gc-summary-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .gc-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .gc-dot.pending {
        background: var(--venus);
      }

      .gc-dot.expiring {
        background: #fbbf24;
      }

      .gc-dot.redeemed {
        background: #22c55e;
      }

      .gc-label {
        flex: 1;
        font-size: 13px;
        color: var(--muted);
      }

      .gc-value {
        font-size: 14px;
        font-weight: 600;
      }

      .gc-value.warning {
        color: #fbbf24;
      }

      /* Cumpleaños */
      .birthday-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .birthday-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
      }

      .birthday-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff6b6b, #feca57);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }

      .birthday-info {
        flex: 1;
      }

      .birthday-info h4 {
        font-size: 13px;
        font-weight: 500;
      }

      .birthday-info p {
        font-size: 11px;
        color: var(--muted);
      }

      .birthday-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 10px;
        font-weight: 600;
      }

      .birthday-badge.soon {
        background: rgba(251, 191, 36, 0.15);
        color: #fbbf24;
      }

      .birthday-badge.today {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
      }

      /* Top clientes */
      .top-client-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 0;
        border-bottom: 1px solid var(--line);
      }

      .top-client-item:last-child {
        border-bottom: none;
      }

      .top-client-rank {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        background: rgba(140, 150, 104, 0.15);
        color: var(--venus-soft);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
      }

      .top-client-rank.gold {
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: #1a1a1a;
      }

      .top-client-info {
        flex: 1;
      }

      .top-client-info h4 {
        font-size: 13px;
        font-weight: 500;
      }

      .top-client-info p {
        font-size: 11px;
        color: var(--muted);
      }

      .top-client-stamps {
        text-align: right;
      }

      .top-client-stamps .count {
        font-size: 14px;
        font-weight: 700;
        color: var(--venus-soft);
      }

      .top-client-stamps .label {
        font-size: 10px;
        color: var(--muted);
      }

      /* Wallets */
      .wallets-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .wallet-card {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
      }

      .wallet-card-icon {
        font-size: 24px;
        margin-bottom: 8px;
      }

      .wallet-card-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--ink);
      }

      .wallet-card-label {
        font-size: 11px;
        color: var(--muted);
      }

      .card-header-link {
        color: var(--venus-soft);
        font-size: 12px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .card-header-link:hover {
        text-decoration: underline;
      }

      /* Scanner Modal */
      .scanner-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .scanner-modal.active {
        display: flex;
      }

      .scanner-content {
        width: 100%;
        max-width: 400px;
        text-align: center;
      }

      .scanner-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        font-size: 20px;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }

      .scanner-close:hover,
      .scanner-close:active {
        background: rgba(255, 255, 255, 0.2);
      }

      /* Mejorar área de toque en móviles */
      @media (max-width: 768px) {
        .scanner-close {
          width: 48px;
          height: 48px;
          top: 16px;
          right: 16px;
          background: rgba(0, 0, 0, 0.6);
          backdrop-filter: blur(10px);
        }

        .scanner-close:active {
          background: rgba(255, 255, 255, 0.3);
          transform: scale(0.95);
        }
      }

      .scanner-header {
        margin-bottom: 24px;
      }

      .scanner-header h2 {
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-bottom: 6px;
        color: var(--ink);
      }

      .scanner-header p {
        color: var(--muted);
        font-size: 14px;
      }

      .scanner-viewport {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 24px;
        position: relative;
      }

      .scanner-frame {
        width: 220px;
        height: 220px;
        margin: 0 auto 16px;
        position: relative;
        border-radius: 16px;
      }

      .scanner-corner {
        position: absolute;
        width: 30px;
        height: 30px;
        border: 3px solid var(--venus);
      }

      .scanner-corner.tl {
        top: 0;
        left: 0;
        border-right: none;
        border-bottom: none;
        border-radius: 8px 0 0 0;
      }

      .scanner-corner.tr {
        top: 0;
        right: 0;
        border-left: none;
        border-bottom: none;
        border-radius: 0 8px 0 0;
      }

      .scanner-corner.bl {
        bottom: 0;
        left: 0;
        border-right: none;
        border-top: none;
        border-radius: 0 0 0 8px;
      }

      .scanner-corner.br {
        bottom: 0;
        right: 0;
        border-left: none;
        border-top: none;
        border-radius: 0 0 8px 0;
      }

      .scanner-line {
        position: absolute;
        left: 10px;
        right: 10px;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--venus), transparent);
        top: 50%;
        animation: scan 2s ease-in-out infinite;
      }

      @keyframes scan {

        0%,
        100% {
          top: 20%;
          opacity: 0.5;
        }

        50% {
          top: 80%;
          opacity: 1;
        }
      }

      .scanner-hint {
        color: var(--muted);
        font-size: 13px;
      }

      .scanner-video {
        width: 100%;
        height: 220px;
        object-fit: cover;
        border-radius: 12px;
        background: #000;
        display: none;
      }

      .scanner-video.active {
        display: block;
      }

      .scanner-frame.hidden {
        display: none;
      }

      .scanner-options {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
      }

      .scanner-option {
        flex: 1;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        text-align: left;
      }

      .scanner-option-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .scanner-option-icon.loyalty {
        background: rgba(140, 150, 104, 0.2);
        color: var(--venus-soft);
      }

      .scanner-option-icon.gift {
        background: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
      }

      .scanner-option-info h4 {
        font-size: 13px;
        font-weight: 600;
        color: var(--ink);
        margin-bottom: 2px;
      }

      .scanner-option-info p {
        font-size: 11px;
        color: var(--muted);
      }

      .scanner-manual {
        padding-top: 16px;
        border-top: 1px solid var(--line);
      }

      .scanner-manual p {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 10px;
      }

      .scanner-result {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .scanner-result.active {
        display: block;
      }

      .scanner-result-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin: 0 auto 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .scanner-result-icon.loyalty {
        background: rgba(140, 150, 104, 0.2);
        color: var(--venus-soft);
      }

      .scanner-result-icon.gift {
        background: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
      }

      .scanner-result h3 {
        font-size: 18px;
        margin-bottom: 4px;
      }

      .scanner-result .subtitle {
        font-size: 14px;
        color: var(--muted);
        margin-bottom: 20px;
      }

      .scanner-result-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .quick-actions {
        position: fixed;
        bottom: 24px;
        right: 24px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 100;
      }

      .quick-action-btn {
        width: 56px;
        height: 56px;
        border-radius: 16px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        transition: all 0.2s;
      }

      .quick-action-btn.primary {
        background: var(--venus);
        color: white;
      }

      .quick-action-btn.primary:hover {
        background: var(--venus-soft);
        transform: scale(1.1);
      }

      @media (max-width: 600px) {
        #modal-product .row {
          flex-direction: column;
          align-items: stretch;
          gap: 12px;
        }
      }
    </style>

    <!-- DIALOG: Escáner QR -->
    <dialog id="scanDialog">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <h3 style="margin:0;font-size:16px;">Escanear tarjeta</h3>
        <button type="button" id="scan-close" class="btn small ghost">Cerrar</button>
      </div>
      <div id="qr-reader" style="width:100%;"></div>
      <div class="muted" id="scan-status" style="margin-top:8px;font-size:12px;">Iniciando cámara…</div>
    </dialog>

    <!-- DIALOG: Escáner Gift Card -->
    <dialog id="giftScanDialog"
      style="background:rgba(27,28,26,0.95);border:1px solid rgba(255,255,255,0.15);border-radius:16px;padding:20px;max-width:500px;width:90%;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h3 style="margin:0;font-size:16px;color:#f9fafb;"><i class="fas fa-qrcode"></i> Escan gift card</h3>
        <button type="button" id="gift-scan-close" class="btn small ghost">Cerrar</button>
      </div>
      <div id="gift-qr-reader" style="width:100%;"></div>
      <div class="muted" id="gift-scan-status" style="margin-top:12px;font-size:13px;text-align:center;">Esperando
        escaneo...</div>
    </dialog>


    <footer class="footer">© Venus Cosmetología</footer>

    <!-- Modal Tarjeta - SIMPLIFICADO -->
    <div id="card-modal-backdrop" class="modal-backdrop hidden">
      <div class="modal-card" style="max-width:420px;">

        <!-- Header con acciones rápidas -->
        <div class="modal-header" style="flex-wrap:wrap;gap:10px;">
          <h3 style="margin:0;flex:1;"><i class="fas fa-user"></i> Cliente</h3>
          <div style="display:flex;gap:6px;">
            <button id="cm-stamp" class="btn small" style="background:#FFD166;color:#1b1b1b;font-weight:600;">⭐ +1
              sello</button>
            <button id="cm-close" class="btn small ghost" onclick="closeCardModal()">✕</button>
          </div>
        </div>

        <!-- Info del cliente -->
        <div class="modal-body" style="padding:16px 0;">

          <!-- Datos principales -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
            <div>
              <div class="muted" style="font-size:11px;margin-bottom:2px;">Nombre</div>
              <div id="cm-name" style="font-weight:600;font-size:15px;">—</div>
            </div>
            <div>
              <div class="muted" style="font-size:11px;margin-bottom:2px;">Teléfono <button id="cm-edit-phone-btn"
                  style="background:none;border:none;color:var(--venus-soft);cursor:pointer;font-size:10px;padding:0;margin-left:4px;">✏️
                  editar</button></div>
              <div id="cm-phone-display" style="font-size:15px;">—</div>
              <div id="cm-phone-edit" class="hidden" style="display:flex;gap:6px;align-items:center;">
                <input type="tel" id="cm-phone-input"
                  style="flex:1;padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:rgba(0,0,0,0.3);color:#fff;font-size:14px;"
                  placeholder="10 dígitos">
                <button id="cm-phone-save" class="btn small" style="padding:6px 10px;background:#22c55e;">✓</button>
                <button id="cm-phone-cancel" class="btn small ghost" style="padding:6px 8px;">✕</button>
              </div>
            </div>
          </div>

          <!-- Sellos con barra de progreso -->
          <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:14px;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <span style="font-size:13px;">Progreso</span>
              <span id="cm-stamps" style="font-weight:700;font-size:18px;color:var(--venus-soft);">0 / 8</span>
            </div>
            <div style="background:rgba(255,255,255,0.1);border-radius:8px;height:8px;overflow:hidden;">
              <div id="cm-progress-bar"
                style="background:linear-gradient(90deg,#FFD166,#8c9668);height:100%;width:0%;transition:width 0.3s;border-radius:8px;">
              </div>
            </div>
            <div id="cm-status-text" class="muted" style="font-size:11px;margin-top:6px;text-align:center;">—</div>
          </div>

          <!-- Próxima cita (si existe) -->
          <div id="cm-next-appt-section" class="hidden"
            style="background:rgba(140,150,104,0.15);border:1px solid rgba(140,150,104,0.3);border-radius:12px;padding:12px;margin-bottom:16px;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
              <span>📅</span>
              <span style="font-size:12px;color:var(--venus-soft);font-weight:600;">Próxima cita</span>
            </div>
            <div id="cm-next-appt-date" style="font-size:18px;font-weight:700;color:#22c55e;">—</div>
            <div id="cm-next-appt-service" style="font-size:13px;margin-top:2px;">—</div>
          </div>

          <!-- Stats rápidos -->
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;">
            <div style="text-align:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;">
              <div id="cm-visited-count" style="font-size:18px;font-weight:700;color:var(--venus-soft);">0</div>
              <div class="muted" style="font-size:10px;">Visitas</div>
            </div>
            <div style="text-align:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;">
              <div id="cm-cycles-completed" style="font-size:18px;font-weight:700;color:var(--venus-soft);">0</div>
              <div class="muted" style="font-size:10px;">Ciclos</div>
            </div>
            <div style="text-align:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;">
              <div id="cm-last-visit" style="font-size:12px;font-weight:600;color:var(--venus-soft);">—</div>
              <div class="muted" style="font-size:10px;">Última visita</div>
            </div>
          </div>

          <!-- Notas (colapsable) -->
          <details style="margin-bottom:16px;">
            <summary style="cursor:pointer;font-size:13px;color:var(--venus-soft);margin-bottom:8px;">📝 Notas del
              cliente</summary>
            <textarea id="cm-notes" class="modal-textarea" rows="2" placeholder="Agregar notas..."
              style="width:100%;background:rgba(0,0,0,0.2);border:1px solid var(--line);border-radius:8px;padding:10px;color:#fff;font-size:13px;resize:none;"></textarea>
            <button id="cm-save-notes" class="btn small ghost" style="margin-top:6px;font-size:11px;"><i
                class="fas fa-save"></i> Guardar
              nota</button>
          </details>

          <!-- QR (colapsable) -->
          <details>
            <summary style="cursor:pointer;font-size:13px;color:var(--venus-soft);margin-bottom:8px;">🔲 Código QR
            </summary>
            <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:12px;text-align:center;">
              <canvas id="card-qr" style="max-width:150px;"></canvas>
              <div class="muted" style="font-size:10px;margin-top:6px;">ID: <code id="cm-id"
                  style="font-size:10px;">—</code></div>
            </div>
          </details>

        </div>

        <!-- Footer con acciones -->
        <div class="modal-footer"
          style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.1);">
          <button id="cm-whatsapp" class="btn small" style="background:#25D366;color:white;">
            💬 WhatsApp
          </button>
          <button id="cm-schedule" class="btn small" style="background:#8c9668;color:white;">
            📅 Agendar
          </button>
          <button id="cm-redeem" class="btn small">
            🎁 Canjear
          </button>
        </div>

        <!-- Acciones secundarias -->
        <div
          style="display:flex;justify-content:center;gap:12px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.05);flex-wrap:wrap;">
          <button id="cm-copy" class="btn-link"
            style="background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;">Copiar ID</button>
          <button id="cm-open-url" class="btn-link"
            style="background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;">Abrir página</button>
          <button id="cm-notify" class="btn-link"
            style="background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;">Notificar</button>
          <button id="cm-force-update" class="btn-link"
            style="background:none;border:none;color:var(--venus-soft);font-size:11px;cursor:pointer;">🔄 Actualizar
            pase</button>
          <button id="cm-delete" class="btn-link"
            style="background:none;border:none;color:#ef4444;font-size:11px;cursor:pointer;">Eliminar</button>
        </div>

        <!-- Formulario de Notificación Individual (Oculto por defecto) -->
        <div id="notify-form-container" class="notify-form-container hidden" style="margin-top:16px;">
          <span class="notify-form-header">🔔 Push Individual</span>
          <div class="input-group">
            <input id="notify-title" class="notify-input" placeholder="Título" value="Recordatorio Venus">
            <span class="input-icon">📌</span>
          </div>
          <div class="input-group">
            <textarea id="notify-message" class="notify-textarea" placeholder="Escribe tu mensaje aquí..."></textarea>
            <span class="input-icon">💬</span>
          </div>
          <div class="notify-btn-group" style="display:flex;gap:8px;margin-top:10px;">
            <button id="btn-cancel-notify" class="btn small ghost">Cancelar</button>
            <button id="btn-send-notify" class="btn small primary">🚀 Enviar</button>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- Off-Canvas Menu for Module Selection -->
  <div class="offcanvas-backdrop" id="offcanvas-backdrop"></div>
  <div class="offcanvas" id="modules-offcanvas">
    <div class="offcanvas-header">
      <h3 class="offcanvas-title">🎛️ Personalizar Dashboard</h3>
      <button class="btn small ghost" id="close-offcanvas">✕</button>
    </div>

    <p class="muted" style="font-size: 13px; margin-bottom: 20px;">
      Selecciona los módulos que deseas ver en el Resumen
    </p>

    <!-- Module Toggles -->
    <div id="module-list">
      <div class="module-item" data-module="kpis">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-chart-bar"></i></span>
          <span class="module-label">KPIs Principales</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="kpis" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="birthdays">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-birthday-cake"></i></span>
          <span class="module-label">Cumpleaños</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="birthdays" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="activity">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-chart-line"></i></span>
          <span class="module-label">Gráfica de Actividad</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="activity" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="topClients">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-star"></i></span>
          <span class="module-label">Top Clientes</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="topClients" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="walletStats">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-mobile-alt"></i></span>
          <span class="module-label">Estado de Wallets</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="walletStats" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="newKPIs">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-chart-bar"></i></span>
          <span class="module-label">KPIs Avanzados</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="newKPIs" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

    <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
      <button id="reset-modules" class="btn small ghost" style="width: 100%;">
        🔄 Restaurar por defecto
      </button>
    </div>
  </div>

  <!-- Modal Nuevo/Editar Servicio -->
  <!-- Modal Nuevo/Editar Servicio -->
  <div id="modal-service" class="modal-backdrop hidden">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="modal-service-title">Nuevo Servicio</h3>
        <span class="close-modal" id="close-modal-service">&times;</span>
      </div>

      <form id="form-service">
        <input type="hidden" id="service-id">

        <div class="form-group">
          <label class="form-label">Nombre del Servicio</label>
          <input type="text" id="service-name" class="form-input" required placeholder="Ej. Facial Hidratante">
        </div>

        <div class="form-group">
          <label class="form-label">Categoría</label>
          <input type="text" id="service-category" class="form-input" list="categories-list" placeholder="Ej. Faciales">
          <datalist id="categories-list">
            <option value="Faciales">
            <option value="Corporales">
            <option value="Depilación">
            <option value="Masajes">
            <option value="Paquetes">
            <option value="Diagnóstico">
            <option value="Otros">
          </datalist>
        </div>

        <div class="row" style="gap:15px;">
          <div class="form-group" style="flex:1;">
            <label class="form-label">Duración (min)</label>
            <input type="number" id="service-duration" class="form-input" required min="10" step="5" value="60">
          </div>
          <div class="form-group" style="flex:1;">
            <label class="form-label">Precio</label>
            <div style="position:relative;">
              <span
                style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:14px;">$</span>
              <input type="number" id="service-price" class="form-input" required min="0" step="any"
                style="padding-left:25px;">
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Descripción (lista de beneficios)</label>
          <textarea id="service-description" class="form-input" rows="4"
            placeholder="Un beneficio por línea..."></textarea>
          <div class="muted" style="font-size:11px;margin-top:4px;">Escribe cada punto en una línea separada.</div>
        </div>

        <div class="form-group">
          <label class="form-label">Descuento/Promoción (Opcional)</label>
          <input type="text" id="service-discount" class="form-input" placeholder="Ej. 10% descuento en efectivo">
        </div>

        <div class="modal-footer">
          <button type="button" class="btn ghost" id="cancel-service">Cancelar</button>
          <button type="submit" class="btn primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- QRCode lib -->

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- Chart.js lib -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    // ===== FUNCIONES GLOBALES MENÚ MÓVIL =====
    // Definidas al inicio para que estén disponibles para onclick en HTML
    function openMobileMenu() {
      console.log('👆 Abriendo menú móvil');
      const mobileMenu = document.getElementById('mobile-menu');
      if (mobileMenu) {
        mobileMenu.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }
    }

    function closeMobileMenu() {
      console.log('👆 Cerrando menú móvil');
      const mobileMenu = document.getElementById('mobile-menu');
      if (mobileMenu) {
        mobileMenu.classList.add('hidden');
        document.body.style.overflow = '';
      }
    }

    // ===== FIREBASE REAL-TIME LISTENERS =====
    // Sistema de polling para actualización de datos (reemplaza Firebase realtime)
    let pollingInterval = null;

    // Inicializar sistema de polling (reemplaza Firebase)
    async function initFirebase() {
      console.log('📊 Usando PostgreSQL - iniciando polling para actualizaciones');
      startPolling();
    }

    // Polling cada 30 segundos para detectar cambios
    function startPolling() {
      // Polling inicial
      console.log('🔄 Sistema de polling iniciado (cada 30s)');

      pollingInterval = setInterval(() => {
        const requestsTab = document.getElementById('tab-requests');
        if (requestsTab && !requestsTab.classList.contains('hidden')) {
          loadBookingRequests();
        }

        const overviewTab = document.getElementById('tab-overview');
        if (overviewTab && !overviewTab.classList.contains('hidden')) {
          loadTodayStats();
        }
      }, 30000); // 30 segundos
    }

    // Limpiar polling cuando sea necesario
    function cleanupListeners() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
    }

    // Global instances
    let newApptClientDropdown, newApptServiceDropdown, editApptServiceDropdown;

    // Payment dialog variables
    let currentPaymentApptId = null;
    const paymentDialog = document.getElementById('paymentDialog');
    const formPayment = document.getElementById('form-payment');

    const $ = s => document.querySelector(s);

    /* ===== MODULE SELECTION SYSTEM ===== */
    const DEFAULT_MODULES = {
      kpis: true,
      birthdays: true,
      activity: true,
      topClients: true,
      walletStats: true,
      newKPIs: true
    };

    // Load saved modules from localStorage
    function getSelectedModules() {
      const saved = localStorage.getItem('venus_modules');
      return saved ? JSON.parse(saved) : { ...DEFAULT_MODULES };
    }

    // Save modules to localStorage
    function saveSelectedModules(modules) {
      localStorage.setItem('venus_modules', JSON.stringify(modules));
    }

    // Apply module visibility
    function applyModuleVisibility() {
      const modules = getSelectedModules();

      // Find and toggle module visibility based on data-module-section attributes
      document.querySelectorAll('[data-module-section]').forEach(section => {
        const moduleName = section.getAttribute('data-module-section');
        if (modules[moduleName] === false) {
          section.style.display = 'none';
        } else {
          section.style.display = '';
        }
      });
    }



    /* ===== GIFT CARD QR SCANNER ===== */
    let giftHtml5QrcodeScanner = null;
    const giftScanDialog = document.getElementById('giftScanDialog');
    const giftScanStatus = document.getElementById('gift-scan-status');

    // Botón para abrir scanner
    document.getElementById('btn-scan-gift-card')?.addEventListener('click', () => {
      openGiftScanner();
    });

    // Botón para cerrar scanner
    document.getElementById('gift-scan-close')?.addEventListener('click', () => {
      closeGiftScanner();
    });

    function openGiftScanner() {
      if (typeof Html5Qrcode === 'undefined') {
        alert('❌ Librería de scanner no disponible');
        return;
      }

      giftScanDialog.showModal();
      giftScanStatus.textContent = 'Iniciando cámara...';

      // Inicializar scanner
      giftHtml5QrcodeScanner = new Html5Qrcode('gift-qr-reader');

      const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      };

      giftHtml5QrcodeScanner.start(
        { facingMode: 'environment' }, // Cámara trasera
        config,
        onGiftScanSuccess,
        onGiftScanError
      ).then(() => {
        giftScanStatus.textContent = '📷 Escanea el QR de la gift card';
      }).catch(err => {
        console.error('Error iniciando cámara:', err);
        giftScanStatus.textContent = '❌ Error al iniciar cámara';
      });
    }

    function closeGiftScanner() {
      if (giftHtml5QrcodeScanner) {
        giftHtml5QrcodeScanner.stop().then(() => {
          giftHtml5QrcodeScanner.clear();
          giftHtml5QrcodeScanner = null;
        }).catch(err => {
          console.error('Error cerrando scanner:', err);
        });
      }
      giftScanDialog.close();
    }

    async function onGiftScanSuccess(decodedText) {
      console.log('✅ QR escaneado:', decodedText);
      giftScanStatus.textContent = '✅ QR detectado, procesando...';

      // Detener scanner
      if (giftHtml5QrcodeScanner) {
        await giftHtml5QrcodeScanner.stop();
      }

      // Procesar gift card
      await processGiftCardScan(decodedText);
    }

    function onGiftScanError(error) {
      // Silenciar errores de escaneo continuo
    }

    async function processGiftCardScan(giftId) {
      try {
        // Buscar gift card
        const response = await fetch(`/api/admin/gift-card/${giftId}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Gift card no encontrada');
        }

        const giftCard = await response.json();

        // Verificar si ya fue canjeada
        if (giftCard.redeemed) {
          giftScanStatus.textContent = '⚠️ Esta gift card ya fue canjeada';
          alert(`⚠️ Gift card ya canjeada\n\nCanjeada por: ${giftCard.redeemedBy || 'No disponible'}\nFecha: ${new Date(giftCard.redeemedAt).toLocaleString('es-MX')}`);
          setTimeout(() => {
            closeGiftScanner();
          }, 2000);
          return;
        }

        // Confirmar canje
        const confirmed = confirm(`¿Canjear gift card?\n\nServicio: ${giftCard.service}\nCliente: ${giftCard.clientName || 'Anónimo'}\n\n¿Marcar como canjeada?`);

        if (!confirmed) {
          giftScanStatus.textContent = 'Canje cancelado';
          setTimeout(() => {
            closeGiftScanner();
          }, 1500);
          return;
        }

        // Marcar como canjeada
        const redeemResponse = await fetch(`/api/admin/gift-card/${giftId}/redeem`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });

        if (!redeemResponse.ok) {
          throw new Error('Error al canjear');
        }

        giftScanStatus.textContent = '✅ Gift card canjeada correctamente';
        alert('✅ Gift card canjeada exitosamente');

        // Recargar lista de gift cards si estamos en ese tab
        if (!document.getElementById('tab-events').classList.contains('hidden')) {
          loadGiftHistory();
        }

        setTimeout(() => {
          closeGiftScanner();
        }, 1500);

      } catch (error) {
        console.error('Error procesando gift card:', error);
        giftScanStatus.textContent = `❌ ${error.message}`;
        alert(`❌ Error: ${error.message}`);
        setTimeout(() => {
          closeGiftScanner();
        }, 2000);
      }
    }

    /* ===== SESIÓN Y PROTECCIÓN ===== */
    async function loadMe() {
      try {
        const r = await fetch("/api/admin/me", { credentials: "include" });

        // ⭐ CRÍTICO: Si no hay sesión válida, redirigir al login
        if (!r.ok) {
          console.log("Sin sesión válida, redirigiendo a login...");
          window.location.href = "/admin-login.html";
          return;
        }

        const j = await r.json();
        $("#me-line").textContent = "Sesión: " + (j.email || j.uid || "admin");

        // ⭐ CRÍTICO: Quitar la pantalla negra solo cuando la sesión sea válida
        document.body.classList.remove('checking-auth');
        document.body.classList.add('auth-verified');

        // Cargar datos iniciales
        loadMetrics('week');
      } catch (e) {
        console.error("Error verificando sesión:", e);
        // Si hay error de red o servidor, también redirigir
        window.location.href = "/admin-login.html";
      }
    }

    // ⭐ CRÍTICO: Verificar sesión ANTES de mostrar cualquier cosa
    loadMe();

    /* ===== TABS ===== */
    document.querySelectorAll('[data-tab]').forEach(tab => {
      tab.addEventListener('click', function (e) {
        e.preventDefault();

        document.querySelectorAll('.nav a').forEach(a => a.classList.remove('is-active'));
        this.classList.add('is-active');

        document.querySelectorAll('[id^="tab-"]').forEach(s => s.classList.add('hidden'));

        const targetId = 'tab-' + this.getAttribute('data-tab');
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
          targetSection.classList.remove('hidden');
        }

        const tabName = this.getAttribute('data-tab');
        if (tabName === 'overview') {
          loadDashboardStats();
          // Iniciar auto-refresh del dashboard
          if (typeof startDashboardAutoRefresh === 'function') startDashboardAutoRefresh();
        } else if (tabName === 'cards') {
          loadCards(1);
          // Detener auto-refresh del dashboard
          if (typeof stopDashboardAutoRefresh === 'function') stopDashboardAutoRefresh();
        } else if (tabName === 'events') {
          loadGiftCardServices();
          loadGiftCards();
          if (typeof stopDashboardAutoRefresh === 'function') stopDashboardAutoRefresh();
        } else if (tabName === 'services') {
          loadServicesTable();
          if (typeof stopDashboardAutoRefresh === 'function') stopDashboardAutoRefresh();
        } else if (tabName === 'requests') {
          loadBookingRequests();
          initAgendarUrl();
          startRequestsAutoRefresh();
          if (typeof stopDashboardAutoRefresh === 'function') stopDashboardAutoRefresh();
        } else if (tabName === 'settings') {
          loadBusinessConfig();
          loadNotificationsHistory();
          if (typeof stopDashboardAutoRefresh === 'function') stopDashboardAutoRefresh();
        } else if (tabName === 'appointments') {
          if (typeof loadAppointments === 'function') loadAppointments();
          if (typeof loadMonthStats === 'function') loadMonthStats();
          // Iniciar auto-refresh cuando se entra al tab de appointments
          if (typeof startAppointmentsAutoRefresh === 'function') startAppointmentsAutoRefresh();
          // Detener auto-refresh del dashboard
          if (typeof stopDashboardAutoRefresh === 'function') stopDashboardAutoRefresh();
        } else if (tabName === 'reports') {
          if (typeof initReportsTab === 'function') initReportsTab();
          if (typeof stopDashboardAutoRefresh === 'function') stopDashboardAutoRefresh();
        } else {
          // Detener auto-refresh cuando se sale de los tabs
          if (typeof stopAppointmentsAutoRefresh === 'function') stopAppointmentsAutoRefresh();
          if (typeof stopRequestsAutoRefresh === 'function') stopRequestsAutoRefresh();
          if (typeof stopDashboardAutoRefresh === 'function') stopDashboardAutoRefresh();
        }
      });
    });

    /* ===== FILTRADO Y REPORTES ===== */
    let globalStatsData = {};

    // Evento cambio de filtro (comentado - elemento no existe en nuevo dashboard)
    // document.getElementById('stats-filter')?.addEventListener('change', (e) => {
    //   loadMetrics(e.target.value);
    // });

    function downloadCSV() {
      if (!globalStatsData.clientsToExport || globalStatsData.clientsToExport.length === 0) {
        alert('⚠️ No hay datos para exportar. Espera a que carguen las métricas.');
        return;
      }

      // Get selected modules from localStorage
      const selectedModules = getSelectedModules();

      const period = 'month'; // Default period
      const periodLabel = 'Este Mes';

      let csvContent = 'data:text/csv;charset=utf-8,';

      // Header
      csvContent += `REPORTE DE LEALTAD VENUS\r\n`;
      csvContent += `Periodo: ${periodLabel}\r\n`;
      csvContent += `Generado: ${new Date().toLocaleString('es-MX')}\r\n`;
      csvContent += `\r\n`;

      // ===== KPIs Section (if enabled) =====
      if (selectedModules.kpis !== false) {
        csvContent += `MÉTRICAS GENERALES\r\n`;
        csvContent += `Métrica,Valor\r\n`;
        csvContent += `Total Tarjetas Activas,${globalStatsData.total || 0}\r\n`;
        csvContent += `Tarjetas Completadas,${globalStatsData.full || 0}\r\n`;
        csvContent += `Sellos en este periodo,${globalStatsData.stamps || 0}\r\n`;
        csvContent += `Canjes en este periodo,${globalStatsData.redeems || 0}\r\n`;
        csvContent += `Promedio de Sellos,${globalStatsData.avg || 0}\r\n`;
        csvContent += `Tasa de Completitud,${globalStatsData.rate || '0%'}\r\n`;
        csvContent += `\r\n`;
      }

      // ===== Top Clients Section (if enabled) =====
      if (selectedModules.topClients !== false && globalStatsData.clients && globalStatsData.clients.length > 0) {
        csvContent += `TOP CLIENTES\r\n`;
        csvContent += `Nombre,Sellos,Meta,Estado,Progreso\r\n`;
        globalStatsData.clients.forEach(c => {
          const estado = c.stamps >= c.max ? "Completada" : "En curso";
          const progreso = Math.round((c.stamps / c.max) * 100) + '%';
          const name = (c.name || "Sin nombre").replace(/,/g, "");
          csvContent += `${name},${c.stamps},${c.max},${estado},${progreso}\r\n`;
        });
        csvContent += `\r\n`;
      }

      // ===== Wallet Stats Section (if enabled) =====
      if (selectedModules.walletStats !== false && globalStatsData.walletStats) {
        csvContent += `ESTADO DE WALLETS\r\n`;
        csvContent += `Plataforma,Cantidad\r\n`;
        csvContent += `Google Wallet,${globalStatsData.walletStats.google || 0}\r\n`;
        csvContent += `Apple Wallet,${globalStatsData.walletStats.apple || 0}\r\n`;
        csvContent += `Dispositivos Totales,${globalStatsData.walletStats.total || 0}\r\n`;
        csvContent += `\r\n`;
      }

      // ===== All Cards Data =====
      csvContent += `TODAS LAS TARJETAS\r\n`;
      csvContent += `Nombre,Teléfono,Sellos Actuales,Meta,Estado,Fecha Nacimiento,Última Visita,Creada,Visitas Totales,Ciclos Completados,Servicios Favoritos,Notas\r\n`;

      globalStatsData.clientsToExport.forEach(c => {
        const estado = c.stamps >= c.max ? "Completada" : "En curso";
        const phone = c.phone || "";
        const bday = c.birthdate || "";
        const last = c.last_visit ? new Date(c.last_visit).toLocaleDateString() : (c.updated_at ? new Date(c.updated_at).toLocaleDateString() : "");
        const created = c.createdAt ? new Date(c.createdAt).toLocaleDateString() : "";
        const name = (c.name || "Sin nombre").replace(/,/g, "");

        // ⭐ FASE 5: Nuevas columnas
        const visitedCount = c.visitedCount || 0;
        const cyclesCompleted = c.cyclesCompleted || 0;
        const favoriteServices = (c.favoriteServices || "").replace(/,/g, ";"); // Reemplazar comas
        const notes = (c.notes || "").replace(/,/g, ";").replace(/\r?\n/g, " "); // Reemplazar comas y saltos de línea

        csvContent += `${name},${phone},${c.stamps},${c.max},${estado},${bday},${last},${created},${visitedCount},${cyclesCompleted},${favoriteServices},${notes}\r\n`;
      });

      // Create download
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', `venus_reporte_${period}_${Date.now()}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      console.log('✅ CSV generado con módulos:', Object.keys(selectedModules).filter(k => selectedModules[k] !== false));
    }

    /* ===== METRICS (Firestore) - MEJORADO CON FILTROS ===== */
    let activityChart = null;

    async function loadMetrics(range = 'week') {
      try {
        // Actualizar etiquetas según el rango
        updatePeriodLabels(range);

        // Métricas básicas con filtro de rango
        const response = await fetch(`/api/admin/metrics-firebase?range=${range}`, {
          credentials: 'include'
        });
        const data = await response.json();

        // KPIs principales (con verificación null)
        const kpiTotal = document.getElementById('kpi-total');
        const kpiFull = document.getElementById('kpi-full');
        const kpiStamps = document.getElementById('kpi-stamps');
        const kpiRedeems = document.getElementById('kpi-redeems');
        const kpiAvg = document.getElementById('kpi-avg');
        const kpiRate = document.getElementById('kpi-rate');

        if (kpiTotal) kpiTotal.textContent = data.total || 0;
        if (kpiFull) kpiFull.textContent = data.full || 0;

        // Actualizar según el rango
        if (range === 'day') {
          if (kpiStamps) kpiStamps.textContent = data.stampsToday || 0;
          if (kpiRedeems) kpiRedeems.textContent = data.redeemsToday || 0;
        } else if (range === 'week') {
          if (kpiStamps) kpiStamps.textContent = data.stampsWeek || 0;
          if (kpiRedeems) kpiRedeems.textContent = data.redeemsWeek || 0;
        } else if (range === 'month') {
          if (kpiStamps) kpiStamps.textContent = data.stampsMonth || 0;
          if (kpiRedeems) kpiRedeems.textContent = data.redeemsMonth || 0;
        }

        // Promedio sellos
        const avg = data.total > 0 ? (((data.totalStamps || 0) / data.total)).toFixed(1) : '0.0';
        if (kpiAvg) kpiAvg.textContent = avg;

        // Tasa de completitud
        const rate = data.total > 0 ? ((data.full / data.total) * 100).toFixed(0) : '0';
        if (kpiRate) kpiRate.textContent = rate + '%';

        // Cargar componentes adicionales
        await loadTopClients();
        await loadActivityChart(range);
        await loadWalletStats();

        // Fetch ALL cards for Birthdays & Report
        // Note: For large datasets, this should be paginated or a separate endpoint
        try {
          const cardsResp = await fetch('/api/admin/cards-firebase?limit=1000', { credentials: 'include' });
          if (cardsResp.ok) {
            const cardsData = await cardsResp.json();
            checkOverviewBirthdays(cardsData.items || []);

            // Populate globalStatsData.clients with ALL clients for the report
            // (loadTopClients only gets top 5)
            if (cardsData.items) {
              globalStatsData.allClients = cardsData.items;
            }
          }
        } catch (e) {
          console.error("Error fetching cards for overview:", e);
        }

        // Guardar datos para reporte
        globalStatsData = {
          ...globalStatsData, // Keep allClients if set
          total: data.total || 0,
          full: data.full || 0,
          stampsPeriod: range === 'day' ? data.stampsToday : (range === 'week' ? data.stampsWeek : data.stampsMonth),
          redeemsPeriod: range === 'day' ? data.redeemsToday : (range === 'week' ? data.redeemsWeek : data.redeemsMonth),
          avg: avg,
          rate: rate,
          range: range
        };

      } catch (error) {
        console.error('Error:', error);
        // En caso de error, cargar datos de ejemplo
        loadSampleData(range);
      }
    }

    function updatePeriodLabels(range) {
      const stampsLabel = document.getElementById('stamps-period-label');
      const redeemsLabel = document.getElementById('redeems-period-label');
      const activityTitle = document.getElementById('activity-title');

      if (range === 'day') {
        if (stampsLabel) stampsLabel.textContent = 'Sellos hoy';
        if (redeemsLabel) redeemsLabel.textContent = 'Canjes hoy';
        if (activityTitle) activityTitle.textContent = '📈 Actividad hoy';
      } else if (range === 'week') {
        if (stampsLabel) stampsLabel.textContent = 'Sellos esta semana';
        if (redeemsLabel) redeemsLabel.textContent = 'Canjes esta semana';
        if (activityTitle) activityTitle.textContent = '📈 Actividad reciente (7 días)';
      } else if (range === 'month') {
        if (stampsLabel) stampsLabel.textContent = 'Sellos este mes';
        if (redeemsLabel) redeemsLabel.textContent = 'Canjes este mes';
        if (activityTitle) activityTitle.textContent = '📈 Actividad mensual';
      }
    }


    /* ===== ADVANCED KPIS (NUEVO - FASE 3) ===== */
    let dayChart = null;
    let hourChart = null;

    async function loadAdvancedKPIs(range = 'week') {
      try {
        // Obtener todas las tarjetas para análisis
        const response = await fetch('/api/admin/cards-all?limit=1000', {
          credentials: 'include'
        });
        const data = await response.json();
        const cards = data.items || [];

        const now = new Date();
        const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

        // Determinar rango para "clientes nuevos"
        let periodStart;
        if (range === 'day') {
          periodStart = new Date(now.setHours(0, 0, 0, 0));
        } else if (range === 'week') {
          periodStart = new Date(now - 7 * 24 * 60 * 60 * 1000);
        } else {
          periodStart = new Date(now.getFullYear(), now.getMonth(), 1);
        }

        // 1. Clientes nuevos
        const newClients = cards.filter(c => {
          if (!c.createdAt) return false;
          return new Date(c.createdAt) >= periodStart;
        });

        // 2 & 3. Clientes activos e inactivos (últimos 30 días)
        const activeClients = cards.filter(c => {
          const lastVisit = c.lastVisit || c.last_visit || c.updatedAt || c.updated_at;
          if (!lastVisit) return false;
          return new Date(lastVisit) >= thirtyDaysAgo;
        });
        const inactiveClients = cards.length - activeClients.length;

        // 4. Promedio días desde última visita
        let totalDays = 0;
        let count = 0;
        cards.forEach(c => {
          const lastVisit = c.lastVisit || c.last_visit || c.updatedAt || c.updated_at;
          if (lastVisit) {
            const days = Math.floor((Date.now() - new Date(lastVisit).getTime()) / (24 * 60 * 60 * 1000));
            totalDays += days;
            count++;
          }
        });
        const avgLastVisit = count > 0 ? Math.round(totalDays / count) : 0;

        // 5. Ciclos completados
        const cyclesCompleted = cards.filter(c => c.stamps >= c.max).length;

        // 6. Tasa de retorno (activos / total)
        const returnRate = cards.length > 0 ? Math.round((activeClients.length / cards.length) * 100) : 0;

        // Actualizar UI (con verificación null)
        const kpiNewClients = document.getElementById('kpi-new-clients');
        const kpiActiveClients = document.getElementById('kpi-active-clients');
        const kpiInactiveClients = document.getElementById('kpi-inactive-clients');
        const kpiAvgLastVisit = document.getElementById('kpi-avg-last-visit');
        const kpiCyclesCompleted = document.getElementById('kpi-cycles-completed');
        const kpiReturnRate = document.getElementById('kpi-return-rate');

        if (kpiNewClients) kpiNewClients.textContent = newClients.length;
        if (kpiActiveClients) kpiActiveClients.textContent = `${activeClients.length} (${returnRate}%)`;
        if (kpiInactiveClients) kpiInactiveClients.textContent = inactiveClients;
        if (kpiAvgLastVisit) kpiAvgLastVisit.textContent = `${avgLastVisit} días`;
        if (kpiCyclesCompleted) kpiCyclesCompleted.textContent = cyclesCompleted;
        if (kpiReturnRate) kpiReturnRate.textContent = `${returnRate}%`;

        // 7. Renderizar gráficas de distribución
        renderDayDistribution(cards);
        renderHourDistribution(cards);

        console.log('📊 KPIs avanzados cargados');
      } catch (error) {
        console.error('Error cargando KPIs avanzados:', error);
        // Valores por defecto en caso de error (con verificación null)
        const els = ['kpi-new-clients', 'kpi-active-clients', 'kpi-inactive-clients',
          'kpi-avg-last-visit', 'kpi-cycles-completed', 'kpi-return-rate'];
        els.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.textContent = '—';
        });
      }
    }

    function renderDayDistribution(cards) {
      const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
      const dayCounts = [0, 0, 0, 0, 0, 0, 0];

      cards.forEach(c => {
        const lastVisit = c.lastVisit || c.last_visit || c.updatedAt || c.updated_at;
        if (lastVisit) {
          const day = new Date(lastVisit).getDay();
          dayCounts[day]++;
        }
      });

      const ctx = document.getElementById('day-distribution-chart');
      if (dayChart) dayChart.destroy();

      dayChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dayNames,
          datasets: [{
            label: 'Visitas',
            data: dayCounts,
            backgroundColor: 'rgba(140, 150, 104, 0.6)',
            borderColor: 'rgb(140, 150, 104)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#e5e7eb', font: { size: 11 } },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            },
            x: {
              ticks: { color: '#e5e7eb', font: { size: 11 } },
              grid: { display: false }
            }
          }
        }
      });
    }

    function renderHourDistribution(cards) {
      const hourCounts = new Array(24).fill(0);

      cards.forEach(c => {
        const lastVisit = c.lastVisit || c.last_visit || c.updatedAt || c.updated_at;
        if (lastVisit) {
          const hour = new Date(lastVisit).getHours();
          hourCounts[hour]++;
        }
      });

      const ctx = document.getElementById('hour-distribution-chart');
      if (hourChart) hourChart.destroy();

      hourChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
          datasets: [{
            label: 'Visitas',
            data: hourCounts,
            borderColor: 'rgb(140, 150, 104)',
            backgroundColor: 'rgba(140, 150, 104, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#e5e7eb', font: { size: 11 } },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            },
            x: {
              ticks: { color: '#e5e7eb', font: { size: 10 }, maxRotation: 0 },
              grid: { display: false }
            }
          }
        }
      });
    }

    function loadSampleData(range) {
      // Datos de ejemplo para cuando la API falle
      let labels, dataStamps, kpiStamps, kpiRedeems;

      if (range === 'day') {
        labels = ['10:00', '12:00', '14:00', '16:00', '18:00', '20:00'];
        dataStamps = [2, 5, 1, 8, 4, 6];
        kpiStamps = 26;
        kpiRedeems = 3;
      } else if (range === 'week') {
        labels = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
        dataStamps = [12, 19, 3, 5, 22, 30, 15];
        kpiStamps = 106;
        kpiRedeems = 8;
      } else { // month
        labels = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];
        dataStamps = [80, 120, 95, 110];
        kpiStamps = 405;
        kpiRedeems = 25;
      }

      // Actualizar UI con datos de ejemplo (con verificación null)
      const kpiTotal = document.getElementById('kpi-total');
      const kpiFull = document.getElementById('kpi-full');
      const kpiStampsEl = document.getElementById('kpi-stamps');
      const kpiRedeemsEl = document.getElementById('kpi-redeems');
      const kpiAvg = document.getElementById('kpi-avg');
      const kpiRate = document.getElementById('kpi-rate');

      if (kpiTotal) kpiTotal.textContent = "142";
      if (kpiFull) kpiFull.textContent = "18";
      if (kpiStampsEl) kpiStampsEl.textContent = kpiStamps;
      if (kpiRedeemsEl) kpiRedeemsEl.textContent = kpiRedeems;
      if (kpiAvg) kpiAvg.textContent = "5.2";
      if (kpiRate) kpiRate.textContent = "13%";

      // Actualizar gráfica
      renderChart(labels, dataStamps);

      // Simular Top Clientes
      renderSampleTopClients();

      // Guardar datos para reporte
      globalStatsData = {
        total: 142,
        full: 18,
        stampsPeriod: kpiStamps,
        redeemsPeriod: kpiRedeems,
        avg: "5.2",
        rate: "13",
        range: range
      };
    }

    function renderChart(labels, data) {
      const canvas = document.getElementById('activity-chart');
      if (!canvas) return;

      // Destruir TODOS los charts previos
      if (activityChart) {
        activityChart.destroy();
        activityChart = null;
      }
      if (window.myActivityChart) {
        window.myActivityChart.destroy();
        window.myActivityChart = null;
      }
      const existingChart = Chart.getChart(canvas);
      if (existingChart) {
        existingChart.destroy();
      }

      activityChart = new Chart(canvas, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Sellos',
            data: data,
            borderColor: '#8c9668',
            backgroundColor: 'rgba(140, 150, 104, 0.15)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: '#8c9668',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 10,
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#8c9668',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#e5e7eb',
                font: { size: 11 }
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#e5e7eb',
                font: { size: 11 }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    function renderSampleTopClients() {
      const clients = [
        { name: 'Ana López', stamps: 7, max: 8 },
        { name: 'Carlos Ruiz', stamps: 8, max: 8 },
        { name: 'Sofía Mendoza', stamps: 4, max: 8 },
        { name: 'Roberto García', stamps: 6, max: 8 },
        { name: 'Laura Torres', stamps: 8, max: 8 }
      ];

      const tbody = document.getElementById('top-clients');
      if (!tbody) return; // Verificación null

      tbody.innerHTML = clients.map(c => `
        <tr>
          <td>${c.name}</td>
          <td>${c.stamps}/${c.max}</td>
          <td>
            ${c.stamps >= c.max
          ? '<span class="tag">🎁 Completa</span>'
          : `<span class="muted">${c.max - c.stamps} más</span>`
        }
          </td>
        </tr>
      `).join('');

      // Guardar para el reporte
      globalStatsData.clients = clients;
    }

    async function loadTopClients() {
      try {
        const response = await fetch('/api/admin/top-clients', {
          credentials: 'include'
        });
        const data = await response.json();

        const tbody = document.getElementById('top-clients');
        if (!tbody) return; // Verificación null

        if (!data.clients || data.clients.length === 0) {
          tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:12px;" class="muted">No hay datos</td></tr>`;
          return;
        }

        tbody.innerHTML = data.clients.slice(0, 5).map(c => `
          <tr>
            <td>${c.name || 'Sin nombre'}</td>
            <td>${c.stamps}/${c.max}</td>
            <td>
              ${c.stamps >= c.max
            ? '<span class="tag">🎁 Completa</span>'
            : `<span class="muted">${c.max - c.stamps} más</span>`
          }
            </td>
          </tr>
        `).join('');

        // Guardar para el reporte
        globalStatsData.clients = data.clients.slice(0, 5);
      } catch (error) {
        console.error('Error cargando top clients:', error);
        renderSampleTopClients();
      }
    }

    async function loadActivityChart(range = 'week') {
      try {
        const response = await fetch(`/api/admin/activity-${range}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('API no disponible');
        }

        const data = await response.json();
        const canvas = document.getElementById('activity-chart');
        if (!canvas) return;

        // Destruir TODOS los charts previos que usen este canvas
        if (activityChart) {
          activityChart.destroy();
          activityChart = null;
        }
        if (window.myActivityChart) {
          window.myActivityChart.destroy();
          window.myActivityChart = null;
        }
        const existingChart = Chart.getChart(canvas);
        if (existingChart) {
          existingChart.destroy();
        }

        activityChart = new Chart(canvas, {
          type: 'line',
          data: {
            labels: data.labels || ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
            datasets: [{
              label: 'Sellos',
              data: data.stamps || [0, 0, 0, 0, 0, 0, 0],
              borderColor: '#8c9668',
              backgroundColor: 'rgba(140, 150, 104, 0.15)',
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#8c9668',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 10,
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: '#8c9668',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: '#e5e7eb',
                  font: { size: 11 }
                },
                grid: {
                  color: 'rgba(255, 255, 255, 0.1)'
                }
              },
              x: {
                ticks: {
                  color: '#e5e7eb',
                  font: { size: 11 }
                },
                grid: {
                  display: false
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error cargando gráfica:', error);
        // Si falla, no hacemos nada ya que loadSampleData ya renderizó una gráfica
      }
    }

    /* ===== WALLET STATS MEJORADO ===== */
    async function loadWalletStats() {
      try {
        // Primero intentar con el nuevo endpoint de device-stats
        try {
          const deviceStatsResponse = await fetch('/api/admin/device-stats', {
            credentials: 'include'
          });

          if (deviceStatsResponse.ok) {
            const deviceStats = await deviceStatsResponse.json();

            // Mostrar en UI (con verificación null)
            const kpiGoogle = document.getElementById('kpi-google');
            const kpiApple = document.getElementById('kpi-apple');
            const kpiDevices = document.getElementById('kpi-devices');

            if (kpiGoogle) kpiGoogle.textContent = deviceStats.googleWallet || 0;
            if (kpiApple) kpiApple.textContent = deviceStats.appleWallet || 0;
            if (kpiDevices) kpiDevices.textContent = deviceStats.totalDevices || 0;

            // ⭐ Guardar en globalStatsData para CSV
            globalStatsData.walletStats = {
              google: deviceStats.googleWallet || 0,
              apple: deviceStats.appleWallet || 0,
              total: deviceStats.totalDevices || 0
            };

            console.log('📱 Wallet stats cargadas exitosamente');
            return;
          }
        } catch (e) {
          console.log('Nuevo endpoint device-stats no disponible, usando endpoint legacy');
        }

        // Fallback al endpoint legacy
        const response = await fetch('/api/admin/wallet-stats', {
          credentials: 'include'
        });
        const data = await response.json();

        const kpiGoogle = document.getElementById('kpi-google');
        const kpiApple = document.getElementById('kpi-apple');
        const kpiDevices = document.getElementById('kpi-devices');

        if (kpiGoogle) kpiGoogle.textContent = data.googleWallets || 0;
        if (kpiApple) kpiApple.textContent = data.appleWallets || 0;
        if (kpiDevices) kpiDevices.textContent = data.appleDevices || 0;
      } catch (error) {
        console.error('Error cargando wallet stats:', error);
        const kpiGoogle = document.getElementById('kpi-google');
        const kpiApple = document.getElementById('kpi-apple');
        const kpiDevices = document.getElementById('kpi-devices');

        if (kpiGoogle) kpiGoogle.textContent = '—';
        if (kpiApple) kpiApple.textContent = '—';
        if (kpiDevices) kpiDevices.textContent = '—';
      }
    }

    // Botón para actualizar estadísticas de wallets (comentado - elemento no existe)
    // document.getElementById('btn-refresh-wallet-stats')?.addEventListener('click', loadWalletStats);

    /* ===== CARDS (Firestore + menú de acciones) ===== */
    let currentPage = 1;
    let cardsCache = {};
    let currentCardId = null;

    // Helper para formatear cumpleaños
    function formatBirthday(birthdate) {
      if (!birthdate) return '';
      const [y, m, d] = birthdate.split('-').map(Number);
      const months = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
      return `${d} ${months[m - 1]}`;
    }

    async function loadCards(page = 1) {
      try {
        const searchQuery = document.getElementById('search-cards').value;
        const sortValue = document.getElementById('sort-cards').value;
        const [sortField, sortOrder] = sortValue.split(':');

        const url = `/api/admin/cards-firebase?page=${page}&q=${encodeURIComponent(searchQuery)}&sort=${sortField}&order=${sortOrder}`;

        const response = await fetch(url, {
          credentials: 'include'
        });

        if (!response.ok) throw new Error('Error ' + response.status);

        const data = await response.json();
        const tbody = document.getElementById('cards-tbody');

        if (!data.items || data.items.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:12px;" class="muted">No hay tarjetas</td></tr>`;
          return;
        }

        cardsCache = {};
        data.items.forEach(c => { cardsCache[c.id] = c; });

        // Check birthdays
        checkBirthdays(data.items);

        tbody.innerHTML = data.items.map(card => {
          // Formatear última visita
          let lastVisitStr = '—';
          const lastVisitField = card.lastVisit || card.last_visit || card.updatedAt || card.updated_at;

          if (lastVisitField) {
            const lastDate = new Date(lastVisitField);
            const now = new Date();
            const diffDays = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) lastVisitStr = 'Hoy';
            else if (diffDays === 1) lastVisitStr = 'Ayer';
            else if (diffDays < 7) lastVisitStr = `Hace ${diffDays} días`;
            else lastVisitStr = lastDate.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
          }

          return `
          <tr data-card-id="${card.id}" class="card-row" style="cursor:pointer;">
            <td>
              <div style="font-weight:500;">${card.name || '—'}</div>
              ${card.birthdate ? `<div class="muted" style="font-size:11px;">🎂 ${formatBirthday(card.birthdate)}</div>` : ''}
            </td>
            <td style="font-size:13px;">${card.phone || '—'}</td>
            <td style="font-size:12px;">${lastVisitStr}</td>
            <td>
              <div style="display:flex;align-items:center;gap:6px;">
                <div style="background:rgba(255,255,255,0.1);border-radius:4px;height:6px;width:60px;overflow:hidden;">
                  <div style="background:linear-gradient(90deg,#FFD166,#8c9668);height:100%;width:${(card.stamps / card.max) * 100}%;"></div>
                </div>
                <span style="font-size:12px;font-weight:500;">${card.stamps}/${card.max}</span>
              </div>
            </td>
            <td>
              <div style="display:flex;gap:6px;">
                <button class="btn small" data-action="stamp" style="background:#FFD166;color:#000;font-weight:600;padding:4px 10px;"><i class="fas fa-star"></i>+1</button>
                <button class="btn small ghost" data-action="view" style="padding:4px 10px;">Ver</button>
              </div>
            </td>
          </tr>
        `}).join('');

        document.getElementById('page-info').textContent =
          `Página ${data.page} de ${data.totalPages} (${data.total} total)`;
        document.getElementById('btn-prev-page').disabled = data.page === 1;
        document.getElementById('btn-next-page').disabled = data.page === data.totalPages;
        currentPage = data.page;
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('cards-tbody').innerHTML =
          `<tr><td colspan="8" style="text-align:center;padding:12px;color:#fecaca;">Error: ${error.message}</td></tr>`;
      }
    }

    // Event listener for sorting
    document.getElementById('sort-cards').addEventListener('change', () => loadCards(1));

    document.getElementById('btn-prev-page').addEventListener('click', () => {
      if (currentPage > 1) loadCards(currentPage - 1);
    });

    document.getElementById('btn-next-page').addEventListener('click', () => {
      loadCards(currentPage + 1);
    });

    // ===== BÚSQUEDA INSTANTÁNEA CON DEBOUNCE =====
    let searchTimeout;
    const searchInput = document.getElementById('search-cards');
    const searchBtn = document.getElementById('btn-search-cards');

    // Instant search con debounce de 300ms
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        console.log('🔍 Búsqueda instantánea:', e.target.value);
        loadCards(1);
      }, 300);
    });

    // Mantener funcionalidad del botón de búsqueda
    searchBtn.addEventListener('click', () => loadCards(1));

    // Enter key también busca
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        clearTimeout(searchTimeout); // Cancelar debounce
        loadCards(1);
      }
    });
    document.getElementById('btn-reload-cards').addEventListener('click', () => loadCards(currentPage));

    document.getElementById('cards-tbody').addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;

      const tr = btn.closest('tr[data-card-id]');
      if (!tr) return;

      const cardId = tr.dataset.cardId;
      const card = cardsCache[cardId] || { id: cardId };
      const action = btn.dataset.action;

      switch (action) {
        case 'view':
          openCardModal(card);
          break;
        case 'copy':
          await copyCardId(cardId);
          break;
        case 'open':
          openClientPage(cardId);
          break;
        case 'stamp':
          await stampCard(cardId);
          break;
        case 'redeem':
          await redeemCard(cardId);
          break;
        case 'delete':
          await deleteCard(cardId);
          break;
      }
    });

    // Event listener for clicking on card rows (not on buttons)
    document.getElementById('cards-tbody').addEventListener('click', (e) => {
      // Si se hizo clic en un botón, ignorar
      if (e.target.closest('button')) return;

      // Buscar el tr más cercano
      const tr = e.target.closest('tr.card-row');
      if (!tr) return;

      const cardId = tr.dataset.cardId;
      const card = cardsCache[cardId];
      if (card) {
        openCardModal(card);
      }
    });

    /* ===== ESCÁNER QR (html5-qrcode) ===== */
    const scanDialog = $("#scanDialog");
    const scanStatus = $("#scan-status");
    let html5QrCode = null;

    $("#btn-scan-card").addEventListener("click", async () => {
      scanDialog.showModal();
      await startScan();
    });

    $("#scan-close").addEventListener("click", () => {
      stopScan();
      scanDialog.close();
    });

    async function startScan() {
      try {
        scanStatus.textContent = "Iniciando cámara...";

        // Crear instancia de html5-qrcode
        html5QrCode = new Html5Qrcode("qr-reader");

        // Iniciar escaneo
        await html5QrCode.start(
          { facingMode: "environment" }, // Cámara trasera
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          async (decodedText, decodedResult) => {
            // ✅ QR detectado exitosamente
            console.log("QR detectado:", decodedText);
            scanStatus.textContent = "✅ QR detectado";

            // Detener escáner
            await stopScan();

            // Procesar el QR
            await handleScan(decodedText);

            // Cerrar diálogo
            scanDialog.close();
          },
          (errorMessage) => {
            // Ignorar errores de no detectar QR (son normales)
          }
        );

        scanStatus.textContent = "📷 Apunta al QR de la tarjeta...";

      } catch (err) {
        console.error("Error iniciando cámara:", err);
        scanStatus.textContent = "❌ No se pudo acceder a la cámara";

        // Si falla, pedir permisos explícitamente
        if (err.name === 'NotAllowedError') {
          scanStatus.textContent = "⚠️ Por favor permite el acceso a la cámara";
        }
      }
    }

    async function stopScan() {
      if (html5QrCode && html5QrCode.isScanning) {
        try {
          await html5QrCode.stop();
          console.log("Escáner detenido");
        } catch (err) {
          console.error("Error deteniendo escáner:", err);
        }
      }
      html5QrCode = null;
    }

    function extractCardId(text) {
      try {
        const u = new URL(text);
        let c = u.searchParams.get("cardId");
        if (c) return c;
        c = u.searchParams.get("card");
        if (c) return c;
      } catch { }
      if (/^card_\d+/.test(text)) return text;
      return null;
    }

    async function handleScan(raw) {
      const cid = extractCardId(raw);
      if (!cid) {
        scanStatus.textContent = "QR inválido.";
        return;
      }

      stopScan();
      scanDialog.close();

      let card = cardsCache[cid];

      if (!card) {
        try {
          const r = await fetch('/api/card/' + encodeURIComponent(cid), {
            credentials: 'include'
          });
          if (r.ok) {
            card = await r.json();
          }
        } catch (e) {
          console.error('Error buscando tarjeta por ID', e);
        }
      }

      if (!card) {
        alert('Tarjeta no encontrada');
        return;
      }

      openCardModal(card);
    }

    /* ===== PUSH NOTIFICATIONS - CORREGIDO ===== */
    const typeEmojis = {
      'promo': '🎁 Promoción',
      'reminder': '⏰ Recordatorio',
      'update': 'ℹ️ Actualización',
      'alert': '⚠️ Alerta'
    };

    document.getElementById('push-title').addEventListener('input', function () {
      document.getElementById('preview-title').textContent = this.value || '¡Nueva promoción!';
    });

    document.getElementById('push-message').addEventListener('input', function () {
      document.getElementById('preview-message').textContent = this.value || 'Tu mensaje aparecerá aquí...';
    });

    document.getElementById('push-type').addEventListener('change', function () {
      document.getElementById('preview-type').textContent = typeEmojis[this.value];
    });

    document.getElementById('push-notification-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const title = document.getElementById('push-title').value;
      const message = document.getElementById('push-message').value;
      const type = document.getElementById('push-type').value;

      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Enviando...';
      submitBtn.disabled = true;

      try {
        const response = await fetch('/api/admin/push-notification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            title,
            message,
            type,
            // ✅ CORREGIDO: Especificar que es alerta visible
            alertType: 'visible',
            badge: 1,
            sound: 'default'
          })
        });

        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        document.getElementById('push-count').textContent = data.passCount;
        document.getElementById('push-success').classList.remove('hidden');
        document.getElementById('push-error').classList.add('hidden');

        this.reset();
        document.getElementById('preview-title').textContent = '¡Nueva promoción!';
        document.getElementById('preview-message').textContent = 'Tu mensaje aparecerá aquí...';

        loadNotificationsHistory();

        setTimeout(() => {
          document.getElementById('push-success').classList.add('hidden');
        }, 5000);

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('push-error').classList.remove('hidden');
        document.getElementById('push-success').classList.add('hidden');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    document.getElementById('test-push').addEventListener('click', async function () {
      const title = document.getElementById('push-title').value;
      const message = document.getElementById('push-message').value;

      if (!title || !message) {
        alert('Completa título y mensaje primero');
        return;
      }

      const originalText = this.textContent;
      this.textContent = 'Enviando...';
      this.disabled = true;

      try {
        const response = await fetch('/api/admin/push-test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            title,
            message,
            type: document.getElementById('push-type').value,
            // ✅ CORREGIDO: Especificar que es alerta visible
            alertType: 'visible'
          })
        });

        const data = await response.json();

        if (data.success) {
          alert(`✅ Prueba enviada a: ${data.cardId}`);
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        alert('❌ Error: ' + error.message);
      } finally {
        this.textContent = originalText;
        this.disabled = false;
      }
    });

    async function loadNotificationsHistory() {
      try {
        const response = await fetch('/api/admin/notifications', {
          credentials: 'include'
        });

        if (!response.ok) throw new Error('Error cargando historial');

        const data = await response.json();
        const tbody = document.getElementById('notifications-history');

        if (!data.notifications || data.notifications.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:12px;" class="muted">No hay notificaciones</td></tr>`;
          return;
        }

        tbody.innerHTML = data.notifications.map(n => {
          const date = new Date(n.createdAt);
          const dateStr = date.toLocaleDateString('es-ES', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
          }) + ', ' + date.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
          });

          return `
            <tr>
              <td>${dateStr}</td>
              <td>${n.title}</td>
              <td>${typeEmojis[n.type] || n.type}</td>
              <td>${n.googleSent}/${n.cardsSent}</td>
              <td>${n.errors > 0 ? `<span style="color:#fecaca">${n.errors}</span>` : '0'}</td>
            </tr>
          `;
        }).join('');

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('notifications-history').innerHTML =
          `<tr><td colspan="5" style="text-align:center;padding:12px;color:#fecaca;">Error cargando historial</td></tr>`;
      }
    }

    document.getElementById('refresh-history').addEventListener('click', loadNotificationsHistory);

    // Borrar historial de notificaciones
    document.getElementById('clear-notif-history').addEventListener('click', async () => {
      if (!confirm('¿Estás seguro de borrar todo el historial de notificaciones enviadas?')) return;

      try {
        const response = await fetch('/api/admin/notifications/clear', {
          method: 'DELETE',
          credentials: 'include'
        });

        if (response.ok) {
          alert('✓ Historial borrado correctamente');
          loadNotificationsHistory();
        } else {
          const data = await response.json();
          alert('Error: ' + (data.error || 'No se pudo borrar el historial'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error de red al borrar historial');
      }
    });

    // ===== Modal Tarjeta =====
    const modalBackdrop = document.getElementById('card-modal-backdrop');
    const modalCloseBtn = document.getElementById('cm-close');
    const modalQrCanvas = document.getElementById('card-qr');

    async function openCardModal(card) {
      currentCardId = card.id;

      // Datos básicos
      document.getElementById('cm-id').textContent = card.id;
      document.getElementById('cm-name').textContent = card.name || '—';
      document.getElementById('cm-phone-display').textContent = card.phone || '—';
      document.getElementById('cm-phone-input').value = card.phone || '';
      document.getElementById('cm-stamps').textContent = `${card.stamps} / ${card.max}`;

      // Resetear estado de edición de teléfono
      document.getElementById('cm-phone-display').classList.remove('hidden');
      document.getElementById('cm-phone-edit').classList.add('hidden');

      // Barra de progreso
      const progressPercent = Math.min((card.stamps / card.max) * 100, 100);
      document.getElementById('cm-progress-bar').style.width = `${progressPercent}%`;

      // Texto de estado
      const remaining = card.max - card.stamps;
      let statusText = '';
      if (card.stamps >= card.max) {
        statusText = '🎉 ¡Tarjeta completa! Lista para canjear';
      } else if (remaining === 1) {
        statusText = '⚡ ¡Solo falta 1 sello!';
      } else if (remaining <= 3) {
        statusText = `🔥 Faltan ${remaining} sellos`;
      } else {
        statusText = `Faltan ${remaining} sellos para completar`;
      }
      document.getElementById('cm-status-text').textContent = statusText;

      // Notas
      document.getElementById('cm-notes').value = card.notes || '';

      // Cargar información adicional del cliente
      loadClientInfo(card);

      // Cargar próxima cita
      loadNextAppointment(card.phone, card.name);

      // Mostrar modal
      modalBackdrop.classList.remove('hidden');

      // Resetear formulario de notificación
      document.getElementById('notify-form-container').classList.add('hidden');
      document.getElementById('notify-title').value = 'Recordatorio Venus';
      document.getElementById('notify-message').value = '';

      // Generar QR
      const url = `${window.location.origin}/?cardId=${encodeURIComponent(card.id)}`;
      if (typeof QRCode !== 'undefined' && modalQrCanvas) {
        try {
          const ctx = modalQrCanvas.getContext('2d');
          ctx.clearRect(0, 0, modalQrCanvas.width, modalQrCanvas.height);
          await QRCode.toCanvas(modalQrCanvas, url, {
            width: 150,
            height: 150,
            margin: 2,
            color: { dark: '#000000', light: '#ffffff' }
          });
        } catch (err) {
          console.error('Error generando QR:', err);
        }
      }
    }

    // Función auxiliar para cargar próxima cita
    async function loadNextAppointment(phone, name) {
      const nextApptSection = document.getElementById('cm-next-appt-section');

      try {
        const searchParam = phone || name;
        if (!searchParam) {
          nextApptSection.classList.add('hidden');
          return;
        }

        const res = await fetch(`/api/appointments/client?search=${encodeURIComponent(searchParam)}`);
        const json = await res.json();

        if (json.success && json.data) {
          // Buscar la próxima cita (status = scheduled y fecha futura)
          const now = new Date();
          const nextAppt = json.data.find(a =>
            a.status === 'scheduled' && new Date(a.startDateTime) > now
          );

          if (nextAppt) {
            const date = new Date(nextAppt.startDateTime);
            const dateStr = date.toLocaleDateString('es-MX', {
              day: 'numeric',
              month: 'short'
            });
            const timeStr = date.toLocaleTimeString('es-MX', {
              hour: '2-digit',
              minute: '2-digit'
            });

            document.getElementById('cm-next-appt-date').textContent = `${dateStr} ${timeStr}`;
            document.getElementById('cm-next-appt-service').textContent = nextAppt.serviceName;
            nextApptSection.classList.remove('hidden');
          } else {
            nextApptSection.classList.add('hidden');
          }
        } else {
          nextApptSection.classList.add('hidden');
        }
      } catch (error) {
        console.error('Error cargando próxima cita:', error);
        nextApptSection.classList.add('hidden');
      }
    }

    function closeCardModal() {
      modalBackdrop.classList.add('hidden');
      currentCardId = null;
    }

    modalCloseBtn.addEventListener('click', closeCardModal);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeCardModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modalBackdrop.classList.contains('hidden')) {
        closeCardModal();
      }
    });

    // ===== Edición de teléfono =====
    document.getElementById('cm-edit-phone-btn').addEventListener('click', () => {
      document.getElementById('cm-phone-display').classList.add('hidden');
      document.getElementById('cm-phone-edit').classList.remove('hidden');
      document.getElementById('cm-phone-edit').style.display = 'flex';
      document.getElementById('cm-phone-input').focus();
    });

    document.getElementById('cm-phone-cancel').addEventListener('click', () => {
      document.getElementById('cm-phone-display').classList.remove('hidden');
      document.getElementById('cm-phone-edit').classList.add('hidden');
    });

    document.getElementById('cm-phone-save').addEventListener('click', async () => {
      const newPhone = document.getElementById('cm-phone-input').value.replace(/\D/g, '');

      if (!newPhone || newPhone.length < 10) {
        alert('Por favor ingresa un número de teléfono válido (10 dígitos)');
        return;
      }

      try {
        const res = await fetch(`/api/cards/${currentCardId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: newPhone })
        });

        const json = await res.json();

        if (json.success || res.ok) {
          document.getElementById('cm-phone-display').textContent = newPhone;
          document.getElementById('cm-phone-display').classList.remove('hidden');
          document.getElementById('cm-phone-edit').classList.add('hidden');
          alert('✅ Teléfono actualizado');
          loadCards(); // Recargar lista de tarjetas
        } else {
          alert('❌ Error: ' + (json.error || 'No se pudo actualizar'));
        }
      } catch (error) {
        console.error('Error actualizando teléfono:', error);
        alert('❌ Error de conexión');
      }
    });

    // ===== Helpers acciones tarjeta - CORREGIDOS =====
    async function copyCardId(cardId) {
      try {
        await navigator.clipboard.writeText(cardId);
        alert('✅ ID copiado al portapapeles');
      } catch (e) {
        alert('No se pudo copiar el ID');
      }
    }

    function openClientPage(cardId) {
      const url = `${window.location.origin}/?cardId=${encodeURIComponent(cardId)}`;
      window.open(url, '_blank');
    }

    /* ===== PHASE 5: LOAD & SAVE CLIENT INFO ===== */
    async function loadClientInfo(card) {
      // Cargar campos editables
      document.getElementById('cm-notes').value = card.notes || '';

      // Resetear valores mientras carga
      document.getElementById('cm-visited-count').textContent = '...';
      document.getElementById('cm-cycles-completed').textContent = '...';
      document.getElementById('cm-last-visit').textContent = '...';

      try {
        // Cargar eventos de la tarjeta para calcular stats reales
        const eventsRes = await fetch(`/api/events/${card.id}`);
        const events = await eventsRes.json();

        if (Array.isArray(events)) {
          // Contar stamps (visitas)
          const stamps = events.filter(e => e.type === 'STAMP');
          const redeems = events.filter(e => e.type === 'REDEEM');

          document.getElementById('cm-visited-count').textContent = stamps.length;
          document.getElementById('cm-cycles-completed').textContent = redeems.length;

          // Última visita (usar campo directo de la tarjeta)
          const lastVisitField = card.lastVisit || card.last_visit;
          if (lastVisitField) {
            const lastVisitDate = new Date(lastVisitField);
            document.getElementById('cm-last-visit').textContent = lastVisitDate.toLocaleDateString('es-MX', {
              day: 'numeric', month: 'short', year: 'numeric'
            });
          } else if (stamps.length > 0) {
            // Fallback a eventos si no hay campo directo
            const lastStamp = stamps.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
            const lastVisitDate = new Date(lastStamp.createdAt);
            document.getElementById('cm-last-visit').textContent = lastVisitDate.toLocaleDateString('es-MX', {
              day: 'numeric', month: 'short', year: 'numeric'
            });
          } else {
            document.getElementById('cm-last-visit').textContent = '—';
          }
        }

        // Cargar próxima cita del cliente
        const phone = card.phone;
        if (phone) {
          const apptRes = await fetch(`/api/appointments/client?search=${encodeURIComponent(phone)}`);
          const apptData = await apptRes.json();

          if (apptData.success && apptData.data && apptData.data.length > 0) {
            // Buscar citas futuras (scheduled o confirmed)
            const now = new Date();
            const futureAppts = apptData.data
              .filter(a => (a.status === 'scheduled' || a.status === 'confirmed') && new Date(a.startDateTime) > now)
              .sort((a, b) => new Date(a.startDateTime) - new Date(b.startDateTime));

            // Ya se maneja en loadNextAppointment()
          }
        }

      } catch (error) {
        console.error('Error cargando info del cliente:', error);
        document.getElementById('cm-visited-count').textContent = '—';
        document.getElementById('cm-cycles-completed').textContent = '—';
        document.getElementById('cm-last-visit').textContent = '—';
      }
    }

    async function saveClientInfo() {
      if (!currentCardId) return;

      const notes = document.getElementById('cm-notes').value;

      try {
        const response = await fetch('/api/admin/update-client-info', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: currentCardId,
            notes
          })
        });

        const data = await response.json();

        if (response.ok) {
          alert('✅ Información guardada correctamente');
          // Actualizar cache
          if (cardsCache[currentCardId]) {
            cardsCache[currentCardId].notes = notes;
          }
        } else {
          alert(`❌ Error: ${data.error || 'No se pudo guardar'}`);
        }
      } catch (error) {
        console.error('Error guardando información:', error);
        alert('❌ Error al guardar información');
      }
    }

    // Event listener para botón guardar
    document.getElementById('cm-save-notes')?.addEventListener('click', saveClientInfo);

    /* ===== STAMP CARD - CORREGIDO PARA ACTUALIZAR GOOGLE WALLET ===== */
    async function stampCard(cardId) {
      if (!confirm('¿Agregar 1 sello a esta tarjeta?')) return;
      try {
        const r = await fetch('/api/admin/stamp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cardId })
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          throw new Error(data.error || 'No se pudo agregar sello');
        }

        // ✅ CORRECCIÓN CRÍTICA: Actualizar Google Wallet inmediatamente
        try {
          const card = cardsCache[cardId];
          if (card) {
            // Calcular nuevos stamps
            const newStamps = (card.stamps || 0) + 1;

            // Actualizar Google Wallet
            const { updateLoyaltyObject } = await import("./lib/google.js");
            await updateLoyaltyObject(cardId, card.name, newStamps, card.max);
            console.log(`[GOOGLE WALLET] ✅ Stamp actualizado para: ${cardId} (${newStamps}/${card.max})`);
          }
        } catch (googleError) {
          console.error(`[GOOGLE WALLET] ❌ Error actualizando stamp:`, googleError.message);
        }

        await loadCards(currentPage);
        if (currentCardId === cardId) {
          const updated = cardsCache[cardId];
          if (updated) openCardModal(updated);
        }
        alert('✅ Sello agregado y Google Wallet actualizado');
      } catch (e) {
        alert('❌ Error: ' + e.message);
      }
    }

    async function redeemCard(cardId) {
      if (!confirm('¿Canjear esta tarjeta? Se reiniciarán los sellos.')) return;
      try {
        const r = await fetch('/api/admin/redeem', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cardId })
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          throw new Error(data.error || 'No se pudo canjear');
        }

        // ✅ CORRECCIÓN: Actualizar Google Wallet después del canje
        try {
          const card = cardsCache[cardId];
          if (card) {
            const { updateLoyaltyObject } = await import("./lib/google.js");
            await updateLoyaltyObject(cardId, card.name, 0, card.max);
            console.log(`[GOOGLE WALLET] ✅ Canje realizado para: ${cardId} (0/${card.max})`);
          }
        } catch (googleError) {
          console.error(`[GOOGLE WALLET] ❌ Error actualizando canje:`, googleError.message);
        }

        await loadCards(currentPage);
        if (currentCardId === cardId) {
          const updated = cardsCache[cardId];
          if (updated) openCardModal(updated);
        }
        alert('✅ Canje realizado y Google Wallet actualizado');
      } catch (e) {
        alert('❌ Error: ' + e.message);
      }
    }

    async function deleteCard(cardId) {
      if (!confirm('⚠️ Esto eliminará la tarjeta de la base de datos, eventos y Firestore. ¿Continuar?')) return;
      try {
        const r = await fetch(`/api/admin/card/${encodeURIComponent(cardId)}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          throw new Error(data.error || 'No se pudo eliminar');
        }
        closeCardModal();
        await loadCards(currentPage);
        alert('✅ Tarjeta eliminada');
      } catch (e) {
        alert('❌ Error: ' + e.message);
      }
    }

    /* ===== REGISTRAR DISPOSITIVO GOOGLE (NUEVO) ===== */
    async function registerGoogleDevice(cardId) {
      try {
        let deviceId = localStorage.getItem('google_device_id');
        if (!deviceId) {
          deviceId = 'gdev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('google_device_id', deviceId);
        }

        const response = await fetch('/api/google/register-device', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            cardId: cardId,
            deviceId: deviceId
          })
        });

        const data = await response.json();

        if (data.success) {
          console.log('✅ Dispositivo Google registrado:', deviceId);
          return true;
        } else {
          console.error('❌ Error registrando dispositivo Google:', data.error);
          return false;
        }
      } catch (error) {
        console.error('❌ Error registrando dispositivo Google:', error);
        return false;
      }
    }

    // Toggle del formulario de notificación
    document.getElementById('cm-notify').addEventListener('click', () => {
      const form = document.getElementById('notify-form-container');
      form.classList.toggle('hidden');
      if (!form.classList.contains('hidden')) {
        document.getElementById('notify-message').focus();
      }
    });

    // Cancelar notificación
    document.getElementById('btn-cancel-notify').addEventListener('click', () => {
      document.getElementById('notify-form-container').classList.add('hidden');
    });

    // Enviar notificación individual
    document.getElementById('btn-send-notify').addEventListener('click', async function () {
      if (!currentCardId) return;

      const title = document.getElementById('notify-title').value;
      const message = document.getElementById('notify-message').value;

      if (!title || !message) {
        alert('Por favor completa el título y el mensaje');
        return;
      }

      const btn = this;
      const originalText = btn.textContent;
      btn.textContent = 'Enviando...';
      btn.disabled = true;

      try {
        const r = await fetch('/api/admin/push-one', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: currentCardId,
            title,
            message,
            type: 'personal',
            alertType: 'visible'
          })
        });
        const data = await r.json();

        if (!r.ok || !data.success) {
          throw new Error(data.error || 'No se pudo enviar la notificación');
        }

        alert('✅ Notificación enviada exitosamente');
        document.getElementById('notify-form-container').classList.add('hidden');
        document.getElementById('notify-message').value = ''; // Limpiar mensaje

      } catch (e) {
        alert('❌ Error: ' + e.message);
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    });

    // ✅ NUEVO: Botón para registrar dispositivo Google desde el modal
    document.getElementById('cm-register-google')?.addEventListener('click', async () => {
      if (currentCardId) {
        const success = await registerGoogleDevice(currentCardId);
        if (success) {
          alert('✅ Dispositivo Google registrado exitosamente');
        } else {
          alert('❌ Error registrando dispositivo Google');
        }
      }
    });

    // ✅ NUEVO: Botón para forzar actualización del pase
    document.getElementById('cm-force-update')?.addEventListener('click', async () => {
      if (!currentCardId) return;

      if (!confirm('¿Forzar actualización del pase en Apple/Google Wallet?')) return;

      try {
        const res = await fetch('/api/admin/force-update-pass', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cardId: currentCardId })
        });

        const data = await res.json();

        if (data.ok) {
          alert(`✅ Pase actualizado!\nSellos: ${data.stamps}\nCiclos: ${data.cycles}`);
        } else {
          alert('❌ Error: ' + (data.error || 'No se pudo actualizar'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('❌ Error de conexión');
      }
    });

    // Acciones desde el modal - con verificación de existencia
    const btnStamp = document.getElementById('cm-stamp');
    const btnRedeem = document.getElementById('cm-redeem');
    const btnCopy = document.getElementById('cm-copy');
    const btnOpenUrl = document.getElementById('cm-open-url');
    const btnDelete = document.getElementById('cm-delete');
    const btnWhatsApp = document.getElementById('cm-whatsapp');
    const btnSchedule = document.getElementById('cm-schedule');

    if (btnStamp) {
      btnStamp.addEventListener('click', async () => {
        if (currentCardId) await stampCard(currentCardId);
      });
    }

    if (btnRedeem) {
      btnRedeem.addEventListener('click', async () => {
        if (currentCardId) await redeemCard(currentCardId);
      });
    }

    if (btnCopy) {
      btnCopy.addEventListener('click', async () => {
        if (currentCardId) await copyCardId(currentCardId);
      });
    }

    if (btnOpenUrl) {
      btnOpenUrl.addEventListener('click', () => {
        if (currentCardId) openClientPage(currentCardId);
      });
    }

    if (btnDelete) {
      btnDelete.addEventListener('click', async () => {
        if (currentCardId) await deleteCard(currentCardId);
      });
    }

    // ===== Botón Agendar =====
    if (btnSchedule) {
      btnSchedule.addEventListener('click', () => {
        if (!currentCardId) return;

        const client = cardsCache[currentCardId];
        if (!client) return;

        // Primero cambiar a la pestaña de Agenda
        const agendaTab = document.querySelector('[data-tab="appointments"]');
        if (agendaTab) {
          agendaTab.click();
        }

        // Esperar un momento para que la pestaña se active
        setTimeout(() => {
          // Abrir el modal de nueva cita
          const newApptDialog = document.getElementById('newApptDialog');
          const clientSelectInput = document.getElementById('new-appt-client-select');
          const phoneInput = document.getElementById('new-appt-phone');
          const dateInput = document.getElementById('new-appt-date');

          if (newApptDialog && clientSelectInput && phoneInput) {
            // Cargar datos necesarios
            loadServices();
            loadClients();
            generateHourMinuteOptions();

            // Prellenar nombre y teléfono
            clientSelectInput.value = client.name || '';
            phoneInput.value = client.phone || '';

            // Prellenar fecha con hoy si está vacía
            if (dateInput && !dateInput.value) {
              const today = new Date();
              const year = today.getFullYear();
              const month = String(today.getMonth() + 1).padStart(2, '0');
              const day = String(today.getDate()).padStart(2, '0');
              dateInput.value = `${year}-${month}-${day}`;
            }

            // Deshabilitar campos de nombre y teléfono (están bloqueados)
            clientSelectInput.disabled = true;
            phoneInput.disabled = true;

            // Mostrar el modal
            newApptDialog.showModal();

            // Cerrar el modal del cliente
            closeCardModal();
          }
        }, 100);
      });
    }

    // ===== Botón WhatsApp =====
    if (btnWhatsApp) {
      btnWhatsApp.addEventListener('click', () => {
        if (!currentCardId) return;

        const phone = cardsCache[currentCardId]?.phone;
        const name = cardsCache[currentCardId]?.name || 'Cliente';

        if (!phone) {
          alert('⚠️ Este cliente no tiene teléfono registrado');
          return;
        }

        // Limpiar el número (remover espacios, guiones, etc.)
        const cleanPhone = phone.replace(/\D/g, '');

        // Mensaje predeterminado
        const message = encodeURIComponent(`Hola ${name}, te contacto de Venus Cosmetología`);

        // Abrir WhatsApp
        window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
      });
    }

    /* ===== DEBUGGING AVANZADO (NUEVO) ===== */

    // Test Apple Push
    document.getElementById('btn-test-apple-push')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta para prueba:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = '🧪 Enviando prueba Apple Push...';

      try {
        const response = await fetch('/api/debug/test-apple-push', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: cardId,
            title: "🔥 PRUEBA APPLE PUSH",
            message: "Si ves esto, las notificaciones Apple funcionan correctamente!"
          })
        });

        const data = await response.json();
        output.innerHTML = `✅ Resultado Apple Push:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `❌ Error Apple Push:<br>${error.message}`;
      }
    });

    // Test Google Push
    document.getElementById('btn-test-google-push')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta para prueba:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = '🧪 Enviando prueba Google Push...';

      try {
        const response = await fetch('/api/debug/test-google-push', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: cardId,
            title: "🔥 PRUEBA GOOGLE PUSH",
            message: "Esto debe aparecer en Google Wallet"
          })
        });

        const data = await response.json();
        output.innerHTML = `✅ Resultado Google Push:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `❌ Error Google Push:<br>${error.message}`;
      }
    });

    // Reparar Google Wallet
    document.getElementById('btn-fix-google-wallet')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta a reparar:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = '🔧 Reparando objeto Google Wallet...';

      try {
        const response = await fetch(`/api/debug/fix-google-wallet/${cardId}`, {
          method: 'POST',
          credentials: 'include'
        });

        const data = await response.json();
        output.innerHTML = `✅ Google Wallet reparado:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `❌ Error reparando Google Wallet:<br>${error.message}`;
      }
    });

    /* ===== BIRTHDAY LOGIC (Cards Tab) ===== */
    function checkBirthdays(cards) {
      const today = new Date();
      const currentMonth = today.getMonth(); // 0-11
      const currentDay = today.getDate();

      const upcomingBirthdays = cards.filter(card => {
        if (!card.birthdate) return false;
        // Parse YYYY-MM-DD manually to avoid timezone issues
        const [y, m, d] = card.birthdate.split('-').map(Number);
        const bMonth = m - 1; // 0-11
        const bDay = d;

        // Check if birthday is in the next 7 days
        if (bMonth === currentMonth) {
          return bDay >= currentDay && bDay <= currentDay + 7;
        }
        // Handle month wrapping
        const nextMonthDate = new Date(today);
        nextMonthDate.setDate(today.getDate() + 7);
        if (nextMonthDate.getMonth() !== currentMonth && bMonth === nextMonthDate.getMonth()) {
          return bDay <= nextMonthDate.getDate();
        }
        return false;
      });

      const section = document.getElementById('birthday-section');
      const list = document.getElementById('birthday-list');
      const actions = document.getElementById('birthday-actions');

      if (upcomingBirthdays.length === 0) {
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');
      list.innerHTML = upcomingBirthdays.map(c => {
        const [y, m, d] = c.birthdate.split('-').map(Number);

        // Calculate days until (handling year wrap if needed, though simpler here)
        const now = new Date(); now.setHours(0, 0, 0, 0);
        const nextBday = new Date(today.getFullYear(), m - 1, d);
        if (nextBday < now) nextBday.setFullYear(now.getFullYear() + 1);

        const diffTime = nextBday - now;
        const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        let actionBtn = '';
        if (daysUntil <= 2 && daysUntil >= 0) {
          actionBtn = `<button onclick="sendBirthdayPush('${c.id}', '${c.name}')" class="btn small primary" style="font-size:10px; padding: 2px 6px;"><i class="fas fa-gift" style="width:12px;height:12px;"></i> Felicitar</button>`;
        }

        const monthNames = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];

        return `
          <div style="background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 16px;">🎉</span>
            <div>
              <div style="font-weight: 600; font-size: 13px;">${c.name || 'Cliente'}</div>
              <div class="muted" style="font-size: 11px;">${d} de ${monthNames[m - 1]}</div>
            </div>
            ${actionBtn}
          </div>
        `;
      }).join('');

      actions.innerHTML = `<span class="tag" style="background:#ffd166; color:#000;">${upcomingBirthdays.length} pendientes</span>`;
    }

    /* ===== BIRTHDAY LOGIC (Overview Tab) ===== */
    function checkOverviewBirthdays(cards) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Calculate 30 days ago and 30 days ahead
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);

      const thirtyDaysAhead = new Date(today);
      thirtyDaysAhead.setDate(today.getDate() + 30);

      // Filter birthdays
      const allBirthdays = cards.filter(card => {
        if (!card.birthdate) return false;
        const [y, m, d] = card.birthdate.split('-').map(Number);
        const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

        // Include birthdays from 30 days ago to 30 days ahead
        return birthdayThisYear >= thirtyDaysAgo && birthdayThisYear <= thirtyDaysAhead;
      });

      const section = document.getElementById('overview-birthday-section');
      const upcomingContainer = document.getElementById('upcoming-birthdays-container');
      const pastContainer = document.getElementById('past-birthdays-container');
      const upcomingList = document.getElementById('upcoming-birthday-list');
      const pastList = document.getElementById('past-birthday-list');

      if (allBirthdays.length === 0) {
        section.classList.add('hidden');
        return;
      }

      // Separate into past and upcoming
      const pastBirthdays = [];
      const upcomingBirthdays = [];

      allBirthdays.forEach(card => {
        const [y, m, d] = card.birthdate.split('-').map(Number);
        const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

        if (birthdayThisYear < today) {
          pastBirthdays.push(card);
        } else {
          upcomingBirthdays.push(card);
        }
      });

      section.classList.remove('hidden');

      const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

      // Render upcoming birthdays (sorted by date, closest first)
      if (upcomingBirthdays.length > 0) {
        upcomingContainer.classList.remove('hidden');
        upcomingBirthdays.sort((a, b) => {
          const [ya, ma, da] = a.birthdate.split('-').map(Number);
          const [yb, mb, db] = b.birthdate.split('-').map(Number);
          const dateA = new Date(today.getFullYear(), ma - 1, da);
          const dateB = new Date(today.getFullYear(), mb - 1, db);
          return dateA - dateB; // Soonest first
        });

        upcomingList.innerHTML = upcomingBirthdays.map(c => {
          const [y, m, d] = c.birthdate.split('-').map(Number);
          const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

          const diffTime = birthdayThisYear - today;
          const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          let actionBtn = '';
          let daysLabel = '';

          if (daysUntil === 0) {
            daysLabel = '<span style="color: #ffd166; font-weight: 600;"><i class="fas fa-party-horn"></i> Hoy</span>';
            actionBtn = `<button onclick="sendBirthdayPush('${c.id}', '${c.name}')" class="btn small primary" style="font-size:10px; padding: 2px 6px;"><i class="fas fa-gift" style="width:12px;height:12px;"></i> Felicitar</button>`;
          } else {
            daysLabel = `<span style="color: #a7f3d0;">en ${daysUntil} día${daysUntil > 1 ? 's' : ''}</span>`;
          }

          return `
            <div style="background: rgba(167, 243, 208, 0.1); border: 1px solid rgba(167, 243, 208, 0.2); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 16px;">🎈</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 13px;">${c.name || 'Cliente'}</div>
                <div class="muted" style="font-size: 11px;">${d} de ${monthNames[m - 1].toLowerCase()} • ${daysLabel}</div>
              </div>
              ${actionBtn}
            </div>
          `;
        }).join('');
      } else {
        upcomingContainer.classList.add('hidden');
      }

      // Render past birthdays (sorted by date, most recent first)
      if (pastBirthdays.length > 0) {
        pastContainer.classList.remove('hidden');
        pastBirthdays.sort((a, b) => {
          const [ya, ma, da] = a.birthdate.split('-').map(Number);
          const [yb, mb, db] = b.birthdate.split('-').map(Number);
          const dateA = new Date(today.getFullYear(), ma - 1, da);
          const dateB = new Date(today.getFullYear(), mb - 1, db);
          return dateB - dateA; // Most recent first
        });

        pastList.innerHTML = pastBirthdays.map(c => {
          const [y, m, d] = c.birthdate.split('-').map(Number);
          const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

          const diffTime = today - birthdayThisYear;
          const daysAgo = Math.floor(diffTime / (1000 * 60 * 60 * 24));

          const daysLabel = `<span style="color: #cbd5e1;">hace ${daysAgo} día${daysAgo > 1 ? 's' : ''}</span>`;

          return `
            <div style="background: rgba(203, 213, 225, 0.1); border: 1px solid rgba(203, 213, 225, 0.2); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 16px;">🎂</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 13px;">${c.name || 'Cliente'}</div>
                <div class="muted" style="font-size: 11px;">${d} de ${monthNames[m - 1].toLowerCase()} • ${daysLabel}</div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        pastContainer.classList.add('hidden');
      }
    }

    window.sendBirthdayPush = async function (cardId, name) {
      if (!confirm(`¿Enviar felicitación de cumpleaños a ${name}?`)) return;

      try {
        const r = await fetch('/api/admin/push-one', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: cardId,
            title: "🎂 ¡Feliz Cumpleaños!",
            message: `¡Hola ${name}! En Venus queremos celebrarte. Ven por un regalo especial en tu próxima visita. 🎉`,
            type: 'promo',
            alertType: 'visible'
          })
        });
        const data = await r.json();
        if (!r.ok || !data.success) {
          throw new Error(data.error || 'No se pudo enviar');
        }
        alert('✅ Felicitación enviada exitosamente');
      } catch (e) {
        alert('❌ Error: ' + e.message);
      }
    };

    // Ver dispositivos
    document.getElementById('btn-check-devices')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta para ver dispositivos:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = '📱 Cargando información de dispositivos...';

      try {
        // Dispositivos Apple
        const appleResponse = await fetch(`/api/debug/apple-devices?cardId=${cardId}`, {
          credentials: 'include'
        });
        const appleData = await appleResponse.json();

        // Dispositivos Google
        const googleResponse = await fetch(`/api/debug/google-devices/${cardId}`, {
          credentials: 'include'
        });
        const googleData = await googleResponse.json();

        output.innerHTML = `
          <strong>📱 Dispositivos para ${cardId}:</strong><br><br>
          <strong>🍎 Apple:</strong> ${appleData.devices?.length || 0} dispositivos<br>
          <strong>🟢 Google:</strong> ${googleData.deviceCount || 0} dispositivos<br><br>
          <strong>Detalles Apple:</strong><br>${JSON.stringify(appleData.devices || [], null, 2)}<br><br>
          <strong>Detalles Google:</strong><br>${JSON.stringify(googleData.devices || [], null, 2)}
        `;
      } catch (error) {
        output.innerHTML = `❌ Error cargando dispositivos:<br>${error.message}`;
      }
    });

    // Ver configuración APNs
    document.getElementById('btn-check-apns')?.addEventListener('click', async function () {
      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = '🍎 Verificando configuración APNs...';

      try {
        const response = await fetch('/api/debug/apple-apns', {
          credentials: 'include'
        });

        const data = await response.json();
        output.innerHTML = `✅ Configuración APNs:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `❌ Error verificando APNs:<br>${error.message}`;
      }
    });

    // Logout
    document.getElementById('logout').addEventListener('click', async () => {
      try {
        await fetch('/api/logout', { method: 'POST', credentials: 'include' });
        window.location.href = '/admin-login.html';
      } catch (error) {
        console.error('Error al cerrar sesión:', error);
        window.location.href = '/admin-login.html';
      }
    });

    /* =========================================================
       LÓGICA DEL BOTÓN "ENVIAR A TODOS"
       ========================================================= */



    // Prevent form submission from interfering with buttons
    const pushForm = document.getElementById('push-notification-form');
    if (pushForm) {
      pushForm.addEventListener('submit', (e) => {
        e.preventDefault();
        console.log('Form submission prevented');
      });
    }

    const btnGlobal = document.getElementById('btn-mass-push');
    console.log('🔍 Buscando botón btn-mass-push:', btnGlobal);

    if (btnGlobal) {
      console.log('✅ Botón encontrado, agregando event listener');

      btnGlobal.addEventListener('click', async (e) => {
        e.preventDefault(); // Prevent any form submission
        e.stopPropagation(); // Stop event bubbling

        console.log('🚀 Botón "Enviar a todos" clickeado');

        const title = document.getElementById('push-title').value.trim();
        const message = document.getElementById('push-message').value.trim();

        console.log('📝 Título:', title);
        console.log('📝 Mensaje:', message);

        if (!title || !message) {
          console.warn('⚠️ Faltan datos');
          return alert("⚠️ Faltan datos: Escribe título y mensaje.");
        }

        if (!confirm(`🚨 ¿ENVIAR A TODOS?\n\n"${title}"`)) {
          console.log('❌ Usuario canceló');
          return;
        }

        const originalText = btnGlobal.textContent;
        btnGlobal.innerHTML = `<span style="display: inline-flex; align-items: center; gap: 6px;"><span class="spinner"></span> Enviando...</span>`;
        btnGlobal.disabled = true;

        console.log('📡 Enviando petición a /api/admin/push-all...');

        try {
          const r = await fetch('/api/admin/push-all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ title, message })
          });

          console.log('📥 Respuesta recibida:', r.status);
          const data = await r.json();
          console.log('📦 Data:', data);

          if (data.success) {
            const apple = data.results?.apple || 0;
            const google = data.results?.google || 0;
            console.log('✅ Éxito! Apple:', apple, 'Google:', google);
            alert(`✅ ¡ENVIADO!\n\n🍏 Apple: ${apple}\n🤖 Google: ${google}`);
            // Limpiar campos
            document.getElementById('push-title').value = "";
            document.getElementById('push-message').value = "";
          } else {
            console.error('❌ Error en respuesta:', data.error);
            alert('⚠️ Error: ' + (data.error || "Desconocido"));
          }
        } catch (e) {
          console.error('💥 Error de conexión:', e);
          alert('❌ Error de conexión: ' + e.message);
        } finally {
          btnGlobal.textContent = originalText;
          btnGlobal.disabled = false;
          console.log('🏁 Proceso terminado');
        }
      });
    } else {
      console.error('❌ Botón btn-mass-push NO encontrado en el DOM');
    }
    // Este archivo contiene el JavaScript completo para el módulo de citas
    // Se insertará en admin.html reemplazando la sección actual

    /* =========================================================
       LÓGICA DE CITAS - VERSIÓN COMPLETA
       ========================================================= */

    // Variables globales
    let allServices = [];
    let allClients = [];
    let currentMonth = new Date();
    currentMonth.setDate(1); // Primer día del mes
    let selectedDate = new Date();
    selectedDate.setHours(0, 0, 0, 0);
    let currentView = 'month';
    let monthAppointments = {}; // Cache de citas del mes
    let allAppointments = []; // Todas las citas del mes para el calendario

    // Helper function to convert Date to local YYYY-MM-DD
    function toLocalDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Elementos del DOM
    const btnNewAppt = document.getElementById('btn-new-appointment');
    const newApptDialog = document.getElementById('newApptDialog');
    const formNewAppt = document.getElementById('form-new-appt');
    const btnCancelAppt = document.getElementById('btn-cancel-appt');

    // Función para bloquear/desbloquear scroll del body cuando se abren diálogos
    function setupDialogScrollLock() {
      const dialogs = document.querySelectorAll('dialog');
      dialogs.forEach(dialog => {
        dialog.addEventListener('close', () => {
          document.body.style.overflow = '';
          document.body.style.paddingRight = '';
        });

        // Observar cuando se abre el diálogo
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.attributeName === 'open') {
              if (dialog.hasAttribute('open')) {
                document.body.style.overflow = 'hidden';
              } else {
                document.body.style.overflow = '';
              }
            }
          });
        });
        observer.observe(dialog, { attributes: true });
      });
    }

    // Inicializar bloqueo de scroll
    setupDialogScrollLock();
    const apptsTbody = document.getElementById('appts-tbody');
    const serviceSelect = document.getElementById('new-appt-service');
    const clientSelect = document.getElementById('new-appt-client-select');
    const phoneInput = document.getElementById('new-appt-phone');
    const hourSelect = document.getElementById('new-appt-hour');
    const minuteSelect = document.getElementById('new-appt-minute');
    const priceInput = document.getElementById('new-appt-price');
    const endTimeInput = document.getElementById('new-appt-end-time');
    const btnRefreshAppts = document.getElementById('btn-refresh-appts');

    // Navegación semanal
    const btnPrevMonth = document.getElementById('btn-prev-month');
    const btnNextMonth = document.getElementById('btn-next-month');
    const btnToday = document.getElementById('btn-today');
    const monthlyCalendar = document.getElementById('monthly-calendar');
    const calendarMonthTitle = document.getElementById('calendar-month-title');
    const selectedDateLabel = document.getElementById('selected-date-label');

    // Nuevo cliente
    const btnToggleNewClient = document.getElementById('btn-toggle-new-client');
    const newClientForm = document.getElementById('new-client-form');
    const btnSaveNewClient = document.getElementById('btn-save-new-client');


    // ========== GENERAR OPCIONES DE HORA Y MINUTOS ==========
    function generateHourMinuteOptions() {
      const hourSelect = document.getElementById('new-appt-hour');
      const minuteSelect = document.getElementById('new-appt-minute');

      if (!hourSelect || !minuteSelect) return;

      // Generar horas (8 AM - 8 PM)
      hourSelect.innerHTML = '<option value="">--</option>';
      for (let hour = 8; hour <= 20; hour++) {
        const option = document.createElement('option');
        option.value = String(hour).padStart(2, '0');
        const displayHour = hour > 12 ? hour - 12 : hour;
        const period = hour >= 12 ? 'PM' : 'AM';
        option.textContent = `${displayHour} ${period}`;
        hourSelect.appendChild(option);
      }

      // Generar minutos (00, 15, 30, 45)
      minuteSelect.innerHTML = '<option value="">--</option>';
      [0, 15, 30, 45].forEach(min => {
        const option = document.createElement('option');
        option.value = String(min).padStart(2, '0');
        option.textContent = String(min).padStart(2, '0');
        minuteSelect.appendChild(option);
      });
    }

    // ========== CARGAR SERVICIOS ==========
    async function loadServices() {
      try {
        const res = await fetch('/api/services');
        const json = await res.json();
        if (json.success) {
          allServices = json.data;

          // Map services to dropdown options format
          const options = allServices.map(s => ({
            value: s.name,
            label: s.name,
            meta: `[${s.category || 'Otros'}] ${s.durationMinutes} min - $${s.price}`,
            data: { id: s.id, price: s.price, duration: s.durationMinutes }
          }));

          // Initialize dropdowns if not already done
          if (!newApptServiceDropdown) {
            newApptServiceDropdown = new CustomSearchableDropdown(
              'new-appt-service',
              'services-dropdown-list',
              (item) => {
                // Auto-fill price when service selected
                document.getElementById('new-appt-price').value = item.data.price;
              }
            );
          }
          newApptServiceDropdown.setOptions(options);

          if (!editApptServiceDropdown) {
            editApptServiceDropdown = new CustomSearchableDropdown(
              'edit-appt-service',
              'edit-services-dropdown-list',
              (item) => {
                // Auto-fill price and duration when service selected
                document.getElementById('edit-appt-price').value = item.data.price;
                document.getElementById('edit-appt-duration').value = item.data.duration;
                calculateEditEndTime();
              }
            );
          }
          editApptServiceDropdown.setOptions(options);
        }
      } catch (e) { console.error('Error loading services', e); }
    }

    /* =========================================================
       HISTORIAL DE CITAS - SELECCIONAR PARA REPETIR SERVICIO
       ========================================================= */

    const historyPanel = document.getElementById('client-history-panel');
    const historyHeader = document.getElementById('toggle-history');
    const historyContent = document.getElementById('history-content');
    const historyList = document.getElementById('history-list');
    const historyCount = document.getElementById('history-count');
    const historyHint = document.getElementById('history-hint');

    // Toggle expandir/contraer historial
    if (historyHeader) {
      historyHeader.addEventListener('click', () => {
        const isExpanded = historyContent.style.display !== 'none';
        historyContent.style.display = isExpanded ? 'none' : 'block';
        historyHeader.classList.toggle('expanded', !isExpanded);
      });
    }

    // Cargar historial de citas del cliente
    async function loadClientHistory(clientPhone, clientName) {
      if (!clientPhone && !clientName) {
        historyPanel.classList.add('hidden');
        return;
      }

      try {
        const searchParam = clientPhone || clientName;
        const res = await fetch(`/api/appointments/client?search=${encodeURIComponent(searchParam)}`);
        const json = await res.json();

        if (json.success && json.data && json.data.length > 0) {
          const appointments = json.data;
          historyPanel.classList.remove('hidden');
          historyCount.textContent = `(${appointments.length})`;
          historyHint.textContent = 'Clic para repetir servicio';
          renderHistoryList(appointments);

          if (appointments.length <= 5) {
            historyContent.style.display = 'block';
            historyHeader.classList.add('expanded');
          }
        } else {
          historyPanel.classList.remove('hidden');
          historyCount.textContent = '(0)';
          historyHint.textContent = '¡Primera visita!';
          historyList.innerHTML = '<div class="history-empty">🎉 Nueva clienta</div>';
          historyContent.style.display = 'block';
          historyHeader.classList.add('expanded');
        }
      } catch (error) {
        console.error('Error cargando historial:', error);
        historyPanel.classList.add('hidden');
      }
    }

    function renderHistoryList(appointments) {
      if (appointments.length === 0) {
        historyList.innerHTML = '<div class="history-empty">Sin citas previas</div>';
        return;
      }

      // Ordenar por fecha más reciente y tomar las últimas 8
      appointments.sort((a, b) => new Date(b.startDateTime) - new Date(a.startDateTime));
      const recentAppts = appointments.slice(0, 8);

      const statusLabels = {
        'completed': '✅',
        'scheduled': '📅',
        'confirmed': '✔️',
        'cancelled': '❌'
      };

      historyList.innerHTML = recentAppts.map(appt => {
        const date = new Date(appt.startDateTime);
        const dateStr = date.toLocaleDateString('es-MX', {
          day: 'numeric',
          month: 'short',
          year: date.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
        });
        const statusIcon = statusLabels[appt.status] || '📋';

        return `
          <div class="history-item" 
               data-service-name="${appt.serviceName}"
               data-service-id="${appt.serviceId || ''}" 
               onclick="selectHistoryService(this)">
            <div class="history-item-info">
              <span class="history-item-date">${statusIcon} ${dateStr}</span>
              <span class="history-item-service">${appt.serviceName}</span>
            </div>
            <span class="history-item-select">Seleccionar →</span>
          </div>
        `;
      }).join('');
    }

    function selectHistoryService(element) {
      const serviceName = element.dataset.serviceName;
      const serviceId = element.dataset.serviceId;
      const service = allServices.find(s => s.name === serviceName || s.id === serviceId);

      const serviceInput = document.getElementById('new-appt-service');
      if (serviceInput) {
        serviceInput.value = serviceName;
        serviceInput.dispatchEvent(new Event('input', { bubbles: true }));
        serviceInput.dispatchEvent(new Event('change', { bubbles: true }));
      }

      const priceInput = document.getElementById('new-appt-price');
      if (priceInput && service) {
        priceInput.value = service.price;
      }

      document.querySelectorAll('.history-item').forEach(item => item.classList.remove('selected'));
      element.classList.add('selected');

      calculateEndTime();
    }

    window.selectHistoryService = selectHistoryService;

    // ========== CARGAR CLIENTES ==========
    async function loadClients() {
      try {
        console.log('[CLIENTS] 🔍 Cargando TODOS los clientes...');

        // Cargar TODAS las páginas de clientes
        let allClientsData = [];
        let page = 1;
        let hasMore = true;

        while (hasMore) {
          const res = await fetch(`/api/admin/cards-firebase?page=${page}&limit=100`, { credentials: 'include' });
          const data = await res.json();

          if (data.items && data.items.length > 0) {
            allClientsData = [...allClientsData, ...data.items];
            hasMore = page < data.totalPages;
            page++;
            console.log(`[CLIENTS] 📄 Página ${page - 1}: ${data.items.length} clientes (Total acumulado: ${allClientsData.length})`);
          } else {
            hasMore = false;
          }
        }

        console.log(`[CLIENTS] ✅ Total de clientes cargados: ${allClientsData.length}`);

        // Actualizar variable global
        allClients = allClientsData;

        // Map clients to dropdown options format
        const options = allClientsData.map(c => ({
          value: c.name,
          label: c.name,
          meta: c.phone || 'Sin teléfono',
          data: { id: c.id, phone: c.phone }
        }));

        console.log('[CLIENTS] 📋 Opciones mapeadas:', options.length);

        // Verificar que los elementos existen
        const inputEl = document.getElementById('new-appt-client-select');
        const dropdownEl = document.getElementById('clients-dropdown-list');

        console.log('[CLIENTS] 🔍 Input existe:', !!inputEl);
        console.log('[CLIENTS] 🔍 Dropdown existe:', !!dropdownEl);

        if (!inputEl || !dropdownEl) {
          console.error('[CLIENTS] ❌ Elementos no encontrados en el DOM');
          return;
        }

        if (!newApptClientDropdown) {
          console.log('[CLIENTS] 🆕 Creando nuevo dropdown...');
          newApptClientDropdown = new CustomSearchableDropdown(
            'new-appt-client-select',
            'clients-dropdown-list',
            (item) => {
              console.log('[CLIENTS] ✅ Cliente seleccionado:', item);
              // Auto-fill phone when client selected
              document.getElementById('new-appt-phone').value = item.data.phone || '';

              // Cargar historial de citas del cliente
              loadClientHistory(item.data.phone, item.label);
            }
          );
        }

        if (newApptClientDropdown) {
          newApptClientDropdown.setOptions(options);
          console.log('[CLIENTS] ✅ Opciones configuradas');
        } else {
          console.error('[CLIENTS] ❌ Dropdown no se pudo crear');
        }
      } catch (e) {
        console.error('[CLIENTS] ❌ Error loading clients:', e);
      }
    }


    // ========== RENDERIZADO CALENDARIO (Mes/Semana/Día) ==========

    function renderCalendar() {
      const calendarGrid = document.getElementById('monthly-calendar');
      if (!calendarGrid) return;

      const weekdaysHeader = document.querySelector('.weekdays-header');

      // Elemento título del mes
      const calendarMonthTitle = document.getElementById('calendar-month-title');
      // En este archivo el título a veces se actualiza dentro de renderMonthlyCalendar, 
      // pero aquí centralizamos la lógica para otras vistas.

      if (currentView === 'month') {
        if (weekdaysHeader) weekdaysHeader.style.display = 'grid';
        calendarGrid.className = 'calendar-grid'; // Reset class
        renderMonthlyCalendar();
      } else {
        if (weekdaysHeader) weekdaysHeader.style.display = 'none';
        calendarGrid.className = 'time-grid-container'; // Use container style

        if (currentView === 'week') renderWeeklyCalendar();
        else if (currentView === 'day') renderDailyCalendar();
      }

      // Update navigation Title for Week/Day view
      if (calendarMonthTitle && currentView !== 'month') {
        if (currentView === 'week') {
          const startOfWeek = new Date(selectedDate);
          startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay()); // Sunday
          const endOfWeek = new Date(startOfWeek);
          endOfWeek.setDate(startOfWeek.getDate() + 6);

          const m1 = startOfWeek.toLocaleString('es-MX', { month: 'short' });
          const m2 = endOfWeek.toLocaleString('es-MX', { month: 'short' });

          calendarMonthTitle.textContent = `${startOfWeek.getDate()} ${m1} - ${endOfWeek.getDate()} ${m2} ${endOfWeek.getFullYear()}`;
        } else if (currentView === 'day') {
          const dateStr = selectedDate.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
          calendarMonthTitle.textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
        }
      }
    }

    function renderWeeklyCalendar() {
      const calendarContainer = document.getElementById('monthly-calendar');
      calendarContainer.innerHTML = '';

      // Start of week (Sunday)
      const startOfWeek = new Date(selectedDate);
      startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
      startOfWeek.setHours(0, 0, 0, 0);

      // Generate Headers
      let headersHTML = '<div class="time-header-spacer"></div><div class="day-headers">';
      const days = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(startOfWeek);
        d.setDate(startOfWeek.getDate() + i);
        days.push(d);
        const isToday = (d.toDateString() === new Date().toDateString());
        headersHTML += `<div class="day-header-cell ${isToday ? 'today' : ''}">
            ${d.toLocaleDateString('es-MX', { weekday: 'short' })} ${d.getDate()}
         </div>`;
      }
      headersHTML += '</div>';

      // Generate Time Grid
      let bodyHTML = '<div class="time-grid-body"><div class="time-labels">';
      for (let h = 8; h <= 20; h++) {
        bodyHTML += `<div class="time-label">${h}:00</div>`;
      }
      bodyHTML += '</div><div class="days-grid">';

      // Columns
      days.forEach(day => {
        bodyHTML += `<div class="day-column" data-date="${toLocalDateString(day)}">`;
        for (let h = 8; h <= 20; h++) {
          const timeStr = `${String(h).padStart(2, '0')}:00`;
          bodyHTML += `<div class="time-slot" data-time="${timeStr}" onclick="openNewApptDialogWithDate('${toLocalDateString(day)}', '${timeStr}')"></div>`;
        }

        // Events
        const dayStr = toLocalDateString(day);
        const dailyAppts = (allAppointments || []).filter(a => a.date === dayStr && a.status !== 'cancelled');

        dailyAppts.forEach(appt => {
          if (!appt.time) return;
          const [apptH, apptM] = appt.time.split(':').map(Number);
          if (apptH < 8 || apptH > 20) return;

          const top = ((apptH - 8) * 60) + (apptM || 0);
          const height = (appt.durationMinutes || 60);

          let bg = '#5c6bc0';
          if (appt.status === 'confirmed') bg = '#10b981';
          else if (appt.status === 'completed') bg = '#059669';
          else if (appt.status === 'no_show') bg = '#ef4444';

          bodyHTML += `<div class="appt-block" style="top:${top}px; height:${height}px; background:${bg}cc; border-left-color:${bg};" 
                          onclick="event.stopPropagation(); editAppointment('${appt.id}')" title="${appt.clientName} - ${appt.serviceName}">
                <strong>${appt.time}</strong> ${appt.clientName}
            </div>`;
        });

        bodyHTML += '</div>';
      });

      bodyHTML += '</div></div>';
      calendarContainer.innerHTML = `<div class="time-grid-header">${headersHTML}</div>` + bodyHTML;
    }

    function renderDailyCalendar() {
      const calendarContainer = document.getElementById('monthly-calendar');
      calendarContainer.innerHTML = '';

      const d = new Date(selectedDate);

      // Header
      let headersHTML = '<div class="time-header-spacer"></div><div class="day-headers">';
      const isToday = (d.toDateString() === new Date().toDateString());
      headersHTML += `<div class="day-header-cell ${isToday ? 'today' : ''}">
            ${d.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long' })}
         </div>`;
      headersHTML += '</div>';

      // Body
      let bodyHTML = '<div class="time-grid-body"><div class="time-labels">';
      for (let h = 8; h <= 20; h++) {
        bodyHTML += `<div class="time-label">${h}:00</div>`;
      }
      bodyHTML += '</div><div class="days-grid">';

      // Column
      bodyHTML += `<div class="day-column" style="flex:1;" data-date="${toLocalDateString(d)}">`;
      for (let h = 8; h <= 20; h++) {
        const timeStr = `${String(h).padStart(2, '0')}:00`;
        bodyHTML += `<div class="time-slot" data-time="${timeStr}" onclick="openNewApptDialogWithDate('${toLocalDateString(d)}', '${timeStr}')"></div>`;
      }

      // Events
      const dayStr = toLocalDateString(d);
      const dailyAppts = (allAppointments || []).filter(a => a.date === dayStr && a.status !== 'cancelled');

      dailyAppts.forEach(appt => {
        if (!appt.time) return;
        const [apptH, apptM] = appt.time.split(':').map(Number);
        if (apptH < 8 || apptH > 20) return;

        const top = ((apptH - 8) * 60) + (apptM || 0);
        const height = (appt.durationMinutes || 60);
        let bg = '#5c6bc0';
        if (appt.status === 'confirmed') bg = '#10b981';
        else if (appt.status === 'completed') bg = '#059669';
        else if (appt.status === 'no_show') bg = '#ef4444';

        bodyHTML += `<div class="appt-block" style="top:${top}px; height:${height}px; background:${bg}cc; border-left-color:${bg};" 
                        onclick="event.stopPropagation(); editAppointment('${appt.id}')" title="${appt.clientName}">
              <div style="font-weight:bold;">${appt.time} - ${appt.clientName}</div>
              <div style="font-size:0.9em;">${appt.serviceName}</div>
              <div style="font-size:0.8em;opacity:0.8;">${appt.clientPhone}</div>
          </div>`;
      });

      bodyHTML += '</div></div></div>';
      calendarContainer.innerHTML = `<div class="time-grid-header">${headersHTML}</div>` + bodyHTML;
    }

    // Función global para abrir modal desde el calendario
    window.openNewApptDialogWithDate = function (dateIso, timeStr) {
      if (newApptDialog) newApptDialog.showModal();

      loadServices();
      loadClients();
      generateHourMinuteOptions();

      if (newApptCalendar && typeof newApptCalendar.selectDate === 'function') {
        newApptCalendar.selectDate(dateIso);
      } else {
        const dateInput = document.getElementById('new-appt-date');
        if (dateInput) dateInput.value = dateIso;
      }

      const [h, m] = timeStr.split(':');
      const hourSelect = document.getElementById('new-appt-hour');
      const minuteSelect = document.getElementById('new-appt-minute');
      if (hourSelect) hourSelect.value = h;
      if (minuteSelect) minuteSelect.value = m;
    }
    async function renderMonthlyCalendar() {
      if (!monthlyCalendar) return;

      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();

      // Actualizar título
      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      if (calendarMonthTitle) {
        calendarMonthTitle.textContent = `${monthNames[month]} ${year}`;
      }

      // Limpiar calendario
      monthlyCalendar.innerHTML = '';

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Primer día del mes y último día
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startDayOfWeek = firstDay.getDay(); // 0 = Domingo

      // Días del mes anterior para llenar (si el mes no empieza en Domingo)
      const prevMonthLastDay = new Date(year, month, 0).getDate();
      for (let i = 0; i < startDayOfWeek; i++) {
        const dayNum = prevMonthLastDay - startDayOfWeek + 1 + i;
        const dayEl = createGoogleCalendarDay(dayNum, year, month - 1, true);
        monthlyCalendar.appendChild(dayEl);
      }

      // Días del mes actual
      for (let day = 1; day <= daysInMonth; day++) {
        const dayEl = createGoogleCalendarDay(day, year, month, false);
        monthlyCalendar.appendChild(dayEl);
      }

      // Días del siguiente mes para completar la cuadrícula
      const totalCells = monthlyCalendar.children.length;
      const remainingCells = Math.ceil(totalCells / 7) * 7 - totalCells;
      if (remainingCells > 0 && remainingCells < 7) {
        for (let day = 1; day <= remainingCells; day++) {
          const dayEl = createGoogleCalendarDay(day, year, month + 1, true);
          monthlyCalendar.appendChild(dayEl);
        }
      }

      // Cargar citas del mes
      await loadMonthAppointments();
    }

    function createGoogleCalendarDay(dayNum, year, month, isOtherMonth) {
      const dayEl = document.createElement('div');
      dayEl.className = 'calendar-day';

      const date = new Date(year, month, dayNum);
      date.setHours(0, 0, 0, 0);
      const dateStr = toLocalDateString(date);
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Clases CSS
      if (isOtherMonth) {
        dayEl.classList.add('other-month');
      }

      if (date.getTime() === today.getTime()) {
        dayEl.classList.add('today');
      }

      if (date.getTime() === selectedDate.getTime()) {
        dayEl.classList.add('selected');
      }

      // Número del día
      const dayNumber = document.createElement('div');
      dayNumber.className = 'day-number';
      dayNumber.textContent = dayNum;
      dayEl.appendChild(dayNumber);

      // Contenedor de eventos
      const eventsContainer = document.createElement('div');
      eventsContainer.className = 'day-events';

      // Obtener citas del día
      const dayAppointments = (allAppointments || []).filter(apt => {
        const aptDate = new Date(apt.date + 'T00:00:00');
        aptDate.setHours(0, 0, 0, 0);
        return aptDate.getTime() === date.getTime();
      });

      // Mostrar hasta 3 eventos, el resto como "+X más"
      const maxEvents = 3;
      dayAppointments.slice(0, maxEvents).forEach(apt => {
        const eventEl = document.createElement('div');
        eventEl.className = 'calendar-event';

        // Color según estado
        if (apt.status === 'confirmed') eventEl.classList.add('confirmed');
        else if (apt.status === 'cancelled') eventEl.classList.add('cancelled');
        else eventEl.classList.add('pending');

        eventEl.textContent = `${apt.time} ${apt.clientName}`;
        eventEl.title = `${apt.time} - ${apt.clientName}\n${apt.serviceName}`;

        // Click en evento - ABRIR DIRECTAMENTE LA CITA
        eventEl.addEventListener('click', (e) => {
          e.stopPropagation();
          // Abrir el modal de edición de cita
          editAppointment(apt.id);
        });

        eventsContainer.appendChild(eventEl);
      });

      // Mostrar "+X más" si hay más eventos
      if (dayAppointments.length > maxEvents) {
        const moreEl = document.createElement('div');
        moreEl.className = 'event-more';
        moreEl.textContent = `+${dayAppointments.length - maxEvents} más`;
        moreEl.addEventListener('click', (e) => {
          e.stopPropagation();
          selectedDate = new Date(date);

          // Cambiar a la pestaña de Citas
          document.querySelectorAll('.nav a').forEach(a => a.classList.remove('is-active'));
          document.querySelectorAll('.mobile-nav-link').forEach(a => a.classList.remove('is-active'));

          const appointmentsTab = document.querySelector('[data-tab="appointments"]');
          if (appointmentsTab) {
            appointmentsTab.classList.add('is-active');
          }

          document.querySelectorAll('[id^="tab-"]').forEach(s => s.classList.add('hidden'));
          const appointmentsSection = document.getElementById('tab-appointments');
          if (appointmentsSection) {
            appointmentsSection.classList.remove('hidden');
          }


          // Update visual selection without full re-render
          document.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));

          loadAppointments();
          updateSelectedDateLabel();
        });
        eventsContainer.appendChild(moreEl);
      }

      dayEl.appendChild(eventsContainer);

      // Click en día
      if (!isOtherMonth) {
        dayEl.addEventListener('click', () => {
          // Remover selección anterior
          document.querySelectorAll('.calendar-day.selected').forEach(el => {
            el.classList.remove('selected');
          });

          // Seleccionar nuevo día
          dayEl.classList.add('selected');
          selectedDate = new Date(date);

          // Cambiar a la pestaña de Citas
          document.querySelectorAll('.nav a').forEach(a => a.classList.remove('is-active'));
          document.querySelectorAll('.mobile-nav-link').forEach(a => a.classList.remove('is-active'));

          const appointmentsTab = document.querySelector('[data-tab="appointments"]');
          if (appointmentsTab) {
            appointmentsTab.classList.add('is-active');
          }

          document.querySelectorAll('[id^="tab-"]').forEach(s => s.classList.add('hidden'));
          const appointmentsSection = document.getElementById('tab-appointments');
          if (appointmentsSection) {
            appointmentsSection.classList.remove('hidden');
          }

          // Cargar citas del día seleccionado
          loadAppointments();
          updateSelectedDateLabel();
        });
      }

      return dayEl;
    }

    // Función createDayElement eliminada - ahora usamos createGoogleCalendarDay

    async function loadMonthAppointments() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth() + 1;

      try {
        const res = await fetch(`/api/appointments/month?year=${year}&month=${month}`);
        const json = await res.json();

        if (json.success) {
          // Guardar todas las citas del mes
          allAppointments = json.data.map(appt => ({
            ...appt,
            date: appt.date || toLocalDateString(new Date(appt.startDateTime)),
            time: appt.time || new Date(appt.startDateTime).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', hour12: false })
          }));

          // Contar citas por día
          monthAppointments = {};
          json.data.forEach(appt => {
            if (appt.status !== 'cancelled') {
              const date = new Date(appt.startDateTime);
              const dateStr = toLocalDateString(date);
              monthAppointments[dateStr] = (monthAppointments[dateStr] || 0) + 1;
            }
          });

          // Update calendar days with appointments data (without full re-render to avoid flickering)
          updateCalendarDaysWithAppointments();
        }
      } catch (error) {
        console.error('Error loading month appointments:', error);
      }
    }

    // Update calendar days with appointment events without full re-render (prevents flickering)
    function updateCalendarDaysWithAppointments() {
      const calendarDays = document.querySelectorAll('.calendar-day:not(.other-month)');

      calendarDays.forEach(dayEl => {
        // Get the date from the day element
        const dayNumber = dayEl.querySelector('.day-number');
        if (!dayNumber) return;

        const dayNum = parseInt(dayNumber.textContent);
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const date = new Date(year, month, dayNum);
        date.setHours(0, 0, 0, 0);

        // Clear existing events container
        let eventsContainer = dayEl.querySelector('.day-events');
        if (eventsContainer) {
          eventsContainer.innerHTML = '';
        } else {
          eventsContainer = document.createElement('div');
          eventsContainer.className = 'day-events';
          dayEl.appendChild(eventsContainer);
        }

        // Find appointments for this day
        const dayAppointments = (allAppointments || []).filter(apt => {
          const aptDate = new Date(apt.date + 'T00:00:00');
          aptDate.setHours(0, 0, 0, 0);
          return aptDate.getTime() === date.getTime();
        });

        // Add appointment events
        const maxEvents = 3;
        dayAppointments.slice(0, maxEvents).forEach(apt => {
          const eventEl = document.createElement('div');
          eventEl.className = 'calendar-event';

          if (apt.status === 'confirmed') eventEl.classList.add('confirmed');
          else if (apt.status === 'cancelled') eventEl.classList.add('cancelled');
          else eventEl.classList.add('pending');

          eventEl.textContent = `${apt.time} ${apt.clientName}`;
          eventEl.title = `${apt.time} - ${apt.clientName}\n${apt.serviceName}`;

          // Click handler for event
          eventEl.addEventListener('click', (e) => {
            e.stopPropagation();
            editAppointment(apt.id);
          });

          eventsContainer.appendChild(eventEl);
        });

        // Show "+X más" if more events
        if (dayAppointments.length > maxEvents) {
          const moreEl = document.createElement('div');
          moreEl.className = 'event-more';
          moreEl.textContent = `+${dayAppointments.length - maxEvents} más`;
          moreEl.addEventListener('click', (e) => {
            e.stopPropagation();
            selectedDate = new Date(date);
            loadAppointments();
            updateSelectedDateLabel();
          });
          eventsContainer.appendChild(moreEl);
        }

        // Add has-appointments class if needed
        if (dayAppointments.length > 0) {
          dayEl.classList.add('has-appointments');
        } else {
          dayEl.classList.remove('has-appointments');
        }
      });
    }

    function updateSelectedDateLabel() {
      const label = document.getElementById('selected-date-label');
      if (label) {
        const options = { weekday: 'long', day: 'numeric', month: 'long' };
        label.textContent = selectedDate.toLocaleDateString('es-MX', options);
      }
    }


    // ========== CARGAR CITAS ==========
    async function loadAppointments() {
      if (!apptsTbody) return;
      apptsTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;">Cargando...</td></tr>';

      const dateStr = toLocalDateString(selectedDate);
      console.log(`📋 Cargar lista citas para: ${dateStr}`);

      try {
        const res = await fetch(`/api/appointments?date=${dateStr}`);
        const json = await res.json();
        console.log(`   📦 Recibidas ${json.data?.length} citas para lista`);

        if (json.success) {
          if (json.data.length === 0) {
            apptsTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;" class="muted">No hay citas para este día</td></tr>';
            return;
          }

          apptsTbody.innerHTML = json.data.map(appt => {
            const time = new Date(appt.startDateTime).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', hour12: false });
            const statusColors = {
              'scheduled': '#3b82f6',      // Azul
              'confirmed': '#22c55e',      // Verde
              'rescheduling': '#fbbf24',   // Amarillo
              'completed': 'var(--venus-soft)', // Verde Venus
              'cancelled': '#ef4444',       // Rojo
              'no_show': '#6b7280'         // Gris
            };
            const statusOptions = {
              'scheduled': 'Agendada',
              'confirmed': 'Confirmada',
              'completed': 'Completada',
              'cancelled': 'Cancelada',
              'no_show': 'No asistió'
            };

            const statusBg = statusColors[appt.status] || '#6b7280';

            return `
              <tr>
                <td style="padding:12px;font-weight:bold;color:#e5e7eb;">${time}</td>
                <td style="padding:12px;">
                  <div style="font-weight:600;color:#f3f4f6;">${appt.clientName}</div>
                  <div style="font-size:0.85em;color:#9ca3af;">${appt.clientPhone}</div>
                </td>
                <td style="padding:12px;color:#d1d5db;">${appt.serviceName}</td>
                <td style="padding:12px;">
                  <select 
                    onchange="updateAppointmentStatus('${appt.id}', this.value)"
                    style="
                      background-color: ${statusBg};
                      color: white;
                      border: none;
                      padding: 4px 8px;
                      border-radius: 12px;
                      font-size: 0.85em;
                      font-weight: 500;
                      cursor: pointer;
                      appearance: none;
                      -webkit-appearance: none;
                      text-align: center;
                      width: 100px;
                    "
                  >
                    ${Object.entries(statusOptions).map(([key, label]) => `
                      <option value="${key}" ${appt.status === key ? 'selected' : ''} style="background-color:#1f2937;color:white;">
                        ${label}
                      </option>
                    `).join('')}
                  </select>
                </td>
                <td style="padding:12px;">
                  <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
                    ${appt.status !== 'completed' ? `
                    <button onclick="openPaymentModal('${appt.id}', '${appt.clientName.replace(/'/g, "\\'") || ''}', '${appt.serviceName.replace(/'/g, "\\'") || ''}', ${appt.price || 0})" class="btn-icon" style="background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;padding:6px 12px;border-radius:8px;font-size:0.85em;display:flex;align-items:center;gap:6px;border:none;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 4px rgba(16,185,129,0.3);" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 8px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='';this.style.boxShadow='0 2px 4px rgba(16,185,129,0.3)'">
                      <i class="fas fa-money-bill-wave"></i> Pagar
                    </button>
                    ` : `
                    <div style="display:flex;align-items:center;gap:6px;background:rgba(34,197,94,0.1);padding:4px 8px;border-radius:6px;border:1px solid rgba(34,197,94,0.3);">
                      <span style="color:#22c55e;font-weight:600;font-size:0.9em;">$${appt.totalPaid || 0}</span>
                      ${(appt.productsSold && appt.productsSold.length > 0) ? `
                        <span style="background:#8b5cf6;color:white;padding:2px 6px;border-radius:4px;font-size:0.75em;font-weight:600;" title="${appt.productsSold.reduce((sum, p) => sum + p.qty, 0)} productos">📦 ${appt.productsSold.reduce((sum, p) => sum + p.qty, 0)}</span>
                      ` : ''}
                      <button onclick="viewPaymentDetails('${appt.id}')" title="Ver detalle de pago" style="background:none;border:none;color:#60a5fa;cursor:pointer;padding:2px 4px;font-size:0.85em;">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button onclick="openPaymentModal('${appt.id}', '${appt.clientName.replace(/'/g, "\\'")}', '${appt.serviceName.replace(/'/g, "\\'")}', ${appt.totalPaid || 0}, true)" title="Editar pago" style="background:none;border:none;color:#9ca3af;cursor:pointer;padding:0;font-size:0.8em;">
                        <i class="fas fa-pencil-alt"></i>
                      </button>
                    </div>
                    `}
                    <button onclick="sendWhatsAppReminder('${appt.id}', '${appt.clientPhone}', '${appt.clientName.replace(/'/g, "\\'")}', '${appt.serviceName.replace(/'/g, "\\'")}', '${appt.startDateTime}')" class="btn-icon" style="background:linear-gradient(135deg, #25D366 0%, #128C7E 100%);color:white;padding:6px 12px;border-radius:8px;font-size:0.85em;display:flex;align-items:center;gap:6px;border:none;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 4px rgba(37,211,102,0.3);" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 8px rgba(37,211,102,0.4)'" onmouseout="this.style.transform='';this.style.boxShadow='0 2px 4px rgba(37,211,102,0.3)'" title="Enviar recordatorio por WhatsApp">
                      <i class="fab fa-whatsapp"></i>
                    </button>
                    <button onclick="editAppointment('${appt.id}')" class="btn-icon" style="background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);color:white;padding:6px 12px;border-radius:8px;font-size:0.85em;display:flex;align-items:center;gap:6px;border:none;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 4px rgba(59,130,246,0.3);" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 8px rgba(59,130,246,0.4)'" onmouseout="this.style.transform='';this.style.boxShadow='0 2px 4px rgba(59,130,246,0.3)'">
                      <i class="fas fa-edit"></i> Modificar
                    </button>
                    <button onclick="cancelAppointment('${appt.id}')" class="btn-icon" style="background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);color:white;padding:6px 12px;border-radius:8px;font-size:0.85em;display:flex;align-items:center;gap:6px;border:none;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 4px rgba(239,68,68,0.3);" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 8px rgba(239,68,68,0.4)'" onmouseout="this.style.transform='';this.style.boxShadow='0 2px 4px rgba(239,68,68,0.3)'">
                      <i class="fas fa-times-circle"></i> Cancelar
                    </button>
                  </div>
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error(e);
        apptsTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--err-text);">Error cargando citas</td></tr>';
      }
    }

    // ========== ESTADÍSTICAS DEL MES ==========
    async function loadMonthStats() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      console.log(`[STATS] Cargando estadísticas para: año=${year}, mes=${month + 1}`);

      try {
        // Obtener todas las citas del mes
        const res = await fetch('/api/appointments/month?' + new URLSearchParams({
          year: year.toString(),
          month: (month + 1).toString()
        }));

        if (!res.ok) {
          throw new Error('Error cargando estadísticas');
        }

        const json = await res.json();

        if (json.success && json.data) {
          const appointments = json.data;
          const total = appointments.length;
          const completed = appointments.filter(a => a.status === 'completed').length;
          const cancelled = appointments.filter(a => a.status === 'cancelled').length;
          const pending = appointments.filter(a => a.status === 'scheduled').length;

          document.getElementById('stat-total').textContent = total;
          document.getElementById('stat-completed').textContent = completed;
          document.getElementById('stat-cancelled').textContent = cancelled;
          document.getElementById('stat-pending').textContent = pending;
        } else {
          document.getElementById('stat-total').textContent = '0';
          document.getElementById('stat-completed').textContent = '0';
          document.getElementById('stat-cancelled').textContent = '0';
          document.getElementById('stat-pending').textContent = '0';
        }

        // Calculate revenue by payment method
        let cashTotal = 0;
        let cardTotal = 0;
        let transferTotal = 0;

        if (json.success && json.data) {
          console.log(`[REVENUE] Total citas del mes: ${json.data.length}`);
          const completedAppts = json.data.filter(a => a.status === 'completed');
          console.log(`[REVENUE] Citas completadas: ${completedAppts.length}`);

          json.data.forEach(appt => {
            if (appt.status === 'completed') {
              // Support both structures (legacy object or root fields)
              const amount = parseFloat(appt.totalPaid || (appt.payment ? appt.payment.amount : 0) || 0);
              const method = appt.paymentMethod || (appt.payment ? appt.payment.method : '') || '';

              console.log(`[REVENUE] Cita ${appt.id}:`, {
                status: appt.status,
                startDateTime: appt.startDateTime,
                totalPaid: appt.totalPaid,
                paymentMethod: appt.paymentMethod,
                payment: appt.payment,
                amount: amount,
                method: method,
                clientName: appt.clientName,
                serviceName: appt.serviceName
              });

              if (amount > 0 && method) {
                switch (method) {
                  case 'efectivo':
                    cashTotal += amount;
                    break;
                  case 'tarjeta':
                    cardTotal += amount;
                    break;
                  case 'transferencia':
                    transferTotal += amount;
                    break;
                }
              }
            }
          });

          console.log(`[REVENUE] Totales calculados: Efectivo=${cashTotal}, Tarjeta=${cardTotal}, Transferencia=${transferTotal}`);
        }

        const total = cashTotal + cardTotal + transferTotal;

        // Update revenue display
        document.getElementById('revenue-cash').textContent = `$${cashTotal.toFixed(2)}`;
        document.getElementById('revenue-card').textContent = `$${cardTotal.toFixed(2)}`;
        document.getElementById('revenue-transfer').textContent = `$${transferTotal.toFixed(2)}`;
        document.getElementById('revenue-total').textContent = `$${total.toFixed(2)}`;
      } catch (e) {
        console.error('Error loading month stats', e);
        document.getElementById('stat-total').textContent = '-';
        document.getElementById('stat-completed').textContent = '-';
        document.getElementById('stat-cancelled').textContent = '-';
        document.getElementById('stat-pending').textContent = '-';
      }
    }

    // ========== CANCELAR CITA ==========
    window.cancelAppointment = async (id) => {
      if (!confirm('¿Cancelar esta cita?')) return;
      try {
        await fetch(`/api/appointments/${id}/cancel`, { method: 'PATCH' });
        loadAppointments();
        renderMonthlyCalendar();
        loadMonthStats();
      } catch (e) { alert('Error: ' + e.message); }
    };

    // ========== ENVIAR RECORDATORIO POR WHATSAPP ==========
    window.sendWhatsAppReminder = (id, phone, clientName, serviceName, startDateTime) => {
      try {
        // Formatear fecha y hora
        const date = new Date(startDateTime);
        const dateStr = date.toLocaleDateString('es-MX', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        const timeStr = date.toLocaleTimeString('es-MX', {
          hour: '2-digit',
          minute: '2-digit',
          hour12: true
        });

        // Crear mensaje
        const message = `Hola ${clientName} 👋

🌟 *Recordatorio de tu cita en Venus Cosmetología*

📅 *Fecha:* ${dateStr}
⏰ *Hora:* ${timeStr}
💆‍♀️ *Servicio:* ${serviceName}

Te esperamos! Si necesitas reagendar, por favor avísanos con anticipación.

Gracias por tu preferencia ✨`;

        // Limpiar número de teléfono (quitar espacios, guiones, etc)
        const cleanPhone = phone.replace(/[^0-9]/g, '');

        // Abrir WhatsApp
        const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');

        console.log('📱 WhatsApp abierto para:', clientName, cleanPhone);
      } catch (error) {
        console.error('Error enviando recordatorio WhatsApp:', error);
        alert('Error al abrir WhatsApp. Verifica que el número de teléfono sea válido.');
      }
    };

    async function updateAppointmentStatus(id, newStatus) {
      // Prevenir cambio a 'completed' sin registrar pago
      if (newStatus === 'completed') {
        alert('⚠️ Para completar una cita debes registrar el pago.\n\nUsa el botón verde "Pagar" para registrar el pago y completar la cita.');
        loadAppointments(); // Revertir selección visualmente
        return;
      }

      if (!confirm(`¿Cambiar estado a "${newStatus}"?`)) {
        loadAppointments(); // Revertir selección visualmente
        return;
      }

      try {
        const res = await fetch(`/api/appointments/${id}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });
        const json = await res.json();

        if (json.success) {
          // Si se canceló, recargar todo para actualizar calendarios y contadores
          if (newStatus === 'cancelled') {
            renderMonthlyCalendar();
          }
          loadAppointments();
        } else {
          alert('Error al actualizar estado: ' + json.error);
          loadAppointments();
        }
      } catch (e) {
        console.error(e);
        alert('Error de conexión');
        loadAppointments();
      }
    }

    // ========== AUTO-REFRESH PARA CITAS (detecta cambios de WhatsApp) ==========
    let appointmentsRefreshInterval = null;
    let lastAppointmentsData = null;

    function startAppointmentsAutoRefresh() {
      // Refrescar cada 60 segundos cuando está en el tab de appointments
      if (appointmentsRefreshInterval) {
        clearInterval(appointmentsRefreshInterval);
      }

      // Los datos se actualizan automáticamente con listeners en tiempo real de Firestore
      // Solo se ejecutan cuando hay cambios reales en la base de datos
      console.log('[APPOINTMENTS] ✅ Usando listeners en tiempo real de Firestore')
    }

    function stopAppointmentsAutoRefresh() {
      if (appointmentsRefreshInterval) {
        clearInterval(appointmentsRefreshInterval);
        appointmentsRefreshInterval = null;
      }
    }

    // Iniciar auto-refresh cuando se carga la página si está en appointments
    document.addEventListener('DOMContentLoaded', () => {
      const appointmentsTab = document.getElementById('tab-appointments');
      if (appointmentsTab && !appointmentsTab.classList.contains('hidden')) {
        startAppointmentsAutoRefresh();
      }
    });

    // ========== REGISTRAR PAGO ==========
    window.openPaymentDialog = async (apptId) => {
      try {
        const res = await fetch(`/api/appointments/${apptId}`);
        const json = await res.json();

        if (!json.success) {
          alert('Error cargando datos de la cita');
          return;
        }

        const appt = json.data;

        // Buscar precio del servicio si no viene en la cita
        let price = appt.price || 0;
        console.log('Initial price from appt:', price);
        console.log('Service Name:', appt.serviceName);

        if (!price && appt.serviceName) {
          // Asegurar que los servicios estén cargados
          if (typeof allServices === 'undefined' || allServices.length === 0) {
            console.log('allServices empty, loading...');
            if (typeof loadServices === 'function') await loadServices();
          }
          if (typeof allServices !== 'undefined') {
            console.log('Searching service in allServices:', allServices);
            const service = allServices.find(s => s.name === appt.serviceName);
            if (service) {
              console.log('Service found:', service);
              price = service.price;
            } else {
              console.log('Service NOT found in allServices');
            }
          }
        }
        console.log('Final price:', price);

        openPaymentModal(apptId, appt.clientName, appt.serviceName, price);
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };



    // ========== MODIFICAR CITA ==========
    const editApptDialog = document.getElementById('editApptDialog');
    const formEditAppt = document.getElementById('form-edit-appt');
    const btnCancelEditAppt = document.getElementById('btn-cancel-edit-appt');
    const editApptId = document.getElementById('edit-appt-id');
    const editClientName = document.getElementById('edit-appt-client-name');
    const editServiceInput = document.getElementById('edit-appt-service');
    const editPriceInput = document.getElementById('edit-appt-price');
    const editDurationInput = document.getElementById('edit-appt-duration');
    const editDateInput = document.getElementById('edit-appt-date');
    const editHourSelect = document.getElementById('edit-appt-hour');
    const editMinuteSelect = document.getElementById('edit-appt-minute');
    const editEndTimeInput = document.getElementById('edit-appt-end-time');

    window.editAppointment = async (id) => {
      try {
        // Fetch appointment data
        const res = await fetch(`/api/appointments/${id}`);
        const json = await res.json();

        if (!json.success) {
          alert('Error cargando cita');
          return;
        }

        const appt = json.data;

        // Load services and generate hour/minute options
        await loadServices();
        generateHourMinuteOptionsForEdit();

        // Populate edit form with frozen client name
        editApptId.value = id;
        editClientName.value = appt.clientName;
        editServiceInput.value = appt.serviceName;

        // Find service to get price and duration
        const service = allServices.find(s => s.name === appt.serviceName);
        if (service) {
          editPriceInput.value = service.price;
          editDurationInput.value = service.durationMinutes;
        }

        // Extract date and time from startDateTime
        const startDate = new Date(appt.startDateTime);
        const isoDate = appt.startDateTime.split('T')[0];
        editDateInput.value = isoDate;

        // Initialize calendar with existing date
        editApptCalendar.selectedDate = isoDate;
        const date = new Date(isoDate + 'T12:00:00');
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        editDateInput.value = `${day}/${month}/${year}`;
        editDateInput.dataset.isoDate = isoDate;

        editHourSelect.value = String(startDate.getHours()).padStart(2, '0');
        editMinuteSelect.value = String(startDate.getMinutes()).padStart(2, '0');

        // Calculate end time
        calculateEditEndTime();

        // Show modal
        editApptDialog.showModal();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    function generateHourMinuteOptionsForEdit() {
      // Hours
      editHourSelect.innerHTML = '<option value="">--</option>';
      for (let h = 8; h <= 20; h++) {
        const val = String(h).padStart(2, '0');
        editHourSelect.innerHTML += `<option value="${val}">${h}:00</option>`;
      }

      // Minutes
      editMinuteSelect.innerHTML = '<option value="">--</option>';
      ['00', '15', '30', '45'].forEach(m => {
        editMinuteSelect.innerHTML += `<option value="${m}">${m}</option>`;
      });
    }

    function calculateEditEndTime() {
      if (!editHourSelect || !editMinuteSelect || !editEndTimeInput) return;

      const hour = editHourSelect.value;
      const minute = editMinuteSelect.value;
      const serviceName = editServiceInput.value.trim();
      const service = allServices.find(s => s.name === serviceName);

      if (!hour || !minute || !service) return;

      const duration = parseInt(service.durationMinutes) || 60;
      const startDate = new Date();
      startDate.setHours(parseInt(hour), parseInt(minute), 0);
      const endDate = new Date(startDate.getTime() + duration * 60000);

      const endHours = endDate.getHours();
      const endMinutes = endDate.getMinutes();
      const displayHour = endHours > 12 ? endHours - 12 : (endHours === 0 ? 12 : endHours);
      const period = endHours >= 12 ? 'PM' : 'AM';

      editEndTimeInput.value = `${displayHour}:${String(endMinutes).padStart(2, '0')} ${period}`;
    }

    // Event listeners for edit modal
    if (btnCancelEditAppt) {
      btnCancelEditAppt.addEventListener('click', () => editApptDialog.close());
    }

    if (editServiceInput) {
      editServiceInput.addEventListener('input', function () {
        const serviceName = this.value.trim();
        const service = allServices.find(s => s.name === serviceName);
        if (service) {
          editPriceInput.value = service.price;
          editDurationInput.value = service.durationMinutes;
          calculateEditEndTime();
        }
      });
    }

    if (editHourSelect) {
      editHourSelect.addEventListener('change', calculateEditEndTime);
    }

    if (editMinuteSelect) {
      editMinuteSelect.addEventListener('change', calculateEditEndTime);
    }

    if (formEditAppt) {
      formEditAppt.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = formEditAppt.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Guardando...';

        try {
          const hour = editHourSelect.value;
          const minute = editMinuteSelect.value;

          if (!hour || !minute) {
            alert('Por favor selecciona hora y minutos');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          const time = `${hour}:${minute}`;
          const serviceName = editServiceInput.value.trim();
          const service = allServices.find(s => s.name === serviceName);

          if (!service) {
            alert('Por favor selecciona un servicio válido');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          // Obtener la fecha - primero del calendario, luego del dataset, luego del input
          let dateValue = editApptCalendar.getISODate();
          if (!dateValue) {
            dateValue = editDateInput.dataset.isoDate;
          }
          if (!dateValue) {
            // Intentar parsear del input (formato dd/mm/yyyy)
            const parts = editDateInput.value.split('/');
            if (parts.length === 3) {
              dateValue = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
          }

          console.log('📅 Fecha a enviar:', dateValue);
          console.log('📅 Calendario ISO:', editApptCalendar.getISODate());
          console.log('📅 Dataset ISO:', editDateInput.dataset.isoDate);
          console.log('📅 Input value:', editDateInput.value);

          if (!dateValue) {
            alert('Por favor selecciona una fecha');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          const body = {
            serviceId: service.id,
            serviceName: service.name,
            date: dateValue,
            time: time,
            durationMinutes: parseInt(service.durationMinutes)
          };

          console.log('📤 Enviando:', body);

          const res = await fetch(`/api/appointments/${editApptId.value}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });

          const json = await res.json();
          if (json.success) {
            alert('✅ Cita actualizada');
            editApptDialog.close();
            formEditAppt.reset();
            loadAppointments();
            renderMonthlyCalendar();
            loadMonthStats();
          } else {
            // Mostrar mensaje específico para conflictos de horario
            if (res.status === 409) {
              console.log('🔴 Conflicto detectado:', json);
              let msg = '⚠️ ' + json.error;
              if (json.debug) {
                msg += `\n\nDetalles:\n- Tu cita: ${json.debug.newTime}\n- Cita existente: ${json.debug.existingClient} (${json.debug.existingTime})\n- Status: ${json.debug.existingStatus}\n- ID: ${json.debug.existingId}`;
              }
              alert(msg);
            } else {
              alert('❌ Error: ' + json.error);
            }
          }
        } catch (e) {
          alert('Error de conexión');
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });
    }


    // ========== CUSTOM CALENDAR PICKER ==========
    /* =========================================================
       CUSTOM SEARCHABLE DROPDOWN CLASS
       ========================================================= */
    class CustomSearchableDropdown {
      constructor(inputId, dropdownId, onSelectCallback) {
        this.input = document.getElementById(inputId);
        this.dropdown = document.getElementById(dropdownId);

        if (!this.input || !this.dropdown) {
          console.error(`CustomSearchableDropdown: Elements not found - input: ${inputId}, dropdown: ${dropdownId}`);
          return;
        }

        this.wrapper = this.input.closest('.custom-select-wrapper');
        this.icon = this.wrapper ? this.wrapper.querySelector('.dropdown-toggle-icon') : null;

        if (!this.icon) {
          console.error(`CustomSearchableDropdown: Icon not found for ${inputId}`);
          return;
        }

        this.options = [];
        this.onSelectCallback = onSelectCallback;

        this.init();
      }

      init() {
        // Toggle on icon click
        this.icon.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggle();
        });

        // Open on input click
        this.input.addEventListener('click', (e) => {
          e.stopPropagation();
          console.log('[DROPDOWN] Input clicked, showing dropdown');
          this.show();
        });

        // Filter on input type
        this.input.addEventListener('input', () => {
          const query = this.input.value;
          console.log('[DROPDOWN] Input changed:', query);
          if (query.length === 0) {
            // Si está vacío, mostrar todas las opciones
            this.render(this.options);
            this.show();
          } else {
            // Si hay texto, filtrar
            this.filter(query);
            this.show();
          }
        });

        // Close on outside click
        document.addEventListener('click', (e) => {
          if (!this.wrapper.contains(e.target)) {
            this.hide();
          }
        });
      }

      setOptions(options) {
        this.options = options;
        this.render(options);
      }

      render(items) {
        console.log('[DROPDOWN] Renderizando', items.length, 'items');
        this.dropdown.innerHTML = '';
        if (items.length === 0) {
          this.dropdown.innerHTML = '<div class="dropdown-item" style="cursor:default;color:var(--muted);">No hay resultados</div>';
          return;
        }

        items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'dropdown-item';
          div.innerHTML = `
            <div>${item.label}</div>
            ${item.meta ? `<span class="item-meta">${item.meta}</span>` : ''}
          `;

          // Store data attributes
          Object.keys(item.data || {}).forEach(key => {
            div.dataset[key] = item.data[key];
          });

          div.addEventListener('click', (e) => {
            e.stopPropagation();
            this.select(item);
          });

          this.dropdown.appendChild(div);
        });
      }

      filter(query) {
        const lowerQuery = query.toLowerCase();
        const filtered = this.options.filter(item =>
          item.label.toLowerCase().includes(lowerQuery) ||
          (item.meta && item.meta.toLowerCase().includes(lowerQuery))
        );
        this.render(filtered);
      }

      show() {
        console.log('[DROPDOWN] Mostrando dropdown con', this.options.length, 'opciones');
        // If empty input, show all
        if (!this.input.value) {
          this.render(this.options);
        }
        this.dropdown.style.display = 'block';
        this.icon.textContent = '▲';
      }

      hide() {
        this.dropdown.style.display = 'none';
        this.icon.textContent = '▼';
      }

      toggle() {
        if (this.dropdown.style.display === 'block') {
          this.hide();
        } else {
          this.show();
        }
      }

      select(item) {
        this.input.value = item.value; // Use value for input

        // Trigger callback if provided
        if (this.onSelectCallback) {
          this.onSelectCallback(item);
        }

        // Trigger native change event for other listeners
        this.input.dispatchEvent(new Event('change', { bubbles: true }));
        this.input.dispatchEvent(new Event('input', { bubbles: true }));

        // Close dropdown AFTER all callbacks
        this.hide();
      }
    }

    // Global instances (Moved to top)
    // Payment dialog variables (Moved to top)

    /* =========================================================
       CUSTOM CALENDAR CLASS
       ========================================================= */
    class CustomCalendar {
      constructor(inputId, calendarId) {
        this.input = document.getElementById(inputId);
        this.calendar = document.getElementById(calendarId);
        this.currentDate = new Date();
        this.selectedDate = null;

        if (!this.input || !this.calendar) return;

        this.input.addEventListener('click', (e) => {
          e.stopPropagation();
          this.show();
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
          if (!this.calendar.contains(e.target) && e.target !== this.input) {
            this.hide();
          }
        });
      }

      show() {
        this.render();
        this.calendar.style.display = 'block';
      }

      hide() {
        this.calendar.style.display = 'none';
      }

      render() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const dayNames = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];

        // First day of month and total days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        let html = `
          <div class="calendar-header">
            <button class="calendar-nav-btn" data-action="prev"><i class="fas fa-chevron-left"></i></button>
            <div class="calendar-month-year">${monthNames[month]} ${year}</div>
            <button class="calendar-nav-btn" data-action="next"><i class="fas fa-chevron-right"></i></button>
          </div>
          <div class="calendar-grid">
        `;

        // Day headers
        dayNames.forEach(day => {
          html += `<div class="calendar-day-header">${day}</div>`;
        });

        // Empty cells before first day
        for (let i = 0; i < firstDay; i++) {
          html += `<div class="calendar-day empty"></div>`;
        }

        // Days of month
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          // Usar formato local YYYY-MM-DD para evitar problemas de timezone
          const y = date.getFullYear();
          const m = String(date.getMonth() + 1).padStart(2, '0');
          const d = String(date.getDate()).padStart(2, '0');
          const dateStr = `${y}-${m}-${d}`;
          const isToday = date.toDateString() === today.toDateString();
          const isSelected = this.selectedDate && dateStr === this.selectedDate;

          let classes = ['calendar-day'];
          if (isToday) classes.push('today');
          if (isSelected) classes.push('selected');

          html += `<div class="${classes.join(' ')}" data-date="${dateStr}">${day}</div>`;
        }

        html += `</div>`;
        this.calendar.innerHTML = html;

        // Event listeners
        this.calendar.querySelectorAll('[data-action="prev"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.currentDate.setMonth(this.currentDate.getMonth() - 1);
            this.render();
          });
        });

        this.calendar.querySelectorAll('[data-action="next"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.currentDate.setMonth(this.currentDate.getMonth() + 1);
            this.render();
          });
        });

        this.calendar.querySelectorAll('.calendar-day:not(.empty)').forEach(dayEl => {
          dayEl.addEventListener('click', (e) => {
            e.stopPropagation();
            const dateStr = dayEl.dataset.date;
            this.selectDate(dateStr);
          });
        });
      }

      selectDate(dateStr) {
        this.selectedDate = dateStr;
        const date = new Date(dateStr + 'T12:00:00');
        const day = date.getDate();
        const month = date.getMonth() + 1;
        const year = date.getFullYear();
        this.input.value = `${day}/${month}/${year}`;
        this.input.dataset.isoDate = dateStr;
        this.hide();
      }

      getISODate() {
        return this.input.dataset.isoDate || '';
      }
    }

    // Initialize calendars
    const newApptCalendar = new CustomCalendar('new-appt-date', 'new-appt-calendar');
    const editApptCalendar = new CustomCalendar('edit-appt-date', 'edit-appt-calendar');

    // ========== EVENT LISTENERS ==========

    // Navegación semanal
    // Navegación del calendario (Mes/Semana/Día)
    if (btnPrevMonth) {
      btnPrevMonth.addEventListener('click', () => {
        if (currentView === 'month') {
          currentMonth.setMonth(currentMonth.getMonth() - 1);
        } else if (currentView === 'week') {
          selectedDate.setDate(selectedDate.getDate() - 7);
          currentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
        } else if (currentView === 'day') {
          selectedDate.setDate(selectedDate.getDate() - 1);
          currentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
        }
        loadMonthAppointments(); // Fetch data then render
      });
    }

    if (btnNextMonth) {
      btnNextMonth.addEventListener('click', () => {
        if (currentView === 'month') {
          currentMonth.setMonth(currentMonth.getMonth() + 1);
        } else if (currentView === 'week') {
          selectedDate.setDate(selectedDate.getDate() + 7);
          currentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
        } else if (currentView === 'day') {
          selectedDate.setDate(selectedDate.getDate() + 1);
          currentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
        }
        loadMonthAppointments(); // Fetch data then render
      });
    }

    if (btnToday) {
      btnToday.addEventListener('click', () => {
        const today = new Date();
        currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        selectedDate = new Date();
        selectedDate.setHours(0, 0, 0, 0);
        loadMonthAppointments(); // Fetch data then render
        loadAppointments();
        updateSelectedDateLabel();
      });
    }

    if (btnRefreshAppts) {
      btnRefreshAppts.addEventListener('click', () => {
        loadAppointments();
        renderMonthlyCalendar();
      });
    }

    // Botones de vista del calendario
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // Remover active de todos
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        // Agregar active al clickeado
        btn.classList.add('active');

        const view = btn.dataset.view;
        console.log('Vista seleccionada:', view);

        currentView = view;
        renderCalendar();
      });
    });

    // Función global para abrir modal de nueva cita (usada por quick-action y otros)
    window.openNewAppointmentModal = function () {
      loadServices();
      loadClients();
      generateHourMinuteOptions();

      // Establecer fecha de hoy por defecto
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      const dateInput = document.getElementById('new-appt-date');
      if (dateInput) dateInput.value = dateStr;

      // Limpiar campos
      const clientInput = document.getElementById('new-appt-client-select');
      const phoneInput = document.getElementById('new-appt-phone');
      const serviceInput = document.getElementById('new-appt-service');
      const priceInput = document.getElementById('new-appt-price');

      if (clientInput) clientInput.value = '';
      if (phoneInput) phoneInput.value = '';
      if (serviceInput) serviceInput.value = '';
      if (priceInput) priceInput.value = '';

      // Limpiar historial
      const historyPanelEl = document.getElementById('client-history-panel');
      const historyContentEl = document.getElementById('history-content');
      const historyHeaderEl = document.getElementById('toggle-history');

      if (historyPanelEl) historyPanelEl.classList.add('hidden');
      if (historyContentEl) historyContentEl.style.display = 'none';
      if (historyHeaderEl) historyHeaderEl.classList.remove('expanded');

      newApptDialog.showModal();
    };

    // Modal
    if (btnNewAppt) {
      btnNewAppt.addEventListener('click', () => {
        loadServices();
        loadClients();
        generateHourMinuteOptions();
        newApptDialog.showModal();
        document.getElementById('new-appt-date').value = toLocalDateString(selectedDate);

        // Limpiar historial
        if (historyPanel) historyPanel.classList.add('hidden');
        if (historyContent) historyContent.style.display = 'none';
        if (historyHeader) historyHeader.classList.remove('expanded');
      });
    }

    if (btnCancelAppt) {
      btnCancelAppt.addEventListener('click', () => newApptDialog.close());
    }

    // Cliente input - auto-llenar teléfono cuando se selecciona
    if (clientSelect) {
      clientSelect.addEventListener('input', function () {
        const clientName = this.value.trim();
        const client = allClients.find(c => c.name === clientName);
        if (client && phoneInput) {
          phoneInput.value = client.phone || '';
          phoneInput.readOnly = true;
        } else {
          if (!phoneInput.value || phoneInput.readOnly) {
            phoneInput.value = '';
          }
          phoneInput.readOnly = false;
        }
      });
    }

    // Servicio input - auto-llenar precio y calcular hora fin
    if (serviceSelect) {
      serviceSelect.addEventListener('input', function () {
        const serviceName = this.value.trim();
        const service = allServices.find(s => s.name === serviceName);
        if (service && priceInput) {
          priceInput.value = service.price;
          calculateEndTime();
        }
      });
    }

    // Hora select - calcular hora fin
    if (hourSelect) {
      hourSelect.addEventListener('change', calculateEndTime);
    }

    // Minuto select - calcular hora fin
    if (minuteSelect) {
      minuteSelect.addEventListener('change', calculateEndTime);
    }

    function calculateEndTime() {
      if (!hourSelect || !minuteSelect || !endTimeInput) return;

      const hour = hourSelect.value;
      const minute = minuteSelect.value;

      if (!hour || !minute) return;

      // Calcular duración total
      let totalDuration = 0;

      // Sumar duración de servicios en la lista
      if (selectedServices.length > 0) {
        totalDuration = selectedServices.reduce((sum, s) => sum + (parseInt(s.durationMinutes) || 60), 0);
      }

      // También sumar el servicio del campo principal si existe y no está vacío
      const serviceName = serviceSelect ? serviceSelect.value.trim() : '';
      if (serviceName) {
        const service = allServices.find(s => s.name === serviceName);
        if (service) {
          // Solo agregar si no está ya en la lista de servicios seleccionados
          const alreadyInList = selectedServices.find(s => s.id === service.id);
          if (!alreadyInList) {
            totalDuration += parseInt(service.durationMinutes) || 60;
          }
        }
      }

      // Si no hay ningún servicio, usar default de 60 min
      if (totalDuration === 0) {
        totalDuration = 60;
      }

      const startDate = new Date();
      startDate.setHours(parseInt(hour), parseInt(minute), 0);

      const endDate = new Date(startDate.getTime() + totalDuration * 60000);

      const endHours = endDate.getHours();
      const endMinutes = endDate.getMinutes();
      const displayHour = endHours > 12 ? endHours - 12 : (endHours === 0 ? 12 : endHours);
      const period = endHours >= 12 ? 'PM' : 'AM';

      endTimeInput.value = `${displayHour}:${String(endMinutes).padStart(2, '0')} ${period}`;

      console.log('📊 Hora fin calculada:', {
        serviciosEnLista: selectedServices.length,
        servicioEnCampo: serviceName,
        duracionTotal: totalDuration,
        horaFin: endTimeInput.value
      });
    }


    // Toggle nuevo cliente form
    if (btnToggleNewClient) {
      btnToggleNewClient.addEventListener('click', () => {
        const isHidden = newClientForm.style.display === 'none';
        newClientForm.style.display = isHidden ? 'block' : 'none';
        btnToggleNewClient.textContent = isHidden ? '- Cancelar' : '+ Registrar nuevo cliente';
      });
    }

    // Guardar nuevo cliente
    if (btnSaveNewClient) {
      btnSaveNewClient.addEventListener('click', async () => {
        const name = document.getElementById('new-client-name').value.trim();
        const phone = document.getElementById('new-client-phone').value.trim();

        if (!name || !phone) {
          alert('Por favor completa nombre y teléfono');
          return;
        }

        try {
          let res;
          try {
            res = await fetch('/api/clients', {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, phone })
            });
          } catch (netErr) {
            alert('⚠️ Error de Red: No se pudo conectar con el servidor.');
            console.error(netErr);
            return;
          }

          let json;
          const text = await res.text();

          try {
            json = JSON.parse(text);
          } catch (e) {
            console.error('Respuesta no JSON:', text);
            alert(`⚠️ Error del Servidor (${res.status}): ${text.substring(0, 100)}`);
            return;
          }

          if (!res.ok) {
            alert(`❌ Error (${res.status}): ${json.error || json.message || 'Error desconocido'}`);
            return;
          }

          if (json.success) {
            alert('✅ Cliente guardado exitosamente');
            await loadClients();

            // Seleccionar el nuevo cliente en el dropdown de búsqueda
            const newClientId = json.client?.id || '';
            const newClientInput = document.getElementById('new-appt-client-select');
            if (newClientInput) {
              newClientInput.value = name;  // Usar el nombre ingresado
            }
            phoneInput.value = phone;
            phoneInput.readOnly = true;

            // Ocultar form
            newClientForm.style.display = 'none';
            btnToggleNewClient.textContent = '+ Registrar nuevo cliente';

            // Limpiar campos
            document.getElementById('new-client-name').value = '';
            document.getElementById('new-client-phone').value = '';
          } else {
            alert('❌ Error: ' + (json.error || 'No se pudo guardar'));
          }
        } catch (e) {
          console.error(e);
          alert('⚠️ Error Inesperado: ' + e.message);
        }
      });
    }

    // ========== MÚLTIPLES SERVICIOS ==========
    let selectedServices = [];

    const btnAddService = document.getElementById('btn-add-service');
    const selectedServicesList = document.getElementById('selected-services-list');
    const servicesListContainer = document.getElementById('services-list-container');

    function addServiceToList() {
      const serviceName = serviceSelect.value.trim();
      const price = parseFloat(priceInput.value) || 0;

      if (!serviceName) {
        alert('Por favor selecciona un servicio');
        return;
      }

      const service = allServices.find(s => s.name === serviceName);
      if (!service) {
        alert('Por favor selecciona un servicio válido');
        return;
      }

      // Verificar si ya está agregado
      if (selectedServices.find(s => s.id === service.id)) {
        alert('Este servicio ya está agregado');
        return;
      }

      selectedServices.push({
        id: service.id,
        name: service.name,
        price: price,
        durationMinutes: service.durationMinutes
      });

      renderSelectedServices();

      // Limpiar campos
      serviceSelect.value = '';
      priceInput.value = '';

      // Recalcular hora fin
      calculateEndTime();
    }

    function removeServiceFromList(serviceId) {
      selectedServices = selectedServices.filter(s => s.id !== serviceId);
      renderSelectedServices();

      // Recalcular hora fin
      calculateEndTime();
    }

    function renderSelectedServices() {
      if (selectedServices.length === 0) {
        selectedServicesList.style.display = 'none';
        return;
      }

      selectedServicesList.style.display = 'block';
      servicesListContainer.innerHTML = selectedServices.map(service => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:8px;">
          <div>
            <div style="font-weight:600;color:var(--ink);">${service.name}</div>
            <div style="font-size:12px;color:var(--muted);">$${service.price} • ${service.durationMinutes} min</div>
          </div>
          <button type="button" onclick="removeServiceFromList('${service.id}')" class="btn small ghost" style="color:#ef4444;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `).join('');

      // Mostrar duración total y precio total (incluyendo servicio del campo principal)
      let totalDuration = selectedServices.reduce((sum, s) => sum + (parseInt(s.durationMinutes) || 60), 0);
      let totalPrice = selectedServices.reduce((sum, s) => sum + (parseFloat(s.price) || 0), 0);
      let extraServiceNote = '';

      // Verificar si hay un servicio en el campo principal que no está en la lista
      const serviceName = serviceSelect ? serviceSelect.value.trim() : '';
      if (serviceName) {
        const service = allServices.find(s => s.name === serviceName);
        if (service && !selectedServices.find(s => s.id === service.id)) {
          const extraDuration = parseInt(service.durationMinutes) || 60;
          const extraPrice = parseFloat(priceInput.value) || 0;
          totalDuration += extraDuration;
          totalPrice += extraPrice;
          extraServiceNote = `<div style="font-size:11px;color:var(--muted);margin-top:4px;">+ ${serviceName} (${extraDuration} min)</div>`;
        }
      }

      servicesListContainer.innerHTML += `
        <div style="padding:10px;background:rgba(140,150,104,0.2);border-radius:8px;margin-top:8px;border:1px solid rgba(140,150,104,0.3);">
          <div style="display:flex;justify-content:space-between;">
            <div style="font-weight:600;color:var(--venus-soft);">
              <i class="fas fa-clock"></i> Total: ${totalDuration} min
            </div>
            <div style="font-weight:600;color:var(--venus-soft);">
              $${totalPrice.toFixed(0)}
            </div>
          </div>
          ${extraServiceNote}
        </div>
      `;
    }

    window.removeServiceFromList = removeServiceFromList;

    if (btnAddService) {
      btnAddService.addEventListener('click', addServiceToList);
    }

    // Submit form
    if (formNewAppt) {
      formNewAppt.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = formNewAppt.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Agendando...';

        try {
          // Construir hora desde los selectores separados
          const hour = hourSelect.value;
          const minute = minuteSelect.value;

          if (!hour || !minute) {
            alert('Por favor selecciona hora y minutos');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          const time = `${hour}:${minute}`;
          const isoDate = newApptCalendar.getISODate();

          if (!isoDate) {
            alert('Por favor selecciona una fecha del calendario');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          const clientName = clientSelect.value.trim();
          const clientPhone = phoneInput.value.trim();
          const sendWhatsAppConfirmation = document.getElementById('check-whatsapp-confirm').checked;
          const sendWhatsApp24h = document.getElementById('check-whatsapp-24h').checked;
          const sendWhatsApp2h = document.getElementById('check-whatsapp-2h').checked;
          const giftCardCode = document.getElementById('new-appt-giftcard').value.trim() || null;

          // Determinar qué servicios agendar
          let servicesToBook = [];

          // Primero agregar el servicio del campo principal si existe
          const mainServiceName = serviceSelect.value.trim();
          if (mainServiceName) {
            const mainService = allServices.find(s => s.name === mainServiceName);
            if (mainService) {
              // Solo agregar si no está ya en la lista de servicios seleccionados
              const alreadyInList = selectedServices.find(s => s.id === mainService.id);
              if (!alreadyInList) {
                servicesToBook.push({
                  id: mainService.id,
                  name: mainService.name,
                  price: parseFloat(priceInput.value) || 0,
                  durationMinutes: parseInt(mainService.durationMinutes)
                });
              }
            }
          }

          // Luego agregar los servicios de la lista
          if (selectedServices.length > 0) {
            servicesToBook = [...servicesToBook, ...selectedServices];
          }

          // Validar que hay al menos un servicio
          if (servicesToBook.length === 0) {
            alert('Por favor selecciona al menos un servicio');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          console.log('🕐 [APPOINTMENT] Creando citas para', servicesToBook.length, 'servicios:', servicesToBook.map(s => s.name));

          // Crear citas para cada servicio
          let currentTime = time;
          const createdAppointments = [];

          for (let i = 0; i < servicesToBook.length; i++) {
            const service = servicesToBook[i];

            const payload = {
              name: clientName,
              phone: clientPhone,
              serviceId: service.id,
              serviceName: service.name,
              date: isoDate,
              time: currentTime,
              durationMinutes: service.durationMinutes,
              sendWhatsAppConfirmation: false, // No enviar WhatsApp individual, lo enviamos después con todos los servicios
              sendWhatsApp24h: sendWhatsApp24h,
              sendWhatsApp2h: sendWhatsApp2h,
              giftCardCode: i === 0 ? giftCardCode : null, // Solo aplicar gift card a la primera
              isMultiService: servicesToBook.length > 1,
              multiServiceIndex: i,
              multiServiceTotal: servicesToBook.length
            };

            console.log(`🕐 [APPOINTMENT] Creando cita ${i + 1}/${servicesToBook.length}:`, service.name);

            const res = await fetch('/api/appointments', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            const json = await res.json();

            if (!json.success) {
              if (res.status === 409) {
                alert(`⚠️ Error en ${service.name}: ${json.error}`);
              } else {
                alert(`❌ Error en ${service.name}: ${json.error}`);
              }
              btn.disabled = false;
              btn.textContent = originalText;
              return;
            }

            createdAppointments.push({
              id: json.appointmentId,
              serviceName: service.name
            });

            // Calcular siguiente hora (sumar duración del servicio actual)
            const [h, m] = currentTime.split(':').map(Number);
            const totalMinutes = h * 60 + m + service.durationMinutes;
            const nextHour = Math.floor(totalMinutes / 60);
            const nextMinute = totalMinutes % 60;
            currentTime = `${String(nextHour).padStart(2, '0')}:${String(nextMinute).padStart(2, '0')}`;
          }

          // Enviar UN solo WhatsApp con todos los servicios
          if (sendWhatsAppConfirmation && createdAppointments.length > 0) {
            const serviceNames = servicesToBook.map(s => s.name);
            console.log('📱 [APPOINTMENT] Enviando WhatsApp con servicios:', serviceNames);

            try {
              const whatsappRes = await fetch('/api/whatsapp/confirmation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  clientName,
                  clientPhone,
                  services: serviceNames,
                  date: isoDate,
                  time: time
                })
              });

              const whatsappJson = await whatsappRes.json();
              if (whatsappJson.success) {
                console.log('✅ [APPOINTMENT] WhatsApp enviado:', whatsappJson.messageSid);
              } else {
                console.error('❌ [APPOINTMENT] Error WhatsApp:', whatsappJson.error);
              }
            } catch (whatsappError) {
              console.error('❌ [APPOINTMENT] Error enviando WhatsApp:', whatsappError);
            }
          }

          alert(`✅ ${servicesToBook.length === 1 ? 'Cita agendada' : servicesToBook.length + ' citas agendadas'}`);
          newApptDialog.close();
          formNewAppt.reset();
          selectedServices = [];
          renderSelectedServices();
          loadAppointments();
          renderMonthlyCalendar();
        } catch (e) {
          alert('Error de conexión');
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });
    }

    // Inicializar
    renderMonthlyCalendar();
    updateSelectedDateLabel();
    loadMonthStats();

    // Auto-load when tab is shown
    window.addEventListener('hashchange', () => {
      if (location.hash === '#appointments') {
        renderMonthlyCalendar();
        loadAppointments();
        updateSelectedDateLabel();
        loadMonthStats();
      }
    });

    if (location.hash === '#appointments') {
      renderMonthlyCalendar();
      loadAppointments();
      updateSelectedDateLabel();
      loadMonthStats();
    }

    // ========== GESTIÓN DE SERVICIOS ==========
    const servicesTbody = document.getElementById('services-tbody');
    const modalService = document.getElementById('modal-service');
    const formService = document.getElementById('form-service');
    const btnNewService = document.getElementById('btn-new-service');
    const closeModalService = document.getElementById('close-modal-service');
    const btnCancelService = document.getElementById('cancel-service');

    async function loadServicesTable() {
      try {
        console.log('[SERVICES] Iniciando carga de servicios...');

        // Verificar que el elemento existe
        if (!servicesTbody) {
          console.error('[SERVICES] ERROR: services-tbody no encontrado en el DOM');
          return;
        }

        servicesTbody.innerHTML = '<tr><td colspan="5" class="muted" style="text-align:center;padding:20px;visibility:visible !important;">Cargando...</td></tr>';

        const res = await fetch('/api/services', { credentials: 'include' });
        console.log('[SERVICES] Respuesta recibida:', res.status);

        const json = await res.json();
        console.log('[SERVICES] Datos parseados:', json);

        if (json.success) {
          const services = json.data || [];
          console.log(`[SERVICES] ${services.length} servicios encontrados`);

          if (services.length === 0) {
            servicesTbody.innerHTML = '<tr><td colspan="5" class="muted" style="text-align:center;padding:40px;visibility:visible !important;background:#f5f5f5;">No hay servicios registrados. Haz clic en "Nuevo Servicio" para agregar uno.</td></tr>';
            return;
          }

          // Store services globally for search
          window.allServicesData = services;
          renderServicesTable(services);
          console.log('[SERVICES] Tabla renderizada correctamente');
        } else {
          console.error('[SERVICES] Error en respuesta:', json.error);
          servicesTbody.innerHTML = '<tr><td colspan="5" style="color:#ef4444;text-align:center;padding:40px;visibility:visible !important;background:#fee;">❌ Error: ' + (json.error || 'Desconocido') + '</td></tr>';
        }
      } catch (error) {
        console.error('[SERVICES] Error fatal:', error);
        servicesTbody.innerHTML = '<tr><td colspan="5" style="color:#ef4444;text-align:center;padding:40px;visibility:visible !important;background:#fee;">❌ Error al cargar servicios: ' + error.message + '</td></tr>';
      }
    }

    // Función para renderizar la tabla de servicios
    function renderServicesTable(services) {
      console.log('[RENDER] Renderizando tabla con', services.length, 'servicios');

      if (!servicesTbody) {
        console.error('[RENDER] ERROR: servicesTbody no existe');
        return;
      }

      if (services.length === 0) {
        servicesTbody.innerHTML = '<tr><td colspan="5" class="muted" style="text-align:center;padding:40px;visibility:visible !important;background:#f5f5f5;">No se encontraron servicios</td></tr>';
        return;
      }

      const html = services.map(s => `
        <tr>
          <td data-label="Nombre">${s.name}</td>
          <td data-label="Categoría">
            <span style="
              display:inline-block;
              padding:4px 10px;
              border-radius:6px;
              font-size:11px;
              font-weight:500;
              background:var(--venus-light);
              color:var(--venus);
            ">${s.category || 'Sin categoría'}</span>
          </td>
          <td data-label="Duración">${s.durationMinutes} min</td>
          <td data-label="Precio">$${s.price}</td>
          <td data-label="Acciones">
            <div class="actions">
              <button class="btn small ghost" onclick="editService('${s.id}')" title="Editar">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn small ghost" style="color:#ef4444;border-color:#ef4444;" onclick="deleteService('${s.id}')" title="Eliminar">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');

      console.log('[RENDER] HTML generado, longitud:', html.length);
      servicesTbody.innerHTML = html;
      console.log('[RENDER] HTML asignado al tbody');
    }

    // Auto-categorizar servicios según palabras clave
    async function autoCategorizarServicios() {
      if (!confirm('¿Quieres organizar automáticamente todos los servicios en categorías?\n\n• Depilación\n• Faciales\n• Masajes\n• Corporales\n• Diagnóstico')) {
        return;
      }

      try {
        console.log('[AUTO-CAT] Cargando servicios...');
        const res = await fetch('/api/services');
        const json = await res.json();

        if (!json.success || !json.data) {
          alert('❌ Error al cargar servicios');
          return;
        }

        const services = json.data;
        let updated = 0;
        let errors = 0;

        console.log(`[AUTO-CAT] Procesando ${services.length} servicios...`);

        for (const service of services) {
          const nameLower = service.name.toLowerCase();
          let newCategory = 'Otros';

          // Determinar categoría según el nombre
          if (nameLower.includes('depil')) {
            newCategory = 'Depilación';
          } else if (nameLower.includes('facial') || nameLower.includes('limpieza') || nameLower.includes('colágeno') || nameLower.includes('anti-') || nameLower.includes('oxigenante') || nameLower.includes('detox') || nameLower.includes('vitamina')) {
            newCategory = 'Faciales';
          } else if (nameLower.includes('masaje') || nameLower.includes('drenaje')) {
            newCategory = 'Masajes';
          } else if (nameLower.includes('hifu') || nameLower.includes('dermapen') || nameLower.includes('aparatolog') || nameLower.includes('pqt') || nameLower.includes('despigmant') || nameLower.includes('radiofrec')) {
            newCategory = 'Corporales';
          } else if (nameLower.includes('seguimiento') || nameLower.includes('analyzer') || nameLower.includes('consulta') || nameLower.includes('diagnóstico')) {
            newCategory = 'Diagnóstico';
          }

          // Solo actualizar si cambió la categoría
          if (service.category !== newCategory) {
            console.log(`[AUTO-CAT] ${service.name}: "${service.category || 'Sin categoría'}" → "${newCategory}"`);

            try {
              const updateRes = await fetch(`/api/services/${service.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  name: service.name,
                  category: newCategory,
                  durationMinutes: service.durationMinutes,
                  price: service.price
                }),
                credentials: 'include'
              });

              const updateJson = await updateRes.json();
              if (updateJson.success) {
                updated++;
              } else {
                errors++;
                console.error(`[AUTO-CAT] Error actualizando ${service.name}:`, updateJson.error);
              }
            } catch (error) {
              errors++;
              console.error(`[AUTO-CAT] Error en ${service.name}:`, error);
            }
          }
        }

        console.log(`[AUTO-CAT] Completado: ${updated} actualizados, ${errors} errores`);
        alert(`✅ Organización completa!\n\n${updated} servicios reorganizados\n${errors} errores`);

        // Recargar la tabla
        await loadServicesTable();
      } catch (error) {
        console.error('[AUTO-CAT] Error general:', error);
        alert('❌ Error al organizar servicios');
      }
    }

    // Abrir modal (Nuevo o Editar)
    window.editService = async (id) => {
      try {
        // Buscar servicio en la lista actual (o hacer fetch)
        const res = await fetch('/api/services');
        const json = await res.json();
        const service = json.data.find(s => s.id === id);

        if (service) {
          document.getElementById('service-id').value = service.id;
          document.getElementById('service-name').value = service.name;
          document.getElementById('service-duration').value = service.durationMinutes;
          document.getElementById('service-price').value = service.price;
          // description es string en Prisma, no array
          document.getElementById('service-description').value = service.description || '';
          document.getElementById('service-category').value = service.category || '';
          document.getElementById('service-discount').value = service.discount || '';
          document.getElementById('modal-service-title').textContent = 'Editar Servicio';
          modalService.classList.remove('hidden');
        }
      } catch (e) { console.error(e); }
    };

    if (btnNewService) {
      btnNewService.addEventListener('click', () => {
        document.getElementById('form-service').reset();
        document.getElementById('service-id').value = '';
        document.getElementById('modal-service-title').textContent = 'Nuevo Servicio';
        modalService.classList.remove('hidden');
      });
    }

    // Cerrar modal
    const closeServiceModalFn = () => modalService.classList.add('hidden');
    if (closeModalService) closeModalService.addEventListener('click', closeServiceModalFn);
    if (btnCancelService) btnCancelService.addEventListener('click', closeServiceModalFn);

    // Guardar servicio
    if (formService) {
      formService.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('service-id').value;
        const data = {
          name: document.getElementById('service-name').value,
          durationMinutes: parseInt(document.getElementById('service-duration').value),
          price: parseFloat(document.getElementById('service-price').value),
          category: document.getElementById('service-category').value || 'Otros',
          description: document.getElementById('service-description').value.split('\n').map(l => l.trim()).filter(l => l.length > 0),
          discount: document.getElementById('service-discount').value
        };

        try {
          const url = id ? `/api/services/${id}` : '/api/services';
          const method = id ? 'PUT' : 'POST';

          const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const json = await res.json();
          if (json.success) {
            closeServiceModalFn();
            loadServicesTable();
            // Recargar dropdowns de citas también
            loadServices();
          } else {
            alert('Error al guardar: ' + json.error);
          }
        } catch (error) {
          console.error(error);
          alert('Error de conexión');
        }
      });
    }

    // Eliminar servicio
    window.deleteService = async (id) => {
      if (!confirm('¿Estás seguro de eliminar este servicio?')) return;

      try {
        const res = await fetch(`/api/services/${id}`, { method: 'DELETE' });
        const json = await res.json();
        if (json.success) {
          loadServicesTable();
          loadServices(); // Recargar dropdowns
        } else {
          alert('Error al eliminar: ' + json.error);
        }
      } catch (error) {
        console.error(error);
        alert('Error de conexión');
      }
    };

    // Búsqueda de servicios
    const searchServicesInput = document.getElementById('search-services');
    if (searchServicesInput) {
      searchServicesInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();

        if (!window.allServicesData) return;

        if (searchTerm === '') {
          renderServicesTable(window.allServicesData);
        } else {
          const filtered = window.allServicesData.filter(s =>
            s.name.toLowerCase().includes(searchTerm) ||
            (s.category && s.category.toLowerCase().includes(searchTerm))
          );
          renderServicesTable(filtered);
        }
      });
    }

    /* =========================================================
       CATÁLOGO: PRODUCTOS
       ========================================================= */

    // Variables globales para productos
    let allProducts = [];
    let currentProductFilter = 'all';

    // Cambiar entre tabs
    function switchCatalogTab(tab) {
      document.querySelectorAll('.tabs-header .tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));

      if (tab === 'services') {
        document.getElementById('btn-tab-services').classList.add('active');
        document.getElementById('panel-services').classList.add('active');
        loadServicesTable();
      } else {
        document.getElementById('btn-tab-products').classList.add('active');
        document.getElementById('panel-products').classList.add('active');
        loadProductsTable();
      }
    }

    // Hacer función global
    window.switchCatalogTab = switchCatalogTab;

    // Cargar servicios al abrir la pestaña de Catálogo
    document.querySelectorAll('.nav a[data-tab="catalog"], .nav a[data-tab="services"]').forEach(link => {
      link.addEventListener('click', () => {
        // Dar tiempo para que se muestre la pestaña
        setTimeout(() => {
          // Verificar qué sub-tab está activo
          const servicesTabActive = document.getElementById('btn-tab-services')?.classList.contains('active');
          if (servicesTabActive) {
            loadServicesTable();
          }
        }, 100);
      });
    });

    /* ========== PRODUCTOS ========== */

    // Cargar productos
    async function loadProductsTable() {
      const tbody = document.getElementById('products-tbody');
      tbody.innerHTML = '<tr><td colspan="5" class="muted" style="text-align:center;padding:20px;">Cargando...</td></tr>';

      try {
        const res = await fetch('/api/products', { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          allProducts = json.data || [];
          updateProductsCount();
          updateProductStats();
          renderProductsTable(allProducts);
        }
      } catch (error) {
        console.error('Error loading products:', error);
        tbody.innerHTML = '<tr><td colspan="5" style="color:#ef4444;text-align:center;">Error al cargar</td></tr>';
      }
    }

    // Renderizar tabla de productos
    function renderProductsTable(products) {
      const tbody = document.getElementById('products-tbody');

      // Filtrar por categoría
      let filtered = products;
      if (currentProductFilter !== 'all') {
        filtered = products.filter(p => p.category === currentProductFilter);
      }

      // Filtrar por búsqueda
      const searchTerm = document.getElementById('search-products')?.value?.toLowerCase() || '';
      if (searchTerm) {
        filtered = filtered.filter(p =>
          p.name.toLowerCase().includes(searchTerm) ||
          (p.description && p.description.toLowerCase().includes(searchTerm))
        );
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="muted" style="text-align:center;padding:20px;">No hay productos</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(p => {
        const stockClass = p.stock <= 0 ? 'stock-out' : p.stock <= (p.minStock || 5) ? 'stock-low' : 'stock-ok';
        const stockWarning = p.stock <= (p.minStock || 5) && p.stock > 0 ? ' ⚠️' : '';

        return `
          <tr>
            <td>
              <div class="product-cell">
                <div class="product-img"><i class="fas fa-box"></i></div>
                <div>
                  <div style="font-weight:500;">${p.name}</div>
                  ${p.presentation ? `<div class="item-category">${p.presentation}</div>` : ''}
                </div>
              </div>
            </td>
            <td style="text-transform:capitalize;">${p.category}</td>
            <td style="font-weight:600;color:var(--venus-soft);">$${p.price}</td>
            <td><span class="stock ${stockClass}">${p.stock} uds${stockWarning}</span></td>
            <td>
              <div class="actions" style="display:flex;gap:6px;">
                <button class="btn small ghost" onclick="editProduct('${p.id}')">Editar</button>
                <button class="btn small ghost" style="color:#ef4444;" onclick="deleteProduct('${p.id}')">Eliminar</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Actualizar contadores
    function updateProductsCount() {
      document.getElementById('products-count').textContent = allProducts.length;
      document.getElementById('services-count').textContent = window.allServicesData?.length || 0;
    }

    // Actualizar estadísticas
    function updateProductStats() {
      const total = allProducts.length;
      const value = allProducts.reduce((sum, p) => sum + (p.price * p.stock), 0);
      const lowStock = allProducts.filter(p => p.stock <= (p.minStock || 5) && p.stock > 0).length;

      document.getElementById('stat-products-total').textContent = total;
      document.getElementById('stat-products-value').textContent = '$' + value.toLocaleString();
      document.getElementById('stat-products-low').textContent = lowStock;
    }

    // Filtrar por categoría
    function filterProducts(category) {
      currentProductFilter = category;

      document.querySelectorAll('.filter-chips .chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.category === category);
      });

      renderProductsTable(allProducts);
    }
    window.filterProducts = filterProducts;

    // Búsqueda de productos
    document.getElementById('search-products')?.addEventListener('input', () => {
      renderProductsTable(allProducts);
    });

    // Modal de producto
    const modalProduct = document.getElementById('modal-product');
    const formProduct = document.getElementById('form-product');

    document.getElementById('btn-new-product')?.addEventListener('click', () => {
      document.getElementById('form-product').reset();
      document.getElementById('product-id').value = '';
      document.getElementById('modal-product-title').innerHTML = '<i class="fas fa-shopping-bag"></i> Nuevo Producto';
      modalProduct.classList.remove('hidden');
    });

    document.getElementById('close-modal-product')?.addEventListener('click', () => {
      modalProduct.classList.add('hidden');
    });

    document.getElementById('cancel-product')?.addEventListener('click', () => {
      modalProduct.classList.add('hidden');
    });

    // Editar producto
    window.editProduct = async (id) => {
      const product = allProducts.find(p => p.id === id);
      if (!product) return;

      document.getElementById('product-id').value = product.id;
      document.getElementById('product-name').value = product.name;
      document.getElementById('product-category').value = product.category;
      document.getElementById('product-presentation').value = product.presentation || '';
      document.getElementById('product-price').value = product.price;
      document.getElementById('product-cost').value = product.cost || '';
      document.getElementById('product-stock').value = product.stock;
      document.getElementById('product-min-stock').value = product.minStock || 5;
      document.getElementById('product-description').value = product.description || '';
      document.getElementById('modal-product-title').innerHTML = '<i class="fas fa-edit"></i> Editar Producto';

      modalProduct.classList.remove('hidden');
    };

    // Eliminar producto
    window.deleteProduct = async (id) => {
      if (!confirm('¿Eliminar este producto?')) return;

      try {
        const res = await fetch(`/api/products/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        const json = await res.json();

        if (json.success) {
          loadProductsTable();
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        alert('Error de conexión');
      }
    };

    // Guardar producto
    formProduct?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('product-id').value;

      // Robust number parsing
      const priceVal = parseFloat(document.getElementById('product-price').value);
      const costVal = parseFloat(document.getElementById('product-cost').value);
      const stockVal = parseInt(document.getElementById('product-stock').value, 10);
      const minStockVal = parseInt(document.getElementById('product-min-stock').value, 10);

      const data = {
        name: document.getElementById('product-name').value,
        category: document.getElementById('product-category').value,
        presentation: document.getElementById('product-presentation').value,
        price: isNaN(priceVal) ? 0 : priceVal,
        cost: isNaN(costVal) ? null : costVal,
        stock: isNaN(stockVal) ? 0 : stockVal,
        minStock: isNaN(minStockVal) ? 5 : minStockVal,
        description: document.getElementById('product-description').value
      };

      const submitBtn = formProduct.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;

      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

        const url = id ? `/api/products/${id}` : '/api/products';
        const method = id ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });

        const json = await res.json();

        if (json.success) {
          modalProduct.classList.add('hidden');
          loadProductsTable();
          // Optional: Show success toast if available, or just reload grid which tells usage
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        console.error(error);
        alert('Error de conexión');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      }
    });

    /* =========================================================
       GIFT CARDS MEJORADO
       ========================================================= */

    let allGiftCards = [];
    let currentGiftCardFilter = 'all';
    let selectedGiftCard = null;

    // Cargar servicios en el dropdown de gift cards
    async function loadGiftCardServices() {
      const select = document.getElementById('gc-service');
      if (!select) return;

      try {
        const res = await fetch('/api/services', { credentials: 'include' });
        const json = await res.json();

        if (json.success && json.data) {
          select.innerHTML = '<option value="">Seleccionar servicio...</option>';
          json.data.forEach(s => {
            select.innerHTML += `<option value="${s.id}" data-name="${s.name}" data-price="${s.price}">${s.name} - $${s.price}</option>`;
          });
        }
      } catch (error) {
        console.error('Error loading services for gift cards:', error);
      }
    }

    // Actualizar preview al seleccionar servicio
    document.getElementById('gc-service')?.addEventListener('change', function () {
      const option = this.options[this.selectedIndex];
      const serviceName = option.dataset?.name || 'Selecciona un servicio';
      document.getElementById('gc-preview-service').textContent = serviceName;
    });

    document.getElementById('gc-validity')?.addEventListener('change', function () {
      document.getElementById('gc-preview-validity').textContent = `Válida por ${this.value} días`;
    });

    // Cargar gift cards
    async function loadGiftCards() {
      const list = document.getElementById('gc-list');
      if (!list) return;

      list.innerHTML = '<div class="gc-empty"><i class="fas fa-spinner fa-spin"></i><p>Cargando...</p></div>';

      try {
        const res = await fetch('/api/giftcards', { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          allGiftCards = json.data || [];
          updateGiftCardStats();
          renderGiftCards();
        }
      } catch (error) {
        console.error('Error loading gift cards:', error);
        list.innerHTML = '<div class="gc-empty" style="color:#ef4444;"><p>Error al cargar</p></div>';
      }
    }

    // Actualizar estadísticas
    function updateGiftCardStats() {
      const now = new Date();

      const pending = allGiftCards.filter(gc => gc.status === 'pending' && new Date(gc.expiresAt) > now);
      const redeemed = allGiftCards.filter(gc => gc.status === 'redeemed');
      const expired = allGiftCards.filter(gc => gc.status === 'expired' || (gc.status === 'pending' && new Date(gc.expiresAt) <= now));

      document.getElementById('gc-stat-total').textContent = allGiftCards.length;
      document.getElementById('gc-stat-pending').textContent = pending.length;
      document.getElementById('gc-stat-redeemed').textContent = redeemed.length;
      document.getElementById('gc-stat-expired').textContent = expired.length;

      document.getElementById('gc-count-all').textContent = allGiftCards.length;
      document.getElementById('gc-count-pending').textContent = pending.length;
      document.getElementById('gc-count-redeemed').textContent = redeemed.length;
      document.getElementById('gc-count-expired').textContent = expired.length;
    }

    // Renderizar lista
    function renderGiftCards() {
      const list = document.getElementById('gc-list');
      const searchTerm = document.getElementById('gc-search')?.value?.toLowerCase() || '';
      const now = new Date();

      let filtered = allGiftCards.map(gc => {
        let status = gc.status;
        if (status === 'pending' && new Date(gc.expiresAt) <= now) {
          status = 'expired';
        }
        return { ...gc, displayStatus: status };
      });

      if (currentGiftCardFilter !== 'all') {
        filtered = filtered.filter(gc => gc.displayStatus === currentGiftCardFilter);
      }

      if (searchTerm) {
        filtered = filtered.filter(gc =>
          (gc.recipientName && gc.recipientName.toLowerCase().includes(searchTerm)) ||
          (gc.serviceName && gc.serviceName.toLowerCase().includes(searchTerm)) ||
          (gc.code && gc.code.toLowerCase().includes(searchTerm))
        );
      }

      filtered.sort((a, b) => {
        const order = { pending: 0, redeemed: 1, expired: 2 };
        if (order[a.displayStatus] !== order[b.displayStatus]) {
          return order[a.displayStatus] - order[b.displayStatus];
        }
        return new Date(b.createdAt) - new Date(a.createdAt);
      });

      if (filtered.length === 0) {
        list.innerHTML = `<div class="gc-empty"><i class="fas fa-gift"></i><p>No hay gift cards</p></div>`;
        return;
      }

      list.innerHTML = filtered.map(gc => {
        const createdDate = new Date(gc.createdAt).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' });
        const expiresDate = new Date(gc.expiresAt).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' });

        const totalDays = gc.validityDays || 30;
        const daysLeft = Math.ceil((new Date(gc.expiresAt) - now) / (1000 * 60 * 60 * 24));
        const percentLeft = Math.max(0, Math.min(100, (daysLeft / totalDays) * 100));

        let progressClass = 'ok';
        if (percentLeft <= 25) progressClass = 'danger';
        else if (percentLeft <= 50) progressClass = 'warning';

        const recipientDisplay = gc.recipientName || 'Sin nombre';

        let statusBadge = '';
        let iconClass = '';
        let iconHtml = '';

        if (gc.displayStatus === 'pending') {
          statusBadge = '<span class="gc-status pending">Pendiente</span>';
          iconClass = 'pending';
          iconHtml = '<i class="fas fa-gift"></i>';
        } else if (gc.displayStatus === 'redeemed') {
          statusBadge = '<span class="gc-status redeemed">Canjeada</span>';
          iconClass = 'redeemed';
          iconHtml = '<i class="fas fa-check"></i>';
        } else {
          statusBadge = '<span class="gc-status expired">Expirada</span>';
          iconClass = 'expired';
          iconHtml = '<i class="fas fa-times"></i>';
        }

        let redeemedInfo = '';
        if (gc.displayStatus === 'redeemed' && gc.redeemedAt) {
          const redeemedDate = new Date(gc.redeemedAt).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' });
          const redeemedBy = gc.redeemedBy || gc.recipientName || 'Cliente';
          redeemedInfo = `<div class="gc-redeemed-info"><i class="fas fa-check-circle"></i> Canjeada el ${redeemedDate} por ${redeemedBy}</div>`;
        }

        let vigenciaHtml = '';
        if (gc.displayStatus === 'pending') {
          const daysText = daysLeft <= 0 ? 'Vencida' : daysLeft === 1 ? 'Queda 1 día' : `Quedan ${daysLeft} días`;
          const warningIcon = daysLeft <= 7 && daysLeft > 0 ? '⚠️ ' : '';
          vigenciaHtml = `
            <div class="gc-vigencia">
              <div class="gc-vigencia-bar">
                <div class="gc-vigencia-progress ${progressClass}" style="width:${percentLeft}%;"></div>
              </div>
              <div class="gc-vigencia-text">${warningIcon}${daysText}</div>
            </div>
          `;
        }

        let actionsHtml = '';
        if (gc.displayStatus === 'pending') {
          actionsHtml = `
            <button class="btn small ghost" onclick="viewGiftCard('${gc.id}')" title="Ver QR"><i class="fas fa-qrcode"></i></button>
            <button class="btn small ghost" onclick="copyGiftCardLinkById('${gc.id}')" title="Copiar link"><i class="fas fa-link"></i></button>
            <button class="btn small ghost" onclick="sendGiftCardWhatsAppById('${gc.id}')" title="WhatsApp"><i class="fab fa-whatsapp"></i></button>
            <button class="btn small ghost" onclick="deleteGiftCard('${gc.id}')" title="Eliminar" style="color:#ef4444;"><i class="fas fa-trash"></i></button>
          `;
        } else if (gc.displayStatus === 'redeemed') {
          actionsHtml = `
            <button class="btn small ghost" onclick="viewGiftCard('${gc.id}')" title="Ver"><i class="fas fa-eye"></i></button>
            <button class="btn small ghost" onclick="deleteGiftCard('${gc.id}')" title="Eliminar" style="color:#ef4444;"><i class="fas fa-trash"></i></button>
          `;
        } else {
          actionsHtml = `
            <button class="btn small ghost" onclick="renewGiftCard('${gc.id}')" title="Renovar" style="color:var(--venus-soft);"><i class="fas fa-sync-alt"></i></button>
            <button class="btn small ghost" onclick="deleteGiftCard('${gc.id}')" title="Eliminar" style="color:#ef4444;"><i class="fas fa-trash"></i></button>
          `;
        }

        return `
          <div class="gc-item ${gc.displayStatus === 'expired' ? 'expired' : ''}">
            <div class="gc-icon ${iconClass}">${iconHtml}</div>
            <div class="gc-info">
              <h4>${recipientDisplay} ${statusBadge}</h4>
              <div class="gc-service">${gc.serviceName} · $${gc.servicePrice}</div>
              <div class="gc-meta">
                <span><i class="fas fa-calendar"></i> ${createdDate}</span>
                ${gc.displayStatus !== 'redeemed' ? `<span><i class="fas fa-hourglass-half"></i> Vence: ${expiresDate}</span>` : ''}
              </div>
              ${vigenciaHtml}
              ${redeemedInfo}
            </div>
            <div class="gc-actions">${actionsHtml}</div>
          </div>
        `;
      }).join('');
    }

    // Tabs
    const gcTabs = document.querySelectorAll('.gc-tab');
    console.log('[GC] Tabs encontrados:', gcTabs.length);
    gcTabs.forEach(tab => {
      tab.addEventListener('click', function () {
        console.log('[GC] Tab clicked:', this.dataset.filter);
        document.querySelectorAll('.gc-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        currentGiftCardFilter = this.dataset.filter;
        renderGiftCards();
      });
    });

    // Búsqueda
    document.getElementById('gc-search')?.addEventListener('input', renderGiftCards);

    // Crear gift card
    const formGiftcard = document.getElementById('form-giftcard');
    console.log('[GC] Formulario encontrado:', !!formGiftcard);

    if (formGiftcard) {
      formGiftcard.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('[GC] Submit del formulario');

        const serviceSelect = document.getElementById('gc-service');
        const serviceOption = serviceSelect.options[serviceSelect.selectedIndex];

        if (!serviceSelect.value) {
          alert('Selecciona un servicio');
          return;
        }

        const data = {
          recipientName: document.getElementById('gc-recipient').value.trim() || null,
          serviceId: serviceSelect.value,
          serviceName: serviceOption.dataset.name,
          servicePrice: parseFloat(serviceOption.dataset.price),
          message: document.getElementById('gc-message').value.trim() || null,
          validityDays: parseInt(document.getElementById('gc-validity').value)
        };

        try {
          const res = await fetch('/api/giftcards', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
          });

          const json = await res.json();
          console.log('[GC] Respuesta:', json);

          if (json.success) {
            document.getElementById('form-giftcard').reset();
            document.getElementById('gc-preview-service').textContent = 'Selecciona un servicio';
            document.getElementById('gc-preview-validity').textContent = 'Válida por 30 días';
            await loadGiftCards();
            viewGiftCard(json.id);
          } else {
            alert('Error: ' + json.error);
          }
        } catch (error) {
          console.error('[GC] Error:', error);
          alert('Error de conexión');
        }
      });
    }

    // Ver gift card
    async function viewGiftCard(id) {
      selectedGiftCard = allGiftCards.find(gc => gc.id === id);
      if (!selectedGiftCard) {
        await loadGiftCards();
        selectedGiftCard = allGiftCards.find(gc => gc.id === id);
        if (!selectedGiftCard) return;
      }

      const content = document.getElementById('modal-giftcard-content');
      const gc = selectedGiftCard;

      const expiresDate = new Date(gc.expiresAt).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' });
      const qrUrl = `${window.location.origin}/giftcard/${gc.code}`;

      content.innerHTML = `
        <div id="gift-card-visual" class="gift-card-visual" style="margin:0;border-radius:12px 12px 0 0;">
          <div class="gift-card-content">
            <img src="/assets/logo.png" alt="Venus" class="gift-brand-logo" style="width:60px;height:60px;margin-bottom:12px;">
            <div style="font-size:18px;color:var(--venus-soft);font-weight:600;">Gift Card Venus</div>
            <div style="font-size:22px;font-weight:700;margin:12px 0;color:#fff;">${gc.serviceName}</div>
            ${gc.recipientName ? `<div style="font-size:12px;color:var(--muted);margin:8px 0;">Para: ${gc.recipientName}</div>` : ''}
            ${gc.message ? `<div style="font-size:13px;font-style:italic;margin:10px 0;opacity:0.9;">"${gc.message}"</div>` : ''}
            <div style="background:white;padding:16px;border-radius:12px;display:inline-block;margin:16px 0;">
              <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrUrl)}" alt="QR" style="display:block;width:150px;height:150px;">
            </div>
            <div style="font-size:11px;color:var(--muted);">Código: ${gc.code}</div>
            <div style="font-size:11px;color:var(--muted);margin-top:4px;">Válida hasta: ${expiresDate}</div>
            <div style="margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);">
              <div style="font-size:11px;color:var(--muted);">📍 Cactus 50, Col. Indeco</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px;">📱 WhatsApp: 427 165 7595</div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('modal-giftcard-view').classList.remove('hidden');
    }

    function closeGiftCardModal() {
      document.getElementById('modal-giftcard-view').classList.add('hidden');
      selectedGiftCard = null;
    }

    // Descargar imagen de gift card
    async function downloadGiftCardImage() {
      if (!selectedGiftCard) return;
      const element = document.getElementById('gift-card-visual');
      if (!element) return;

      try {
        const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#3f4037', useCORS: true });
        const link = document.createElement('a');
        link.download = `gift-card-venus-${selectedGiftCard.code}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (error) {
        console.error('Error generando imagen:', error);
        alert('Error al generar la imagen');
      }
    }

    // Enviar por WhatsApp con imagen
    async function sendGiftCardWhatsAppImage() {
      if (!selectedGiftCard) return;
      const element = document.getElementById('gift-card-visual');
      if (!element) { sendGiftCardWhatsApp(); return; }

      try {
        const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#3f4037', useCORS: true });
        const gc = selectedGiftCard;
        const url = `${window.location.origin}/giftcard/${gc.code}`;
        const message = `🎁 ¡Te han regalado un servicio en Venus Cosmetología!\n\n✨ ${gc.serviceName}\n${gc.recipientName ? `👤 Para: ${gc.recipientName}\n` : ''}${gc.message ? `💬 "${gc.message}"\n` : ''}\n📍 Cactus 50, Col. Indeco\n📱 WhatsApp: 427 165 7595\n\n🎁 Canjea tu gift card aquí:\n${url}`;

        if (navigator.share && navigator.canShare) {
          const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
          const file = new File([blob], 'gift-card-venus.png', { type: 'image/png' });
          try {
            await navigator.share({ title: 'Gift Card Venus', text: message, files: [file] });
            return;
          } catch (err) { if (err.name === 'AbortError') return; }
        }

        // Fallback: descargar y abrir WhatsApp
        const link = document.createElement('a');
        link.download = 'gift-card-venus.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        setTimeout(() => {
          window.open(`https://wa.me/?text=${encodeURIComponent(message + '\n\n(Adjunta la imagen descargada)')}`, '_blank');
        }, 1000);
      } catch (error) {
        console.error('Error:', error);
        sendGiftCardWhatsApp();
      }
    }

    function copyGiftCardLink() {
      if (!selectedGiftCard) return;
      const url = `${window.location.origin}/giftcard/${selectedGiftCard.code}`;
      navigator.clipboard.writeText(url);
      alert('Link copiado');
    }

    function copyGiftCardLinkById(id) {
      const gc = allGiftCards.find(g => g.id === id);
      if (!gc) return;
      const url = `${window.location.origin}/giftcard/${gc.code}`;
      navigator.clipboard.writeText(url);
      alert('Link copiado');
    }

    function sendGiftCardWhatsApp() {
      if (!selectedGiftCard) return;
      sendGiftCardWhatsAppById(selectedGiftCard.id);
    }

    function sendGiftCardWhatsAppById(id) {
      const gc = allGiftCards.find(g => g.id === id);
      if (!gc) return;
      const url = `${window.location.origin}/giftcard/${gc.code}`;
      const text = encodeURIComponent(`🎁 ¡Te han regalado un servicio en Venus Cosmetología!\n\n✨ ${gc.serviceName}\n\n📍 Cactus 50, Col. Indeco\n📱 WhatsApp: 427 165 7595\n\n🎁 Canjea tu gift card aquí:\n${url}`);
      window.open(`https://wa.me/?text=${text}`, '_blank');
    }

    async function renewGiftCard(id) {
      if (!confirm('¿Renovar esta gift card por 30 días más?')) return;

      try {
        const res = await fetch(`/api/giftcards/${id}/renew`, {
          method: 'POST',
          credentials: 'include'
        });

        const json = await res.json();

        if (json.success) {
          loadGiftCards();
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        alert('Error de conexión');
      }
    }

    async function deleteGiftCard(id) {
      if (!confirm('¿Eliminar esta gift card? Esta acción no se puede deshacer.')) return;

      try {
        const res = await fetch(`/api/giftcards/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        const json = await res.json();

        if (json.success) {
          loadGiftCards();
          loadDashboardStats();
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        alert('Error de conexión');
      }
    }

    // Hacer funciones globales
    window.viewGiftCard = viewGiftCard;
    window.deleteGiftCard = deleteGiftCard;
    window.closeGiftCardModal = closeGiftCardModal;
    window.copyGiftCardLink = copyGiftCardLink;
    window.copyGiftCardLinkById = copyGiftCardLinkById;
    window.sendGiftCardWhatsApp = sendGiftCardWhatsApp;
    window.sendGiftCardWhatsAppById = sendGiftCardWhatsAppById;
    window.downloadGiftCardImage = downloadGiftCardImage;
    window.sendGiftCardWhatsAppImage = sendGiftCardWhatsAppImage;
    window.renewGiftCard = renewGiftCard;
    window.loadGiftCardServices = loadGiftCardServices;
    window.loadGiftCards = loadGiftCards;

    console.log('[GC] Gift Cards module loaded');

    /* =========================================================
       MODAL DE PAGO CON PRODUCTOS Y DESCUENTOS
       ========================================================= */

    let paymentProducts = [];
    let paymentServicePrice = 0;
    let allProductsForPayment = [];
    let discountType = 'percent';
    let isPriceEditing = false;

    async function loadProductsForPayment() {
      try {
        const res = await fetch('/api/products', { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          allProductsForPayment = (json.data || []).filter(p => p.stock > 0);
          updatePaymentProductSelect();
        }
      } catch (error) {
        console.error('Error loading products for payment:', error);
      }
    }

    function updatePaymentProductSelect() {
      const select = document.getElementById('payment-product-select');
      if (!select) return;

      select.innerHTML = '<option value="">Agregar producto...</option>';

      allProductsForPayment.forEach(p => {
        const inCart = paymentProducts.find(pp => pp.id === p.id);
        const availableStock = p.stock - (inCart ? inCart.qty : 0);

        if (availableStock > 0) {
          const stockLabel = availableStock <= 5 ? ` (${availableStock})` : '';
          select.innerHTML += `<option value="${p.id}" data-price="${p.price}" data-name="${p.name}" data-stock="${availableStock}" data-category="${p.category}">${p.name} - $${p.price}${stockLabel}</option>`;
        }
      });
    }

    async function openPaymentModal(appointmentId, clientName, serviceName, servicePrice, isEdit = false) {
      paymentProducts = [];
      discountType = 'percent';
      isPriceEditing = false;

      document.getElementById('payment-appointment-id').value = appointmentId;
      document.getElementById('payment-client-name').textContent = clientName || '-';
      document.getElementById('payment-service-name').textContent = serviceName || '-';

      const modalTitle = document.querySelector('#paymentDialog h3');
      const submitBtn = document.querySelector('#paymentDialog .btn.primary');

      if (isEdit) {
        modalTitle.textContent = 'Editar Pago';
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios <span id="btn-payment-total">$0</span>';
      } else {
        modalTitle.textContent = 'Registrar Pago';
        submitBtn.innerHTML = '<i class="fas fa-check"></i> Completar Cita <span id="btn-payment-total">$0</span>';
      }

      // Si es edición, obtener datos actuales de la cita
      if (isEdit) {
        try {
          const res = await fetch(`/api/appointments/${appointmentId}`, { credentials: 'include' });
          const json = await res.json();
          if (json.success && json.data) {
            const appt = json.data;
            servicePrice = appt.serviceAmount || appt.price || 0;

            // Pre-seleccionar método de pago
            const methodSelect = document.getElementById('payment-method');
            if (methodSelect) methodSelect.value = appt.paymentMethod || 'efectivo';

            // Pre-llenar descuento si existe
            if (appt.discountType) {
              discountType = appt.discountType;
              document.getElementById('payment-discount-value').value = appt.discountValue || 0;

              // Actualizar UI de botones de descuento
              document.getElementById('btn-discount-percent').classList.toggle('active', discountType === 'percent');
              document.getElementById('btn-discount-fixed').classList.toggle('active', discountType === 'fixed');
              document.getElementById('discount-symbol').textContent = discountType === 'percent' ? '%' : '$';
            }

            // TODO: Cargar productos vendidos si es necesario (complejo porque requiere stock)

            // Recalcular totales después de cargar datos
            setTimeout(calculateTotals, 100);
          }
        } catch (e) {
          console.error('Error cargando datos de pago:', e);
        }
      }

      // Si no hay precio, intentar obtenerlo del servidor
      if (!servicePrice || servicePrice === 0) {
        console.log('[PAYMENT] Precio no disponible, obteniendo del servidor...');
        try {
          const res = await fetch(`/api/appointments/${appointmentId}`, { credentials: 'include' });
          const json = await res.json();

          if (json.success && json.data) {
            console.log('[PAYMENT] Datos de cita:', json.data);
            servicePrice = json.data.price || json.data.servicePrice || 0;

            // Si aún no hay precio, buscar en servicios
            if (!servicePrice || servicePrice === 0) {
              const serviceId = json.data.serviceId;
              if (serviceId) {
                const servRes = await fetch('/api/services', { credentials: 'include' });
                const servJson = await servRes.json();
                if (servJson.success) {
                  const service = servJson.data.find(s => s.id === serviceId);
                  if (service) {
                    servicePrice = service.price || 0;
                    console.log('[PAYMENT] Precio obtenido del servicio:', servicePrice);
                  }
                }
              }
            }
          }
        } catch (error) {
          console.error('[PAYMENT] Error obteniendo precio:', error);
        }
      }

      paymentServicePrice = parseFloat(servicePrice) || 0;
      console.log('[PAYMENT] Precio final del servicio:', paymentServicePrice);

      document.getElementById('payment-original-price').value = paymentServicePrice;
      document.getElementById('payment-price-display').textContent = '$' + paymentServicePrice.toLocaleString();
      document.getElementById('payment-price-display').classList.remove('hidden');
      document.getElementById('payment-price-input').value = paymentServicePrice;
      document.getElementById('payment-price-input').classList.remove('visible');

      // Solo resetear descuento si NO es edición
      if (!isEdit) {
        document.getElementById('payment-discount-value').value = 0;
        document.getElementById('btn-discount-percent').classList.add('active');
        document.getElementById('btn-discount-fixed').classList.remove('active');
        document.getElementById('discount-symbol').textContent = '%';
      }

      document.getElementById('payment-product-qty').value = 1;

      loadProductsForPayment();
      renderPaymentProducts();
      calculateTotals();

      document.getElementById('paymentDialog').showModal();
    }

    function closePaymentModal() {
      document.getElementById('paymentDialog').close();
      paymentProducts = [];
    }

    function togglePriceEdit() {
      const display = document.getElementById('payment-price-display');
      const input = document.getElementById('payment-price-input');

      if (isPriceEditing) {
        paymentServicePrice = parseFloat(input.value) || 0;
        display.textContent = '$' + paymentServicePrice.toLocaleString();
        display.classList.remove('hidden');
        input.classList.remove('visible');
        isPriceEditing = false;
      } else {
        input.value = paymentServicePrice;
        display.classList.add('hidden');
        input.classList.add('visible');
        input.focus();
        input.select();
        isPriceEditing = true;
      }
      calculateTotals();
    }

    function setDiscountType(type) {
      discountType = type;
      document.getElementById('btn-discount-percent').classList.toggle('active', type === 'percent');
      document.getElementById('btn-discount-fixed').classList.toggle('active', type === 'fixed');
      document.getElementById('discount-symbol').textContent = type === 'percent' ? '%' : '$';
      calculateTotals();
    }

    function addProductToPayment() {
      const select = document.getElementById('payment-product-select');
      const qtyInput = document.getElementById('payment-product-qty');

      if (!select.value) {
        alert('Selecciona un producto');
        return;
      }

      const option = select.options[select.selectedIndex];
      const qty = parseInt(qtyInput.value) || 1;
      const stock = parseInt(option.dataset.stock) || 0;

      if (qty > stock) {
        alert(`Solo hay ${stock} unidades disponibles`);
        return;
      }

      const existing = paymentProducts.find(p => p.id === select.value);

      if (existing) {
        existing.qty += qty;
      } else {
        paymentProducts.push({
          id: select.value,
          name: option.dataset.name,
          price: parseFloat(option.dataset.price),
          qty: qty,
          category: option.dataset.category,
          maxStock: stock
        });
      }

      select.value = '';
      qtyInput.value = 1;

      updatePaymentProductSelect();
      renderPaymentProducts();
      calculateTotals();
    }

    function removeProductFromPayment(productId) {
      paymentProducts = paymentProducts.filter(p => p.id !== productId);
      updatePaymentProductSelect();
      renderPaymentProducts();
      calculateTotals();
    }

    function renderPaymentProducts() {
      const list = document.getElementById('payment-products-list');

      if (paymentProducts.length === 0) {
        list.innerHTML = '<div class="payment-products-empty">Sin productos adicionales</div>';
        return;
      }

      const icons = { 'skincare': '🧴', 'maquillaje': '💄', 'corporal': '✨', 'cabello': '💇', 'otro': '📦' };

      list.innerHTML = paymentProducts.map(p => {
        const icon = icons[p.category] || '📦';
        const subtotal = p.price * p.qty;

        return `
          <div class="payment-product-item">
            <div class="payment-product-icon">${icon}</div>
            <div class="payment-product-info">
              <div class="payment-product-name">${p.name}</div>
              <div class="payment-product-meta">$${p.price} × ${p.qty}</div>
            </div>
            <div class="payment-product-price">$${subtotal.toLocaleString()}</div>
            <button class="payment-product-remove" onclick="removeProductFromPayment('${p.id}')">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
      }).join('');
    }

    function calculateTotals() {
      const servicePrice = paymentServicePrice;
      const productsTotal = paymentProducts.reduce((sum, p) => sum + (p.price * p.qty), 0);
      const productsCount = paymentProducts.reduce((sum, p) => sum + p.qty, 0);
      const subtotal = servicePrice + productsTotal;

      const discountValue = parseFloat(document.getElementById('payment-discount-value').value) || 0;
      let discountAmount = 0;

      if (discountType === 'percent') {
        discountAmount = Math.round(subtotal * (discountValue / 100));
      } else {
        discountAmount = Math.min(discountValue, subtotal);
      }

      const grandTotal = Math.max(0, subtotal - discountAmount);

      document.getElementById('total-service').textContent = '$' + servicePrice.toLocaleString();
      document.getElementById('total-products').textContent = '$' + productsTotal.toLocaleString();
      document.getElementById('total-products-count').textContent = productsCount;
      document.getElementById('total-subtotal').textContent = '$' + subtotal.toLocaleString();
      document.getElementById('total-discount').textContent = '-$' + discountAmount.toLocaleString();
      document.getElementById('total-grand').textContent = '$' + grandTotal.toLocaleString();
      document.getElementById('btn-payment-total').textContent = '$' + grandTotal.toLocaleString();

      document.getElementById('total-products-row').style.display = productsCount > 0 ? 'flex' : 'none';

      const discountRow = document.getElementById('total-discount-row');
      const discountApplied = document.getElementById('discount-applied');

      if (discountAmount > 0) {
        discountRow.classList.add('visible');
        discountApplied.classList.add('visible');
        const label = discountType === 'percent' ? `Descuento (${discountValue}%)` : 'Descuento';
        document.getElementById('total-discount-label').textContent = label;
        document.getElementById('discount-applied-text').textContent = `Descuento aplicado: -$${discountAmount.toLocaleString()}`;
      } else {
        discountRow.classList.remove('visible');
        discountApplied.classList.remove('visible');
      }
    }

    async function savePayment() {
      const appointmentId = document.getElementById('payment-appointment-id').value;
      const paymentMethod = document.getElementById('payment-method').value;

      const servicePrice = paymentServicePrice;
      const productsTotal = paymentProducts.reduce((sum, p) => sum + (p.price * p.qty), 0);
      const subtotal = servicePrice + productsTotal;

      const discountValue = parseFloat(document.getElementById('payment-discount-value').value) || 0;
      let discountAmount = 0;
      if (discountType === 'percent') {
        discountAmount = Math.round(subtotal * (discountValue / 100));
      } else {
        discountAmount = Math.min(discountValue, subtotal);
      }

      const grandTotal = Math.max(0, subtotal - discountAmount);

      if (!appointmentId) {
        alert('Error: No se encontró la cita');
        return;
      }

      const btn = document.getElementById('btn-save-payment');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

      try {
        const productsSold = paymentProducts.map(p => ({
          productId: p.id,
          name: p.name,
          price: p.price,
          qty: p.qty,
          subtotal: p.price * p.qty
        }));

        const res = await fetch(`/api/appointments/${appointmentId}/payment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            paymentMethod,
            serviceAmount: servicePrice,
            productsAmount: productsTotal,
            subtotal,
            discountType: discountAmount > 0 ? discountType : null,
            discountValue: discountAmount > 0 ? discountValue : 0,
            discountAmount,
            totalAmount: grandTotal,
            productsSold
          })
        });

        const json = await res.json();

        if (json.success) {
          closePaymentModal();
          if (typeof loadAppointments === 'function') loadAppointments();
          if (typeof loadTodayAppointments === 'function') loadTodayAppointments();
          if (typeof loadMonthStats === 'function') loadMonthStats();
          alert('✓ Pago registrado: $' + grandTotal.toLocaleString());
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        console.error('Error saving payment:', error);
        alert('Error de conexión');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Cobrar <span id="btn-payment-total">$' + grandTotal.toLocaleString() + '</span>';
      }
    }

    window.openPaymentModal = openPaymentModal;
    window.closePaymentModal = closePaymentModal;
    window.togglePriceEdit = togglePriceEdit;
    window.setDiscountType = setDiscountType;
    window.addProductToPayment = addProductToPayment;
    window.removeProductFromPayment = removeProductFromPayment;
    window.calculateTotals = calculateTotals;
    window.savePayment = savePayment;

    // ========== VER DETALLE DE PAGO ==========
    async function viewPaymentDetails(appointmentId) {
      try {
        const res = await fetch(`/api/appointments/${appointmentId}`, { credentials: 'include' });
        const json = await res.json();
        if (!json.success) return alert('Error cargando detalles');

        const appt = json.data;
        const productsSold = appt.productsSold || [];

        let productsHtml = '';
        if (productsSold.length > 0) {
          const productsTotal = productsSold.reduce((sum, p) => sum + (p.subtotal || p.price * p.qty), 0);
          productsHtml = `
            <div style="margin:16px 0;background:rgba(139,92,246,0.1);border-radius:12px;padding:12px;">
              <h4 style="margin:0 0 10px;font-size:14px;color:#a78bfa;display:flex;align-items:center;gap:6px;">
                <i class="fas fa-shopping-bag"></i> Productos Vendidos
              </h4>
              <table style="width:100%;font-size:12px;border-collapse:collapse;">
                <thead>
                  <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                    <th style="text-align:left;padding:6px 4px;color:#9ca3af;">Producto</th>
                    <th style="text-align:center;padding:6px 4px;color:#9ca3af;">Cant.</th>
                    <th style="text-align:right;padding:6px 4px;color:#9ca3af;">Precio</th>
                    <th style="text-align:right;padding:6px 4px;color:#9ca3af;">Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  ${productsSold.map(p => `
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                      <td style="padding:8px 4px;color:#f3f4f6;">${p.name}</td>
                      <td style="text-align:center;padding:8px 4px;color:#d1d5db;">${p.qty}</td>
                      <td style="text-align:right;padding:8px 4px;color:#d1d5db;">$${p.price.toLocaleString()}</td>
                      <td style="text-align:right;padding:8px 4px;color:#a78bfa;font-weight:600;">$${(p.subtotal || p.price * p.qty).toLocaleString()}</td>
                    </tr>
                  `).join('')}
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="3" style="text-align:right;padding:8px 4px;font-weight:600;color:#f3f4f6;">Total Productos:</td>
                    <td style="text-align:right;padding:8px 4px;font-weight:700;color:#a78bfa;">$${productsTotal.toLocaleString()}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          `;
        }

        const methodLabels = {
          'efectivo': 'Efectivo',
          'tarjeta_credito': 'Tarjeta de crédito',
          'tarjeta_debito': 'Tarjeta de débito',
          'transferencia': 'Transferencia'
        };

        document.getElementById('payment-detail-content').innerHTML = `
          <div class="payment-info-row" style="margin-bottom:16px;">
            <div class="payment-info-box">
              <div class="payment-info-label">Cliente</div>
              <div class="payment-info-value">${appt.clientName}</div>
            </div>
            <div class="payment-info-box">
              <div class="payment-info-label">Servicio</div>
              <div class="payment-info-value">${appt.serviceName}</div>
            </div>
          </div>
          ${productsHtml}
          <div class="payment-totals" style="margin-top:16px;">
            <div class="payment-total-row sub"><span>Servicio</span><span>$${(appt.serviceAmount || 0).toLocaleString()}</span></div>
            ${appt.productsAmount > 0 ? `<div class="payment-total-row sub"><span>Productos</span><span>$${appt.productsAmount.toLocaleString()}</span></div>` : ''}
            ${appt.discountAmount > 0 ? `<div class="payment-total-row discount"><span>Descuento (${appt.discountType === 'percent' ? appt.discountValue + '%' : '$' + appt.discountValue})</span><span>-$${appt.discountAmount.toLocaleString()}</span></div>` : ''}
            <div class="payment-total-row grand"><span>Total Pagado</span><span>$${(appt.totalPaid || 0).toLocaleString()}</span></div>
          </div>
          <div style="margin-top:16px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:12px;color:#9ca3af;">
            <div style="display:flex;justify-content:space-between;">
              <span><i class="fas fa-credit-card"></i> ${methodLabels[appt.paymentMethod] || appt.paymentMethod || 'N/A'}</span>
              <span><i class="fas fa-clock"></i> ${appt.paidAt ? new Date(appt.paidAt).toLocaleString('es-MX') : 'N/A'}</span>
            </div>
          </div>
        `;

        document.getElementById('paymentDetailDialog').showModal();
      } catch (error) {
        console.error('Error viewing payment details:', error);
        alert('Error cargando detalles del pago');
      }
    }

    function closePaymentDetail() {
      document.getElementById('paymentDetailDialog').close();
    }

    window.viewPaymentDetails = viewPaymentDetails;
    window.closePaymentDetail = closePaymentDetail;

    // ========== VENTA DIRECTA (SIN CITA) ==========
    let directSaleProducts = [];
    let dsDiscountType = 'percent';

    async function openDirectSaleModal() {
      directSaleProducts = [];
      dsDiscountType = 'percent';
      document.getElementById('direct-sale-client').value = '';
      document.getElementById('direct-sale-discount-value').value = 0;
      document.getElementById('btn-ds-discount-percent').classList.add('active');
      document.getElementById('btn-ds-discount-fixed').classList.remove('active');
      document.getElementById('ds-discount-symbol').textContent = '%';

      await loadProductsForDirectSale();
      renderDirectSaleProducts();
      calculateDirectSaleTotals();

      document.getElementById('directSaleDialog').showModal();
    }

    function closeDirectSaleModal() {
      document.getElementById('directSaleDialog').close();
      directSaleProducts = [];
    }

    async function loadProductsForDirectSale() {
      try {
        const res = await fetch('/api/products', { credentials: 'include' });
        const json = await res.json();
        if (json.success) {
          const select = document.getElementById('direct-sale-product-select');
          select.innerHTML = '<option value="">Agregar producto...</option>';
          json.data.filter(p => p.stock > 0).forEach(p => {
            select.innerHTML += `<option value="${p.id}" data-price="${p.price}" data-name="${p.name}" data-stock="${p.stock}">
              ${p.name} - $${p.price.toLocaleString()} (Stock: ${p.stock})
            </option>`;
          });
        }
      } catch (e) {
        console.error('Error cargando productos:', e);
      }
    }

    function addProductToDirectSale() {
      const select = document.getElementById('direct-sale-product-select');
      const qtyInput = document.getElementById('direct-sale-product-qty');
      const option = select.selectedOptions[0];

      if (!select.value) return;

      const qty = parseInt(qtyInput.value) || 1;
      const existing = directSaleProducts.find(p => p.id === select.value);

      if (existing) {
        existing.qty += qty;
      } else {
        directSaleProducts.push({
          id: select.value,
          name: option.dataset.name,
          price: parseFloat(option.dataset.price),
          qty: qty,
          maxStock: parseInt(option.dataset.stock)
        });
      }

      select.value = '';
      qtyInput.value = 1;
      renderDirectSaleProducts();
      calculateDirectSaleTotals();
    }

    function removeProductFromDirectSale(productId) {
      directSaleProducts = directSaleProducts.filter(p => p.id !== productId);
      renderDirectSaleProducts();
      calculateDirectSaleTotals();
    }

    function renderDirectSaleProducts() {
      const list = document.getElementById('direct-sale-products-list');
      if (directSaleProducts.length === 0) {
        list.innerHTML = '<div class="payment-products-empty">Selecciona productos para vender</div>';
        return;
      }

      list.innerHTML = directSaleProducts.map(p => {
        const subtotal = p.price * p.qty;
        return `
          <div class="payment-product-item">
            <div class="payment-product-info">
              <span class="payment-product-name">${p.name}</span>
              <span class="payment-product-price">$${p.price.toLocaleString()} × ${p.qty}</span>
            </div>
            <div class="payment-product-subtotal">$${subtotal.toLocaleString()}</div>
            <button onclick="removeProductFromDirectSale('${p.id}')" class="payment-product-remove">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
      }).join('');
    }

    function setDirectSaleDiscountType(type) {
      dsDiscountType = type;
      document.getElementById('btn-ds-discount-percent').classList.toggle('active', type === 'percent');
      document.getElementById('btn-ds-discount-fixed').classList.toggle('active', type === 'fixed');
      document.getElementById('ds-discount-symbol').textContent = type === 'percent' ? '%' : '$';
      calculateDirectSaleTotals();
    }

    function calculateDirectSaleTotals() {
      const productsTotal = directSaleProducts.reduce((sum, p) => sum + (p.price * p.qty), 0);
      const discountValue = parseFloat(document.getElementById('direct-sale-discount-value').value) || 0;

      let discountAmount = 0;
      if (dsDiscountType === 'percent') {
        discountAmount = Math.round(productsTotal * (discountValue / 100));
      } else {
        discountAmount = Math.min(discountValue, productsTotal);
      }

      const grandTotal = Math.max(0, productsTotal - discountAmount);

      document.getElementById('ds-total-products').textContent = '$' + productsTotal.toLocaleString();
      document.getElementById('ds-total-discount').textContent = '-$' + discountAmount.toLocaleString();
      document.getElementById('ds-total-discount-row').style.display = discountAmount > 0 ? 'flex' : 'none';
      document.getElementById('ds-total-grand').textContent = '$' + grandTotal.toLocaleString();
      document.getElementById('btn-ds-total').textContent = '$' + grandTotal.toLocaleString();
    }

    async function saveDirectSale() {
      if (directSaleProducts.length === 0) {
        return alert('Agrega al menos un producto');
      }

      const clientName = document.getElementById('direct-sale-client').value.trim() || 'Venta directa';
      const paymentMethod = document.getElementById('direct-sale-payment-method').value;
      const discountValue = parseFloat(document.getElementById('direct-sale-discount-value').value) || 0;
      const productsTotal = directSaleProducts.reduce((sum, p) => sum + (p.price * p.qty), 0);

      let discountAmount = 0;
      if (dsDiscountType === 'percent') {
        discountAmount = Math.round(productsTotal * (discountValue / 100));
      } else {
        discountAmount = Math.min(discountValue, productsTotal);
      }

      const grandTotal = Math.max(0, productsTotal - discountAmount);

      const btn = document.getElementById('btn-save-direct-sale');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

      try {
        const productsSold = directSaleProducts.map(p => ({
          productId: p.id,
          name: p.name,
          price: p.price,
          qty: p.qty,
          subtotal: p.price * p.qty
        }));

        const res = await fetch('/api/direct-sales', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            clientName,
            paymentMethod,
            productsAmount: productsTotal,
            discountType: discountAmount > 0 ? dsDiscountType : null,
            discountValue: discountAmount > 0 ? discountValue : 0,
            discountAmount,
            totalAmount: grandTotal,
            productsSold
          })
        });

        const json = await res.json();

        if (json.success) {
          closeDirectSaleModal();
          if (typeof loadMonthStats === 'function') loadMonthStats();
          if (typeof loadProducts === 'function') loadProducts();
          alert('✓ Venta registrada: $' + grandTotal.toLocaleString());
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        console.error('Error saving direct sale:', error);
        alert('Error de conexión');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Cobrar <span id="btn-ds-total">$' + grandTotal.toLocaleString() + '</span>';
      }
    }

    window.openDirectSaleModal = openDirectSaleModal;
    window.closeDirectSaleModal = closeDirectSaleModal;
    window.addProductToDirectSale = addProductToDirectSale;
    window.removeProductFromDirectSale = removeProductFromDirectSale;
    window.setDirectSaleDiscountType = setDirectSaleDiscountType;
    window.calculateDirectSaleTotals = calculateDirectSaleTotals;
    window.saveDirectSale = saveDirectSale;


    // --- SIMULATE WEBHOOK ---
    async function simulateWebhook(action) {
      const phone = prompt("Ingresa el teléfono del cliente (10 dígitos):", "4271657595");
      if (!phone) return;

      let payload = {};
      if (action === 'confirmar') {
        payload = { From: 'whatsapp:+521' + phone, ButtonText: 'Confirmar', Body: 'Confirmar' };
      } else if (action === 'reprogramar') {
        payload = { From: 'whatsapp:+521' + phone, ButtonText: 'Reprogramar', Body: 'Reprogramar' };
      } else if (action === 'cancelar') {
        payload = { From: 'whatsapp:+521' + phone, ButtonText: 'Cancelar', Body: 'Cancelar' };
      }

      try {
        const res = await fetch('/api/whatsapp/webhook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          alert('✅ Webhook simulado correctamente. Revisa la consola del servidor y el estado de la cita.');
          loadAppointments(); // Recargar citas para ver cambios
        } else {
          alert('❌ Error al simular webhook');
        }
      } catch (e) {
        console.error(e);
        alert('❌ Error de red al simular webhook');
      }
    }

    /* =========================================================
       DASHBOARD MEJORADO - FASE 1
       ========================================================= */

    // Saludo según hora del día
    function updateGreeting() {
      const hour = new Date().getHours();
      let greeting = 'Buenas noches';
      if (hour >= 5 && hour < 12) greeting = 'Buenos días';
      else if (hour >= 12 && hour < 19) greeting = 'Buenas tardes';

      const el = document.getElementById('dash-greeting');
      if (el) el.textContent = greeting;
    }

    // Cargar estadísticas del dashboard
    async function loadDashboardStats() {
      try {
        // 1. Cargar métricas del mes desde el servidor (datos reales de eventos)
        const metricsRes = await fetch('/api/admin/metrics-month', { credentials: 'include' });
        const metricsJson = await metricsRes.json();

        if (metricsJson.success && metricsJson.data) {
          const { total, activeClients, stampsThisMonth, redeemsThisMonth, returnRate } = metricsJson.data;

          document.getElementById('stat-total-clients').textContent = activeClients || total;
          document.getElementById('stat-stamps-month').textContent = stampsThisMonth;
          document.getElementById('stat-redeems-month').textContent = redeemsThisMonth;
          document.getElementById('stat-return-rate').textContent = returnRate + '%';
        }

        // 2. Cargar TODAS las tarjetas para top clientes y cumpleaños
        let allClients = [];
        let page = 1;
        let hasMore = true;

        while (hasMore) {
          const clientsRes = await fetch(`/api/admin/cards-firebase?page=${page}&limit=100`, { credentials: 'include' });
          const clientsJson = await clientsRes.json();

          if (clientsJson.items && clientsJson.items.length > 0) {
            allClients = [...allClients, ...clientsJson.items];
            hasMore = page < clientsJson.totalPages;
            page++;
          } else {
            hasMore = false;
          }
        }

        const clients = allClients;

        if (clients.length > 0) {
          // Top clientes
          renderTopClients(clients);

          // Wallets
          const appleCount = clients.filter(c => c.walletType === 'apple').length;
          const googleCount = clients.filter(c => c.walletType === 'google').length;
          document.getElementById('wallet-apple').textContent = appleCount;
          document.getElementById('wallet-google').textContent = googleCount;

          // Cargar cumpleaños con todas las tarjetas
          loadBirthdaysFromClients(clients);
        }

        // 3. Cargar citas de hoy
        await loadTodayStats();

        // 4. Cargar gift cards
        await loadGiftCardStats();

        // 5. Cargar gráfica de actividad
        await loadDashboardActivityChart();

      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    // Cargar stats de hoy
    async function loadTodayStats() {
      try {
        const res = await fetch('/api/dashboard/today', { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          const { appointments, pending, income } = json.data;
          document.getElementById('today-appointments').textContent = appointments;
          document.getElementById('today-pending').textContent = pending;
          document.getElementById('today-income').textContent = '$' + income.toLocaleString();
        }
      } catch (error) {
        console.error('Error loading today stats:', error);
      }
    }

    // Cargar stats de gift cards
    async function loadGiftCardStats() {
      try {
        const res = await fetch('/api/giftcards', { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          const giftcards = json.data || [];
          const now = new Date();
          const sevenDaysFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
          const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

          const pending = giftcards.filter(gc => gc.status === 'pending' && new Date(gc.expiresAt) > now).length;
          const expiring = giftcards.filter(gc => {
            const expires = new Date(gc.expiresAt);
            return gc.status === 'pending' && expires > now && expires <= sevenDaysFromNow;
          }).length;
          const redeemedThisMonth = giftcards.filter(gc => {
            return gc.status === 'redeemed' && gc.redeemedAt && new Date(gc.redeemedAt) >= firstOfMonth;
          }).length;

          document.getElementById('gc-pending').textContent = pending;
          document.getElementById('gc-expiring').textContent = expiring;
          document.getElementById('gc-redeemed').textContent = redeemedThisMonth;
        }
      } catch (error) {
        console.error('Error loading gift card stats:', error);
      }
    }

    // Cargar cumpleaños desde clientes ya cargados
    function loadBirthdaysFromClients(clients) {
      try {
        const now = new Date();
        const birthdays = [];

        clients.forEach(c => {
          // Usar birthdate (no birthday)
          const birthdateField = c.birthdate || c.birthday;

          if (birthdateField) {
            // Parsear fecha en formato YYYY-MM-DD
            const [year, month, day] = birthdateField.split('-').map(Number);
            const thisYearBday = new Date(now.getFullYear(), month - 1, day);

            // Si ya pasó este año, usar el próximo año
            if (thisYearBday < now) {
              thisYearBday.setFullYear(now.getFullYear() + 1);
            }

            const daysUntil = Math.ceil((thisYearBday - now) / (1000 * 60 * 60 * 24));

            // Mostrar cumpleaños en los próximos 30 días
            if (daysUntil <= 30) {
              birthdays.push({
                name: c.name,
                date: thisYearBday,
                daysUntil,
                dateStr: thisYearBday.toLocaleDateString('es-MX', { day: 'numeric', month: 'long' })
              });
            }
          }
        });

        birthdays.sort((a, b) => a.daysUntil - b.daysUntil);
        renderBirthdays(birthdays.slice(0, 3));
      } catch (error) {
        console.error('Error loading birthdays:', error);
      }
    }

    function renderBirthdays(birthdays) {
      const container = document.getElementById('birthday-list');

      if (birthdays.length === 0) {
        container.innerHTML = '<div class="dash-empty"><p>Sin cumpleaños próximos</p></div>';
        return;
      }

      container.innerHTML = birthdays.map(b => {
        let badgeClass = 'soon';
        let badgeText = `En ${b.daysUntil} días`;

        if (b.daysUntil === 0) {
          badgeClass = 'today';
          badgeText = '¡Hoy!';
        } else if (b.daysUntil === 1) {
          badgeText = 'Mañana';
        }

        return `
          <div class="birthday-item">
            <div class="birthday-avatar">🎂</div>
            <div class="birthday-info">
              <h4>${b.name}</h4>
              <p>${b.dateStr}</p>
            </div>
            <span class="birthday-badge ${badgeClass}">${badgeText}</span>
          </div>
        `;
      }).join('');
    }

    // Cargar y renderizar gráfica de actividad del dashboard
    async function loadDashboardActivityChart() {
      try {
        const res = await fetch('/api/dashboard/history', { credentials: 'include' });
        const json = await res.json();

        if (!json.success) return;

        const data = json.data;
        const canvas = document.getElementById('activity-chart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');

        // Destruir TODOS los charts previos que usen este canvas
        if (window.myActivityChart) {
          window.myActivityChart.destroy();
          window.myActivityChart = null;
        }
        if (window.activityChart) {
          window.activityChart.destroy();
          window.activityChart = null;
        }
        // También destruir por ID del chart
        const existingChart = Chart.getChart(canvas);
        if (existingChart) {
          existingChart.destroy();
        }

        window.myActivityChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.map(d => d.date),
            datasets: [
              {
                label: 'Citas',
                data: data.map(d => d.appointments),
                borderColor: '#8c9668', // Venus
                backgroundColor: 'rgba(140, 150, 104, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                yAxisID: 'y'
              },
              {
                label: 'Ingresos',
                data: data.map(d => d.income),
                borderColor: '#22c55e', // Green
                backgroundColor: 'rgba(34, 197, 94, 0.0)',
                borderWidth: 2,
                borderDash: [5, 5],
                tension: 0.4,
                fill: false,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            plugins: {
              legend: {
                labels: { color: '#e5e7eb' }
              }
            },
            scales: {
              x: {
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { color: '#e5e7eb' }
              },
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { color: '#e5e7eb', stepSize: 1 }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                grid: { drawOnChartArea: false },
                ticks: {
                  color: '#22c55e',
                  callback: function (value) { return '$' + value; }
                }
              }
            }
          }
        });

      } catch (error) {
        console.error('Error loading activity chart:', error);
      }
    }

    // Renderizar top clientes
    function renderTopClients(clients) {
      const container = document.getElementById('top-clients-sidebar');

      const sorted = [...clients]
        .map(c => ({ ...c, totalStamps: (c.stamps || 0) + ((c.cycles || 0) * 8) }))
        .sort((a, b) => b.totalStamps - a.totalStamps)
        .slice(0, 5);

      if (sorted.length === 0 || sorted[0].totalStamps === 0) {
        container.innerHTML = '<div class="dash-empty"><p>Sin datos aún</p></div>';
        return;
      }

      container.innerHTML = sorted.map((c, i) => {
        const maxStamps = 8;
        const remaining = maxStamps - c.stamps;

        return `
          <div class="top-client-item">
            <div class="top-client-rank ${i === 0 ? 'gold' : ''}">${i + 1}</div>
            <div class="top-client-info">
              <h4>${c.name}</h4>
              <p>${remaining > 0 ? remaining + ' para canjear' : '¡Listo para canjear!'}</p>
            </div>
            <div class="top-client-stamps">
              <div class="count">${c.stamps}/${maxStamps}</div>
              <div class="label">sellos</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Inicializar dashboard
    document.addEventListener('DOMContentLoaded', () => {
      updateGreeting();

      const activeTab = document.querySelector('.tab-content:not(.hidden)');
      if (activeTab && activeTab.id === 'tab-overview') {
        loadDashboardStats();
      }
    });

    window.loadDashboardStats = loadDashboardStats;

    // ========== AUTO-REFRESH DASHBOARD (cada 60 segundos) ==========
    let dashboardRefreshInterval = null;
    let lastDashboardData = null;

    function startDashboardAutoRefresh() {
      if (dashboardRefreshInterval) {
        clearInterval(dashboardRefreshInterval);
      }

      // El dashboard se actualiza automáticamente con listeners en tiempo real de Firestore
      // Solo se ejecutan cuando hay cambios reales en las citas
      console.log('[DASHBOARD] ✅ Usando listeners en tiempo real de Firestore');
    }

    function stopDashboardAutoRefresh() {
      if (dashboardRefreshInterval) {
        clearInterval(dashboardRefreshInterval);
        dashboardRefreshInterval = null;
      }
    }

    // Iniciar auto-refresh cuando se entra al tab overview
    document.addEventListener('DOMContentLoaded', () => {
      const overviewTab = document.getElementById('tab-overview');
      if (overviewTab && !overviewTab.classList.contains('hidden')) {
        startDashboardAutoRefresh();
      }
    });

    /* =========================================================
       SCANNER UNIVERSAL - FASE 3
       ========================================================= */

    let universalScanner = null;

    async function openScanner() {
      document.getElementById('scanner-modal').classList.add('active');
      document.getElementById('scanner-result').classList.remove('active');
      document.getElementById('scanner-options').style.display = 'flex';
      document.getElementById('scanner-manual').style.display = 'block';
      document.getElementById('scanner-viewport').style.display = 'block';

      // Verificar si estamos en HTTPS o localhost
      const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';

      if (!isSecure) {
        document.getElementById('scanner-hint').textContent = 'La cámara requiere conexión HTTPS. Usa el código manual.';
        return;
      }

      document.getElementById('scanner-hint').textContent = 'Preparando cámara...';

      // Pequeño delay para que se vea el modal antes de pedir permisos
      setTimeout(() => {
        startCamera();
      }, 100);
    }

    function closeScanner() {
      console.log('🔴 Cerrando scanner...');
      const modal = document.getElementById('scanner-modal');
      if (modal) {
        modal.classList.remove('active');
      }
      stopCamera();
    }

    // Agregar event listener al botón de cerrar para asegurar que funcione en móviles
    document.addEventListener('DOMContentLoaded', () => {
      const closeBtn = document.getElementById('scanner-close-btn');
      if (closeBtn) {
        console.log('✅ Event listener del scanner close agregado');

        // Agregar múltiples eventos para asegurar compatibilidad
        closeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('👆 Click en cerrar scanner');
          closeScanner();
        });

        closeBtn.addEventListener('touchend', (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('👆 Touch en cerrar scanner');
          closeScanner();
        });
      } else {
        console.error('❌ No se encontró el botón de cerrar scanner');
      }

      // Event listener para botón de permisos de cámara
      const btnRequestCamera = document.getElementById('btn-request-camera');
      if (btnRequestCamera) {
        btnRequestCamera.addEventListener('click', async () => {
          document.getElementById('scanner-permissions').style.display = 'none';
          await startCamera();
        });
      }
    });

    async function startCamera() {
      const frame = document.getElementById('scanner-frame');
      const hintEl = document.getElementById('scanner-hint');

      try {
        // Verificar si el navegador soporta getUserMedia
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('Tu navegador no soporta acceso a la cámara');
        }

        // Solicitar permisos de cámara primero
        hintEl.textContent = 'Solicitando permisos de cámara...';

        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });

        // Detener el stream temporal
        stream.getTracks().forEach(track => track.stop());

        hintEl.textContent = 'Iniciando cámara...';
        frame.style.display = 'block';

        // Crear div para el scanner si no existe
        let scannerDiv = document.getElementById('universal-qr-reader');
        if (!scannerDiv) {
          scannerDiv = document.createElement('div');
          scannerDiv.id = 'universal-qr-reader';
          scannerDiv.style.width = '100%';
          document.getElementById('scanner-viewport').appendChild(scannerDiv);
        }

        frame.style.display = 'none';

        universalScanner = new Html5Qrcode('universal-qr-reader');

        const config = {
          fps: 10,
          qrbox: { width: 220, height: 220 },
          aspectRatio: 1.0
        };

        // Intentar con cámara trasera primero
        let cameraConfig = { facingMode: 'environment' };

        try {
          await universalScanner.start(
            cameraConfig,
            config,
            (decodedText) => {
              handleScannedCode(decodedText);
            },
            (errorMessage) => {
              // Ignorar errores de escaneo continuo
            }
          );
          hintEl.textContent = 'Apunta la cámara al código QR';
        } catch (backCameraError) {
          console.log('Cámara trasera no disponible, intentando frontal...');

          // Si falla la trasera, intentar con la frontal
          cameraConfig = { facingMode: 'user' };
          await universalScanner.start(
            cameraConfig,
            config,
            (decodedText) => {
              handleScannedCode(decodedText);
            },
            (errorMessage) => {
              // Ignorar errores de escaneo continuo
            }
          );
          hintEl.textContent = 'Apunta la cámara al código QR (cámara frontal)';
        }

      } catch (error) {
        console.error('Error accessing camera:', error);

        let errorMsg = 'No se pudo acceder a la cámara.';
        let showPermissionBtn = false;

        if (error.name === 'NotAllowedError' || error.message.includes('Permission denied')) {
          errorMsg = 'Permisos de cámara denegados.';
          showPermissionBtn = true;
        } else if (error.name === 'NotFoundError') {
          errorMsg = 'No se encontró ninguna cámara en el dispositivo.';
        } else if (error.name === 'NotSupportedError') {
          errorMsg = 'Tu navegador no soporta acceso a la cámara.';
        } else if (error.message.includes('HTTPS')) {
          errorMsg = 'La cámara requiere conexión HTTPS segura.';
        }

        hintEl.textContent = errorMsg;
        frame.style.display = 'block';

        if (showPermissionBtn) {
          // Mostrar botón para solicitar permisos
          document.getElementById('scanner-permissions').style.display = 'block';
        } else {
          // Mostrar opciones manuales
          document.getElementById('scanner-options').style.display = 'flex';
          document.getElementById('scanner-manual').style.display = 'block';
        }
      }
    }

    async function stopCamera() {
      if (universalScanner) {
        try {
          await universalScanner.stop();
          universalScanner.clear();
          universalScanner = null;
        } catch (error) {
          console.error('Error stopping scanner:', error);
        }
      }
    }

    async function handleScannedCode(code) {
      stopCamera();

      document.getElementById('scanner-hint').textContent = 'Procesando...';
      document.getElementById('scanner-options').style.display = 'none';
      document.getElementById('scanner-manual').style.display = 'none';

      try {
        if (code.startsWith('VGC-')) {
          await handleGiftCardScan(code);
        } else {
          await handleLoyaltyScan(code);
        }
      } catch (error) {
        console.error('Error processing code:', error);
        document.getElementById('scanner-hint').textContent = 'Error al procesar. Intenta de nuevo.';
      }
    }

    async function handleLoyaltyScan(cardId) {
      try {
        const res = await fetch(`/api/card/${cardId}`, { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          const card = json.data;
          showScanResult('loyalty', card.name, `${card.stamps}/8 sellos`, cardId);
        } else {
          document.getElementById('scanner-hint').textContent = 'Tarjeta no encontrada';
          setTimeout(() => {
            document.getElementById('scanner-options').style.display = 'flex';
            document.getElementById('scanner-manual').style.display = 'block';
            document.getElementById('scanner-hint').textContent = 'Intenta de nuevo';
          }, 2000);
        }
      } catch (error) {
        document.getElementById('scanner-hint').textContent = 'Error de conexión';
      }
    }

    async function handleGiftCardScan(code) {
      try {
        const res = await fetch(`/api/giftcards/code/${code}`, { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          const gc = json.data;
          const statusText = gc.status === 'redeemed' ? '(Ya canjeada)' : gc.serviceName;
          showScanResult('gift', gc.recipientName || 'Gift Card', statusText, gc.id, gc.status);
        } else {
          document.getElementById('scanner-hint').textContent = 'Gift Card no encontrada';
          setTimeout(() => {
            document.getElementById('scanner-options').style.display = 'flex';
            document.getElementById('scanner-manual').style.display = 'block';
            document.getElementById('scanner-hint').textContent = 'Intenta de nuevo';
          }, 2000);
        }
      } catch (error) {
        document.getElementById('scanner-hint').textContent = 'Error de conexión';
      }
    }

    function showScanResult(type, title, subtitle, id, status) {
      const resultDiv = document.getElementById('scanner-result');
      const iconDiv = document.getElementById('scanner-result-icon');
      const actionsDiv = document.getElementById('scanner-result-actions');

      document.getElementById('scanner-result-title').textContent = title;
      document.getElementById('scanner-result-subtitle').textContent = subtitle;

      iconDiv.className = 'scanner-result-icon ' + type;
      iconDiv.innerHTML = type === 'loyalty'
        ? '<i class="fas fa-credit-card"></i>'
        : '<i class="fas fa-gift"></i>';

      if (type === 'loyalty') {
        actionsDiv.innerHTML = `
          <button class="btn primary" onclick="addStampFromScanner('${id}')">
            <i class="fas fa-star"></i> Agregar Sello
          </button>
          <button class="btn ghost" onclick="closeScanner()">Cancelar</button>
        `;
      } else {
        if (status === 'redeemed') {
          actionsDiv.innerHTML = `
            <button class="btn ghost" onclick="closeScanner()">
              <i class="fas fa-check"></i> Ya canjeada
            </button>
          `;
        } else if (status === 'expired') {
          actionsDiv.innerHTML = `
            <button class="btn ghost" onclick="closeScanner()">
              <i class="fas fa-times"></i> Expirada
            </button>
          `;
        } else {
          actionsDiv.innerHTML = `
            <button class="btn primary" onclick="redeemGiftCardFromScanner('${id}')">
              <i class="fas fa-gift"></i> Canjear
            </button>
            <button class="btn ghost" onclick="closeScanner()">Cancelar</button>
          `;
        }
      }

      document.getElementById('scanner-viewport').style.display = 'none';
      resultDiv.classList.add('active');
    }

    async function addStampFromScanner(cardId) {
      try {
        const res = await fetch(`/api/stamp/${cardId}`, {
          method: 'POST',
          credentials: 'include'
        });
        const json = await res.json();

        if (json.success || json.stamps !== undefined) {
          const clientName = json.name || 'Cliente';
          const stamps = json.stamps || 0;
          const maxStamps = json.max || 8;

          // Crear notificación
          notifySello(clientName, stamps, maxStamps);

          alert('✓ Sello agregado correctamente');
          closeScanner();
          loadDashboardStats();
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        alert('Error de conexión');
      }
    }

    async function redeemGiftCardFromScanner(giftcardId) {
      try {
        const res = await fetch(`/api/giftcards/${giftcardId}/redeem`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ redeemedBy: 'Scanner' })
        });
        const json = await res.json();

        if (json.success) {
          alert('✓ Gift Card canjeada correctamente');
          closeScanner();
          loadDashboardStats();
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        alert('Error de conexión');
      }
    }

    function showManualCodeInput() {
      const code = prompt('Ingresa el código de la tarjeta o gift card:');
      if (code && code.trim()) {
        handleScannedCode(code.trim().toUpperCase());
      }
    }

    // Cerrar scanner con ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('scanner-modal');
        if (modal && modal.classList.contains('active')) {
          closeScanner();
        }
      }
    });

    // Mobile Menu Logic - Inicializar cuando el DOM esté listo
    function initMobileMenu() {
      console.log('🔧 Inicializando menú móvil...');

      const mobileMenu = document.getElementById('mobile-menu');
      const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
      const mobileMenuClose = document.getElementById('mobile-menu-close');
      const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');

      console.log('📱 Elementos encontrados:', {
        menu: !!mobileMenu,
        toggle: !!mobileMenuToggle,
        close: !!mobileMenuClose,
        links: mobileNavLinks.length
      });

      // Cerrar menú al hacer click fuera (en el overlay)
      if (mobileMenu) {
        mobileMenu.addEventListener('click', function (e) {
          if (e.target === mobileMenu) {
            closeMobileMenu();
          }
        });
      }

      // Event listeners para los links del menú
      mobileNavLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          // Handle tab switching if it's a tab link
          const tab = link.dataset.tab;
          if (tab) {
            e.preventDefault();

            // Cerrar menú
            if (mobileMenu) {
              mobileMenu.classList.add('hidden');
              document.body.style.overflow = '';
            }

            // Actualizar navegación
            document.querySelectorAll('.nav a').forEach(a => a.classList.remove('is-active'));
            document.querySelectorAll('.mobile-nav-link').forEach(a => a.classList.remove('is-active'));
            link.classList.add('is-active');

            // Cambiar tab
            document.querySelectorAll('[id^="tab-"]').forEach(s => s.classList.add('hidden'));
            const targetId = 'tab-' + tab;
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
              targetSection.classList.remove('hidden');
            }

            // Cargar datos del tab
            if (tab === 'overview') {
              loadDashboardStats();
              if (typeof startDashboardAutoRefresh === 'function') startDashboardAutoRefresh();
            } else if (tab === 'cards') {
              loadCards(1);
            } else if (tab === 'events') {
              loadGiftCardServices();
              loadGiftCards();
            } else if (tab === 'requests') {
              loadBookingRequests();
              initAgendarUrl();
              startRequestsAutoRefresh();
            } else if (tab === 'appointments') {
              if (typeof loadAppointments === 'function') loadAppointments();
              if (typeof loadMonthStats === 'function') loadMonthStats();
              if (typeof startAppointmentsAutoRefresh === 'function') startAppointmentsAutoRefresh();
            } else if (tab === 'services') {
              loadServicesTable();
            } else if (tab === 'settings') {
              loadBusinessConfig();
              loadNotificationsHistory();
            }
          }
        });
      });
    }

    // Logout mobile
    document.getElementById('logout-mobile')?.addEventListener('click', async () => {
      try {
        await fetch('/api/admin/logout', { method: 'POST' });
        window.location.reload();
      } catch (e) { console.error(e); }
    });

    window.openScanner = openScanner;
    window.closeScanner = closeScanner;
    window.showManualCodeInput = showManualCodeInput;
    window.addStampFromScanner = addStampFromScanner;
    window.redeemGiftCardFromScanner = redeemGiftCardFromScanner;

    /* =========================================================
       SOLICITUDES DE CITAS ONLINE
       ========================================================= */

    let bookingRequests = [];

    let lastRequestsCount = 0;

    async function loadBookingRequests() {
      try {
        console.log('[REQUESTS] 📥 Cargando solicitudes...');
        const res = await fetch('/api/booking-requests', { credentials: 'include' });
        const json = await res.json();

        console.log('[REQUESTS] Respuesta:', json);

        if (json.success) {
          const newRequests = json.data || [];
          console.log(`[REQUESTS] ✅ ${newRequests.length} solicitudes cargadas`);

          // Detectar nuevas solicitudes
          if (lastRequestsCount > 0 && newRequests.length > lastRequestsCount) {
            const newCount = newRequests.length - lastRequestsCount;
            console.log(`[REQUESTS] 🆕 ${newCount} nueva(s) solicitud(es)`);

            // Mostrar notificación del navegador
            if ("Notification" in window && Notification.permission === "granted") {
              new Notification('Nueva solicitud de cita', {
                body: `${newRequests[0].clientName} quiere ${newRequests[0].serviceName}`,
                icon: '/assets/logo.png'
              });
            }
          }

          lastRequestsCount = newRequests.length;
          bookingRequests = newRequests;
          renderBookingRequests();
          updateRequestStats();
        } else {
          console.error('[REQUESTS] ❌ Error en respuesta:', json.error);
        }
      } catch (error) {
        console.error('[REQUESTS] ❌ Error loading booking requests:', error);
      }
    }

    // Auto-refresh cada 30 segundos cuando está en el tab de solicitudes
    let requestsRefreshInterval = null;

    function startRequestsAutoRefresh() {
      if (requestsRefreshInterval) return;

      // Las solicitudes se actualizan automáticamente con listeners en tiempo real de Firestore
      // Solo se ejecutan cuando hay cambios reales en las solicitudes
      console.log('[REQUESTS] ✅ Usando listeners en tiempo real de Firestore');
    }

    function stopRequestsAutoRefresh() {
      if (requestsRefreshInterval) {
        clearInterval(requestsRefreshInterval);
        requestsRefreshInterval = null;
        console.log('[REQUESTS] ⏹️ Auto-refresh detenido');
      }
    }

    function updateRequestStats() {
      const pending = bookingRequests.filter(r => r.status === 'pending').length;
      const contacted = bookingRequests.filter(r => r.status === 'contacted').length;
      const booked = bookingRequests.filter(r => r.status === 'booked').length;

      document.getElementById('req-pending').textContent = pending;
      document.getElementById('req-contacted').textContent = contacted;
      document.getElementById('req-booked').textContent = booked;
    }

    function renderBookingRequests() {
      const container = document.getElementById('requests-list');
      if (!container) return;

      if (bookingRequests.length === 0) {
        container.innerHTML = `
          <div style="text-align:center;padding:40px;" class="muted">
            <i class="fas fa-inbox" style="font-size:32px;margin-bottom:12px;display:block;opacity:0.5;"></i>
            No hay solicitudes de citas<br>
            <small style="font-size:12px;">Las solicitudes aparecerán aquí cuando las clientas agenden desde la página pública</small>
          </div>
        `;
        return;
      }

      container.innerHTML = bookingRequests.map(req => {
        const createdDate = new Date(req.createdAt);
        const createdStr = createdDate.toLocaleDateString('es-MX', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

        const desiredDate = new Date(req.date + 'T00:00:00');
        const desiredStr = desiredDate.toLocaleDateString('es-MX', { weekday: 'short', day: 'numeric', month: 'short' });
        const hour = parseInt(req.time.split(':')[0]);
        const timeStr = hour === 12 ? '12:00 PM' : hour > 12 ? `${hour - 12}:00 PM` : `${hour}:00 AM`;

        const statusConfig = {
          pending: { bg: 'rgba(251,191,36,0.15)', color: '#fbbf24', icon: 'clock', text: 'Pendiente' },
          contacted: { bg: 'rgba(59,130,246,0.15)', color: '#3b82f6', icon: 'phone', text: 'Contactada' },
          booked: { bg: 'rgba(34,197,94,0.15)', color: '#22c55e', icon: 'check-circle', text: 'Agendada' },
          rejected: { bg: 'rgba(239,68,68,0.15)', color: '#ef4444', icon: 'times-circle', text: 'Rechazada' }
        }[req.status] || { bg: 'rgba(251,191,36,0.15)', color: '#fbbf24', icon: 'clock', text: 'Pendiente' };

        const whatsappNum = req.clientPhone.startsWith('52') ? req.clientPhone : '52' + req.clientPhone;

        const actions = req.status === 'pending' ? `
          <a href="https://wa.me/+${whatsappNum}" target="_blank" class="btn small" style="background:#25D366;border-color:#25D366;" title="Abrir WhatsApp">
            <i class="fab fa-whatsapp"></i> WhatsApp
          </a>
          <button class="btn small" onclick="contactRequest('${req.id}')" title="Marcar como contactada" style="background:#3b82f6;border-color:#3b82f6;color:white;">
            <i class="fas fa-check"></i> Marcar contactada
          </button>
          <button class="btn small ghost" onclick="rejectRequest('${req.id}')" title="Rechazar solicitud" style="color:#ef4444;border-color:#ef4444;">
            <i class="fas fa-times"></i>
          </button>
        ` : req.status === 'contacted' ? `
          <a href="https://wa.me/+${whatsappNum}" target="_blank" class="btn small" style="background:#25D366;border-color:#25D366;" title="Abrir WhatsApp">
            <i class="fab fa-whatsapp"></i> WhatsApp
          </a>
          <button class="btn small primary" onclick="markAsBooked('${req.id}')" title="Marcar como agendada">
            <i class="fas fa-calendar-check"></i> Agendada
          </button>
          <button class="btn small ghost" onclick="rejectRequest('${req.id}')" title="Rechazar" style="color:#ef4444;border-color:#ef4444;">
            <i class="fas fa-times"></i>
          </button>
        ` : req.status === 'rejected' ? `
          <span class="muted" style="font-size:12px;"><i class="fas fa-times-circle"></i> Rechazada</span>
        ` : `
          <span class="muted" style="font-size:12px;"><i class="fas fa-check-circle"></i> Agendada</span>
        `;

        const statusBadge = `<span style="background:${statusConfig.bg};color:${statusConfig.color};padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600;"><i class="fas fa-${statusConfig.icon}"></i> ${statusConfig.text}</span>`;

        return `
          <tr>
            <td>${createdStr}</td>
            <td>
              <strong>${req.clientName}</strong><br>
              <small class="muted">${req.clientPhone}</small>
              ${req.isNewClient ? '<br><span style="font-size:10px;color:#22c55e;"><i class="fas fa-star"></i> Nueva</span>' : ''}
            </td>
            <td>
              ${req.serviceName}<br>
              <small class="muted">$${req.servicePrice || 0}</small>
            </td>
            <td>
              ${desiredStr}<br>
              <small class="muted">${timeStr}</small>
            </td>
            <td>${statusBadge}</td>
            <td style="white-space:nowrap;">
              <div style="display:flex;gap:6px;">
                ${actions}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function contactRequest(id) {
      try {
        const res = await fetch(`/api/booking-requests/${id}/contacted`, {
          method: 'POST',
          credentials: 'include'
        });
        const json = await res.json();
        if (json.success) {
          loadBookingRequests();
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        alert('Error de conexión');
      }
    }

    async function markAsBooked(id) {
      // Prevenir doble clic
      const btn = event?.target?.closest('button');
      if (btn && btn.disabled) return;
      if (btn) {
        btn.disabled = true;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Agendando...';
      }

      try {
        const res = await fetch(`/api/booking-requests/${id}/booked`, {
          method: 'POST',
          credentials: 'include'
        });
        const json = await res.json();
        if (json.success) {
          loadBookingRequests();

          // Recargar notificaciones inmediatamente
          if (typeof loadNotifications === 'function') {
            loadNotifications();
          }

          // Si estamos en el tab de citas, recargar
          if (typeof loadAppointments === 'function') {
            loadAppointments();
          }
          if (typeof renderWeeklyCalendar === 'function') {
            renderMonthlyCalendar();
          }

          alert('✅ Cita agendada correctamente');
        } else {
          alert('Error: ' + json.error);
          // Re-habilitar botón en caso de error
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
          }
        }
      } catch (error) {
        alert('Error de conexión');
        // Re-habilitar botón en caso de error
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalHtml;
        }
      }
    }

    async function rejectRequest(id) {
      if (!confirm('¿Rechazar esta solicitud?')) return;

      try {
        const res = await fetch(`/api/booking-requests/${id}/rejected`, {
          method: 'POST',
          credentials: 'include'
        });
        const json = await res.json();
        if (json.success) {
          loadBookingRequests();
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        alert('Error de conexión');
      }
    }

    function initAgendarUrl() {
      const urlEl = document.getElementById('agendar-url');
      if (urlEl) {
        urlEl.textContent = window.location.origin + '/agendar.html';
      }
    }

    function copyAgendarUrl() {
      const url = window.location.origin + '/agendar.html';
      navigator.clipboard.writeText(url).then(() => {
        alert('✅ URL copiada al portapapeles');
      }).catch(() => {
        prompt('Copia esta URL:', url);
      });
    }

    async function deleteAllRequests() {
      if (!confirm('⚠️ ¿Estás seguro de que quieres BORRAR TODAS las solicitudes?\n\nEsta acción no se puede deshacer.')) return;

      const code = prompt('Para confirmar, escribe "BORRAR":');
      if (code !== 'BORRAR') return;

      try {
        const res = await fetch('/api/booking-requests', {
          method: 'DELETE',
          credentials: 'include'
        });
        const json = await res.json();
        if (json.success) {
          alert('✅ Todas las solicitudes han sido eliminadas');
          loadBookingRequests();
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        alert('Error de conexión');
      }
    }

    window.loadBookingRequests = loadBookingRequests;
    window.contactRequest = contactRequest;
    window.markAsBooked = markAsBooked;
    window.rejectRequest = rejectRequest;
    window.deleteAllRequests = deleteAllRequests;
    window.copyAgendarUrl = copyAgendarUrl;

    /* =========================================================
       CONFIGURACIÓN DEL NEGOCIO
       ========================================================= */

    async function loadBusinessConfig() {
      try {
        const res = await fetch('/api/settings/business');
        const json = await res.json();

        if (json.success && json.data) {
          const d = json.data;
          document.getElementById('biz-name').value = d.businessName || '';
          document.getElementById('biz-whatsapp').value = d.whatsappBusiness || '';

          // Actualizar dirección en ambos lugares
          document.getElementById('biz-address').value = d.address || '';
          const autocompleteEl = document.getElementById('biz-address-autocomplete');
          if (autocompleteEl) autocompleteEl.value = d.address || '';

          document.getElementById('biz-maps-url').value = d.mapsUrl || '';
          document.getElementById('biz-open').value = d.openTime || '09:00';
          document.getElementById('biz-close').value = d.closeTime || '19:00';

          // Días de trabajo
          const workDays = d.workDays || [1, 2, 3, 4, 5, 6];
          for (let i = 0; i <= 6; i++) {
            const cb = document.getElementById(`biz-day-${i}`);
            if (cb) cb.checked = workDays.includes(i);
          }
        }
      } catch (error) {
        console.error('Error loading business config:', error);
      }
    }

    // Inicializar Google Places Autocomplete con el nuevo componente web
    let autocompleteInitialized = false;
    let selectedPlaceData = null;

    window.initAddressAutocomplete = function () {
      if (autocompleteInitialized) return;

      const autocompleteElement = document.getElementById('biz-address-autocomplete');
      const hiddenInput = document.getElementById('biz-address');

      if (!autocompleteElement) {
        console.log('[MAPS] Componente de autocomplete no encontrado');
        return;
      }

      // Verificar si Google Maps API está cargada
      if (typeof google === 'undefined' || !google.maps) {
        console.log('[MAPS] API no disponible aún, reintentando...');
        setTimeout(initAddressAutocomplete, 500);
        return;
      }

      try {
        // Configurar el componente web
        autocompleteElement.componentRestrictions = { country: 'mx' };
        autocompleteElement.types = ['address'];

        // Escuchar evento de selección de lugar
        autocompleteElement.addEventListener('gmp-placeselect', async (event) => {
          const place = event.detail.place;

          if (!place) {
            console.warn('[MAPS] No se recibió información del lugar');
            return;
          }

          try {
            // Obtener detalles completos del lugar
            await place.fetchFields({ fields: ['displayName', 'formattedAddress', 'location'] });

            selectedPlaceData = place;

            // Actualizar campo oculto con la dirección
            const address = place.formattedAddress || place.displayName;
            hiddenInput.value = address;

            // Generar URL de Google Maps con coordenadas
            if (place.location) {
              const lat = place.location.lat();
              const lng = place.location.lng();
              const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;

              document.getElementById('biz-maps-url').value = mapsUrl;

              console.log('[MAPS] Dirección seleccionada:', {
                address: address,
                lat: lat,
                lng: lng
              });
            }
          } catch (error) {
            console.error('[MAPS] Error obteniendo detalles del lugar:', error);
          }
        });

        autocompleteInitialized = true;
        console.log('[MAPS] Autocomplete (nuevo componente web) inicializado correctamente');
      } catch (error) {
        console.error('[MAPS] Error inicializando autocomplete:', error);
      }
    };

    // Intentar inicializar cuando la página cargue
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initAddressAutocomplete, 1000);
      });
    } else {
      setTimeout(initAddressAutocomplete, 1000);
    }

    // Botón de búsqueda manual (fallback si no funciona autocomplete)
    document.getElementById('btn-search-address')?.addEventListener('click', () => {
      const address = document.getElementById('biz-address').value.trim();

      if (!address) {
        alert('⚠️ Por favor escribe una dirección');
        return;
      }

      // Generar URL de búsqueda simple
      const encodedAddress = encodeURIComponent(address);
      const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
      document.getElementById('biz-maps-url').value = mapsUrl;

      alert('✅ URL de Maps generada. Recuerda guardar la configuración.');
    });

    document.getElementById('business-config-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const workDays = [];
      for (let i = 0; i <= 6; i++) {
        const cb = document.getElementById(`biz-day-${i}`);
        if (cb && cb.checked) workDays.push(i);
      }

      const data = {
        businessName: document.getElementById('biz-name').value,
        whatsappBusiness: document.getElementById('biz-whatsapp').value,
        address: document.getElementById('biz-address').value,
        mapsUrl: document.getElementById('biz-maps-url').value,
        openTime: document.getElementById('biz-open').value,
        closeTime: document.getElementById('biz-close').value,
        workDays
      };

      try {
        const res = await fetch('/api/settings/business', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        const json = await res.json();

        if (json.success) {
          const successEl = document.getElementById('biz-success');
          successEl.classList.remove('hidden');
          setTimeout(() => successEl.classList.add('hidden'), 3000);
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        alert('Error de conexión');
      }
    });

    window.loadBusinessConfig = loadBusinessConfig;

    /* =========================================================
       SISTEMA DE NOTIFICACIONES - CAMPANA
       ========================================================= */

    let notifications = [];
    let unreadCount = 0;

    // Tipos de notificación con iconos
    const NOTIF_TYPES = {
      CITA_NUEVA: { type: 'cita', icon: 'calendar-plus', title: 'Nueva cita' },
      CITA_CONFIRMADA: { type: 'cita', icon: 'calendar-check', title: 'Cita confirmada' },
      CITA_CANCELADA: { type: 'alerta', icon: 'calendar-times', title: 'Cita cancelada' },
      VENTA: { type: 'venta', icon: 'receipt', title: 'Venta completada' },
      TARJETA_NUEVA: { type: 'tarjeta', icon: 'credit-card', title: 'Nueva tarjeta' },
      SELLO: { type: 'sello', icon: 'star', title: 'Sello agregado' },
      TARJETA_COMPLETA: { type: 'sello', icon: 'award', title: '¡Tarjeta completa!' },
      GIFTCARD_NUEVA: { type: 'giftcard', icon: 'gift', title: 'Gift card creada' },
      GIFTCARD_CANJEADA: { type: 'giftcard', icon: 'box-open', title: 'Gift card canjeada' },
      CUMPLE: { type: 'cumple', icon: 'birthday-cake', title: '¡Cumpleaños!' }
    };

    async function initNotifications() {
      console.log('[NOTIF] 🔔 Inicializando sistema de notificaciones...');
      await loadNotifications();
      // Las notificaciones se actualizan automáticamente con listeners en tiempo real de Firestore
      checkBirthdays();
      console.log('[NOTIF] ✅ Sistema de notificaciones iniciado con listeners en tiempo real');
    }

    async function loadNotifications() {
      try {
        console.log('[NOTIF] 📥 Cargando notificaciones...');
        const res = await fetch('/api/notifications?limit=30', { credentials: 'include' });
        const json = await res.json();

        console.log('[NOTIF] Respuesta:', json);

        if (json.success) {
          notifications = json.data || [];
          unreadCount = notifications.filter(n => !n.read).length;
          console.log(`[NOTIF] ✅ ${notifications.length} notificaciones cargadas, ${unreadCount} no leídas`);
          updateBadge();
          renderNotifications();
        } else {
          console.error('[NOTIF] ❌ Error en respuesta:', json.error);
        }
      } catch (error) {
        console.error('[NOTIF] ❌ Error loading notifications:', error);
      }
    }

    async function checkNewNotifications() {
      try {
        const lastId = notifications[0]?.id || '';
        const res = await fetch(`/api/notifications/new?after=${lastId}`, { credentials: 'include' });
        const json = await res.json();

        if (json.success && json.data?.length > 0) {
          notifications = [...json.data, ...notifications];
          unreadCount += json.data.length;
          updateBadge();
          renderNotifications();

          // Mostrar notificaciones de navegador
          if ("Notification" in window && Notification.permission === "granted") {
            json.data.forEach(n => {
              new Notification(n.title, {
                body: n.message,
                icon: '/assets/icon.png' // Fallback icon if available
              });
            });
          }
        }
      } catch (error) {
        console.error('Error checking notifications:', error);
      }
    }

    function toggleNotifications(e) {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }

      // Solicitar permiso si aún no se tiene
      if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
      }

      const dropdown = document.getElementById('notif-dropdown');
      dropdown?.classList.toggle('active');

      if (dropdown?.classList.contains('active')) {
        renderNotifications();
      }
    }

    // Event listeners para botones de notificaciones
    function initNotificationButtons() {
      console.log('[NOTIF] 🔘 Inicializando botones de notificaciones...');

      const notifBtnDesktop = document.getElementById('notif-btn-desktop');
      const notifBtnMobile = document.getElementById('notif-btn-mobile');
      const btnMarkAllRead = document.getElementById('btn-mark-all-read');
      const btnClearAll = document.getElementById('btn-clear-all-notif');

      console.log('[NOTIF] Elementos encontrados:', {
        desktop: !!notifBtnDesktop,
        mobile: !!notifBtnMobile,
        markRead: !!btnMarkAllRead,
        clearAll: !!btnClearAll
      });

      if (notifBtnDesktop) {
        console.log('[NOTIF] ✅ Configurando botón desktop');
        notifBtnDesktop.addEventListener('click', (e) => {
          console.log('[NOTIF] 👆 Click en campana desktop');
          toggleNotifications(e);
        });
      } else {
        console.error('[NOTIF] ❌ No se encontró botón desktop');
      }

      if (notifBtnMobile) {
        console.log('[NOTIF] ✅ Configurando botón móvil');
        // Para móvil, solo usar click - el navegador maneja el touch automáticamente
        notifBtnMobile.addEventListener('click', (e) => {
          console.log('[NOTIF] 👆 Click en campana móvil');
          e.preventDefault();
          e.stopPropagation();
          toggleNotifications(e);
        });
      } else {
        console.warn('[NOTIF] ⚠️ No se encontró botón móvil');
      }

      if (btnMarkAllRead) {
        btnMarkAllRead.addEventListener('click', (e) => {
          e.preventDefault();
          markAllRead();
        });
      }

      if (btnClearAll) {
        btnClearAll.addEventListener('click', (e) => {
          e.preventDefault();
          clearAllNotifications();
        });
      }

      console.log('[NOTIF] ✅ Botones inicializados correctamente');
    }

    document.addEventListener('click', (e) => {
      const wrapper = e.target.closest('.notification-wrapper');
      if (!wrapper) {
        document.getElementById('notif-dropdown')?.classList.remove('active');
      }
    });

    function updateBadge() {
      const badge = document.getElementById('notif-badge');
      const badgeMobile = document.getElementById('notif-badge-mobile');
      const count = unreadCount > 99 ? '99+' : unreadCount;

      if (badge) {
        badge.textContent = count;
        badge.classList.toggle('hidden', unreadCount === 0);
      }

      if (badgeMobile) {
        badgeMobile.textContent = count;
        badgeMobile.classList.toggle('hidden', unreadCount === 0);
      }
    }

    function renderNotifications() {
      const list = document.getElementById('notif-list');
      if (!list) return;

      if (notifications.length === 0) {
        list.innerHTML = `
          <div class="notification-empty">
            <i class="fas fa-bell-slash"></i>
            <p>No hay notificaciones</p>
          </div>
        `;
        return;
      }

      list.innerHTML = notifications.slice(0, 20).map(n => `
        <div class="notification-item ${n.read ? '' : 'unread'}" onclick="clickNotification('${n.id}')">
          <div class="notification-icon ${n.type}">
            <i class="fas fa-${n.icon}"></i>
          </div>
          <div class="notification-content">
            <div class="notification-title">
              ${n.title}
              ${!n.read ? '<span class="new-tag">Nuevo</span>' : ''}
            </div>
            <div class="notification-message">${n.message}</div>
            <div class="notification-time">${timeAgo(n.createdAt)}</div>
          </div>
        </div>
      `).join('');
    }

    function timeAgo(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const secs = Math.floor((now - date) / 1000);

      if (secs < 60) return 'Ahora';
      if (secs < 3600) return `Hace ${Math.floor(secs / 60)} min`;
      if (secs < 86400) return `Hace ${Math.floor(secs / 3600)} hrs`;
      if (secs < 604800) return `Hace ${Math.floor(secs / 86400)} días`;
      return date.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
    }

    async function clickNotification(id) {
      const notif = notifications.find(n => n.id === id);

      if (notif && !notif.read) {
        notif.read = true;
        unreadCount = Math.max(0, unreadCount - 1);
        updateBadge();
        renderNotifications();
        fetch(`/api/notifications/${id}/read`, { method: 'POST', credentials: 'include' });
      }

      document.getElementById('notif-dropdown')?.classList.remove('active');
    }

    async function markAllRead() {
      try {
        await fetch('/api/notifications/read-all', { method: 'POST', credentials: 'include' });
        notifications.forEach(n => n.read = true);
        unreadCount = 0;
        updateBadge();
        renderNotifications();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function clearAllNotifications() {
      if (!confirm('¿Eliminar todas las notificaciones?')) return;

      try {
        await fetch('/api/notifications/clear', { method: 'DELETE', credentials: 'include' });
        notifications = [];
        unreadCount = 0;
        updateBadge();
        renderNotifications();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function createNotification(typeKey, message, entityId = null) {
      const config = NOTIF_TYPES[typeKey];
      if (!config) return;

      const data = {
        type: config.type,
        icon: config.icon,
        title: config.title,
        message: message,
        entityId: entityId
      };

      try {
        const res = await fetch('/api/notifications', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });

        const json = await res.json();

        if (json.success) {
          notifications.unshift(json.data);
          unreadCount++;
          updateBadge();
        }
      } catch (error) {
        console.error('Error creating notification:', error);
      }
    }

    function notifyCitaNueva(clientName, serviceName, date, time) {
      createNotification('CITA_NUEVA', `${clientName} - ${serviceName} (${date} ${time})`);
    }

    function notifyCitaConfirmada(clientName, serviceName) {
      createNotification('CITA_CONFIRMADA', `${clientName} confirmó ${serviceName}`);
    }

    function notifyCitaCancelada(clientName, serviceName) {
      createNotification('CITA_CANCELADA', `${clientName} canceló ${serviceName}`);
    }

    function notifyVenta(clientName, total) {
      createNotification('VENTA', `$${total.toLocaleString()} - ${clientName}`);
    }

    function notifyTarjetaNueva(clientName) {
      createNotification('TARJETA_NUEVA', `Nueva tarjeta para ${clientName}`);
    }

    function notifySello(clientName, stamps, maxStamps = 8) {
      const remaining = maxStamps - stamps;
      if (remaining <= 0) {
        createNotification('TARJETA_COMPLETA', `${clientName} completó su tarjeta 🎉`);
      } else {
        createNotification('SELLO', `${clientName} tiene ${stamps}/${maxStamps} sellos`);
      }
    }

    function notifyGiftCardNueva(serviceName, recipientName) {
      createNotification('GIFTCARD_NUEVA', `${serviceName} para ${recipientName}`);
    }

    function notifyGiftCardCanjeada(serviceName, recipientName) {
      createNotification('GIFTCARD_CANJEADA', `${recipientName} canjeó ${serviceName}`);
    }

    async function checkBirthdays() {
      try {
        const res = await fetch('/api/admin/cards-firebase', { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          const today = new Date();
          const todayMD = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

          const birthdays = (json.data?.items || []).filter(c => {
            if (!c.birthdate) return false;
            const parts = c.birthdate.split('-');
            const bday = `${parts[1]}-${parts[2]}`;
            return bday === todayMD;
          });

          const notifiedKey = `birthdays_${today.toISOString().split('T')[0]}`;
          if (localStorage.getItem(notifiedKey)) return;

          birthdays.forEach(c => {
            createNotification('CUMPLE', `¡${c.name} cumple años hoy! 🎂`);
          });

          if (birthdays.length > 0) {
            localStorage.setItem(notifiedKey, 'true');
          }
        }
      } catch (error) {
        console.error('Error checking birthdays:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Inicializar Firebase y listeners en tiempo real
      initFirebase();

      // Inicializar menú móvil
      initMobileMenu();

      // Inicializar botones de notificaciones
      initNotificationButtons();

      // Inicializar notificaciones
      setTimeout(initNotifications, 1000);
    });

    window.toggleNotifications = toggleNotifications;
    window.markAllRead = markAllRead;
    window.clearAllNotifications = clearAllNotifications;
    window.clickNotification = clickNotification;
    window.createNotification = createNotification;
    window.notifyCitaNueva = notifyCitaNueva;
    window.notifyCitaConfirmada = notifyCitaConfirmada;
    window.notifyCitaCancelada = notifyCitaCancelada;
    window.notifyVenta = notifyVenta;
    window.notifyTarjetaNueva = notifyTarjetaNueva;
    window.notifySello = notifySello;
    window.notifyGiftCardNueva = notifyGiftCardNueva;
    window.notifyGiftCardCanjeada = notifyGiftCardCanjeada;

  </script>

  <!-- Botones flotantes -->
  <div class="quick-actions">
    <button class="quick-action-btn scanner" title="Escanear QR" onclick="openScanner()">
      <i class="fas fa-qrcode"></i>
    </button>
    <button class="quick-action-btn" style="background:#10b981;" title="Nueva Venta" onclick="openDirectSaleModal()">
      <i class="fas fa-shopping-cart"></i>
    </button>
    <button class="quick-action-btn primary" title="Nueva cita" onclick="openNewAppointmentModal()">
      <i class="fas fa-plus"></i>
    </button>
  </div>

  <!-- Modal Scanner Universal -->
  <div class="scanner-modal" id="scanner-modal">
    <div class="scanner-content">
      <button class="scanner-close" id="scanner-close-btn" aria-label="Cerrar scanner">
        <i class="fas fa-times"></i>
      </button>

      <div class="scanner-header">
        <h2><i class="fas fa-qrcode"></i> Escanear QR</h2>
        <p>Tarjetas de lealtad o Gift Cards</p>
      </div>

      <div class="scanner-viewport" id="scanner-viewport">
        <video id="scanner-video" class="scanner-video" playsinline></video>
        <div class="scanner-frame" id="scanner-frame">
          <div class="scanner-corner tl"></div>
          <div class="scanner-corner tr"></div>
          <div class="scanner-corner bl"></div>
          <div class="scanner-corner br"></div>
          <div class="scanner-line"></div>
        </div>
        <p class="scanner-hint" id="scanner-hint">Apunta la cámara al código QR</p>

        <!-- Botón para solicitar permisos -->
        <div class="scanner-permissions" id="scanner-permissions"
          style="display: none; text-align: center; padding: 20px;">
          <button class="btn primary" id="btn-request-camera" style="margin-bottom: 10px;">
            <i class="fas fa-camera"></i> Permitir acceso a cámara
          </button>
          <p style="font-size: 12px; color: #999;">
            Necesitamos acceso a tu cámara para escanear códigos QR
          </p>
        </div>
      </div>

      <div class="scanner-result" id="scanner-result">
        <div class="scanner-result-icon" id="scanner-result-icon">
          <i class="fas fa-credit-card"></i>
        </div>
        <h3 id="scanner-result-title">Cliente encontrado</h3>
        <p class="subtitle" id="scanner-result-subtitle">-</p>
        <div class="scanner-result-actions" id="scanner-result-actions">
          <!-- Botones dinámicos -->
        </div>
      </div>

      <div class="scanner-options" id="scanner-options">
        <div class="scanner-option">
          <div class="scanner-option-icon loyalty">
            <i class="fas fa-credit-card"></i>
          </div>
          <div class="scanner-option-info">
            <h4>Tarjeta de Lealtad</h4>
            <p>Agregar sello (+1)</p>
          </div>
        </div>
        <div class="scanner-option">
          <div class="scanner-option-icon gift">
            <i class="fas fa-gift"></i>
          </div>
          <div class="scanner-option-info">
            <h4>Gift Card</h4>
            <p>Canjear servicio</p>
          </div>
        </div>
      </div>

      <div class="scanner-manual" id="scanner-manual">
        <p>¿No funciona la cámara?</p>
        <button class="btn ghost" style="width:100%;" onclick="showManualCodeInput()">
          <i class="fas fa-keyboard"></i> Ingresar código manual
        </button>
      </div>
    </div>
  </div>

  <!-- Google Places API - Se carga dinámicamente con la API key del servidor -->
  <script>
    // Cargar Google Maps API con la key del servidor (usando loading=async)
    async function loadGoogleMapsAPI() {
      try {
        const res = await fetch('/api/config/maps-key', { credentials: 'include' });
        const json = await res.json();

        if (json.success && json.apiKey) {
          const script = document.createElement('script');
          // Usar v=beta para acceder a los nuevos componentes web
          script.src = `https://maps.googleapis.com/maps/api/js?key=${json.apiKey}&libraries=places,marker&v=beta&language=es&region=MX&loading=async`;
          script.async = true;
          script.defer = true;
          script.onload = () => {
            console.log('[MAPS] API cargada correctamente');
            if (window.initAddressAutocomplete) {
              window.initAddressAutocomplete();
            }
          };
          document.head.appendChild(script);
        } else {
          console.warn('[MAPS] No se encontró API key de Google Maps');
        }
      } catch (error) {
        console.error('[MAPS] Error cargando API key:', error);
      }
    }

    // Cargar la API cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadGoogleMapsAPI);
    } else {
      loadGoogleMapsAPI();
    }

    // ========== SECCIÓN DE REPORTES DE VENTAS ==========

    let reportData = [];

    // Cargar servicios en el filtro cuando se entre a la pestaña de reportes
    document.addEventListener('DOMContentLoaded', () => {
      // Detectar cuando se abre la pestaña de reportes
      const reportLink = document.querySelector('a[data-tab="reports"]');
      if (reportLink) {
        reportLink.addEventListener('click', async () => {
          await cargarServiciosReporte();
          // Establecer fechas por defecto (último mes)
          const hoy = new Date();
          const hace30Dias = new Date();
          hace30Dias.setDate(hoy.getDate() - 30);
          document.getElementById('filter-date-from').value = hace30Dias.toISOString().split('T')[0];
          document.getElementById('filter-date-to').value = hoy.toISOString().split('T')[0];
        });
      }
    });

    async function cargarServiciosReporte() {
      try {
        const res = await fetch('/api/services', { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          const servicios = json.data || [];
          const select = document.getElementById('filter-service');
          select.innerHTML = '<option value="">Todos</option>';

          servicios.forEach(s => {
            const option = document.createElement('option');
            option.value = s.id;
            option.textContent = s.name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('[REPORTS] Error cargando servicios:', error);
      }
    }

    async function initReportsTab() {
      console.log('[REPORTS] Inicializando tab de reportes');

      // Cargar servicios para el dropdown
      await cargarServiciosReporte();

      // Establecer fechas por defecto (mes actual)
      const hoy = new Date();
      const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);

      document.getElementById('filter-date-from').value = primerDiaMes.toISOString().split('T')[0];
      document.getElementById('filter-date-to').value = hoy.toISOString().split('T')[0];

      console.log('[REPORTS] Tab inicializado. Listo para aplicar filtros.');
    }

    async function aplicarFiltrosReporte() {
      try {
        const dateFrom = document.getElementById('filter-date-from').value;
        const dateTo = document.getElementById('filter-date-to').value;

        if (!dateFrom || !dateTo) {
          alert('⚠️ Por favor selecciona un rango de fechas');
          return;
        }

        console.log('[REPORTS] Cargando ventas desde', dateFrom, 'hasta', dateTo);

        // Convertir fechas a ISO con timezone de México
        const fromISO = `${dateFrom}T00:00:00-06:00`;
        const toISO = `${dateTo}T23:59:59-06:00`;

        console.log('[REPORTS] URL:', `/api/appointments/range?from=${fromISO}&to=${toISO}`);

        // Cargar todas las citas completadas en el rango
        const res = await fetch(`/api/appointments/range?from=${fromISO}&to=${toISO}`, { credentials: 'include' });
        console.log('[REPORTS] Fetch completado. Status:', res.status, res.statusText);

        const json = await res.json();
        console.log('[REPORTS] JSON recibido:', json);

        if (!json.success) {
          console.error('[REPORTS] Error en respuesta:', json.error);
          alert('❌ Error cargando datos: ' + (json.error || 'Desconocido'));
          return;
        }

        const allAppointments = json.data || [];
        console.log('[REPORTS] Total de citas recibidas:', allAppointments.length);

        // Debug: Ver el estado de las primeras 5 citas
        allAppointments.slice(0, 5).forEach((a, i) => {
          console.log(`[REPORTS] Cita ${i + 1}:`, {
            id: a.id,
            clientName: a.clientName,
            status: a.status,
            totalPaid: a.totalPaid,
            paymentMethod: a.paymentMethod,
            startDateTime: a.startDateTime
          });
        });

        // Filtrar solo las citas completadas con pago
        let ventas = allAppointments.filter(a => {
          const isCompleted = a.status === 'completed';
          const hasTotalPaid = !!a.totalPaid;
          const hasPaymentMethod = !!a.paymentMethod;

          if (!isCompleted || !hasTotalPaid || !hasPaymentMethod) {
            console.log('[REPORTS] Cita excluida:', {
              id: a.id,
              clientName: a.clientName,
              isCompleted,
              hasTotalPaid,
              hasPaymentMethod
            });
          }

          return isCompleted && hasTotalPaid && hasPaymentMethod;
        });

        console.log('[REPORTS] Citas completadas con pago:', ventas.length);

        // Aplicar filtros adicionales
        const paymentFilter = document.getElementById('filter-payment-method').value;
        const serviceFilter = document.getElementById('filter-service').value;

        console.log('[REPORTS] Filtros adicionales:', { paymentFilter, serviceFilter });

        if (paymentFilter) {
          const before = ventas.length;
          ventas = ventas.filter(v => v.paymentMethod === paymentFilter);
          console.log(`[REPORTS] Filtro de método de pago: ${before} → ${ventas.length}`);
        }

        if (serviceFilter) {
          const before = ventas.length;
          ventas = ventas.filter(v => v.serviceId === serviceFilter);
          console.log(`[REPORTS] Filtro de servicio: ${before} → ${ventas.length}`);
        }

        console.log('[REPORTS] Total final de ventas:', ventas.length);

        reportData = ventas;
        renderizarReporte(ventas);
      } catch (error) {
        console.error('[REPORTS] ❌ Error capturado:', error);
        console.error('[REPORTS] Error name:', error.name);
        console.error('[REPORTS] Error message:', error.message);
        console.error('[REPORTS] Error stack:', error.stack);
        alert('❌ Error al cargar el reporte: ' + error.message);
      }
    }

    function renderizarReporte(ventas) {
      console.log('[REPORTS] Renderizando reporte con', ventas.length, 'ventas');

      // Calcular estadísticas
      let totalGeneral = 0;
      let totalEfectivo = 0;
      let totalTarjeta = 0;
      let totalTransferencia = 0;
      let countEfectivo = 0;
      let countTarjeta = 0;
      let countTransferencia = 0;

      ventas.forEach(v => {
        const amount = parseFloat(v.totalPaid) || 0;
        totalGeneral += amount;

        switch (v.paymentMethod) {
          case 'efectivo':
            totalEfectivo += amount;
            countEfectivo++;
            break;
          case 'tarjeta':
            totalTarjeta += amount;
            countTarjeta++;
            break;
          case 'transferencia':
            totalTransferencia += amount;
            countTransferencia++;
            break;
        }
      });

      // Actualizar estadísticas
      document.getElementById('report-total-sales').textContent = '$' + totalGeneral.toFixed(2);
      document.getElementById('report-sales-count').textContent = `${ventas.length} ventas`;

      document.getElementById('report-cash-total').textContent = '$' + totalEfectivo.toFixed(2);
      document.getElementById('report-cash-count').textContent = `${countEfectivo} ventas`;

      document.getElementById('report-card-total').textContent = '$' + totalTarjeta.toFixed(2);
      document.getElementById('report-card-count').textContent = `${countTarjeta} ventas`;

      document.getElementById('report-transfer-total').textContent = '$' + totalTransferencia.toFixed(2);
      document.getElementById('report-transfer-count').textContent = `${countTransferencia} ventas`;

      // Renderizar tabla
      const tbody = document.getElementById('report-sales-tbody');

      if (ventas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="muted" style="text-align:center;padding:40px;">No se encontraron ventas en este período</td></tr>';
        return;
      }

      tbody.innerHTML = ventas.map((v, index) => {
        const fecha = new Date(v.paidAt || v.startDateTime);
        const fechaStr = fecha.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' });

        const productsSold = v.productsSold || [];
        const productosCount = productsSold.length;
        const productosQty = productsSold.reduce((sum, p) => sum + (p.qty || 1), 0);

        // Crear HTML de productos para el tooltip/expandible
        let productosHtml = '-';
        if (productosCount > 0) {
          const productosListHtml = productsSold.map(p =>
            `<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.1);">
              <span>${p.name}</span>
              <span style="color:#a78bfa;font-weight:600;">×${p.qty} = $${(p.price * p.qty).toLocaleString()}</span>
            </div>`
          ).join('');

          productosHtml = `
            <div class="productos-cell" style="position:relative;">
              <button onclick="toggleProductosDetail(${index})" style="
                background:#8b5cf6;
                color:white;
                border:none;
                padding:4px 10px;
                border-radius:6px;
                font-size:11px;
                font-weight:600;
                cursor:pointer;
                display:flex;
                align-items:center;
                gap:4px;
              ">
                📦 ${productosQty} <i class="fas fa-chevron-down" style="font-size:9px;"></i>
              </button>
              <div id="productos-detail-${index}" class="productos-detail-popup" style="
                display:none;
                position:absolute;
                top:100%;
                left:0;
                z-index:100;
                background:#1a1b18;
                border:1px solid rgba(139,92,246,0.3);
                border-radius:10px;
                padding:12px;
                min-width:250px;
                box-shadow:0 10px 25px rgba(0,0,0,0.4);
                margin-top:4px;
              ">
                <div style="font-size:12px;font-weight:600;margin-bottom:8px;color:#a78bfa;">
                  <i class="fas fa-shopping-bag"></i> Productos Vendidos
                </div>
                ${productosListHtml}
                <div style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1);font-weight:600;text-align:right;color:#22c55e;">
                  Total: $${productsSold.reduce((sum, p) => sum + (p.price * p.qty), 0).toLocaleString()}
                </div>
              </div>
            </div>
          `;
        }

        const descuento = parseFloat(v.discountAmount) || 0;
        const descuentoText = descuento > 0 ? `$${descuento.toFixed(2)}` : '-';

        return `
          <tr>
            <td data-label="Fecha">${fechaStr}</td>
            <td data-label="Cliente">${v.clientName || 'Sin nombre'}</td>
            <td data-label="Servicio">${v.serviceName || '-'}</td>
            <td data-label="Método">
              <span style="
                display:inline-block;
                padding:4px 8px;
                border-radius:6px;
                font-size:11px;
                font-weight:500;
                background:${v.paymentMethod === 'efectivo' ? '#dcfce7' : v.paymentMethod === 'tarjeta' ? '#dbeafe' : '#f3e8ff'};
                color:${v.paymentMethod === 'efectivo' ? '#166534' : v.paymentMethod === 'tarjeta' ? '#1e40af' : '#6b21a8'};
              ">${v.paymentMethod || '-'}</span>
            </td>
            <td data-label="Productos">${productosHtml}</td>
            <td data-label="Descuento">${descuentoText}</td>
            <td data-label="Total" style="font-weight:600;">$${parseFloat(v.totalPaid).toFixed(2)}</td>
          </tr>
        `;
      }).join('');

      console.log('[REPORTS] Reporte renderizado correctamente');
    }

    function limpiarFiltrosReporte() {
      document.getElementById('filter-date-from').value = '';
      document.getElementById('filter-date-to').value = '';
      document.getElementById('filter-payment-method').value = '';
      document.getElementById('filter-service').value = '';

      reportData = [];

      document.getElementById('report-total-sales').textContent = '$0.00';
      document.getElementById('report-sales-count').textContent = '0 ventas';
      document.getElementById('report-cash-total').textContent = '$0.00';
      document.getElementById('report-cash-count').textContent = '0 ventas';
      document.getElementById('report-card-total').textContent = '$0.00';
      document.getElementById('report-card-count').textContent = '0 ventas';
      document.getElementById('report-transfer-total').textContent = '$0.00';
      document.getElementById('report-transfer-count').textContent = '0 ventas';

      const tbody = document.getElementById('report-sales-tbody');
      tbody.innerHTML = '<tr><td colspan="7" class="muted" style="text-align:center;padding:40px;">Selecciona un rango de fechas y haz clic en "Aplicar Filtros"</td></tr>';
    }

    // Función para mostrar/ocultar detalle de productos en reportes
    function toggleProductosDetail(index) {
      const popup = document.getElementById('productos-detail-' + index);
      if (!popup) return;

      // Cerrar otros popups abiertos
      document.querySelectorAll('.productos-detail-popup').forEach(p => {
        if (p.id !== 'productos-detail-' + index) {
          p.style.display = 'none';
        }
      });

      // Toggle el popup actual
      popup.style.display = popup.style.display === 'none' ? 'block' : 'none';
    }

    // Cerrar popups al hacer clic fuera
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.productos-cell')) {
        document.querySelectorAll('.productos-detail-popup').forEach(p => {
          p.style.display = 'none';
        });
      }
    });

    window.toggleProductosDetail = toggleProductosDetail;

    function exportarVentas() {
      if (reportData.length === 0) {
        alert('⚠️ No hay datos para exportar. Primero aplica los filtros.');
        return;
      }

      try {
        // Crear CSV
        const headers = ['Fecha', 'Cliente', 'Teléfono', 'Servicio', 'Método Pago', 'Productos', 'Descuento', 'Total'];
        const rows = reportData.map(v => {
          const fecha = new Date(v.paidAt || v.startDateTime);
          const fechaStr = fecha.toLocaleDateString('es-MX');

          const productosCount = (v.productsSold || []).length;
          const descuento = parseFloat(v.discountAmount) || 0;

          return [
            fechaStr,
            v.clientName || 'Sin nombre',
            v.clientPhone || '',
            v.serviceName || '',
            v.paymentMethod || '',
            productosCount,
            descuento.toFixed(2),
            parseFloat(v.totalPaid).toFixed(2)
          ];
        });

        // Convertir a CSV
        const csvContent = [
          headers.join(','),
          ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
        ].join('\n');

        // Descargar
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        const dateFrom = document.getElementById('filter-date-from').value;
        const dateTo = document.getElementById('filter-date-to').value;

        link.setAttribute('href', url);
        link.setAttribute('download', `reporte-ventas-${dateFrom}-${dateTo}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        console.log('[REPORTS] CSV exportado correctamente');
      } catch (error) {
        console.error('[REPORTS] Error exportando:', error);
        alert('❌ Error al exportar: ' + error.message);
      }
    }

    // ===== EXPORTAR A EXCEL FORMATO VENTAS VENUS =====
    async function exportarVentasExcel() {
      if (reportData.length === 0) {
        alert('⚠️ No hay datos para exportar. Primero selecciona un mes.');
        return;
      }

      try {
        // Cargar librería SheetJS si no está cargada
        if (typeof XLSX === 'undefined') {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }

        const { year, month } = currentReportMonth;
        const mesNombre = MESES[month];
        const sheetName = `${mesNombre} ${year}`;

        // Calcular totales
        let totalIngresos = 0;
        let totalEgresos = 0;
        const ingresosPorServicio = {};

        reportData.forEach(v => {
          const amount = parseFloat(v.totalPaid) || 0;
          totalIngresos += amount;
          const serviceName = v.serviceName || 'Otro';
          if (!ingresosPorServicio[serviceName]) ingresosPorServicio[serviceName] = 0;
          ingresosPorServicio[serviceName] += amount;
        });

        // Obtener gastos del mes
        const expenseElements = document.querySelectorAll('#expenses-tbody tr');
        const gastos = [];
        expenseElements.forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 4) {
            const fecha = cells[0]?.textContent?.trim() || '';
            const concepto = cells[2]?.textContent?.trim() || '';
            const monto = parseFloat(cells[3]?.textContent?.replace('$', '').replace(',', '')) || 0;
            if (monto > 0) {
              totalEgresos += monto;
              gastos.push({ fecha, concepto, monto });
            }
          }
        });

        // Crear hoja de trabajo con el formato VENTAS VENUS
        const wsData = [];

        // Filas vacías iniciales (como en el archivo original)
        wsData.push([]);
        wsData.push([]);
        wsData.push([]);

        // Fila 4: Mes y encabezado de servicios
        wsData.push(['Mes:', mesNombre, null, 'Ingresos por servicios']);

        // Filas 5-11: Resumen y servicios
        const serviciosOrdenados = Object.entries(ingresosPorServicio).sort((a, b) => b[1] - a[1]);
        const serviciosPadded = [...serviciosOrdenados];
        while (serviciosPadded.length < 8) serviciosPadded.push(['', 0]);

        wsData.push([null, null, null, serviciosPadded[0]?.[0] || '', serviciosPadded[0]?.[1] || 0]);
        wsData.push(['Resumen Financiero', null, null, serviciosPadded[1]?.[0] || '', serviciosPadded[1]?.[1] || 0]);
        wsData.push(['TOTAL Ingresos', totalIngresos, null, serviciosPadded[2]?.[0] || '', serviciosPadded[2]?.[1] || 0]);
        wsData.push(['TOTAL Egresos', totalEgresos, null, serviciosPadded[3]?.[0] || '', serviciosPadded[3]?.[1] || 0]);
        wsData.push([null, null, null, serviciosPadded[4]?.[0] || '', serviciosPadded[4]?.[1] || 0]);
        wsData.push([null, totalIngresos - totalEgresos, null, serviciosPadded[5]?.[0] || '', serviciosPadded[5]?.[1] || 0]);
        wsData.push([null, null, null, serviciosPadded[6]?.[0] || '', serviciosPadded[6]?.[1] || 0]);
        wsData.push([null, null, null, serviciosPadded[7]?.[0] || '', serviciosPadded[7]?.[1] || 0]);

        // Fila vacía
        wsData.push([]);

        // Fila 14: Encabezados INGRESOS y EGRESOS
        wsData.push([
          'INGRESOS', null, null, null, null, null, null, null, null, null, null, null, null,
          'EGRESOS'
        ]);

        // Fila 15: Cabeceras de columnas
        wsData.push([
          'Fecha de pago', 'Cliente', 'Servicio', 'Tipo', 'Forma de pago', 'Cuenta Bancaria',
          'Subtotal', 'IVA', 'Descuento', 'Total', 'Comentarios', null, null,
          'Fecha de pago', 'Concepto', 'Forma de pago', 'Cuenta Bancaria', 'Subtotal', 'IVA', 'Total', 'Comentarios'
        ]);

        // Filas de datos: INGRESOS y EGRESOS lado a lado
        const maxRows = Math.max(reportData.length, gastos.length);

        for (let i = 0; i < maxRows; i++) {
          const venta = reportData[i];
          const gasto = gastos[i];

          const row = [];

          // Datos de INGRESOS
          if (venta) {
            const fecha = new Date(venta.paidAt || venta.startDateTime);
            const subtotal = parseFloat(venta.serviceAmount || venta.totalPaid) || 0;
            const iva = 0;
            const descuento = parseFloat(venta.discountAmount) || 0;
            const total = parseFloat(venta.totalPaid) || 0;
            const tipo = (venta.productsSold?.length > 0) ? 'PRODUCTO' : null;
            const formaPago = (venta.paymentMethod || '').charAt(0).toUpperCase() + (venta.paymentMethod || '').slice(1);
            const cuentaBancaria = venta.paymentMethod === 'transferencia' || venta.paymentMethod === 'tarjeta'
              ? 'BBVA Alo' : 'Caja';

            row.push(
              fecha,
              venta.clientName || '',
              venta.serviceName || '',
              tipo,
              formaPago,
              cuentaBancaria,
              subtotal > 0 ? subtotal : null,
              iva > 0 ? iva : null,
              descuento > 0 ? descuento : null,
              total,
              null
            );
          } else {
            row.push(null, null, null, null, null, null, null, null, null, null, null);
          }

          // Separador
          row.push(null, null);

          // Datos de EGRESOS
          if (gasto) {
            row.push(
              gasto.fecha,
              gasto.concepto,
              'Efectivo',
              'Caja',
              gasto.monto,
              0,
              gasto.monto,
              null
            );
          } else {
            row.push(null, null, null, null, null, null, null, null);
          }

          wsData.push(row);
        }

        // Crear workbook y worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // Configurar anchos de columna
        ws['!cols'] = [
          { wch: 14 }, // Fecha
          { wch: 25 }, // Cliente
          { wch: 22 }, // Servicio
          { wch: 12 }, // Tipo
          { wch: 14 }, // Forma de pago
          { wch: 14 }, // Cuenta Bancaria
          { wch: 12 }, // Subtotal
          { wch: 8 },  // IVA
          { wch: 10 }, // Descuento
          { wch: 12 }, // Total
          { wch: 15 }, // Comentarios
          { wch: 3 },  // Separador
          { wch: 3 },  // Separador
          { wch: 14 }, // Fecha Egreso
          { wch: 20 }, // Concepto
          { wch: 14 }, // Forma pago
          { wch: 14 }, // Cuenta
          { wch: 12 }, // Subtotal
          { wch: 8 },  // IVA
          { wch: 12 }, // Total
          { wch: 15 }  // Comentarios
        ];

        XLSX.utils.book_append_sheet(wb, ws, sheetName);

        // Generar archivo
        const fileName = `VENTAS VENUS - ${mesNombre} ${year}.xlsx`;
        XLSX.writeFile(wb, fileName);

        console.log('[REPORTS] Excel exportado correctamente:', fileName);
        alert('✅ Archivo Excel generado: ' + fileName);

      } catch (error) {
        console.error('[REPORTS] Error exportando Excel:', error);
        alert('❌ Error al exportar: ' + error.message);
      }
    }

    window.exportarVentasExcel = exportarVentasExcel;

    // ===== NUEVAS FUNCIONES PARA REPORTES ESTILO EXCEL =====

    let reportPieChart = null;
    let reportServicesPieChart = null;
    let currentReportMonth = { year: new Date().getFullYear(), month: new Date().getMonth() + 1 };
    const MESES = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const SERVICE_COLORS = [
      '#5F8D4E', '#285430', '#A4BE7B', '#5F7464', '#8C9A86',
      '#9EB384', '#B5C99A', '#708238', '#556B2F', '#3F4F3A'
    ];

    function initReportMonthTabs() {
      const container = document.getElementById('report-month-tabs');
      if (!container) return;

      const now = new Date();
      const tabs = [];

      // Generar tabs para los últimos 6 meses
      for (let i = 5; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const year = d.getFullYear();
        const month = d.getMonth() + 1;
        const isActive = year === currentReportMonth.year && month === currentReportMonth.month;

        tabs.push(`
          <button class="btn ${isActive ? 'primary' : 'ghost'}" 
                  style="padding:8px 14px;font-size:12px;white-space:nowrap;"
                  onclick="selectReportMonth(${year}, ${month})">
            ${MESES[month]} ${year}
          </button>
        `);
      }

      container.innerHTML = tabs.join('');
    }

    async function selectReportMonth(year, month) {
      currentReportMonth = { year, month };
      initReportMonthTabs();
      await cargarReportesMes();
      // Recargar gastos del mes seleccionado
      if (typeof loadExpenses === 'function') loadExpenses();
    }

    async function cargarReportesMes() {
      try {
        const { year, month } = currentReportMonth;
        document.getElementById('report-current-month').textContent = `${MESES[month]} ${year}`;

        // Calcular rango del mes
        const firstDay = `${year}-${String(month).padStart(2, '0')}-01`;
        const lastDay = new Date(year, month, 0).getDate();
        const lastDayStr = `${year}-${String(month).padStart(2, '0')}-${lastDay}`;

        const fromISO = `${firstDay}T00:00:00-06:00`;
        const toISO = `${lastDayStr}T23:59:59-06:00`;

        console.log('[REPORTS] Cargando mes:', firstDay, 'a', lastDayStr);

        const res = await fetch(`/api/appointments/range?from=${fromISO}&to=${toISO}`, { credentials: 'include' });
        const json = await res.json();

        if (!json.success) {
          console.error('[REPORTS] Error:', json.error);
          return;
        }

        // Filtrar ventas completadas
        const ventas = (json.data || []).filter(a =>
          a.status === 'completed' && a.totalPaid && a.paymentMethod
        );

        console.log('[REPORTS] Ventas del mes:', ventas.length);
        reportData = ventas;

        renderExcelReport(ventas);
      } catch (error) {
        console.error('[REPORTS] Error cargando mes:', error);
      }
    }

    function renderExcelReport(ventas) {
      // 1. Calcular totales
      let totalIngresos = 0;
      const ingresosPorServicio = {};

      ventas.forEach(v => {
        const amount = parseFloat(v.totalPaid) || 0;
        totalIngresos += amount;

        const serviceName = v.serviceName || 'Otro';
        if (!ingresosPorServicio[serviceName]) {
          ingresosPorServicio[serviceName] = 0;
        }
        ingresosPorServicio[serviceName] += amount;
      });

      // Por ahora, egresos es 0 (se puede expandir más adelante)
      const totalEgresos = 0;

      // 2. Actualizar resumen financiero
      document.getElementById('report-total-ingresos').textContent = '$' + totalIngresos.toLocaleString('es-MX', { minimumFractionDigits: 2 });
      document.getElementById('report-total-egresos').textContent = '$' + totalEgresos.toLocaleString('es-MX', { minimumFractionDigits: 2 });

      // 3. Renderizar lista de servicios
      const serviciosList = document.getElementById('report-servicios-list');
      const serviciosOrdenados = Object.entries(ingresosPorServicio).sort((a, b) => b[1] - a[1]);

      serviciosList.innerHTML = serviciosOrdenados.map(([servicio, monto]) => `
        <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.1);font-size:12px;">
          <span style="color:rgba(255,255,255,0.9);">${servicio}</span>
          <span style="color:#C1D7AE;font-weight:500;">$${monto.toLocaleString('es-MX', { minimumFractionDigits: 2 })}</span>
        </div>
      `).join('') || '<p style="color:rgba(255,255,255,0.5);font-size:12px;">Sin datos</p>';

      // 4. Renderizar gráfica Ingresos vs Egresos
      renderIngresosEgresosChart(totalIngresos, totalEgresos);

      // 5. Renderizar gráfica por servicios
      renderServicesChart(serviciosOrdenados);

      // 6. Renderizar tabla detallada
      renderExcelTable(ventas);
    }

    function renderIngresosEgresosChart(ingresos, egresos) {
      const ctx = document.getElementById('report-pie-chart');
      if (!ctx) return;

      if (reportPieChart) {
        reportPieChart.destroy();
      }

      const total = ingresos + egresos;
      const ingresosPercent = total > 0 ? ((ingresos / total) * 100).toFixed(0) : 100;
      const egresosPercent = total > 0 ? ((egresos / total) * 100).toFixed(0) : 0;

      reportPieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: [`Ingresos (${ingresosPercent}%)`, `Egresos (${egresosPercent}%)`],
          datasets: [{
            data: [ingresos, egresos || 0.01],
            backgroundColor: ['#6B8E23', '#3F4F3A'],
            borderColor: ['#2c2d26', '#2c2d26'],
            borderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => {
                  return '$' + context.raw.toLocaleString('es-MX', { minimumFractionDigits: 2 });
                }
              }
            }
          }
        }
      });
    }

    function renderServicesChart(serviciosOrdenados) {
      const ctx = document.getElementById('report-services-pie-chart');
      if (!ctx) return;

      if (reportServicesPieChart) {
        reportServicesPieChart.destroy();
      }

      const labels = serviciosOrdenados.map(s => s[0]);
      const data = serviciosOrdenados.map(s => s[1]);
      const colors = serviciosOrdenados.map((_, i) => SERVICE_COLORS[i % SERVICE_COLORS.length]);

      reportServicesPieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderColor: '#2c2d26',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percent = ((context.raw / total) * 100).toFixed(1);
                  return `${context.label}: $${context.raw.toLocaleString('es-MX')} (${percent}%)`;
                }
              }
            }
          }
        }
      });

      // Renderizar leyenda
      const legend = document.getElementById('report-services-legend');
      legend.innerHTML = serviciosOrdenados.map(([servicio, monto], i) => {
        const total = data.reduce((a, b) => a + b, 0);
        const percent = ((monto / total) * 100).toFixed(1);
        return `
          <div style="display:flex;align-items:center;gap:8px;">
            <div style="width:14px;height:14px;border-radius:3px;background:${SERVICE_COLORS[i % SERVICE_COLORS.length]};"></div>
            <span style="font-size:12px;flex:1;">${servicio}</span>
            <span style="font-size:12px;color:var(--muted);">${percent}%</span>
            <span style="font-size:12px;font-weight:600;color:var(--venus-soft);">$${monto.toLocaleString('es-MX')}</span>
          </div>
        `;
      }).join('');
    }

    function renderExcelTable(ventas) {
      const tbody = document.getElementById('report-sales-tbody');
      const tfoot = document.getElementById('report-sales-tfoot');

      if (ventas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="muted" style="text-align:center;padding:40px;">No hay ingresos registrados este mes</td></tr>';
        if (tfoot) tfoot.innerHTML = '';
        return;
      }

      let totalSubtotal = 0;
      let totalIVA = 0;
      let totalDescuento = 0;
      let totalGeneral = 0;

      tbody.innerHTML = ventas.map(v => {
        const fecha = new Date(v.paidAt || v.startDateTime);
        const fechaStr = fecha.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: '2-digit' });

        const subtotal = parseFloat(v.serviceAmount || v.totalPaid) || 0;
        const iva = 0; // Ajustar si se maneja IVA
        const descuento = parseFloat(v.discountAmount) || 0;
        const total = parseFloat(v.totalPaid) || 0;

        totalSubtotal += subtotal;
        totalIVA += iva;
        totalDescuento += descuento;
        totalGeneral += total;

        const tipo = (v.productsSold?.length > 0) ? 'PRODUCTO' : 'SERVICIO';
        const formaPago = (v.paymentMethod || '').charAt(0).toUpperCase() + (v.paymentMethod || '').slice(1);
        const cuentaBancaria = v.paymentMethod === 'transferencia' ? 'BBVA Aho' :
          v.paymentMethod === 'tarjeta' ? 'BBVA Aho' : 'Caja';

        return `
          <tr>
            <td style="white-space:nowrap;">${fechaStr}</td>
            <td>${v.clientName || 'Sin nombre'}</td>
            <td>${v.serviceName || '-'}</td>
            <td><span style="font-size:10px;padding:2px 6px;border-radius:4px;background:${tipo === 'PRODUCTO' ? '#fef3c7' : '#e0e7ff'};color:${tipo === 'PRODUCTO' ? '#92400e' : '#3730a3'}">${tipo}</span></td>
            <td>${formaPago}</td>
            <td>${cuentaBancaria}</td>
            <td>$${subtotal.toLocaleString('es-MX', { minimumFractionDigits: 2 })}</td>
            <td>${iva > 0 ? '$' + iva.toFixed(2) : '-'}</td>
            <td>${descuento > 0 ? '$' + descuento.toFixed(2) : '-'}</td>
            <td style="font-weight:600;color:var(--venus-soft);">$${total.toLocaleString('es-MX', { minimumFractionDigits: 2 })}</td>
            <td><textarea style="width:80px;padding:4px;font-size:10px;border:1px solid var(--line);border-radius:4px;background:transparent;color:var(--ink);resize:none;" rows="1" placeholder="..."></textarea></td>
          </tr>
        `;
      }).join('');

      // Renderizar footer con totales
      if (tfoot) {
        tfoot.innerHTML = `
          <tr>
            <td colspan="6" style="text-align:right;">TOTALES:</td>
            <td>$${totalSubtotal.toLocaleString('es-MX', { minimumFractionDigits: 2 })}</td>
            <td>${totalIVA > 0 ? '$' + totalIVA.toFixed(2) : '-'}</td>
            <td>${totalDescuento > 0 ? '$' + totalDescuento.toFixed(2) : '-'}</td>
            <td style="color:var(--venus-soft);">$${totalGeneral.toLocaleString('es-MX', { minimumFractionDigits: 2 })}</td>
            <td></td>
          </tr>
        `;
      }
    }

    function filtrarTablaReporte() {
      const paymentFilter = document.getElementById('filter-payment-method').value;
      if (!reportData) return;

      const filteredVentas = paymentFilter
        ? reportData.filter(v => v.paymentMethod === paymentFilter)
        : reportData;

      renderExcelTable(filteredVentas);
    }

    // ========== FILTRO POR FECHAS PERSONALIZADO ==========
    let customDateFilter = { from: null, to: null };

    function filtrarReportePorFechas() {
      const fromInput = document.getElementById('report-date-from');
      const toInput = document.getElementById('report-date-to');

      if (!fromInput.value || !toInput.value) {
        alert('Por favor selecciona ambas fechas');
        return;
      }

      const from = fromInput.value;
      const to = toInput.value;

      if (from > to) {
        alert('La fecha "Desde" no puede ser mayor que "Hasta"');
        return;
      }

      customDateFilter = { from, to };
      cargarReportePorRango(from, to);

      // Mostrar label de filtro activo
      const label = document.getElementById('filter-active-label');
      const text = document.getElementById('filter-range-text');
      if (label && text) {
        const fromDate = new Date(from + 'T00:00:00');
        const toDate = new Date(to + 'T00:00:00');
        const options = { day: 'numeric', month: 'short', year: 'numeric' };
        text.textContent = `Mostrando del ${fromDate.toLocaleDateString('es-MX', options)} al ${toDate.toLocaleDateString('es-MX', options)}`;
        label.style.display = 'block';
      }
    }

    function limpiarFiltroFechas() {
      document.getElementById('report-date-from').value = '';
      document.getElementById('report-date-to').value = '';
      document.getElementById('filter-active-label').style.display = 'none';
      customDateFilter = { from: null, to: null };

      // Volver al mes actual
      cargarReportesMes();
      loadExpenses();
    }

    function filtroRapido(tipo) {
      const now = new Date();
      let from, to;

      if (tipo === 'hoy') {
        from = to = now.toISOString().split('T')[0];
      } else if (tipo === 'semana') {
        const dayOfWeek = now.getDay();
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - dayOfWeek);
        from = startOfWeek.toISOString().split('T')[0];
        to = now.toISOString().split('T')[0];
      } else if (tipo === 'mes') {
        from = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-01`;
        to = now.toISOString().split('T')[0];
      }

      document.getElementById('report-date-from').value = from;
      document.getElementById('report-date-to').value = to;
      filtrarReportePorFechas();
    }

    async function cargarReportePorRango(from, to) {
      try {
        document.getElementById('report-current-month').textContent = 'Rango personalizado';

        const fromISO = `${from}T00:00:00-06:00`;
        const toISO = `${to}T23:59:59-06:00`;

        console.log('[REPORTS] Cargando rango:', from, 'a', to);

        const res = await fetch(`/api/appointments/range?from=${fromISO}&to=${toISO}`, { credentials: 'include' });
        const json = await res.json();

        if (!json.success) {
          console.error('[REPORTS] Error:', json.error);
          return;
        }

        // Filtrar ventas completadas
        const ventas = (json.data || []).filter(a =>
          a.status === 'completed' && a.totalPaid && a.paymentMethod
        );

        console.log('[REPORTS] Ventas encontradas:', ventas.length);

        // Guardar datos para filtros
        reportData = ventas;

        // Calcular totales
        let totalGeneral = 0;
        let totalEfectivo = 0;
        let totalTarjeta = 0;
        let totalTransferencia = 0;
        const serviciosTotales = {};

        ventas.forEach(v => {
          const total = parseFloat(v.totalPaid) || 0;
          totalGeneral += total;

          if (v.paymentMethod === 'efectivo') totalEfectivo += total;
          else if (v.paymentMethod === 'tarjeta') totalTarjeta += total;
          else if (v.paymentMethod === 'transferencia') totalTransferencia += total;

          const serviceName = v.serviceName || 'Otro';
          if (!serviciosTotales[serviceName]) serviciosTotales[serviceName] = 0;
          serviciosTotales[serviceName] += total;
        });

        // Actualizar estadísticas
        document.getElementById('report-total-sales').textContent = '$' + totalGeneral.toFixed(2);
        document.getElementById('report-sales-count').textContent = `${ventas.length} ventas`;
        document.getElementById('report-cash-total').textContent = '$' + totalEfectivo.toFixed(2);
        document.getElementById('report-card-total').textContent = '$' + totalTarjeta.toFixed(2);
        document.getElementById('report-transfer-total').textContent = '$' + totalTransferencia.toFixed(2);

        // Actualizar resumen financiero
        document.getElementById('report-total-ingresos').textContent = '$' + totalGeneral.toFixed(2);

        // Renderizar lista de servicios
        const serviciosList = document.getElementById('report-servicios-list');
        if (serviciosList) {
          const sortedServicios = Object.entries(serviciosTotales).sort((a, b) => b[1] - a[1]);
          serviciosList.innerHTML = sortedServicios.map(([name, total]) => `
            <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.1);">
              <span style="font-size:12px;color:rgba(255,255,255,0.85);">${name}</span>
              <span style="font-size:12px;font-weight:600;color:#C1D7AE;">$${total.toFixed(2)}</span>
            </div>
          `).join('');
        }

        // Renderizar tabla
        renderExcelTable(ventas);

        // Cargar gastos del rango
        await cargarGastosPorRango(from, to);

      } catch (error) {
        console.error('[REPORTS] Error:', error);
      }
    }

    async function cargarGastosPorRango(from, to) {
      try {
        console.log(`[EXPENSES] Cargando gastos del ${from} al ${to}`);

        const res = await fetch(`/api/expenses?from=${from}&to=${to}`, { credentials: 'include' });
        const json = await res.json();

        if (!json.success) {
          console.error('Error cargando gastos:', json.error);
          return;
        }

        const expenses = json.data || [];
        console.log(`[EXPENSES] ${expenses.length} gastos encontrados`);
        renderExpenses(expenses);
        calculateExpenseStats(expenses);
      } catch (error) {
        console.error('Error cargando gastos:', error);
      }
    }

    // Exponer funciones globalmente
    window.selectReportMonth = selectReportMonth;
    window.cargarReportesMes = cargarReportesMes;
    window.filtrarTablaReporte = filtrarTablaReporte;
    window.filtrarReportePorFechas = filtrarReportePorFechas;
    window.limpiarFiltroFechas = limpiarFiltroFechas;
    window.filtroRapido = filtroRapido;

    // ========== GASTOS DEL MES ==========
    let currentExpenseId = null;
    const expenseDialog = document.getElementById('expenseDialog');
    const formExpense = document.getElementById('form-expense');

    async function loadExpenses() {
      try {
        // Usar el mes seleccionado del reporte (currentReportMonth) en lugar del mes actual
        let year, month;

        if (typeof currentReportMonth !== 'undefined' && currentReportMonth.year && currentReportMonth.month) {
          year = currentReportMonth.year;
          month = String(currentReportMonth.month).padStart(2, '0');
        } else {
          // Fallback al mes actual si no hay mes seleccionado
          const now = new Date();
          year = now.getFullYear();
          month = String(now.getMonth() + 1).padStart(2, '0');
        }

        const firstDay = `${year}-${month}-01`;
        const lastDay = new Date(year, parseInt(month), 0).getDate();
        const lastDayStr = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;

        console.log(`[EXPENSES] Cargando gastos del ${firstDay} al ${lastDayStr}`);

        const res = await fetch(`/api/expenses?from=${firstDay}&to=${lastDayStr}`, { credentials: 'include' });
        const json = await res.json();

        if (!json.success) {
          console.error('Error cargando gastos:', json.error);
          return;
        }

        const expenses = json.data || [];
        console.log(`[EXPENSES] ${expenses.length} gastos encontrados`);
        renderExpenses(expenses);
        calculateExpenseStats(expenses);
      } catch (error) {
        console.error('Error cargando gastos:', error);
      }
    }

    function renderExpenses(expenses) {
      const tbody = document.getElementById('expenses-tbody');

      if (!expenses || expenses.length === 0) {
        if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="muted" style="text-align:center;padding:20px;">No hay gastos registrados este mes</td></tr>';
        return;
      }

      if (tbody) {
        tbody.innerHTML = expenses.map(exp => {
          const date = new Date(exp.date);
          const dateStr = date.toLocaleDateString('es-MX', { day: '2-digit', month: 'short' });
          const categoryIcons = {
            productos: '📦',
            renta: '🏠',
            servicios: '💡',
            salarios: '👥',
            marketing: '📢',
            equipo: '🔧',
            mantenimiento: '🛠️',
            transporte: '🚗',
            otros: '📝'
          };

          return `
            <tr>
              <td>${dateStr}</td>
              <td>${categoryIcons[exp.category] || '📝'} ${exp.category}</td>
              <td>${exp.description}</td>
              <td style="font-weight:600;color:#ef4444;">$${parseFloat(exp.amount).toFixed(2)}</td>
              <td>
                <button onclick="editExpense('${exp.id}')" class="btn-icon" style="background:#3b82f6;color:white;padding:4px 8px;border-radius:6px;font-size:0.85em;">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteExpense('${exp.id}')" class="btn-icon" style="background:#ef4444;color:white;padding:4px 8px;border-radius:6px;font-size:0.85em;">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        }).join('');
      }
    }

    function calculateExpenseStats(expenses) {
      let totalExpenses = 0;
      let productsExpenses = 0;
      let othersExpenses = 0;

      expenses.forEach(exp => {
        const amount = parseFloat(exp.amount) || 0;
        totalExpenses += amount;

        if (exp.category === 'productos') {
          productsExpenses += amount;
        } else {
          othersExpenses += amount;
        }
      });

      // Obtener total de ventas del mes
      const totalSalesEl = document.getElementById('report-total-sales');
      const totalSales = totalSalesEl ? parseFloat(totalSalesEl.textContent.replace('$', '').replace(',', '')) || 0 : 0;
      const netProfit = totalSales - totalExpenses;
      const profitMargin = totalSales > 0 ? ((netProfit / totalSales) * 100).toFixed(1) : 0;

      const ids = ['expenses-total', 'expenses-count', 'expenses-products', 'expenses-others', 'net-profit', 'profit-margin'];
      ids.forEach(id => {
        if (!document.getElementById(id)) console.warn('Missing element:', id);
      });

      if (document.getElementById('expenses-total')) document.getElementById('expenses-total').textContent = '$' + totalExpenses.toFixed(2);
      if (document.getElementById('expenses-count')) document.getElementById('expenses-count').textContent = `${expenses.length} gastos`;
      if (document.getElementById('expenses-products')) document.getElementById('expenses-products').textContent = '$' + productsExpenses.toFixed(2);
      if (document.getElementById('expenses-others')) document.getElementById('expenses-others').textContent = '$' + othersExpenses.toFixed(2);

      const netProfitEl = document.getElementById('net-profit');
      if (netProfitEl) {
        netProfitEl.textContent = '$' + netProfit.toFixed(2);
        if (netProfit >= 0) {
          netProfitEl.style.color = '#10b981';
        } else {
          netProfitEl.style.color = '#ef4444';
        }
      }

      if (document.getElementById('profit-margin')) document.getElementById('profit-margin').textContent = `${profitMargin}% margen`;
    }

    window.openExpenseModal = function () {
      currentExpenseId = null;
      if (formExpense) formExpense.reset();
      const title = document.getElementById('expense-modal-title');
      if (title) title.textContent = 'Nuevo Gasto';
      const dateInput = document.getElementById('expense-date');
      if (dateInput) dateInput.valueAsDate = new Date();
      if (expenseDialog) expenseDialog.showModal();
    };

    window.closeExpenseModal = function () {
      if (expenseDialog) expenseDialog.close();
      currentExpenseId = null;
    };

    window.editExpense = async function (id) {
      try {
        const res = await fetch(`/api/expenses/${id}`, { credentials: 'include' });
        const json = await res.json();

        if (!json.success) {
          alert('Error cargando gasto');
          return;
        }

        const expense = json.data;
        currentExpenseId = id;
        document.getElementById('expense-id').value = id;
        document.getElementById('expense-date').value = expense.date;
        document.getElementById('expense-category').value = expense.category;
        document.getElementById('expense-description').value = expense.description;
        document.getElementById('expense-amount').value = expense.amount;
        document.getElementById('expense-modal-title').textContent = 'Editar Gasto';
        expenseDialog.showModal();
      } catch (error) {
        console.error('Error:', error);
        alert('Error cargando gasto');
      }
    };

    window.deleteExpense = async function (id) {
      if (!confirm('¿Eliminar este gasto?')) return;

      try {
        const res = await fetch(`/api/expenses/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        const json = await res.json();

        if (json.success) {
          alert('✅ Gasto eliminado');
          loadExpenses();
        } else {
          alert('❌ Error: ' + json.error);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error eliminando gasto');
      }
    };

    if (formExpense) {
      formExpense.addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
          date: document.getElementById('expense-date').value,
          category: document.getElementById('expense-category').value,
          description: document.getElementById('expense-description').value,
          amount: parseFloat(document.getElementById('expense-amount').value)
        };

        try {
          const url = currentExpenseId ? `/api/expenses/${currentExpenseId}` : '/api/expenses';
          const method = currentExpenseId ? 'PUT' : 'POST';

          const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
          });

          const json = await res.json();

          if (json.success) {
            alert(currentExpenseId ? '✅ Gasto actualizado' : '✅ Gasto registrado');
            closeExpenseModal();
            loadExpenses();
          } else {
            alert('❌ Error: ' + json.error);
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error guardando gasto');
        }
      });
    }

    // Inicializar listeners combinados (Reportes y Gastos)
    document.querySelectorAll('[data-tab="reports"]').forEach(tab => {
      tab.addEventListener('click', () => {
        setTimeout(() => {
          // Mis funciones
          if (typeof initReportMonthTabs === 'function') initReportMonthTabs();
          if (typeof cargarReportesMes === 'function') cargarReportesMes();
          // Sus funciones
          if (typeof loadExpenses === 'function') loadExpenses();
        }, 100);
      });
    });
  </script>

</body>

</html>