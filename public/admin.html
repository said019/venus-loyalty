<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Panel Admin ‚Äî Venus Lealtad</title>
  <link rel="icon" href="/assets/logo.png">

  <!-- BOOTSTRAP 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- ICONOS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <!-- LIBRER√çAS QUE YA USES -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <!-- TEMA VENUS -->
  <style>
    :root{
      --venus:#8c9668;
      --venus-soft:#dfe6c1;
      --bg:#3f4037;
      --ink:#f9fafb;
      --muted:#e5e7eb;
      --line:rgba(255,255,255,0.25);
      --success:#10b981;
      --danger:#ef4444;
      --radius:18px;
    }

    body{
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
      margin:0;
      padding:0;
      min-height:100vh;
    }

    body.checking-auth {
      opacity: 0;
      pointer-events: none;
    }
    body.auth-verified {
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    /* Tarjetas y contenedores */
    .card-venus{
      background:rgba(255,255,255,.08);
      border-radius:var(--radius);
      border:1px solid var(--line);
      padding:20px;
      box-shadow:0 10px 28px rgba(0,0,0,0.25);
      backdrop-filter:blur(4px);
      position:relative;
      overflow:hidden;
    }
    .card-venus::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 20% 20%,rgba(255,255,255,0.05),transparent 60%),
        radial-gradient(circle at 80% 70%,rgba(255,255,255,0.03),transparent 60%);
      opacity:.8;
    }
    .card-venus > *{
      position:relative;
      z-index:2;
    }

    /* Navbar */
    .nav-link{
      color:var(--muted) !important;
      border-radius:30px;
      padding:6px 12px !important;
      transition:.2s;
    }
    .nav-link.active{
      background:rgba(255,255,255,.12);
      color:var(--venus-soft) !important;
      border:1px solid var(--venus);
      box-shadow:0 4px 12px rgba(0,0,0,0.25);
    }

    /* Botones */
    .btn-venus{
      background:var(--venus);
      border-color:var(--venus);
      color:#fff;
      border-radius:30px;
      padding:8px 16px;
      font-weight:500;
    }
    .btn-venus:hover{
      opacity:0.85;
    }

    .btn-ghost{
      background:transparent;
      border:1px solid var(--line);
      border-radius:30px;
      color:var(--ink);
    }
    .btn-ghost:hover{
      background:rgba(255,255,255,.08);
    }

    /* Inputs */
    .form-control,
    .form-select,
    textarea{
      background:rgba(255,255,255,.08) !important;
      border:1px solid var(--line) !important;
      color:var(--ink) !important;
      border-radius:12px !important;
    }
    .form-control::placeholder{
      color:var(--muted) !important;
    }

    /* Tablas */
    table{
      font-size:13px;
      color:var(--ink);
    }
    th{
      background:rgba(255,255,255,.08);
      border-bottom:1px solid var(--line);
      padding:6px;
    }
    td{
      border-bottom:1px solid rgba(255,255,255,.1);
      padding:6px;
    }

    /* KPI */
    .kpi{
      border-radius:12px;
      background:rgba(255,255,255,.1);
      padding:14px;
      border:1px solid rgba(255,255,255,.15);
    }
    .kpi .value{
      font-size:22px;
      font-weight:600;
      color:var(--ink);
    }

    /* QR modal */
    .modal-content{
      background:#111827 !important;
      border-radius:20px !important;
      color:var(--ink);
    }
    .modal-header{
      border-bottom:1px solid rgba(255,255,255,.1) !important;
    }

    .hidden{ display:none!important; }
  </style>
</head>

<body class="checking-auth">

  <nav class="navbar navbar-dark px-3" style="background:rgba(0,0,0,0.25); backdrop-filter:blur(6px);">
    <a class="navbar-brand d-flex align-items-center gap-2" href="#">
      <img src="/assets/logo.png" width="40" height="40" class="rounded" />
      <span class="fw-semibold">Admin ‚Äî Venus Lealtad</span>
    </a>

    <div class="d-flex gap-2">
      <a href="/" class="btn btn-ghost btn-sm" target="_blank">P√°gina clientes</a>
      <button id="logout" class="btn btn-ghost btn-sm">Cerrar sesi√≥n</button>
    </div>
  </nav>

  <div class="container py-4">

    <!-- NAV DE TABS -->
    <ul class="nav nav-pills mb-3 gap-2" id="admin-tabs">
      <li class="nav-item">
        <a class="nav-link active" data-tab="overview" href="#">Resumen</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-tab="cards" href="#">Tarjetas</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-tab="events" href="#">Gift Cards</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-tab="settings" href="#">Configuraci√≥n</a>
      </li>
    </ul>

    <!-- ================= TAB: OVERVIEW ================= -->
    <div id="tab-overview" class="card-venus">

      <div class="d-flex justify-content-between flex-wrap">
        <div>
          <h3 class="mb-1">Resumen general</h3>
          <small class="text-light opacity-75">Indicadores r√°pidos del sistema</small>
        </div>

        <div class="d-flex gap-2 align-items-center mt-2">
          <select id="stats-filter" class="form-select form-select-sm" style="max-width:150px;">
            <option value="day">Hoy</option>
            <option value="week" selected>Semana</option>
            <option value="month">Mes</option>
          </select>

          <button id="btn-download-report" class="btn btn-venus btn-sm">
            Descargar Reporte
          </button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="row mt-3 g-2">
        <div class="col-md-4">
          <div class="kpi">
            <div>Tarjetas totales</div>
            <div class="value" id="kpi-total">‚Äî</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="kpi">
            <div>Tarjetas completas</div>
            <div class="value" id="kpi-full">‚Äî</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="kpi">
            <div id="stamps-period-label">Sellos hoy</div>
            <div class="value" id="kpi-stamps">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- Segunda fila KPI -->
      <div class="row mt-2 g-2">
        <div class="col-md-4">
          <div class="kpi">
            <div id="redeems-period-label">Canjes hoy</div>
            <div class="value" id="kpi-redeems">‚Äî</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="kpi">
            <div>Promedio sellos</div>
            <div class="value" id="kpi-avg">‚Äî</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="kpi">
            <div>Tasa completitud</div>
            <div class="value" id="kpi-rate">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- Cumplea√±os -->
      <hr class="my-4" style="border-color:var(--line);">
      <h5>üéÇ Cumplea√±os</h5>

      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <div class="p-3 rounded" style="background:rgba(0,0,0,0.2); border:1px solid var(--line);">
            <h6 class="text-danger">Pasaron (15 d√≠as)</h6>
            <div id="list-past-bd" class="small opacity-75">Cargando...</div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="p-3 rounded" style="background:rgba(0,0,0,0.2); border:1px solid var(--line);">
            <h6 class="text-success">Pr√≥ximos (15 d√≠as)</h6>
            <div id="list-next-bd" class="small opacity-75">Cargando...</div>
          </div>
        </div>
      </div>

      <!-- Actividad gr√°fica -->
      <hr class="my-4" style="border-color:var(--line);">
      <h5 id="activity-title">üìà Actividad (7 d√≠as)</h5>
      <div class="p-3" style="background:rgba(255,255,255,0.05); border-radius:12px;">
        <canvas id="activity-chart" style="height:200px;"></canvas>
      </div>

      <!-- Top clientes -->
      <hr class="my-4" style="border-color:var(--line);">
      <h5>‚≠ê Top clientes</h5>
      <div class="table-responsive">
        <table class="table table-dark table-sm align-middle">
          <thead><tr><th>Cliente</th><th>Sellos</th><th>Estado</th></tr></thead>
          <tbody id="top-clients">
            <tr><td colspan="3" class="text-center opacity-75">Cargando...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Wallet Stats -->
      <hr class="my-4" style="border-color:var(--line);">
      <h5>üì± Estado de Wallets</h5>

      <div class="row g-2">
        <div class="col-md-4">
          <div class="kpi">
            <div>Google Wallet</div>
            <div class="value" id="kpi-google">‚Äî</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="kpi">
            <div>Apple Wallet</div>
            <div class="value" id="kpi-apple">‚Äî</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="kpi">
            <div>Dispositivos</div>
            <div class="value" id="kpi-devices">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="text-center mt-3">
        <button id="btn-refresh-wallet-stats" class="btn btn-ghost btn-sm">Actualizar</button>
      </div>
    </div>

    <!-- ================= TAB: CARDS ================= -->
    <div id="tab-cards" class="card-venus mt-3 d-none">

      <h3>Tarjetas</h3>
      <p class="opacity-75 small">Gestiona todas las tarjetas del programa</p>

      <!-- Buscador -->
      <div class="row g-2 mt-2">
        <div class="col-md-4">
          <input id="search-cards" class="form-control" placeholder="Buscar por ID o nombre...">
        </div>
        <div class="col-auto">
          <button id="btn-search-cards" class="btn btn-venus btn-sm">Buscar</button>
        </div>
        <div class="col-auto">
          <button id="btn-reload-cards" class="btn btn-ghost btn-sm">Recargar</button>
        </div>
        <div class="col-auto">
          <button id="btn-scan-card" class="btn btn-ghost btn-sm">üì∑ Escanear QR</button>
        </div>
      </div>

      <!-- Tabla -->
      <div class="table-responsive mt-3">
        <table class="table table-dark table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Cliente</th>
              <th>Tel√©fono</th>
              <th>Nacimiento</th>
              <th>Sellos</th>
              <th>Max</th>
              <th>Creada</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="cards-tbody">
            <tr><td colspan="8" class="text-center opacity-75">Cargando...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-2">
        <button id="btn-prev-page" class="btn btn-ghost btn-sm">Anterior</button>
        <span id="page-info" class="small opacity-75">P√°gina 1</span>
        <button id="btn-next-page" class="btn btn-ghost btn-sm">Siguiente</button>
      </div>

    </div>

    <!-- ================= TAB: GIFT CARDS ================= -->
    <div id="tab-events" class="card-venus mt-3 d-none">

      <h3>Gift Cards</h3>
      <p class="opacity-75 small">Crear, visualizar y canjear gifts</p>

      <div class="p-3 rounded" style="background:rgba(255,255,255,0.05);">
        <h5 class="mb-2 text-center">üé´ Canjear Gift Card</h5>
        <div class="d-flex justify-content-center gap-2">
          <input id="redeem-code" class="form-control w-auto" style="max-width:200px;" placeholder="C√≥digo">
          <button id="btn-redeem-gift" class="btn btn-venus btn-sm">Canjear</button>
        </div>

        <div class="text-center mt-2">
          <button onclick="startGiftScan()" class="btn btn-ghost btn-sm">üì∑ Usar c√°mara</button>
        </div>
      </div>

      <hr class="my-4" style="border-color:var(--line)">

      <h5>üìú Historial reciente</h5>
      <div class="table-responsive mt-2">
        <table class="table table-dark table-sm">
          <thead><tr><th>C√≥digo</th><th>Servicio</th><th>Cliente</th><th>Fecha</th></tr></thead>
          <tbody id="gift-history-body">
            <tr><td colspan="4">Cargando...</td></tr>
          </tbody>
        </table>
      </div>

      <hr class="my-4" style="border-color:var(--line)">

      <!-- Crear Gift -->
      <h4>Crear Gift Card</h4>

      <form id="gift-form" class="mt-3" style="max-width:450px;">
        <label class="form-label">Nombre del cliente (opcional)</label>
        <input id="gift-name" class="form-control" placeholder="Ej. Ana L√≥pez">

        <label class="form-label mt-2">Servicio</label>
        <input id="gift-service" class="form-control" required placeholder="Ej. Facial hidratante">

        <button class="btn btn-venus mt-3">Generar Gift Card</button>
      </form>

      <!-- Preview Gift -->
      <div id="gift-preview-container" class="mt-4 d-none">
        <div id="gift-card-visual" class="p-4 text-center rounded" style="background:#8c9668; max-width:320px; margin:auto;">
          <img src="/assets/logo.png" width="70" class="rounded-circle mb-2" />
          <h4 class="fw-bold">Venus Cosmetolog√≠a</h4>
          <div>üéÅ ¬°Tienes un regalo!</div>
          <hr>

          <div id="gift-visual-service" class="h5 fw-bold">Servicio</div>
          <div id="gift-visual-client" class="small opacity-75">Cliente</div>
          <div id="gift-visual-date" class="small opacity-75">Vence: --/--/--</div>

          <div class="bg-white p-2 rounded mt-2">
            <canvas id="gift-qr"></canvas>
          </div>
        </div>

        <div class="d-flex justify-content-center gap-2 mt-3">
          <button id="gift-copy" class="btn btn-ghost btn-sm">Copiar texto</button>
          <button id="gift-whatsapp" class="btn btn-venus btn-sm">WhatsApp texto</button>
          <button id="gift-whatsapp-image" class="btn btn-venus btn-sm">WhatsApp imagen</button>
        </div>

        <div id="gift-success" class="alert alert-success mt-3 d-none">
          Gift Card generada correctamente
        </div>
      </div>
    </div>

    <!-- ================= TAB: SETTINGS ================= -->
    <div id="tab-settings" class="card-venus mt-3 d-none">

      <h3>Configuraci√≥n</h3>

      <div class="mt-3 p-3 rounded" style="background:rgba(255,255,255,0.05);">
        <h5>Notificaciones Push</h5>

        <form id="push-notification-form" class="mt-3">

          <label class="form-label">T√≠tulo</label>
          <input id="push-title" class="form-control" maxLength="50" required>

          <label class="form-label mt-2">Mensaje</label>
          <textarea id="push-message" class="form-control" rows="3" maxLength="200" required></textarea>

          <label class="form-label mt-2">Tipo</label>
          <select id="push-type" class="form-select">
            <option value="promo">Promoci√≥n</option>
            <option value="reminder">Recordatorio</option>
            <option value="update">Actualizaci√≥n</option>
            <option value="alert">Alerta</option>
          </select>

          <div class="mt-3 p-3 rounded" style="background:rgba(255,255,255,0.05);">
            <small class="opacity-75">Vista previa:</small>
            <div class="fw-bold" id="preview-title">T√≠tulo aqu√≠</div>
            <div class="small opacity-75" id="preview-message">Mensaje aqu√≠</div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button type="button" id="btn-mass-push" class="btn btn-venus">Enviar a todos</button>
            <button type="button" id="test-push" class="btn btn-ghost">Probar</button>
          </div>

          <div id="push-success" class="alert alert-success mt-3 d-none">
            Notificaci√≥n enviada a <span id="push-count">0</span> pases
          </div>
          <div id="push-error" class="alert alert-danger mt-3 d-none">
            Error enviando notificaci√≥n
          </div>
        </form>
      </div>
    </div>

  </div> <!-- END container -->

  <footer class="text-center py-3 small opacity-75">
    ¬© Venus Cosmetolog√≠a ‚Äî Admin Panel
  </footer>


  <!-- ============== MODAL TARJETA ============== -->
  <div class="modal fade" id="cardModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title">Tarjeta</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="card-modal-content">Cargando...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============== MODAL SCAN QR ============== -->
  <div class="modal fade" id="scanModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title">Escanear QR</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="qr-reader" style="width:100%"></div>
          <div class="small opacity-75 text-center mt-2" id="scan-status">Iniciando c√°mara...</div>
        </div>
      </div>
    </div>
  </div>
  <script>
/* -----------------------------------------------------------------------
      UTILIDADES
------------------------------------------------------------------------*/
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

let html5QrCode = null;
let activityChart = null;

function showSection(tab) {
  $$('#admin-tabs .nav-link').forEach(a => a.classList.remove('active'));
  $(`[data-tab="${tab}"]`).classList.add('active');

  $$('#tab-overview, #tab-cards, #tab-events, #tab-settings').forEach(s => s.classList.add('d-none'));
  $(`#tab-${tab}`).classList.remove('d-none');
}

/* -----------------------------------------------------------------------
      AUTENTICACI√ìN
------------------------------------------------------------------------*/
async function verifySession() {
  try {
    const r = await fetch("/api/admin/me", { credentials: "include" });
    if (!r.ok) return location.href = "/admin-login.html";

    const j = await r.json();
    document.body.classList.remove("checking-auth");
    document.body.classList.add("auth-verified");

    $("#me-line") && ($("#me-line").textContent = "Sesi√≥n: " + (j.email || j.uid));

    loadMetrics("week");
  } catch (e) {
    location.href = "/admin-login.html";
  }
}
verifySession();

/* -----------------------------------------------------------------------
      EVENTOS DE TABS
------------------------------------------------------------------------*/
$$('[data-tab]').forEach(a => {
  a.addEventListener("click", (e) => {
    e.preventDefault();
    const tab = a.dataset.tab;
    showSection(tab);

    if (tab === "overview") loadMetrics($("#stats-filter").value);
    if (tab === "cards") loadCards(1);
    if (tab === "events") loadGiftHistory();
  });
});

/* -----------------------------------------------------------------------
      RESUMEN / M√âTRICAS
------------------------------------------------------------------------*/
let globalStatsData = {};

async function loadMetrics(range = "week") {
  try {
    const r = await fetch(`/api/admin/metrics-firebase?range=${range}`, { credentials: "include" });
    const d = await r.json();

    $("#kpi-total").textContent = d.total || 0;
    $("#kpi-full").textContent = d.full || 0;

    const stamps = range === "day" ? d.stampsToday : (range === "week" ? d.stampsWeek : d.stampsMonth);
    const redeems = range === "day" ? d.redeemsToday : (range === "week" ? d.redeemsWeek : d.redeemsMonth);

    $("#kpi-stamps").textContent = stamps || 0;
    $("#kpi-redeems").textContent = redeems || 0;

    $("#kpi-avg").textContent = d.total > 0 ? ((d.totalStamps || 0) / d.total).toFixed(1) : "0.0";
    $("#kpi-rate").textContent = d.total > 0 ? ((d.full / d.total) * 100).toFixed(0) + "%" : "0%";

    updatePeriodText(range);
    await loadActivityChart(range);
    await loadTopClients();
    await loadWalletStats();
    await loadBirthdays();

    globalStatsData = d;
  } catch (err) {
    console.error("Metrics error", err);
  }
}

function updatePeriodText(range) {
  $("#stamps-period-label").textContent = range === "day" ? "Sellos hoy" :
                                          range === "week" ? "Sellos esta semana" :
                                          "Sellos este mes";

  $("#redeems-period-label").textContent = range === "day" ? "Canjes hoy" :
                                           range === "week" ? "Canjes esta semana" :
                                           "Canjes este mes";

  $("#activity-title").textContent =
      range === "day" ? "üìà Actividad del d√≠a" :
      range === "week" ? "üìà Actividad (7 d√≠as)" :
      "üìà Actividad del mes";
}

// Filtro
$("#stats-filter").addEventListener("change", (e) => loadMetrics(e.target.value));

/* -----------------------------------------------------------------------
      GR√ÅFICA
------------------------------------------------------------------------*/
async function loadActivityChart(range = "week") {
  try {
    const r = await fetch(`/api/admin/activity-${range}`, { credentials: "include" });
    if (!r.ok) throw new Error("API error");

    const d = await r.json();

    const ctx = $("#activity-chart");

    if (activityChart) activityChart.destroy();

    activityChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: d.labels || [],
        datasets: [{
          label: "Sellos",
          data: d.stamps || [],
          borderColor: "#8c9668",
          backgroundColor: "rgba(140, 150, 104, 0.15)",
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { color: "#fff" } },
          x: { ticks: { color: "#ccc" } }
        }
      }
    });
  } catch (e) {
    console.error("Chart error:", e);
  }
}

/* -----------------------------------------------------------------------
      TOP CLIENTES
------------------------------------------------------------------------*/
async function loadTopClients() {
  try {
    const r = await fetch(`/api/admin/top-clients`, { credentials: "include" });
    const d = await r.json();

    const tbody = $("#top-clients");
    tbody.innerHTML = d.clients.slice(0, 5).map(c => `
      <tr>
        <td>${c.name}</td>
        <td>${c.stamps}/${c.max}</td>
        <td>${c.stamps >= c.max ? "üéÅ Completa" : (c.max - c.stamps) + " restantes"}</td>
      </tr>
    `).join("");
  } catch (e) {
    console.error("Top clients error:", e);
  }
}

/* -----------------------------------------------------------------------
      CUMPLEA√ëOS
------------------------------------------------------------------------*/
async function loadBirthdays() {
  try {
    const r = await fetch(`/api/admin/birthdays`);
    const d = await r.json();

    $("#list-past-bd").innerHTML =
      d.past.map(x => `<div class="d-flex justify-content-between"><span>${x.name}</span><span>${x.daysAgo} d√≠as</span></div>`).join("");

    $("#list-next-bd").innerHTML =
      d.upcoming.map(x => `<div class="d-flex justify-content-between"><span>${x.name}</span><span>En ${x.daysLeft} d√≠as</span></div>`).join("");
  } catch (e) {
    console.error("Birthday error", e);
  }
}

/* -----------------------------------------------------------------------
      WALLET STATS
------------------------------------------------------------------------*/
async function loadWalletStats() {
  try {
    const r = await fetch(`/api/admin/device-stats`, { credentials: "include" });
    if (!r.ok) return;

    const d = await r.json();
    $("#kpi-google").textContent = d.google?.totalDevices || 0;
    $("#kpi-apple").textContent = d.apple?.totalDevices || 0;
    $("#kpi-devices").textContent = d.total?.devices || 0;
  } catch (e) {
    console.error("Wallet stats error", e);
  }
}
$("#btn-refresh-wallet-stats").addEventListener("click", loadWalletStats);

/* -----------------------------------------------------------------------
      TARJETAS
------------------------------------------------------------------------*/
let currentPage = 1;

async function loadCards(page = 1) {
  try {
    const q = $("#search-cards").value;
    const url = `/api/admin/cards-firebase?page=${page}${q ? "&q="+q : ""}`;

    const r = await fetch(url, { credentials: "include" });
    const d = await r.json();

    const tbody = $("#cards-tbody");
    tbody.innerHTML = d.items.map(c => `
      <tr>
        <td><code>${c.id}</code></td>
        <td>${c.name || "‚Äî"}</td>
        <td>${c.phone || "‚Äî"}</td>
        <td>${c.birthdate || "‚Äî"}</td>
        <td>${c.stamps}</td>
        <td>${c.max}</td>
        <td>${new Date(c.createdAt).toLocaleDateString("es-MX")}</td>
        <td>
          <div class="d-flex flex-wrap gap-1">
            <button class="btn btn-ghost btn-sm" onclick='openCard("${c.id}")'>Ver</button>
            <button class="btn btn-ghost btn-sm" onclick='copyId("${c.id}")'>Copiar</button>
            <button class="btn btn-ghost btn-sm" onclick='addStamp("${c.id}")'>+1</button>
            <button class="btn btn-ghost btn-sm" onclick='redeem("${c.id}")'>Canjear</button>
          </div>
        </td>
      </tr>
    `).join("");

    $("#page-info").textContent = `P√°gina ${d.page} / ${d.totalPages}`;

    currentPage = page;

    $("#btn-prev-page").disabled = d.page === 1;
    $("#btn-next-page").disabled = d.page === d.totalPages;

  } catch (e) {
    console.error("Cards error:", e);
  }
}

$("#btn-search-cards").addEventListener("click", () => loadCards(1));
$("#btn-reload-cards").addEventListener("click", () => loadCards(currentPage));
$("#btn-prev-page").addEventListener("click", () => loadCards(currentPage - 1));
$("#btn-next-page").addEventListener("click", () => loadCards(currentPage + 1));

/* -----------------------------------------------------------------------
      VER TARJETA (MODAL)
------------------------------------------------------------------------*/
async function openCard(id) {
  $("#card-modal-content").innerHTML = "Cargando...";

  const r = await fetch(`/api/card/${id}`);
  const d = await r.json();

  $("#card-modal-content").innerHTML = `
    <h4>${d.name}</h4>
    <p><strong>ID:</strong> ${d.id}</p>
    <p><strong>Sellos:</strong> ${d.stamps}/${d.max}</p>
    <div class="text-center">
      <canvas id="modal-qr"></canvas>
    </div>
  `;

  QRCode.toCanvas($("#modal-qr"), d.id);

  new bootstrap.Modal($("#cardModal")).show();
}

/* -----------------------------------------------------------------------
      ACCIONES TARJETA
------------------------------------------------------------------------*/
async function copyId(id) {
  await navigator.clipboard.writeText(id);
  alert("ID copiado");
}

async function addStamp(id) {
  const r = await fetch(`/api/card/${id}/stamp`, { method: "POST" });
  if (r.ok) { alert("+1 sello agregado"); loadCards(currentPage); }
}

async function redeem(id) {
  const r = await fetch(`/api/card/${id}/redeem`, { method: "POST" });
  if (r.ok) { alert("Tarjeta canjeada"); loadCards(currentPage); }
}

/* -----------------------------------------------------------------------
      SCAN QR TARJETA
------------------------------------------------------------------------*/
$("#btn-scan-card").addEventListener("click", () => {
  const modal = new bootstrap.Modal($("#scanModal"));
  modal.show();
  startScan();
});

async function startScan() {
  try {
    html5QrCode = new Html5Qrcode("qr-reader");

    await html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        const cardId = extractCardId(decodedText);
        if (cardId) {
          html5QrCode.stop();
          bootstrap.Modal.getInstance($("#scanModal")).hide();
          openCard(cardId);
        }
      }
    );
  } catch (e) {
    console.error("Scan error:", e);
  }
}

function extractCardId(text) {
  try {
    const u = new URL(text);
    return u.searchParams.get("cardId");
  } catch {}
  return text.startsWith("card_") ? text : null;
}

/* -----------------------------------------------------------------------
      GIFT CARDS
------------------------------------------------------------------------*/
async function loadGiftHistory() {
  try {
    const r = await fetch(`/api/admin/gift-history`);
    const d = await r.json();

    $("#gift-history-body").innerHTML = d.history.map(h => `
      <tr>
        <td>${h.code}</td>
        <td>${h.service}</td>
        <td>${h.client}</td>
        <td>${new Date(h.date).toLocaleString()}</td>
      </tr>
    `).join("");
  } catch (e) {
    console.error("Gift history error:", e);
  }
}

/* Crear gift */
$("#gift-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = $("#gift-name").value.trim() || "Cliente";
  const service = $("#gift-service").value.trim();

  const id = "gift_" + Date.now();
  const expires = new Date();
  expires.setDate(expires.getDate() + 30);

  $("#gift-visual-service").textContent = service;
  $("#gift-visual-client").textContent = name;
  $("#gift-visual-date").textContent = "Vence: " + expires.toLocaleDateString("es-MX");

  QRCode.toCanvas($("#gift-qr"), `GIFT|${id}|${service}|${name}`);

  $("#gift-preview-container").classList.remove("d-none");
  $("#gift-success").classList.remove("d-none");
});

/* WhatsApp texto */
$("#gift-whatsapp").addEventListener("click", () => {
  const service = $("#gift-visual-service").textContent;
  const client = $("#gift-visual-client").textContent.replace("Para:", "");
  const expires = $("#gift-visual-date").textContent;

  const msg =
    `üéÅ Gift de Venus\n\n`+
    `‚ú® Servicio: ${service}\n`+
    `üë© Para: ${client}\n`+
    `üìÖ ${expires}\n`;

  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
});

/* WhatsApp imagen */
$("#gift-whatsapp-image").addEventListener("click", async () => {
  const card = $("#gift-card-visual");

  const canvas = await html2canvas(card, { scale: 2 });
  canvas.toBlob((blob) => {
    const file = new File([blob], "gift.png", { type: "image/png" });

    if (navigator.share) {
      navigator.share({
        files: [file],
        title: "Gift Venus",
        text: "Tu tarjeta de regalo"
      });
    } else {
      const a = document.createElement("a");
      a.href = canvas.toDataURL();
      a.download = "gift.png";
      a.click();
    }
  });
});

/* -----------------------------------------------------------------------
      NOTIFICACIONES
------------------------------------------------------------------------*/
$("#push-type").addEventListener("change", updatePreview);
$("#push-title").addEventListener("input", updatePreview);
$("#push-message").addEventListener("input", updatePreview);

function updatePreview() {
  $("#preview-title").textContent = $("#push-title").value;
  $("#preview-message").textContent = $("#push-message").value;
}

$("#btn-mass-push").addEventListener("click", async () => {
  const body = {
    title: $("#push-title").value,
    message: $("#push-message").value,
    type: $("#push-type").value
  };

  const r = await fetch("/api/admin/push-all", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(body)
  });

  if (r.ok) {
    $("#push-success").classList.remove("d-none");
    $("#push-error").classList.add("d-none");
  } else {
    $("#push-success").classList.add("d-none");
    $("#push-error").classList.remove("d-none");
  }
});

/* -----------------------------------------------------------------------
      LOGOUT
------------------------------------------------------------------------*/
$("#logout").addEventListener("click", async () => {
  await fetch("/api/admin/logout", { method: "POST" });
  location.href = "/admin-login.html";
});
</script> 
<!-- BOOTSTRAP JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* -----------------------------------------------------------------------
      FIXES FINALES Y OPTIMIZACIONES
------------------------------------------------------------------------*/

/* Cerrar modal al hacer ESC sin romper c√°mara */
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && html5QrCode) {
    try { html5QrCode.stop(); } catch {}
  }
});

/* Evitar scroll al abrir modales */
const modals = document.querySelectorAll(".modal");
modals.forEach(m => {
  m.addEventListener("shown.bs.modal", () => document.body.classList.add("modal-open-fixed"));
  m.addEventListener("hidden.bs.modal", () => document.body.classList.remove("modal-open-fixed"));
});

/* Soluci√≥n c√°mara Safari/iOS */
document.addEventListener("visibilitychange", () => {
  if (document.hidden && html5QrCode) {
    try { html5QrCode.stop(); } catch {}
  }
});

/* Mantener tu color Venus en selecci√≥n de texto */
const style = document.createElement("style");
style.innerHTML = `
  ::selection {
    background: var(--venus);
    color: #fff;
  }
`;
document.head.appendChild(style);

/* Ajuste responsivo del dashboard */
function adjustDashboard() {
  const w = window.innerWidth;
  if (w < 480) {
    document.body.classList.add("mobile-ui");
  } else {
    document.body.classList.remove("mobile-ui");
  }
}
adjustDashboard();
window.addEventListener("resize", adjustDashboard);

/* Crash-safe para evitar errores al iniciar */
console.log("%cVenus Admin cargado ‚úî", "color:#8c9668;font-size:14px;");

/* Fallback para charts */
window.addEventListener("error", (e) => {
  if (String(e.message).includes("Chart")) {
    console.warn("Chart.js warning:", e.message);
  }
});
</script>

</body>
</html>