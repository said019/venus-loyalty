<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Admin — Venus Lealtad</title>
  <link rel="icon" href="/assets/logo.png">
  <style>
    /* [TODOS LOS ESTILOS EXISTENTES SE MANTIENEN IGUAL] */
    body.checking-auth {
      opacity: 0;
      pointer-events: none;
    }

    body.auth-verified {
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    :root {
      --venus: #8c9668;
      --venus-soft: #dfe6c1;
      --bg: #3f4037;
      --ink: #f9fafb;
      --muted: #e5e7eb;
      --line: rgba(255, 255, 255, 0.25);
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .wrap {
      max-width: 1100px;
      margin: 16px auto;
      padding: 0 12px 32px;
      width: 100%;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand img {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, .1);
    }

    h1 {
      font-size: 22px;
      margin: 0;
      color: var(--ink);
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .1);
      padding: 7px 13px;
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
      color: var(--ink);
      white-space: nowrap;
      backdrop-filter: blur(3px);
      transition: all 0.2s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--venus-green) 0%, #9aa066 100%);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(140, 150, 104, 0.3);
      transition: all 0.2s ease;
    }

    .btn.primary:hover {
      background: linear-gradient(135deg, #9aa066 0%, var(--venus-green) 100%);
      box-shadow: 0 6px 16px rgba(140, 150, 104, 0.4);
      transform: translateY(-1px);
    }

    .btn.ghost {
      background: transparent;
      border-color: var(--line);
    }

    .btn.small {
      padding: 5px 10px;
      font-size: 12px;
    }

    .nav {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 8px 0 14px;
      position: relative;
      z-index: 100;
    }

    .nav a {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid transparent;
      text-decoration: none;
      font-size: 13px;
      color: var(--muted);
      background: transparent;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .nav a.is-active {
      background: rgba(255, 255, 255, .15);
      border-color: var(--venus);
      color: var(--venus-soft);
      box-shadow: 0 4px 14px rgba(0, 0, 0, .1);
    }

    .card {
      background: rgba(255, 255, 255, .08);
      border-radius: var(--radius);
      border: 1px solid var(--line);
      padding: 16px 16px 14px;
      box-shadow: 0 10px 28px rgba(0, 0, 0, .2);
      margin-bottom: 14px;
      backdrop-filter: blur(3px);
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.05), transparent 60%),
        radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.03), transparent 60%);
      opacity: .9;
      pointer-events: none;
    }

    .card>* {
      position: relative;
      z-index: 1;
    }

    .card h2 {
      margin: 0 0 6px;
      font-size: 18px;
      color: var(--ink);
    }

    .card h3 {
      margin: 0 0 6px;
      font-size: 15px;
      color: var(--ink);
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select.filter-select {
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      border: 1px solid var(--line);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      outline: none;
      cursor: pointer;
    }

    .grid-3-kpi {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    @media (max-width:700px) {
      .grid-3-kpi {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width:480px) {
      .grid-3-kpi {
        grid-template-columns: 1fr;
      }
    }

    .kpi {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, .1);
      border: 1px solid rgba(255, 255, 255, .15);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      backdrop-filter: blur(3px);
    }

    .kpi span.value {
      font-size: 20px;
      font-weight: 600;
      color: var(--ink);
    }

    .kpi span {
      color: var(--muted);
    }

    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    label {
      display: block;
      margin: 8px 0 4px;
      font-size: 13px;
      font-weight: 500;
      color: var(--ink);
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .1);
      font-size: 13px;
      color: var(--ink);
      backdrop-filter: blur(3px);
    }

    input::placeholder {
      color: var(--muted);
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    .hidden {
      display: none !important;
    }

    .table-wrap {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 13px;
    }

    thead {
      background: rgba(255, 255, 255, .1);
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, .1);
      text-align: left;
      white-space: nowrap;
      color: var(--ink);
    }

    tr:last-child td {
      border-bottom: none;
    }

    code {
      font-size: 12px;
      background: rgba(255, 255, 255, .15);
      padding: 2px 4px;
      border-radius: 4px;
      color: var(--ink);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      background: #bbf7d0;
      color: #166534;
      font-size: 11px;
    }

    /* Estilos adaptados de index.html para la Gift Card */
    .gift-card-visual {
      background-color: #8c9668;
      /* Tu color original */
      border-radius: 20px;
      color: #fff;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      width: 100%;
      max-width: 320px;
      /* Tamaño proporcional para compartir */
      position: relative;
      overflow: hidden;
      text-align: center;
      margin: 0 auto;
      /* Centrado */
      font-family: 'Poppins', sans-serif;
    }

    .gift-card-visual::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.05), transparent 70%),
        radial-gradient(circle at 80% 60%, rgba(255, 255, 255, 0.04), transparent 60%);
      opacity: 0.7;
      z-index: 0;
    }

    .gift-card-content {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .gift-brand-logo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #fff;
      margin-bottom: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      object-fit: contain;
      padding: 2px;
    }

    .gift-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 5px 0;
    }

    .gift-service {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 10px 0 5px;
      color: #dfe6c1;
      /* Venus soft color */
    }

    .gift-meta {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 15px;
    }

    .gift-qr-container {
      background: #fff;
      padding: 10px;
      border-radius: 12px;
      margin-top: 10px;
      display: inline-block;
    }


    .gift-qr {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      background: #fff;
      padding: 8px;
      margin-bottom: 8px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0, 0, 0, .18);
      font-size: 11px;
      margin-top: 6px;
    }

    .gift-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .footer {
      margin-top: auto;
      text-align: center;
      padding: 8px 0 14px;
      font-size: 12px;
      color: var(--muted);
    }

    .success-message {
      background: rgba(187, 247, 208, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 10px;
      font-size: 13px;
      color: #bbf7d0;
    }

    dialog {
      border-radius: 16px;
      border: 1px solid var(--line);
      background: #111827;
      color: var(--ink);
      padding: 16px 18px 14px;
      max-width: 420px;
      width: 90%;
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, .6);
    }

    /* ===== OFF-CANVAS MENU (Module Selection) ===== */
    .offcanvas {
      position: fixed;
      top: 0;
      right: -400px;
      width: 380px;
      height: 100vh;
      background: linear-gradient(135deg, rgba(27, 28, 26, 0.98), rgba(140, 150, 104, 0.1));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-left: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      overflow-y: auto;
      padding: 24px;
    }

    .offcanvas.open {
      right: 0;
    }

    .offcanvas-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .offcanvas-backdrop.show {
      opacity: 1;
      visibility: visible;
    }

    .offcanvas-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .offcanvas-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--venus-soft);
    }

    .module-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      transition: all 0.2s ease;
    }

    .module-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .module-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .module-icon {
      font-size: 20px;
    }

    .module-label {
      font-size: 14px;
      font-weight: 500;
      color: #f3f3f3;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.2);
      transition: .3s;
      border-radius: 34px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked+.toggle-slider {
      background-color: var(--venus-green);
      box-shadow: 0 0 8px rgba(140, 150, 104, 0.5);
    }

    .toggle-switch input:checked+.toggle-slider:before {
      transform: translateX(22px);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-card {
      background: linear-gradient(135deg, rgba(27, 28, 26, 0.95), rgba(140, 150, 104, 0.15));
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, .15);
      padding: 24px;
      max-width: 480px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, .4),
        0 0 0 1px rgba(255, 255, 255, .05) inset;
      color: #f9fafb;
      animation: modalSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--venus-soft);
    }

    .modal-body p {
      margin: 12px 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-body strong {
      font-weight: 600;
      min-width: 80px;
      color: var(--venus-soft);
    }

    .modal-footer {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* Mejorar botones del modal */
    .modal-footer .btn.small {
      border-radius: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .modal-footer .btn.small:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .modal-footer .btn.primary {
      background: linear-gradient(135deg, var(--venus-green), #a0b070);
      border: none;
    }

    .modal-footer .btn.success {
      box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
    }

    .modal-footer .btn.success:hover {
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
      background: #22c55e;
    }

    .modal-footer .btn.ghost {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-footer .btn.ghost:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .qr-box {
      margin-top: 10px;
      display: flex;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 10px;
    }

    .qr-box canvas {
      background: #fff;
      border-radius: 8px;
      padding: 8px;
      max-width: 100%;
      height: auto;
    }

    /* Estilos para debugging */
    .debug-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--line);
    }

    .debug-output {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 10px;
    }

    /* Estilos para el formulario de notificación individual */
    .notify-form-container {
      margin-top: 15px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(140, 150, 104, 0.08) 0%, rgba(140, 150, 104, 0.03) 100%);
      border: 1px solid rgba(140, 150, 104, 0.2);
      border-radius: 16px;
      animation: slideDown 0.3s ease-out;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Spinner animation for loading states */
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .notify-form-header {
      font-size: 15px;
      font-weight: 600;
      color: var(--venus-soft);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(140, 150, 104, 0.15);
    }

    .input-group {
      position: relative;
      margin-bottom: 12px;
    }

    .input-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      pointer-events: none;
      color: var(--venus-soft);
      opacity: 0.7;
    }

    .input-group textarea+.input-icon {
      top: 14px;
      transform: none;
    }

    .notify-input {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(140, 150, 104, 0.2);
      border-radius: 12px;
      padding: 12px 14px 12px 42px;
      color: #fff;
      font-size: 14px;
      transition: all 0.2s;
    }

    .notify-input:focus {
      border-color: var(--venus-soft);
      outline: none;
      background: rgba(0, 0, 0, 0.4);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.15);
    }

    .notify-textarea {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(140, 150, 104, 0.2);
      border-radius: 12px;
      padding: 12px 14px 12px 42px;
      color: #fff;
      font-size: 14px;
      min-height: 90px;
      resize: vertical;
      font-family: inherit;
      transition: all 0.2s;
    }

    .notify-textarea:focus {
      border-color: var(--venus-soft);
      outline: none;
      background: rgba(0, 0, 0, 0.4);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.15);
    }

    .notify-btn-group {}

    .automation-textarea:focus {
      outline: none;
      border-color: var(--venus-green);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.1);
    }

    .stat-money {
      font-variant-numeric: tabular-nums;
    }

    /* Payment functionality styles */
    .payment-indicator {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .payment-efectivo {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .payment-tarjeta {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .payment-transferencia {
      background: rgba(168, 85, 247, 0.2);
      color: #a855f7;
    }

    .payment-no_pagado {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .form-input.readonly {
      background: rgba(0, 0, 0, 0.2);
      cursor: not-allowed;
      opacity: 0.7;
    }

    .automation-history {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .automation-log-item {
      padding: 8px;
      margin-bottom: 6px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.5;
    }

    .modal-textarea:focus {
      outline: none;
      border-color: var(--venus-green);
      box-shadow: 0 0 0 3px rgba(140, 150, 104, 0.1);
    }

    /* ===== HISTORIAL DE CITAS SELECCIONABLE ===== */
    .client-history-panel {
      margin-top: 12px;
      background: rgba(140, 150, 104, 0.08);
      border: 1px solid rgba(140, 150, 104, 0.25);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .client-history-panel.hidden {
      display: none;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      cursor: pointer;
      transition: background 0.2s;
      user-select: none;
    }

    .history-header:hover {
      background: rgba(140, 150, 104, 0.12);
    }

    .history-toggle-icon {
      transition: transform 0.3s ease;
      font-size: 12px;
      color: var(--venus-soft);
    }

    .history-header.expanded .history-toggle-icon {
      transform: rotate(180deg);
    }

    .history-count {
      font-size: 12px;
      color: var(--venus-soft);
      font-weight: 600;
    }

    .history-hint {
      font-size: 11px;
      color: var(--muted);
      font-style: italic;
    }

    .history-content {
      border-top: 1px solid rgba(140, 150, 104, 0.15);
      max-height: 180px;
      overflow-y: auto;
    }

    .history-list {
      padding: 8px;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .history-item:last-child {
      margin-bottom: 0;
    }

    .history-item:hover {
      background: rgba(140, 150, 104, 0.2);
      border-color: var(--venus-soft);
    }

    .history-item:active {
      transform: scale(0.98);
    }

    .history-item-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .history-item-date {
      font-size: 11px;
      color: var(--muted);
    }

    .history-item-service {
      font-size: 13px;
      color: #fff;
      font-weight: 500;
    }

    .history-item-select {
      font-size: 11px;
      color: var(--venus-soft);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .history-item:hover .history-item-select {
      opacity: 1;
    }

    .history-empty {
      text-align: center;
      padding: 16px;
      color: var(--muted);
      font-size: 13px;
    }

    .history-item.selected {
      background: rgba(140, 150, 104, 0.3);
      border-color: var(--venus-soft);
    }

    .history-item.selected .history-item-select {
      opacity: 1;
      color: #22c55e;
    }

    /* ===== TABS SERVICIOS/PRODUCTOS ===== */
    .tabs-header {
      display: flex;
      border-bottom: 1px solid var(--line);
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px 12px 0 0;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }

    .tab-btn {
      flex: 1;
      padding: 14px 20px;
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
    }

    .tab-btn:hover {
      color: var(--ink);
      background: rgba(255, 255, 255, 0.05);
    }

    .tab-btn.active {
      color: var(--venus-soft);
      background: rgba(140, 150, 104, 0.1);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--venus);
      border-radius: 3px 3px 0 0;
    }

    .tab-count {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }

    .tab-btn.active .tab-count {
      background: var(--venus);
      color: white;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* Productos */
    .product-cell {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .product-img {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .stock {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
    }

    .stock-ok {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .stock-low {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
    }

    .stock-out {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .stats-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-item {
      background: rgba(0, 0, 0, 0.2);
      padding: 12px 20px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-item .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--venus-soft);
    }

    .stat-item .stat-label {
      font-size: 11px;
      color: var(--muted);
    }

    .filter-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      padding: 6px 14px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chip:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--ink);
    }

    .chip.active {
      background: var(--venus);
      border-color: var(--venus);
      color: white;
    }

    .item-category {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    /* ===== FONT AWESOME ICONS ===== */
    .btn i {
      margin-right: 6px;
    }

    .btn.icon-only i {
      margin: 0;
    }

    h2 i,
    h3 i,
    h4 i {
      margin-right: 8px;
    }

    /* ===== GIFT CARDS ===== */
    .gc-layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 24px;
    }

    @media (max-width: 900px) {
      .gc-layout {
        grid-template-columns: 1fr;
      }
    }

    .gc-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .gc-stat {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 14px 18px;
      border: 1px solid var(--line);
    }

    .gc-stat-value {
      font-size: 26px;
      font-weight: 700;
      color: var(--venus-soft);
    }

    .gc-stat-label {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .gc-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 600px;
      overflow-y: auto;
    }

    .gc-item {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 14px 16px;
      border: 1px solid var(--line);
      display: grid;
      grid-template-columns: 44px 1fr auto;
      gap: 14px;
      align-items: start;
      transition: all 0.2s;
    }

    .gc-item:hover {
      background: rgba(0, 0, 0, 0.3);
      border-color: var(--venus);
    }

    .gc-item.expired {
      opacity: 0.5;
    }

    .gc-icon {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .gc-icon.pending {
      background: linear-gradient(135deg, var(--venus), var(--venus-soft));
      color: white;
    }

    .gc-icon.redeemed {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .gc-icon.expired {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .gc-info h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .gc-service {
      font-size: 13px;
      color: var(--venus-soft);
      margin-bottom: 6px;
    }

    .gc-meta {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .gc-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .gc-status {
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .gc-status.pending {
      background: rgba(140, 150, 104, 0.2);
      color: var(--venus-soft);
    }

    .gc-status.redeemed {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .gc-status.expired {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .gc-vigencia {
      margin-top: 8px;
    }

    .gc-vigencia-bar {
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 4px;
    }

    .gc-vigencia-progress {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s;
    }

    .gc-vigencia-progress.ok {
      background: #22c55e;
    }

    .gc-vigencia-progress.warning {
      background: #fbbf24;
    }

    .gc-vigencia-progress.danger {
      background: #ef4444;
    }

    .gc-vigencia-text {
      font-size: 10px;
      color: var(--muted);
    }

    .gc-redeemed-info {
      background: rgba(34, 197, 94, 0.1);
      border-radius: 6px;
      padding: 6px 10px;
      margin-top: 8px;
      font-size: 11px;
      color: #22c55e;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .gc-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .gc-actions .btn {
      padding: 6px 8px;
    }

    .gc-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .gc-tab {
      padding: 7px 14px;
      border-radius: 8px;
      background: transparent;
      border: 1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .gc-tab:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--ink);
    }

    .gc-tab.active {
      background: var(--venus);
      border-color: var(--venus);
      color: white;
    }

    .gc-tab-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 7px;
      border-radius: 10px;
      font-size: 10px;
    }

    .gc-preview {
      background: linear-gradient(135deg, rgba(90, 90, 66, 0.5) 0%, rgba(74, 74, 53, 0.5) 100%);
      border-radius: 14px;
      padding: 24px;
      text-align: center;
      margin-top: 16px;
      border: 1px solid var(--line);
    }

    .gc-preview-logo {
      font-size: 36px;
      margin-bottom: 10px;
    }

    .gc-preview h3 {
      font-size: 16px;
      color: var(--venus-soft);
      margin-bottom: 6px;
    }

    .gc-preview .gc-preview-service {
      font-size: 14px;
      color: var(--ink);
      margin-bottom: 14px;
    }

    .gc-preview-qr {
      width: 90px;
      height: 90px;
      background: white;
      border-radius: 10px;
      margin: 0 auto 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gc-preview-validity {
      font-size: 11px;
      color: var(--muted);
    }

    .gc-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    .gc-empty i {
      font-size: 40px;
      margin-bottom: 10px;
      opacity: 0.4;
    }

    /* Mobile Menu Styles */
    .mobile-actions {
      display: none;
      align-items: center;
      gap: 8px;
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: var(--ink);
      font-size: 24px;
      cursor: pointer;
    }

    .mobile-bell {
      display: none;
    }

    .mobile-menu {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 3000;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }

    .mobile-menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: bold;
    }

    .close-menu-btn {
      background: none;
      border: none;
      color: var(--ink);
      font-size: 24px;
      cursor: pointer;
    }

    .mobile-nav-link {
      display: block;
      padding: 12px;
      color: var(--ink);
      text-decoration: none;
      font-size: 16px;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .mobile-nav-link:hover,
    .mobile-nav-link.is-active {
      background: rgba(255, 255, 255, 0.1);
    }

    @media (max-width: 768px) {
      .desktop-only {
        display: none !important;
      }

      .mobile-actions {
        display: flex;
      }

      .mobile-menu-btn {
        display: block;
      }

      .mobile-bell {
        display: block;
      }

      /* Mobile notification dropdown */
      .notification-dropdown {
        position: fixed;
        top: 60px;
        left: 10px;
        right: 10px;
        width: auto;
        max-width: none;
      }
    }

    /* ===== NOTIFICACIONES - CAMPANA ===== */
    .notification-wrapper {
      position: relative;
    }

    .notification-bell {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 10px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      position: relative;
    }

    .notification-bell:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--ink);
    }

    .notification-bell i {
      font-size: 20px;
    }

    .notification-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      min-width: 18px;
      height: 18px;
      background: #ef4444;
      color: white;
      font-size: 10px;
      font-weight: 700;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 5px;
      animation: pulse-badge 2s infinite;
    }

    .notification-badge.hidden {
      display: none;
    }

    @keyframes pulse-badge {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }
    }

    .notification-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      width: 380px;
      max-width: calc(100vw - 40px);
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      display: none;
      overflow: hidden;
    }

    .notification-dropdown.active {
      display: block;
      animation: dropdownIn 0.2s ease;
    }

    @keyframes dropdownIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .notification-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notification-header h3 {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
    }

    .notification-header h3 i {
      font-size: 16px;
    }

    .btn-mark-read {
      background: none;
      border: none;
      color: var(--venus-soft);
      font-size: 12px;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .btn-mark-read:hover {
      background: rgba(140, 150, 104, 0.1);
    }

    .btn-mark-read i {
      font-size: 14px;
    }

    .notification-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 14px 20px;
      border-bottom: 1px solid var(--line);
      display: flex;
      gap: 12px;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-item:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .notification-item.unread {
      background: rgba(140, 150, 104, 0.08);
    }

    .notification-item.unread::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 6px;
      background: var(--venus);
      border-radius: 50%;
    }

    .notification-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 18px;
    }

    .notification-icon.cita {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
    }

    .notification-icon.venta {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .notification-icon.tarjeta {
      background: rgba(140, 150, 104, 0.15);
      color: var(--venus-soft);
    }

    .notification-icon.sello {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
    }

    .notification-icon.giftcard {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
    }

    .notification-icon.cumple {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .notification-icon.cumpleaños {
      background: rgba(236, 72, 153, 0.15);
      color: #ec4899;
    }

    .notification-icon.premio {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .notification-icon.stock {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
    }

    .notification-icon.alerta {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .notification-title .new-tag {
      background: var(--venus);
      color: white;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }

    .notification-message {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .notification-time {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .notification-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--muted);
    }

    .notification-empty i {
      font-size: 40px;
      margin-bottom: 12px;
      opacity: 0.4;
    }

    .notification-empty p {
      font-size: 13px;
      margin: 0;
    }

    .notification-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--line);
      text-align: center;
    }

    .notification-footer button {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
    }

    .notification-footer button:hover {
      color: var(--venus-soft);
      text-decoration: underline;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>

<body class="checking-auth">

  <main class="wrap">
    <header class="topbar">
      <div class="brand">
        <img src="/assets/logo.png" alt="Venus">
        <div>
          <h1>Admin — Venus Lealtad</h1>
          <div class="muted" id="me-line">Sesión iniciada</div>
        </div>
      </div>
      <!-- Campana y menú móvil -->
      <div class="mobile-actions">
        <button class="notification-bell mobile-bell" onclick="toggleNotifications()" title="Notificaciones">
          <i class="fas fa-bell"></i>
          <span class="notification-badge hidden" id="notif-badge-mobile">0</span>
        </button>
        <button class="mobile-menu-btn" id="mobile-menu-toggle"><i class="fas fa-bars"></i></button>
      </div>

      <!-- Acciones desktop -->
      <div class="actions desktop-only">
        <!-- Campana de Notificaciones -->
        <div class="notification-wrapper">
          <button class="notification-bell" onclick="toggleNotifications()" title="Notificaciones">
            <i class="fas fa-bell"></i>
            <span class="notification-badge hidden" id="notif-badge">0</span>
          </button>

          <div class="notification-dropdown" id="notif-dropdown">
            <div class="notification-header">
              <h3><i class="fas fa-bell"></i> Notificaciones</h3>
              <button class="btn-mark-read" onclick="markAllRead()">
                <i class="fas fa-check-double"></i> Marcar leídas
              </button>
            </div>

            <div class="notification-list" id="notif-list">
              <div class="notification-empty">
                <i class="fas fa-bell-slash"></i>
                <p>No hay notificaciones</p>
              </div>
            </div>

            <div class="notification-footer">
              <button onclick="clearAllNotifications()">Limpiar todas</button>
            </div>
          </div>
        </div>

        <a class="btn" href="/" target="_blank" rel="noopener">Página clientes</a>
        <button id="logout" class="btn">Cerrar sesión</button>
      </div>
    </header>

    <div class="mobile-menu hidden" id="mobile-menu">
      <div class="mobile-menu-header">
        <span>Menú</span>
        <button class="close-menu-btn" id="mobile-menu-close"><i class="fas fa-times"></i></button>
      </div>
      <div class="mobile-menu-content">
        <a href="#overview" class="mobile-nav-link" data-tab="overview"><i class="fas fa-th-large"></i> Resumen</a>
        <a href="#cards" class="mobile-nav-link" data-tab="cards"><i class="fas fa-credit-card"></i> Tarjetas</a>
        <a href="#events" class="mobile-nav-link" data-tab="events"><i class="fas fa-gift"></i> Gift Cards</a>
        <a href="#appointments" class="mobile-nav-link" data-tab="appointments"><i class="fas fa-calendar"></i>
          Citas</a>
        <a href="#services" class="mobile-nav-link" data-tab="services"><i class="fas fa-sparkles"></i> Servicios</a>
        <a href="#settings" class="mobile-nav-link" data-tab="settings"><i class="fas fa-cog"></i> Configuración</a>
        <hr style="border-color:rgba(255,255,255,0.1);margin:10px 0;">
        <a href="/" target="_blank" class="mobile-nav-link"><i class="fas fa-external-link-alt"></i> Página clientes</a>
        <button id="logout-mobile" class="mobile-nav-link"
          style="width:100%;text-align:left;background:none;border:none;color:var(--ink);font-size:16px;padding:12px;"><i
            class="fas fa-sign-out-alt"></i> Cerrar sesión</button>
      </div>
    </div>

    <nav class="nav desktop-only">
      <a href="#overview" data-tab="overview" class="is-active"><i class="fas fa-th-large"></i> Resumen</a>
      <a href="#cards" data-tab="cards"><i class="fas fa-credit-card"></i> Tarjetas</a>
      <a href="#events" data-tab="events"><i class="fas fa-gift"></i> Gift Cards</a>
      <a href="#notifications" data-tab="notifications"><i class="fas fa-bell"></i> Notificaciones</a>
      <a href="#appointments" data-tab="appointments"><i class="fas fa-calendar"></i> Citas</a>
      <a href="#services" data-tab="services"><i class="fas fa-sparkles"></i> Servicios</a>
      <a href="#settings" data-tab="settings"><i class="fas fa-cog"></i> Configuración</a>
    </nav>

    <!-- TAB: Overview - MODIFICADO CON FILTROS Y REPORTES -->
    <section id="tab-overview" class="tab-content">
      <div class="header-actions" style="margin-bottom:20px;">
        <h2 id="dash-greeting">Buenos días</h2>
        <div style="display:flex;gap:10px;">
          <button class="btn primary" onclick="newApptDialog.showModal()">
            <i class="fas fa-plus"></i> Nueva Cita
          </button>
        </div>
      </div>

      <!-- Hero Stats -->
      <div class="hero-stats">
        <div class="hero-stat">
          <div class="hero-stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="hero-stat-value" id="stat-total-clients">0</div>
          <div class="hero-stat-label">Clientes activos</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-icon">
            <i class="fas fa-star"></i>
          </div>
          <div class="hero-stat-value" id="stat-stamps-month">0</div>
          <div class="hero-stat-label">Sellos este mes</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-icon">
            <i class="fas fa-gift"></i>
          </div>
          <div class="hero-stat-value" id="stat-redeems-month">0</div>
          <div class="hero-stat-label">Canjes este mes</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-icon">
            <i class="fas fa-trophy"></i>
          </div>
          <div class="hero-stat-value" id="stat-return-rate">0%</div>
          <div class="hero-stat-label">Tasa de retorno</div>
        </div>
      </div>

      <!-- Sección HOY -->
      <div class="today-grid">
        <div class="today-card" onclick="switchTab('tab-appointments')">
          <div class="today-card-icon citas">
            <i class="fas fa-calendar-check"></i>
          </div>
          <div class="today-card-info">
            <h4 id="today-appointments">0</h4>
            <p>Citas hoy</p>
          </div>
        </div>
        <div class="today-card">
          <div class="today-card-icon pendientes">
            <i class="fas fa-clock"></i>
          </div>
          <div class="today-card-info">
            <h4 id="today-pending">0</h4>
            <p>Por confirmar</p>
          </div>
        </div>
        <div class="today-card">
          <div class="today-card-icon ingresos">
            <i class="fas fa-dollar-sign"></i>
          </div>
          <div class="today-card-info">
            <h4 id="today-income">$0</h4>
            <p>Ingresos hoy</p>
          </div>
        </div>
      </div>

      <!-- Grid principal con sidebar -->
      <div class="dash-grid">
        <!-- Columna principal (vacía por ahora, se llenará en Fase 3) -->
        <div class="dash-main">
          <div class="card">
            <div class="card-header">
              <span class="card-title">
                <i class="fas fa-chart-line"></i> Actividad reciente
              </span>
            </div>
            <div class="card-body">
              <div style="position: relative; height: 250px; width: 100%;">
                <canvas id="activity-chart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar derecho -->
        <div class="dash-sidebar">
          <!-- Gift Cards -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">
                <i class="fas fa-gift"></i> Gift Cards
              </span>
              <a href="#" class="card-header-link" onclick="switchTab('tab-events');return false;">
                Ver todas <i class="fas fa-chevron-right"></i>
              </a>
            </div>
            <div class="card-body" style="padding:16px;">
              <div class="gc-summary">
                <div class="gc-summary-row">
                  <span class="gc-dot pending"></span>
                  <span class="gc-label">Pendientes</span>
                  <span class="gc-value" id="gc-pending">0</span>
                </div>
                <div class="gc-summary-row">
                  <span class="gc-dot expiring"></span>
                  <span class="gc-label">Por vencer (7 días)</span>
                  <span class="gc-value warning" id="gc-expiring">0</span>
                </div>
                <div class="gc-summary-row">
                  <span class="gc-dot redeemed"></span>
                  <span class="gc-label">Canjeadas este mes</span>
                  <span class="gc-value" id="gc-redeemed">0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Cumpleaños -->
          <div class="card" id="card-birthdays">
            <div class="card-header">
              <span class="card-title">
                <i class="fas fa-birthday-cake"></i> Cumpleaños
              </span>
            </div>
            <div class="card-body" style="padding:16px;">
              <div class="birthday-list" id="birthday-list">
                <div class="dash-empty">
                  <p>Sin cumpleaños próximos</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Top Clientes -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">
                <i class="fas fa-trophy"></i> Top Clientes
              </span>
            </div>
            <div class="card-body" style="padding:12px 16px;">
              <div id="top-clients-sidebar">
                <div class="dash-empty">
                  <p>Sin datos aún</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Wallets -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">
                <i class="fas fa-wallet"></i> Wallets
              </span>
            </div>
            <div class="card-body" style="padding:16px;">
              <div class="wallets-grid">
                <div class="wallet-card">
                  <div class="wallet-card-icon">🍎</div>
                  <div class="wallet-card-value" id="wallet-apple">0</div>
                  <div class="wallet-card-label">Apple Wallet</div>
                </div>
                <div class="wallet-card">
                  <div class="wallet-card-icon">🤖</div>
                  <div class="wallet-card-value" id="wallet-google">0</div>
                  <div class="wallet-card-label">Google Wallet</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </section>

    <!-- TAB: Cards -->
    <section id="tab-cards" class="card hidden">
      <h2>Tarjetas de lealtad</h2>
      <p class="muted">Gestiona todas las tarjetas de tus clientes.</p>

      <!-- KPI CUMPLEAÑOS -->
      <div id="birthday-section" class="hidden"
        style="margin: 15px 0; padding: 15px; background: rgba(255, 209, 102, 0.1); border: 1px solid rgba(255, 209, 102, 0.3); border-radius: 12px;">
        <div class="row" style="justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;"><i class="fas fa-birthday-cake"></i></span>
            <div>
              <h3 style="margin: 0; color: #ffd166;">Cumpleaños Cercanos</h3>
              <p class="muted" style="margin: 2px 0 0; font-size: 13px;">Clientes que cumplen años en los próximos 7
                días.</p>
            </div>
          </div>
          <div id="birthday-actions">
            <!-- Se llenará dinámicamente -->
          </div>
        </div>
        <div id="birthday-list" style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
          <!-- Lista de cumpleañeros -->
        </div>
      </div>

      <div class="row" style="margin-top:12px; align-items: center;">
        <input id="search-cards" placeholder="Buscar por nombre o teléfono..." style="flex:1;min-width:200px;">

        <!-- SORTING CONTROLS -->
        <select id="sort-cards" class="filter-select">
          <option value="created_at:desc">Recientes</option>
          <option value="created_at:asc">Antiguos</option>
          <option value="name:asc">Nombre (A-Z)</option>
          <option value="name:desc">Nombre (Z-A)</option>
          <option value="stamps:desc">Más sellos</option>
          <option value="stamps:asc">Menos sellos</option>
          <option value="last_visit:desc">Última visita</option>
        </select>

        <button id="btn-search-cards" class="btn primary"><i class="fas fa-search"></i> Buscar</button>
        <button id="btn-reload-cards" class="btn"><i class="fas fa-sync-alt"></i> Recargar</button>
        <button id="btn-scan-card" class="btn ghost"><i class="fas fa-qrcode"></i> Escanear QR</button>
      </div>

      <div class="table-wrap" style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Teléfono</th>
              <th>Última Visita</th>
              <th>Sellos</th>
              <th style="width:120px;">Acciones</th>
            </tr>
          </thead>
          <tbody id="cards-tbody">
            <tr>
              <td colspan="5" style="text-align:center;padding:12px;" class="muted">Cargando tarjetas...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:12px;">
        <button id="btn-prev-page" class="btn small ghost">← Anterior</button>
        <span id="page-info" class="muted">Página 1</span>
        <button id="btn-next-page" class="btn small ghost">Siguiente →</button>
      </div>
    </section>

    <!-- TAB: Gift Cards -->
    <section id="tab-events" class="tab-content hidden">
      <div class="header-actions">
        <h2><i class="fas fa-gift"></i> Gift Cards</h2>
        <button class="btn ghost" id="btn-scan-gift-card">
          <i class="fas fa-qrcode"></i> Escanear QR
        </button>
      </div>

      <!-- Stats -->
      <div class="gc-stats">
        <div class="gc-stat">
          <div class="gc-stat-value" id="gc-stat-total">0</div>
          <div class="gc-stat-label"><i class="fas fa-gift"></i> Total</div>
        </div>
        <div class="gc-stat">
          <div class="gc-stat-value" id="gc-stat-pending" style="color:var(--venus-soft);">0</div>
          <div class="gc-stat-label"><i class="fas fa-clock"></i> Pendientes</div>
        </div>
        <div class="gc-stat">
          <div class="gc-stat-value" id="gc-stat-redeemed" style="color:#22c55e;">0</div>
          <div class="gc-stat-label"><i class="fas fa-check-circle"></i> Canjeadas</div>
        </div>
        <div class="gc-stat">
          <div class="gc-stat-value" id="gc-stat-expired" style="color:#ef4444;">0</div>
          <div class="gc-stat-label"><i class="fas fa-times-circle"></i> Expiradas</div>
        </div>
      </div>

      <!-- Layout 2 columnas -->
      <div class="gc-layout">

        <!-- Columna izquierda: Crear -->
        <div class="card">
          <h3 style="font-size:15px;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
            <i class="fas fa-plus-circle"></i> Crear Gift Card
          </h3>

          <form id="form-giftcard">
            <div class="form-group">
              <label class="form-label">Para quién es (opcional)</label>
              <input type="text" id="gc-recipient" class="form-input" placeholder="Nombre del destinatario">
            </div>

            <div class="form-group">
              <label class="form-label">Servicio a regalar</label>
              <select id="gc-service" class="form-input" required>
                <option value="">Seleccionar servicio...</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Mensaje personalizado (opcional)</label>
              <input type="text" id="gc-message" class="form-input" placeholder="Ej: ¡Feliz cumpleaños!"
                maxlength="100">
            </div>

            <div class="form-group">
              <label class="form-label">Vigencia</label>
              <select id="gc-validity" class="form-input">
                <option value="30">30 días</option>
                <option value="60">60 días</option>
                <option value="90">90 días</option>
              </select>
            </div>

            <button type="submit" class="btn primary" style="width:100%;">
              <i class="fas fa-sparkles"></i> Generar Gift Card
            </button>
          </form>

          <!-- Preview -->
          <div class="gc-preview" id="gc-preview">
            <div class="gc-preview-logo">🎁</div>
            <h3>Gift Card Venus</h3>
            <div class="gc-preview-service" id="gc-preview-service">Selecciona un servicio</div>
            <div class="gc-preview-qr">
              <i class="fas fa-qrcode" style="font-size:50px;color:#333;"></i>
            </div>
            <div class="gc-preview-validity" id="gc-preview-validity">Válida por 30 días</div>
          </div>
        </div>

        <!-- Columna derecha: Lista -->
        <div class="card">
          <div
            style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px;">
            <h3 style="font-size:15px;display:flex;align-items:center;gap:8px;">
              <i class="fas fa-list"></i> Gift Cards
            </h3>
            <input type="text" id="gc-search" class="form-input" placeholder="Buscar..."
              style="width:180px;padding:8px 12px;">
          </div>

          <!-- Tabs -->
          <div class="gc-tabs">
            <button class="gc-tab active" data-filter="all">
              Todas <span class="gc-tab-count" id="gc-count-all">0</span>
            </button>
            <button class="gc-tab" data-filter="pending">
              <i class="fas fa-clock"></i> Pendientes <span class="gc-tab-count" id="gc-count-pending">0</span>
            </button>
            <button class="gc-tab" data-filter="redeemed">
              <i class="fas fa-check"></i> Canjeadas <span class="gc-tab-count" id="gc-count-redeemed">0</span>
            </button>
            <button class="gc-tab" data-filter="expired">
              <i class="fas fa-times"></i> Expiradas <span class="gc-tab-count" id="gc-count-expired">0</span>
            </button>
          </div>

          <!-- Lista -->
          <div class="gc-list" id="gc-list">
            <div class="gc-empty">
              <i class="fas fa-gift"></i>
              <p>No hay gift cards</p>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Modal Ver Gift Card -->
    <div id="modal-giftcard-view" class="modal-backdrop hidden">
      <div class="modal-card" style="max-width:420px;">
        <div class="modal-header">
          <h3><i class="fas fa-gift"></i> Gift Card</h3>
          <button class="btn small ghost" onclick="closeGiftCardModal()"><i class="fas fa-times"></i></button>
        </div>
        <div id="modal-giftcard-content" style="padding:0;">
          <!-- Contenido dinámico con diseño personalizado -->
        </div>
        <div class="modal-footer" style="justify-content:center;gap:8px;flex-wrap:wrap;">
          <button class="btn ghost" onclick="downloadGiftCardImage()">
            <i class="fas fa-download"></i> Descargar
          </button>
          <button class="btn ghost" onclick="copyGiftCardLink()">
            <i class="fas fa-link"></i> Copiar link
          </button>
          <button class="btn primary" onclick="sendGiftCardWhatsAppImage()">
            <i class="fab fa-whatsapp"></i> WhatsApp
          </button>
        </div>
      </div>
    </div>

    <!-- TAB: Settings - MEJORADO CON DEBUGGING -->
    <section id="tab-settings" class="card hidden">
      <h2>Configuración</h2>
      <p class="muted">Envía notificaciones push a todos los pases en Google Wallet.</p>

      <div
        style="background:rgba(140,150,104,0.1);border:1px solid rgba(140,150,104,0.3);border-radius:12px;padding:14px;margin:12px 0;">
        <h3 style="margin:0 0 8px;"><i class="fas fa-mobile-alt"></i> Notificaciones Push</h3>

        <form id="push-notification-form">
          <label>Título de la notificación</label>
          <input id="push-title" placeholder="Ej. ¡Nueva promoción!" required maxlength="50">
          <small class="muted">Máximo 50 caracteres</small>

          <label style="margin-top:10px;">Mensaje</label>
          <textarea id="push-message" placeholder="Ej. Hoy tenemos 20% de descuento..." required maxlength="200"
            rows="3"></textarea>
          <small class="muted">Máximo 200 caracteres</small>

          <label style="margin-top:10px;">Tipo</label>
          <select id="push-type">
            <option value="promo">Promoción</option>
            <option value="reminder">Recordatorio</option>
            <option value="update">Actualización</option>
            <option value="alert">⚠️ Alerta</option>
          </select>

          <div style="margin-top:12px;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;">
            <div class="row" style="justify-content:space-between;margin-bottom:8px;">
              <span class="muted" style="font-size:12px;">Vista previa:</span>
              <span id="preview-type" style="font-size:12px;">🎁 Promoción</span>
            </div>
            <div style="background:rgba(255,255,255,0.1);border-radius:8px;padding:10px;">
              <div id="preview-title" style="font-weight:600;margin-bottom:4px;">¡Nueva promoción!</div>
              <div id="preview-message" class="muted" style="font-size:12px;">Tu mensaje aparecerá aquí...</div>
            </div>
          </div>

          <div class="row" style="margin-top:14px;gap:10px;">
            <button type="button" id="btn-mass-push" class="btn primary">Enviar a todos</button>
            <button type="button" id="test-push" class="btn ghost">Enviar prueba</button>
          </div>
        </form>

        <div id="push-success" class="success-message hidden" style="margin-top:12px;">
          ✅ Notificación enviada a <span id="push-count">0</span> pases
        </div>

        <div id="push-error" class="hidden"
          style="background:rgba(254,202,202,0.1);border:1px solid rgba(153,27,27,0.3);border-radius:10px;padding:10px 12px;margin-top:12px;font-size:13px;color:#fecaca;">
          ❌ Error al enviar notificación
        </div>
      </div>

      <div style="margin-top:16px;">
        <div class="row" style="justify-content:space-between;margin-bottom:8px;">
          <h3 style="margin:0;"><i class="fas fa-list"></i> Historial</h3>
          <div style="display:flex;gap:8px;">
            <button id="refresh-history" class="btn small ghost" title="Refrescar"><i
                class="fas fa-sync-alt"></i></button>
            <button id="clear-notif-history" class="btn small ghost" style="color:#ef4444;" title="Borrar historial"><i
                class="fas fa-trash"></i></button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Título</th>
                <th>Tipo</th>
                <th>Enviadas</th>
                <th>Errores</th>
              </tr>
            </thead>
            <tbody id="notifications-history">
              <tr>
                <td colspan="5" style="text-align:center;padding:12px;" class="muted">Cargando...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- NUEVA SECCIÓN: DEBUGGING AVANZADO -->
      <div class="debug-section">
        <h3 style="margin:0 0 12px;font-size:15px;color:var(--ink);"><i class="fas fa-bug"></i> Debugging Avanzado</h3>

        <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:12px;">
          <button id="btn-test-apple-push" class="btn small"><i class="fas fa-flask"></i> Test Apple Push</button>
          <button id="btn-test-google-push" class="btn small"><i class="fas fa-flask"></i> Test Google Push</button>
          <button id="btn-fix-google-wallet" class="btn small"><i class="fas fa-wrench"></i> Reparar Google
            Wallet</button>
          <button id="btn-check-devices" class="btn small"><i class="fas fa-mobile-alt"></i> Ver Dispositivos</button>
          <button id="btn-check-apns" class="btn small"><i class="fab fa-apple"></i> Ver Config APNs</button>
        </div>

        <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--line);">
          <h4 style="margin:0 0 10px;font-size:13px;color:var(--venus-soft);">Simular Webhook WhatsApp (Local)</h4>
          <div class="row" style="gap:8px;flex-wrap:wrap;">
            <button class="btn small ghost" onclick="simulateWebhook('confirmar')"><i class="fas fa-check"></i> Simular
              Confirmar</button>
            <button class="btn small ghost" onclick="simulateWebhook('reprogramar')"><i class="fas fa-clock"></i>
              Simular Reprogramar</button>
            <button class="btn small ghost" onclick="simulateWebhook('cancelar')"><i class="fas fa-times"></i> Simular
              Cancelar</button>
          </div>
        </div>
        <div id="debug-output" class="debug-output hidden">
          <!-- Aquí se mostrarán los resultados del debugging -->
        </div>
      </div>
    </section>

    <!-- TAB: Notificaciones -->
    <section id="tab-notifications" class="card hidden">
      <h2><i class="fas fa-bell"></i> Notificaciones</h2>
      <p class="muted" style="margin:0 0 20px;font-size:13px;">
        Configura notificaciones automáticas para diferentes eventos del programa de lealtad.
      </p>

      <!-- Botón ejecutar todas -->
      <div style="margin-bottom:24px;">
        <button id="btn-run-all-automations" class="btn primary">
          <i class="fas fa-play"></i> Ejecutar Automatizaciones Activas
        </button>
        <span class="muted" style="font-size:12px;margin-left:10px;">Procesa todas las reglas activas ahora</span>
      </div>

      <!-- Regla 1: Cumpleaños -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon"><i class="fas fa-birthday-cake"></i></span>
            <span class="automation-title">Recordatorio de Cumpleaños</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-birthday-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <label class="automation-label">Días de anticipación:</label>
          <input type="number" id="auto-birthday-days" class="automation-input" value="3" min="0" max="30">

          <label class="automation-label" style="margin-top:10px;">Mensaje:</label>
          <textarea id="auto-birthday-message" class="automation-textarea"
            rows="2">¡Feliz cumpleaños! 🎉 Te esperamos con un regalo especial en Venus.</textarea>

          <button class="btn small ghost automation-test-btn" data-type="birthday"><i class="fas fa-flask"></i>
            Probar</button>
        </div>
      </div>

      <!-- Regla 2: Inactividad -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon"><i class="fas fa-moon"></i></span>
            <span class="automation-title">Alerta de Inactividad</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-inactivity-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <label class="automation-label">Días sin visita:</label>
          <input type="number" id="auto-inactivity-days" class="automation-input" value="30" min="7" max="180">

          <label class="automation-label" style="margin-top:10px;">Mensaje:</label>
          <textarea id="auto-inactivity-message" class="automation-textarea"
            rows="2">¡Te extrañamos! 😊 Hace tiempo que no te vemos. Ven y disfruta nuestros servicios.</textarea>

          <button class="btn small ghost automation-test-btn" data-type="inactivity"><i class="fas fa-flask"></i>
            Probar</button>
        </div>
      </div>

      <!-- Regla 3: Tarjeta Completada -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon"><i class="fas fa-gift"></i></span>
            <span class="automation-title">Tarjeta Completada</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-completed-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <p class="muted" style="font-size:12px;margin:0 0 10px;">Notificación cuando el cliente complete su tarjeta.
          </p>

          <label class="automation-label">Mensaje:</label>
          <textarea id="auto-completed-message" class="automation-textarea"
            rows="2">¡Felicidades! 🎁 Has completado tu tarjeta. Ven a canjear tu premio.</textarea>

          <button class="btn small ghost automation-test-btn" data-type="completed"><i class="fas fa-flask"></i>
            Probar</button>
        </div>
      </div>

      <!-- Regla 4: Casi Completa -->
      <div class="automation-card">
        <div class="automation-header">
          <div>
            <span class="automation-icon">⚡</span>
            <span class="automation-title">Casi Completa (Motivacional)</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="auto-almost-enabled" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="automation-body">
          <label class="automation-label">Faltan X sellos:</label>
          <input type="number" id="auto-almost-stamps" class="automation-input" value="2" min="1" max="5">

          <label class="automation-label" style="margin-top:10px;">Mensaje:</label>
          <textarea id="auto-almost-message" class="automation-textarea"
            rows="2">¡Ya casi! ⚡ Solo te faltan [X] sellos para tu premio. ¡No esperes más!</textarea>

          <button class="btn small ghost automation-test-btn" data-type="almost">🧪 Probar</button>
        </div>
      </div>

      <!-- Historial de automatizaciones -->
      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--line);">
        <h4 style="margin:0 0 10px;font-size:14px;color:var(--venus-soft);"><i class="fas fa-list"></i> Historial
          Reciente</h4>
        <div id="automation-history" class="automation-history">
          <p class="muted" style="font-size:12px;">No hay envíos recientes</p>
        </div>
      </div>
    </section>

    <!-- TAB: Citas -->
    <section id="tab-appointments" class="tab-content hidden">
      <div class="header-actions">
        <h2><i class="fas fa-calendar"></i> Agenda de Citas</h2>
        <button class="btn primary" id="btn-new-appointment">Nueva Cita</button>
      </div>

      <!-- Calendario Semanal -->
      <div class="card" style="margin-bottom:20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3 style="margin:0;">Semana Actual</h3>
          <div style="display:flex;gap:8px;">
            <button class="btn small ghost" id="btn-prev-week">← Anterior</button>
            <button class="btn small ghost" id="btn-today">Hoy</button>
            <button class="btn small ghost" id="btn-next-week">Siguiente →</button>
          </div>
        </div>
        <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
          <div id="weekly-calendar" style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;min-width: 800px;">
          </div>
        </div>
      </div>

      <!-- Citas del Día Seleccionado -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h3 style="margin:0;">Citas del <span id="selected-date-label">Hoy</span></h3>
          <button class="btn small" id="btn-refresh-appts"><i class="fas fa-sync-alt"></i> Actualizar</button>
        </div>

        <table class="data-table">
          <thead>
            <tr>
              <th>Hora</th>
              <th>Cliente</th>
              <th>Servicio</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="appts-tbody">
            <tr>
              <td colspan="5" style="text-align:center;padding:20px;">Cargando...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Historial del Mes -->
      <div class="card" style="margin-top:20px;">
        <h3 style="margin-top:0;">Historial del Mes</h3>
        <div id="month-stats"
          style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:16px;">
          <div class="stat-card">
            <div class="stat-label">Total Citas</div>
            <div class="stat-value" id="stat-total">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Completadas</div>
            <div class="stat-value" id="stat-completed">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Canceladas</div>
            <div class="stat-value" id="stat-cancelled">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Pendientes</div>
            <div class="stat-value" id="stat-pending">-</div>
          </div>
        </div>
      </div>

      <!-- Resumen de Ventas del Mes -->
      <div class="card" style="margin-top:20px;">
        <h3 style="margin-top:0;"><i class="fas fa-dollar-sign"></i> Ventas del Mes</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;">
          <div class="stat-card">
            <div class="stat-label"><i class="fas fa-money-bill"></i> Efectivo</div>
            <div class="stat-value stat-money" id="revenue-cash">$0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label"><i class="fas fa-credit-card"></i> Tarjeta</div>
            <div class="stat-value stat-money" id="revenue-card">$0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label"><i class="fas fa-building"></i> Transferencia</div>
            <div class="stat-value stat-money" id="revenue-transfer">$0.00</div>
          </div>
          <div class="stat-card">
            <div class="stat-label"><i class="fas fa-dollar-sign"></i> Total</div>
            <div class="stat-value stat-money" id="revenue-total" style="color:#FFD166;font-weight:700;">$0.00</div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: Servicios y Productos -->
    <section id="tab-services" class="tab-content hidden">
      <div class="header-actions">
        <h2><i class="fas fa-sparkles"></i> Catálogo</h2>
      </div>

      <!-- Tabs Header -->
      <div class="tabs-header" style="margin-bottom:0;border-radius:12px 12px 0 0;">
        <button class="tab-btn active" onclick="switchCatalogTab('services')" id="btn-tab-services">
          <i class="fas fa-sparkles"></i> Servicios
          <span class="tab-count" id="services-count">0</span>
        </button>
        <button class="tab-btn" onclick="switchCatalogTab('products')" id="btn-tab-products">
          <i class="fas fa-shopping-bag"></i> Productos
          <span class="tab-count" id="products-count">0</span>
        </button>
      </div>

      <div class="card" style="border-radius:0 0 12px 12px;margin-top:0;">

        <!-- Panel: Servicios -->
        <div id="panel-services" class="tab-panel active">
          <div class="row" style="gap:12px;margin-bottom:16px;flex-wrap:wrap;">
            <input type="text" id="search-services" class="form-input" placeholder="Buscar servicio..."
              style="flex:1;min-width:200px;">
            <button class="btn primary" id="btn-new-service"><i class="fas fa-plus"></i> Nuevo Servicio</button>
          </div>

          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Duración</th>
                  <th>Precio</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="services-tbody">
                <tr>
                  <td colspan="4" class="muted" style="text-align:center;padding:20px;">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Panel: Productos -->
        <div id="panel-products" class="tab-panel">
          <!-- Stats -->
          <div class="stats-bar">
            <div class="stat-item">
              <span class="stat-value" id="stat-products-total">0</span>
              <span class="stat-label">Productos</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="stat-products-value">$0</span>
              <span class="stat-label">Valor inventario</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="stat-products-low" style="color:#fbbf24;">0</span>
              <span class="stat-label">Stock bajo</span>
            </div>
          </div>

          <div class="row" style="gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center;">
            <input type="text" id="search-products" class="form-input" placeholder="Buscar producto..."
              style="flex:1;min-width:200px;">
            <div class="filter-chips">
              <span class="chip active" data-category="all" onclick="filterProducts('all')">Todos</span>
              <span class="chip" data-category="skincare" onclick="filterProducts('skincare')">Skincare</span>
              <span class="chip" data-category="maquillaje" onclick="filterProducts('maquillaje')">Maquillaje</span>
              <span class="chip" data-category="corporal" onclick="filterProducts('corporal')">Corporal</span>
            </div>
            <button class="btn primary" id="btn-new-product"><i class="fas fa-plus"></i> Nuevo Producto</button>
          </div>

          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Categoría</th>
                  <th>Precio</th>
                  <th>Stock</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="products-tbody">
                <tr>
                  <td colspan="5" class="muted" style="text-align:center;padding:20px;">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <!-- Modal Nuevo/Editar Producto -->
    <div id="modal-product" class="modal-backdrop hidden">
      <div class="modal-card">
        <div class="modal-header">
          <h3 id="modal-product-title"><i class="fas fa-shopping-bag"></i> Nuevo Producto</h3>
          <button class="btn small ghost" id="close-modal-product"><i class="fas fa-times"></i></button>
        </div>

        <form id="form-product">
          <input type="hidden" id="product-id">

          <div class="form-group">
            <label class="form-label">Nombre del producto</label>
            <input type="text" id="product-name" class="form-input" required placeholder="Ej: Sérum Vitamina C">
          </div>

          <div class="row" style="gap:12px;">
            <div class="form-group" style="flex:1;">
              <label class="form-label">Categoría</label>
              <select id="product-category" class="form-input" required>
                <option value="skincare">Skincare</option>
                <option value="maquillaje">Maquillaje</option>
                <option value="corporal">Corporal</option>
                <option value="cabello">Cabello</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="form-group" style="flex:1;">
              <label class="form-label">Presentación</label>
              <input type="text" id="product-presentation" class="form-input" placeholder="Ej: 30ml, 50g">
            </div>
          </div>

          <div class="row" style="gap:12px;">
            <div class="form-group" style="flex:1;">
              <label class="form-label">Precio de venta</label>
              <div style="position:relative;">
                <span
                  style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);">$</span>
                <input type="number" id="product-price" class="form-input" required min="0" step="10"
                  style="padding-left:25px;">
              </div>
            </div>
            <div class="form-group" style="flex:1;">
              <label class="form-label">Costo (opcional)</label>
              <div style="position:relative;">
                <span
                  style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);">$</span>
                <input type="number" id="product-cost" class="form-input" min="0" step="10" style="padding-left:25px;">
              </div>
            </div>
          </div>

          <div class="row" style="gap:12px;">
            <div class="form-group" style="flex:1;">
              <label class="form-label">Stock actual</label>
              <input type="number" id="product-stock" class="form-input" required min="0" value="0">
            </div>
            <div class="form-group" style="flex:1;">
              <label class="form-label">Stock mínimo (alerta)</label>
              <input type="number" id="product-min-stock" class="form-input" min="0" value="5">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Descripción (opcional)</label>
            <input type="text" id="product-description" class="form-input" placeholder="Breve descripción">
          </div>

          <div class="modal-footer">
            <button type="button" class="btn ghost" id="cancel-product">Cancelar</button>
            <button type="submit" class="btn primary"><i class="fas fa-save"></i> Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- DIALOG: Nueva Cita -->
    <dialog id="newApptDialog">
      <div class="dialog-content">
        <h3 style="margin-top:0;margin-bottom:20px;"><i class="fas fa-calendar"></i> Agendar Cita</h3>
        <form id="form-new-appt">
          <div style="display:grid;gap:16px;">
            <!-- Cliente con búsqueda editable -->
            <div>
              <label class="form-label">Cliente</label>
              <div class="custom-select-wrapper">
                <input type="text" id="new-appt-client-select" class="form-input"
                  placeholder="Buscar o escribir nombre..." autocomplete="off">
                <span class="dropdown-toggle-icon">▼</span>
                <div id="clients-dropdown-list" class="custom-dropdown-list" style="display:none;"></div>
              </div>
              <button type="button" id="btn-toggle-new-client" class="btn small ghost" style="margin-top:8px;">
                + Registrar nuevo cliente
              </button>

              <!-- Panel Historial de Citas - Clic para seleccionar servicio -->
              <div id="client-history-panel" class="client-history-panel hidden">
                <div class="history-header" id="toggle-history">
                  <div style="display:flex;align-items:center;gap:8px;">
                    <span class="history-toggle-icon">▼</span>
                    <span><i class="fas fa-calendar"></i> Citas anteriores</span>
                    <span class="history-count" id="history-count">(0)</span>
                  </div>
                  <span class="history-hint" id="history-hint">Clic para repetir servicio</span>
                </div>
                <div class="history-content" id="history-content" style="display:none;">
                  <div id="history-list" class="history-list">
                  </div>
                </div>
              </div>
            </div>

            <!-- Formulario Nuevo Cliente (oculto por defecto) -->
            <div id="new-client-form"
              style="display:none;background:rgba(140,150,104,0.1);border:1px solid rgba(140,150,104,0.3);border-radius:12px;padding:16px;">
              <h4 style="margin:0 0 12px 0;color:var(--venus-soft);">Nuevo Cliente</h4>
              <div style="display:grid;gap:12px;">
                <div>
                  <label class="form-label">Nombre completo</label>
                  <input type="text" id="new-client-name" class="form-input" placeholder="Ej: María González">
                </div>
                <div>
                  <label class="form-label">Teléfono</label>
                  <input type="tel" id="new-client-phone" class="form-input" placeholder="52...">
                </div>
                <button type="button" id="btn-save-new-client" class="btn small primary">Guardar Cliente</button>
              </div>
            </div>

            <!-- Teléfono -->
            <div>
              <label class="form-label">Teléfono</label>
              <input type="tel" id="new-appt-phone" class="form-input" placeholder="4421234567" required>
            </div>

            <!-- Servicio y Precio -->
            <div class="grid-service-price">
              <div>
                <label class="form-label">Servicio</label>
                <div class="custom-select-wrapper">
                  <input type="text" id="new-appt-service" class="form-input"
                    placeholder="Buscar o escribir servicio..." autocomplete="off" required>
                  <span class="dropdown-toggle-icon">▼</span>
                  <div id="services-dropdown-list" class="custom-dropdown-list" style="display:none;"></div>
                </div>
              </div>
              <div>
                <label class="form-label">Precio</label>
                <div style="position:relative;">
                  <span
                    style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--venus-soft);font-size:14px;">$</span>
                  <input type="number" id="new-appt-price" class="form-input" placeholder="0" min="0" step="10"
                    style="padding-left:28px;">
                </div>
              </div>
            </div>

            <!-- Fecha y Hora -->
            <div class="grid-date-time">
              <div style="position:relative;">
                <label class="form-label"><i class="fas fa-calendar"></i> Fecha</label>
                <input type="text" id="new-appt-date" class="form-input date-picker-input" readonly required
                  placeholder="Seleccionar fecha" style="cursor:pointer;">
                <div id="new-appt-calendar" class="calendar-dropdown" style="display:none;"></div>
              </div>
              <div>
                <label class="form-label">Hora</label>
                <select id="new-appt-hour" class="form-input" required>
                  <option value="">--</option>
                </select>
              </div>
              <div>
                <label class="form-label">Min</label>
                <select id="new-appt-minute" class="form-input" required>
                  <option value="">--</option>
                </select>
              </div>
              <div>
                <label class="form-label">Hora fin</label>
                <input type="text" id="new-appt-end-time" class="form-input" readonly
                  style="background:rgba(0,0,0,0.15);color:var(--muted);">
              </div>
            </div>

            <!-- Recordatorios -->
            <div class="reminders-section">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                <svg width="18" height="18" fill="none" stroke="var(--venus-soft)" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                  </path>
                </svg>
                <span style="font-size:13px;font-weight:600;color:var(--venus-soft);">Recordatorios por
                  WhatsApp</span>
              </div>
              <div style="display:grid;gap:10px;">
                <label class="reminder-option">
                  <input type="checkbox" id="check-whatsapp-confirm" checked>
                  <span class="reminder-text">
                    <strong>Confirmación inmediata</strong>
                    <small>Se envía al crear la cita</small>
                  </span>
                </label>
                <label class="reminder-option">
                  <input type="checkbox" id="check-whatsapp-24h" checked>
                  <span class="reminder-text">
                    <strong>24 horas antes</strong>
                    <small>Recordatorio automático</small>
                  </span>
                </label>
                <label class="reminder-option">
                  <input type="checkbox" id="check-whatsapp-2h" checked>
                  <span class="reminder-text">
                    <strong>2 horas antes</strong>
                    <small>Recordatorio final</small>
                  </span>
                </label>
              </div>
            </div>

            <!-- Botones -->
            <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
              <button type="button" class="btn ghost" id="btn-cancel-appt">Cancelar</button>
              <button type="submit" class="btn primary">Agendar</button>
            </div>
          </div>
        </form>
      </div>
    </dialog>

    <!-- Modal: Modificar Cita -->
    <dialog id="editApptDialog">
      <div class="dialog-content">
        <h2><i class="fas fa-edit"></i> Modificar Cita</h2>
        <form id="form-edit-appt">
          <input type="hidden" id="edit-appt-id">

          <div class="form-grid">
            <!-- Cliente (congelado) -->
            <div style="grid-column: 1/3;">
              <label class="form-label">Cliente (no editable)</label>
              <input type="text" id="edit-appt-client-name" class="form-input" readonly
                style="background:rgba(255,255,255,0.05);cursor:not-allowed;">
            </div>

            <!-- Servicio -->
            <div style="grid-column: 1/3;">
              <label class="form-label">Servicio</label>
              <div class="custom-select-wrapper">
                <input type="text" id="edit-appt-service" class="form-input" required>
                <span class="dropdown-toggle-icon">▼</span>
                <div id="edit-services-dropdown-list" class="custom-dropdown-list" style="display:none;"></div>
              </div>
            </div>

            <div>
              <label class="form-label">Precio</label>
              <div style="position:relative;">
                <span
                  style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--venus-soft);font-size:14px;">$</span>
                <input type="number" id="edit-appt-price" class="form-input" readonly style="padding-left:28px;">
              </div>
            </div>

            <div>
              <label class="form-label">Duración (min)</label>
              <input type="number" id="edit-appt-duration" class="form-input" readonly>
            </div>

            <!-- Fecha y Hora -->
            <div class="grid-date-time full-width">
              <div style="position:relative;">
                <label class="form-label"><i class="fas fa-calendar"></i> Fecha</label>
                <input type="text" id="edit-appt-date" class="form-input date-picker-input" readonly required
                  placeholder="Seleccionar fecha" style="cursor:pointer;">
                <div id="edit-appt-calendar" class="calendar-dropdown" style="display:none;"></div>
              </div>
              <div>
                <label class="form-label">Hora</label>
                <select id="edit-appt-hour" class="form-input" required style="width:100px;">
                  <option value="">--</option>
                </select>
              </div>
              <div>
                <label class="form-label">Min</label>
                <select id="edit-appt-minute" class="form-input" required style="width:90px;">
                  <option value="">--</option>
                </select>
              </div>
              <div>
                <label class="form-label">Termina</label>
                <input type="text" id="edit-appt-end-time" class="form-input" readonly>
              </div>
            </div>

            <!-- Botones -->
            <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;grid-column:1/3;">
              <button type="button" class="btn ghost" id="btn-cancel-edit-appt">Cancelar</button>
              <button type="submit" class="btn primary">Guardar Cambios</button>
            </div>
          </div>
        </form>
      </div>
    </dialog>

    <!-- PAYMENT DIALOG -->
    <dialog id="paymentDialog">
      <button class="btn-close-payment" onclick="closePaymentModal()" title="Cerrar">
        <i class="fas fa-times"></i>
      </button>

      <div class="dialog-header">
        <h3><i class="fas fa-receipt"></i> Cobrar Servicio</h3>
      </div>

      <div style="padding:0 20px 20px;">
        <!-- Info cliente y servicio -->
        <div class="payment-info-row">
          <div class="payment-info-box">
            <div class="payment-info-label">Cliente</div>
            <div class="payment-info-value" id="payment-client-name">-</div>
          </div>
          <div class="payment-info-box">
            <div class="payment-info-label">Servicio</div>
            <div class="payment-info-value" id="payment-service-name">-</div>
            <div class="payment-price-row">
              <span class="payment-price-display" id="payment-price-display">$0</span>
              <input type="number" class="payment-price-input" id="payment-price-input" min="0" step="10">
              <button class="btn-edit-price" onclick="togglePriceEdit()" title="Editar precio">
                <i class="fas fa-pencil" style="font-size:12px;"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Productos -->
        <div class="payment-section">
          <div class="payment-section-header">
            <span class="payment-section-title">
              <i class="fas fa-shopping-bag"></i> Productos
            </span>
          </div>

          <div class="product-add-row">
            <select id="payment-product-select">
              <option value="">Agregar producto...</option>
            </select>
            <input type="number" id="payment-product-qty" value="1" min="1" max="99">
            <button type="button" onclick="addProductToPayment()">
              <i class="fas fa-plus"></i>
            </button>
          </div>

          <div class="payment-product-list" id="payment-products-list">
            <div class="payment-products-empty">Sin productos adicionales</div>
          </div>
        </div>

        <!-- Descuento -->
        <div class="payment-section">
          <div class="payment-section-header">
            <span class="payment-section-title">
              <i class="fas fa-percent"></i> Descuento
            </span>
          </div>

          <div class="discount-row">
            <div class="discount-toggle">
              <button class="active" onclick="setDiscountType('percent')" id="btn-discount-percent">%</button>
              <button onclick="setDiscountType('fixed')" id="btn-discount-fixed">$</button>
            </div>
            <div class="discount-input-wrap">
              <input type="number" id="payment-discount-value" placeholder="0" min="0" value="0"
                oninput="calculateTotals()">
              <span class="discount-symbol" id="discount-symbol">%</span>
            </div>
          </div>

          <div class="discount-applied" id="discount-applied">
            <i class="fas fa-tag"></i>
            <span id="discount-applied-text">Descuento aplicado: -$0</span>
          </div>
        </div>

        <!-- Totales -->
        <div class="payment-totals">
          <div class="payment-total-row sub">
            <span>Servicio</span>
            <span id="total-service">$0</span>
          </div>
          <div class="payment-total-row sub" id="total-products-row" style="display:none;">
            <span>Productos (<span id="total-products-count">0</span>)</span>
            <span id="total-products">$0</span>
          </div>
          <div class="payment-total-row subtotal-line">
            <span>Subtotal</span>
            <span id="total-subtotal">$0</span>
          </div>
          <div class="payment-total-row discount" id="total-discount-row">
            <span id="total-discount-label">Descuento</span>
            <span id="total-discount">-$0</span>
          </div>
          <div class="payment-total-row grand">
            <span>Total</span>
            <span id="total-grand">$0</span>
          </div>
        </div>

        <!-- Método de pago -->
        <div class="form-row" style="margin-top:16px;margin-bottom:0;">
          <label>Método de Pago <span style="color:#ef4444;">*</span></label>
          <select id="payment-method" class="form-input">
            <option value="efectivo">Efectivo</option>
            <option value="tarjeta_credito">Tarjeta de crédito</option>
            <option value="tarjeta_debito">Tarjeta de débito</option>
            <option value="transferencia">Transferencia</option>
          </select>
        </div>

        <!-- Campos ocultos -->
        <input type="hidden" id="payment-appointment-id">
        <input type="hidden" id="payment-original-price">
      </div>

      <div class="dialog-footer">
        <button class="btn primary btn-cobrar" onclick="savePayment()" id="btn-save-payment">
          <i class="fas fa-check-circle"></i>
          Cobrar <span id="btn-payment-total">$0</span>
        </button>
        <button type="button" onclick="closePaymentModal()" class="btn ghost">Cancelar</button>
      </div>
    </dialog>

    <style>
      /* Dialog Styles - Backdrop Opaco */
      #newApptDialog::backdrop {
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
      }

      #newApptDialog {
        border: none;
        border-radius: 16px;
        padding: 0;
        max-width: 650px;
        width: 90%;
        background: transparent;
      }

      .dialog-content {
        background: var(--bg-card);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 24px;
        color: #fff;
      }

      /* Form Elements */
      .form-label {
        display: block;
        font-size: 12px;
        margin-bottom: 6px;
        color: var(--venus-soft);
        font-weight: 500;
      }

      .form-input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--line);
        background: rgba(0, 0, 0, 0.3);
        color: #fff;
        font-size: 14px;
        transition: all 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--venus-green);
        background: rgba(0, 0, 0, 0.4);
      }

      .form-input:disabled,
      .form-input:read-only {
        background: rgba(0, 0, 0, 0.15);
        color: var(--muted);
        cursor: not-allowed;
      }

      /* Reminders Section */
      .reminders-section {
        background: rgba(140, 150, 104, 0.1);
        border: 1px solid rgba(140, 150, 104, 0.3);
        border-radius: 12px;
        padding: 16px;
      }

      .reminder-option {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
      }

      .reminder-option:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .reminder-option {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        transition: all 0.2s;
      }

      .reminder-option:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .reminder-option input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        margin-top: 3px;
        width: 20px;
        height: 20px;
        cursor: pointer;
        border: 2px solid var(--venus-soft);
        border-radius: 6px;
        background: rgba(0, 0, 0, 0.3);
        position: relative;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .reminder-option input[type="checkbox"]:hover {
        border-color: var(--venus-green);
        background: rgba(140, 150, 104, 0.1);
      }

      .reminder-option input[type="checkbox"]:checked {
        background: var(--venus-green);
        border-color: var(--venus-green);
      }

      /* Checkmark dibujado con CSS - BLANCO Y GRUESO */
      .reminder-option input[type="checkbox"]:checked::after {
        content: "";
        position: absolute;
        left: 6px;
        top: 2px;
        width: 6px;
        height: 12px;
        border: solid #fff;
        border-width: 0 3px 3px 0;
        transform: rotate(45deg);
        filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.5));
      }

      .reminder-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .reminder-text strong {
        font-size: 14px;
        color: #fff;
        font-weight: 500;
      }

      .reminder-text small {
        font-size: 12px;
        color: var(--muted);
        line-height: 1.4;
      }

      /* Weekly Calendar */
      .day-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .day-card:hover {
        background: rgba(140, 150, 104, 0.1);
        border-color: var(--venus-green);
      }

      .day-card.selected {
        background: rgba(140, 150, 104, 0.2);
        border-color: var(--venus-green);
      }

      .day-card.today {
        border: 2px solid var(--venus-green);
      }

      .day-name {
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        margin-bottom: 4px;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .data-table th,
      .data-table td {
        padding: 12px 8px;
        text-align: left;
        border-bottom: 1px solid var(--line);
      }

      .data-table th {
        font-weight: 600;
        color: var(--venus-soft);
        background: rgba(255, 255, 255, .02);
      }

      .data-table tbody tr:hover {
        background: rgba(255, 255, 255, .03);
      }

      /* Responsive table */
      @media (max-width: 768px) {
        .data-table thead {
          display: none;
        }

        .data-table,
        .data-table tbody,
        .data-table tr,
        .data-table td {
          display: block;
          width: 100%;
        }

        .data-table tr {
          margin-bottom: 20px;
          border: 1px solid rgba(140, 150, 104, 0.3);
          border-radius: 16px;
          padding: 16px;
          background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .data-table td {
          padding: 0;
          border: none;
          position: relative;
          padding-left: 0;
          text-align: left;
          margin-bottom: 12px;
        }

        .data-table td:last-child {
          margin-bottom: 0;
        }

        .data-table td::before {
          content: attr(data-label);
          display: block;
          font-weight: 600;
          color: var(--venus-soft);
          font-size: 11px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          margin-bottom: 4px;
        }

        /* First cell (time) - make it prominent */
        .data-table td:first-child {
          font-size: 28px;
          font-weight: 700;
          color: var(--venus-soft);
          margin-bottom: 16px;
          padding-bottom: 12px;
          border-bottom: 1px solid rgba(140, 150, 104, 0.2);
        }

        .data-table td:first-child::before {
          font-size: 10px;
          color: var(--muted);
        }

        /* Actions cell - full width buttons */
        .data-table td .actions,
        .data-table td:last-child {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-top: 16px;
          padding-top: 12px;
          border-top: 1px solid rgba(140, 150, 104, 0.1);
        }

        .data-table td .actions button,
        .data-table td:last-child button {
          width: 100%;
          justify-content: center;
          padding: 12px 16px;
          font-size: 15px;
          border-radius: 12px;
        }

        /* Hide label for actions */
        .data-table td:last-child::before {
          display: none;
        }
      }

      .day-number {
        font-size: 20px;
        font-weight: 700;
        color: #fff;
        margin-bottom: 4px;
      }

      .day-count {
        font-size: 11px;
        color: var(--venus-soft);
      }

      /* Stats Cards */
      .stat-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
      }

      .stat-label {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--venus-soft);
      }

      /* Section Headers */
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 12px;
      }

      .section-header h2 {
        font-size: 20px;
        font-weight: 700;
        color: var(--ink);
        margin: 0;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      /* Responsive Grids */
      .grid-service-price {
        display: grid;
        grid-template-columns: 1fr 120px;
        gap: 10px;
      }

      .grid-date-time {
        display: grid;
        grid-template-columns: 1fr 100px 90px 1fr;
        gap: 10px;
      }

      .full-width {
        grid-column: 1 / -1;
      }

      /* Mobile Responsiveness */
      @media (max-width: 768px) {
        .grid-service-price {
          grid-template-columns: 1fr;
        }

        .grid-date-time {
          grid-template-columns: 1fr 1fr;
          gap: 8px;
        }

        /* Make date span full width on mobile */
        .grid-date-time>div:first-child {
          grid-column: 1 / -1;
        }

        #newApptDialog,
        #editApptDialog {
          width: 95%;
          max-height: 95vh;
          margin: 10px auto;
        }

        .dialog-content {
          padding: 16px;
          max-height: 85vh;
          overflow-y: auto;
        }

        .form-label {
          font-size: 13px;
        }

        .form-input {
          font-size: 16px;
          /* Prevent zoom on iOS */
        }

        /* Adjust calendar dropdown for mobile to be centered */
        .calendar-dropdown {
          position: fixed;
          top: 50% !important;
          left: 50% !important;
          transform: translate(-50%, -50%);
          width: 90%;
          max-width: 320px;
          margin-top: 0;
          z-index: 2000;
        }
      }

      /* Custom Calendar Dropdown */
      .calendar-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        margin-top: 8px;
        background: #1a1a1a;
        /* Solid background */
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 16px;
        width: 300px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        min-width: 280px;
      }

      /* Custom Searchable Dropdown */
      .custom-select-wrapper {
        position: relative;
      }

      .dropdown-toggle-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--venus-soft);
        cursor: pointer;
        font-size: 12px;
        pointer-events: auto;
        /* Ensure click works */
        padding: 4px;
      }

      .custom-dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1001;
        margin-top: 4px;
        background: #1a1a1a;
        border: 1px solid var(--line);
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }

      .dropdown-item {
        padding: 10px 12px;
        cursor: pointer;
        font-size: 13px;
        color: var(--ink);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s;
      }

      .dropdown-item:last-child {
        border-bottom: none;
      }

      .dropdown-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .dropdown-item .item-meta {
        display: block;
        font-size: 11px;
        color: var(--muted);
        margin-top: 2px;
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        gap: 8px;
      }

      .calendar-nav-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--line);
        color: #fff;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
      }

      .calendar-nav-btn:hover {
        background: var(--venus-green);
        border-color: var(--venus-green);
      }

      .calendar-month-year {
        font-weight: 600;
        color: #fff;
        font-size: 14px;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }

      .calendar-day-header {
        text-align: center;
        font-size: 11px;
        color: var(--venus-soft);
        padding: 8px 0;
        font-weight: 600;
      }

      .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        color: #fff;
        transition: all 0.15s;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid transparent;
      }

      .calendar-day:hover:not(.empty):not(.selected) {
        background: rgba(140, 150, 104, 0.2);
        border-color: var(--venus-green);
      }

      .calendar-day.empty {
        cursor: default;
        background: transparent;
        opacity: 0.3;
      }

      .calendar-day.today {
        border-color: var(--venus-green);
        background: rgba(140, 150, 104, 0.15);
        font-weight: 600;
      }

      .calendar-day.selected {
        background: var(--venus-green);
        color: #000;
        font-weight: 600;
      }

      .calendar-day.other-month {
        color: rgba(255, 255, 255, 0.3);
      }

      /* ===== MODAL COBRAR SERVICIO ===== */
      .payment-info-row {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
      }

      .payment-info-box {
        flex: 1;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        padding: 12px;
        border: 1px solid var(--line);
      }

      .payment-info-label {
        font-size: 10px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .payment-info-value {
        font-size: 14px;
        font-weight: 500;
      }

      .payment-products {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 16px;
        border: 1px solid var(--line);
      }

      .payment-products-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .payment-products-header h4 {
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--venus-soft);
      }

      .product-add-row {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }

      .product-add-row select {
        flex: 1;
        padding: 10px 12px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--line);
        border-radius: 8px;
        color: var(--ink);
        font-size: 13px;
      }

      .product-add-row input {
        width: 65px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--line);
        border-radius: 8px;
        color: var(--ink);
        font-size: 13px;
        text-align: center;
      }

      .product-add-row button {
        padding: 10px 14px;
        background: var(--venus);
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
      }

      .product-add-row button:hover {
        background: var(--venus-soft);
      }

      .payment-product-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 180px;
        overflow-y: auto;
      }

      .payment-product-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        border: 1px solid var(--line);
      }

      .payment-product-icon {
        width: 32px;
        height: 32px;
        background: rgba(140, 150, 104, 0.2);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--venus-soft);
        font-size: 14px;
      }

      .payment-product-info {
        flex: 1;
        min-width: 0;
      }

      .payment-product-name {
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .payment-product-meta {
        font-size: 11px;
        color: var(--muted);
      }

      .payment-product-price {
        font-size: 13px;
        font-weight: 600;
        color: var(--venus-soft);
        white-space: nowrap;
      }

      .payment-product-remove {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        padding: 4px;
        opacity: 0.6;
        display: flex;
        align-items: center;
      }

      .payment-product-remove:hover {
        opacity: 1;
      }

      .payment-products-empty {
        text-align: center;
        padding: 16px;
        color: var(--muted);
        font-size: 12px;
      }

      .stock-warn {
        font-size: 10px;
        color: #fbbf24;
        display: flex;
        align-items: center;
        gap: 4px;
        margin-top: 2px;
      }

      .payment-totals {
        background: rgba(140, 150, 104, 0.1);
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 16px;
        border: 1px solid rgba(140, 150, 104, 0.2);
      }

      .payment-total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
      }

      .payment-total-row.subtotal {
        font-size: 13px;
        color: var(--muted);
      }

      .payment-total-row.grand {
        font-size: 18px;
        font-weight: 700;
        color: var(--venus-soft);
        border-top: 1px solid var(--line);
        padding-top: 12px;
        margin-top: 8px;
      }

      /* Estilos adicionales para modal mejorado */
      #paymentDialog {
        max-width: 440px !important;
      }

      .btn-close-payment {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--line);
        color: var(--muted);
        width: 36px;
        height: 36px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        z-index: 10;
      }

      .btn-close-payment:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.3);
        color: #ef4444;
      }

      .payment-price-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
      }

      .payment-price-display {
        font-size: 15px;
        font-weight: 600;
        color: var(--venus-soft);
      }

      .payment-price-input {
        width: 100px;
        padding: 6px 10px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--venus);
        border-radius: 8px;
        color: var(--ink);
        font-size: 15px;
        font-weight: 600;
        display: none;
      }

      .payment-price-input.visible {
        display: block;
      }

      .payment-price-display.hidden {
        display: none;
      }

      .btn-edit-price {
        background: none;
        border: none;
        color: var(--muted);
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
        display: flex;
        align-items: center;
      }

      .btn-edit-price:hover {
        color: var(--venus-soft);
        background: rgba(140, 150, 104, 0.1);
      }

      .payment-section {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 14px;
        padding: 16px;
        margin-bottom: 16px;
        border: 1px solid var(--line);
      }

      .payment-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 14px;
      }

      .payment-section-title {
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--venus-soft);
      }

      .discount-row {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .discount-toggle {
        display: flex;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid var(--line);
      }

      .discount-toggle button {
        padding: 10px 18px;
        background: transparent;
        border: none;
        color: var(--muted);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .discount-toggle button.active {
        background: var(--venus);
        color: white;
      }

      .discount-toggle button:hover:not(.active) {
        background: rgba(255, 255, 255, 0.05);
      }

      .discount-input-wrap {
        flex: 1;
        position: relative;
      }

      .discount-input-wrap input {
        width: 100%;
        padding: 10px 14px;
        padding-right: 36px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--line);
        border-radius: 10px;
        color: var(--ink);
        font-size: 14px;
      }

      .discount-input-wrap input:focus {
        outline: none;
        border-color: var(--venus);
      }

      .discount-symbol {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
        font-size: 14px;
        font-weight: 500;
      }

      .discount-applied {
        margin-top: 12px;
        padding: 10px 14px;
        background: rgba(34, 197, 94, 0.1);
        border-radius: 10px;
        font-size: 13px;
        color: #22c55e;
        display: none;
        align-items: center;
        gap: 8px;
      }

      .discount-applied.visible {
        display: flex;
      }

      .payment-total-row.sub {
        font-size: 13px;
        color: var(--muted);
      }

      .payment-total-row.subtotal-line {
        font-size: 14px;
        color: var(--ink);
      }

      .payment-total-row.discount {
        font-size: 13px;
        color: #22c55e;
        display: none;
      }

      .payment-total-row.discount.visible {
        display: flex;
      }

      .btn-cobrar {
        flex: 1;
        padding: 14px 24px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 12px;
      }

      /* ===== DASHBOARD MEJORADO ===== */
      .hero-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 24px;
      }

      @media (max-width: 900px) {
        .hero-stats {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .hero-stat {
        background: var(--card);
        border-radius: 16px;
        padding: 20px;
        border: 1px solid var(--line);
        position: relative;
        overflow: hidden;
      }

      .hero-stat::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: radial-gradient(circle, rgba(140, 150, 104, 0.15) 0%, transparent 70%);
        opacity: 0.5;
      }

      .hero-stat-icon {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 14px;
        background: rgba(140, 150, 104, 0.15);
        color: var(--venus-soft);
      }

      .hero-stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--ink);
        line-height: 1;
        margin-bottom: 6px;
      }

      .hero-stat-label {
        font-size: 13px;
        color: var(--muted);
      }

      .hero-stat-trend {
        position: absolute;
        top: 16px;
        right: 16px;
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .hero-stat-trend.up {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
      }

      .today-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 24px;
      }

      @media (max-width: 700px) {
        .today-grid {
          grid-template-columns: 1fr;
        }
      }

      .today-card {
        background: var(--card);
        border-radius: 14px;
        padding: 18px;
        border: 1px solid var(--line);
        display: flex;
        align-items: center;
        gap: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .today-card:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--venus);
        transform: translateY(-2px);
      }

      .today-card-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .today-card-icon.citas {
        background: rgba(59, 130, 246, 0.15);
        color: #60a5fa;
      }

      .today-card-icon.pendientes {
        background: rgba(251, 191, 36, 0.15);
        color: #fbbf24;
      }

      .today-card-icon.ingresos {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
      }

      .today-card-info h4 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 2px;
      }

      .today-card-info p {
        font-size: 12px;
        color: var(--muted);
      }

      .dash-empty {
        text-align: center;
        padding: 30px 20px;
        color: var(--muted);
      }

      .dash-empty p {
        font-size: 13px;
      }

      /* Sidebar y layout */
      .dash-grid {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 24px;
      }

      @media (max-width: 1000px) {
        .dash-grid {
          grid-template-columns: 1fr;
        }
      }

      .dash-sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* Gift Cards summary */
      .gc-summary {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .gc-summary-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .gc-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .gc-dot.pending {
        background: var(--venus);
      }

      .gc-dot.expiring {
        background: #fbbf24;
      }

      .gc-dot.redeemed {
        background: #22c55e;
      }

      .gc-label {
        flex: 1;
        font-size: 13px;
        color: var(--muted);
      }

      .gc-value {
        font-size: 14px;
        font-weight: 600;
      }

      .gc-value.warning {
        color: #fbbf24;
      }

      /* Cumpleaños */
      .birthday-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .birthday-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
      }

      .birthday-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff6b6b, #feca57);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }

      .birthday-info {
        flex: 1;
      }

      .birthday-info h4 {
        font-size: 13px;
        font-weight: 500;
      }

      .birthday-info p {
        font-size: 11px;
        color: var(--muted);
      }

      .birthday-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 10px;
        font-weight: 600;
      }

      .birthday-badge.soon {
        background: rgba(251, 191, 36, 0.15);
        color: #fbbf24;
      }

      .birthday-badge.today {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
      }

      /* Top clientes */
      .top-client-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 0;
        border-bottom: 1px solid var(--line);
      }

      .top-client-item:last-child {
        border-bottom: none;
      }

      .top-client-rank {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        background: rgba(140, 150, 104, 0.15);
        color: var(--venus-soft);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
      }

      .top-client-rank.gold {
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: #1a1a1a;
      }

      .top-client-info {
        flex: 1;
      }

      .top-client-info h4 {
        font-size: 13px;
        font-weight: 500;
      }

      .top-client-info p {
        font-size: 11px;
        color: var(--muted);
      }

      .top-client-stamps {
        text-align: right;
      }

      .top-client-stamps .count {
        font-size: 14px;
        font-weight: 700;
        color: var(--venus-soft);
      }

      .top-client-stamps .label {
        font-size: 10px;
        color: var(--muted);
      }

      /* Wallets */
      .wallets-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .wallet-card {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
      }

      .wallet-card-icon {
        font-size: 24px;
        margin-bottom: 8px;
      }

      .wallet-card-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--ink);
      }

      .wallet-card-label {
        font-size: 11px;
        color: var(--muted);
      }

      .card-header-link {
        color: var(--venus-soft);
        font-size: 12px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .card-header-link:hover {
        text-decoration: underline;
      }

      /* Scanner Modal */
      .scanner-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .scanner-modal.active {
        display: flex;
      }

      .scanner-content {
        width: 100%;
        max-width: 400px;
        text-align: center;
      }

      .scanner-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .scanner-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .scanner-header {
        margin-bottom: 24px;
      }

      .scanner-header h2 {
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-bottom: 6px;
        color: var(--ink);
      }

      .scanner-header p {
        color: var(--muted);
        font-size: 14px;
      }

      .scanner-viewport {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 24px;
        position: relative;
      }

      .scanner-frame {
        width: 220px;
        height: 220px;
        margin: 0 auto 16px;
        position: relative;
        border-radius: 16px;
      }

      .scanner-corner {
        position: absolute;
        width: 30px;
        height: 30px;
        border: 3px solid var(--venus);
      }

      .scanner-corner.tl {
        top: 0;
        left: 0;
        border-right: none;
        border-bottom: none;
        border-radius: 8px 0 0 0;
      }

      .scanner-corner.tr {
        top: 0;
        right: 0;
        border-left: none;
        border-bottom: none;
        border-radius: 0 8px 0 0;
      }

      .scanner-corner.bl {
        bottom: 0;
        left: 0;
        border-right: none;
        border-top: none;
        border-radius: 0 0 0 8px;
      }

      .scanner-corner.br {
        bottom: 0;
        right: 0;
        border-left: none;
        border-top: none;
        border-radius: 0 0 8px 0;
      }

      .scanner-line {
        position: absolute;
        left: 10px;
        right: 10px;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--venus), transparent);
        top: 50%;
        animation: scan 2s ease-in-out infinite;
      }

      @keyframes scan {

        0%,
        100% {
          top: 20%;
          opacity: 0.5;
        }

        50% {
          top: 80%;
          opacity: 1;
        }
      }

      .scanner-hint {
        color: var(--muted);
        font-size: 13px;
      }

      .scanner-video {
        width: 100%;
        height: 220px;
        object-fit: cover;
        border-radius: 12px;
        background: #000;
        display: none;
      }

      .scanner-video.active {
        display: block;
      }

      .scanner-frame.hidden {
        display: none;
      }

      .scanner-options {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
      }

      .scanner-option {
        flex: 1;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        text-align: left;
      }

      .scanner-option-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .scanner-option-icon.loyalty {
        background: rgba(140, 150, 104, 0.2);
        color: var(--venus-soft);
      }

      .scanner-option-icon.gift {
        background: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
      }

      .scanner-option-info h4 {
        font-size: 13px;
        font-weight: 600;
        color: var(--ink);
        margin-bottom: 2px;
      }

      .scanner-option-info p {
        font-size: 11px;
        color: var(--muted);
      }

      .scanner-manual {
        padding-top: 16px;
        border-top: 1px solid var(--line);
      }

      .scanner-manual p {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 10px;
      }

      .scanner-result {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .scanner-result.active {
        display: block;
      }

      .scanner-result-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin: 0 auto 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .scanner-result-icon.loyalty {
        background: rgba(140, 150, 104, 0.2);
        color: var(--venus-soft);
      }

      .scanner-result-icon.gift {
        background: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
      }

      .scanner-result h3 {
        font-size: 18px;
        margin-bottom: 4px;
      }

      .scanner-result .subtitle {
        font-size: 14px;
        color: var(--muted);
        margin-bottom: 20px;
      }

      .scanner-result-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .quick-actions {
        position: fixed;
        bottom: 24px;
        right: 24px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 100;
      }

      .quick-action-btn {
        width: 56px;
        height: 56px;
        border-radius: 16px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        transition: all 0.2s;
      }

      .quick-action-btn.primary {
        background: var(--venus);
        color: white;
      }

      .quick-action-btn.primary:hover {
        background: var(--venus-soft);
        transform: scale(1.1);
      }
    </style>

    <!-- DIALOG: Escáner QR -->
    <dialog id="scanDialog">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <h3 style="margin:0;font-size:16px;">Escanear tarjeta</h3>
        <button type="button" id="scan-close" class="btn small ghost">Cerrar</button>
      </div>
      <div id="qr-reader" style="width:100%;"></div>
      <div class="muted" id="scan-status" style="margin-top:8px;font-size:12px;">Iniciando cámara…</div>
    </dialog>

    <!-- DIALOG: Escáner Gift Card -->
    <dialog id="giftScanDialog"
      style="background:rgba(27,28,26,0.95);border:1px solid rgba(255,255,255,0.15);border-radius:16px;padding:20px;max-width:500px;width:90%;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h3 style="margin:0;font-size:16px;color:#f9fafb;"><i class="fas fa-qrcode"></i> Escan gift card</h3>
        <button type="button" id="gift-scan-close" class="btn small ghost">Cerrar</button>
      </div>
      <div id="gift-qr-reader" style="width:100%;"></div>
      <div class="muted" id="gift-scan-status" style="margin-top:12px;font-size:13px;text-align:center;">Esperando
        escaneo...</div>
    </dialog>


    <footer class="footer">© Venus Cosmetología</footer>

    <!-- Modal Tarjeta - SIMPLIFICADO -->
    <div id="card-modal-backdrop" class="modal-backdrop hidden">
      <div class="modal-card" style="max-width:420px;">

        <!-- Header con acciones rápidas -->
        <div class="modal-header" style="flex-wrap:wrap;gap:10px;">
          <h3 style="margin:0;flex:1;"><i class="fas fa-user"></i> Cliente</h3>
          <div style="display:flex;gap:6px;">
            <button id="cm-stamp" class="btn small" style="background:#FFD166;color:#1b1b1b;font-weight:600;">⭐ +1
              sello</button>
            <button id="cm-close" class="btn small ghost">✕</button>
          </div>
        </div>

        <!-- Info del cliente -->
        <div class="modal-body" style="padding:16px 0;">

          <!-- Datos principales -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
            <div>
              <div class="muted" style="font-size:11px;margin-bottom:2px;">Nombre</div>
              <div id="cm-name" style="font-weight:600;font-size:15px;">—</div>
            </div>
            <div>
              <div class="muted" style="font-size:11px;margin-bottom:2px;">Teléfono</div>
              <div id="cm-phone" style="font-size:15px;">—</div>
            </div>
          </div>

          <!-- Sellos con barra de progreso -->
          <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:14px;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <span style="font-size:13px;">Progreso</span>
              <span id="cm-stamps" style="font-weight:700;font-size:18px;color:var(--venus-soft);">0 / 8</span>
            </div>
            <div style="background:rgba(255,255,255,0.1);border-radius:8px;height:8px;overflow:hidden;">
              <div id="cm-progress-bar"
                style="background:linear-gradient(90deg,#FFD166,#8c9668);height:100%;width:0%;transition:width 0.3s;border-radius:8px;">
              </div>
            </div>
            <div id="cm-status-text" class="muted" style="font-size:11px;margin-top:6px;text-align:center;">—</div>
          </div>

          <!-- Próxima cita (si existe) -->
          <div id="cm-next-appt-section" class="hidden"
            style="background:rgba(140,150,104,0.15);border:1px solid rgba(140,150,104,0.3);border-radius:12px;padding:12px;margin-bottom:16px;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
              <span>📅</span>
              <span style="font-size:12px;color:var(--venus-soft);font-weight:600;">Próxima cita</span>
            </div>
            <div id="cm-next-appt-date" style="font-size:18px;font-weight:700;color:#22c55e;">—</div>
            <div id="cm-next-appt-service" style="font-size:13px;margin-top:2px;">—</div>
          </div>

          <!-- Stats rápidos -->
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;">
            <div style="text-align:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;">
              <div id="cm-visited-count" style="font-size:18px;font-weight:700;color:var(--venus-soft);">0</div>
              <div class="muted" style="font-size:10px;">Visitas</div>
            </div>
            <div style="text-align:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;">
              <div id="cm-cycles-completed" style="font-size:18px;font-weight:700;color:var(--venus-soft);">0</div>
              <div class="muted" style="font-size:10px;">Ciclos</div>
            </div>
            <div style="text-align:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;">
              <div id="cm-last-visit" style="font-size:12px;font-weight:600;color:var(--venus-soft);">—</div>
              <div class="muted" style="font-size:10px;">Última visita</div>
            </div>
          </div>

          <!-- Notas (colapsable) -->
          <details style="margin-bottom:16px;">
            <summary style="cursor:pointer;font-size:13px;color:var(--venus-soft);margin-bottom:8px;">📝 Notas del
              cliente</summary>
            <textarea id="cm-notes" class="modal-textarea" rows="2" placeholder="Agregar notas..."
              style="width:100%;background:rgba(0,0,0,0.2);border:1px solid var(--line);border-radius:8px;padding:10px;color:#fff;font-size:13px;resize:none;"></textarea>
            <button id="cm-save-notes" class="btn small ghost" style="margin-top:6px;font-size:11px;"><i
                class="fas fa-save"></i> Guardar
              nota</button>
          </details>

          <!-- QR (colapsable) -->
          <details>
            <summary style="cursor:pointer;font-size:13px;color:var(--venus-soft);margin-bottom:8px;">🔲 Código QR
            </summary>
            <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:12px;text-align:center;">
              <canvas id="card-qr" style="max-width:150px;"></canvas>
              <div class="muted" style="font-size:10px;margin-top:6px;">ID: <code id="cm-id"
                  style="font-size:10px;">—</code></div>
            </div>
          </details>

        </div>

        <!-- Footer con acciones -->
        <div class="modal-footer"
          style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.1);">
          <button id="cm-whatsapp" class="btn small" style="background:#25D366;color:white;">
            💬 WhatsApp
          </button>
          <button id="cm-schedule" class="btn small" style="background:#8c9668;color:white;">
            📅 Agendar
          </button>
          <button id="cm-redeem" class="btn small">
            🎁 Canjear
          </button>
        </div>

        <!-- Acciones secundarias -->
        <div
          style="display:flex;justify-content:center;gap:12px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.05);">
          <button id="cm-copy" class="btn-link"
            style="background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;">Copiar ID</button>
          <button id="cm-open-url" class="btn-link"
            style="background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;">Abrir página</button>
          <button id="cm-notify" class="btn-link"
            style="background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;">Notificar</button>
          <button id="cm-delete" class="btn-link"
            style="background:none;border:none;color:#ef4444;font-size:11px;cursor:pointer;">Eliminar</button>
        </div>

        <!-- Formulario de Notificación Individual (Oculto por defecto) -->
        <div id="notify-form-container" class="notify-form-container hidden" style="margin-top:16px;">
          <span class="notify-form-header">🔔 Push Individual</span>
          <div class="input-group">
            <input id="notify-title" class="notify-input" placeholder="Título" value="Recordatorio Venus">
            <span class="input-icon">📌</span>
          </div>
          <div class="input-group">
            <textarea id="notify-message" class="notify-textarea" placeholder="Escribe tu mensaje aquí..."></textarea>
            <span class="input-icon">💬</span>
          </div>
          <div class="notify-btn-group" style="display:flex;gap:8px;margin-top:10px;">
            <button id="btn-cancel-notify" class="btn small ghost">Cancelar</button>
            <button id="btn-send-notify" class="btn small primary">🚀 Enviar</button>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- Off-Canvas Menu for Module Selection -->
  <div class="offcanvas-backdrop" id="offcanvas-backdrop"></div>
  <div class="offcanvas" id="modules-offcanvas">
    <div class="offcanvas-header">
      <h3 class="offcanvas-title">🎛️ Personalizar Dashboard</h3>
      <button class="btn small ghost" id="close-offcanvas">✕</button>
    </div>

    <p class="muted" style="font-size: 13px; margin-bottom: 20px;">
      Selecciona los módulos que deseas ver en el Resumen
    </p>

    <!-- Module Toggles -->
    <div id="module-list">
      <div class="module-item" data-module="kpis">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-chart-bar"></i></span>
          <span class="module-label">KPIs Principales</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="kpis" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="birthdays">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-birthday-cake"></i></span>
          <span class="module-label">Cumpleaños</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="birthdays" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="activity">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-chart-line"></i></span>
          <span class="module-label">Gráfica de Actividad</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="activity" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="topClients">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-star"></i></span>
          <span class="module-label">Top Clientes</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="topClients" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="walletStats">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-mobile-alt"></i></span>
          <span class="module-label">Estado de Wallets</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="walletStats" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="module-item" data-module="newKPIs">
        <div class="module-info">
          <span class="module-icon"><i class="fas fa-chart-bar"></i></span>
          <span class="module-label">KPIs Avanzados</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" data-module="newKPIs" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

    <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
      <button id="reset-modules" class="btn small ghost" style="width: 100%;">
        🔄 Restaurar por defecto
      </button>
    </div>
  </div>

  <!-- Modal Nuevo/Editar Servicio -->
  <!-- Modal Nuevo/Editar Servicio -->
  <div id="modal-service" class="modal-backdrop hidden">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="modal-service-title">Nuevo Servicio</h3>
        <span class="close-modal" id="close-modal-service">&times;</span>
      </div>

      <form id="form-service">
        <input type="hidden" id="service-id">

        <div class="form-group">
          <label class="form-label">Nombre del Servicio</label>
          <input type="text" id="service-name" class="form-input" required placeholder="Ej. Facial Hidratante">
        </div>

        <div class="row" style="gap:15px;">
          <div class="form-group" style="flex:1;">
            <label class="form-label">Duración (min)</label>
            <input type="number" id="service-duration" class="form-input" required min="10" step="5" value="60">
          </div>
          <div class="form-group" style="flex:1;">
            <label class="form-label">Precio</label>
            <div style="position:relative;">
              <span
                style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:14px;">$</span>
              <input type="number" id="service-price" class="form-input" required min="0" step="50"
                style="padding-left:25px;">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn ghost" id="cancel-service">Cancelar</button>
          <button type="submit" class="btn primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- QRCode lib -->

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- Chart.js lib -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    // Global instances
    let newApptClientDropdown, newApptServiceDropdown, editApptServiceDropdown;

    // Payment dialog variables
    let currentPaymentApptId = null;
    const paymentDialog = document.getElementById('paymentDialog');
    const formPayment = document.getElementById('form-payment');

    const $ = s => document.querySelector(s);

    /* ===== MODULE SELECTION SYSTEM ===== */
    const DEFAULT_MODULES = {
      kpis: true,
      birthdays: true,
      activity: true,
      topClients: true,
      walletStats: true,
      newKPIs: true
    };

    // Load saved modules from localStorage
    function getSelectedModules() {
      const saved = localStorage.getItem('venus_modules');
      return saved ? JSON.parse(saved) : { ...DEFAULT_MODULES };
    }

    // Save modules to localStorage
    function saveSelectedModules(modules) {
      localStorage.setItem('venus_modules', JSON.stringify(modules));
    }

    // Apply module visibility
    function applyModuleVisibility() {
      const modules = getSelectedModules();

      // Find and toggle module visibility based on data-module-section attributes
      document.querySelectorAll('[data-module-section]').forEach(section => {
        const moduleName = section.getAttribute('data-module-section');
        if (modules[moduleName] === false) {
          section.style.display = 'none';
        } else {
          section.style.display = '';
        }
      });
    }



    /* ===== GIFT CARD QR SCANNER ===== */
    let giftHtml5QrcodeScanner = null;
    const giftScanDialog = document.getElementById('giftScanDialog');
    const giftScanStatus = document.getElementById('gift-scan-status');

    // Botón para abrir scanner
    document.getElementById('btn-scan-gift-card')?.addEventListener('click', () => {
      openGiftScanner();
    });

    // Botón para cerrar scanner
    document.getElementById('gift-scan-close')?.addEventListener('click', () => {
      closeGiftScanner();
    });

    function openGiftScanner() {
      if (typeof Html5Qrcode === 'undefined') {
        alert('❌ Librería de scanner no disponible');
        return;
      }

      giftScanDialog.showModal();
      giftScanStatus.textContent = 'Iniciando cámara...';

      // Inicializar scanner
      giftHtml5QrcodeScanner = new Html5Qrcode('gift-qr-reader');

      const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      };

      giftHtml5QrcodeScanner.start(
        { facingMode: 'environment' }, // Cámara trasera
        config,
        onGiftScanSuccess,
        onGiftScanError
      ).then(() => {
        giftScanStatus.textContent = '📷 Escanea el QR de la gift card';
      }).catch(err => {
        console.error('Error iniciando cámara:', err);
        giftScanStatus.textContent = '❌ Error al iniciar cámara';
      });
    }

    function closeGiftScanner() {
      if (giftHtml5QrcodeScanner) {
        giftHtml5QrcodeScanner.stop().then(() => {
          giftHtml5QrcodeScanner.clear();
          giftHtml5QrcodeScanner = null;
        }).catch(err => {
          console.error('Error cerrando scanner:', err);
        });
      }
      giftScanDialog.close();
    }

    async function onGiftScanSuccess(decodedText) {
      console.log('✅ QR escaneado:', decodedText);
      giftScanStatus.textContent = '✅ QR detectado, procesando...';

      // Detener scanner
      if (giftHtml5QrcodeScanner) {
        await giftHtml5QrcodeScanner.stop();
      }

      // Procesar gift card
      await processGiftCardScan(decodedText);
    }

    function onGiftScanError(error) {
      // Silenciar errores de escaneo continuo
    }

    async function processGiftCardScan(giftId) {
      try {
        // Buscar gift card
        const response = await fetch(`/api/admin/gift-card/${giftId}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Gift card no encontrada');
        }

        const giftCard = await response.json();

        // Verificar si ya fue canjeada
        if (giftCard.redeemed) {
          giftScanStatus.textContent = '⚠️ Esta gift card ya fue canjeada';
          alert(`⚠️ Gift card ya canjeada\n\nCanjeada por: ${giftCard.redeemedBy || 'No disponible'}\nFecha: ${new Date(giftCard.redeemedAt).toLocaleString('es-MX')}`);
          setTimeout(() => {
            closeGiftScanner();
          }, 2000);
          return;
        }

        // Confirmar canje
        const confirmed = confirm(`¿Canjear gift card?\n\nServicio: ${giftCard.service}\nCliente: ${giftCard.clientName || 'Anónimo'}\n\n¿Marcar como canjeada?`);

        if (!confirmed) {
          giftScanStatus.textContent = 'Canje cancelado';
          setTimeout(() => {
            closeGiftScanner();
          }, 1500);
          return;
        }

        // Marcar como canjeada
        const redeemResponse = await fetch(`/api/admin/gift-card/${giftId}/redeem`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });

        if (!redeemResponse.ok) {
          throw new Error('Error al canjear');
        }

        giftScanStatus.textContent = '✅ Gift card canjeada correctamente';
        alert('✅ Gift card canjeada exitosamente');

        // Recargar lista de gift cards si estamos en ese tab
        if (!document.getElementById('tab-events').classList.contains('hidden')) {
          loadGiftHistory();
        }

        setTimeout(() => {
          closeGiftScanner();
        }, 1500);

      } catch (error) {
        console.error('Error procesando gift card:', error);
        giftScanStatus.textContent = `❌ ${error.message}`;
        alert(`❌ Error: ${error.message}`);
        setTimeout(() => {
          closeGiftScanner();
        }, 2000);
      }
    }

    /* ===== SESIÓN Y PROTECCIÓN ===== */
    async function loadMe() {
      try {
        const r = await fetch("/api/admin/me", { credentials: "include" });

        // ⭐ CRÍTICO: Si no hay sesión válida, redirigir al login
        if (!r.ok) {
          console.log("Sin sesión válida, redirigiendo a login...");
          window.location.href = "/admin-login.html";
          return;
        }

        const j = await r.json();
        $("#me-line").textContent = "Sesión: " + (j.email || j.uid || "admin");

        // ⭐ CRÍTICO: Quitar la pantalla negra solo cuando la sesión sea válida
        document.body.classList.remove('checking-auth');
        document.body.classList.add('auth-verified');

        // Cargar datos iniciales
        loadMetrics('week');
      } catch (e) {
        console.error("Error verificando sesión:", e);
        // Si hay error de red o servidor, también redirigir
        window.location.href = "/admin-login.html";
      }
    }

    // ⭐ CRÍTICO: Verificar sesión ANTES de mostrar cualquier cosa
    loadMe();

    /* ===== TABS ===== */
    document.querySelectorAll('[data-tab]').forEach(tab => {
      tab.addEventListener('click', function (e) {
        e.preventDefault();

        document.querySelectorAll('.nav a').forEach(a => a.classList.remove('is-active'));
        this.classList.add('is-active');

        document.querySelectorAll('[id^="tab-"]').forEach(s => s.classList.add('hidden'));

        const targetId = 'tab-' + this.getAttribute('data-tab');
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
          targetSection.classList.remove('hidden');
        }

        const tabName = this.getAttribute('data-tab');
        if (tabName === 'overview') {
          loadDashboardStats();
          // Iniciar auto-refresh del dashboard
          if (typeof startDashboardAutoRefresh === 'function') startDashboardAutoRefresh();
        } else if (tabName === 'cards') {
          loadCards(1);
          // Detener auto-refresh del dashboard
          if (typeof stopDashboardAutoRefresh === 'function') stopDashboardAutoRefresh();
        } else if (tabName === 'settings') {
          loadNotificationsHistory();
          if (typeof stopDashboardAutoRefresh === 'function') stopDashboardAutoRefresh();
        } else if (tabName === 'events') {
          loadGiftCardServices();
          loadGiftCards();
          if (typeof stopDashboardAutoRefresh === 'function') stopDashboardAutoRefresh();
        } else if (tabName === 'services') {
          loadServicesTable();
          if (typeof stopDashboardAutoRefresh === 'function') stopDashboardAutoRefresh();
        } else if (tabName === 'appointments') {
          if (typeof loadAppointments === 'function') loadAppointments();
          if (typeof loadMonthStats === 'function') loadMonthStats();
          // Iniciar auto-refresh cuando se entra al tab de appointments
          if (typeof startAppointmentsAutoRefresh === 'function') startAppointmentsAutoRefresh();
          // Detener auto-refresh del dashboard
          if (typeof stopDashboardAutoRefresh === 'function') stopDashboardAutoRefresh();
        } else {
          // Detener auto-refresh cuando se sale del tab de appointments
          if (typeof stopAppointmentsAutoRefresh === 'function') stopAppointmentsAutoRefresh();
          if (typeof stopDashboardAutoRefresh === 'function') stopDashboardAutoRefresh();
        }
      });
    });

    /* ===== FILTRADO Y REPORTES ===== */
    let globalStatsData = {};

    // Evento cambio de filtro (comentado - elemento no existe en nuevo dashboard)
    // document.getElementById('stats-filter')?.addEventListener('change', (e) => {
    //   loadMetrics(e.target.value);
    // });

    function downloadCSV() {
      if (!globalStatsData.clientsToExport || globalStatsData.clientsToExport.length === 0) {
        alert('⚠️ No hay datos para exportar. Espera a que carguen las métricas.');
        return;
      }

      // Get selected modules from localStorage
      const selectedModules = getSelectedModules();

      const period = 'month'; // Default period
      const periodLabel = 'Este Mes';

      let csvContent = 'data:text/csv;charset=utf-8,';

      // Header
      csvContent += `REPORTE DE LEALTAD VENUS\r\n`;
      csvContent += `Periodo: ${periodLabel}\r\n`;
      csvContent += `Generado: ${new Date().toLocaleString('es-MX')}\r\n`;
      csvContent += `\r\n`;

      // ===== KPIs Section (if enabled) =====
      if (selectedModules.kpis !== false) {
        csvContent += `MÉTRICAS GENERALES\r\n`;
        csvContent += `Métrica,Valor\r\n`;
        csvContent += `Total Tarjetas Activas,${globalStatsData.total || 0}\r\n`;
        csvContent += `Tarjetas Completadas,${globalStatsData.full || 0}\r\n`;
        csvContent += `Sellos en este periodo,${globalStatsData.stamps || 0}\r\n`;
        csvContent += `Canjes en este periodo,${globalStatsData.redeems || 0}\r\n`;
        csvContent += `Promedio de Sellos,${globalStatsData.avg || 0}\r\n`;
        csvContent += `Tasa de Completitud,${globalStatsData.rate || '0%'}\r\n`;
        csvContent += `\r\n`;
      }

      // ===== Top Clients Section (if enabled) =====
      if (selectedModules.topClients !== false && globalStatsData.clients && globalStatsData.clients.length > 0) {
        csvContent += `TOP CLIENTES\r\n`;
        csvContent += `Nombre,Sellos,Meta,Estado,Progreso\r\n`;
        globalStatsData.clients.forEach(c => {
          const estado = c.stamps >= c.max ? "Completada" : "En curso";
          const progreso = Math.round((c.stamps / c.max) * 100) + '%';
          const name = (c.name || "Sin nombre").replace(/,/g, "");
          csvContent += `${name},${c.stamps},${c.max},${estado},${progreso}\r\n`;
        });
        csvContent += `\r\n`;
      }

      // ===== Wallet Stats Section (if enabled) =====
      if (selectedModules.walletStats !== false && globalStatsData.walletStats) {
        csvContent += `ESTADO DE WALLETS\r\n`;
        csvContent += `Plataforma,Cantidad\r\n`;
        csvContent += `Google Wallet,${globalStatsData.walletStats.google || 0}\r\n`;
        csvContent += `Apple Wallet,${globalStatsData.walletStats.apple || 0}\r\n`;
        csvContent += `Dispositivos Totales,${globalStatsData.walletStats.total || 0}\r\n`;
        csvContent += `\r\n`;
      }

      // ===== All Cards Data =====
      csvContent += `TODAS LAS TARJETAS\r\n`;
      csvContent += `Nombre,Teléfono,Sellos Actuales,Meta,Estado,Fecha Nacimiento,Última Visita,Creada,Visitas Totales,Ciclos Completados,Servicios Favoritos,Notas\r\n`;

      globalStatsData.clientsToExport.forEach(c => {
        const estado = c.stamps >= c.max ? "Completada" : "En curso";
        const phone = c.phone || "";
        const bday = c.birthdate || "";
        const last = c.last_visit ? new Date(c.last_visit).toLocaleDateString() : (c.updated_at ? new Date(c.updated_at).toLocaleDateString() : "");
        const created = c.createdAt ? new Date(c.createdAt).toLocaleDateString() : "";
        const name = (c.name || "Sin nombre").replace(/,/g, "");

        // ⭐ FASE 5: Nuevas columnas
        const visitedCount = c.visitedCount || 0;
        const cyclesCompleted = c.cyclesCompleted || 0;
        const favoriteServices = (c.favoriteServices || "").replace(/,/g, ";"); // Reemplazar comas
        const notes = (c.notes || "").replace(/,/g, ";").replace(/\r?\n/g, " "); // Reemplazar comas y saltos de línea

        csvContent += `${name},${phone},${c.stamps},${c.max},${estado},${bday},${last},${created},${visitedCount},${cyclesCompleted},${favoriteServices},${notes}\r\n`;
      });

      // Create download
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', `venus_reporte_${period}_${Date.now()}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      console.log('✅ CSV generado con módulos:', Object.keys(selectedModules).filter(k => selectedModules[k] !== false));
    }

    /* ===== METRICS (Firestore) - MEJORADO CON FILTROS ===== */
    let activityChart = null;

    async function loadMetrics(range = 'week') {
      try {
        // Actualizar etiquetas según el rango
        updatePeriodLabels(range);

        // Métricas básicas con filtro de rango
        const response = await fetch(`/api/admin/metrics-firebase?range=${range}`, {
          credentials: 'include'
        });
        const data = await response.json();

        // KPIs principales
        document.getElementById('kpi-total').textContent = data.total || 0;
        document.getElementById('kpi-full').textContent = data.full || 0;

        // Actualizar según el rango
        if (range === 'day') {
          document.getElementById('kpi-stamps').textContent = data.stampsToday || 0;
          document.getElementById('kpi-redeems').textContent = data.redeemsToday || 0;
        } else if (range === 'week') {
          document.getElementById('kpi-stamps').textContent = data.stampsWeek || 0;
          document.getElementById('kpi-redeems').textContent = data.redeemsWeek || 0;
        } else if (range === 'month') {
          document.getElementById('kpi-stamps').textContent = data.stampsMonth || 0;
          document.getElementById('kpi-redeems').textContent = data.redeemsMonth || 0;
        }

        // Promedio sellos
        const avg = data.total > 0 ? (((data.totalStamps || 0) / data.total)).toFixed(1) : '0.0';
        document.getElementById('kpi-avg').textContent = avg;

        // Tasa de completitud
        const rate = data.total > 0 ? ((data.full / data.total) * 100).toFixed(0) : '0';
        document.getElementById('kpi-rate').textContent = rate + '%';

        // Cargar componentes adicionales
        await loadTopClients();
        await loadActivityChart(range);
        await loadWalletStats();

        // Fetch ALL cards for Birthdays & Report
        // Note: For large datasets, this should be paginated or a separate endpoint
        try {
          const cardsResp = await fetch('/api/admin/cards-firebase?limit=1000', { credentials: 'include' });
          if (cardsResp.ok) {
            const cardsData = await cardsResp.json();
            checkOverviewBirthdays(cardsData.items || []);

            // Populate globalStatsData.clients with ALL clients for the report
            // (loadTopClients only gets top 5)
            if (cardsData.items) {
              globalStatsData.allClients = cardsData.items;
            }
          }
        } catch (e) {
          console.error("Error fetching cards for overview:", e);
        }

        // Guardar datos para reporte
        globalStatsData = {
          ...globalStatsData, // Keep allClients if set
          total: data.total || 0,
          full: data.full || 0,
          stampsPeriod: range === 'day' ? data.stampsToday : (range === 'week' ? data.stampsWeek : data.stampsMonth),
          redeemsPeriod: range === 'day' ? data.redeemsToday : (range === 'week' ? data.redeemsWeek : data.redeemsMonth),
          avg: avg,
          rate: rate,
          range: range
        };

      } catch (error) {
        console.error('Error:', error);
        // En caso de error, cargar datos de ejemplo
        loadSampleData(range);
      }
    }

    function updatePeriodLabels(range) {
      const stampsLabel = document.getElementById('stamps-period-label');
      const redeemsLabel = document.getElementById('redeems-period-label');
      const activityTitle = document.getElementById('activity-title');

      if (range === 'day') {
        stampsLabel.textContent = 'Sellos hoy';
        redeemsLabel.textContent = 'Canjes hoy';
        activityTitle.textContent = '📈 Actividad hoy';
      } else if (range === 'week') {
        stampsLabel.textContent = 'Sellos esta semana';
        redeemsLabel.textContent = 'Canjes esta semana';
        activityTitle.textContent = '📈 Actividad reciente (7 días)';
      } else if (range === 'month') {
        stampsLabel.textContent = 'Sellos este mes';
        redeemsLabel.textContent = 'Canjes este mes';
        activityTitle.textContent = '📈 Actividad mensual';
      }
    }


    /* ===== ADVANCED KPIS (NUEVO - FASE 3) ===== */
    let dayChart = null;
    let hourChart = null;

    async function loadAdvancedKPIs(range = 'week') {
      try {
        // Obtener todas las tarjetas para análisis
        const response = await fetch('/api/admin/cards-all?limit=1000', {
          credentials: 'include'
        });
        const data = await response.json();
        const cards = data.items || [];

        const now = new Date();
        const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

        // Determinar rango para "clientes nuevos"
        let periodStart;
        if (range === 'day') {
          periodStart = new Date(now.setHours(0, 0, 0, 0));
        } else if (range === 'week') {
          periodStart = new Date(now - 7 * 24 * 60 * 60 * 1000);
        } else {
          periodStart = new Date(now.getFullYear(), now.getMonth(), 1);
        }

        // 1. Clientes nuevos
        const newClients = cards.filter(c => {
          if (!c.createdAt) return false;
          return new Date(c.createdAt) >= periodStart;
        });

        // 2 & 3. Clientes activos e inactivos (últimos 30 días)
        const activeClients = cards.filter(c => {
          const lastVisit = c.lastVisit || c.last_visit || c.updatedAt || c.updated_at;
          if (!lastVisit) return false;
          return new Date(lastVisit) >= thirtyDaysAgo;
        });
        const inactiveClients = cards.length - activeClients.length;

        // 4. Promedio días desde última visita
        let totalDays = 0;
        let count = 0;
        cards.forEach(c => {
          const lastVisit = c.lastVisit || c.last_visit || c.updatedAt || c.updated_at;
          if (lastVisit) {
            const days = Math.floor((Date.now() - new Date(lastVisit).getTime()) / (24 * 60 * 60 * 1000));
            totalDays += days;
            count++;
          }
        });
        const avgLastVisit = count > 0 ? Math.round(totalDays / count) : 0;

        // 5. Ciclos completados
        const cyclesCompleted = cards.filter(c => c.stamps >= c.max).length;

        // 6. Tasa de retorno (activos / total)
        const returnRate = cards.length > 0 ? Math.round((activeClients.length / cards.length) * 100) : 0;

        // Actualizar UI
        document.getElementById('kpi-new-clients').textContent = newClients.length;
        document.getElementById('kpi-active-clients').textContent = `${activeClients.length} (${returnRate}%)`;
        document.getElementById('kpi-inactive-clients').textContent = inactiveClients;
        document.getElementById('kpi-avg-last-visit').textContent = `${avgLastVisit} días`;
        document.getElementById('kpi-cycles-completed').textContent = cyclesCompleted;
        document.getElementById('kpi-return-rate').textContent = `${returnRate}%`;

        // 7. Renderizar gráficas de distribución
        renderDayDistribution(cards);
        renderHourDistribution(cards);

        console.log('📊 KPIs avanzados cargados');
      } catch (error) {
        console.error('Error cargando KPIs avanzados:', error);
        // Valores por defecto en caso de error
        document.getElementById('kpi-new-clients').textContent = '—';
        document.getElementById('kpi-active-clients').textContent = '—';
        document.getElementById('kpi-inactive-clients').textContent = '—';
        document.getElementById('kpi-avg-last-visit').textContent = '—';
        document.getElementById('kpi-cycles-completed').textContent = '—';
        document.getElementById('kpi-return-rate').textContent = '—';
      }
    }

    function renderDayDistribution(cards) {
      const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
      const dayCounts = [0, 0, 0, 0, 0, 0, 0];

      cards.forEach(c => {
        const lastVisit = c.lastVisit || c.last_visit || c.updatedAt || c.updated_at;
        if (lastVisit) {
          const day = new Date(lastVisit).getDay();
          dayCounts[day]++;
        }
      });

      const ctx = document.getElementById('day-distribution-chart');
      if (dayChart) dayChart.destroy();

      dayChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dayNames,
          datasets: [{
            label: 'Visitas',
            data: dayCounts,
            backgroundColor: 'rgba(140, 150, 104, 0.6)',
            borderColor: 'rgb(140, 150, 104)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#e5e7eb', font: { size: 11 } },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            },
            x: {
              ticks: { color: '#e5e7eb', font: { size: 11 } },
              grid: { display: false }
            }
          }
        }
      });
    }

    function renderHourDistribution(cards) {
      const hourCounts = new Array(24).fill(0);

      cards.forEach(c => {
        const lastVisit = c.lastVisit || c.last_visit || c.updatedAt || c.updated_at;
        if (lastVisit) {
          const hour = new Date(lastVisit).getHours();
          hourCounts[hour]++;
        }
      });

      const ctx = document.getElementById('hour-distribution-chart');
      if (hourChart) hourChart.destroy();

      hourChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
          datasets: [{
            label: 'Visitas',
            data: hourCounts,
            borderColor: 'rgb(140, 150, 104)',
            backgroundColor: 'rgba(140, 150, 104, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#e5e7eb', font: { size: 11 } },
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            },
            x: {
              ticks: { color: '#e5e7eb', font: { size: 10 }, maxRotation: 0 },
              grid: { display: false }
            }
          }
        }
      });
    }

    function loadSampleData(range) {
      // Datos de ejemplo para cuando la API falle
      let labels, dataStamps, kpiStamps, kpiRedeems;

      if (range === 'day') {
        labels = ['10:00', '12:00', '14:00', '16:00', '18:00', '20:00'];
        dataStamps = [2, 5, 1, 8, 4, 6];
        kpiStamps = 26;
        kpiRedeems = 3;
      } else if (range === 'week') {
        labels = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
        dataStamps = [12, 19, 3, 5, 22, 30, 15];
        kpiStamps = 106;
        kpiRedeems = 8;
      } else { // month
        labels = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];
        dataStamps = [80, 120, 95, 110];
        kpiStamps = 405;
        kpiRedeems = 25;
      }

      // Actualizar UI con datos de ejemplo
      document.getElementById('kpi-total').textContent = "142";
      document.getElementById('kpi-full').textContent = "18";
      document.getElementById('kpi-stamps').textContent = kpiStamps;
      document.getElementById('kpi-redeems').textContent = kpiRedeems;
      document.getElementById('kpi-avg').textContent = "5.2";
      document.getElementById('kpi-rate').textContent = "13%";

      // Actualizar gráfica
      renderChart(labels, dataStamps);

      // Simular Top Clientes
      renderSampleTopClients();

      // Guardar datos para reporte
      globalStatsData = {
        total: 142,
        full: 18,
        stampsPeriod: kpiStamps,
        redeemsPeriod: kpiRedeems,
        avg: "5.2",
        rate: "13",
        range: range
      };
    }

    function renderChart(labels, data) {
      const ctx = document.getElementById('activity-chart');

      // Destruir gráfica anterior si existe
      if (activityChart) {
        activityChart.destroy();
      }

      activityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Sellos',
            data: data,
            borderColor: '#8c9668',
            backgroundColor: 'rgba(140, 150, 104, 0.15)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: '#8c9668',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 10,
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#8c9668',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#e5e7eb',
                font: { size: 11 }
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#e5e7eb',
                font: { size: 11 }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    function renderSampleTopClients() {
      const clients = [
        { name: 'Ana López', stamps: 7, max: 8 },
        { name: 'Carlos Ruiz', stamps: 8, max: 8 },
        { name: 'Sofía Mendoza', stamps: 4, max: 8 },
        { name: 'Roberto García', stamps: 6, max: 8 },
        { name: 'Laura Torres', stamps: 8, max: 8 }
      ];

      const tbody = document.getElementById('top-clients');
      tbody.innerHTML = clients.map(c => `
        <tr>
          <td>${c.name}</td>
          <td>${c.stamps}/${c.max}</td>
          <td>
            ${c.stamps >= c.max
          ? '<span class="tag">🎁 Completa</span>'
          : `<span class="muted">${c.max - c.stamps} más</span>`
        }
          </td>
        </tr>
      `).join('');

      // Guardar para el reporte
      globalStatsData.clients = clients;
    }

    async function loadTopClients() {
      try {
        const response = await fetch('/api/admin/top-clients', {
          credentials: 'include'
        });
        const data = await response.json();

        const tbody = document.getElementById('top-clients');
        if (!data.clients || data.clients.length === 0) {
          tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:12px;" class="muted">No hay datos</td></tr>`;
          return;
        }

        tbody.innerHTML = data.clients.slice(0, 5).map(c => `
          <tr>
            <td>${c.name || 'Sin nombre'}</td>
            <td>${c.stamps}/${c.max}</td>
            <td>
              ${c.stamps >= c.max
            ? '<span class="tag">🎁 Completa</span>'
            : `<span class="muted">${c.max - c.stamps} más</span>`
          }
            </td>
          </tr>
        `).join('');

        // Guardar para el reporte
        globalStatsData.clients = data.clients.slice(0, 5);
      } catch (error) {
        console.error('Error cargando top clients:', error);
        renderSampleTopClients();
      }
    }

    async function loadActivityChart(range = 'week') {
      try {
        const response = await fetch(`/api/admin/activity-${range}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('API no disponible');
        }

        const data = await response.json();
        const ctx = document.getElementById('activity-chart');

        // Destruir gráfica anterior si existe
        if (activityChart) {
          activityChart.destroy();
        }

        activityChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.labels || ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
            datasets: [{
              label: 'Sellos',
              data: data.stamps || [0, 0, 0, 0, 0, 0, 0],
              borderColor: '#8c9668',
              backgroundColor: 'rgba(140, 150, 104, 0.15)',
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#8c9668',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 10,
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: '#8c9668',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: '#e5e7eb',
                  font: { size: 11 }
                },
                grid: {
                  color: 'rgba(255, 255, 255, 0.1)'
                }
              },
              x: {
                ticks: {
                  color: '#e5e7eb',
                  font: { size: 11 }
                },
                grid: {
                  display: false
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error cargando gráfica:', error);
        // Si falla, no hacemos nada ya que loadSampleData ya renderizó una gráfica
      }
    }

    /* ===== WALLET STATS MEJORADO ===== */
    async function loadWalletStats() {
      try {
        // Primero intentar con el nuevo endpoint de device-stats
        try {
          const deviceStatsResponse = await fetch('/api/admin/device-stats', {
            credentials: 'include'
          });

          if (deviceStatsResponse.ok) {
            const deviceStats = await deviceStatsResponse.json();

            // Mostrar en UI
            document.getElementById('kpi-google').textContent = deviceStats.googleWallet || 0;
            document.getElementById('kpi-apple').textContent = deviceStats.appleWallet || 0;
            document.getElementById('kpi-devices').textContent = deviceStats.totalDevices || 0;

            // ⭐ Guardar en globalStatsData para CSV
            globalStatsData.walletStats = {
              google: deviceStats.googleWallet || 0,
              apple: deviceStats.appleWallet || 0,
              total: deviceStats.totalDevices || 0
            };

            console.log('📱 Wallet stats cargadas exitosamente');
            return;
          }
        } catch (e) {
          console.log('Nuevo endpoint device-stats no disponible, usando endpoint legacy');
        }

        // Fallback al endpoint legacy
        const response = await fetch('/api/admin/wallet-stats', {
          credentials: 'include'
        });
        const data = await response.json();

        document.getElementById('kpi-google').textContent = data.googleWallets || 0;
        document.getElementById('kpi-apple').textContent = data.appleWallets || 0;
        document.getElementById('kpi-devices').textContent = data.appleDevices || 0;
      } catch (error) {
        console.error('Error cargando wallet stats:', error);
        document.getElementById('kpi-google').textContent = '—';
        document.getElementById('kpi-apple').textContent = '—';
        document.getElementById('kpi-devices').textContent = '—';
      }
    }

    // Botón para actualizar estadísticas de wallets (comentado - elemento no existe)
    // document.getElementById('btn-refresh-wallet-stats')?.addEventListener('click', loadWalletStats);

    /* ===== CARDS (Firestore + menú de acciones) ===== */
    let currentPage = 1;
    let cardsCache = {};
    let currentCardId = null;

    // Helper para formatear cumpleaños
    function formatBirthday(birthdate) {
      if (!birthdate) return '';
      const [y, m, d] = birthdate.split('-').map(Number);
      const months = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
      return `${d} ${months[m - 1]}`;
    }

    async function loadCards(page = 1) {
      try {
        const searchQuery = document.getElementById('search-cards').value;
        const sortValue = document.getElementById('sort-cards').value;
        const [sortField, sortOrder] = sortValue.split(':');

        const url = `/api/admin/cards-firebase?page=${page}&q=${encodeURIComponent(searchQuery)}&sort=${sortField}&order=${sortOrder}`;

        const response = await fetch(url, {
          credentials: 'include'
        });

        if (!response.ok) throw new Error('Error ' + response.status);

        const data = await response.json();
        const tbody = document.getElementById('cards-tbody');

        if (!data.items || data.items.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:12px;" class="muted">No hay tarjetas</td></tr>`;
          return;
        }

        cardsCache = {};
        data.items.forEach(c => { cardsCache[c.id] = c; });

        // Check birthdays
        checkBirthdays(data.items);

        tbody.innerHTML = data.items.map(card => {
          // Formatear última visita
          let lastVisitStr = '—';
          const lastVisitField = card.lastVisit || card.last_visit || card.updatedAt || card.updated_at;

          if (lastVisitField) {
            const lastDate = new Date(lastVisitField);
            const now = new Date();
            const diffDays = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) lastVisitStr = 'Hoy';
            else if (diffDays === 1) lastVisitStr = 'Ayer';
            else if (diffDays < 7) lastVisitStr = `Hace ${diffDays} días`;
            else lastVisitStr = lastDate.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
          }

          return `
          <tr data-card-id="${card.id}" class="card-row" style="cursor:pointer;">
            <td>
              <div style="font-weight:500;">${card.name || '—'}</div>
              ${card.birthdate ? `<div class="muted" style="font-size:11px;">🎂 ${formatBirthday(card.birthdate)}</div>` : ''}
            </td>
            <td style="font-size:13px;">${card.phone || '—'}</td>
            <td style="font-size:12px;">${lastVisitStr}</td>
            <td>
              <div style="display:flex;align-items:center;gap:6px;">
                <div style="background:rgba(255,255,255,0.1);border-radius:4px;height:6px;width:60px;overflow:hidden;">
                  <div style="background:linear-gradient(90deg,#FFD166,#8c9668);height:100%;width:${(card.stamps / card.max) * 100}%;"></div>
                </div>
                <span style="font-size:12px;font-weight:500;">${card.stamps}/${card.max}</span>
              </div>
            </td>
            <td>
              <div style="display:flex;gap:6px;">
                <button class="btn small" data-action="stamp" style="background:#FFD166;color:#000;font-weight:600;padding:4px 10px;"><i class="fas fa-star"></i>+1</button>
                <button class="btn small ghost" data-action="view" style="padding:4px 10px;">Ver</button>
              </div>
            </td>
          </tr>
        `}).join('');

        document.getElementById('page-info').textContent =
          `Página ${data.page} de ${data.totalPages} (${data.total} total)`;
        document.getElementById('btn-prev-page').disabled = data.page === 1;
        document.getElementById('btn-next-page').disabled = data.page === data.totalPages;
        currentPage = data.page;
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('cards-tbody').innerHTML =
          `<tr><td colspan="8" style="text-align:center;padding:12px;color:#fecaca;">Error: ${error.message}</td></tr>`;
      }
    }

    // Event listener for sorting
    document.getElementById('sort-cards').addEventListener('change', () => loadCards(1));

    document.getElementById('btn-prev-page').addEventListener('click', () => {
      if (currentPage > 1) loadCards(currentPage - 1);
    });

    document.getElementById('btn-next-page').addEventListener('click', () => {
      loadCards(currentPage + 1);
    });

    // ===== BÚSQUEDA INSTANTÁNEA CON DEBOUNCE =====
    let searchTimeout;
    const searchInput = document.getElementById('search-cards');
    const searchBtn = document.getElementById('btn-search-cards');

    // Instant search con debounce de 300ms
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        console.log('🔍 Búsqueda instantánea:', e.target.value);
        loadCards(1);
      }, 300);
    });

    // Mantener funcionalidad del botón de búsqueda
    searchBtn.addEventListener('click', () => loadCards(1));

    // Enter key también busca
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        clearTimeout(searchTimeout); // Cancelar debounce
        loadCards(1);
      }
    });
    document.getElementById('btn-reload-cards').addEventListener('click', () => loadCards(currentPage));

    document.getElementById('cards-tbody').addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;

      const tr = btn.closest('tr[data-card-id]');
      if (!tr) return;

      const cardId = tr.dataset.cardId;
      const card = cardsCache[cardId] || { id: cardId };
      const action = btn.dataset.action;

      switch (action) {
        case 'view':
          openCardModal(card);
          break;
        case 'copy':
          await copyCardId(cardId);
          break;
        case 'open':
          openClientPage(cardId);
          break;
        case 'stamp':
          await stampCard(cardId);
          break;
        case 'redeem':
          await redeemCard(cardId);
          break;
        case 'delete':
          await deleteCard(cardId);
          break;
      }
    });

    // Event listener for clicking on card rows (not on buttons)
    document.getElementById('cards-tbody').addEventListener('click', (e) => {
      // Si se hizo clic en un botón, ignorar
      if (e.target.closest('button')) return;

      // Buscar el tr más cercano
      const tr = e.target.closest('tr.card-row');
      if (!tr) return;

      const cardId = tr.dataset.cardId;
      const card = cardsCache[cardId];
      if (card) {
        openCardModal(card);
      }
    });

    /* ===== ESCÁNER QR (html5-qrcode) ===== */
    const scanDialog = $("#scanDialog");
    const scanStatus = $("#scan-status");
    let html5QrCode = null;

    $("#btn-scan-card").addEventListener("click", async () => {
      scanDialog.showModal();
      await startScan();
    });

    $("#scan-close").addEventListener("click", () => {
      stopScan();
      scanDialog.close();
    });

    async function startScan() {
      try {
        scanStatus.textContent = "Iniciando cámara...";

        // Crear instancia de html5-qrcode
        html5QrCode = new Html5Qrcode("qr-reader");

        // Iniciar escaneo
        await html5QrCode.start(
          { facingMode: "environment" }, // Cámara trasera
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          async (decodedText, decodedResult) => {
            // ✅ QR detectado exitosamente
            console.log("QR detectado:", decodedText);
            scanStatus.textContent = "✅ QR detectado";

            // Detener escáner
            await stopScan();

            // Procesar el QR
            await handleScan(decodedText);

            // Cerrar diálogo
            scanDialog.close();
          },
          (errorMessage) => {
            // Ignorar errores de no detectar QR (son normales)
          }
        );

        scanStatus.textContent = "📷 Apunta al QR de la tarjeta...";

      } catch (err) {
        console.error("Error iniciando cámara:", err);
        scanStatus.textContent = "❌ No se pudo acceder a la cámara";

        // Si falla, pedir permisos explícitamente
        if (err.name === 'NotAllowedError') {
          scanStatus.textContent = "⚠️ Por favor permite el acceso a la cámara";
        }
      }
    }

    async function stopScan() {
      if (html5QrCode && html5QrCode.isScanning) {
        try {
          await html5QrCode.stop();
          console.log("Escáner detenido");
        } catch (err) {
          console.error("Error deteniendo escáner:", err);
        }
      }
      html5QrCode = null;
    }

    function extractCardId(text) {
      try {
        const u = new URL(text);
        let c = u.searchParams.get("cardId");
        if (c) return c;
        c = u.searchParams.get("card");
        if (c) return c;
      } catch { }
      if (/^card_\d+/.test(text)) return text;
      return null;
    }

    async function handleScan(raw) {
      const cid = extractCardId(raw);
      if (!cid) {
        scanStatus.textContent = "QR inválido.";
        return;
      }

      stopScan();
      scanDialog.close();

      let card = cardsCache[cid];

      if (!card) {
        try {
          const r = await fetch('/api/card/' + encodeURIComponent(cid), {
            credentials: 'include'
          });
          if (r.ok) {
            card = await r.json();
          }
        } catch (e) {
          console.error('Error buscando tarjeta por ID', e);
        }
      }

      if (!card) {
        alert('Tarjeta no encontrada');
        return;
      }

      openCardModal(card);
    }

    /* ===== PUSH NOTIFICATIONS - CORREGIDO ===== */
    const typeEmojis = {
      'promo': '🎁 Promoción',
      'reminder': '⏰ Recordatorio',
      'update': 'ℹ️ Actualización',
      'alert': '⚠️ Alerta'
    };

    document.getElementById('push-title').addEventListener('input', function () {
      document.getElementById('preview-title').textContent = this.value || '¡Nueva promoción!';
    });

    document.getElementById('push-message').addEventListener('input', function () {
      document.getElementById('preview-message').textContent = this.value || 'Tu mensaje aparecerá aquí...';
    });

    document.getElementById('push-type').addEventListener('change', function () {
      document.getElementById('preview-type').textContent = typeEmojis[this.value];
    });

    document.getElementById('push-notification-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const title = document.getElementById('push-title').value;
      const message = document.getElementById('push-message').value;
      const type = document.getElementById('push-type').value;

      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Enviando...';
      submitBtn.disabled = true;

      try {
        const response = await fetch('/api/admin/push-notification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            title,
            message,
            type,
            // ✅ CORREGIDO: Especificar que es alerta visible
            alertType: 'visible',
            badge: 1,
            sound: 'default'
          })
        });

        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        document.getElementById('push-count').textContent = data.passCount;
        document.getElementById('push-success').classList.remove('hidden');
        document.getElementById('push-error').classList.add('hidden');

        this.reset();
        document.getElementById('preview-title').textContent = '¡Nueva promoción!';
        document.getElementById('preview-message').textContent = 'Tu mensaje aparecerá aquí...';

        loadNotificationsHistory();

        setTimeout(() => {
          document.getElementById('push-success').classList.add('hidden');
        }, 5000);

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('push-error').classList.remove('hidden');
        document.getElementById('push-success').classList.add('hidden');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    document.getElementById('test-push').addEventListener('click', async function () {
      const title = document.getElementById('push-title').value;
      const message = document.getElementById('push-message').value;

      if (!title || !message) {
        alert('Completa título y mensaje primero');
        return;
      }

      const originalText = this.textContent;
      this.textContent = 'Enviando...';
      this.disabled = true;

      try {
        const response = await fetch('/api/admin/push-test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            title,
            message,
            type: document.getElementById('push-type').value,
            // ✅ CORREGIDO: Especificar que es alerta visible
            alertType: 'visible'
          })
        });

        const data = await response.json();

        if (data.success) {
          alert(`✅ Prueba enviada a: ${data.cardId}`);
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        alert('❌ Error: ' + error.message);
      } finally {
        this.textContent = originalText;
        this.disabled = false;
      }
    });

    async function loadNotificationsHistory() {
      try {
        const response = await fetch('/api/admin/notifications', {
          credentials: 'include'
        });

        if (!response.ok) throw new Error('Error cargando historial');

        const data = await response.json();
        const tbody = document.getElementById('notifications-history');

        if (!data.notifications || data.notifications.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:12px;" class="muted">No hay notificaciones</td></tr>`;
          return;
        }

        tbody.innerHTML = data.notifications.map(n => {
          const date = new Date(n.createdAt);
          const dateStr = date.toLocaleDateString('es-ES', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
          }) + ', ' + date.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
          });

          return `
            <tr>
              <td>${dateStr}</td>
              <td>${n.title}</td>
              <td>${typeEmojis[n.type] || n.type}</td>
              <td>${n.googleSent}/${n.cardsSent}</td>
              <td>${n.errors > 0 ? `<span style="color:#fecaca">${n.errors}</span>` : '0'}</td>
            </tr>
          `;
        }).join('');

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('notifications-history').innerHTML =
          `<tr><td colspan="5" style="text-align:center;padding:12px;color:#fecaca;">Error cargando historial</td></tr>`;
      }
    }

    document.getElementById('refresh-history').addEventListener('click', loadNotificationsHistory);

    // Borrar historial de notificaciones
    document.getElementById('clear-notif-history').addEventListener('click', async () => {
      if (!confirm('¿Estás seguro de borrar todo el historial de notificaciones enviadas?')) return;

      try {
        const response = await fetch('/api/admin/notifications/clear', {
          method: 'DELETE',
          credentials: 'include'
        });

        if (response.ok) {
          alert('✓ Historial borrado correctamente');
          loadNotificationsHistory();
        } else {
          const data = await response.json();
          alert('Error: ' + (data.error || 'No se pudo borrar el historial'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error de red al borrar historial');
      }
    });

    // ===== Modal Tarjeta =====
    const modalBackdrop = document.getElementById('card-modal-backdrop');
    const modalCloseBtn = document.getElementById('cm-close');
    const modalQrCanvas = document.getElementById('card-qr');

    async function openCardModal(card) {
      currentCardId = card.id;

      // Datos básicos
      document.getElementById('cm-id').textContent = card.id;
      document.getElementById('cm-name').textContent = card.name || '—';
      document.getElementById('cm-phone').textContent = card.phone || '—';
      document.getElementById('cm-stamps').textContent = `${card.stamps} / ${card.max}`;

      // Barra de progreso
      const progressPercent = Math.min((card.stamps / card.max) * 100, 100);
      document.getElementById('cm-progress-bar').style.width = `${progressPercent}%`;

      // Texto de estado
      const remaining = card.max - card.stamps;
      let statusText = '';
      if (card.stamps >= card.max) {
        statusText = '🎉 ¡Tarjeta completa! Lista para canjear';
      } else if (remaining === 1) {
        statusText = '⚡ ¡Solo falta 1 sello!';
      } else if (remaining <= 3) {
        statusText = `🔥 Faltan ${remaining} sellos`;
      } else {
        statusText = `Faltan ${remaining} sellos para completar`;
      }
      document.getElementById('cm-status-text').textContent = statusText;

      // Notas
      document.getElementById('cm-notes').value = card.notes || '';

      // Cargar información adicional del cliente
      loadClientInfo(card);

      // Cargar próxima cita
      loadNextAppointment(card.phone, card.name);

      // Mostrar modal
      modalBackdrop.classList.remove('hidden');

      // Resetear formulario de notificación
      document.getElementById('notify-form-container').classList.add('hidden');
      document.getElementById('notify-title').value = 'Recordatorio Venus';
      document.getElementById('notify-message').value = '';

      // Generar QR
      const url = `${window.location.origin}/?cardId=${encodeURIComponent(card.id)}`;
      if (typeof QRCode !== 'undefined' && modalQrCanvas) {
        try {
          const ctx = modalQrCanvas.getContext('2d');
          ctx.clearRect(0, 0, modalQrCanvas.width, modalQrCanvas.height);
          await QRCode.toCanvas(modalQrCanvas, url, {
            width: 150,
            height: 150,
            margin: 2,
            color: { dark: '#000000', light: '#ffffff' }
          });
        } catch (err) {
          console.error('Error generando QR:', err);
        }
      }
    }

    // Función auxiliar para cargar próxima cita
    async function loadNextAppointment(phone, name) {
      const nextApptSection = document.getElementById('cm-next-appt-section');

      try {
        const searchParam = phone || name;
        if (!searchParam) {
          nextApptSection.classList.add('hidden');
          return;
        }

        const res = await fetch(`/api/appointments/client?search=${encodeURIComponent(searchParam)}`);
        const json = await res.json();

        if (json.success && json.data) {
          // Buscar la próxima cita (status = scheduled y fecha futura)
          const now = new Date();
          const nextAppt = json.data.find(a =>
            a.status === 'scheduled' && new Date(a.startDateTime) > now
          );

          if (nextAppt) {
            const date = new Date(nextAppt.startDateTime);
            const dateStr = date.toLocaleDateString('es-MX', {
              day: 'numeric',
              month: 'short'
            });
            const timeStr = date.toLocaleTimeString('es-MX', {
              hour: '2-digit',
              minute: '2-digit'
            });

            document.getElementById('cm-next-appt-date').textContent = `${dateStr} ${timeStr}`;
            document.getElementById('cm-next-appt-service').textContent = nextAppt.serviceName;
            nextApptSection.classList.remove('hidden');
          } else {
            nextApptSection.classList.add('hidden');
          }
        } else {
          nextApptSection.classList.add('hidden');
        }
      } catch (error) {
        console.error('Error cargando próxima cita:', error);
        nextApptSection.classList.add('hidden');
      }
    }

    function closeCardModal() {
      modalBackdrop.classList.add('hidden');
      currentCardId = null;
    }

    modalCloseBtn.addEventListener('click', closeCardModal);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeCardModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modalBackdrop.classList.contains('hidden')) {
        closeCardModal();
      }
    });

    // ===== Helpers acciones tarjeta - CORREGIDOS =====
    async function copyCardId(cardId) {
      try {
        await navigator.clipboard.writeText(cardId);
        alert('✅ ID copiado al portapapeles');
      } catch (e) {
        alert('No se pudo copiar el ID');
      }
    }

    function openClientPage(cardId) {
      const url = `${window.location.origin}/?cardId=${encodeURIComponent(cardId)}`;
      window.open(url, '_blank');
    }

    /* ===== PHASE 5: LOAD & SAVE CLIENT INFO ===== */
    async function loadClientInfo(card) {
      // Cargar campos editables
      document.getElementById('cm-notes').value = card.notes || '';

      // Resetear valores mientras carga
      document.getElementById('cm-visited-count').textContent = '...';
      document.getElementById('cm-cycles-completed').textContent = '...';
      document.getElementById('cm-last-visit').textContent = '...';

      try {
        // Cargar eventos de la tarjeta para calcular stats reales
        const eventsRes = await fetch(`/api/events/${card.id}`);
        const events = await eventsRes.json();

        if (Array.isArray(events)) {
          // Contar stamps (visitas)
          const stamps = events.filter(e => e.type === 'STAMP');
          const redeems = events.filter(e => e.type === 'REDEEM');

          document.getElementById('cm-visited-count').textContent = stamps.length;
          document.getElementById('cm-cycles-completed').textContent = redeems.length;

          // Última visita (usar campo directo de la tarjeta)
          const lastVisitField = card.lastVisit || card.last_visit;
          if (lastVisitField) {
            const lastVisitDate = new Date(lastVisitField);
            document.getElementById('cm-last-visit').textContent = lastVisitDate.toLocaleDateString('es-MX', {
              day: 'numeric', month: 'short', year: 'numeric'
            });
          } else if (stamps.length > 0) {
            // Fallback a eventos si no hay campo directo
            const lastStamp = stamps.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
            const lastVisitDate = new Date(lastStamp.createdAt);
            document.getElementById('cm-last-visit').textContent = lastVisitDate.toLocaleDateString('es-MX', {
              day: 'numeric', month: 'short', year: 'numeric'
            });
          } else {
            document.getElementById('cm-last-visit').textContent = '—';
          }
        }

        // Cargar próxima cita del cliente
        const phone = card.phone;
        if (phone) {
          const apptRes = await fetch(`/api/appointments/client?search=${encodeURIComponent(phone)}`);
          const apptData = await apptRes.json();

          if (apptData.success && apptData.data && apptData.data.length > 0) {
            // Buscar citas futuras (scheduled o confirmed)
            const now = new Date();
            const futureAppts = apptData.data
              .filter(a => (a.status === 'scheduled' || a.status === 'confirmed') && new Date(a.startDateTime) > now)
              .sort((a, b) => new Date(a.startDateTime) - new Date(b.startDateTime));

            // Ya se maneja en loadNextAppointment()
          }
        }

      } catch (error) {
        console.error('Error cargando info del cliente:', error);
        document.getElementById('cm-visited-count').textContent = '—';
        document.getElementById('cm-cycles-completed').textContent = '—';
        document.getElementById('cm-last-visit').textContent = '—';
      }
    }

    async function saveClientInfo() {
      if (!currentCardId) return;

      const notes = document.getElementById('cm-notes').value;

      try {
        const response = await fetch('/api/admin/update-client-info', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: currentCardId,
            notes
          })
        });

        const data = await response.json();

        if (response.ok) {
          alert('✅ Información guardada correctamente');
          // Actualizar cache
          if (cardsCache[currentCardId]) {
            cardsCache[currentCardId].notes = notes;
          }
        } else {
          alert(`❌ Error: ${data.error || 'No se pudo guardar'}`);
        }
      } catch (error) {
        console.error('Error guardando información:', error);
        alert('❌ Error al guardar información');
      }
    }

    // Event listener para botón guardar
    document.getElementById('cm-save-notes')?.addEventListener('click', saveClientInfo);

    /* ===== STAMP CARD - CORREGIDO PARA ACTUALIZAR GOOGLE WALLET ===== */
    async function stampCard(cardId) {
      if (!confirm('¿Agregar 1 sello a esta tarjeta?')) return;
      try {
        const r = await fetch('/api/admin/stamp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cardId })
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          throw new Error(data.error || 'No se pudo agregar sello');
        }

        // ✅ CORRECCIÓN CRÍTICA: Actualizar Google Wallet inmediatamente
        try {
          const card = cardsCache[cardId];
          if (card) {
            // Calcular nuevos stamps
            const newStamps = (card.stamps || 0) + 1;

            // Actualizar Google Wallet
            const { updateLoyaltyObject } = await import("./lib/google.js");
            await updateLoyaltyObject(cardId, card.name, newStamps, card.max);
            console.log(`[GOOGLE WALLET] ✅ Stamp actualizado para: ${cardId} (${newStamps}/${card.max})`);
          }
        } catch (googleError) {
          console.error(`[GOOGLE WALLET] ❌ Error actualizando stamp:`, googleError.message);
        }

        await loadCards(currentPage);
        if (currentCardId === cardId) {
          const updated = cardsCache[cardId];
          if (updated) openCardModal(updated);
        }
        alert('✅ Sello agregado y Google Wallet actualizado');
      } catch (e) {
        alert('❌ Error: ' + e.message);
      }
    }

    async function redeemCard(cardId) {
      if (!confirm('¿Canjear esta tarjeta? Se reiniciarán los sellos.')) return;
      try {
        const r = await fetch('/api/admin/redeem', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cardId })
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          throw new Error(data.error || 'No se pudo canjear');
        }

        // ✅ CORRECCIÓN: Actualizar Google Wallet después del canje
        try {
          const card = cardsCache[cardId];
          if (card) {
            const { updateLoyaltyObject } = await import("./lib/google.js");
            await updateLoyaltyObject(cardId, card.name, 0, card.max);
            console.log(`[GOOGLE WALLET] ✅ Canje realizado para: ${cardId} (0/${card.max})`);
          }
        } catch (googleError) {
          console.error(`[GOOGLE WALLET] ❌ Error actualizando canje:`, googleError.message);
        }

        await loadCards(currentPage);
        if (currentCardId === cardId) {
          const updated = cardsCache[cardId];
          if (updated) openCardModal(updated);
        }
        alert('✅ Canje realizado y Google Wallet actualizado');
      } catch (e) {
        alert('❌ Error: ' + e.message);
      }
    }

    async function deleteCard(cardId) {
      if (!confirm('⚠️ Esto eliminará la tarjeta de la base de datos, eventos y Firestore. ¿Continuar?')) return;
      try {
        const r = await fetch(`/api/admin/card/${encodeURIComponent(cardId)}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          throw new Error(data.error || 'No se pudo eliminar');
        }
        closeCardModal();
        await loadCards(currentPage);
        alert('✅ Tarjeta eliminada');
      } catch (e) {
        alert('❌ Error: ' + e.message);
      }
    }

    /* ===== REGISTRAR DISPOSITIVO GOOGLE (NUEVO) ===== */
    async function registerGoogleDevice(cardId) {
      try {
        let deviceId = localStorage.getItem('google_device_id');
        if (!deviceId) {
          deviceId = 'gdev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('google_device_id', deviceId);
        }

        const response = await fetch('/api/google/register-device', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            cardId: cardId,
            deviceId: deviceId
          })
        });

        const data = await response.json();

        if (data.success) {
          console.log('✅ Dispositivo Google registrado:', deviceId);
          return true;
        } else {
          console.error('❌ Error registrando dispositivo Google:', data.error);
          return false;
        }
      } catch (error) {
        console.error('❌ Error registrando dispositivo Google:', error);
        return false;
      }
    }

    // Toggle del formulario de notificación
    document.getElementById('cm-notify').addEventListener('click', () => {
      const form = document.getElementById('notify-form-container');
      form.classList.toggle('hidden');
      if (!form.classList.contains('hidden')) {
        document.getElementById('notify-message').focus();
      }
    });

    // Cancelar notificación
    document.getElementById('btn-cancel-notify').addEventListener('click', () => {
      document.getElementById('notify-form-container').classList.add('hidden');
    });

    // Enviar notificación individual
    document.getElementById('btn-send-notify').addEventListener('click', async function () {
      if (!currentCardId) return;

      const title = document.getElementById('notify-title').value;
      const message = document.getElementById('notify-message').value;

      if (!title || !message) {
        alert('Por favor completa el título y el mensaje');
        return;
      }

      const btn = this;
      const originalText = btn.textContent;
      btn.textContent = 'Enviando...';
      btn.disabled = true;

      try {
        const r = await fetch('/api/admin/push-one', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: currentCardId,
            title,
            message,
            type: 'personal',
            alertType: 'visible'
          })
        });
        const data = await r.json();

        if (!r.ok || !data.success) {
          throw new Error(data.error || 'No se pudo enviar la notificación');
        }

        alert('✅ Notificación enviada exitosamente');
        document.getElementById('notify-form-container').classList.add('hidden');
        document.getElementById('notify-message').value = ''; // Limpiar mensaje

      } catch (e) {
        alert('❌ Error: ' + e.message);
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    });

    // ✅ NUEVO: Botón para registrar dispositivo Google desde el modal
    document.getElementById('cm-register-google')?.addEventListener('click', async () => {
      if (currentCardId) {
        const success = await registerGoogleDevice(currentCardId);
        if (success) {
          alert('✅ Dispositivo Google registrado exitosamente');
        } else {
          alert('❌ Error registrando dispositivo Google');
        }
      }
    });

    // Acciones desde el modal - con verificación de existencia
    const btnStamp = document.getElementById('cm-stamp');
    const btnRedeem = document.getElementById('cm-redeem');
    const btnCopy = document.getElementById('cm-copy');
    const btnOpenUrl = document.getElementById('cm-open-url');
    const btnDelete = document.getElementById('cm-delete');
    const btnWhatsApp = document.getElementById('cm-whatsapp');
    const btnSchedule = document.getElementById('cm-schedule');

    if (btnStamp) {
      btnStamp.addEventListener('click', async () => {
        if (currentCardId) await stampCard(currentCardId);
      });
    }

    if (btnRedeem) {
      btnRedeem.addEventListener('click', async () => {
        if (currentCardId) await redeemCard(currentCardId);
      });
    }

    if (btnCopy) {
      btnCopy.addEventListener('click', async () => {
        if (currentCardId) await copyCardId(currentCardId);
      });
    }

    if (btnOpenUrl) {
      btnOpenUrl.addEventListener('click', () => {
        if (currentCardId) openClientPage(currentCardId);
      });
    }

    if (btnDelete) {
      btnDelete.addEventListener('click', async () => {
        if (currentCardId) await deleteCard(currentCardId);
      });
    }

    // ===== Botón Agendar =====
    if (btnSchedule) {
      btnSchedule.addEventListener('click', () => {
        if (!currentCardId) return;

        const client = cardsCache[currentCardId];
        if (!client) return;

        // Primero cambiar a la pestaña de Agenda
        const agendaTab = document.querySelector('[data-tab="appointments"]');
        if (agendaTab) {
          agendaTab.click();
        }

        // Esperar un momento para que la pestaña se active
        setTimeout(() => {
          // Abrir el modal de nueva cita
          const newApptDialog = document.getElementById('newApptDialog');
          const clientSelectInput = document.getElementById('new-appt-client-select');
          const phoneInput = document.getElementById('new-appt-phone');
          const dateInput = document.getElementById('new-appt-date');

          if (newApptDialog && clientSelectInput && phoneInput) {
            // Cargar datos necesarios
            loadServices();
            loadClients();
            generateHourMinuteOptions();

            // Prellenar nombre y teléfono
            clientSelectInput.value = client.name || '';
            phoneInput.value = client.phone || '';

            // Prellenar fecha con hoy si está vacía
            if (dateInput && !dateInput.value) {
              const today = new Date();
              const year = today.getFullYear();
              const month = String(today.getMonth() + 1).padStart(2, '0');
              const day = String(today.getDate()).padStart(2, '0');
              dateInput.value = `${year}-${month}-${day}`;
            }

            // Deshabilitar campos de nombre y teléfono (están bloqueados)
            clientSelectInput.disabled = true;
            phoneInput.disabled = true;

            // Mostrar el modal
            newApptDialog.showModal();

            // Cerrar el modal del cliente
            closeCardModal();
          }
        }, 100);
      });
    }

    // ===== Botón WhatsApp =====
    if (btnWhatsApp) {
      btnWhatsApp.addEventListener('click', () => {
        if (!currentCardId) return;

        const phone = cardsCache[currentCardId]?.phone;
        const name = cardsCache[currentCardId]?.name || 'Cliente';

        if (!phone) {
          alert('⚠️ Este cliente no tiene teléfono registrado');
          return;
        }

        // Limpiar el número (remover espacios, guiones, etc.)
        const cleanPhone = phone.replace(/\D/g, '');

        // Mensaje predeterminado
        const message = encodeURIComponent(`Hola ${name}, te contacto de Venus Cosmetología`);

        // Abrir WhatsApp
        window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
      });
    }

    /* ===== DEBUGGING AVANZADO (NUEVO) ===== */

    // Test Apple Push
    document.getElementById('btn-test-apple-push')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta para prueba:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = '🧪 Enviando prueba Apple Push...';

      try {
        const response = await fetch('/api/debug/test-apple-push', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: cardId,
            title: "🔥 PRUEBA APPLE PUSH",
            message: "Si ves esto, las notificaciones Apple funcionan correctamente!"
          })
        });

        const data = await response.json();
        output.innerHTML = `✅ Resultado Apple Push:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `❌ Error Apple Push:<br>${error.message}`;
      }
    });

    // Test Google Push
    document.getElementById('btn-test-google-push')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta para prueba:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = '🧪 Enviando prueba Google Push...';

      try {
        const response = await fetch('/api/debug/test-google-push', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: cardId,
            title: "🔥 PRUEBA GOOGLE PUSH",
            message: "Esto debe aparecer en Google Wallet"
          })
        });

        const data = await response.json();
        output.innerHTML = `✅ Resultado Google Push:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `❌ Error Google Push:<br>${error.message}`;
      }
    });

    // Reparar Google Wallet
    document.getElementById('btn-fix-google-wallet')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta a reparar:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = '🔧 Reparando objeto Google Wallet...';

      try {
        const response = await fetch(`/api/debug/fix-google-wallet/${cardId}`, {
          method: 'POST',
          credentials: 'include'
        });

        const data = await response.json();
        output.innerHTML = `✅ Google Wallet reparado:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `❌ Error reparando Google Wallet:<br>${error.message}`;
      }
    });

    /* ===== BIRTHDAY LOGIC (Cards Tab) ===== */
    function checkBirthdays(cards) {
      const today = new Date();
      const currentMonth = today.getMonth(); // 0-11
      const currentDay = today.getDate();

      const upcomingBirthdays = cards.filter(card => {
        if (!card.birthdate) return false;
        // Parse YYYY-MM-DD manually to avoid timezone issues
        const [y, m, d] = card.birthdate.split('-').map(Number);
        const bMonth = m - 1; // 0-11
        const bDay = d;

        // Check if birthday is in the next 7 days
        if (bMonth === currentMonth) {
          return bDay >= currentDay && bDay <= currentDay + 7;
        }
        // Handle month wrapping
        const nextMonthDate = new Date(today);
        nextMonthDate.setDate(today.getDate() + 7);
        if (nextMonthDate.getMonth() !== currentMonth && bMonth === nextMonthDate.getMonth()) {
          return bDay <= nextMonthDate.getDate();
        }
        return false;
      });

      const section = document.getElementById('birthday-section');
      const list = document.getElementById('birthday-list');
      const actions = document.getElementById('birthday-actions');

      if (upcomingBirthdays.length === 0) {
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');
      list.innerHTML = upcomingBirthdays.map(c => {
        const [y, m, d] = c.birthdate.split('-').map(Number);

        // Calculate days until (handling year wrap if needed, though simpler here)
        const now = new Date(); now.setHours(0, 0, 0, 0);
        const nextBday = new Date(today.getFullYear(), m - 1, d);
        if (nextBday < now) nextBday.setFullYear(now.getFullYear() + 1);

        const diffTime = nextBday - now;
        const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        let actionBtn = '';
        if (daysUntil <= 2 && daysUntil >= 0) {
          actionBtn = `<button onclick="sendBirthdayPush('${c.id}', '${c.name}')" class="btn small primary" style="font-size:10px; padding: 2px 6px;"><i class="fas fa-gift" style="width:12px;height:12px;"></i> Felicitar</button>`;
        }

        const monthNames = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];

        return `
          <div style="background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 16px;">🎉</span>
            <div>
              <div style="font-weight: 600; font-size: 13px;">${c.name || 'Cliente'}</div>
              <div class="muted" style="font-size: 11px;">${d} de ${monthNames[m - 1]}</div>
            </div>
            ${actionBtn}
          </div>
        `;
      }).join('');

      actions.innerHTML = `<span class="tag" style="background:#ffd166; color:#000;">${upcomingBirthdays.length} pendientes</span>`;
    }

    /* ===== BIRTHDAY LOGIC (Overview Tab) ===== */
    function checkOverviewBirthdays(cards) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Calculate 30 days ago and 30 days ahead
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);

      const thirtyDaysAhead = new Date(today);
      thirtyDaysAhead.setDate(today.getDate() + 30);

      // Filter birthdays
      const allBirthdays = cards.filter(card => {
        if (!card.birthdate) return false;
        const [y, m, d] = card.birthdate.split('-').map(Number);
        const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

        // Include birthdays from 30 days ago to 30 days ahead
        return birthdayThisYear >= thirtyDaysAgo && birthdayThisYear <= thirtyDaysAhead;
      });

      const section = document.getElementById('overview-birthday-section');
      const upcomingContainer = document.getElementById('upcoming-birthdays-container');
      const pastContainer = document.getElementById('past-birthdays-container');
      const upcomingList = document.getElementById('upcoming-birthday-list');
      const pastList = document.getElementById('past-birthday-list');

      if (allBirthdays.length === 0) {
        section.classList.add('hidden');
        return;
      }

      // Separate into past and upcoming
      const pastBirthdays = [];
      const upcomingBirthdays = [];

      allBirthdays.forEach(card => {
        const [y, m, d] = card.birthdate.split('-').map(Number);
        const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

        if (birthdayThisYear < today) {
          pastBirthdays.push(card);
        } else {
          upcomingBirthdays.push(card);
        }
      });

      section.classList.remove('hidden');

      const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

      // Render upcoming birthdays (sorted by date, closest first)
      if (upcomingBirthdays.length > 0) {
        upcomingContainer.classList.remove('hidden');
        upcomingBirthdays.sort((a, b) => {
          const [ya, ma, da] = a.birthdate.split('-').map(Number);
          const [yb, mb, db] = b.birthdate.split('-').map(Number);
          const dateA = new Date(today.getFullYear(), ma - 1, da);
          const dateB = new Date(today.getFullYear(), mb - 1, db);
          return dateA - dateB; // Soonest first
        });

        upcomingList.innerHTML = upcomingBirthdays.map(c => {
          const [y, m, d] = c.birthdate.split('-').map(Number);
          const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

          const diffTime = birthdayThisYear - today;
          const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          let actionBtn = '';
          let daysLabel = '';

          if (daysUntil === 0) {
            daysLabel = '<span style="color: #ffd166; font-weight: 600;"><i class="fas fa-party-horn"></i> Hoy</span>';
            actionBtn = `<button onclick="sendBirthdayPush('${c.id}', '${c.name}')" class="btn small primary" style="font-size:10px; padding: 2px 6px;"><i class="fas fa-gift" style="width:12px;height:12px;"></i> Felicitar</button>`;
          } else {
            daysLabel = `<span style="color: #a7f3d0;">en ${daysUntil} día${daysUntil > 1 ? 's' : ''}</span>`;
          }

          return `
            <div style="background: rgba(167, 243, 208, 0.1); border: 1px solid rgba(167, 243, 208, 0.2); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 16px;">🎈</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 13px;">${c.name || 'Cliente'}</div>
                <div class="muted" style="font-size: 11px;">${d} de ${monthNames[m - 1].toLowerCase()} • ${daysLabel}</div>
              </div>
              ${actionBtn}
            </div>
          `;
        }).join('');
      } else {
        upcomingContainer.classList.add('hidden');
      }

      // Render past birthdays (sorted by date, most recent first)
      if (pastBirthdays.length > 0) {
        pastContainer.classList.remove('hidden');
        pastBirthdays.sort((a, b) => {
          const [ya, ma, da] = a.birthdate.split('-').map(Number);
          const [yb, mb, db] = b.birthdate.split('-').map(Number);
          const dateA = new Date(today.getFullYear(), ma - 1, da);
          const dateB = new Date(today.getFullYear(), mb - 1, db);
          return dateB - dateA; // Most recent first
        });

        pastList.innerHTML = pastBirthdays.map(c => {
          const [y, m, d] = c.birthdate.split('-').map(Number);
          const birthdayThisYear = new Date(today.getFullYear(), m - 1, d);

          const diffTime = today - birthdayThisYear;
          const daysAgo = Math.floor(diffTime / (1000 * 60 * 60 * 24));

          const daysLabel = `<span style="color: #cbd5e1;">hace ${daysAgo} día${daysAgo > 1 ? 's' : ''}</span>`;

          return `
            <div style="background: rgba(203, 213, 225, 0.1); border: 1px solid rgba(203, 213, 225, 0.2); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 16px;">🎂</span>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 13px;">${c.name || 'Cliente'}</div>
                <div class="muted" style="font-size: 11px;">${d} de ${monthNames[m - 1].toLowerCase()} • ${daysLabel}</div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        pastContainer.classList.add('hidden');
      }
    }

    window.sendBirthdayPush = async function (cardId, name) {
      if (!confirm(`¿Enviar felicitación de cumpleaños a ${name}?`)) return;

      try {
        const r = await fetch('/api/admin/push-one', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            cardId: cardId,
            title: "🎂 ¡Feliz Cumpleaños!",
            message: `¡Hola ${name}! En Venus queremos celebrarte. Ven por un regalo especial en tu próxima visita. 🎉`,
            type: 'promo',
            alertType: 'visible'
          })
        });
        const data = await r.json();
        if (!r.ok || !data.success) {
          throw new Error(data.error || 'No se pudo enviar');
        }
        alert('✅ Felicitación enviada exitosamente');
      } catch (e) {
        alert('❌ Error: ' + e.message);
      }
    };

    // Ver dispositivos
    document.getElementById('btn-check-devices')?.addEventListener('click', async function () {
      const cardId = prompt('ID de la tarjeta para ver dispositivos:');
      if (!cardId) return;

      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = '📱 Cargando información de dispositivos...';

      try {
        // Dispositivos Apple
        const appleResponse = await fetch(`/api/debug/apple-devices?cardId=${cardId}`, {
          credentials: 'include'
        });
        const appleData = await appleResponse.json();

        // Dispositivos Google
        const googleResponse = await fetch(`/api/debug/google-devices/${cardId}`, {
          credentials: 'include'
        });
        const googleData = await googleResponse.json();

        output.innerHTML = `
          <strong>📱 Dispositivos para ${cardId}:</strong><br><br>
          <strong>🍎 Apple:</strong> ${appleData.devices?.length || 0} dispositivos<br>
          <strong>🟢 Google:</strong> ${googleData.deviceCount || 0} dispositivos<br><br>
          <strong>Detalles Apple:</strong><br>${JSON.stringify(appleData.devices || [], null, 2)}<br><br>
          <strong>Detalles Google:</strong><br>${JSON.stringify(googleData.devices || [], null, 2)}
        `;
      } catch (error) {
        output.innerHTML = `❌ Error cargando dispositivos:<br>${error.message}`;
      }
    });

    // Ver configuración APNs
    document.getElementById('btn-check-apns')?.addEventListener('click', async function () {
      const output = document.getElementById('debug-output');
      output.style.display = 'block';
      output.innerHTML = '🍎 Verificando configuración APNs...';

      try {
        const response = await fetch('/api/debug/apple-apns', {
          credentials: 'include'
        });

        const data = await response.json();
        output.innerHTML = `✅ Configuración APNs:<br>${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        output.innerHTML = `❌ Error verificando APNs:<br>${error.message}`;
      }
    });

    // Logout
    document.getElementById('logout').addEventListener('click', async () => {
      try {
        await fetch('/api/logout', { method: 'POST', credentials: 'include' });
        window.location.href = '/admin-login.html';
      } catch (error) {
        console.error('Error al cerrar sesión:', error);
        window.location.href = '/admin-login.html';
      }
    });

    /* =========================================================
       LÓGICA DEL BOTÓN "ENVIAR A TODOS"
       ========================================================= */



    // Prevent form submission from interfering with buttons
    const pushForm = document.getElementById('push-notification-form');
    if (pushForm) {
      pushForm.addEventListener('submit', (e) => {
        e.preventDefault();
        console.log('Form submission prevented');
      });
    }

    const btnGlobal = document.getElementById('btn-mass-push');
    console.log('🔍 Buscando botón btn-mass-push:', btnGlobal);

    if (btnGlobal) {
      console.log('✅ Botón encontrado, agregando event listener');

      btnGlobal.addEventListener('click', async (e) => {
        e.preventDefault(); // Prevent any form submission
        e.stopPropagation(); // Stop event bubbling

        console.log('🚀 Botón "Enviar a todos" clickeado');

        const title = document.getElementById('push-title').value.trim();
        const message = document.getElementById('push-message').value.trim();

        console.log('📝 Título:', title);
        console.log('📝 Mensaje:', message);

        if (!title || !message) {
          console.warn('⚠️ Faltan datos');
          return alert("⚠️ Faltan datos: Escribe título y mensaje.");
        }

        if (!confirm(`🚨 ¿ENVIAR A TODOS?\n\n"${title}"`)) {
          console.log('❌ Usuario canceló');
          return;
        }

        const originalText = btnGlobal.textContent;
        btnGlobal.innerHTML = `<span style="display: inline-flex; align-items: center; gap: 6px;"><span class="spinner"></span> Enviando...</span>`;
        btnGlobal.disabled = true;

        console.log('📡 Enviando petición a /api/admin/push-all...');

        try {
          const r = await fetch('/api/admin/push-all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ title, message })
          });

          console.log('📥 Respuesta recibida:', r.status);
          const data = await r.json();
          console.log('📦 Data:', data);

          if (data.success) {
            const apple = data.results?.apple || 0;
            const google = data.results?.google || 0;
            console.log('✅ Éxito! Apple:', apple, 'Google:', google);
            alert(`✅ ¡ENVIADO!\n\n🍏 Apple: ${apple}\n🤖 Google: ${google}`);
            // Limpiar campos
            document.getElementById('push-title').value = "";
            document.getElementById('push-message').value = "";
          } else {
            console.error('❌ Error en respuesta:', data.error);
            alert('⚠️ Error: ' + (data.error || "Desconocido"));
          }
        } catch (e) {
          console.error('💥 Error de conexión:', e);
          alert('❌ Error de conexión: ' + e.message);
        } finally {
          btnGlobal.textContent = originalText;
          btnGlobal.disabled = false;
          console.log('🏁 Proceso terminado');
        }
      });
    } else {
      console.error('❌ Botón btn-mass-push NO encontrado en el DOM');
    }
    // Este archivo contiene el JavaScript completo para el módulo de citas
    // Se insertará en admin.html reemplazando la sección actual

    /* =========================================================
       LÓGICA DE CITAS - VERSIÓN COMPLETA
       ========================================================= */

    // Variables globales
    let allServices = [];
    let allClients = [];
    let currentWeekStart = new Date();
    currentWeekStart.setHours(0, 0, 0, 0);
    let selectedDate = new Date();
    selectedDate.setHours(0, 0, 0, 0);

    // Helper function to convert Date to local YYYY-MM-DD
    function toLocalDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Elementos del DOM
    const btnNewAppt = document.getElementById('btn-new-appointment');
    const newApptDialog = document.getElementById('newApptDialog');
    const formNewAppt = document.getElementById('form-new-appt');
    const btnCancelAppt = document.getElementById('btn-cancel-appt');
    const apptsTbody = document.getElementById('appts-tbody');
    const serviceSelect = document.getElementById('new-appt-service');
    const clientSelect = document.getElementById('new-appt-client-select');
    const phoneInput = document.getElementById('new-appt-phone');
    const hourSelect = document.getElementById('new-appt-hour');
    const minuteSelect = document.getElementById('new-appt-minute');
    const priceInput = document.getElementById('new-appt-price');
    const endTimeInput = document.getElementById('new-appt-end-time');
    const btnRefreshAppts = document.getElementById('btn-refresh-appts');

    // Navegación semanal
    const btnPrevWeek = document.getElementById('btn-prev-week');
    const btnNextWeek = document.getElementById('btn-next-week');
    const btnToday = document.getElementById('btn-today');
    const weeklyCalendar = document.getElementById('weekly-calendar');
    const selectedDateLabel = document.getElementById('selected-date-label');

    // Nuevo cliente
    const btnToggleNewClient = document.getElementById('btn-toggle-new-client');
    const newClientForm = document.getElementById('new-client-form');
    const btnSaveNewClient = document.getElementById('btn-save-new-client');


    // ========== GENERAR OPCIONES DE HORA Y MINUTOS ==========
    function generateHourMinuteOptions() {
      const hourSelect = document.getElementById('new-appt-hour');
      const minuteSelect = document.getElementById('new-appt-minute');

      if (!hourSelect || !minuteSelect) return;

      // Generar horas (8 AM - 8 PM)
      hourSelect.innerHTML = '<option value="">--</option>';
      for (let hour = 8; hour <= 20; hour++) {
        const option = document.createElement('option');
        option.value = String(hour).padStart(2, '0');
        const displayHour = hour > 12 ? hour - 12 : hour;
        const period = hour >= 12 ? 'PM' : 'AM';
        option.textContent = `${displayHour} ${period}`;
        hourSelect.appendChild(option);
      }

      // Generar minutos (00, 15, 30, 45)
      minuteSelect.innerHTML = '<option value="">--</option>';
      [0, 15, 30, 45].forEach(min => {
        const option = document.createElement('option');
        option.value = String(min).padStart(2, '0');
        option.textContent = String(min).padStart(2, '0');
        minuteSelect.appendChild(option);
      });
    }

    // ========== CARGAR SERVICIOS ==========
    async function loadServices() {
      try {
        const res = await fetch('/api/services');
        const json = await res.json();
        if (json.success) {
          allServices = json.data;

          // Map services to dropdown options format
          const options = allServices.map(s => ({
            value: s.name,
            label: s.name,
            meta: `${s.durationMinutes} min - $${s.price}`,
            data: { id: s.id, price: s.price, duration: s.durationMinutes }
          }));

          // Initialize dropdowns if not already done
          if (!newApptServiceDropdown) {
            newApptServiceDropdown = new CustomSearchableDropdown(
              'new-appt-service',
              'services-dropdown-list',
              (item) => {
                // Auto-fill price when service selected
                document.getElementById('new-appt-price').value = item.data.price;
              }
            );
          }
          newApptServiceDropdown.setOptions(options);

          if (!editApptServiceDropdown) {
            editApptServiceDropdown = new CustomSearchableDropdown(
              'edit-appt-service',
              'edit-services-dropdown-list',
              (item) => {
                // Auto-fill price and duration when service selected
                document.getElementById('edit-appt-price').value = item.data.price;
                document.getElementById('edit-appt-duration').value = item.data.duration;
                calculateEditEndTime();
              }
            );
          }
          editApptServiceDropdown.setOptions(options);
        }
      } catch (e) { console.error('Error loading services', e); }
    }

    /* =========================================================
       HISTORIAL DE CITAS - SELECCIONAR PARA REPETIR SERVICIO
       ========================================================= */

    const historyPanel = document.getElementById('client-history-panel');
    const historyHeader = document.getElementById('toggle-history');
    const historyContent = document.getElementById('history-content');
    const historyList = document.getElementById('history-list');
    const historyCount = document.getElementById('history-count');
    const historyHint = document.getElementById('history-hint');

    // Toggle expandir/contraer historial
    if (historyHeader) {
      historyHeader.addEventListener('click', () => {
        const isExpanded = historyContent.style.display !== 'none';
        historyContent.style.display = isExpanded ? 'none' : 'block';
        historyHeader.classList.toggle('expanded', !isExpanded);
      });
    }

    // Cargar historial de citas del cliente
    async function loadClientHistory(clientPhone, clientName) {
      if (!clientPhone && !clientName) {
        historyPanel.classList.add('hidden');
        return;
      }

      try {
        const searchParam = clientPhone || clientName;
        const res = await fetch(`/api/appointments/client?search=${encodeURIComponent(searchParam)}`);
        const json = await res.json();

        if (json.success && json.data && json.data.length > 0) {
          const appointments = json.data;
          historyPanel.classList.remove('hidden');
          historyCount.textContent = `(${appointments.length})`;
          historyHint.textContent = 'Clic para repetir servicio';
          renderHistoryList(appointments);

          if (appointments.length <= 5) {
            historyContent.style.display = 'block';
            historyHeader.classList.add('expanded');
          }
        } else {
          historyPanel.classList.remove('hidden');
          historyCount.textContent = '(0)';
          historyHint.textContent = '¡Primera visita!';
          historyList.innerHTML = '<div class="history-empty">🎉 Nueva clienta</div>';
          historyContent.style.display = 'block';
          historyHeader.classList.add('expanded');
        }
      } catch (error) {
        console.error('Error cargando historial:', error);
        historyPanel.classList.add('hidden');
      }
    }

    function renderHistoryList(appointments) {
      if (appointments.length === 0) {
        historyList.innerHTML = '<div class="history-empty">Sin citas previas</div>';
        return;
      }

      // Ordenar por fecha más reciente y tomar las últimas 8
      appointments.sort((a, b) => new Date(b.startDateTime) - new Date(a.startDateTime));
      const recentAppts = appointments.slice(0, 8);

      const statusLabels = {
        'completed': '✅',
        'scheduled': '📅',
        'confirmed': '✔️',
        'cancelled': '❌'
      };

      historyList.innerHTML = recentAppts.map(appt => {
        const date = new Date(appt.startDateTime);
        const dateStr = date.toLocaleDateString('es-MX', {
          day: 'numeric',
          month: 'short',
          year: date.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
        });
        const statusIcon = statusLabels[appt.status] || '📋';

        return `
          <div class="history-item" 
               data-service-name="${appt.serviceName}"
               data-service-id="${appt.serviceId || ''}" 
               onclick="selectHistoryService(this)">
            <div class="history-item-info">
              <span class="history-item-date">${statusIcon} ${dateStr}</span>
              <span class="history-item-service">${appt.serviceName}</span>
            </div>
            <span class="history-item-select">Seleccionar →</span>
          </div>
        `;
      }).join('');
    }

    function selectHistoryService(element) {
      const serviceName = element.dataset.serviceName;
      const serviceId = element.dataset.serviceId;
      const service = allServices.find(s => s.name === serviceName || s.id === serviceId);

      const serviceInput = document.getElementById('new-appt-service');
      if (serviceInput) {
        serviceInput.value = serviceName;
        serviceInput.dispatchEvent(new Event('input', { bubbles: true }));
        serviceInput.dispatchEvent(new Event('change', { bubbles: true }));
      }

      const priceInput = document.getElementById('new-appt-price');
      if (priceInput && service) {
        priceInput.value = service.price;
      }

      document.querySelectorAll('.history-item').forEach(item => item.classList.remove('selected'));
      element.classList.add('selected');

      calculateEndTime();
    }

    window.selectHistoryService = selectHistoryService;

    // ========== CARGAR CLIENTES ==========
    async function loadClients() {
      try {
        console.log('[CLIENTS] 🔍 Cargando clientes...');
        const res = await fetch('/api/admin/cards?limit=1000');
        const data = await res.json();

        console.log('[CLIENTS] 📦 Respuesta:', data);

        // La respuesta viene directa como objeto de paginación, no tiene success: true
        if (data.items && Array.isArray(data.items)) {
          // Map clients to dropdown options format
          const options = data.items.map(c => ({
            value: c.name,
            label: c.name,
            meta: c.phone || 'Sin teléfono',
            data: { id: c.id, phone: c.phone }
          }));

          console.log('[CLIENTS] 📋 Opciones mapeadas:', options.length);

          // Verificar que los elementos existen
          const inputEl = document.getElementById('new-appt-client-select');
          const dropdownEl = document.getElementById('clients-dropdown-list');

          console.log('[CLIENTS] 🔍 Input existe:', !!inputEl);
          console.log('[CLIENTS] 🔍 Dropdown existe:', !!dropdownEl);

          if (!inputEl || !dropdownEl) {
            console.error('[CLIENTS] ❌ Elementos no encontrados en el DOM');
            return;
          }

          if (!newApptClientDropdown) {
            console.log('[CLIENTS] 🆕 Creando nuevo dropdown...');
            newApptClientDropdown = new CustomSearchableDropdown(
              'new-appt-client-select',
              'clients-dropdown-list',
              (item) => {
                console.log('[CLIENTS] ✅ Cliente seleccionado:', item);
                // Auto-fill phone when client selected
                document.getElementById('new-appt-phone').value = item.data.phone || '';

                // Cargar historial de citas del cliente
                loadClientHistory(item.data.phone, item.label);
              }
            );
          }

          if (newApptClientDropdown) {
            newApptClientDropdown.setOptions(options);
            console.log('[CLIENTS] ✅ Opciones configuradas');
          } else {
            console.error('[CLIENTS] ❌ Dropdown no se pudo crear');
          }
        }
      } catch (e) {
        console.error('[CLIENTS] ❌ Error loading clients:', e);
      }
    }

    // ========== CALENDARIO SEMANAL ==========
    function renderWeeklyCalendar() {
      if (!weeklyCalendar) return;

      weeklyCalendar.innerHTML = '';
      const days = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Ajustar al inicio de la semana (domingo)
      const weekStart = new Date(currentWeekStart);
      weekStart.setDate(weekStart.getDate() - weekStart.getDay());

      for (let i = 0; i < 7; i++) {
        const day = new Date(weekStart);
        day.setDate(day.getDate() + i);
        day.setHours(0, 0, 0, 0);

        const isToday = toLocalDateString(day) === toLocalDateString(today);
        const isSelected = toLocalDateString(day) === toLocalDateString(selectedDate);
        const dayDateStr = toLocalDateString(day);

        const dayCard = document.createElement('div');
        dayCard.className = 'day-card';
        if (isToday) dayCard.classList.add('today');
        if (isSelected) dayCard.classList.add('selected');

        dayCard.innerHTML = `
      <div class="day-name">${days[i]}</div>
      <div class="day-number">${day.getDate()}</div>
      <div class="day-count" id="day-count-${dayDateStr}">-</div>
    `;

        dayCard.addEventListener('click', () => {
          selectedDate = new Date(day.getFullYear(), day.getMonth(), day.getDate());
          renderWeeklyCalendar();
          loadAppointments();
          updateSelectedDateLabel();
        });

        weeklyCalendar.appendChild(dayCard);
      }

      // Cargar conteo de citas para cada día
      loadWeekAppointmentCounts(weekStart);
    }

    async function loadWeekAppointmentCounts(weekStart) {
      console.log('📅 Cargar conteos semana:', weekStart);
      for (let i = 0; i < 7; i++) {
        const day = new Date(weekStart);
        day.setDate(day.getDate() + i);
        const dateStr = toLocalDateString(day);

        try {
          const res = await fetch(`/api/appointments?date=${dateStr}`);
          const json = await res.json();
          console.log(`   🗓️ Día ${dateStr}: ${json.data?.length} citas`);

          const countEl = document.getElementById(`day-count-${dateStr}`);
          if (countEl && json.success) {
            const count = json.data.length;
            countEl.textContent = count > 0 ? `${count} cita${count > 1 ? 's' : ''}` : 'Sin citas';
          }
        } catch (e) {
          console.error('Error loading day count', e);
        }
      }
    }

    function updateSelectedDateLabel() {
      if (!selectedDateLabel) return;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const selected = new Date(selectedDate);
      selected.setHours(0, 0, 0, 0);

      if (selected.getTime() === today.getTime()) {
        selectedDateLabel.textContent = 'Hoy';
      } else {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        selectedDateLabel.textContent = selected.toLocaleDateString('es-MX', options);
      }
    }

    // ========== CARGAR CITAS ==========
    async function loadAppointments() {
      if (!apptsTbody) return;
      apptsTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;">Cargando...</td></tr>';

      const dateStr = toLocalDateString(selectedDate);
      console.log(`📋 Cargar lista citas para: ${dateStr}`);

      try {
        const res = await fetch(`/api/appointments?date=${dateStr}`);
        const json = await res.json();
        console.log(`   📦 Recibidas ${json.data?.length} citas para lista`);

        if (json.success) {
          if (json.data.length === 0) {
            apptsTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;" class="muted">No hay citas para este día</td></tr>';
            return;
          }

          apptsTbody.innerHTML = json.data.map(appt => {
            const time = new Date(appt.startDateTime).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', hour12: false });
            const statusColors = {
              'scheduled': '#3b82f6',      // Azul
              'confirmed': '#22c55e',      // Verde
              'rescheduling': '#fbbf24',   // Amarillo
              'completed': 'var(--venus-soft)', // Verde Venus
              'cancelled': '#ef4444',       // Rojo
              'no_show': '#6b7280'         // Gris
            };
            const statusOptions = {
              'scheduled': 'Agendada',
              'confirmed': 'Confirmada',
              'completed': 'Completada',
              'cancelled': 'Cancelada',
              'no_show': 'No asistió'
            };

            const statusBg = statusColors[appt.status] || '#6b7280';

            return `
              <tr>
                <td style="padding:12px;font-weight:bold;color:#e5e7eb;">${time}</td>
                <td style="padding:12px;">
                  <div style="font-weight:600;color:#f3f4f6;">${appt.clientName}</div>
                  <div style="font-size:0.85em;color:#9ca3af;">${appt.clientPhone}</div>
                </td>
                <td style="padding:12px;color:#d1d5db;">${appt.serviceName}</td>
                <td style="padding:12px;">
                  <select 
                    onchange="updateAppointmentStatus('${appt.id}', this.value)"
                    style="
                      background-color: ${statusBg};
                      color: white;
                      border: none;
                      padding: 4px 8px;
                      border-radius: 12px;
                      font-size: 0.85em;
                      font-weight: 500;
                      cursor: pointer;
                      appearance: none;
                      -webkit-appearance: none;
                      text-align: center;
                      width: 100px;
                    "
                  >
                    ${Object.entries(statusOptions).map(([key, label]) => `
                      <option value="${key}" ${appt.status === key ? 'selected' : ''} style="background-color:#1f2937;color:white;">
                        ${label}
                      </option>
                    `).join('')}
                  </select>
                </td>
                <td style="padding:12px;">
                  <div style="display:flex;gap:8px;">
                    ${appt.status !== 'completed' ? `
                    <button onclick="openPaymentModal('${appt.id}', '${appt.clientName.replace(/'/g, "\\'") || ''}', '${appt.serviceName.replace(/'/g, "\\'") || ''}', ${appt.price || 0})" class="btn-icon" style="background:#10b981;color:white;padding:4px 10px;border-radius:6px;font-size:0.85em;display:flex;align-items:center;gap:4px;">
                      <i class="fas fa-money-bill-wave"></i> Pagar
                    </button>
                    ` : ''}
                    <button onclick="editAppointment('${appt.id}')" class="btn-icon" style="background:#6b7280;color:white;padding:4px 10px;border-radius:6px;font-size:0.85em;">Modificar</button>
                    <button onclick="cancelAppointment('${appt.id}')" class="btn-icon" style="background:#6b7280;color:white;padding:4px 10px;border-radius:6px;font-size:0.85em;">Cancelar</button>
                  </div>
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (e) {
        console.error(e);
        apptsTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--err-text);">Error cargando citas</td></tr>';
      }
    }

    // ========== ESTADÍSTICAS DEL MES ==========
    async function loadMonthStats() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      try {
        // Obtener todas las citas del mes
        const res = await fetch('/api/appointments/month?' + new URLSearchParams({
          year: year.toString(),
          month: (month + 1).toString()
        }));

        if (!res.ok) {
          throw new Error('Error cargando estadísticas');
        }

        const json = await res.json();

        if (json.success && json.data) {
          const appointments = json.data;
          const total = appointments.length;
          const completed = appointments.filter(a => a.status === 'completed').length;
          const cancelled = appointments.filter(a => a.status === 'cancelled').length;
          const pending = appointments.filter(a => a.status === 'scheduled').length;

          document.getElementById('stat-total').textContent = total;
          document.getElementById('stat-completed').textContent = completed;
          document.getElementById('stat-cancelled').textContent = cancelled;
          document.getElementById('stat-pending').textContent = pending;
        } else {
          document.getElementById('stat-total').textContent = '0';
          document.getElementById('stat-completed').textContent = '0';
          document.getElementById('stat-cancelled').textContent = '0';
          document.getElementById('stat-pending').textContent = '0';
        }

        // Calculate revenue by payment method
        let cashTotal = 0;
        let cardTotal = 0;
        let transferTotal = 0;

        if (json.success && json.data) {
          json.data.forEach(appt => {
            if (appt.payment && appt.status === 'completed') {
              const amount = appt.payment.amount || 0;
              switch (appt.payment.method) {
                case 'efectivo':
                  cashTotal += amount;
                  break;
                case 'tarjeta':
                  cardTotal += amount;
                  break;
                case 'transferencia':
                  transferTotal += amount;
                  break;
              }
            }
          });
        }

        const total = cashTotal + cardTotal + transferTotal;

        // Update revenue display
        document.getElementById('revenue-cash').textContent = `$${cashTotal.toFixed(2)}`;
        document.getElementById('revenue-card').textContent = `$${cardTotal.toFixed(2)}`;
        document.getElementById('revenue-transfer').textContent = `$${transferTotal.toFixed(2)}`;
        document.getElementById('revenue-total').textContent = `$${total.toFixed(2)}`;
      } catch (e) {
        console.error('Error loading month stats', e);
        document.getElementById('stat-total').textContent = '-';
        document.getElementById('stat-completed').textContent = '-';
        document.getElementById('stat-cancelled').textContent = '-';
        document.getElementById('stat-pending').textContent = '-';
      }
    }

    // ========== CANCELAR CITA ==========
    window.cancelAppointment = async (id) => {
      if (!confirm('¿Cancelar esta cita?')) return;
      try {
        await fetch(`/api/appointments/${id}/cancel`, { method: 'PATCH' });
        loadAppointments();
        renderWeeklyCalendar();
        loadMonthStats();
      } catch (e) { alert('Error: ' + e.message); }
    };

    async function updateAppointmentStatus(id, newStatus) {
      if (!confirm(`¿Cambiar estado a "${newStatus}"?`)) {
        loadAppointments(); // Revertir selección visualmente
        return;
      }

      try {
        const res = await fetch(`/api/appointments/${id}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });
        const json = await res.json();

        if (json.success) {
          // Si se canceló, recargar todo para actualizar calendarios y contadores
          if (newStatus === 'cancelled') {
            renderWeeklyCalendar();
          }
          loadAppointments();
        } else {
          alert('Error al actualizar estado: ' + json.error);
          loadAppointments();
        }
      } catch (e) {
        console.error(e);
        alert('Error de conexión');
        loadAppointments();
      }
    }

    // ========== AUTO-REFRESH PARA CITAS (detecta cambios de WhatsApp) ==========
    let appointmentsRefreshInterval = null;

    function startAppointmentsAutoRefresh() {
      // Refrescar cada 30 segundos cuando está en el tab de appointments
      if (appointmentsRefreshInterval) {
        clearInterval(appointmentsRefreshInterval);
      }

      appointmentsRefreshInterval = setInterval(() => {
        const appointmentsTab = document.getElementById('tab-appointments');
        if (appointmentsTab && !appointmentsTab.classList.contains('hidden')) {
          console.log('🔄 Auto-refresh: actualizando citas...');
          loadAppointments();
          renderWeeklyCalendar();
          loadMonthStats();
        }
      }, 15000); // 15 segundos para detectar cambios de WhatsApp más rápido
    }

    function stopAppointmentsAutoRefresh() {
      if (appointmentsRefreshInterval) {
        clearInterval(appointmentsRefreshInterval);
        appointmentsRefreshInterval = null;
      }
    }

    // Iniciar auto-refresh cuando se carga la página si está en appointments
    document.addEventListener('DOMContentLoaded', () => {
      const appointmentsTab = document.getElementById('tab-appointments');
      if (appointmentsTab && !appointmentsTab.classList.contains('hidden')) {
        startAppointmentsAutoRefresh();
      }
    });

    // ========== REGISTRAR PAGO ==========
    window.openPaymentDialog = async (apptId) => {
      try {
        const res = await fetch(`/api/appointments/${apptId}`);
        const json = await res.json();

        if (!json.success) {
          alert('Error cargando datos de la cita');
          return;
        }

        const appt = json.data;

        // Buscar precio del servicio si no viene en la cita
        let price = appt.price || 0;
        console.log('Initial price from appt:', price);
        console.log('Service Name:', appt.serviceName);

        if (!price && appt.serviceName) {
          // Asegurar que los servicios estén cargados
          if (typeof allServices === 'undefined' || allServices.length === 0) {
            console.log('allServices empty, loading...');
            if (typeof loadServices === 'function') await loadServices();
          }
          if (typeof allServices !== 'undefined') {
            console.log('Searching service in allServices:', allServices);
            const service = allServices.find(s => s.name === appt.serviceName);
            if (service) {
              console.log('Service found:', service);
              price = service.price;
            } else {
              console.log('Service NOT found in allServices');
            }
          }
        }
        console.log('Final price:', price);

        openPaymentModal(apptId, appt.clientName, appt.serviceName, price);
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };



    // ========== MODIFICAR CITA ==========
    const editApptDialog = document.getElementById('editApptDialog');
    const formEditAppt = document.getElementById('form-edit-appt');
    const btnCancelEditAppt = document.getElementById('btn-cancel-edit-appt');
    const editApptId = document.getElementById('edit-appt-id');
    const editClientName = document.getElementById('edit-appt-client-name');
    const editServiceInput = document.getElementById('edit-appt-service');
    const editPriceInput = document.getElementById('edit-appt-price');
    const editDurationInput = document.getElementById('edit-appt-duration');
    const editDateInput = document.getElementById('edit-appt-date');
    const editHourSelect = document.getElementById('edit-appt-hour');
    const editMinuteSelect = document.getElementById('edit-appt-minute');
    const editEndTimeInput = document.getElementById('edit-appt-end-time');

    window.editAppointment = async (id) => {
      try {
        // Fetch appointment data
        const res = await fetch(`/api/appointments/${id}`);
        const json = await res.json();

        if (!json.success) {
          alert('Error cargando cita');
          return;
        }

        const appt = json.data;

        // Load services and generate hour/minute options
        await loadServices();
        generateHourMinuteOptionsForEdit();

        // Populate edit form with frozen client name
        editApptId.value = id;
        editClientName.value = appt.clientName;
        editServiceInput.value = appt.serviceName;

        // Find service to get price and duration
        const service = allServices.find(s => s.name === appt.serviceName);
        if (service) {
          editPriceInput.value = service.price;
          editDurationInput.value = service.durationMinutes;
        }

        // Extract date and time from startDateTime
        const startDate = new Date(appt.startDateTime);
        const isoDate = appt.startDateTime.split('T')[0];
        editDateInput.value = isoDate;

        // Initialize calendar with existing date
        editApptCalendar.selectedDate = isoDate;
        const date = new Date(isoDate + 'T12:00:00');
        const day = date.getDate();
        const month = date.getMonth() + 1;
        const year = date.getFullYear();
        editDateInput.value = `${day}/${month}/${year}`;
        editDateInput.dataset.isoDate = isoDate;

        editHourSelect.value = String(startDate.getHours()).padStart(2, '0');
        editMinuteSelect.value = String(startDate.getMinutes()).padStart(2, '0');

        // Calculate end time
        calculateEditEndTime();

        // Show modal
        editApptDialog.showModal();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    function generateHourMinuteOptionsForEdit() {
      // Hours
      editHourSelect.innerHTML = '<option value="">--</option>';
      for (let h = 8; h <= 20; h++) {
        const val = String(h).padStart(2, '0');
        editHourSelect.innerHTML += `<option value="${val}">${h}:00</option>`;
      }

      // Minutes
      editMinuteSelect.innerHTML = '<option value="">--</option>';
      ['00', '15', '30', '45'].forEach(m => {
        editMinuteSelect.innerHTML += `<option value="${m}">${m}</option>`;
      });
    }

    function calculateEditEndTime() {
      if (!editHourSelect || !editMinuteSelect || !editEndTimeInput) return;

      const hour = editHourSelect.value;
      const minute = editMinuteSelect.value;
      const serviceName = editServiceInput.value.trim();
      const service = allServices.find(s => s.name === serviceName);

      if (!hour || !minute || !service) return;

      const duration = parseInt(service.durationMinutes) || 60;
      const startDate = new Date();
      startDate.setHours(parseInt(hour), parseInt(minute), 0);
      const endDate = new Date(startDate.getTime() + duration * 60000);

      const endHours = endDate.getHours();
      const endMinutes = endDate.getMinutes();
      const displayHour = endHours > 12 ? endHours - 12 : (endHours === 0 ? 12 : endHours);
      const period = endHours >= 12 ? 'PM' : 'AM';

      editEndTimeInput.value = `${displayHour}:${String(endMinutes).padStart(2, '0')} ${period}`;
    }

    // Event listeners for edit modal
    if (btnCancelEditAppt) {
      btnCancelEditAppt.addEventListener('click', () => editApptDialog.close());
    }

    if (editServiceInput) {
      editServiceInput.addEventListener('input', function () {
        const serviceName = this.value.trim();
        const service = allServices.find(s => s.name === serviceName);
        if (service) {
          editPriceInput.value = service.price;
          editDurationInput.value = service.durationMinutes;
          calculateEditEndTime();
        }
      });
    }

    if (editHourSelect) {
      editHourSelect.addEventListener('change', calculateEditEndTime);
    }

    if (editMinuteSelect) {
      editMinuteSelect.addEventListener('change', calculateEditEndTime);
    }

    if (formEditAppt) {
      formEditAppt.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = formEditAppt.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Guardando...';

        try {
          const hour = editHourSelect.value;
          const minute = editMinuteSelect.value;

          if (!hour || !minute) {
            alert('Por favor selecciona hora y minutos');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          const time = `${hour}:${minute}`;
          const serviceName = editServiceInput.value.trim();
          const service = allServices.find(s => s.name === serviceName);

          if (!service) {
            alert('Por favor selecciona un servicio válido');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          const body = {
            serviceId: service.id,
            serviceName: service.name,
            date: editApptCalendar.getISODate() || editDateInput.value,
            time: time,
            durationMinutes: parseInt(service.durationMinutes)
          };

          const res = await fetch(`/api/appointments/${editApptId.value}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });

          const json = await res.json();
          if (json.success) {
            alert('✅ Cita actualizada');
            editApptDialog.close();
            formEditAppt.reset();
            loadAppointments();
            renderWeeklyCalendar();
            loadMonthStats();
          } else {
            alert('❌ Error: ' + json.error);
          }
        } catch (e) {
          alert('Error de conexión');
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });
    }


    // ========== CUSTOM CALENDAR PICKER ==========
    /* =========================================================
       CUSTOM SEARCHABLE DROPDOWN CLASS
       ========================================================= */
    class CustomSearchableDropdown {
      constructor(inputId, dropdownId, onSelectCallback) {
        this.input = document.getElementById(inputId);
        this.dropdown = document.getElementById(dropdownId);

        if (!this.input || !this.dropdown) {
          console.error(`CustomSearchableDropdown: Elements not found - input: ${inputId}, dropdown: ${dropdownId}`);
          return;
        }

        this.wrapper = this.input.closest('.custom-select-wrapper');
        this.icon = this.wrapper ? this.wrapper.querySelector('.dropdown-toggle-icon') : null;

        if (!this.icon) {
          console.error(`CustomSearchableDropdown: Icon not found for ${inputId}`);
          return;
        }

        this.options = [];
        this.onSelectCallback = onSelectCallback;

        this.init();
      }

      init() {
        // Toggle on icon click
        this.icon.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggle();
        });

        // Open on input click
        this.input.addEventListener('click', (e) => {
          e.stopPropagation();
          console.log('[DROPDOWN] Input clicked, showing dropdown');
          this.show();
        });

        // Filter on input type
        this.input.addEventListener('input', () => {
          const query = this.input.value;
          console.log('[DROPDOWN] Input changed:', query);
          if (query.length === 0) {
            // Si está vacío, mostrar todas las opciones
            this.render(this.options);
            this.show();
          } else {
            // Si hay texto, filtrar
            this.filter(query);
            this.show();
          }
        });

        // Close on outside click
        document.addEventListener('click', (e) => {
          if (!this.wrapper.contains(e.target)) {
            this.hide();
          }
        });
      }

      setOptions(options) {
        this.options = options;
        this.render(options);
      }

      render(items) {
        console.log('[DROPDOWN] Renderizando', items.length, 'items');
        this.dropdown.innerHTML = '';
        if (items.length === 0) {
          this.dropdown.innerHTML = '<div class="dropdown-item" style="cursor:default;color:var(--muted);">No hay resultados</div>';
          return;
        }

        items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'dropdown-item';
          div.innerHTML = `
            <div>${item.label}</div>
            ${item.meta ? `<span class="item-meta">${item.meta}</span>` : ''}
          `;

          // Store data attributes
          Object.keys(item.data || {}).forEach(key => {
            div.dataset[key] = item.data[key];
          });

          div.addEventListener('click', (e) => {
            e.stopPropagation();
            this.select(item);
          });

          this.dropdown.appendChild(div);
        });
      }

      filter(query) {
        const lowerQuery = query.toLowerCase();
        const filtered = this.options.filter(item =>
          item.label.toLowerCase().includes(lowerQuery) ||
          (item.meta && item.meta.toLowerCase().includes(lowerQuery))
        );
        this.render(filtered);
      }

      show() {
        console.log('[DROPDOWN] Mostrando dropdown con', this.options.length, 'opciones');
        // If empty input, show all
        if (!this.input.value) {
          this.render(this.options);
        }
        this.dropdown.style.display = 'block';
        this.icon.textContent = '▲';
      }

      hide() {
        this.dropdown.style.display = 'none';
        this.icon.textContent = '▼';
      }

      toggle() {
        if (this.dropdown.style.display === 'block') {
          this.hide();
        } else {
          this.show();
        }
      }

      select(item) {
        this.input.value = item.value; // Use value for input

        // Trigger callback if provided
        if (this.onSelectCallback) {
          this.onSelectCallback(item);
        }

        // Trigger native change event for other listeners
        this.input.dispatchEvent(new Event('change', { bubbles: true }));
        this.input.dispatchEvent(new Event('input', { bubbles: true }));

        // Close dropdown AFTER all callbacks
        this.hide();
      }
    }

    // Global instances (Moved to top)
    // Payment dialog variables (Moved to top)

    /* =========================================================
       CUSTOM CALENDAR CLASS
       ========================================================= */
    class CustomCalendar {
      constructor(inputId, calendarId) {
        this.input = document.getElementById(inputId);
        this.calendar = document.getElementById(calendarId);
        this.currentDate = new Date();
        this.selectedDate = null;

        if (!this.input || !this.calendar) return;

        this.input.addEventListener('click', (e) => {
          e.stopPropagation();
          this.show();
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
          if (!this.calendar.contains(e.target) && e.target !== this.input) {
            this.hide();
          }
        });
      }

      show() {
        this.render();
        this.calendar.style.display = 'block';
      }

      hide() {
        this.calendar.style.display = 'none';
      }

      render() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const dayNames = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];

        // First day of month and total days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        let html = `
          <div class="calendar-header">
            <button class="calendar-nav-btn" data-action="prev"><i class="fas fa-chevron-left"></i></button>
            <div class="calendar-month-year">${monthNames[month]} ${year}</div>
            <button class="calendar-nav-btn" data-action="next"><i class="fas fa-chevron-right"></i></button>
          </div>
          <div class="calendar-grid">
        `;

        // Day headers
        dayNames.forEach(day => {
          html += `<div class="calendar-day-header">${day}</div>`;
        });

        // Empty cells before first day
        for (let i = 0; i < firstDay; i++) {
          html += `<div class="calendar-day empty"></div>`;
        }

        // Days of month
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          // Usar formato local YYYY-MM-DD para evitar problemas de timezone
          const y = date.getFullYear();
          const m = String(date.getMonth() + 1).padStart(2, '0');
          const d = String(date.getDate()).padStart(2, '0');
          const dateStr = `${y}-${m}-${d}`;
          const isToday = date.toDateString() === today.toDateString();
          const isSelected = this.selectedDate && dateStr === this.selectedDate;

          let classes = ['calendar-day'];
          if (isToday) classes.push('today');
          if (isSelected) classes.push('selected');

          html += `<div class="${classes.join(' ')}" data-date="${dateStr}">${day}</div>`;
        }

        html += `</div>`;
        this.calendar.innerHTML = html;

        // Event listeners
        this.calendar.querySelectorAll('[data-action="prev"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.currentDate.setMonth(this.currentDate.getMonth() - 1);
            this.render();
          });
        });

        this.calendar.querySelectorAll('[data-action="next"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.currentDate.setMonth(this.currentDate.getMonth() + 1);
            this.render();
          });
        });

        this.calendar.querySelectorAll('.calendar-day:not(.empty)').forEach(dayEl => {
          dayEl.addEventListener('click', (e) => {
            e.stopPropagation();
            const dateStr = dayEl.dataset.date;
            this.selectDate(dateStr);
          });
        });
      }

      selectDate(dateStr) {
        this.selectedDate = dateStr;
        const date = new Date(dateStr + 'T12:00:00');
        const day = date.getDate();
        const month = date.getMonth() + 1;
        const year = date.getFullYear();
        this.input.value = `${day}/${month}/${year}`;
        this.input.dataset.isoDate = dateStr;
        this.hide();
      }

      getISODate() {
        return this.input.dataset.isoDate || '';
      }
    }

    // Initialize calendars
    const newApptCalendar = new CustomCalendar('new-appt-date', 'new-appt-calendar');
    const editApptCalendar = new CustomCalendar('edit-appt-date', 'edit-appt-calendar');

    // ========== EVENT LISTENERS ==========

    // Navegación semanal
    if (btnPrevWeek) {
      btnPrevWeek.addEventListener('click', () => {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        renderWeeklyCalendar();
      });
    }

    if (btnNextWeek) {
      btnNextWeek.addEventListener('click', () => {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        renderWeeklyCalendar();
      });
    }

    if (btnToday) {
      btnToday.addEventListener('click', () => {
        currentWeekStart = new Date();
        currentWeekStart.setHours(0, 0, 0, 0);
        selectedDate = new Date();
        selectedDate.setHours(0, 0, 0, 0);
        renderWeeklyCalendar();
        loadAppointments();
        updateSelectedDateLabel();
      });
    }

    if (btnRefreshAppts) {
      btnRefreshAppts.addEventListener('click', () => {
        loadAppointments();
        renderWeeklyCalendar();
      });
    }

    // Modal
    if (btnNewAppt) {
      btnNewAppt.addEventListener('click', () => {
        loadServices();
        loadClients();
        generateHourMinuteOptions();
        newApptDialog.showModal();
        document.getElementById('new-appt-date').value = toLocalDateString(selectedDate);

        // Limpiar historial
        if (historyPanel) historyPanel.classList.add('hidden');
        if (historyContent) historyContent.style.display = 'none';
        if (historyHeader) historyHeader.classList.remove('expanded');
      });
    }

    if (btnCancelAppt) {
      btnCancelAppt.addEventListener('click', () => newApptDialog.close());
    }

    // Cliente input - auto-llenar teléfono cuando se selecciona
    if (clientSelect) {
      clientSelect.addEventListener('input', function () {
        const clientName = this.value.trim();
        const client = allClients.find(c => c.name === clientName);
        if (client && phoneInput) {
          phoneInput.value = client.phone || '';
          phoneInput.readOnly = true;
        } else {
          if (!phoneInput.value || phoneInput.readOnly) {
            phoneInput.value = '';
          }
          phoneInput.readOnly = false;
        }
      });
    }

    // Servicio input - auto-llenar precio y calcular hora fin
    if (serviceSelect) {
      serviceSelect.addEventListener('input', function () {
        const serviceName = this.value.trim();
        const service = allServices.find(s => s.name === serviceName);
        if (service && priceInput) {
          priceInput.value = service.price;
          calculateEndTime();
        }
      });
    }

    // Hora select - calcular hora fin
    if (hourSelect) {
      hourSelect.addEventListener('change', calculateEndTime);
    }

    // Minuto select - calcular hora fin
    if (minuteSelect) {
      minuteSelect.addEventListener('change', calculateEndTime);
    }

    function calculateEndTime() {
      if (!hourSelect || !minuteSelect || !endTimeInput) return;

      const hour = hourSelect.value;
      const minute = minuteSelect.value;
      const serviceName = serviceSelect ? serviceSelect.value.trim() : '';
      const service = allServices.find(s => s.name === serviceName);

      if (!hour || !minute || !service) return;

      const duration = parseInt(service.durationMinutes) || 60;

      const startDate = new Date();
      startDate.setHours(parseInt(hour), parseInt(minute), 0);

      const endDate = new Date(startDate.getTime() + duration * 60000);

      const endHours = endDate.getHours();
      const endMinutes = endDate.getMinutes();
      const displayHour = endHours > 12 ? endHours - 12 : (endHours === 0 ? 12 : endHours);
      const period = endHours >= 12 ? 'PM' : 'AM';

      endTimeInput.value = `${displayHour}:${String(endMinutes).padStart(2, '0')} ${period}`;
    }


    // Toggle nuevo cliente form
    if (btnToggleNewClient) {
      btnToggleNewClient.addEventListener('click', () => {
        const isHidden = newClientForm.style.display === 'none';
        newClientForm.style.display = isHidden ? 'block' : 'none';
        btnToggleNewClient.textContent = isHidden ? '- Cancelar' : '+ Registrar nuevo cliente';
      });
    }

    // Guardar nuevo cliente
    if (btnSaveNewClient) {
      btnSaveNewClient.addEventListener('click', async () => {
        const name = document.getElementById('new-client-name').value.trim();
        const phone = document.getElementById('new-client-phone').value.trim();

        if (!name || !phone) {
          alert('Por favor completa nombre y teléfono');
          return;
        }

        try {
          const res = await fetch('/api/clients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, phone })
          });

          const json = await res.json();
          if (json.success) {
            alert('✅ Cliente guardado');
            await loadClients();

            // Seleccionar el nuevo cliente
            const newClientId = json.client.id;
            clientSelect.value = newClientId;
            phoneInput.value = phone;
            phoneInput.readOnly = true;

            // Ocultar form
            newClientForm.style.display = 'none';
            btnToggleNewClient.textContent = '+ Registrar nuevo cliente';

            // Limpiar campos
            document.getElementById('new-client-name').value = '';
            document.getElementById('new-client-phone').value = '';
          } else {
            alert('❌ Error: ' + json.error);
          }
        } catch (e) {
          alert('Error de conexión');
        }
      });
    }

    // Submit form
    if (formNewAppt) {
      formNewAppt.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = formNewAppt.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Agendando...';

        try {
          // Construir hora desde los selectores separados
          const hour = hourSelect.value;
          const minute = minuteSelect.value;

          if (!hour || !minute) {
            alert('Por favor selecciona hora y minutos');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          const time = `${hour}:${minute}`;

          // Buscar servicio en allServices
          const serviceName = serviceSelect.value.trim();
          const service = allServices.find(s => s.name === serviceName);

          if (!service) {
            alert('Por favor selecciona un servicio válido');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          const isoDate = newApptCalendar.getISODate();
          if (!isoDate) {
            alert('Por favor selecciona una fecha del calendario');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
          }

          const payload = {
            name: clientSelect.value.trim(),
            phone: phoneInput.value.trim(),
            serviceId: service.id,
            serviceName: serviceSelect.value.trim(),
            date: isoDate,
            time: time,
            durationMinutes: parseInt(service.durationMinutes),
            sendWhatsAppConfirmation: document.getElementById('check-whatsapp-confirm').checked,
            sendWhatsApp24h: document.getElementById('check-whatsapp-24h').checked,
            sendWhatsApp2h: document.getElementById('check-whatsapp-2h').checked
          };

          const res = await fetch('/api/appointments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const json = await res.json();
          if (json.success) {
            alert('✅ Cita agendada');
            newApptDialog.close();
            formNewAppt.reset();
            loadAppointments();
            renderWeeklyCalendar();
          } else {
            alert('❌ Error: ' + json.error);
          }
        } catch (e) {
          alert('Error de conexión');
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });
    }

    // Inicializar
    renderWeeklyCalendar();
    updateSelectedDateLabel();
    loadMonthStats();

    // Auto-load when tab is shown
    window.addEventListener('hashchange', () => {
      if (location.hash === '#appointments') {
        renderWeeklyCalendar();
        loadAppointments();
        updateSelectedDateLabel();
        loadMonthStats();
      }
    });

    if (location.hash === '#appointments') {
      renderWeeklyCalendar();
      loadAppointments();
      updateSelectedDateLabel();
      loadMonthStats();
    }

    // ========== GESTIÓN DE SERVICIOS ==========
    const servicesTbody = document.getElementById('services-tbody');
    const modalService = document.getElementById('modal-service');
    const formService = document.getElementById('form-service');
    const btnNewService = document.getElementById('btn-new-service');
    const closeModalService = document.getElementById('close-modal-service');
    const btnCancelService = document.getElementById('cancel-service');

    async function loadServicesTable() {
      try {
        servicesTbody.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center;padding:20px;">Cargando...</td></tr>';
        const res = await fetch('/api/services');
        const json = await res.json();

        if (json.success) {
          const services = json.data;
          if (services.length === 0) {
            servicesTbody.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center;padding:20px;">No hay servicios registrados</td></tr>';
            return;
          }

          // Store services globally for search
          window.allServicesData = services;
          renderServicesTable(services);
        }
      } catch (error) {
        console.error('Error loading services:', error);
        servicesTbody.innerHTML = '<tr><td colspan="4" style="color:red;text-align:center;">Error al cargar servicios</td></tr>';
      }
    }

    // Función para renderizar la tabla de servicios
    function renderServicesTable(services) {
      if (services.length === 0) {
        servicesTbody.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center;padding:20px;">No se encontraron servicios</td></tr>';
        return;
      }

      servicesTbody.innerHTML = services.map(s => `
        <tr>
          <td data-label="Nombre">${s.name}</td>
          <td data-label="Duración">${s.durationMinutes} min</td>
          <td data-label="Precio">$${s.price}</td>
          <td data-label="Acciones">
            <div class="actions">
              <button class="btn small ghost" onclick="editService('${s.id}')" title="Editar">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn small ghost" style="color:#ef4444;border-color:#ef4444;" onclick="deleteService('${s.id}')" title="Eliminar">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Abrir modal (Nuevo o Editar)
    window.editService = async (id) => {
      try {
        // Buscar servicio en la lista actual (o hacer fetch)
        const res = await fetch('/api/services');
        const json = await res.json();
        const service = json.data.find(s => s.id === id);

        if (service) {
          document.getElementById('service-id').value = service.id;
          document.getElementById('service-name').value = service.name;
          document.getElementById('service-duration').value = service.durationMinutes;
          document.getElementById('service-price').value = service.price;
          document.getElementById('modal-service-title').textContent = 'Editar Servicio';
          modalService.classList.remove('hidden');
        }
      } catch (e) { console.error(e); }
    };

    if (btnNewService) {
      btnNewService.addEventListener('click', () => {
        document.getElementById('form-service').reset();
        document.getElementById('service-id').value = '';
        document.getElementById('modal-service-title').textContent = 'Nuevo Servicio';
        modalService.classList.remove('hidden');
      });
    }

    // Cerrar modal
    const closeServiceModalFn = () => modalService.classList.add('hidden');
    if (closeModalService) closeModalService.addEventListener('click', closeServiceModalFn);
    if (btnCancelService) btnCancelService.addEventListener('click', closeServiceModalFn);

    // Guardar servicio
    if (formService) {
      formService.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('service-id').value;
        const data = {
          name: document.getElementById('service-name').value,
          durationMinutes: parseInt(document.getElementById('service-duration').value),
          price: parseFloat(document.getElementById('service-price').value)
        };

        try {
          const url = id ? `/api/services/${id}` : '/api/services';
          const method = id ? 'PUT' : 'POST';

          const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const json = await res.json();
          if (json.success) {
            closeServiceModalFn();
            loadServicesTable();
            // Recargar dropdowns de citas también
            loadServices();
          } else {
            alert('Error al guardar: ' + json.error);
          }
        } catch (error) {
          console.error(error);
          alert('Error de conexión');
        }
      });
    }

    // Eliminar servicio
    window.deleteService = async (id) => {
      if (!confirm('¿Estás seguro de eliminar este servicio?')) return;

      try {
        const res = await fetch(`/api/services/${id}`, { method: 'DELETE' });
        const json = await res.json();
        if (json.success) {
          loadServicesTable();
          loadServices(); // Recargar dropdowns
        } else {
          alert('Error al eliminar: ' + json.error);
        }
      } catch (error) {
        console.error(error);
        alert('Error de conexión');
      }
    };

    // Búsqueda de servicios
    const searchServicesInput = document.getElementById('search-services');
    if (searchServicesInput) {
      searchServicesInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();

        if (!window.allServicesData) return;

        if (searchTerm === '') {
          renderServicesTable(window.allServicesData);
        } else {
          const filtered = window.allServicesData.filter(s =>
            s.name.toLowerCase().includes(searchTerm)
          );
          renderServicesTable(filtered);
        }
      });
    }

    /* =========================================================
       CATÁLOGO: PRODUCTOS
       ========================================================= */

    // Variables globales para productos
    let allProducts = [];
    let currentProductFilter = 'all';

    // Cambiar entre tabs
    function switchCatalogTab(tab) {
      document.querySelectorAll('.tabs-header .tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));

      if (tab === 'services') {
        document.getElementById('btn-tab-services').classList.add('active');
        document.getElementById('panel-services').classList.add('active');
        loadServicesTable();
      } else {
        document.getElementById('btn-tab-products').classList.add('active');
        document.getElementById('panel-products').classList.add('active');
        loadProductsTable();
      }
    }

    // Hacer función global
    window.switchCatalogTab = switchCatalogTab;

    // Cargar servicios al abrir la pestaña de Catálogo
    document.querySelectorAll('.nav a[data-tab="catalog"], .nav a[data-tab="services"]').forEach(link => {
      link.addEventListener('click', () => {
        // Dar tiempo para que se muestre la pestaña
        setTimeout(() => {
          // Verificar qué sub-tab está activo
          const servicesTabActive = document.getElementById('btn-tab-services')?.classList.contains('active');
          if (servicesTabActive) {
            loadServicesTable();
          }
        }, 100);
      });
    });

    /* ========== PRODUCTOS ========== */

    // Cargar productos
    async function loadProductsTable() {
      const tbody = document.getElementById('products-tbody');
      tbody.innerHTML = '<tr><td colspan="5" class="muted" style="text-align:center;padding:20px;">Cargando...</td></tr>';

      try {
        const res = await fetch('/api/products', { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          allProducts = json.data || [];
          updateProductsCount();
          updateProductStats();
          renderProductsTable(allProducts);
        }
      } catch (error) {
        console.error('Error loading products:', error);
        tbody.innerHTML = '<tr><td colspan="5" style="color:#ef4444;text-align:center;">Error al cargar</td></tr>';
      }
    }

    // Renderizar tabla de productos
    function renderProductsTable(products) {
      const tbody = document.getElementById('products-tbody');

      // Filtrar por categoría
      let filtered = products;
      if (currentProductFilter !== 'all') {
        filtered = products.filter(p => p.category === currentProductFilter);
      }

      // Filtrar por búsqueda
      const searchTerm = document.getElementById('search-products')?.value?.toLowerCase() || '';
      if (searchTerm) {
        filtered = filtered.filter(p =>
          p.name.toLowerCase().includes(searchTerm) ||
          (p.description && p.description.toLowerCase().includes(searchTerm))
        );
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="muted" style="text-align:center;padding:20px;">No hay productos</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(p => {
        const stockClass = p.stock <= 0 ? 'stock-out' : p.stock <= (p.minStock || 5) ? 'stock-low' : 'stock-ok';
        const stockWarning = p.stock <= (p.minStock || 5) && p.stock > 0 ? ' ⚠️' : '';

        return `
          <tr>
            <td>
              <div class="product-cell">
                <div class="product-img"><i class="fas fa-box"></i></div>
                <div>
                  <div style="font-weight:500;">${p.name}</div>
                  ${p.presentation ? `<div class="item-category">${p.presentation}</div>` : ''}
                </div>
              </div>
            </td>
            <td style="text-transform:capitalize;">${p.category}</td>
            <td style="font-weight:600;color:var(--venus-soft);">$${p.price}</td>
            <td><span class="stock ${stockClass}">${p.stock} uds${stockWarning}</span></td>
            <td>
              <div class="actions" style="display:flex;gap:6px;">
                <button class="btn small ghost" onclick="editProduct('${p.id}')">Editar</button>
                <button class="btn small ghost" style="color:#ef4444;" onclick="deleteProduct('${p.id}')">Eliminar</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Actualizar contadores
    function updateProductsCount() {
      document.getElementById('products-count').textContent = allProducts.length;
      document.getElementById('services-count').textContent = window.allServicesData?.length || 0;
    }

    // Actualizar estadísticas
    function updateProductStats() {
      const total = allProducts.length;
      const value = allProducts.reduce((sum, p) => sum + (p.price * p.stock), 0);
      const lowStock = allProducts.filter(p => p.stock <= (p.minStock || 5) && p.stock > 0).length;

      document.getElementById('stat-products-total').textContent = total;
      document.getElementById('stat-products-value').textContent = '$' + value.toLocaleString();
      document.getElementById('stat-products-low').textContent = lowStock;
    }

    // Filtrar por categoría
    function filterProducts(category) {
      currentProductFilter = category;

      document.querySelectorAll('.filter-chips .chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.category === category);
      });

      renderProductsTable(allProducts);
    }
    window.filterProducts = filterProducts;

    // Búsqueda de productos
    document.getElementById('search-products')?.addEventListener('input', () => {
      renderProductsTable(allProducts);
    });

    // Modal de producto
    const modalProduct = document.getElementById('modal-product');
    const formProduct = document.getElementById('form-product');

    document.getElementById('btn-new-product')?.addEventListener('click', () => {
      document.getElementById('form-product').reset();
      document.getElementById('product-id').value = '';
      document.getElementById('modal-product-title').innerHTML = '<i class="fas fa-shopping-bag"></i> Nuevo Producto';
      modalProduct.classList.remove('hidden');
    });

    document.getElementById('close-modal-product')?.addEventListener('click', () => {
      modalProduct.classList.add('hidden');
    });

    document.getElementById('cancel-product')?.addEventListener('click', () => {
      modalProduct.classList.add('hidden');
    });

    // Editar producto
    window.editProduct = async (id) => {
      const product = allProducts.find(p => p.id === id);
      if (!product) return;

      document.getElementById('product-id').value = product.id;
      document.getElementById('product-name').value = product.name;
      document.getElementById('product-category').value = product.category;
      document.getElementById('product-presentation').value = product.presentation || '';
      document.getElementById('product-price').value = product.price;
      document.getElementById('product-cost').value = product.cost || '';
      document.getElementById('product-stock').value = product.stock;
      document.getElementById('product-min-stock').value = product.minStock || 5;
      document.getElementById('product-description').value = product.description || '';
      document.getElementById('modal-product-title').innerHTML = '<i class="fas fa-edit"></i> Editar Producto';

      modalProduct.classList.remove('hidden');
    };

    // Eliminar producto
    window.deleteProduct = async (id) => {
      if (!confirm('¿Eliminar este producto?')) return;

      try {
        const res = await fetch(`/api/products/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        const json = await res.json();

        if (json.success) {
          loadProductsTable();
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        alert('Error de conexión');
      }
    };

    // Guardar producto
    formProduct?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('product-id').value;
      const data = {
        name: document.getElementById('product-name').value,
        category: document.getElementById('product-category').value,
        presentation: document.getElementById('product-presentation').value,
        price: parseFloat(document.getElementById('product-price').value),
        cost: parseFloat(document.getElementById('product-cost').value) || null,
        stock: parseInt(document.getElementById('product-stock').value),
        minStock: parseInt(document.getElementById('product-min-stock').value) || 5,
        description: document.getElementById('product-description').value
      };

      try {
        const url = id ? `/api/products/${id}` : '/api/products';
        const method = id ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });

        const json = await res.json();

        if (json.success) {
          modalProduct.classList.add('hidden');
          loadProductsTable();
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        alert('Error de conexión');
      }
    });

    /* =========================================================
       GIFT CARDS MEJORADO
       ========================================================= */

    let allGiftCards = [];
    let currentGiftCardFilter = 'all';
    let selectedGiftCard = null;

    // Cargar servicios en el dropdown de gift cards
    async function loadGiftCardServices() {
      const select = document.getElementById('gc-service');
      if (!select) return;

      try {
        const res = await fetch('/api/services', { credentials: 'include' });
        const json = await res.json();

        if (json.success && json.data) {
          select.innerHTML = '<option value="">Seleccionar servicio...</option>';
          json.data.forEach(s => {
            select.innerHTML += `<option value="${s.id}" data-name="${s.name}" data-price="${s.price}">${s.name} - $${s.price}</option>`;
          });
        }
      } catch (error) {
        console.error('Error loading services for gift cards:', error);
      }
    }

    // Actualizar preview al seleccionar servicio
    document.getElementById('gc-service')?.addEventListener('change', function () {
      const option = this.options[this.selectedIndex];
      const serviceName = option.dataset?.name || 'Selecciona un servicio';
      document.getElementById('gc-preview-service').textContent = serviceName;
    });

    document.getElementById('gc-validity')?.addEventListener('change', function () {
      document.getElementById('gc-preview-validity').textContent = `Válida por ${this.value} días`;
    });

    // Cargar gift cards
    async function loadGiftCards() {
      const list = document.getElementById('gc-list');
      if (!list) return;

      list.innerHTML = '<div class="gc-empty"><i class="fas fa-spinner fa-spin"></i><p>Cargando...</p></div>';

      try {
        const res = await fetch('/api/giftcards', { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          allGiftCards = json.data || [];
          updateGiftCardStats();
          renderGiftCards();
        }
      } catch (error) {
        console.error('Error loading gift cards:', error);
        list.innerHTML = '<div class="gc-empty" style="color:#ef4444;"><p>Error al cargar</p></div>';
      }
    }

    // Actualizar estadísticas
    function updateGiftCardStats() {
      const now = new Date();

      const pending = allGiftCards.filter(gc => gc.status === 'pending' && new Date(gc.expiresAt) > now);
      const redeemed = allGiftCards.filter(gc => gc.status === 'redeemed');
      const expired = allGiftCards.filter(gc => gc.status === 'expired' || (gc.status === 'pending' && new Date(gc.expiresAt) <= now));

      document.getElementById('gc-stat-total').textContent = allGiftCards.length;
      document.getElementById('gc-stat-pending').textContent = pending.length;
      document.getElementById('gc-stat-redeemed').textContent = redeemed.length;
      document.getElementById('gc-stat-expired').textContent = expired.length;

      document.getElementById('gc-count-all').textContent = allGiftCards.length;
      document.getElementById('gc-count-pending').textContent = pending.length;
      document.getElementById('gc-count-redeemed').textContent = redeemed.length;
      document.getElementById('gc-count-expired').textContent = expired.length;
    }

    // Renderizar lista
    function renderGiftCards() {
      const list = document.getElementById('gc-list');
      const searchTerm = document.getElementById('gc-search')?.value?.toLowerCase() || '';
      const now = new Date();

      let filtered = allGiftCards.map(gc => {
        let status = gc.status;
        if (status === 'pending' && new Date(gc.expiresAt) <= now) {
          status = 'expired';
        }
        return { ...gc, displayStatus: status };
      });

      if (currentGiftCardFilter !== 'all') {
        filtered = filtered.filter(gc => gc.displayStatus === currentGiftCardFilter);
      }

      if (searchTerm) {
        filtered = filtered.filter(gc =>
          (gc.recipientName && gc.recipientName.toLowerCase().includes(searchTerm)) ||
          (gc.serviceName && gc.serviceName.toLowerCase().includes(searchTerm)) ||
          (gc.code && gc.code.toLowerCase().includes(searchTerm))
        );
      }

      filtered.sort((a, b) => {
        const order = { pending: 0, redeemed: 1, expired: 2 };
        if (order[a.displayStatus] !== order[b.displayStatus]) {
          return order[a.displayStatus] - order[b.displayStatus];
        }
        return new Date(b.createdAt) - new Date(a.createdAt);
      });

      if (filtered.length === 0) {
        list.innerHTML = `<div class="gc-empty"><i class="fas fa-gift"></i><p>No hay gift cards</p></div>`;
        return;
      }

      list.innerHTML = filtered.map(gc => {
        const createdDate = new Date(gc.createdAt).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' });
        const expiresDate = new Date(gc.expiresAt).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' });

        const totalDays = gc.validityDays || 30;
        const daysLeft = Math.ceil((new Date(gc.expiresAt) - now) / (1000 * 60 * 60 * 24));
        const percentLeft = Math.max(0, Math.min(100, (daysLeft / totalDays) * 100));

        let progressClass = 'ok';
        if (percentLeft <= 25) progressClass = 'danger';
        else if (percentLeft <= 50) progressClass = 'warning';

        const recipientDisplay = gc.recipientName || 'Sin nombre';

        let statusBadge = '';
        let iconClass = '';
        let iconHtml = '';

        if (gc.displayStatus === 'pending') {
          statusBadge = '<span class="gc-status pending">Pendiente</span>';
          iconClass = 'pending';
          iconHtml = '<i class="fas fa-gift"></i>';
        } else if (gc.displayStatus === 'redeemed') {
          statusBadge = '<span class="gc-status redeemed">Canjeada</span>';
          iconClass = 'redeemed';
          iconHtml = '<i class="fas fa-check"></i>';
        } else {
          statusBadge = '<span class="gc-status expired">Expirada</span>';
          iconClass = 'expired';
          iconHtml = '<i class="fas fa-times"></i>';
        }

        let redeemedInfo = '';
        if (gc.displayStatus === 'redeemed' && gc.redeemedAt) {
          const redeemedDate = new Date(gc.redeemedAt).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' });
          const redeemedBy = gc.redeemedBy || gc.recipientName || 'Cliente';
          redeemedInfo = `<div class="gc-redeemed-info"><i class="fas fa-check-circle"></i> Canjeada el ${redeemedDate} por ${redeemedBy}</div>`;
        }

        let vigenciaHtml = '';
        if (gc.displayStatus === 'pending') {
          const daysText = daysLeft <= 0 ? 'Vencida' : daysLeft === 1 ? 'Queda 1 día' : `Quedan ${daysLeft} días`;
          const warningIcon = daysLeft <= 7 && daysLeft > 0 ? '⚠️ ' : '';
          vigenciaHtml = `
            <div class="gc-vigencia">
              <div class="gc-vigencia-bar">
                <div class="gc-vigencia-progress ${progressClass}" style="width:${percentLeft}%;"></div>
              </div>
              <div class="gc-vigencia-text">${warningIcon}${daysText}</div>
            </div>
          `;
        }

        let actionsHtml = '';
        if (gc.displayStatus === 'pending') {
          actionsHtml = `
            <button class="btn small ghost" onclick="viewGiftCard('${gc.id}')" title="Ver QR"><i class="fas fa-qrcode"></i></button>
            <button class="btn small ghost" onclick="copyGiftCardLinkById('${gc.id}')" title="Copiar link"><i class="fas fa-link"></i></button>
            <button class="btn small ghost" onclick="sendGiftCardWhatsAppById('${gc.id}')" title="WhatsApp"><i class="fab fa-whatsapp"></i></button>
            <button class="btn small ghost" onclick="deleteGiftCard('${gc.id}')" title="Eliminar" style="color:#ef4444;"><i class="fas fa-trash"></i></button>
          `;
        } else if (gc.displayStatus === 'redeemed') {
          actionsHtml = `
            <button class="btn small ghost" onclick="viewGiftCard('${gc.id}')" title="Ver"><i class="fas fa-eye"></i></button>
            <button class="btn small ghost" onclick="deleteGiftCard('${gc.id}')" title="Eliminar" style="color:#ef4444;"><i class="fas fa-trash"></i></button>
          `;
        } else {
          actionsHtml = `
            <button class="btn small ghost" onclick="renewGiftCard('${gc.id}')" title="Renovar" style="color:var(--venus-soft);"><i class="fas fa-sync-alt"></i></button>
            <button class="btn small ghost" onclick="deleteGiftCard('${gc.id}')" title="Eliminar" style="color:#ef4444;"><i class="fas fa-trash"></i></button>
          `;
        }

        return `
          <div class="gc-item ${gc.displayStatus === 'expired' ? 'expired' : ''}">
            <div class="gc-icon ${iconClass}">${iconHtml}</div>
            <div class="gc-info">
              <h4>${recipientDisplay} ${statusBadge}</h4>
              <div class="gc-service">${gc.serviceName} · $${gc.servicePrice}</div>
              <div class="gc-meta">
                <span><i class="fas fa-calendar"></i> ${createdDate}</span>
                ${gc.displayStatus !== 'redeemed' ? `<span><i class="fas fa-hourglass-half"></i> Vence: ${expiresDate}</span>` : ''}
              </div>
              ${vigenciaHtml}
              ${redeemedInfo}
            </div>
            <div class="gc-actions">${actionsHtml}</div>
          </div>
        `;
      }).join('');
    }

    // Tabs
    const gcTabs = document.querySelectorAll('.gc-tab');
    console.log('[GC] Tabs encontrados:', gcTabs.length);
    gcTabs.forEach(tab => {
      tab.addEventListener('click', function () {
        console.log('[GC] Tab clicked:', this.dataset.filter);
        document.querySelectorAll('.gc-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        currentGiftCardFilter = this.dataset.filter;
        renderGiftCards();
      });
    });

    // Búsqueda
    document.getElementById('gc-search')?.addEventListener('input', renderGiftCards);

    // Crear gift card
    const formGiftcard = document.getElementById('form-giftcard');
    console.log('[GC] Formulario encontrado:', !!formGiftcard);

    if (formGiftcard) {
      formGiftcard.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('[GC] Submit del formulario');

        const serviceSelect = document.getElementById('gc-service');
        const serviceOption = serviceSelect.options[serviceSelect.selectedIndex];

        if (!serviceSelect.value) {
          alert('Selecciona un servicio');
          return;
        }

        const data = {
          recipientName: document.getElementById('gc-recipient').value.trim() || null,
          serviceId: serviceSelect.value,
          serviceName: serviceOption.dataset.name,
          servicePrice: parseFloat(serviceOption.dataset.price),
          message: document.getElementById('gc-message').value.trim() || null,
          validityDays: parseInt(document.getElementById('gc-validity').value)
        };

        try {
          const res = await fetch('/api/giftcards', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
          });

          const json = await res.json();
          console.log('[GC] Respuesta:', json);

          if (json.success) {
            document.getElementById('form-giftcard').reset();
            document.getElementById('gc-preview-service').textContent = 'Selecciona un servicio';
            document.getElementById('gc-preview-validity').textContent = 'Válida por 30 días';
            await loadGiftCards();
            viewGiftCard(json.id);
          } else {
            alert('Error: ' + json.error);
          }
        } catch (error) {
          console.error('[GC] Error:', error);
          alert('Error de conexión');
        }
      });
    }

    // Ver gift card
    async function viewGiftCard(id) {
      selectedGiftCard = allGiftCards.find(gc => gc.id === id);
      if (!selectedGiftCard) {
        await loadGiftCards();
        selectedGiftCard = allGiftCards.find(gc => gc.id === id);
        if (!selectedGiftCard) return;
      }

      const content = document.getElementById('modal-giftcard-content');
      const gc = selectedGiftCard;

      const expiresDate = new Date(gc.expiresAt).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' });
      const qrUrl = `${window.location.origin}/giftcard/${gc.code}`;

      content.innerHTML = `
        <div id="gift-card-visual" class="gift-card-visual" style="margin:0;border-radius:12px 12px 0 0;">
          <div class="gift-card-content">
            <img src="/assets/logo.png" alt="Venus" class="gift-brand-logo" style="width:60px;height:60px;margin-bottom:12px;">
            <div style="font-size:18px;color:var(--venus-soft);font-weight:600;">Gift Card Venus</div>
            <div style="font-size:22px;font-weight:700;margin:12px 0;color:#fff;">${gc.serviceName}</div>
            ${gc.recipientName ? `<div style="font-size:12px;color:var(--muted);margin:8px 0;">Para: ${gc.recipientName}</div>` : ''}
            ${gc.message ? `<div style="font-size:13px;font-style:italic;margin:10px 0;opacity:0.9;">"${gc.message}"</div>` : ''}
            <div style="background:white;padding:16px;border-radius:12px;display:inline-block;margin:16px 0;">
              <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrUrl)}" alt="QR" style="display:block;width:150px;height:150px;">
            </div>
            <div style="font-size:11px;color:var(--muted);">Código: ${gc.code}</div>
            <div style="font-size:11px;color:var(--muted);margin-top:4px;">Válida hasta: ${expiresDate}</div>
            <div style="margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);">
              <div style="font-size:11px;color:var(--muted);">📍 Cactus 50, Col. Indeco</div>
              <div style="font-size:11px;color:var(--muted);margin-top:2px;">📱 WhatsApp: 427 165 7595</div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('modal-giftcard-view').classList.remove('hidden');
    }

    function closeGiftCardModal() {
      document.getElementById('modal-giftcard-view').classList.add('hidden');
      selectedGiftCard = null;
    }

    // Descargar imagen de gift card
    async function downloadGiftCardImage() {
      if (!selectedGiftCard) return;
      const element = document.getElementById('gift-card-visual');
      if (!element) return;

      try {
        const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#3f4037', useCORS: true });
        const link = document.createElement('a');
        link.download = `gift-card-venus-${selectedGiftCard.code}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (error) {
        console.error('Error generando imagen:', error);
        alert('Error al generar la imagen');
      }
    }

    // Enviar por WhatsApp con imagen
    async function sendGiftCardWhatsAppImage() {
      if (!selectedGiftCard) return;
      const element = document.getElementById('gift-card-visual');
      if (!element) { sendGiftCardWhatsApp(); return; }

      try {
        const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#3f4037', useCORS: true });
        const gc = selectedGiftCard;
        const url = `${window.location.origin}/giftcard/${gc.code}`;
        const message = `🎁 ¡Te han regalado un servicio en Venus Cosmetología!\n\n✨ ${gc.serviceName}\n${gc.recipientName ? `👤 Para: ${gc.recipientName}\n` : ''}${gc.message ? `💬 "${gc.message}"\n` : ''}\n📍 Cactus 50, Col. Indeco\n📱 WhatsApp: 427 165 7595\n\n🎁 Canjea tu gift card aquí:\n${url}`;

        if (navigator.share && navigator.canShare) {
          const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
          const file = new File([blob], 'gift-card-venus.png', { type: 'image/png' });
          try {
            await navigator.share({ title: 'Gift Card Venus', text: message, files: [file] });
            return;
          } catch (err) { if (err.name === 'AbortError') return; }
        }

        // Fallback: descargar y abrir WhatsApp
        const link = document.createElement('a');
        link.download = 'gift-card-venus.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        setTimeout(() => {
          window.open(`https://wa.me/?text=${encodeURIComponent(message + '\n\n(Adjunta la imagen descargada)')}`, '_blank');
        }, 1000);
      } catch (error) {
        console.error('Error:', error);
        sendGiftCardWhatsApp();
      }
    }

    function copyGiftCardLink() {
      if (!selectedGiftCard) return;
      const url = `${window.location.origin}/giftcard/${selectedGiftCard.code}`;
      navigator.clipboard.writeText(url);
      alert('Link copiado');
    }

    function copyGiftCardLinkById(id) {
      const gc = allGiftCards.find(g => g.id === id);
      if (!gc) return;
      const url = `${window.location.origin}/giftcard/${gc.code}`;
      navigator.clipboard.writeText(url);
      alert('Link copiado');
    }

    function sendGiftCardWhatsApp() {
      if (!selectedGiftCard) return;
      sendGiftCardWhatsAppById(selectedGiftCard.id);
    }

    function sendGiftCardWhatsAppById(id) {
      const gc = allGiftCards.find(g => g.id === id);
      if (!gc) return;
      const url = `${window.location.origin}/giftcard/${gc.code}`;
      const text = encodeURIComponent(`🎁 ¡Te han regalado un servicio en Venus Cosmetología!\n\n✨ ${gc.serviceName}\n\n📍 Cactus 50, Col. Indeco\n📱 WhatsApp: 427 165 7595\n\n🎁 Canjea tu gift card aquí:\n${url}`);
      window.open(`https://wa.me/?text=${text}`, '_blank');
    }

    async function renewGiftCard(id) {
      if (!confirm('¿Renovar esta gift card por 30 días más?')) return;

      try {
        const res = await fetch(`/api/giftcards/${id}/renew`, {
          method: 'POST',
          credentials: 'include'
        });

        const json = await res.json();

        if (json.success) {
          loadGiftCards();
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        alert('Error de conexión');
      }
    }

    async function deleteGiftCard(id) {
      if (!confirm('¿Eliminar esta gift card? Esta acción no se puede deshacer.')) return;

      try {
        const res = await fetch(`/api/giftcards/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        const json = await res.json();

        if (json.success) {
          loadGiftCards();
          loadDashboardStats();
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        alert('Error de conexión');
      }
    }

    // Hacer funciones globales
    window.viewGiftCard = viewGiftCard;
    window.deleteGiftCard = deleteGiftCard;
    window.closeGiftCardModal = closeGiftCardModal;
    window.copyGiftCardLink = copyGiftCardLink;
    window.copyGiftCardLinkById = copyGiftCardLinkById;
    window.sendGiftCardWhatsApp = sendGiftCardWhatsApp;
    window.sendGiftCardWhatsAppById = sendGiftCardWhatsAppById;
    window.downloadGiftCardImage = downloadGiftCardImage;
    window.sendGiftCardWhatsAppImage = sendGiftCardWhatsAppImage;
    window.renewGiftCard = renewGiftCard;
    window.loadGiftCardServices = loadGiftCardServices;
    window.loadGiftCards = loadGiftCards;

    console.log('[GC] Gift Cards module loaded');

    /* =========================================================
       MODAL DE PAGO CON PRODUCTOS Y DESCUENTOS
       ========================================================= */

    let paymentProducts = [];
    let paymentServicePrice = 0;
    let allProductsForPayment = [];
    let discountType = 'percent';
    let isPriceEditing = false;

    async function loadProductsForPayment() {
      try {
        const res = await fetch('/api/products', { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          allProductsForPayment = (json.data || []).filter(p => p.stock > 0);
          updatePaymentProductSelect();
        }
      } catch (error) {
        console.error('Error loading products for payment:', error);
      }
    }

    function updatePaymentProductSelect() {
      const select = document.getElementById('payment-product-select');
      if (!select) return;

      select.innerHTML = '<option value="">Agregar producto...</option>';

      allProductsForPayment.forEach(p => {
        const inCart = paymentProducts.find(pp => pp.id === p.id);
        const availableStock = p.stock - (inCart ? inCart.qty : 0);

        if (availableStock > 0) {
          const stockLabel = availableStock <= 5 ? ` (${availableStock})` : '';
          select.innerHTML += `<option value="${p.id}" data-price="${p.price}" data-name="${p.name}" data-stock="${availableStock}" data-category="${p.category}">${p.name} - $${p.price}${stockLabel}</option>`;
        }
      });
    }

    async function openPaymentModal(appointmentId, clientName, serviceName, servicePrice) {
      paymentProducts = [];
      discountType = 'percent';
      isPriceEditing = false;

      document.getElementById('payment-appointment-id').value = appointmentId;
      document.getElementById('payment-client-name').textContent = clientName || '-';
      document.getElementById('payment-service-name').textContent = serviceName || '-';

      // Si no hay precio, intentar obtenerlo del servidor
      if (!servicePrice || servicePrice === 0) {
        console.log('[PAYMENT] Precio no disponible, obteniendo del servidor...');
        try {
          const res = await fetch(`/api/appointments/${appointmentId}`, { credentials: 'include' });
          const json = await res.json();
          
          if (json.success && json.data) {
            console.log('[PAYMENT] Datos de cita:', json.data);
            servicePrice = json.data.price || json.data.servicePrice || 0;
            
            // Si aún no hay precio, buscar en servicios
            if (!servicePrice || servicePrice === 0) {
              const serviceId = json.data.serviceId;
              if (serviceId) {
                const servRes = await fetch('/api/services', { credentials: 'include' });
                const servJson = await servRes.json();
                if (servJson.success) {
                  const service = servJson.data.find(s => s.id === serviceId);
                  if (service) {
                    servicePrice = service.price || 0;
                    console.log('[PAYMENT] Precio obtenido del servicio:', servicePrice);
                  }
                }
              }
            }
          }
        } catch (error) {
          console.error('[PAYMENT] Error obteniendo precio:', error);
        }
      }

      paymentServicePrice = parseFloat(servicePrice) || 0;
      console.log('[PAYMENT] Precio final del servicio:', paymentServicePrice);

      document.getElementById('payment-original-price').value = paymentServicePrice;
      document.getElementById('payment-price-display').textContent = '$' + paymentServicePrice.toLocaleString();
      document.getElementById('payment-price-display').classList.remove('hidden');
      document.getElementById('payment-price-input').value = paymentServicePrice;
      document.getElementById('payment-price-input').classList.remove('visible');

      document.getElementById('payment-discount-value').value = 0;
      document.getElementById('btn-discount-percent').classList.add('active');
      document.getElementById('btn-discount-fixed').classList.remove('active');
      document.getElementById('discount-symbol').textContent = '%';
      document.getElementById('payment-product-qty').value = 1;

      loadProductsForPayment();
      renderPaymentProducts();
      calculateTotals();

      document.getElementById('paymentDialog').showModal();
    }

    function closePaymentModal() {
      document.getElementById('paymentDialog').close();
      paymentProducts = [];
    }

    function togglePriceEdit() {
      const display = document.getElementById('payment-price-display');
      const input = document.getElementById('payment-price-input');

      if (isPriceEditing) {
        paymentServicePrice = parseFloat(input.value) || 0;
        display.textContent = '$' + paymentServicePrice.toLocaleString();
        display.classList.remove('hidden');
        input.classList.remove('visible');
        isPriceEditing = false;
      } else {
        input.value = paymentServicePrice;
        display.classList.add('hidden');
        input.classList.add('visible');
        input.focus();
        input.select();
        isPriceEditing = true;
      }
      calculateTotals();
    }

    function setDiscountType(type) {
      discountType = type;
      document.getElementById('btn-discount-percent').classList.toggle('active', type === 'percent');
      document.getElementById('btn-discount-fixed').classList.toggle('active', type === 'fixed');
      document.getElementById('discount-symbol').textContent = type === 'percent' ? '%' : '$';
      calculateTotals();
    }

    function addProductToPayment() {
      const select = document.getElementById('payment-product-select');
      const qtyInput = document.getElementById('payment-product-qty');

      if (!select.value) {
        alert('Selecciona un producto');
        return;
      }

      const option = select.options[select.selectedIndex];
      const qty = parseInt(qtyInput.value) || 1;
      const stock = parseInt(option.dataset.stock) || 0;

      if (qty > stock) {
        alert(`Solo hay ${stock} unidades disponibles`);
        return;
      }

      const existing = paymentProducts.find(p => p.id === select.value);

      if (existing) {
        existing.qty += qty;
      } else {
        paymentProducts.push({
          id: select.value,
          name: option.dataset.name,
          price: parseFloat(option.dataset.price),
          qty: qty,
          category: option.dataset.category,
          maxStock: stock
        });
      }

      select.value = '';
      qtyInput.value = 1;

      updatePaymentProductSelect();
      renderPaymentProducts();
      calculateTotals();
    }

    function removeProductFromPayment(productId) {
      paymentProducts = paymentProducts.filter(p => p.id !== productId);
      updatePaymentProductSelect();
      renderPaymentProducts();
      calculateTotals();
    }

    function renderPaymentProducts() {
      const list = document.getElementById('payment-products-list');

      if (paymentProducts.length === 0) {
        list.innerHTML = '<div class="payment-products-empty">Sin productos adicionales</div>';
        return;
      }

      const icons = { 'skincare': '🧴', 'maquillaje': '💄', 'corporal': '✨', 'cabello': '💇', 'otro': '📦' };

      list.innerHTML = paymentProducts.map(p => {
        const icon = icons[p.category] || '📦';
        const subtotal = p.price * p.qty;

        return `
          <div class="payment-product-item">
            <div class="payment-product-icon">${icon}</div>
            <div class="payment-product-info">
              <div class="payment-product-name">${p.name}</div>
              <div class="payment-product-meta">$${p.price} × ${p.qty}</div>
            </div>
            <div class="payment-product-price">$${subtotal.toLocaleString()}</div>
            <button class="payment-product-remove" onclick="removeProductFromPayment('${p.id}')">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
      }).join('');
    }

    function calculateTotals() {
      const servicePrice = paymentServicePrice;
      const productsTotal = paymentProducts.reduce((sum, p) => sum + (p.price * p.qty), 0);
      const productsCount = paymentProducts.reduce((sum, p) => sum + p.qty, 0);
      const subtotal = servicePrice + productsTotal;

      const discountValue = parseFloat(document.getElementById('payment-discount-value').value) || 0;
      let discountAmount = 0;

      if (discountType === 'percent') {
        discountAmount = Math.round(subtotal * (discountValue / 100));
      } else {
        discountAmount = Math.min(discountValue, subtotal);
      }

      const grandTotal = Math.max(0, subtotal - discountAmount);

      document.getElementById('total-service').textContent = '$' + servicePrice.toLocaleString();
      document.getElementById('total-products').textContent = '$' + productsTotal.toLocaleString();
      document.getElementById('total-products-count').textContent = productsCount;
      document.getElementById('total-subtotal').textContent = '$' + subtotal.toLocaleString();
      document.getElementById('total-discount').textContent = '-$' + discountAmount.toLocaleString();
      document.getElementById('total-grand').textContent = '$' + grandTotal.toLocaleString();
      document.getElementById('btn-payment-total').textContent = '$' + grandTotal.toLocaleString();

      document.getElementById('total-products-row').style.display = productsCount > 0 ? 'flex' : 'none';

      const discountRow = document.getElementById('total-discount-row');
      const discountApplied = document.getElementById('discount-applied');

      if (discountAmount > 0) {
        discountRow.classList.add('visible');
        discountApplied.classList.add('visible');
        const label = discountType === 'percent' ? `Descuento (${discountValue}%)` : 'Descuento';
        document.getElementById('total-discount-label').textContent = label;
        document.getElementById('discount-applied-text').textContent = `Descuento aplicado: -$${discountAmount.toLocaleString()}`;
      } else {
        discountRow.classList.remove('visible');
        discountApplied.classList.remove('visible');
      }
    }

    async function savePayment() {
      const appointmentId = document.getElementById('payment-appointment-id').value;
      const paymentMethod = document.getElementById('payment-method').value;

      const servicePrice = paymentServicePrice;
      const productsTotal = paymentProducts.reduce((sum, p) => sum + (p.price * p.qty), 0);
      const subtotal = servicePrice + productsTotal;

      const discountValue = parseFloat(document.getElementById('payment-discount-value').value) || 0;
      let discountAmount = 0;
      if (discountType === 'percent') {
        discountAmount = Math.round(subtotal * (discountValue / 100));
      } else {
        discountAmount = Math.min(discountValue, subtotal);
      }

      const grandTotal = Math.max(0, subtotal - discountAmount);

      if (!appointmentId) {
        alert('Error: No se encontró la cita');
        return;
      }

      const btn = document.getElementById('btn-save-payment');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

      try {
        const productsSold = paymentProducts.map(p => ({
          productId: p.id,
          name: p.name,
          price: p.price,
          qty: p.qty,
          subtotal: p.price * p.qty
        }));

        const res = await fetch(`/api/appointments/${appointmentId}/payment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            paymentMethod,
            serviceAmount: servicePrice,
            productsAmount: productsTotal,
            subtotal,
            discountType: discountAmount > 0 ? discountType : null,
            discountValue: discountAmount > 0 ? discountValue : 0,
            discountAmount,
            totalAmount: grandTotal,
            productsSold
          })
        });

        const json = await res.json();

        if (json.success) {
          closePaymentModal();
          if (typeof loadAppointments === 'function') loadAppointments();
          if (typeof loadTodayAppointments === 'function') loadTodayAppointments();
          alert('✓ Pago registrado: $' + grandTotal.toLocaleString());
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        console.error('Error saving payment:', error);
        alert('Error de conexión');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Cobrar <span id="btn-payment-total">$' + grandTotal.toLocaleString() + '</span>';
      }
    }

    window.openPaymentModal = openPaymentModal;
    window.closePaymentModal = closePaymentModal;
    window.togglePriceEdit = togglePriceEdit;
    window.setDiscountType = setDiscountType;
    window.addProductToPayment = addProductToPayment;
    window.removeProductFromPayment = removeProductFromPayment;
    window.calculateTotals = calculateTotals;
    window.savePayment = savePayment;

    // --- SIMULATE WEBHOOK ---
    async function simulateWebhook(action) {
      const phone = prompt("Ingresa el teléfono del cliente (10 dígitos):", "4271657595");
      if (!phone) return;

      let payload = {};
      if (action === 'confirmar') {
        payload = { From: 'whatsapp:+521' + phone, ButtonText: 'Confirmar', Body: 'Confirmar' };
      } else if (action === 'reprogramar') {
        payload = { From: 'whatsapp:+521' + phone, ButtonText: 'Reprogramar', Body: 'Reprogramar' };
      } else if (action === 'cancelar') {
        payload = { From: 'whatsapp:+521' + phone, ButtonText: 'Cancelar', Body: 'Cancelar' };
      }

      try {
        const res = await fetch('/api/whatsapp/webhook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          alert('✅ Webhook simulado correctamente. Revisa la consola del servidor y el estado de la cita.');
          loadAppointments(); // Recargar citas para ver cambios
        } else {
          alert('❌ Error al simular webhook');
        }
      } catch (e) {
        console.error(e);
        alert('❌ Error de red al simular webhook');
      }
    }

    /* =========================================================
       DASHBOARD MEJORADO - FASE 1
       ========================================================= */

    // Saludo según hora del día
    function updateGreeting() {
      const hour = new Date().getHours();
      let greeting = 'Buenas noches';
      if (hour >= 5 && hour < 12) greeting = 'Buenos días';
      else if (hour >= 12 && hour < 19) greeting = 'Buenas tardes';

      const el = document.getElementById('dash-greeting');
      if (el) el.textContent = greeting;
    }

    // Cargar estadísticas del dashboard
    async function loadDashboardStats() {
      try {
        // 1. Cargar métricas del mes desde el servidor (datos reales de eventos)
        const metricsRes = await fetch('/api/admin/metrics-month', { credentials: 'include' });
        const metricsJson = await metricsRes.json();

        if (metricsJson.success && metricsJson.data) {
          const { total, activeClients, stampsThisMonth, redeemsThisMonth, returnRate } = metricsJson.data;

          document.getElementById('stat-total-clients').textContent = activeClients || total;
          document.getElementById('stat-stamps-month').textContent = stampsThisMonth;
          document.getElementById('stat-redeems-month').textContent = redeemsThisMonth;
          document.getElementById('stat-return-rate').textContent = returnRate + '%';
        }

        // 2. Cargar TODAS las tarjetas para top clientes y cumpleaños
        let allClients = [];
        let page = 1;
        let hasMore = true;

        while (hasMore) {
          const clientsRes = await fetch(`/api/admin/cards-firebase?page=${page}&limit=100`, { credentials: 'include' });
          const clientsJson = await clientsRes.json();

          if (clientsJson.items && clientsJson.items.length > 0) {
            allClients = [...allClients, ...clientsJson.items];
            hasMore = page < clientsJson.totalPages;
            page++;
          } else {
            hasMore = false;
          }
        }

        const clients = allClients;

        if (clients.length > 0) {
          // Top clientes
          renderTopClients(clients);

          // Wallets
          const appleCount = clients.filter(c => c.walletType === 'apple').length;
          const googleCount = clients.filter(c => c.walletType === 'google').length;
          document.getElementById('wallet-apple').textContent = appleCount;
          document.getElementById('wallet-google').textContent = googleCount;

          // Cargar cumpleaños con todas las tarjetas
          loadBirthdaysFromClients(clients);
        }

        // 3. Cargar citas de hoy
        await loadTodayStats();

        // 4. Cargar gift cards
        await loadGiftCardStats();

        // 5. Cargar gráfica de actividad
        await loadActivityChart();

      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    // Cargar stats de hoy
    async function loadTodayStats() {
      try {
        const res = await fetch('/api/dashboard/today', { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          const { appointments, pending, income } = json.data;
          document.getElementById('today-appointments').textContent = appointments;
          document.getElementById('today-pending').textContent = pending;
          document.getElementById('today-income').textContent = '$' + income.toLocaleString();
        }
      } catch (error) {
        console.error('Error loading today stats:', error);
      }
    }

    // Cargar stats de gift cards
    async function loadGiftCardStats() {
      try {
        const res = await fetch('/api/giftcards', { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          const giftcards = json.data || [];
          const now = new Date();
          const sevenDaysFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
          const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

          const pending = giftcards.filter(gc => gc.status === 'pending' && new Date(gc.expiresAt) > now).length;
          const expiring = giftcards.filter(gc => {
            const expires = new Date(gc.expiresAt);
            return gc.status === 'pending' && expires > now && expires <= sevenDaysFromNow;
          }).length;
          const redeemedThisMonth = giftcards.filter(gc => {
            return gc.status === 'redeemed' && gc.redeemedAt && new Date(gc.redeemedAt) >= firstOfMonth;
          }).length;

          document.getElementById('gc-pending').textContent = pending;
          document.getElementById('gc-expiring').textContent = expiring;
          document.getElementById('gc-redeemed').textContent = redeemedThisMonth;
        }
      } catch (error) {
        console.error('Error loading gift card stats:', error);
      }
    }

    // Cargar cumpleaños desde clientes ya cargados
    function loadBirthdaysFromClients(clients) {
      try {
        const now = new Date();
        const birthdays = [];

        clients.forEach(c => {
          // Usar birthdate (no birthday)
          const birthdateField = c.birthdate || c.birthday;

          if (birthdateField) {
            // Parsear fecha en formato YYYY-MM-DD
            const [year, month, day] = birthdateField.split('-').map(Number);
            const thisYearBday = new Date(now.getFullYear(), month - 1, day);

            // Si ya pasó este año, usar el próximo año
            if (thisYearBday < now) {
              thisYearBday.setFullYear(now.getFullYear() + 1);
            }

            const daysUntil = Math.ceil((thisYearBday - now) / (1000 * 60 * 60 * 24));

            // Mostrar cumpleaños en los próximos 30 días
            if (daysUntil <= 30) {
              birthdays.push({
                name: c.name,
                date: thisYearBday,
                daysUntil,
                dateStr: thisYearBday.toLocaleDateString('es-MX', { day: 'numeric', month: 'long' })
              });
            }
          }
        });

        birthdays.sort((a, b) => a.daysUntil - b.daysUntil);
        renderBirthdays(birthdays.slice(0, 3));
      } catch (error) {
        console.error('Error loading birthdays:', error);
      }
    }

    function renderBirthdays(birthdays) {
      const container = document.getElementById('birthday-list');

      if (birthdays.length === 0) {
        container.innerHTML = '<div class="dash-empty"><p>Sin cumpleaños próximos</p></div>';
        return;
      }

      container.innerHTML = birthdays.map(b => {
        let badgeClass = 'soon';
        let badgeText = `En ${b.daysUntil} días`;

        if (b.daysUntil === 0) {
          badgeClass = 'today';
          badgeText = '¡Hoy!';
        } else if (b.daysUntil === 1) {
          badgeText = 'Mañana';
        }

        return `
          <div class="birthday-item">
            <div class="birthday-avatar">🎂</div>
            <div class="birthday-info">
              <h4>${b.name}</h4>
              <p>${b.dateStr}</p>
            </div>
            <span class="birthday-badge ${badgeClass}">${badgeText}</span>
          </div>
        `;
      }).join('');
    }

    // Cargar y renderizar gráfica de actividad
    async function loadActivityChart() {
      try {
        const res = await fetch('/api/dashboard/history', { credentials: 'include' });
        const json = await res.json();

        if (!json.success) return;

        const data = json.data;
        const ctx = document.getElementById('activity-chart').getContext('2d');

        // Destruir chart previo si existe
        if (window.myActivityChart) {
          window.myActivityChart.destroy();
        }

        window.myActivityChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.map(d => d.date),
            datasets: [
              {
                label: 'Citas',
                data: data.map(d => d.appointments),
                borderColor: '#8c9668', // Venus
                backgroundColor: 'rgba(140, 150, 104, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                yAxisID: 'y'
              },
              {
                label: 'Ingresos',
                data: data.map(d => d.income),
                borderColor: '#22c55e', // Green
                backgroundColor: 'rgba(34, 197, 94, 0.0)',
                borderWidth: 2,
                borderDash: [5, 5],
                tension: 0.4,
                fill: false,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            plugins: {
              legend: {
                labels: { color: '#e5e7eb' }
              }
            },
            scales: {
              x: {
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { color: '#e5e7eb' }
              },
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { color: '#e5e7eb', stepSize: 1 }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                grid: { drawOnChartArea: false },
                ticks: {
                  color: '#22c55e',
                  callback: function (value) { return '$' + value; }
                }
              }
            }
          }
        });

      } catch (error) {
        console.error('Error loading activity chart:', error);
      }
    }

    // Renderizar top clientes
    function renderTopClients(clients) {
      const container = document.getElementById('top-clients-sidebar');

      const sorted = [...clients]
        .map(c => ({ ...c, totalStamps: (c.stamps || 0) + ((c.cycles || 0) * 8) }))
        .sort((a, b) => b.totalStamps - a.totalStamps)
        .slice(0, 5);

      if (sorted.length === 0 || sorted[0].totalStamps === 0) {
        container.innerHTML = '<div class="dash-empty"><p>Sin datos aún</p></div>';
        return;
      }

      container.innerHTML = sorted.map((c, i) => {
        const maxStamps = 8;
        const remaining = maxStamps - c.stamps;

        return `
          <div class="top-client-item">
            <div class="top-client-rank ${i === 0 ? 'gold' : ''}">${i + 1}</div>
            <div class="top-client-info">
              <h4>${c.name}</h4>
              <p>${remaining > 0 ? remaining + ' para canjear' : '¡Listo para canjear!'}</p>
            </div>
            <div class="top-client-stamps">
              <div class="count">${c.stamps}/${maxStamps}</div>
              <div class="label">sellos</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Inicializar dashboard
    document.addEventListener('DOMContentLoaded', () => {
      updateGreeting();

      const activeTab = document.querySelector('.tab-content:not(.hidden)');
      if (activeTab && activeTab.id === 'tab-overview') {
        loadDashboardStats();
      }
    });

    window.loadDashboardStats = loadDashboardStats;

    // ========== AUTO-REFRESH DASHBOARD (cada 30 segundos) ==========
    let dashboardRefreshInterval = null;

    function startDashboardAutoRefresh() {
      if (dashboardRefreshInterval) {
        clearInterval(dashboardRefreshInterval);
      }

      dashboardRefreshInterval = setInterval(() => {
        const overviewTab = document.getElementById('tab-overview');
        if (overviewTab && !overviewTab.classList.contains('hidden')) {
          console.log('🔄 Auto-refresh: actualizando dashboard...');
          loadTodayStats();
          loadGiftCardStats();
          // No recargar todo para evitar parpadeo, solo stats que cambian frecuentemente
        }
      }, 30000); // 30 segundos
    }

    function stopDashboardAutoRefresh() {
      if (dashboardRefreshInterval) {
        clearInterval(dashboardRefreshInterval);
        dashboardRefreshInterval = null;
      }
    }

    // Iniciar auto-refresh cuando se entra al tab overview
    document.addEventListener('DOMContentLoaded', () => {
      const overviewTab = document.getElementById('tab-overview');
      if (overviewTab && !overviewTab.classList.contains('hidden')) {
        startDashboardAutoRefresh();
      }
    });

    /* =========================================================
       SCANNER UNIVERSAL - FASE 3
       ========================================================= */

    let universalScanner = null;

    function openScanner() {
      document.getElementById('scanner-modal').classList.add('active');
      document.getElementById('scanner-result').classList.remove('active');
      document.getElementById('scanner-options').style.display = 'flex';
      document.getElementById('scanner-manual').style.display = 'block';
      document.getElementById('scanner-viewport').style.display = 'block';
      document.getElementById('scanner-hint').textContent = 'Apunta la cámara al código QR';

      startCamera();
    }

    function closeScanner() {
      document.getElementById('scanner-modal').classList.remove('active');
      stopCamera();
    }

    async function startCamera() {
      const frame = document.getElementById('scanner-frame');

      try {
        frame.style.display = 'block';

        // Crear div para el scanner si no existe
        let scannerDiv = document.getElementById('universal-qr-reader');
        if (!scannerDiv) {
          scannerDiv = document.createElement('div');
          scannerDiv.id = 'universal-qr-reader';
          scannerDiv.style.width = '100%';
          document.getElementById('scanner-viewport').appendChild(scannerDiv);
        }

        frame.style.display = 'none';

        universalScanner = new Html5Qrcode('universal-qr-reader');

        const config = {
          fps: 10,
          qrbox: { width: 220, height: 220 }
        };

        await universalScanner.start(
          { facingMode: 'environment' },
          config,
          (decodedText) => {
            handleScannedCode(decodedText);
          },
          (errorMessage) => {
            // Ignorar errores de escaneo continuo
          }
        );

      } catch (error) {
        console.error('Error accessing camera:', error);
        document.getElementById('scanner-hint').textContent = 'No se pudo acceder a la cámara. Usa el código manual.';
        frame.style.display = 'block';
      }
    }

    async function stopCamera() {
      if (universalScanner) {
        try {
          await universalScanner.stop();
          universalScanner.clear();
          universalScanner = null;
        } catch (error) {
          console.error('Error stopping scanner:', error);
        }
      }
    }

    async function handleScannedCode(code) {
      stopCamera();

      document.getElementById('scanner-hint').textContent = 'Procesando...';
      document.getElementById('scanner-options').style.display = 'none';
      document.getElementById('scanner-manual').style.display = 'none';

      try {
        if (code.startsWith('VGC-')) {
          await handleGiftCardScan(code);
        } else {
          await handleLoyaltyScan(code);
        }
      } catch (error) {
        console.error('Error processing code:', error);
        document.getElementById('scanner-hint').textContent = 'Error al procesar. Intenta de nuevo.';
      }
    }

    async function handleLoyaltyScan(cardId) {
      try {
        const res = await fetch(`/api/card/${cardId}`, { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          const card = json.data;
          showScanResult('loyalty', card.name, `${card.stamps}/8 sellos`, cardId);
        } else {
          document.getElementById('scanner-hint').textContent = 'Tarjeta no encontrada';
          setTimeout(() => {
            document.getElementById('scanner-options').style.display = 'flex';
            document.getElementById('scanner-manual').style.display = 'block';
            document.getElementById('scanner-hint').textContent = 'Intenta de nuevo';
          }, 2000);
        }
      } catch (error) {
        document.getElementById('scanner-hint').textContent = 'Error de conexión';
      }
    }

    async function handleGiftCardScan(code) {
      try {
        const res = await fetch(`/api/giftcards/code/${code}`, { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          const gc = json.data;
          const statusText = gc.status === 'redeemed' ? '(Ya canjeada)' : gc.serviceName;
          showScanResult('gift', gc.recipientName || 'Gift Card', statusText, gc.id, gc.status);
        } else {
          document.getElementById('scanner-hint').textContent = 'Gift Card no encontrada';
          setTimeout(() => {
            document.getElementById('scanner-options').style.display = 'flex';
            document.getElementById('scanner-manual').style.display = 'block';
            document.getElementById('scanner-hint').textContent = 'Intenta de nuevo';
          }, 2000);
        }
      } catch (error) {
        document.getElementById('scanner-hint').textContent = 'Error de conexión';
      }
    }

    function showScanResult(type, title, subtitle, id, status) {
      const resultDiv = document.getElementById('scanner-result');
      const iconDiv = document.getElementById('scanner-result-icon');
      const actionsDiv = document.getElementById('scanner-result-actions');

      document.getElementById('scanner-result-title').textContent = title;
      document.getElementById('scanner-result-subtitle').textContent = subtitle;

      iconDiv.className = 'scanner-result-icon ' + type;
      iconDiv.innerHTML = type === 'loyalty'
        ? '<i class="fas fa-credit-card"></i>'
        : '<i class="fas fa-gift"></i>';

      if (type === 'loyalty') {
        actionsDiv.innerHTML = `
          <button class="btn primary" onclick="addStampFromScanner('${id}')">
            <i class="fas fa-star"></i> Agregar Sello
          </button>
          <button class="btn ghost" onclick="closeScanner()">Cancelar</button>
        `;
      } else {
        if (status === 'redeemed') {
          actionsDiv.innerHTML = `
            <button class="btn ghost" onclick="closeScanner()">
              <i class="fas fa-check"></i> Ya canjeada
            </button>
          `;
        } else if (status === 'expired') {
          actionsDiv.innerHTML = `
            <button class="btn ghost" onclick="closeScanner()">
              <i class="fas fa-times"></i> Expirada
            </button>
          `;
        } else {
          actionsDiv.innerHTML = `
            <button class="btn primary" onclick="redeemGiftCardFromScanner('${id}')">
              <i class="fas fa-gift"></i> Canjear
            </button>
            <button class="btn ghost" onclick="closeScanner()">Cancelar</button>
          `;
        }
      }

      document.getElementById('scanner-viewport').style.display = 'none';
      resultDiv.classList.add('active');
    }

    async function addStampFromScanner(cardId) {
      try {
        const res = await fetch(`/api/stamp/${cardId}`, {
          method: 'POST',
          credentials: 'include'
        });
        const json = await res.json();

        if (json.success || json.stamps !== undefined) {
          const clientName = json.name || 'Cliente';
          const stamps = json.stamps || 0;
          const maxStamps = json.max || 8;

          // Crear notificación
          notifySello(clientName, stamps, maxStamps);

          alert('✓ Sello agregado correctamente');
          closeScanner();
          loadDashboardStats();
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        alert('Error de conexión');
      }
    }

    async function redeemGiftCardFromScanner(giftcardId) {
      try {
        const res = await fetch(`/api/giftcards/${giftcardId}/redeem`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ redeemedBy: 'Scanner' })
        });
        const json = await res.json();

        if (json.success) {
          alert('✓ Gift Card canjeada correctamente');
          closeScanner();
          loadDashboardStats();
        } else {
          alert('Error: ' + json.error);
        }
      } catch (error) {
        alert('Error de conexión');
      }
    }

    function showManualCodeInput() {
      const code = prompt('Ingresa el código de la tarjeta o gift card:');
      if (code && code.trim()) {
        handleScannedCode(code.trim().toUpperCase());
      }
    }

    // Cerrar scanner con ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('scanner-modal');
        if (modal && modal.classList.contains('active')) {
          closeScanner();
        }
      }
    });

    // Mobile Menu Logic
    const mobileMenu = document.getElementById('mobile-menu');
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const mobileMenuClose = document.getElementById('mobile-menu-close');
    const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');

    if (mobileMenuToggle) {
      mobileMenuToggle.addEventListener('click', () => {
        mobileMenu.classList.remove('hidden');
      });
    }

    if (mobileMenuClose) {
      mobileMenuClose.addEventListener('click', () => {
        mobileMenu.classList.add('hidden');
      });
    }

    mobileNavLinks.forEach(link => {
      link.addEventListener('click', () => {
        mobileMenu.classList.add('hidden');
        // Handle tab switching if it's a tab link
        const tab = link.dataset.tab;
        if (tab) {
          document.querySelectorAll('.nav a').forEach(a => a.classList.remove('is-active'));
          document.querySelectorAll('.mobile-nav-link').forEach(a => a.classList.remove('is-active'));
          link.classList.add('is-active');

          document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
          const target = document.getElementById('tab-' + tab);
          if (target) target.classList.add('active');
        }
      });
    });

    // Logout mobile
    document.getElementById('logout-mobile')?.addEventListener('click', async () => {
      try {
        await fetch('/api/admin/logout', { method: 'POST' });
        window.location.reload();
      } catch (e) { console.error(e); }
    });

    window.openScanner = openScanner;
    window.closeScanner = closeScanner;
    window.showManualCodeInput = showManualCodeInput;
    window.addStampFromScanner = addStampFromScanner;
    window.redeemGiftCardFromScanner = redeemGiftCardFromScanner;

    /* =========================================================
       SISTEMA DE NOTIFICACIONES - CAMPANA
       ========================================================= */

    let notifications = [];
    let unreadCount = 0;

    // Tipos de notificación con iconos
    const NOTIF_TYPES = {
      CITA_NUEVA: { type: 'cita', icon: 'calendar-plus', title: 'Nueva cita' },
      CITA_CONFIRMADA: { type: 'cita', icon: 'calendar-check', title: 'Cita confirmada' },
      CITA_CANCELADA: { type: 'alerta', icon: 'calendar-times', title: 'Cita cancelada' },
      VENTA: { type: 'venta', icon: 'receipt', title: 'Venta completada' },
      TARJETA_NUEVA: { type: 'tarjeta', icon: 'credit-card', title: 'Nueva tarjeta' },
      SELLO: { type: 'sello', icon: 'star', title: 'Sello agregado' },
      TARJETA_COMPLETA: { type: 'sello', icon: 'award', title: '¡Tarjeta completa!' },
      GIFTCARD_NUEVA: { type: 'giftcard', icon: 'gift', title: 'Gift card creada' },
      GIFTCARD_CANJEADA: { type: 'giftcard', icon: 'box-open', title: 'Gift card canjeada' },
      CUMPLE: { type: 'cumple', icon: 'birthday-cake', title: '¡Cumpleaños!' }
    };

    async function initNotifications() {
      console.log('[NOTIF] 🔔 Inicializando sistema de notificaciones...');
      await loadNotifications();
      setInterval(checkNewNotifications, 30000);
      checkBirthdays();
      console.log('[NOTIF] ✅ Sistema de notificaciones iniciado');
    }

    async function loadNotifications() {
      try {
        console.log('[NOTIF] 📥 Cargando notificaciones...');
        const res = await fetch('/api/notifications?limit=30', { credentials: 'include' });
        const json = await res.json();

        console.log('[NOTIF] Respuesta:', json);

        if (json.success) {
          notifications = json.data || [];
          unreadCount = notifications.filter(n => !n.read).length;
          console.log(`[NOTIF] ✅ ${notifications.length} notificaciones cargadas, ${unreadCount} no leídas`);
          updateBadge();
          renderNotifications();
        } else {
          console.error('[NOTIF] ❌ Error en respuesta:', json.error);
        }
      } catch (error) {
        console.error('[NOTIF] ❌ Error loading notifications:', error);
      }
    }

    async function checkNewNotifications() {
      try {
        const lastId = notifications[0]?.id || '';
        const res = await fetch(`/api/notifications/new?after=${lastId}`, { credentials: 'include' });
        const json = await res.json();

        if (json.success && json.data?.length > 0) {
          notifications = [...json.data, ...notifications];
          unreadCount += json.data.length;
          updateBadge();
          renderNotifications();

          // Mostrar notificaciones de navegador
          if ("Notification" in window && Notification.permission === "granted") {
            json.data.forEach(n => {
              new Notification(n.title, {
                body: n.message,
                icon: '/assets/icon.png' // Fallback icon if available
              });
            });
          }
        }
      } catch (error) {
        console.error('Error checking notifications:', error);
      }
    }

    function toggleNotifications() {
      // Solicitar permiso si aún no se tiene
      if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
      }

      const dropdown = document.getElementById('notif-dropdown');
      dropdown?.classList.toggle('active');

      if (dropdown?.classList.contains('active')) {
        renderNotifications();
      }
    }

    document.addEventListener('click', (e) => {
      const wrapper = e.target.closest('.notification-wrapper');
      if (!wrapper) {
        document.getElementById('notif-dropdown')?.classList.remove('active');
      }
    });

    function updateBadge() {
      const badge = document.getElementById('notif-badge');
      const badgeMobile = document.getElementById('notif-badge-mobile');
      const count = unreadCount > 99 ? '99+' : unreadCount;

      if (badge) {
        badge.textContent = count;
        badge.classList.toggle('hidden', unreadCount === 0);
      }

      if (badgeMobile) {
        badgeMobile.textContent = count;
        badgeMobile.classList.toggle('hidden', unreadCount === 0);
      }
    }

    function renderNotifications() {
      const list = document.getElementById('notif-list');
      if (!list) return;

      if (notifications.length === 0) {
        list.innerHTML = `
          <div class="notification-empty">
            <i class="fas fa-bell-slash"></i>
            <p>No hay notificaciones</p>
          </div>
        `;
        return;
      }

      list.innerHTML = notifications.slice(0, 20).map(n => `
        <div class="notification-item ${n.read ? '' : 'unread'}" onclick="clickNotification('${n.id}')">
          <div class="notification-icon ${n.type}">
            <i class="fas fa-${n.icon}"></i>
          </div>
          <div class="notification-content">
            <div class="notification-title">
              ${n.title}
              ${!n.read ? '<span class="new-tag">Nuevo</span>' : ''}
            </div>
            <div class="notification-message">${n.message}</div>
            <div class="notification-time">${timeAgo(n.createdAt)}</div>
          </div>
        </div>
      `).join('');
    }

    function timeAgo(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const secs = Math.floor((now - date) / 1000);

      if (secs < 60) return 'Ahora';
      if (secs < 3600) return `Hace ${Math.floor(secs / 60)} min`;
      if (secs < 86400) return `Hace ${Math.floor(secs / 3600)} hrs`;
      if (secs < 604800) return `Hace ${Math.floor(secs / 86400)} días`;
      return date.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
    }

    async function clickNotification(id) {
      const notif = notifications.find(n => n.id === id);

      if (notif && !notif.read) {
        notif.read = true;
        unreadCount = Math.max(0, unreadCount - 1);
        updateBadge();
        renderNotifications();
        fetch(`/api/notifications/${id}/read`, { method: 'POST', credentials: 'include' });
      }

      document.getElementById('notif-dropdown')?.classList.remove('active');
    }

    async function markAllRead() {
      try {
        await fetch('/api/notifications/read-all', { method: 'POST', credentials: 'include' });
        notifications.forEach(n => n.read = true);
        unreadCount = 0;
        updateBadge();
        renderNotifications();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function clearAllNotifications() {
      if (!confirm('¿Eliminar todas las notificaciones?')) return;

      try {
        await fetch('/api/notifications/clear', { method: 'DELETE', credentials: 'include' });
        notifications = [];
        unreadCount = 0;
        updateBadge();
        renderNotifications();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function createNotification(typeKey, message, entityId = null) {
      const config = NOTIF_TYPES[typeKey];
      if (!config) return;

      const data = {
        type: config.type,
        icon: config.icon,
        title: config.title,
        message: message,
        entityId: entityId
      };

      try {
        const res = await fetch('/api/notifications', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });

        const json = await res.json();

        if (json.success) {
          notifications.unshift(json.data);
          unreadCount++;
          updateBadge();
        }
      } catch (error) {
        console.error('Error creating notification:', error);
      }
    }

    function notifyCitaNueva(clientName, serviceName, date, time) {
      createNotification('CITA_NUEVA', `${clientName} - ${serviceName} (${date} ${time})`);
    }

    function notifyCitaConfirmada(clientName, serviceName) {
      createNotification('CITA_CONFIRMADA', `${clientName} confirmó ${serviceName}`);
    }

    function notifyCitaCancelada(clientName, serviceName) {
      createNotification('CITA_CANCELADA', `${clientName} canceló ${serviceName}`);
    }

    function notifyVenta(clientName, total) {
      createNotification('VENTA', `$${total.toLocaleString()} - ${clientName}`);
    }

    function notifyTarjetaNueva(clientName) {
      createNotification('TARJETA_NUEVA', `Nueva tarjeta para ${clientName}`);
    }

    function notifySello(clientName, stamps, maxStamps = 8) {
      const remaining = maxStamps - stamps;
      if (remaining <= 0) {
        createNotification('TARJETA_COMPLETA', `${clientName} completó su tarjeta 🎉`);
      } else {
        createNotification('SELLO', `${clientName} tiene ${stamps}/${maxStamps} sellos`);
      }
    }

    function notifyGiftCardNueva(serviceName, recipientName) {
      createNotification('GIFTCARD_NUEVA', `${serviceName} para ${recipientName}`);
    }

    function notifyGiftCardCanjeada(serviceName, recipientName) {
      createNotification('GIFTCARD_CANJEADA', `${recipientName} canjeó ${serviceName}`);
    }

    async function checkBirthdays() {
      try {
        const res = await fetch('/api/admin/cards-firebase', { credentials: 'include' });
        const json = await res.json();

        if (json.success) {
          const today = new Date();
          const todayMD = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

          const birthdays = (json.data?.items || []).filter(c => {
            if (!c.birthdate) return false;
            const parts = c.birthdate.split('-');
            const bday = `${parts[1]}-${parts[2]}`;
            return bday === todayMD;
          });

          const notifiedKey = `birthdays_${today.toISOString().split('T')[0]}`;
          if (localStorage.getItem(notifiedKey)) return;

          birthdays.forEach(c => {
            createNotification('CUMPLE', `¡${c.name} cumple años hoy! 🎂`);
          });

          if (birthdays.length > 0) {
            localStorage.setItem(notifiedKey, 'true');
          }
        }
      } catch (error) {
        console.error('Error checking birthdays:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initNotifications, 1000);
    });

    window.toggleNotifications = toggleNotifications;
    window.markAllRead = markAllRead;
    window.clearAllNotifications = clearAllNotifications;
    window.clickNotification = clickNotification;
    window.createNotification = createNotification;
    window.notifyCitaNueva = notifyCitaNueva;
    window.notifyCitaConfirmada = notifyCitaConfirmada;
    window.notifyCitaCancelada = notifyCitaCancelada;
    window.notifyVenta = notifyVenta;
    window.notifyTarjetaNueva = notifyTarjetaNueva;
    window.notifySello = notifySello;
    window.notifyGiftCardNueva = notifyGiftCardNueva;
    window.notifyGiftCardCanjeada = notifyGiftCardCanjeada;

  </script>

  <!-- Botones flotantes -->
  <div class="quick-actions">
    <button class="quick-action-btn scanner" title="Escanear QR" onclick="openScanner()">
      <i class="fas fa-qrcode"></i>
    </button>
    <button class="quick-action-btn primary" title="Nueva cita" onclick="newApptDialog.showModal()">
      <i class="fas fa-plus"></i>
    </button>
  </div>

  <!-- Modal Scanner Universal -->
  <div class="scanner-modal" id="scanner-modal">
    <div class="scanner-content">
      <button class="scanner-close" onclick="closeScanner()">
        <i class="fas fa-times"></i>
      </button>

      <div class="scanner-header">
        <h2><i class="fas fa-qrcode"></i> Escanear QR</h2>
        <p>Tarjetas de lealtad o Gift Cards</p>
      </div>

      <div class="scanner-viewport" id="scanner-viewport">
        <video id="scanner-video" class="scanner-video" playsinline></video>
        <div class="scanner-frame" id="scanner-frame">
          <div class="scanner-corner tl"></div>
          <div class="scanner-corner tr"></div>
          <div class="scanner-corner bl"></div>
          <div class="scanner-corner br"></div>
          <div class="scanner-line"></div>
        </div>
        <p class="scanner-hint" id="scanner-hint">Apunta la cámara al código QR</p>
      </div>

      <div class="scanner-result" id="scanner-result">
        <div class="scanner-result-icon" id="scanner-result-icon">
          <i class="fas fa-credit-card"></i>
        </div>
        <h3 id="scanner-result-title">Cliente encontrado</h3>
        <p class="subtitle" id="scanner-result-subtitle">-</p>
        <div class="scanner-result-actions" id="scanner-result-actions">
          <!-- Botones dinámicos -->
        </div>
      </div>

      <div class="scanner-options" id="scanner-options">
        <div class="scanner-option">
          <div class="scanner-option-icon loyalty">
            <i class="fas fa-credit-card"></i>
          </div>
          <div class="scanner-option-info">
            <h4>Tarjeta de Lealtad</h4>
            <p>Agregar sello (+1)</p>
          </div>
        </div>
        <div class="scanner-option">
          <div class="scanner-option-icon gift">
            <i class="fas fa-gift"></i>
          </div>
          <div class="scanner-option-info">
            <h4>Gift Card</h4>
            <p>Canjear servicio</p>
          </div>
        </div>
      </div>

      <div class="scanner-manual" id="scanner-manual">
        <p>¿No funciona la cámara?</p>
        <button class="btn ghost" style="width:100%;" onclick="showManualCodeInput()">
          <i class="fas fa-keyboard"></i> Ingresar código manual
        </button>
      </div>
    </div>
  </div>
</body>

</html>