<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendar Cita - Venus Cosmetolog√≠a</title>
  <link rel="icon" href="/assets/logo.png">
  <link rel="stylesheet" href="/css/tailwind.css?v=2">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    /* Navigation styles - keep for now */
    nav {
      position: fixed;
      top: 0;
      width: 100%;
      background: rgba(255,255,255,0.98);
      backdrop-filter: blur(10px);
      padding: 0.8rem 1.5rem;
      z-index: 1000;
      box-shadow: 0 2px 20px rgba(0,0,0,0.05);
    }
    
    nav > div {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    nav a {
      text-decoration: none;
      color: #2d2d1f;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    nav a:first-child {
      font-size: 1.5rem;
      font-weight: 300;
      color: #8c9668;
      font-style: italic;
    }
    
    nav > div > div {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }
  </style>
</head>

<body class="bg-venus-bg" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; color: #2d2d1f; min-height: 100vh; margin: 0; padding: 0; width: 100%; display: flex; flex-direction: column;">
  <!-- Navigation -->
  <nav
    style="position:fixed;top:0;width:100%;background:rgba(255,255,255,0.98);backdrop-filter:blur(10px);padding:0.8rem 0;z-index:1000;box-shadow:0 2px 20px rgba(0,0,0,0.05);">
    <div class="tw-container-centered" style="display:flex;justify-content:space-between;align-items:center;">
      <a href="/landing.html"
        style="font-size:1.5rem;font-weight:300;color:#8c9668;font-style:italic;text-decoration:none;">Venus</a>
      <div style="display:flex;gap:1.5rem;align-items:center;">
        <a href="/landing.html#inicio"
          style="text-decoration:none;color:#2d2d1f;font-size:0.9rem;font-weight:500;">Inicio</a>
        <a href="/landing.html#servicios"
          style="text-decoration:none;color:#2d2d1f;font-size:0.9rem;font-weight:500;">Servicios</a>
        <a href="/landing.html#transformaciones"
          style="text-decoration:none;color:#2d2d1f;font-size:0.9rem;font-weight:500;">Transformaciones</a>
        <a href="/landing.html#testimonios"
          style="text-decoration:none;color:#2d2d1f;font-size:0.9rem;font-weight:500;">Testimonios</a>
      </div>
    </div>
  </nav>

  <div class="tw-booking-header" style="margin-top:60px;">
    <img src="/assets/logo.png" alt="Venus" class="tw-booking-logo">
    <h1 id="business-name" class="tw-booking-title">Venus Cosmetolog√≠a</h1>
    <p class="tw-booking-subtitle">Solicita tu cita</p>
  </div>
  <div class="tw-booking-container">
    <!-- Informaci√≥n del negocio -->
    <div class="tw-business-info">
      <div class="tw-business-row">
        <i class="fas fa-map-marker-alt tw-business-icon"></i>
        <div class="tw-business-content">
          <div class="tw-business-label">Ubicaci√≥n</div>
          <div id="business-address" class="tw-business-text">Cargando...</div>
        </div>
      </div>
      <div class="tw-business-row">
        <i class="fas fa-clock tw-business-icon"></i>
        <div class="tw-business-content">
          <div class="tw-business-label">Horario de atenci√≥n</div>
          <div id="business-hours" class="tw-business-text">Cargando...</div>
        </div>
      </div>
      <div id="maps-button-container" style="display: none; margin-top: 8px;">
        <a id="maps-button" href="#" target="_blank" class="tw-maps-btn">
          <i class="fas fa-map-marked-alt"></i>Ver en Google Maps
        </a>
      </div>
    </div>
    <div class="tw-progress">
      <div class="tw-progress-dot active" id="dot-1"></div>
      <div class="tw-progress-dot" id="dot-2"></div>
      <div class="tw-progress-dot" id="dot-3"></div>
      <div class="tw-progress-dot" id="dot-4"></div>
    </div>
    <!-- PASO 1: Servicio -->
    <div class="tw-step active" id="step-1">
      <div class="tw-card">
        <div class="tw-card-header">
          <div class="tw-card-title"><i class="fas fa-sparkles"></i>¬øQu√© servicio te gustar√≠a?</div>
        </div>
        <div class="tw-card-body">
          <!-- Tabs Container -->
          <div class="tw-category-tabs" id="category-tabs">
            <!-- Rendered by JS -->
          </div>
          <div class="tw-services-grid" id="services-list">
            <div class="tw-booking-loading">
              <div class="tw-spinner"></div>
              <p>Cargando servicios...</p>
            </div>
          </div>
          <div class="tw-buttons-row">
            <button class="tw-btn tw-btn-primary" id="btn-step1" disabled>Continuar <i class="fas fa-arrow-right"></i></button>
          </div>
        </div>
      </div>
    </div>
    <!-- PASO 2: Fecha y Hora -->
    <div class="tw-step" id="step-2">
      <div class="tw-card">
        <div class="tw-card-header">
          <div class="tw-card-title"><i class="fas fa-calendar"></i>¬øCu√°ndo te gustar√≠a venir?</div>
        </div>
        <div class="tw-card-body">
          <div class="tw-calendar-wrapper">
            <div class="tw-calendar">
              <div class="tw-calendar-header">
                <div class="tw-calendar-nav">
                  <button class="tw-calendar-nav-btn" id="btn-prev-month"><i class="fas fa-chevron-left"></i></button>
                </div>
                <h3 class="tw-calendar-title" id="calendar-month">Diciembre 2025</h3>
                <div class="tw-calendar-nav">
                  <button class="tw-calendar-nav-btn" id="btn-next-month"><i class="fas fa-chevron-right"></i></button>
                </div>
              </div>
              <div class="tw-calendar-grid" id="calendar-grid"></div>
            </div>
            <div class="tw-time-slots">
              <h3 class="tw-time-slots-title" id="time-title">Selecciona un d√≠a</h3>
              <div class="tw-time-grid" id="time-grid">
                <p style="grid-column:span 3;text-align:center;color:#7a7a6a;padding:16px;font-size:12px;">
                  Primero elige una fecha
                </p>
              </div>
            </div>
          </div>
          <div class="tw-buttons-row">
            <button class="tw-btn tw-btn-ghost" id="btn-back-to-1"><i class="fas fa-arrow-left"></i>Atr√°s</button>
            <button class="tw-btn tw-btn-primary" id="btn-step2" disabled>Continuar <i class="fas fa-arrow-right"></i></button>
          </div>
        </div>
      </div>
    </div>
    <!-- PASO 3: Datos -->
    <div class="tw-step" id="step-3">
      <div class="tw-card">
        <div class="tw-card-header">
          <div class="tw-card-title"><i class="fas fa-user"></i>Tus datos</div>
        </div>
        <div class="tw-card-body">
          <div class="tw-form-group">
            <label class="tw-form-label">Nombre completo <span class="required" style="color:#ef4444;">*</span></label>
            <input type="text" class="tw-form-input" id="input-name" placeholder="Tu nombre completo">
          </div>
          <div class="tw-form-group">
            <label class="tw-form-label">WhatsApp <span class="required" style="color:#ef4444;">*</span></label>
            <input type="tel" class="tw-form-input" id="input-phone" placeholder="10 d√≠gitos" maxlength="15">
          </div>
          <div class="tw-form-row">
            <div class="tw-form-group">
              <label class="tw-form-label">Email</label>
              <input type="email" class="tw-form-input" id="input-email" placeholder="tu@email.com">
            </div>
            <div class="tw-form-group">
              <label class="tw-form-label">Cumplea√±os</label>
              <input type="date" class="tw-form-input" id="input-birthday">
            </div>
          </div>
        </div>
      </div>
      <div class="tw-card">
        <div class="tw-card-header">
          <div class="tw-card-title"><i class="fas fa-clipboard-list"></i>Tu solicitud</div>
        </div>
        <div class="tw-card-body">
          <div class="tw-summary">
            <div class="tw-summary-row">
              <span class="tw-summary-label">Servicio</span>
              <span class="tw-summary-value" id="sum-service">-</span>
            </div>
            <div class="tw-summary-row">
              <span class="tw-summary-label">Fecha</span>
              <span class="tw-summary-value" id="sum-date">-</span>
            </div>
            <div class="tw-summary-row">
              <span class="tw-summary-label">Hora</span>
              <span class="tw-summary-value" id="sum-time">-</span>
            </div>
            <div class="tw-summary-row">
              <span class="tw-summary-label">Precio</span>
              <span class="tw-summary-value tw-summary-total" id="sum-price">-</span>
            </div>
          </div>
          <div class="tw-buttons-row">
            <button class="tw-btn tw-btn-ghost" id="btn-back-to-2"><i class="fas fa-arrow-left"></i>Atr√°s</button>
            <button class="tw-btn tw-btn-primary" id="btn-submit">Solicitar <i class="fas fa-paper-plane"></i></button>
          </div>
        </div>
      </div>
    </div>
    <!-- PASO 4: Confirmaci√≥n -->
    <div class="tw-step" id="step-4">
      <div class="tw-card">
        <div class="tw-confirmation">
          <div class="tw-confirmation-icon"><i class="fas fa-check-circle"></i></div>
          <h2 class="tw-confirmation-title">¬°Solicitud Enviada!</h2>
          <p class="tw-confirmation-subtitle">Env√≠anos un WhatsApp para confirmar tu cita</p>
          <div class="tw-confirmation-box">
            <div class="tw-confirmation-row"><i class="fas fa-sparkles"></i><span id="conf-service">-</span></div>
            <div class="tw-confirmation-row"><i class="fas fa-calendar"></i><span id="conf-datetime">-</span></div>
            <div class="tw-confirmation-row"><i class="fas fa-dollar-sign"></i><span id="conf-price">-</span></div>
          </div>
          <button class="tw-btn tw-btn-success" id="btn-whatsapp" style="background:#25D366;">
            <i class="fab fa-whatsapp"></i>Enviar WhatsApp para confirmar
          </button>
          <p style="margin-top:16px;font-size:12px;color:#7a7a6a;">Te contactaremos para confirmar disponibilidad</p>
        </div>
      </div>
    </div>
  </div>
  <div class="tw-client-footer" id="business-footer">Venus Cosmetolog√≠a ¬∑ San Juan del R√≠o, Qro.</div>
  <script>
    let services = [];
    let businessHours = { start: '09:00', end: '20:00', interval: 60, closedDays: [0] };
    let businessConfig = {};
    let selectedService = null;
    let selectedDate = null;
    let selectedTime = null;
    let currentMonth = new Date();
    let busySlots = {};
    let whatsappUrl = '';
    let currentCategory = null;

    const MONTHS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const DAYS = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

    document.addEventListener('DOMContentLoaded', async () => {
      await loadConfig();
      await loadServices();
      renderCalendar();
      setupEventListeners();
    });

    function setupEventListeners() {
      document.getElementById('btn-prev-month').addEventListener('click', prevMonth);
      document.getElementById('btn-next-month').addEventListener('click', nextMonth);
      document.getElementById('btn-step1').addEventListener('click', () => goToStep(2));
      document.getElementById('btn-step2').addEventListener('click', () => goToStep(3));
      document.getElementById('btn-back-to-1').addEventListener('click', () => goToStep(1));
      document.getElementById('btn-back-to-2').addEventListener('click', () => goToStep(2));
      document.getElementById('btn-submit').addEventListener('click', submitRequest);
      document.getElementById('btn-whatsapp').addEventListener('click', openWhatsApp);
    }

    async function loadConfig() {
      try {
        const res = await fetch('/api/public/config');
        const json = await res.json();
        if (json.success && json.data) {
          businessConfig = json.data;
          if (json.data.businessHours) {
            businessHours = json.data.businessHours;
          }
          updateBusinessInfo();
        }
      } catch (e) {
        console.error('Error cargando configuraci√≥n:', e);
      }
    }

    function updateBusinessInfo() {
      if (businessConfig.businessName) {
        document.getElementById('business-name').textContent = businessConfig.businessName;
        document.title = `Agendar Cita - ${businessConfig.businessName}`;
      }
      if (businessConfig.address) {
        document.getElementById('business-address').textContent = businessConfig.address;
      } else {
        document.getElementById('business-address').textContent = 'San Juan del R√≠o, Quer√©taro';
      }
      if (businessConfig.openTime && businessConfig.closeTime) {
        const workDays = businessConfig.workDays || [1, 2, 3, 4, 5, 6];
        const daysText = workDays.map(d => DAYS[d]).join(', ');
        document.getElementById('business-hours').textContent = `${daysText} ¬∑ ${businessConfig.openTime} - ${businessConfig.closeTime}`;
      } else {
        document.getElementById('business-hours').textContent = 'Lun - S√°b ¬∑ 09:00 - 19:00';
      }
      if (businessConfig.mapsUrl) {
        document.getElementById('maps-button').href = businessConfig.mapsUrl;
        document.getElementById('maps-button-container').style.display = 'block';
      }
      const footerText = businessConfig.businessName || 'Venus Cosmetolog√≠a';
      const footerLocation = businessConfig.address ? businessConfig.address.split(',')[businessConfig.address.split(',').length - 1].trim() : 'San Juan del R√≠o, Qro.';
      document.getElementById('business-footer').textContent = `${footerText} ¬∑ ${footerLocation}`;
    }

    async function loadServices() {
      try {
        const res = await fetch('/api/public/services');
        const json = await res.json();
        if (json.success) {
          services = json.data || [];
          renderServices();
        }
      } catch (e) {
        document.getElementById('services-list').innerHTML = '<p style="color:#ef4444;">Error al cargar</p>';
      }
    }

    function renderServices() {
      const el = document.getElementById('services-list');
      const tabsEl = document.getElementById('category-tabs');

      if (services.length === 0) {
        el.innerHTML = '<p style="color:var(--muted);">No hay servicios disponibles</p>';
        return;
      }

      // 1. Obtener categor√≠as √∫nicas
      const categories = ['Todos', ...new Set(services.map(s => s.category || 'Otros'))];

      // Orden personalizado
      const catOrder = ['Todos', 'Faciales', 'Corporales', 'Depilaci√≥n', 'Masajes', 'Paquetes', 'Otros'];
      categories.sort((a, b) => {
        const ia = catOrder.indexOf(a);
        const ib = catOrder.indexOf(b);
        if (ia === -1 && ib === -1) return a.localeCompare(b);
        if (ia === -1) return 1;
        if (ib === -1) return -1;
        return ia - ib;
      });

      // 2. Set default category if none
      if (!currentCategory) {
        currentCategory = categories[1] || 'Todos';
      }

      // 3. Render Tabs
      tabsEl.innerHTML = categories.map(cat => `
        <div class="category-tab ${cat === currentCategory ? 'active' : ''}" 
             onclick="setCategory('${cat}')">
          ${cat}
        </div>
      `).join('');

      // 4. Filter Services
      const filteredServices = currentCategory === 'Todos'
        ? services
        : services.filter(s => (s.category || 'Otros') === currentCategory);

      // 5. Render Grid
      filteredServices.sort((a, b) => a.name.localeCompare(b.name));

      el.innerHTML = filteredServices.map(s => {
        const hasDesc = s.description && s.description.length > 0;
        const descHtml = hasDesc ? `
          <div class="service-description" id="desc-${s.id}">
            <ul style="margin:0;padding:0 0 0 16px;font-size:11px;color:var(--muted);line-height:1.6;">
              ${s.description.map(d => `<li>${d}</li>`).join('')}
            </ul>
            ${s.discount ? `<p style="margin:8px 0 0;font-size:10px;color:var(--venus);font-weight:500;"><i class="fas fa-tag"></i> ${s.discount}</p>` : ''}
          </div>
        ` : '';

        return `
          <div class="service-item ${selectedService && selectedService.id === s.id ? 'selected' : ''}" 
               data-id="${s.id}">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
              <div class="service-name" onclick="selectService(this.parentElement.parentElement, '${s.id}')">${s.name}</div>
              ${hasDesc ? `<button class="service-info-btn" onclick="toggleServiceDesc(event, '${s.id}')" title="Ver detalles">
                <i class="fas fa-info-circle"></i>
              </button>` : ''}
            </div>
            <div class="service-meta-row" onclick="selectService(this.parentElement, '${s.id}')">
              <span class="service-duration"><i class="far fa-clock"></i> ${s.duration}m</span>
              <span class="service-price">$${s.price}</span>
            </div>
            ${descHtml}
          </div>
        `;
      }).join('');
    }

    function setCategory(cat) {
      currentCategory = cat;
      renderServices();
    }

    function toggleServiceDesc(e, id) {
      e.stopPropagation();
      const item = document.querySelector(`.tw-service-item[data-id="${id}"]`);
      if (item) {
        item.classList.toggle('show-desc');
      }
    }


    function selectService(el, id) {
      document.querySelectorAll('.tw-service-item').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
      selectedService = services.find(s => s.id === id);
      document.getElementById('btn-step1').disabled = false;
      updateSummary();
    }

    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      document.getElementById('calendar-month').textContent = `${MONTHS[month]} ${year}`;

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date(); today.setHours(0, 0, 0, 0);

      let html = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'].map(d => `<div class="tw-day-name">${d}</div>`).join('');

      for (let i = 0; i < firstDay; i++) html += '<div class="tw-day empty"></div>';

      for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month, d);
        const dateStr = formatDateISO(date);
        const isPast = date < today;
        const isClosed = businessHours.closedDays?.includes(date.getDay());
        const isToday = date.toDateString() === today.toDateString();
        const isSelected = selectedDate === dateStr;

        let cls = 'tw-day';
        if (isToday) cls += ' today';
        if (isSelected) cls += ' selected';
        if (isPast || isClosed) cls += ' disabled';

        html += `<div class="${cls}" data-date="${dateStr}">${d}</div>`;
      }

      document.getElementById('calendar-grid').innerHTML = html;

      document.querySelectorAll('.tw-day:not(.disabled):not(.empty)').forEach(day => {
        day.addEventListener('click', function () {
          const dateStr = this.dataset.date;
          if (dateStr) selectDate(dateStr);
        });
      });
    }

    function prevMonth() {
      currentMonth.setMonth(currentMonth.getMonth() - 1);
      renderCalendar();
    }

    function nextMonth() {
      currentMonth.setMonth(currentMonth.getMonth() + 1);
      renderCalendar();
    }

    async function selectDate(dateStr) {
      selectedDate = dateStr;
      selectedTime = null;
      document.getElementById('btn-step2').disabled = true;
      renderCalendar();

      document.getElementById('time-grid').innerHTML = '<p style="grid-column:span 3;text-align:center;padding:16px;">Cargando...</p>';

      try {
        const res = await fetch(`/api/public/availability?date=${dateStr}`);
        const json = await res.json();
        busySlots[dateStr] = json.success ? json.busy : [];
      } catch (e) {
        busySlots[dateStr] = [];
      }

      renderTimeSlots(dateStr);
      updateSummary();
    }

    function renderTimeSlots(dateStr) {
      const busy = busySlots[dateStr] || [];
      const date = new Date(dateStr + 'T00:00:00');
      document.getElementById('time-title').textContent = date.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'short' });

      const startH = parseInt(businessHours.start?.split(':')[0]) || 9;
      const endH = parseInt(businessHours.end?.split(':')[0]) || 20;

      let html = '';
      for (let h = startH; h < endH; h++) {
        const time = `${h.toString().padStart(2, '0')}:00`;
        const display = h === 12 ? '12:00 PM' : h > 12 ? `${h - 12}:00 PM` : `${h}:00 AM`;
        const isBusy = busy.includes(time);

        html += `<div class="tw-time-slot ${isBusy ? 'disabled' : ''}" data-time="${time}">${display}</div>`;
      }

      document.getElementById('time-grid').innerHTML = html;

      document.querySelectorAll('.tw-time-slot:not(.disabled)').forEach(slot => {
        slot.addEventListener('click', function () {
          selectTime(this.dataset.time, this);
        });
      });
    }

    function selectTime(time, el) {
      document.querySelectorAll('.tw-time-slot').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
      selectedTime = time;
      document.getElementById('btn-step2').disabled = false;
      updateSummary();
    }

    function updateSummary() {
      if (selectedService) {
        document.getElementById('sum-service').textContent = selectedService.name;
        document.getElementById('sum-price').textContent = '$' + selectedService.price;
      }
      if (selectedDate) {
        const d = new Date(selectedDate + 'T00:00:00');
        document.getElementById('sum-date').textContent = d.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long' });
      }
      if (selectedTime) {
        const h = parseInt(selectedTime.split(':')[0]);
        document.getElementById('sum-time').textContent = h === 12 ? '12:00 PM' : h > 12 ? `${h - 12}:00 PM` : `${h}:00 AM`;
      }
    }

    async function submitRequest() {
      const name = document.getElementById('input-name').value.trim();
      const phone = document.getElementById('input-phone').value.trim().replace(/\D/g, '');
      const email = document.getElementById('input-email').value.trim();
      const birthday = document.getElementById('input-birthday').value;

      // üêõ DEBUG: Logs para verificar datos antes de enviar
      console.log('üìù [BOOKING] Datos del formulario:', {
        name,
        phone,
        email: email || 'sin email',
        birthday: birthday || 'sin cumplea√±os',
        service: selectedService?.name,
        date: selectedDate,
        time: selectedTime
      });

      if (!name) { alert('Ingresa tu nombre'); return; }
      if (phone.length < 10) { alert('Ingresa tu WhatsApp (10 d√≠gitos)'); return; }

      const btn = document.getElementById('btn-submit');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;display:inline-block;margin-right:8px;"></div> Enviando...';

      const requestData = {
        serviceId: selectedService.id,
        serviceName: selectedService.name,
        servicePrice: selectedService.price,
        serviceDuration: selectedService.duration,
        date: selectedDate,
        time: selectedTime,
        clientName: name,
        clientPhone: phone,
        clientEmail: email || null,
        clientBirthday: birthday || null
      };

      console.log('üöÄ [BOOKING] Enviando solicitud:', requestData);

      try {
        const res = await fetch('/api/public/request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData)
        });

        console.log('üì° [BOOKING] Respuesta HTTP:', res.status);

        const json = await res.json();
        console.log('üì¶ [BOOKING] Respuesta del servidor:', json);

        if (json.success) {
          console.log('‚úÖ [BOOKING] Solicitud exitosa!', {
            requestId: json.requestId,
            cardId: json.cardId,
            isNewClient: json.isNewClient
          });
          whatsappUrl = json.whatsappUrl;
          showConfirmation();
        } else {
          console.error('‚ùå [BOOKING] Error del servidor:', json.error);
          alert('Error al enviar la solicitud:\n' + json.error);
          btn.disabled = false;
          btn.innerHTML = 'Solicitar <i class="fas fa-paper-plane"></i>';
        }
      } catch (e) {
        console.error('‚ùå [BOOKING] Error de conexi√≥n:', e);
        alert('Error de conexi√≥n. Por favor verifica tu internet e intenta de nuevo.');
        btn.disabled = false;
        btn.innerHTML = 'Solicitar <i class="fas fa-paper-plane"></i>';
      }
    }

    function showConfirmation() {
      document.getElementById('conf-service').textContent = selectedService.name;
      document.getElementById('conf-price').textContent = '$' + selectedService.price;

      const d = new Date(selectedDate + 'T00:00:00');
      const h = parseInt(selectedTime.split(':')[0]);
      const timeStr = h === 12 ? '12:00 PM' : h > 12 ? `${h - 12}:00 PM` : `${h}:00 AM`;

      document.getElementById('conf-datetime').textContent = d.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'short' }) + ', ' + timeStr;

      goToStep(4);
    }

    function openWhatsApp() {
      if (whatsappUrl) window.open(whatsappUrl, '_blank');
    }

    function goToStep(n) {
      document.querySelectorAll('.tw-step').forEach(el => el.classList.remove('active'));
      document.getElementById(`step-${n}`).classList.add('active');

      for (let i = 1; i <= 4; i++) {
        const dot = document.getElementById(`dot-${i}`);
        dot.className = 'tw-progress-dot';
        if (i < n) dot.classList.add('completed');
        else if (i === n) dot.classList.add('active');
      }
      window.scrollTo(0, 0);
    }

    function formatDateISO(d) {
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }
  </script>
</body>

</html>