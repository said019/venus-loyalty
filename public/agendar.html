<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendar Cita - Venus Cosmetolog√≠a</title>
  <link rel="icon" href="/assets/logo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root {
      --bg: #faf9f6;
      --card: #ffffff;
      --venus: #8C9668;
      --venus-soft: #a8b485;
      --venus-light: #e8ebe0;
      --ink: #2d2d1f;
      --muted: #7a7a6a;
      --line: rgba(0, 0, 0, 0.08);
      --success: #22c55e;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--ink);
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #3a3a2a 0%, #2d2d1f 100%);
      padding: 30px 20px;
      text-align: center;
      color: white;
    }

    .logo {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      margin: 0 auto 16px;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.8;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 24px 20px 40px;
    }

    .progress {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 32px;
    }

    .progress-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--line);
    }

    .progress-dot.active {
      background: var(--venus);
    }

    .progress-dot.completed {
      background: var(--success);
    }

    .card {
      background: var(--card);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      border: 1px solid var(--line);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title i {
      color: var(--venus);
    }

    .category-section {
      margin-bottom: 20px;
    }

    .category-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--venus);
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--line);
    }

    .services-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 8px;
    }

    .service-item {
      border: 2px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }

    .service-item:hover {
      border-color: var(--venus-soft);
    }

    .service-item:active {
      transform: scale(0.98);
    }

    .service-item.selected {
      border-color: var(--venus);
      background: var(--venus-light);
    }

    .service-item.selected::after {
      content: '‚úì';
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--venus);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }

    .service-name {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .service-meta {
      font-size: 11px;
      color: var(--muted);
    }

    .service-description {
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease, margin 0.3s ease;
      opacity: 0;
      pointer-events: none;
    }

    .service-item.show-desc .service-description,
    .service-item.selected .service-description {
      max-height: 200px;
      opacity: 1;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--line);
      pointer-events: auto;
    }

    .service-info-btn {
      background: none;
      border: none;
      color: var(--venus);
      cursor: pointer;
      padding: 4px;
      font-size: 16px;
      display: flex;
      align-items: center;
      transition: transform 0.2s;
    }

    .service-info-btn:hover {
      transform: scale(1.2);
    }

    .calendar-wrapper {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 600px) {
      .calendar-wrapper {
        grid-template-columns: 1fr;
      }
    }

    .calendar {
      background: var(--bg);
      border-radius: 12px;
      padding: 14px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .calendar-header h3 {
      font-size: 14px;
      font-weight: 600;
    }

    .calendar-nav {
      display: flex;
      gap: 6px;
    }

    .calendar-nav button {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: white;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .calendar-nav button:hover {
      background: var(--venus-light);
    }

    .calendar-nav button:active {
      background: var(--venus-soft);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
      text-align: center;
    }

    .day-name {
      font-size: 10px;
      color: var(--muted);
      padding: 6px 0;
    }

    .day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }

    .day:hover:not(.disabled):not(.empty) {
      background: var(--venus-light);
    }

    .day:active:not(.disabled):not(.empty) {
      background: var(--venus-soft);
    }

    .day.selected {
      background: var(--venus);
      color: white;
      font-weight: 600;
    }

    .day.today {
      border: 2px solid var(--venus);
    }

    .day.disabled {
      color: #ccc;
      cursor: not-allowed;
    }

    .time-slots {
      background: var(--bg);
      border-radius: 12px;
      padding: 14px;
    }

    .time-slots h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .time-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .time-slot {
      padding: 10px 6px;
      border: 2px solid var(--line);
      border-radius: 8px;
      text-align: center;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }

    .time-slot:hover:not(.disabled) {
      border-color: var(--venus-soft);
    }

    .time-slot:active:not(.disabled) {
      background: var(--venus-light);
    }

    .time-slot.selected {
      border-color: var(--venus);
      background: var(--venus);
      color: white;
    }

    .time-slot.disabled {
      background: #f5f5f5;
      color: #ccc;
      cursor: not-allowed;
      text-decoration: line-through;
    }

    .form-group {
      margin-bottom: 14px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 5px;
    }

    .form-label .required {
      color: #ef4444;
    }

    .form-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--line);
      border-radius: 10px;
      font-size: 15px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--venus);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 500px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .summary {
      background: var(--venus-light);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 13px;
    }

    .summary-row:not(:last-child) {
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    }

    .summary-label {
      color: var(--muted);
    }

    .summary-value {
      font-weight: 600;
    }

    .summary-total {
      font-size: 16px;
      color: var(--venus);
    }

    .btn {
      padding: 14px 24px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      transition: all 0.2s;
      width: 100%;
    }

    .btn-primary {
      background: var(--venus);
      color: white;
    }

    .btn-primary:hover {
      background: var(--venus-soft);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--line);
      color: var(--ink);
    }

    .btn-whatsapp {
      background: #25D366;
      color: white;
    }

    .btn-whatsapp:hover {
      background: #20bd5a;
    }

    .buttons-row {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .buttons-row .btn {
      flex: 1;
    }

    .confirmation {
      text-align: center;
      padding: 30px 20px;
    }

    .confirmation-icon {
      width: 70px;
      height: 70px;
      background: rgba(34, 197, 94, 0.15);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      color: var(--success);
      font-size: 32px;
    }

    .confirmation h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }

    .confirmation p {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 20px;
    }

    .confirmation-box {
      background: var(--bg);
      border-radius: 12px;
      padding: 16px;
      text-align: left;
      margin-bottom: 20px;
    }

    .confirmation-row {
      display: flex;
      gap: 10px;
      padding: 8px 0;
      font-size: 13px;
    }

    .confirmation-row i {
      color: var(--venus);
      width: 18px;
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    .loading {
      text-align: center;
      padding: 30px;
      color: var(--muted);
    }

    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid var(--line);
      border-top-color: var(--venus);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .footer {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-size: 11px;
    }

    /* Tabs de categor√≠as */
    .category-tabs {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 12px;
      margin-bottom: 20px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      /* Hide scrollbar Firefox */
    }

    .category-tabs::-webkit-scrollbar {
      display: none;
    }

    /* Hide scrollbar Chrome */

    .category-tab {
      padding: 8px 16px;
      border-radius: 20px;
      background: #f3f4f6;
      color: var(--muted);
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .category-tab.active {
      background: var(--venus);
      color: white;
      box-shadow: 0 4px 12px rgba(140, 150, 104, 0.4);
    }

    .category-tab:hover:not(.active) {
      background: #e5e7eb;
    }

    /* Grid mejorado */
    .services-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      /* M√°s ancho */
      gap: 12px;
    }

    .service-item {
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 100px;
    }

    .service-item:hover {
      border-color: var(--venus);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
    }

    .service-item.selected {
      border-color: var(--venus);
      background: #f7f9f2;
      /* Venus light tint */
      box-shadow: 0 0 0 2px var(--venus);
    }

    .service-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .service-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-top: auto;
    }

    .service-duration {
      font-size: 11px;
      color: var(--muted);
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 6px;
    }

    .service-price {
      color: var(--venus);
      font-weight: 700;
      font-size: 15px;
    }

    .service-info-btn {
      background: none;
      border: none;
      color: var(--venus);
      cursor: pointer;
      padding: 4px;
      font-size: 14px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .service-info-btn:hover {
      opacity: 1;
    }

    .service-description {
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <!-- Navigation -->
  <nav
    style="position:fixed;top:0;width:100%;background:rgba(255,255,255,0.98);backdrop-filter:blur(10px);padding:0.8rem 1.5rem;z-index:1000;box-shadow:0 2px 20px rgba(0,0,0,0.05);">
    <div style="max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;">
      <a href="/landing.html"
        style="font-size:1.5rem;font-weight:300;color:var(--venus);font-style:italic;text-decoration:none;">Venus</a>
      <div style="display:flex;gap:1.5rem;align-items:center;">
        <a href="/landing.html#inicio"
          style="text-decoration:none;color:#2d2d1f;font-size:0.9rem;font-weight:500;">Inicio</a>
        <a href="/landing.html#servicios"
          style="text-decoration:none;color:#2d2d1f;font-size:0.9rem;font-weight:500;">Servicios</a>
        <a href="/landing.html#transformaciones"
          style="text-decoration:none;color:#2d2d1f;font-size:0.9rem;font-weight:500;">Transformaciones</a>
        <a href="/landing.html#testimonios"
          style="text-decoration:none;color:#2d2d1f;font-size:0.9rem;font-weight:500;">Testimonios</a>
      </div>
    </div>
  </nav>

  <div class="header" style="margin-top:60px;"><img src="/assets/logo.png" alt="Venus" class="logo">
    <h1 id="business-name">Venus Cosmetolog√≠a</h1>
    <p>Solicita tu cita</p>
  </div>
  <div class="container">
    <!-- Informaci√≥n del negocio -->
    <div class="card" style="margin-bottom: 24px;">
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <div style="display: flex; align-items: start; gap: 12px;"><i class="fas fa-map-marker-alt"
            style="color: var(--venus); margin-top: 2px; font-size: 16px;"></i>
          <div style="flex: 1;">
            <div style="font-size: 13px; font-weight: 600; margin-bottom: 2px;">Ubicaci√≥n</div>
            <div id="business-address" style="font-size: 13px; color: var(--muted);">Cargando...</div>
          </div>
        </div>
        <div style="display: flex; align-items: start; gap: 12px;"><i class="fas fa-clock"
            style="color: var(--venus); margin-top: 2px; font-size: 16px;"></i>
          <div style="flex: 1;">
            <div style="font-size: 13px; font-weight: 600; margin-bottom: 2px;">Horario de atenci√≥n</div>
            <div id="business-hours" style="font-size: 13px; color: var(--muted);">Cargando...</div>
          </div>
        </div>
        <div id="maps-button-container" style="display: none; margin-top: 8px;"><a id="maps-button" href="#"
            target="_blank" class="btn" style="
 display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--venus);
    color: white;
    text-decoration: none;
    padding: 10px 16px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
    ">
            <i class="fas fa-map-marked-alt"></i>Ver en Google Maps </a></div>
      </div>
    </div>
    <div class="progress">
      <div class="progress-dot active" id="dot-1"></div>
      <div class="progress-dot" id="dot-2"></div>
      <div class="progress-dot" id="dot-3"></div>
      <div class="progress-dot" id="dot-4"></div>
    </div>
    <!-- PASO 1: Servicio -->
    <div class="step active" id="step-1">
      <div class="card">
        <div class="card-title"><i class="fas fa-sparkles"></i>¬øQu√© servicio te gustar√≠a? </div>
        <!-- Tabs Container -->
        <div class="category-tabs" id="category-tabs">
          <!-- Rendered by JS -->
        </div>
        <div class="services-grid" id="services-list">
          <div class="loading">
            <div class="spinner"></div>
            <p>Cargando servicios...</p>
          </div>
        </div>
        <div class="buttons-row"><button class="btn btn-primary" id="btn-step1" disabled>Continuar <i
              class="fas fa-arrow-right"></i></button></div>
      </div>
    </div>
    <!-- PASO 2: Fecha y Hora -->
    <div class="step" id="step-2">
      <div class="card">
        <div class="card-title"><i class="fas fa-calendar"></i>¬øCu√°ndo te gustar√≠a venir? </div>
        <div class="calendar-wrapper">
          <div class="calendar">
            <div class="calendar-header">
              <div class="calendar-nav"><button id="btn-prev-month"><i class="fas fa-chevron-left"></i></button>
              </div>
              <h3 id="calendar-month">Diciembre 2025</h3>
              <div class="calendar-nav"><button id="btn-next-month"><i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
          </div>
          <div class="time-slots">
            <h3 id="time-title">Selecciona un d√≠a</h3>
            <div class="time-grid" id="time-grid">
              <p style="grid-column:span 3;text-align:center;color:var(--muted);padding:16px;font-size:12px;">
                Primero elige una fecha </p>
            </div>
          </div>
        </div>
        <div class="buttons-row"><button class="btn btn-outline" id="btn-back-to-1"><i
              class="fas fa-arrow-left"></i>Atr√°s </button><button class="btn btn-primary" id="btn-step2"
            disabled>Continuar <i class="fas fa-arrow-right"></i></button></div>
      </div>
    </div>
    <!-- PASO 3: Datos -->
    <div class="step" id="step-3">
      <div class="card">
        <div class="card-title"><i class="fas fa-user"></i>Tus datos </div>
        <div class="form-group"><label class="form-label">Nombre completo <span class="required">*</span></label><input
            type="text" class="form-input" id="input-name" placeholder="Tu nombre completo"></div>
        <div class="form-group"><label class="form-label">WhatsApp <span class="required">*</span></label><input
            type="tel" class="form-input" id="input-phone" placeholder="10 d√≠gitos" maxlength="15"></div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input"
              id="input-email" placeholder="tu@email.com"></div>
          <div class="form-group"><label class="form-label">Cumplea√±os</label><input type="date" class="form-input"
              id="input-birthday"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><i class="fas fa-clipboard-list"></i>Tu solicitud </div>
        <div class="summary">
          <div class="summary-row"><span class="summary-label">Servicio</span><span class="summary-value"
              id="sum-service">-</span></div>
          <div class="summary-row"><span class="summary-label">Fecha</span><span class="summary-value"
              id="sum-date">-</span></div>
          <div class="summary-row"><span class="summary-label">Hora</span><span class="summary-value"
              id="sum-time">-</span></div>
          <div class="summary-row"><span class="summary-label">Precio</span><span class="summary-value summary-total"
              id="sum-price">-</span></div>
        </div>
        <div class="buttons-row"><button class="btn btn-outline" id="btn-back-to-2"><i
              class="fas fa-arrow-left"></i>Atr√°s </button><button class="btn btn-primary" id="btn-submit">Solicitar <i
              class="fas fa-paper-plane"></i></button></div>
      </div>
    </div>
    <!-- PASO 4: Confirmaci√≥n -->
    <div class="step" id="step-4">
      <div class="card">
        <div class="confirmation">
          <div class="confirmation-icon"><i class="fas fa-check-circle"></i></div>
          <h2>¬°Solicitud Enviada !</h2>
          <p>Env√≠anos un WhatsApp para confirmar tu cita</p>
          <div class="confirmation-box">
            <div class="confirmation-row"><i class="fas fa-sparkles"></i><span id="conf-service">-</span>
            </div>
            <div class="confirmation-row"><i class="fas fa-calendar"></i><span id="conf-datetime">-</span>
            </div>
            <div class="confirmation-row"><i class="fas fa-dollar-sign"></i><span id="conf-price">-</span>
            </div>
          </div><button class="btn btn-whatsapp" id="btn-whatsapp"><i class="fab fa-whatsapp"></i>Enviar
            WhatsApp para confirmar </button>
          <p style="margin-top:16px;font-size:12px;color:var(--muted);">Te contactaremos para confirmar
            disponibilidad </p>
        </div>
      </div>
    </div>
  </div>
  <div class="footer" id="business-footer">Venus Cosmetolog√≠a ¬∑ San Juan del R√≠o,
    Qro. </div>
  <script>
    let services = [];
    let businessHours = { start: '09:00', end: '20:00', interval: 60, closedDays: [0] };
    let businessConfig = {};
    let selectedService = null;
    let selectedDate = null;
    let selectedTime = null;
    let currentMonth = new Date();
    let busySlots = {};
    let whatsappUrl = '';
    let currentCategory = null;

    const MONTHS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const DAYS = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

    document.addEventListener('DOMContentLoaded', async () => {
      await loadConfig();
      await loadServices();
      renderCalendar();
      setupEventListeners();
    });

    function setupEventListeners() {
      document.getElementById('btn-prev-month').addEventListener('click', prevMonth);
      document.getElementById('btn-next-month').addEventListener('click', nextMonth);
      document.getElementById('btn-step1').addEventListener('click', () => goToStep(2));
      document.getElementById('btn-step2').addEventListener('click', () => goToStep(3));
      document.getElementById('btn-back-to-1').addEventListener('click', () => goToStep(1));
      document.getElementById('btn-back-to-2').addEventListener('click', () => goToStep(2));
      document.getElementById('btn-submit').addEventListener('click', submitRequest);
      document.getElementById('btn-whatsapp').addEventListener('click', openWhatsApp);
    }

    async function loadConfig() {
      try {
        const res = await fetch('/api/public/config');
        const json = await res.json();
        if (json.success && json.data) {
          businessConfig = json.data;
          if (json.data.businessHours) {
            businessHours = json.data.businessHours;
          }
          updateBusinessInfo();
        }
      } catch (e) {
        console.error('Error cargando configuraci√≥n:', e);
      }
    }

    function updateBusinessInfo() {
      if (businessConfig.businessName) {
        document.getElementById('business-name').textContent = businessConfig.businessName;
        document.title = `Agendar Cita - ${businessConfig.businessName}`;
      }
      if (businessConfig.address) {
        document.getElementById('business-address').textContent = businessConfig.address;
      } else {
        document.getElementById('business-address').textContent = 'San Juan del R√≠o, Quer√©taro';
      }
      if (businessConfig.openTime && businessConfig.closeTime) {
        const workDays = businessConfig.workDays || [1, 2, 3, 4, 5, 6];
        const daysText = workDays.map(d => DAYS[d]).join(', ');
        document.getElementById('business-hours').textContent = `${daysText} ¬∑ ${businessConfig.openTime} - ${businessConfig.closeTime}`;
      } else {
        document.getElementById('business-hours').textContent = 'Lun - S√°b ¬∑ 09:00 - 19:00';
      }
      if (businessConfig.mapsUrl) {
        document.getElementById('maps-button').href = businessConfig.mapsUrl;
        document.getElementById('maps-button-container').style.display = 'block';
      }
      const footerText = businessConfig.businessName || 'Venus Cosmetolog√≠a';
      const footerLocation = businessConfig.address ? businessConfig.address.split(',')[businessConfig.address.split(',').length - 1].trim() : 'San Juan del R√≠o, Qro.';
      document.getElementById('business-footer').textContent = `${footerText} ¬∑ ${footerLocation}`;
    }

    async function loadServices() {
      try {
        const res = await fetch('/api/public/services');
        const json = await res.json();
        if (json.success) {
          services = json.data || [];
          renderServices();
        }
      } catch (e) {
        document.getElementById('services-list').innerHTML = '<p style="color:#ef4444;">Error al cargar</p>';
      }
    }

    function renderServices() {
      const el = document.getElementById('services-list');
      const tabsEl = document.getElementById('category-tabs');

      if (services.length === 0) {
        el.innerHTML = '<p style="color:var(--muted);">No hay servicios disponibles</p>';
        return;
      }

      // 1. Obtener categor√≠as √∫nicas
      const categories = ['Todos', ...new Set(services.map(s => s.category || 'Otros'))];

      // Orden personalizado
      const catOrder = ['Todos', 'Faciales', 'Corporales', 'Depilaci√≥n', 'Masajes', 'Paquetes', 'Otros'];
      categories.sort((a, b) => {
        const ia = catOrder.indexOf(a);
        const ib = catOrder.indexOf(b);
        if (ia === -1 && ib === -1) return a.localeCompare(b);
        if (ia === -1) return 1;
        if (ib === -1) return -1;
        return ia - ib;
      });

      // 2. Set default category if none
      if (!currentCategory) {
        currentCategory = categories[1] || 'Todos';
      }

      // 3. Render Tabs
      tabsEl.innerHTML = categories.map(cat => `
        <div class="category-tab ${cat === currentCategory ? 'active' : ''}" 
             onclick="setCategory('${cat}')">
          ${cat}
        </div>
      `).join('');

      // 4. Filter Services
      const filteredServices = currentCategory === 'Todos'
        ? services
        : services.filter(s => (s.category || 'Otros') === currentCategory);

      // 5. Render Grid
      filteredServices.sort((a, b) => a.name.localeCompare(b.name));

      el.innerHTML = filteredServices.map(s => {
        const hasDesc = s.description && s.description.length > 0;
        const descHtml = hasDesc ? `
          <div class="service-description" id="desc-${s.id}">
            <ul style="margin:0;padding:0 0 0 16px;font-size:11px;color:var(--muted);line-height:1.6;">
              ${s.description.map(d => `<li>${d}</li>`).join('')}
            </ul>
            ${s.discount ? `<p style="margin:8px 0 0;font-size:10px;color:var(--venus);font-weight:500;"><i class="fas fa-tag"></i> ${s.discount}</p>` : ''}
          </div>
        ` : '';

        return `
          <div class="service-item ${selectedService && selectedService.id === s.id ? 'selected' : ''}" 
               data-id="${s.id}">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
              <div class="service-name" onclick="selectService(this.parentElement.parentElement, '${s.id}')">${s.name}</div>
              ${hasDesc ? `<button class="service-info-btn" onclick="toggleServiceDesc(event, '${s.id}')" title="Ver detalles">
                <i class="fas fa-info-circle"></i>
              </button>` : ''}
            </div>
            <div class="service-meta-row" onclick="selectService(this.parentElement, '${s.id}')">
              <span class="service-duration"><i class="far fa-clock"></i> ${s.duration}m</span>
              <span class="service-price">$${s.price}</span>
            </div>
            ${descHtml}
          </div>
        `;
      }).join('');
    }

    function setCategory(cat) {
      currentCategory = cat;
      renderServices();
    }

    function toggleServiceDesc(e, id) {
      e.stopPropagation();
      const item = document.querySelector(`.service-item[data-id="${id}"]`);
      if (item) {
        item.classList.toggle('show-desc');
      }
    }


    function selectService(el, id) {
      document.querySelectorAll('.service-item').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
      selectedService = services.find(s => s.id === id);
      document.getElementById('btn-step1').disabled = false;
      updateSummary();
    }

    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      document.getElementById('calendar-month').textContent = `${MONTHS[month]} ${year}`;

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date(); today.setHours(0, 0, 0, 0);

      let html = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'].map(d => `<div class="day-name">${d}</div>`).join('');

      for (let i = 0; i < firstDay; i++) html += '<div class="day empty"></div>';

      for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month, d);
        const dateStr = formatDateISO(date);
        const isPast = date < today;
        const isClosed = businessHours.closedDays?.includes(date.getDay());
        const isToday = date.toDateString() === today.toDateString();
        const isSelected = selectedDate === dateStr;

        let cls = 'day';
        if (isToday) cls += ' today';
        if (isSelected) cls += ' selected';
        if (isPast || isClosed) cls += ' disabled';

        html += `<div class="${cls}" data-date="${dateStr}">${d}</div>`;
      }

      document.getElementById('calendar-grid').innerHTML = html;

      document.querySelectorAll('.day:not(.disabled):not(.empty)').forEach(day => {
        day.addEventListener('click', function () {
          const dateStr = this.dataset.date;
          if (dateStr) selectDate(dateStr);
        });
      });
    }

    function prevMonth() {
      currentMonth.setMonth(currentMonth.getMonth() - 1);
      renderCalendar();
    }

    function nextMonth() {
      currentMonth.setMonth(currentMonth.getMonth() + 1);
      renderCalendar();
    }

    async function selectDate(dateStr) {
      selectedDate = dateStr;
      selectedTime = null;
      document.getElementById('btn-step2').disabled = true;
      renderCalendar();

      document.getElementById('time-grid').innerHTML = '<p style="grid-column:span 3;text-align:center;padding:16px;">Cargando...</p>';

      try {
        const res = await fetch(`/api/public/availability?date=${dateStr}`);
        const json = await res.json();
        busySlots[dateStr] = json.success ? json.busy : [];
      } catch (e) {
        busySlots[dateStr] = [];
      }

      renderTimeSlots(dateStr);
      updateSummary();
    }

    function renderTimeSlots(dateStr) {
      const busy = busySlots[dateStr] || [];
      const date = new Date(dateStr + 'T00:00:00');
      document.getElementById('time-title').textContent = date.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'short' });

      const startH = parseInt(businessHours.start?.split(':')[0]) || 9;
      const endH = parseInt(businessHours.end?.split(':')[0]) || 20;

      let html = '';
      for (let h = startH; h < endH; h++) {
        const time = `${h.toString().padStart(2, '0')}:00`;
        const display = h === 12 ? '12:00 PM' : h > 12 ? `${h - 12}:00 PM` : `${h}:00 AM`;
        const isBusy = busy.includes(time);

        html += `<div class="time-slot ${isBusy ? 'disabled' : ''}" data-time="${time}">${display}</div>`;
      }

      document.getElementById('time-grid').innerHTML = html;

      document.querySelectorAll('.time-slot:not(.disabled)').forEach(slot => {
        slot.addEventListener('click', function () {
          selectTime(this.dataset.time, this);
        });
      });
    }

    function selectTime(time, el) {
      document.querySelectorAll('.time-slot').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
      selectedTime = time;
      document.getElementById('btn-step2').disabled = false;
      updateSummary();
    }

    function updateSummary() {
      if (selectedService) {
        document.getElementById('sum-service').textContent = selectedService.name;
        document.getElementById('sum-price').textContent = '$' + selectedService.price;
      }
      if (selectedDate) {
        const d = new Date(selectedDate + 'T00:00:00');
        document.getElementById('sum-date').textContent = d.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long' });
      }
      if (selectedTime) {
        const h = parseInt(selectedTime.split(':')[0]);
        document.getElementById('sum-time').textContent = h === 12 ? '12:00 PM' : h > 12 ? `${h - 12}:00 PM` : `${h}:00 AM`;
      }
    }

    async function submitRequest() {
      const name = document.getElementById('input-name').value.trim();
      const phone = document.getElementById('input-phone').value.trim().replace(/\D/g, '');
      const email = document.getElementById('input-email').value.trim();
      const birthday = document.getElementById('input-birthday').value;

      // üêõ DEBUG: Logs para verificar datos antes de enviar
      console.log('üìù [BOOKING] Datos del formulario:', {
        name,
        phone,
        email: email || 'sin email',
        birthday: birthday || 'sin cumplea√±os',
        service: selectedService?.name,
        date: selectedDate,
        time: selectedTime
      });

      if (!name) { alert('Ingresa tu nombre'); return; }
      if (phone.length < 10) { alert('Ingresa tu WhatsApp (10 d√≠gitos)'); return; }

      const btn = document.getElementById('btn-submit');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;display:inline-block;margin-right:8px;"></div> Enviando...';

      const requestData = {
        serviceId: selectedService.id,
        serviceName: selectedService.name,
        servicePrice: selectedService.price,
        serviceDuration: selectedService.duration,
        date: selectedDate,
        time: selectedTime,
        clientName: name,
        clientPhone: phone,
        clientEmail: email || null,
        clientBirthday: birthday || null
      };

      console.log('üöÄ [BOOKING] Enviando solicitud:', requestData);

      try {
        const res = await fetch('/api/public/request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData)
        });

        console.log('üì° [BOOKING] Respuesta HTTP:', res.status);

        const json = await res.json();
        console.log('üì¶ [BOOKING] Respuesta del servidor:', json);

        if (json.success) {
          console.log('‚úÖ [BOOKING] Solicitud exitosa!', {
            requestId: json.requestId,
            cardId: json.cardId,
            isNewClient: json.isNewClient
          });
          whatsappUrl = json.whatsappUrl;
          showConfirmation();
        } else {
          console.error('‚ùå [BOOKING] Error del servidor:', json.error);
          alert('Error al enviar la solicitud:\n' + json.error);
          btn.disabled = false;
          btn.innerHTML = 'Solicitar <i class="fas fa-paper-plane"></i>';
        }
      } catch (e) {
        console.error('‚ùå [BOOKING] Error de conexi√≥n:', e);
        alert('Error de conexi√≥n. Por favor verifica tu internet e intenta de nuevo.');
        btn.disabled = false;
        btn.innerHTML = 'Solicitar <i class="fas fa-paper-plane"></i>';
      }
    }

    function showConfirmation() {
      document.getElementById('conf-service').textContent = selectedService.name;
      document.getElementById('conf-price').textContent = '$' + selectedService.price;

      const d = new Date(selectedDate + 'T00:00:00');
      const h = parseInt(selectedTime.split(':')[0]);
      const timeStr = h === 12 ? '12:00 PM' : h > 12 ? `${h - 12}:00 PM` : `${h}:00 AM`;

      document.getElementById('conf-datetime').textContent = d.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'short' }) + ', ' + timeStr;

      goToStep(4);
    }

    function openWhatsApp() {
      if (whatsappUrl) window.open(whatsappUrl, '_blank');
    }

    function goToStep(n) {
      document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
      document.getElementById(`step-${n}`).classList.add('active');

      for (let i = 1; i <= 4; i++) {
        const dot = document.getElementById(`dot-${i}`);
        dot.className = 'progress-dot';
        if (i < n) dot.classList.add('completed');
        else if (i === n) dot.classList.add('active');
      }
      window.scrollTo(0, 0);
    }

    function formatDateISO(d) {
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }
  </script>
</body>

</html>