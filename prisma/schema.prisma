generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Tarjetas de lealtad
model Card {
  id            String    @id @default(cuid())
  name          String
  phone         String    @unique
  email         String?
  birthday      String?
  stamps        Int       @default(0)
  max           Int       @default(8)
  cycles        Int       @default(0)
  status        String    @default("active")
  lastVisit     DateTime?
  latestMessage String?   // Para notificaciones push
  source        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Tarjeta Digital Wallet
  cardType      String    @default("loyalty")  // loyalty | annual | gold
  cardColor     String    @default("#8C9668")  // Color hex del pase
  sessionsTotal Int       @default(0)          // Sesiones prepagadas (Venus Constancia Anual)
  sessionsUsed  Int       @default(0)          // Sesiones ya canjeadas
  walletPassUrl String?                        // URL Google Wallet Object

  // Membresía de Masajes (independiente de los sellos de lealtad)
  massageActive  Boolean   @default(false)     // Si tiene membresía de masajes activa
  massageStamps  Int       @default(0)         // Sellos de masaje actuales
  massageMax     Int       @default(10)        // Total de sesiones de masaje
  massageCycles  Int       @default(0)         // Ciclos completados de masaje
  massageWalletUrl String?                     // URL Google Wallet para masajes

  // Relaciones
  appointments Appointment[]
  events       Event[]

  @@map("cards")
}

// Servicios
model Service {
  id              String   @id @default(cuid())
  name            String
  description     String?
  price           Decimal  @db.Decimal(10, 2)
  durationMinutes Int      @default(60)
  category        String?
  discount        String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("services")
}

// Citas
model Appointment {
  id                     String    @id @default(cuid())
  clientName             String
  clientPhone            String
  serviceName            String
  date                   String
  time                   String
  startDateTime          DateTime
  endDateTime            DateTime
  durationMinutes        Int       @default(60)
  status                 String    @default("scheduled") // scheduled, confirmed, completed, cancelled, rescheduling
  location               String?
  
  // Pago
  totalPaid              Decimal?  @db.Decimal(10, 2)
  paymentMethod          String?   // efectivo, tarjeta, transferencia
  discount               Decimal?  @db.Decimal(10, 2)
  
  // Google Calendar
  googleCalendarEventId  String?
  googleCalendarEventId2 String?
  
  // WhatsApp reminders
  sendWhatsApp30h        Boolean   @default(false)
  sendWhatsApp24h        Boolean   @default(true)
  sendWhatsApp2h         Boolean   @default(true)
  sent30hAt              DateTime?
  sent24hAt              DateTime?
  sent2hAt               DateTime?
  
  // Confirmación
  confirmedAt            DateTime?
  confirmedVia           String?   // whatsapp, manual
  cancelledAt            DateTime?
  cancelledVia           String?   // whatsapp, manual
  cancelReason           String?
  rescheduleRequestedAt  DateTime?
  
  // Productos vendidos (JSON)
  productsSold           Json?
  
  source                 String?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // Relaciones
  cardId    String?
  card      Card?    @relation(fields: [cardId], references: [id], onDelete: SetNull)
  serviceId String?
  // Removemos la relación estricta con Service para permitir citas con servicios eliminados

  // Google Calendar mapping (OAuth2)
  calendarMappings GoogleCalendarMapping[]

  @@map("appointments")
}

// Eventos (sellos, canjes)
model Event {
  id        String   @id @default(cuid())
  type      String   // stamp, redeem
  cardId    String
  card      Card     @relation(fields: [cardId], references: [id])
  staffId   String?
  staffName String?
  note      String?
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())

  @@map("events")
}

// Productos
model Product {
  id           String   @id @default(cuid())
  name         String
  category     String?
  presentation String?
  price        Decimal  @db.Decimal(10, 2)
  cost         Decimal? @db.Decimal(10, 2)
  stock        Int      @default(0)
  minStock     Int      @default(5)
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("products")
}

// Gastos
model Expense {
  id          String   @id @default(cuid())
  date        String
  category    String   // productos, renta, servicios, salarios, marketing, equipo, mantenimiento, transporte, otros
  description String
  amount      Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("expenses")
}

// Tarjetas de regalo
model GiftCard {
  id             String    @id @default(cuid())
  code           String    @unique
  amount         Decimal   @db.Decimal(10, 2)
  remainingAmount Decimal  @db.Decimal(10, 2)
  status         String    @default("pending") // pending, active, used, expired
  purchaserName  String?
  purchaserPhone String?
  recipientName  String?
  recipientPhone String?
  message        String?
  expiresAt      DateTime?
  usedAt         DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("giftcards")
}

// Notificaciones
model Notification {
  id        String   @id @default(cuid())
  type      String   // cumpleaños, premio, stock, giftcard, cita, alerta
  icon      String?
  title     String
  message   String
  read      Boolean  @default(false)
  data      Json?
  entityId  String?  // ID de la entidad relacionada (cita, tarjeta, etc.)
  createdAt DateTime @default(now())

  @@map("notifications")
}

// Solicitudes de reserva (desde página pública)
model BookingRequest {
  id              String   @id @default(cuid())
  name            String?
  phone           String?
  serviceId       String?
  serviceName     String
  servicePrice    Decimal? @db.Decimal(10, 2)
  serviceDuration Int?
  date            String
  time            String
  clientName      String?
  clientPhone     String?
  clientEmail     String?
  clientBirthday  String?
  cardId          String?
  isNewClient     Boolean  @default(false)
  status          String   @default("pending") // pending, approved, rejected
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("booking_requests")
}

// Configuración
model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

// Ventas (historial)
model Sale {
  id             String   @id @default(cuid())
  appointmentId  String?
  clientName     String?
  clientPhone    String?
  serviceName    String?
  serviceAmount  Decimal? @db.Decimal(10, 2)
  productsAmount Decimal? @db.Decimal(10, 2)
  products       Json?
  productsSold   Json?
  subtotal       Decimal  @db.Decimal(10, 2)
  discountType   String?
  discountValue  Decimal? @db.Decimal(10, 2)
  discountAmount Decimal? @db.Decimal(10, 2)
  discount       Decimal? @db.Decimal(10, 2)
  total          Decimal  @db.Decimal(10, 2)
  totalAmount    Decimal? @db.Decimal(10, 2)
  paymentMethod  String
  date           DateTime
  createdAt      DateTime @default(now())

  @@map("sales")
}

// Administradores
model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  pass_hash String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admins")
}

// Reset de contraseñas de admin
model AdminReset {
  id        String   @id @default(cuid())
  adminId   String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("admin_resets")
}

// Dispositivos Apple Wallet
model AppleDevice {
  id             String   @id @default(cuid())
  deviceId       String
  pushToken      String
  passTypeId     String
  serialNumber   String
  createdAt      DateTime @default(now())

  @@unique([deviceId, passTypeId, serialNumber])
  @@map("apple_devices")
}

// Actualizaciones Apple Wallet
model AppleUpdate {
  id           String   @id @default(cuid())
  serialNumber String
  updatedAt    DateTime @default(now())

  @@map("apple_updates")
}

// Dispositivos Google Wallet
model GoogleDevice {
  id        String   @id @default(cuid())
  cardId    String
  objectId  String
  createdAt DateTime @default(now())

  @@map("google_devices")
}

// ========== EXPEDIENTES DE CLIENTAS ==========

// Expediente principal de la clienta
model ClientRecord {
  id              String   @id @default(cuid())
  cardId          String   @unique
  
  // Datos personales adicionales
  age             Int?
  skinType        String?   // normal, grasa, seca, mixta, sensible
  allergies       String?   // Alergias conocidas
  medicalHistory  String?   // Antecedentes médicos relevantes
  objectives      String?   // Objetivos del tratamiento
  observations    String?   // Observaciones generales
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relaciones
  sessions        TreatmentSession[]
  photos          ClientPhoto[]
  
  @@map("client_records")
}

// Sesiones de tratamiento
model TreatmentSession {
  id              String   @id @default(cuid())
  recordId        String
  record          ClientRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  
  // Datos de la sesión
  date            DateTime @default(now())
  treatmentType   String   // facial, corporal, depilación, etc.
  serviceName     String?
  staffName       String?
  
  // Parámetros del aparato
  deviceName      String?  // Nombre del aparato usado
  deviceSettings  Json?    // Configuración: potencia, frecuencia, tiempo, etc.
  
  // Zonas tratadas
  treatedAreas    String?  // Zonas del cuerpo/cara tratadas
  
  // Productos utilizados
  productsUsed    String?
  
  // Observaciones de la sesión
  observations    String?
  results         String?
  recommendations String?  // Recomendaciones para próxima sesión
  
  // Fotos de la sesión
  photos          ClientPhoto[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("treatment_sessions")
}

// Fotos del expediente
model ClientPhoto {
  id              String   @id @default(cuid())
  recordId        String
  record          ClientRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  
  sessionId       String?
  session         TreatmentSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  
  // Datos de la foto
  url             String   // URL de la imagen
  publicId        String?  // ID para Cloudinary/storage
  type            String   @default("progress") // before, after, progress
  category        String?  // facial, corporal, etc.
  area            String?  // Zona específica
  description     String?
  
  takenAt         DateTime @default(now())
  createdAt       DateTime @default(now())
  
  @@map("client_photos")
}

// Mensajes WhatsApp (historial entrante y saliente)
model WhatsappMessage {
  id        String   @id @default(cuid())
  phone     String
  name      String?
  body      String
  direction String   // 'in' | 'out'
  timestamp DateTime @default(now())
  read      Boolean  @default(false)
  messageId String?
  createdAt DateTime @default(now())

  @@map("whatsapp_messages")
}

// Mapeo poll_message_id → appointment_id para respuestas de polls de Evolution API
model PendingPoll {
  id            String   @id // = pollMessageId devuelto por Evolution API
  appointmentId String
  phone         String
  expiresAt     DateTime
  createdAt     DateTime @default(now())

  @@map("pending_polls")
}

// Historial de canjes de Gift Cards
model GiftCardRedeem {
  id          String   @id @default(cuid())
  code        String
  service     String?
  clientName  String?  @map("client_name")
  expiryDate  String?  @map("expiry_date")
  redeemedAt  DateTime @default(now()) @map("redeemed_at")
  createdAt   DateTime @default(now())

  @@map("gift_card_redeems")
}

// Bloqueos de horario (días específicos o recurrentes)
model BlockedSlot {
  id        String   @id @default(cuid())
  startTime String   // "HH:mm"
  endTime   String   // "HH:mm"
  date      String?  // "YYYY-MM-DD" (Fecha específica, opcional)
  dayOfWeek Int?     // 0-6 (Día recurrente, 0=Dom, opcional)
  reason    String?  // Motivo del bloqueo
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("blocked_slots")
}

// ===== GOOGLE CALENDAR OAUTH2 =====

// Almacena los tokens OAuth2 de Google Calendar (singleton, id=1)
model GoogleCalendarConfig {
  id           Int       @id @default(autoincrement())
  refreshToken String?   @map("refresh_token")
  accessToken  String?   @map("access_token")
  tokenExpiry  DateTime? @map("token_expiry")
  calendarId   String    @default("primary") @map("calendar_id")
  isConnected  Boolean   @default(false) @map("is_connected")
  lastSyncAt   DateTime? @map("last_sync_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("google_calendar_config")
}

// Mapeo entre citas del sistema y eventos de Google Calendar
model GoogleCalendarMapping {
  id              Int      @id @default(autoincrement())
  appointmentId   String   @map("appointment_id")
  googleEventId   String   @unique @map("google_event_id")
  syncStatus      String   @default("synced") @map("sync_status") // synced, pending, failed
  errorMessage    String?  @map("error_message")
  lastSyncedAt    DateTime @default(now()) @map("last_synced_at")
  createdAt       DateTime @default(now()) @map("created_at")

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@unique([appointmentId, googleEventId])
  @@map("google_calendar_mapping")
}
